&Scoped-define NEW 
&Scoped-define SHARED 
{SPECMTRLTEMP.I}
DEFINE TEMP-TABLE aspec_mtrl NO-UNDO LIKE spec_mtrl
   FIELD ny AS LOGICAL
   FIELD andrad AS LOGICAL
   FIELD bort AS LOGICAL.        
DEFINE QUERY mtrlq FOR MTRLDEP.

DEFINE INPUT PARAMETER vald_depa AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER TABLE FOR aspec_mtrl.
DEFINE INPUT PARAMETER invdat AS DATE NO-UNDO.

FOR EACH aspec_mtrl WHERE aspec_mtrl.BORT = TRUE:
   DO TRANSACTION:
      FOR EACH MTRLDEP WHERE MTRLDEP.ENR = aspec_mtrl.ENR AND MTRLDEP.DEPNR = vald_depa 
      AND MTRLDEP.IBDATUM = ? AND MTRLDEP.LAGER = TRUE AND MTRLDEP.LEVKOD = aspec_mtrl.LEVKOD EXCLUSIVE-LOCK:
         DELETE MTRLDEP.
      END.      
   END.
   DELETE aspec_mtrl.
END.

FOR EACH aspec_mtrl WHERE aspec_mtrl.NY = TRUE:
   DO TRANSACTION:
      CREATE MTRLDEP.
      BUFFER-COPY aspec_mtrl TO MTRLDEP.
      ASSIGN
      MTRLDEP.IBDATUM = ?
      MTRLDEP.LAGER = TRUE
      MTRLDEP.INVDATUM = invdat.
   END.
   DELETE aspec_mtrl.
END.
FOR EACH aspec_mtrl WHERE aspec_mtrl.ANDRAD = TRUE:
   DO TRANSACTION:
      FIND FIRST MTRLDEP WHERE MTRLDEP.ENR = aspec_mtrl.ENR AND MTRLDEP.DEPNR = vald_depa 
      AND MTRLDEP.IBDATUM = ? AND MTRLDEP.LAGER = TRUE AND MTRLDEP.LEVKOD = aspec_mtrl.LEVKOD EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE MTRLDEP THEN DO:          
         BUFFER-COPY aspec_mtrl TO MTRLDEP.
         ASSIGN
         MTRLDEP.LAGER = TRUE.
      END.
   END.
END.


   /*OPEN QUERY mtrlq FOR EACH MTRLDEP WHERE MTRLDEP.DEPNR = vald_depa 
   AND MTRLDEP.IBDATUM = ? AND MTRLDEP.LAGER = TRUE USE-INDEX DEPNR NO-LOCK. 
   GET FIRST mtrlq EXCLUSIVE-LOCK.
   DO WHILE AVAILABLE(MTRLDEP):
      DELETE MTRLDEP.
      GET NEXT mtrlq EXCLUSIVE-LOCK. 
   END.
   CLOSE QUERY mtrlq.                
   FOR EACH spec_mtrl:
      CREATE MTRLDEP.
      ASSIGN
      MTRLDEP.DEPNR = vald_depa          
      MTRLDEP.ENR = spec_mtrl.ENR 
      MTRLDEP.BENAMNING = spec_mtrl.BENAMNING
      MTRLDEP.NPRIS = spec_mtrl.NPRIS 
      MTRLDEP.BPRIS = spec_mtrl.BPRIS
      MTRLDEP.ENHET = spec_mtrl.ENHET
      MTRLDEP.BESTKVANT = spec_mtrl.BESTKVANT 
      MTRLDEP.BESTPUNKT = spec_mtrl.BESTPUNKT 
      MTRLDEP.INVANT = spec_mtrl.INVANT 
      MTRLDEP.INVDATUM = invdat
      MTRLDEP.FACKID = spec_mtrl.FACKID
      MTRLDEP.OMSATT = spec_mtrl.OMSATT 
      MTRLDEP.LEVKOD = spec_mtrl.LEV
      MTRLDEP.SALDO = spec_mtrl.SALDO
      MTRLDEP.LAGER = TRUE.        
   END. 
   
     */
