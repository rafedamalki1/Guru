/*ANDKINDAPP.P*/
{STARTFORAPP.I}
{MARKVARD.I}

PROCEDURE btnok.
   DEFINE INPUT PARAMETER vart AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER FILL-IN_AR AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER FILL-IN_MANAD AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER FILL-IN_VARDE AS INTEGER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR felmeddtemp.
   DEFINE INPUT-OUTPUT PARAMETER TABLE FOR kindextemp.  
   IF vart = "NYA" THEN DO:
      FIND FIRST KINDEX WHERE KINDEX.AR = FILL-IN_AR AND 
      KINDEX.MANAD =  FILL-IN_MANAD NO-LOCK NO-ERROR.
      IF AVAILABLE KINDEX THEN DO:
         CREATE felmeddtemp.
         ASSIGN felmeddtemp.FELMEDD = "Index finns redan för detta år och månad".
         RETURN.
      END.
      ELSE DO TRANSACTION:
         CREATE KINDEX.
         ASSIGN 
         KINDEX.AR = FILL-IN_AR      
         KINDEX.MANAD = FILL-IN_MANAD
         KINDEX.VARDE = FILL-IN_VARDE.         
         CREATE kindextemp.
         ASSIGN 
         kindextemp.AR = FILL-IN_AR        
         kindextemp.MANAD = FILL-IN_MANAD  
         kindextemp.VARDE = FILL-IN_VARDE. 
      END.
      RELEASE KINDEX NO-ERROR.
      RETURN.
   END.
   ELSE DO TRANSACTION:
      FIND FIRST KINDEX WHERE KINDEX.AR = FILL-IN_AR AND 
      KINDEX.MANAD =  FILL-IN_MANAD EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KINDEX THEN DO:
         ASSIGN 
         KINDEX.AR = FILL-IN_AR      
         KINDEX.MANAD = FILL-IN_MANAD
         KINDEX.VARDE = FILL-IN_VARDE.
         FIND FIRST kindextemp WHERE kindextemp.AR = FILL-IN_AR AND 
         kindextemp.MANAD = FILL-IN_MANAD NO-LOCK NO-ERROR.
         IF AVAILABLE kindextemp THEN DO:
            ASSIGN 
            kindextemp.AR = FILL-IN_AR        
            kindextemp.MANAD = FILL-IN_MANAD  
            kindextemp.VARDE = FILL-IN_VARDE. 
         END.
      END.
   END.
   RELEASE KINDEX NO-ERROR.
END PROCEDURE.


