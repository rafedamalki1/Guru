DEFINE VARIABLE arrhjsum LIKE TIDREGITAB.BERANTAL NO-UNDO.  
DEFINE VARIABLE arrhjsum2 LIKE TIDREGITAB.BERANTAL NO-UNDO.  

DEFINE TEMP-TABLE dagtemp
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"         
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ô-KOSTNAD"  
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"        
   INDEX AONR IS PRIMARY AONR DELNR.             
   
DEFINE TEMP-TABLE dagtemp2
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"         
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ô-KOSTNAD"  
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"        
   INDEX AONR IS PRIMARY AONR DELNR.   
   
DEFINE TEMP-TABLE artemp
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"         
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ô-KOSTNAD"  
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"        
   INDEX AONR IS PRIMARY AONR DELNR.             
   
DEFINE TEMP-TABLE artemp2
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"         
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ô-KOSTNAD"  
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"        
   INDEX AONR IS PRIMARY AONR DELNR.      

DEFINE QUERY sumq FOR SUMTIDDAG. 
DEFINE QUERY sum2q FOR SUMTID.   

DEFINE QUERY arq FOR SUMTIDDAG. 
DEFINE QUERY ar2q FOR SUMTID.

OPEN QUERY sum2q FOR EACH SUMTID WHERE YEAR(SUMTID.DATUM) = 1997 AND
SUMTID.VECKOKORD NE " "  NO-LOCK.
DO TRANSACTION:
 GET FIRST sum2q EXCLUSIVE-LOCK.
 ASSIGN SUMTID.TBELOPP = 0.
END. 
DO WHILE AVAILABLE(SUMTID):
   DO TRANSACTION: 
      GET NEXT sum2q EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN           
      SUMTID.TBELOPP = 0.
   END.   
END.                          
CLOSE QUERY sum2q.


OPEN QUERY sumq FOR EACH SUMTIDDAG WHERE YEAR(SUMTIDDAG.DATUM) = 1997 
USE-INDEX PRISTYP NO-LOCK.
GET FIRST sumq NO-LOCK.
DO WHILE AVAILABLE(SUMTIDDAG):             
   IF SUMTIDDAG.VECKOKORD NE " " THEN DO:
      IF SUMTIDDAG.TBELOPP NE 0 THEN DO TRANSACTION:
         CREATE dagtemp.
         ASSIGN        
         dagtemp.AONR = SUMTIDDAG.AONR
         dagtemp.DELNR = SUMTIDDAG.DELNR
         dagtemp.PERSONALKOD = SUMTIDDAG.PERSONALKOD
         dagtemp.OMRADE = SUMTIDDAG.OMRADE
         dagtemp.TBELOPP = SUMTIDDAG.TBELOPP.
      END.
   END.   
   GET NEXT sumq NO-LOCK.
END.                          
CLOSE QUERY sumq.    

     
arrhjsum = 0.
FOR EACH dagtemp
   BREAK BY dagtemp.AONR BY dagtemp.DELNR BY dagtemp.OMRADE BY dagtemp.PERSONALKOD: 
   ACCUMULATE 
   dagtemp.TBELOPP (TOTAL BY dagtemp.AONR BY dagtemp.DELNR 
   BY dagtemp.OMRADE BY dagtemp.PERSONALKOD).         
   IF LAST-OF(dagtemp.PERSONALKOD) THEN DO TRANSACTION:
      CREATE dagtemp2.
      ASSIGN   
      dagtemp2.AONR = dagtemp.AONR
      dagtemp2.DELNR = dagtemp.DELNR      
      dagtemp2.PERSONALKOD = dagtemp.PERSONALKOD      
      dagtemp2.OMRADE = dagtemp.OMRADE                       
      dagtemp2.TBELOPP = (ACCUM TOTAL dagtemp.TBELOPP) - arrhjsum            
      arrhjsum = ACCUM TOTAL dagtemp.TBELOPP.                       
   END.                                                   
END.      

FOR EACH dagtemp2: 
   DO TRANSACTION:      
      FIND FIRST SUMTID WHERE SUMTID.AONR = dagtemp2.AONR AND 
      SUMTID.DELNR = dagtemp2.DELNR AND SUMTID.OMRADE = dagtemp2.OMRADE AND
      SUMTID.PERSONALKOD = dagtemp2.PERSONALKOD AND YEAR(SUMTID.DATUM) = 1997 AND
      SUMTID.VECKOKORD NE "" AND SUMTID.PRISTYP NE "FRèNVARO." 
      USE-INDEX PERSONALKOD EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE SUMTID THEN DO:
         SUMTID.TBELOPP = dagtemp2.TBELOPP.
      END.    
   END.   
END.
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
OUTPUT TO restidfil APPEND.
display "TRAK klar" FORETAG.FORETAG.
OUTPUT CLOSE.
