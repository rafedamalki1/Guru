    /*SUFRHOGIAM.P   format 214007 årtal i peronsnummer 4 siffror*/
{LESAMMAN.I}  
DEFINE INPUT PARAMETER kordatum AS DATE NO-UNDO.
DEFINE INPUT PARAMETER koranv LIKE ANVANDARE.ANVANDARE NO-UNDO.
DEFINE INPUT PARAMETER gkorvar AS CHARACTER NO-UNDO.
RUN sammut_UI (INPUT 1).
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{LONEDEF.I}
/*DEFINE NEW SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.*/

DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE gvisatidpermanad AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE regstart LIKE TIDREGITAB.START NO-UNDO. 
DEFINE NEW SHARED VARIABLE regslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.        
DEFINE NEW SHARED VARIABLE regtotalt LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE NEW SHARED VARIABLE frustarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE fruslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffestart AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffeslut AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchstarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE korvar AS CHARACTER NO-UNDO.
DEFINE VARIABLE onr LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE onr2 LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE dnr LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE dnr2 LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE starttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE sluttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE antal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE antal2 LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE personal LIKE PERSONALTAB.PERSONALKOD NO-UNDO.
DEFINE VARIABLE pnr LIKE PERSONALTAB.PERSONNUMMER NO-UNDO.      /*LON*/
DEFINE VARIABLE pc LIKE FVARO.PROC NO-UNDO.
DEFINE VARIABLE fkod LIKE FVARO.FRKOD NO-UNDO.
DEFINE VARIABLE del1 LIKE FVARO.DEL NO-UNDO.
DEFINE VARIABLE regdatum2 AS DATE NO-UNDO.  
DEFINE VARIABLE regdat3 AS DATE NO-UNDO.
DEFINE VARIABLE regdat4 AS DATE NO-UNDO. 
DEFINE VARIABLE regdat5 AS DATE NO-UNDO.
DEFINE VARIABLE tott1 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE tott2 AS INTEGER NO-UNDO.
DEFINE VARIABLE tott3 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE proc1 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE proc2 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE seku AS INTEGER NO-UNDO.
DEFINE VARIABLE anst LIKE ANSTFORM.KOD NO-UNDO.
DEFINE VARIABLE krav AS INTEGER FORMAT "9" NO-UNDO.
DEFINE VARIABLE frstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE frslut LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE avdatum AS DATE NO-UNDO.
DEFINE VARIABLE komptid AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE kommentar AS CHARACTER NO-UNDO.
DEFINE VARIABLE arbdg AS INTEGER NO-UNDO.
DEFINE VARIABLE dagtot AS DECIMAL NO-UNDO.
DEFINE VARIABLE regdat1 AS DATE NO-UNDO.
DEFINE VARIABLE regdat2 AS DATE NO-UNDO.  
DEFINE VARIABLE prognamn AS CHARACTER FORMAT "X(41)" NO-UNDO.
DEFINE VARIABLE prognamn5 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn6 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn3 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn4 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE kolldatum AS DATE NO-UNDO.
DEFINE VARIABLE lonfil AS CHARACTER NO-UNDO.
DEFINE VARIABLE anstperson AS CHARACTER NO-UNDO.
DEFINE VARIABLE overrapp1 AS CHARACTER FORMAT "X(250)" NO-UNDO.      /*LON*/
DEFINE VARIABLE overrapp2 AS CHARACTER FORMAT "X(250)" NO-UNDO.      /*LON*/
DEFINE VARIABLE omfatt AS DECIMAL NO-UNDO.
DEFINE VARIABLE frantim AS INTEGER NO-UNDO.
DEFINE VARIABLE startm AS LOGICAL NO-UNDO.
DEFINE VARIABLE slutm AS LOGICAL NO-UNDO.
DEFINE VARIABLE startdatum AS DATE NO-UNDO.
DEFINE VARIABLE slutdatum AS DATE NO-UNDO.
DEFINE VARIABLE stregtid AS DECIMAL NO-UNDO.
DEFINE VARIABLE stttid AS DECIMAL NO-UNDO.
DEFINE VARIABLE slregtid AS DECIMAL NO-UNDO.
DEFINE VARIABLE slttid AS DECIMAL NO-UNDO.
DEFINE VARIABLE koll1 AS LOGICAL NO-UNDO.
DEFINE STREAM frlule. 
DEFINE STREAM frlulekop. 
DEFINE STREAM sjuklule. 
/*DEFINE STREAM stanslule. */

DEFINE BUFFER frbuff FOR TIDREGITAB.
DEFINE TEMP-TABLE franvarotemp
   FIELD PERSONALKOD LIKE PERSONALTAB.PERSONALKOD
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD FRTID AS DECIMAL FORMAT "99.99"
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD TITID AS DECIMAL FORMAT "99.99"
   FIELD PROCENT AS INTEGER FORMAT "999"
   FIELD TIMMAR AS DECIMAL FORMAT "99.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"   
   FIELD PKOD LIKE ANSTFORMTAB.KOD
   FIELD VIJUDID AS CHARACTER
   FIELD PNR AS CHARACTER
   FIELD TIMANSTALLD AS LOGICAL
   FIELD SJUK AS INTEGER EXTENT 31
   FIELD SJTIM AS DECIMAL EXTENT 31
   FIELD SJUKTIMMAR AS DECIMAL 
   FIELD ORSAK AS CHARACTER   
   FIELD KOMMENTAR AS CHARACTER   
   FIELD ARBDAGAR AS INTEGER   
   FIELD TTID AS DECIMAL     /*regtotalt -dagens arbetstid*/
   FIELD TOTTID AS DECIMAL   /*periodens totala timmar*/
   INDEX FRANVARO IS PRIMARY PNR FRAN LART ASCENDING
   INDEX VIJUDID VIJUDID PNR FRAN LART ASCENDING.
DEFINE TEMP-TABLE frvarotempsj NO-UNDO LIKE franvarotemp.
DEFINE TEMP-TABLE frfel
   FIELD PERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD TIMMAR AS DECIMAL FORMAT "99.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"
   INDEX FRANVARO IS PRIMARY  PERSONNUMMER FRAN LART ASCENDING. 

DEFINE BUFFER fbuff FOR  franvarotemp .
DEFINE BUFFER fbuff2 FOR  franvarotemp .
DEFINE BUFFER fbuff3 FOR  franvarotemp .

FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
   RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.
END FUNCTION.
{AMERICANEUROPEAN.I}
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
ASSIGN
Guru.Konstanter:globforetag = FORETAG.FORETAG
vkdatum = kordatum
gvisatidpermanad = TRUE
korvar = gkorvar.


IF Guru.Konstanter:globforetag = "MISV" THEN DO:
   /*Guru.Konstanter:AppSpringSet[1] = "misvstb"*/   
   prognamn5 = "D:\elpool\delad\pro10s\EXPORT\lon\".
   /*Guru.Konstanter:AppSpringSet[1] = "misvstb"*/   
   prognamn6 = "D:\elpool\delad\pro10s\EXPORT\lon\lonfiler\".
      
END.

OPEN QUERY persq FOR EACH PERSONALTAB WHERE PERSONALTAB.PERSMASK = TRUE 
AND PERSONALTAB.BRAVO = TRUE USE-INDEX PERSONALKOD NO-LOCK.
GET FIRST persq NO-LOCK.
DO WHILE AVAILABLE(PERSONALTAB):
   persrec = RECID(PERSONALTAB).
   personal = PERSONALTAB.PERSONALKOD.
   pnr = PERSONALTAB.PERSONNUMMER.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
   PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
   anst = ANSTFORMTAB.KOD.  
    /*TIDREGITAB.VECKOKORD = korvar AND*/  
   OPEN QUERY tidq FOR EACH TIDREGITAB WHERE 
   TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM > 12/31/2012 AND 
   TIDREGITAB.GODKAND BEGINS "G" AND 
   SUBSTRING(TIDREGITAB.VECKOKORD,1,9) NE "" AND SUBSTRING(TIDREGITAB.VECKOKORD,10,9) = korvar AND   
   TIDREGITAB.DATUM <= vkdatum AND TIDREGITAB.TIDLOG = TRUE
   USE-INDEX PSTART NO-LOCK.          
   GET FIRST tidq NO-LOCK.         
   DO WHILE AVAILABLE(TIDREGITAB):         
      krav = 0.             
      FIND FIRST FRDEL WHERE FRDEL.PERSONALKOD = personal AND
      FRDEL.AONR = TIDREGITAB.AONR USE-INDEX FRDEL NO-LOCK NO-ERROR.
      IF AVAILABLE FRDEL THEN ASSIGN onr = FRDEL.AONR dnr = FRDEL.DELNR krav = 1.      
      FIND FIRST FVARO WHERE FVARO.AONR = TIDREGITAB.AONR
      AND FVARO.DELNR = TIDREGITAB.DELNR USE-INDEX FVARO NO-LOCK NO-ERROR.
      IF NOT AVAILABLE FVARO THEN krav = 1. 
      regdatum = TIDREGITAB.DATUM.
      regvnr = TIDREGITAB.VECKONUMMER.
      RUN SLUTARB.P.
      IF regstart = regslut THEN krav = 1.
      IF regstart NE regslut THEN DO:
         IF TIDREGITAB.START GE regslut AND TIDREGITAB.SLUT > regslut THEN krav = 1.
         IF TIDREGITAB.START < regstart AND TIDREGITAB.SLUT LE regstart THEN krav = 1.
      END.   
      IF TIDREGITAB.TOTALT = 0 THEN krav = 1.
      IF krav = 0 THEN DO:  
         ASSIGN
         /*rec = RECID(TIDREGITAB)*/
         onr2 = TIDREGITAB.AONR
         dnr2 = TIDREGITAB.DELNR
         kommentar = TIDREGITAB.RESMAL.
         FIND FIRST FVARO WHERE FVARO.AONR = onr2
         AND FVARO.DELNR = dnr2 USE-INDEX FVARO NO-LOCK NO-ERROR.
         IF AVAILABLE FVARO THEN DO TRANSACTION:	
            ASSIGN
            fkod = FVARO.FRKOD
	         pc = FVARO.PROC
	         del1 = FVARO.DEL   /* ti-timmar pr-procent he-heldag */
            frstart = TIDREGITAB.START
            frslut = TIDREGITAB.SLUT. 
            FIND LAST franvarotemp WHERE franvarotemp.PNR = pnr AND
	         franvarotemp.AONR = onr2 AND franvarotemp.DELNR = dnr2
	         USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE franvarotemp THEN DO:
               ASSIGN
	            regdatum = TIDREGITAB.DATUM
	            regvnr = TIDREGITAB.VECKONUMMER.
	            RUN SLUTARB.P.
	            nytid = regstart.
	            RUN TIMSEK.P.              /* raknar ut totala tiden */
               ASSIGN
	            starttiden = sekunder
	            nytid = regslut.
               RUN TIMSEK.P.
               ASSIGN
               sluttiden = sekunder
               regdatum = TIDREGITAB.DATUM
               regvnr = TIDREGITAB.VECKONUMMER.
     	         RUN NORDFTO.P.
     	         tott1 = nytid.
     	        RUN TIMSEK.P.
     	        tott2 = sekunder.
     	        IF regstart = regslut THEN ASSIGN proc1 = 000 antal = 0.      	        
	           ELSE IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
	           THEN DO:
	              nytid = TIDREGITAB.TOTALT.
	              RUN TIMSEK.P.
	              IF tott2 LE 0 THEN proc1 = 0.
	              ELSE  proc1 = 100 * sekunder / tott2.               
	              IF pc NE TRUE THEN  antal = TIDREGITAB.TOTALT.	              
	           END. 
              ELSE IF TIDREGITAB.AONR = "160" OR TIDREGITAB.AONR = "161" OR  TIDREGITAB.AONR = "162" OR TIDREGITAB.AONR = "170" OR TIDREGITAB.AONR = "300"   
              /*OR TIDREGITAB.AONR = "171"*/    THEN DO:                                  
                 /* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna                                                   
                 406- arbetstidsförkortning 160
                 406- arbetstidsförkortning 161 SVAB
                 860- kompledighet 170
                 861- 6 JUNI 162
                 693 - förtroendemannauppdrag 300 SEAB
                 - veckovila 171                                                   
                 franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
                 franvarotemp.TTID- TIMMAR DEL AV DAG
                 */
                 antal = TIDREGITAB.TOTALT.
              END.
              ELSE ASSIGN   proc1 = 100  antal = 0.                 	          
              /*Avrunda inte frånvaro*/ 
              ASSIGN
              antal2 =  klock100(antal)
              tott3 = klock100(tott1)                          
              proc2 = 100 * antal2 / tott3
              regdat3 = TIDREGITAB.DATUM
              regdat4 = TIDREGITAB.DATUM
              frstart = TIDREGITAB.START
              frslut = TIDREGITAB.SLUT. 
	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3  AND
	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
	              ASSIGN
	              regdat3 = TIDREGITAB.DATUM - 1 
                 regdat5 = regdat3
                 frstart = 00.00.
                 IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.                                     
                 ELSE DO:
                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                    IF AVAILABLE OVERAVTAB THEN DO:
                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
                    END.
                 END.                                  
                 dat:
                 REPEAT:
                    IF regdat5 = regdat3 THEN LEAVE dat.
                    IF regdat5 > regdat3 THEN DO:    
                       regdat5 = regdat3.
                       IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                       ELSE DO:
                          FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                          OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                          IF AVAILABLE OVERAVTAB THEN DO:
                             IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
                          END.
                       END.
                    END.
                 END.   
                 IF DAY(regdat3) GE 26 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
                    IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                    ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
                 END.  	     
                 ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                 
              END.              	         	        
              ELSE IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
              DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	           ASSIGN
   	           regdat4 = TIDREGITAB.DATUM + 1 
   	           regdat5 = regdat4
                 frslut = 24.00.                  
     	           IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	              END.
   	           END. 
   	           IF regdat4 = regdat5 THEN ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	           
   	           dat2:
   	           REPEAT:
   	              IF regdat4 = regdat5 THEN LEAVE dat2. 
    	              IF regdat4 > regdat5 THEN DO:
   	                 regdat5 = regdat4.
                           IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                           ELSE DO:
   	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                    END.
   	                 END.    
   	              END.
   	           END.   
   	           IF DAY(regdat4) LE 3 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
      	              FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
   	              IF AVAILABLE frbuff THEN DO: 
   	                 IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                    ASSIGN
   	                    regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                    regdat4 = regdat5 - 1.
   	                 END.
   	                 ELSE  ASSIGN regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))  regdat4 = regdat5 - 1.   	                 
   	              END.  
   	              ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                                            
   	           END.              
                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                  
                 IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	              ASSIGN
   	              regdat3 =  TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3.
                    frstart = 00.00.
   	              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
   	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
                              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                              ELSE DO:
     	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   	       
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1  AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                    END.                 
   	              /*2010/02/19  IF AVAILABLE frbuff THEN regdat3 = regdat3 + 1 .	              */
                    IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                    ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
   	           END.                                  
   	        END.    	    
   	        ELSE IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	           ASSIGN
   	           regdat3 = TIDREGITAB.DATUM - 1 
   	           regdat5 = regdat3.
                 frstart = 00.00.
   	           IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	              END.
   	           END.                                  
   	           dat:
   	           REPEAT:
   	              IF regdat5 = regdat3 THEN LEAVE dat.
   	              IF regdat5 > regdat3 THEN DO:    
   	                 regdat5 = regdat3.
                       IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                       ELSE DO:
     	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                    END.
   	                 END.
   	              END.
   	           END.   	                   
                 IF onr2 = "118" THEN DO:
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 AND frbuff.RESMAL = kommentar NO-LOCK NO-ERROR.
                 END.
                 ELSE DO:                 
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                 END.
   	           /*IF AVAILABLE frbuff THEN regdat3 = regdat3 + 1 .	              */
                 IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                 ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                 
   	        END.              	                           
   	        CREATE franvarotemp.
   	        ASSIGN 
            franvarotemp.PERSONALKOD = personal  franvarotemp.PNR = pnr franvarotemp.AONR = onr2
   	        franvarotemp.DELNR = dnr2 franvarotemp.LART = fkod
   	        franvarotemp.FRAN = regdat3 franvarotemp.TILL = regdat4
   	        franvarotemp.PROCENT = proc1 franvarotemp.TIMMAR = antal2 franvarotemp.PKOD = anst
              /*franvarotemp.NAMN = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN*/
              /*franvarotemp.PROCENT2 = proc2 franvarotemp.TIMMAR2 = antal2*/ franvarotemp.KOMMENTAR  = kommentar.
              /*franvarotemp.TOTTIMMAR = franvarotemp.TIMMAR2.*/               	       
              ASSIGN
    	        franvarotemp.FRTID = frstart 
   	        franvarotemp.TITID = frslut.  
              FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
              FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = PERSONALTAB.OMRADE NO-LOCK NO-ERROR.
              FIND FIRST AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK NO-ERROR.
              FIND FIRST JURPERS WHERE JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK NO-ERROR.      
              IF AVAILABLE JURPERS THEN ASSIGN franvarotemp.VIJUDID = JURPERS.VIJUDID.              
   	     END.           
           ELSE DO:
   	        regdatum = TIDREGITAB.DATUM - 1.
   	        RUN REGVEC.P.
   	        RUN SLUTARB.P.
   	        IF regstart = regslut THEN DO:
   	           REPEAT:
   	              IF regstart ne regslut THEN LEAVE.
   	              /*SÅ ATT DET INTE SKA BLI LOP OM PERSONEN STARTAR SIN ANSTÄLLNING MED FRÅNVARO*/
                    IF regdatum < ( TIDREGITAB.DATUM - 31 ) THEN LEAVE.
   	              regdatum = regdatum - 1.
   	              RUN REGVEC.P.
   	              RUN SLUTARB.P.
   	           END.
   	        END.
   	        ASSIGN
   	        regdatum2 = regdatum
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN SLUTARB.P.	   
   	        nytid = regstart.
   	        RUN TIMSEK.P. 
   	        ASSIGN             /* raknar ut totala tiden */
   	        starttiden = sekunder
   	        nytid = regslut.
   	        RUN TIMSEK.P.
   	        ASSIGN
   	        sluttiden = sekunder
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN NORDFTO.P.
   	        tott1 = nytid.
   	        RUN TIMSEK.P.
   	        tott2 = sekunder.	   
              /*IF tott2 > 28800 THEN tott2 = 28800.*/
   	        IF franvarotemp.TILL < regdatum2
   	        OR franvarotemp.PROCENT < 100
   	        OR TIDREGITAB.TOTALT < tott1 OR TIDREGITAB.SLUT = 24 THEN DO:
   	           IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
   	           THEN DO:                  
   	              nytid = TIDREGITAB.TOTALT.
   	              RUN TIMSEK.P.               
   	              IF tott2 LE 0 THEN proc1 = 0.
   	              ELSE proc1 = 100 * sekunder / tott2.	           
   	              IF pc NE TRUE THEN antal = nytid.		             	              
   	           END.	    	           
                 ELSE IF  TIDREGITAB.AONR = "160" OR TIDREGITAB.AONR = "161" OR  TIDREGITAB.AONR = "162"  OR TIDREGITAB.AONR = "170"  OR TIDREGITAB.AONR = "300" 
                 /*OR TIDREGITAB.AONR = "171"*/   THEN DO:                                  
                    /* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna                                                      
                    406- arbetstidsförkortning 160
                    406- arbetstidsförkortning 161 SVAB
                    860- kompledighet 170
                    861- 6 JUNI 162
                    693- förtroendemannauppdrag SEAB 300
                    - veckovila 171                                                      
                    franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
                    franvarotemp.TTID- TIMMAR DEL AV DAG
                    */
                    antal = TIDREGITAB.TOTALT.
                 END.
                 ELSE DO:
   	              ASSIGN  proc1 = 100  antal = 0.
                    /*antal = nytid.	              */
   	           END.                                       
                 /*Inga avrundningar på frånvaro*/
                 ASSIGN
                 antal2 =  klock100(antal)
                 tott3 = klock100(tott1).                 
                 proc2 = 100 * antal2  / tott3. 
                 regdat3 = TIDREGITAB.DATUM.
                 frstart = TIDREGITAB.START.
   	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3 AND
   	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
   	              ASSIGN
   	              regdat3 = TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3
                    frstart = 00.00.
   	              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
     	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
                          IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   
   	              IF DAY(regdat3) GE 26 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN regdat3 =  DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).
         	           ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                       
   	              END.  	   
   	              ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
   	           END.              	         
   	           ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                  
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4
                    frslut = 24.00. 
   	              IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                       IF AVAILABLE OVERAVTAB THEN DO:
    	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
      	           END.   
   	              IF regdat4 = regdat5 THEN ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	              
   	              dat2:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat2. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
                          IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                           IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
     	                    END.      
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO:
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                       ASSIGN
   	                       regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))
     	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                        
   	              END.                              
   	              ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                     
   	           END.  	    
   	           CREATE franvarotemp.
   	           ASSIGN franvarotemp.PERSONALKOD = personal franvarotemp.PNR = pnr franvarotemp.AONR = onr2
   	           franvarotemp.DELNR = dnr2 franvarotemp.LART = fkod
   	           franvarotemp.FRAN = regdat3 franvarotemp.TILL = regdat4
   	           franvarotemp.PROCENT = proc1 franvarotemp.TIMMAR = antal2 franvarotemp.PKOD = anst
                 /*franvarotemp.NAMN = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN
                 franvarotemp.PROCENT2 = proc2 franvarotemp.TIMMAR2 = antal2*/ franvarotemp.KOMMENTAR  = kommentar.
                 /*franvarotemp.TOTTIMMAR = franvarotemp.TIMMAR2.*/   	           
                 ASSIGN
    	           franvarotemp.FRTID = frstart 
   	           franvarotemp.TITID = frslut.
                 FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                 FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = PERSONALTAB.OMRADE NO-LOCK NO-ERROR.
                 FIND FIRST AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK NO-ERROR.
                 FIND FIRST JURPERS WHERE JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK NO-ERROR.      
                 IF AVAILABLE JURPERS THEN ASSIGN franvarotemp.VIJUDID = JURPERS.VIJUDID.                 
   	        END.
              ELSE DO:      
                 ASSIGN
   	           regdat4 = TIDREGITAB.DATUM
                 frslut = TIDREGITAB.SLUT
                 dagtot = 0.                                 
                 /* Ingen avrundning på frånvaro*/
                 dagtot = klock100(TIDREGITAB.TOTALT).
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4.
                    frslut = 24.00. 
   	              IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
   	              END.        
   	              IF regdat4 = regdat5 THEN  ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	              
   	              dat3:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat3. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
                          IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
   	                    END.    
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO: 
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO: 
                             ASSIGN regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)                          
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM)).
   	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                        
   	              END.
   	              ELSE ASSIGN  regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                     
   	           END.  	    
                 ASSIGN franvarotemp.TILL = regdat4
                 franvarotemp.TITID = frslut.
                 /*franvarotemp.TOTTIMMAR = franvarotemp.TOTTIMMAR + dagtot.                 */
                                         
              END. 
            END.
            IF del1 = FALSE AND franvarotemp.PROCENT < 100 THEN DO:
               CREATE frfel.
               ASSIGN frfel.PERSONNUMMER = franvarotemp.PNR frfel.AONR = franvarotemp.AONR  
  	            frfel.DELNR = franvarotemp.DELNR frfel.LART = franvarotemp.LART
	            frfel.FRAN =   franvarotemp.FRAN frfel.TILL = franvarotemp.TILL 
	            frfel.PROCENT = franvarotemp.PROCENT frfel.TIMMAR = franvarotemp.TIMMAR.
	         END.      
         END.
      END.
      GET NEXT tidq NO-LOCK.
   END.
   GET NEXT persq NO-LOCK.
END.       
prognamn3 = prognamn5 + "ftest"  + STRING(TODAY,"999999") + ".d".
OUTPUT TO VALUE(prognamn3).     
/* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna
frånvarolöneart
406- arbetstidsförkortning 160
406- arbetstidsförkortning 161 svab
693 - förtroendemannauppdrag 300 SEAB
860- kompledighet 170
861- 6 JUNI 162
franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
franvarotemp.TTID- regtotalt DEL AV DAG
*/
FOR EACH franvarotemp WHERE franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861" :
   IF franvarotemp.FRAN NE franvarotemp.TILL THEN DO:
      IF MONTH(franvarotemp.FRAN) < MONTH(franvarotemp.TILL) THEN DO:              
         ASSIGN regdat1 = franvarotemp.TILL
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2
         regdat2 = regdat2 + 1.     
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.     
      END.
      ASSIGN       
      regdatum = franvarotemp.FRAN 
      avdatum = franvarotemp.TILL.
      komptid = 0.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
      persrec = RECID(PERSONALTAB).
      REPEAT:      
         RUN REGVEC.P.
         RUN SLUTARB.P.
         IF regstart NE regslut THEN komptid = komptid + klock100(regtotalt).                      
         regdatum = regdatum + 1.
         IF regdatum > avdatum THEN LEAVE.         
      END.
      franvarotemp.TOTTID = komptid.
      EXPORT franvarotemp.
   END.   
END.
OUTPUT CLOSE.

RUN ftemp_UI.

FOR EACH franvarotemp WHERE LENGTH(franvarotemp.PNR) = 10:
   IF SUBSTRING(franvarotemp.PNR,1,1) = "0" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE IF SUBSTRING(franvarotemp.PNR,1,1) = "1" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE IF SUBSTRING(franvarotemp.PNR,1,1) = "2" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE franvarotemp.PNR = "19" + franvarotemp.PNR.
    
END.



DO TRANSACTION:      
       
   IF Guru.Konstanter:globforetag = "MISV" THEN DO:   
      /*MITTSVERIGE VATTEN AB*/               
      IF korvar = "" THEN DO:      
         prognamn3 = prognamn5 + "frkollMSV.d".
         OUTPUT STREAM sjuklule TO VALUE(prognamn3) NO-ECHO.   
         prognamn3 = prognamn5 + "MSV.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.
         lonfil =  "MSVfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.           
      END.
      ELSE DO:
         prognamn3 = prognamn5 + "frkollomkMSV.d".
         OUTPUT STREAM sjuklule TO VALUE(prognamn3) NO-ECHO.   
         prognamn3 = prognamn5 + "MSVomk.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.      
         lonfil =  "MSVomkfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.            
      END.
      anstperson = "".
      FOR EACH franvarotemp WHERE franvarotemp.VIJUDID = "SVAB" USE-INDEX VIJUDID:
         overrapp2 = "".
         IF anstperson NE franvarotemp.PNR THEN DO: 
            overrapp2 = "".         
            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR NO-LOCK NO-ERROR.            
            ASSIGN
            SUBSTRING(overrapp2,2,11) = STRING(franvarotemp.PNR,"999999-9999").
            IF AVAILABLE PERSONALTAB THEN SUBSTRING(overrapp2,14,38) = PERSONALTAB.PERSONALKOD + " " + PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN.           
            anstperson = franvarotemp.PNR.                        
         END.
         
         ASSIGN overrapp2 = "".   
         ASSIGN                        
         SUBSTRING(overrapp2,2,8) = SUBSTRING(franvarotemp.LART,1,8)
         SUBSTRING(overrapp2,24,10) = STRING(franvarotemp.FRAN,"99999999")
         SUBSTRING(overrapp2,39,10) = STRING(franvarotemp.TILL,"99999999").         
         
         IF franvarotemp.LART = "600" OR franvarotemp.LART = "605" OR franvarotemp.LART = "606"
         OR franvarotemp.LART = "601" OR franvarotemp.LART = "603" OR franvarotemp.LART = "604"
         OR franvarotemp.LART = "607" OR franvarotemp.LART = "608" OR franvarotemp.LART = "615" THEN DO:                 
            IF franvarotemp.TIMMAR > 0 THEN DO:                       
               /*franvarotemp.LART = "602". */
               omfatt = 0.
               IF franvarotemp.TTID > 0 THEN DO:      
                  omfatt = ( franvarotemp.TIMMAR / franvarotemp.TTID) * 100.
                  IF omfatt > 100 THEN omfatt = 100.
               END.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               STRING(omfatt,"999.99") 
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
            END.
            ELSE DO:         
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               "100.00" 
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
            END.         
         END.   
         /*ELSE IF franvarotemp.LART = "440" OR franvarotemp.LART = "465" OR franvarotemp.LART = "623" OR franvarotemp.LART = "692"
         OR franvarotemp.LART = "693" OR franvarotemp.LART = "860" OR franvarotemp.LART = "865" THEN  DO:*/
         ELSE IF franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861" THEN  DO:
            /*timavdrag*/         
            /*rgr = "    ".*/
            /*IF franvarotemp.LART = "440" THEN rgr = "1420".*/
            IF franvarotemp.TIMMAR > 0 THEN DO:  
               IF franvarotemp.FRAN = franvarotemp.TILL THEN DO:               
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").
                  /*SUBSTRING(overrapp2,64,4) = SUBSTRING(rgr,1,4).*/
               END.
               ELSE DO:            
                  frantim = franvarotemp.TOTTID * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TOTTID,"999.99").
                  /*SUBSTRING(overrapp2,64,4) = SUBSTRING(rgr,1,4).*/
               END.
            END.
            /*PUT STREAM sjuklule overrapp1 SKIP. */
         END.
         ELSE IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100 THEN  DO:
            /*timavdrag för föräldraledighet del av dag 20071106*/         
            franvarotemp.LART = "660".  
            IF franvarotemp.TIMMAR > 0 THEN DO:              
               frantim = franvarotemp.TIMMAR * 100.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "L" + franvarotemp.LART + 
               STRING(frantim,"-999999999") +
               "000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +
               "0000000000000000" +
               "00000 " +         
               "                    " +
               "                    " +
               "            " +
               "                    " +              
               "100.00"          
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                        
            END.         
         END.
         ELSE DO:
            /*kalenderdagavdrag*/      
            IF franvarotemp.TIMMAR > 0 THEN DO:                          
               IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100  THEN franvarotemp.LART = "660".            
               IF franvarotemp.LART = "621" AND franvarotemp.PROCENT < 100 THEN franvarotemp.LART = "620". 
               IF franvarotemp.LART = "620" THEN DO:
                  /* Timavdrag om det är det av dag för tjäntledighet utan lön enligt Ingrid 20080812*/              
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00"          
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").
                  /*SUBSTRING(overrapp2,64,4) = SUBSTRING(rgr,1,4).*/
                 
               END.
               ELSE DO:            
                  omfatt = 0.
                  IF franvarotemp.TTID > 0 THEN DO:      
                     omfatt = ( franvarotemp.TIMMAR / franvarotemp.TTID) * 100.
                     IF omfatt > 100 THEN omfatt = 100.
                  END.
                  IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:
                     /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal*/
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART + 
                     STRING(omfatt,"-999999999") +
                     "000000000000000000000000000" +               
                    /* "0000000000" +
                     "000000000000000000000000000" +*/
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +
                     "100.00"
                     /*STRING(omfatt,"999.99") */
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  "100.00".
                  END.
                  ELSE DO:
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART + 
                     /*STRING(frantim,"-999999999") +*/
                     "0000000000" +
                     "000000000000000000000000000" +
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +
                     STRING(omfatt,"999.99") 
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
                  END.
               END.
            END.
            ELSE DO:
               /* lägg in hela dagar sem lart 501*/
               ASSIGN
               startm = FALSE
               slutm = FALSE
               startdatum = ?
               slutdatum = ?.
               IF franvarotemp.LART = "661" OR franvarotemp.LART = "621" /*OR franvarotemp.LART = "694"*/ THEN DO:
                  IF DAY(franvarotemp.FRAN)  > 01 AND DAY(franvarotemp.FRAN)  LE 04 THEN DO:
                     regdatum = franvarotemp.FRAN - 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN DO:
                           regdatum = regdatum - 1.
                        END.
                        ELSE LEAVE.                     
                        IF DAY(regdatum) > DAY(franvarotemp.FRAN) THEN DO: 
                           regdatum = regdatum + 1.
                           IF DAY(regdatum) = 01 THEN DO: 
                              startm = TRUE.
                              startdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.
                  END.
                  IF DAY(franvarotemp.TILL)  > 26 AND DAY(franvarotemp.TILL + 1) > 26 THEN DO:
                     regdatum = franvarotemp.TILL + 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN regdatum = regdatum + 1.                     
                        ELSE LEAVE.                     
                        IF DAY(regdatum) < DAY(franvarotemp.TILL) THEN DO: 
                           regdatum = regdatum - 1.
                           IF DAY(regdatum + 1 ) = 01 THEN DO: 
                              slutm = TRUE.
                              slutdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.                  
                  END.
                  IF startm = TRUE AND slutm = TRUE THEN DO:
                     IF startdatum NE ? AND slutdatum NE ? THEN DO:                  
                        ASSIGN
                        franvarotemp.FRAN = startdatum
                        franvarotemp.TILL = slutdatum.
                     END.
                  END.
               END.
               IF franvarotemp.LART = "661" THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "662".                           
               IF franvarotemp.LART = "621"  THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "622".                           
               IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:
                  /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal*/
                  IF franvarotemp.FRAN = franvarotemp.TILL  THEN omfatt = 100.
                  ELSE omfatt = franvarotemp.ARBDAGAR * 100.                             
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                   STRING(omfatt,"-999999999") +                 
                  /*STRING(omfatt,"-999999999") +*/
                  "000000000000000000000000000" +               
                 /* "0000000000" +
                  "000000000000000000000000000" +*/
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  "100.00".
               END.
               ELSE DO:            
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + "0000000000000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
               END.
            END.
         /*   PUT STREAM sjuklule overrapp1 SKIP. */      
         END.
         IF franvarotemp.LART = "600" OR franvarotemp.LART = "605" OR franvarotemp.LART = "606" 
         OR franvarotemp.LART = "601" OR franvarotemp.LART = "603" OR franvarotemp.LART = "604" 
         OR franvarotemp.LART = "607" OR franvarotemp.LART = "608" OR franvarotemp.LART = "615" THEN DO:                 
            PUT STREAM sjuklule overrapp1 SKIP. 
         END.
         PUT STREAM frlule overrapp1 SKIP.
         PUT STREAM frlulekop overrapp1 SKIP.         
         DELETE franvarotemp.
         overrapp1 = "".
      END.   
      overrapp1 = "999999".
      PUT STREAM frlule overrapp1 SKIP.
      PUT STREAM frlulekop overrapp1 SKIP.      
      OUTPUT STREAM sjuklule CLOSE.      
      OUTPUT STREAM frlule CLOSE.
      OUTPUT STREAM frlulekop CLOSE.      
      /*prognamn3 = prognamn5 + "MSVstanstid" + ".d".   
      prognamn = prognamn5 + "MSVstanstid" + STRING(TODAY,"999999") + ".d".              
      OS-COPY VALUE(prognamn3) VALUE(prognamn).*/         
   END.
END.



IF korvar = "" THEN prognamn3 = prognamn5 + "fransu.d".   
ELSE prognamn3 = prognamn5 + "fransuomk.d".   
OUTPUT TO VALUE(prognamn3) NO-ECHO.

FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
  EXPORT franvarotemp.
END.
OUTPUT CLOSE.
IF korvar = "" THEN prognamn3 = prognamn5 + "felpers.d".   
ELSE prognamn3 = prognamn5 + "felpersomk.d".   
OUTPUT TO VALUE(prognamn3) APPEND.
FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
  EXPORT franvarotemp.
END.
OUTPUT CLOSE.

IF Guru.Konstanter:globforetag = "misv" THEN DO:   
   IF korvar = "" THEN DO:   
      lonfil =  "MSV" + STRING(TODAY,"99999999") + ".wli".
      prognamn = prognamn6  + lonfil.        
      prognamn3 = prognamn5 + "MSV.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn). 
      prognamn = prognamn5  + lonfil.              
      OS-COPY VALUE(prognamn3) VALUE(prognamn).                  
   END.
   ELSE DO:   
      prognamn = prognamn5 + "MSVomk" + STRING(TODAY,"999999") + ".wli".        
      prognamn3 = prognamn5 + "MSVomk.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn).               
   END.
END.

/*RUN SULOFRN.P.*/
RUN sammut_UI (INPUT 2).
{EUROPEANAMERICAN.I}
PROCEDURE ftemp_UI:
   FOR EACH franvarotemp WHERE franvarotemp.FRAN = franvarotemp.TILL :   
      IF franvarotemp.TIMMAR > 0 THEN DO:   
         /*regtotalt DEL AV DAG*/
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
         persrec = RECID(PERSONALTAB).       
         regdatum = franvarotemp.FRAN. 
         RUN REGVEC.P.
         RUN SLUTARB.P.
         ASSIGN
         franvarotemp.TTID = klock100(regtotalt).         
      END.   
   END.
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\allfranfskift.d NO-ECHO.
   END.   
   
   FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.  
   /*SKIFT dela upp i skiftdygnet*/
   FOR EACH franvarotemp WHERE franvarotemp.TITID = 24 AND franvarotemp.FRAN = franvarotemp.TILL BY franvarotemp.PERSONALKOD BY franvarotemp.FRAN:
      IF franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861"  THEN.
      ELSE DO:         
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
         persrec = RECID(PERSONALTAB).       
         regdatum = franvarotemp.FRAN. 
         RUN REGVEC.P.
         RUN SLUTARB.P.      
         ASSIGN
         stregtid = klock100(franvarotemp.TITID) - klock100(franvarotemp.FRTID).      
         IF regstart = 0 THEN stttid = klock100(regslut) - klock100(lunchslutet).
         ELSE stttid = klock100(regslut) - klock100(regstart).
         regdatum = regdatum + 1.
         RUN REGVEC.P.
         RUN SLUTARB.P.
         IF regslut = 24 THEN slttid = klock100(lunchstarten) - klock100(regstart).
         ELSE slttid = klock100(regslut) - klock100(regstart).                          
         FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.FRAN = franvarotemp.TILL + 1
         /*AND fbuff.FRAN = fbuff.TILL*/ AND fbuff.LART = franvarotemp.LART AND fbuff.FRTID = 00 NO-ERROR.
         IF AVAILABLE fbuff THEN DO:
            ASSIGN
            slregtid = klock100(fbuff.TITID) - klock100(fbuff.FRTID).                
            koll1 = FALSE.
            IF stregtid = stttid AND slregtid = slttid THEN koll1 = TRUE.
            IF stregtid = stttid AND fbuff.FRAN NE fbuff.TILL THEN koll1 = TRUE.
            IF koll1 = TRUE THEN DO:
               FIND FIRST fbuff2 WHERE fbuff2.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff2.TILL = franvarotemp.FRAN - 1
               AND fbuff2.LART = franvarotemp.LART  NO-ERROR.            
               IF stttid > slttid THEN DO:
                  ASSIGN franvarotemp.PROCENT = 100 franvarotemp.TIMMAR = stregtid + slregtid 
                  franvarotemp.TTID = franvarotemp.TIMMAR franvarotemp.TITID = fbuff.TITID.               
                  DELETE fbuff.
               END.
               ELSE DO:
                  FIND FIRST fbuff3 WHERE fbuff3.PERSONALKOD = franvarotemp.PERSONALKOD AND
                  fbuff3.FRAN = franvarotemp.FRAN AND fbuff3.LART = franvarotemp.LART AND RECID(fbuff3) NE RECID(franvarotemp)  NO-ERROR.
                  ASSIGN fbuff.PROCENT = 100 fbuff.TIMMAR = stregtid + slregtid 
                  fbuff.FRTID = franvarotemp.FRTID fbuff.TTID = fbuff.TIMMAR.
                  IF AVAILABLE fbuff2 THEN DO:                                    
                     /*IF NOT AVAILABLE fbuff3 THEN DO:
                        /*problem vid hoptolkning bakåt. Första dagen 7-15 nästa dag 22-07 ger då 3 dagar ej 2 . carina bergman Ok skicka med uppehåll?*/
                        ASSIGN fbuff.FRAN = franvarotemp.FRAN.
                     END.                  */
                     
                  END.
                  IF NOT AVAILABLE fbuff3 THEN DO:
                     DELETE franvarotemp.   
                  END.
               END.
            END.
            ELSE DO:
               IF franvarotemp.FRAN = franvarotemp.TILL THEN DO: 
                  ASSIGN franvarotemp.PROCENT = stregtid / (stttid + slttid)            
                  franvarotemp.TIMMAR = stregtid 
                  franvarotemp.TTID = stttid + slttid.
               END.
               IF fbuff.FRAN = fbuff.TILL THEN DO: 
                  ASSIGN fbuff.PROCENT = slregtid / (stttid + slttid)
                  fbuff.TIMMAR = slregtid 
                  fbuff.TTID = stttid + slttid.
               END.
               /*IF fbuff.FRAN NE fbuff.TILL THEN DO: 
                  ccc
               END.*/
            END.
         END.
         ELSE DO:
            IF franvarotemp.FRAN = franvarotemp.TILL THEN DO: 
               ASSIGN franvarotemp.PROCENT = stregtid / (stttid + slttid)
               franvarotemp.TIMMAR = stregtid 
               franvarotemp.TTID = stttid + slttid.  
            END.
         END.
      END.   
   END.
   
   /*test att ta bort*/
   FOR EACH franvarotemp WHERE franvarotemp.FRAN = franvarotemp.TILL AND franvarotemp.TTID NE franvarotemp.TIMMAR :   
      /*Om uppdelning på flera registreringar samma dag , slå ihop till 1 registrering 20070423*/
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.TILL = franvarotemp.TILL
      AND fbuff.FRAN = franvarotemp.FRAN AND fbuff.LART = franvarotemp.LART AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
      IF AVAILABLE fbuff THEN DO:
         franvarotemp.TIMMAR = franvarotemp.TIMMAR + fbuff.TIMMAR.   
         franvarotemp.PROCENT = franvarotemp.PROCENT + fbuff.PROCENT.         
         DELETE fbuff.
      END.
   END.
   FOR EACH franvarotemp WHERE franvarotemp.FRAN NE franvarotemp.TILL :   
      /*Ta bort dubbelregistrering startdag*/
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.FRAN = franvarotemp.FRAN AND
      fbuff.LART = franvarotemp.LART AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
      IF AVAILABLE fbuff THEN DO:      
         DELETE fbuff.
      END.
   END.
   /*117- 663 pappaledgihet vid barns födelse
    118 - 655 Tillfällig vård av barn
    119 - 660,661,662 Föräldraledighet tillaggt 20081002
    135 -623  Enskild angelägenhet
    skicka kommentar
    118 -655 ejlängre kommentar till lön Ingrid 20100825*/
   FOR EACH franvarotemp :
       IF franvarotemp.LART = "663" /*OR franvarotemp.LART = "655"*/ THEN franvarotemp.KOMMENTAR = SUBSTRING(franvarotemp.KOMMENTAR,1,6) + "-" + SUBSTRING(franvarotemp.KOMMENTAR,7,4).      
       ELSE IF franvarotemp.LART = "660" OR franvarotemp.LART = "661" OR franvarotemp.LART = "662" THEN
       franvarotemp.KOMMENTAR = SUBSTRING(franvarotemp.KOMMENTAR,1,6) + "-" + SUBSTRING(franvarotemp.KOMMENTAR,7,4).      
       ELSE IF franvarotemp.LART = "623"  THEN franvarotemp.KOMMENTAR = franvarotemp.KOMMENTAR .
       ELSE ASSIGN franvarotemp.KOMMENTAR = "".    
   END.
   /*FOR EACH franvarotemp WHERE franvarotemp.LART = "KL" AND  franvarotemp.FRAN NE franvarotemp.TILL:
      ASSIGN
      komptid = 0
      regdatum = franvarotemp.FRAN + 1
      avdatum = franvarotemp.TILL.
      komptid =  franvarotemp.TIMMAR.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      IF NOT AVAILABLE PERSONALTAB  THEN DO:
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      END.
      FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
      PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
      REPEAT:   
         musz = FALSE.
         FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND
         OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.   
         IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 1  THEN musz = TRUE.
         ELSE IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 7  THEN musz = TRUE.      
         ELSE IF WEEKDAY(regdatum) = 1 THEN musz = TRUE.
         ELSE IF WEEKDAY(regdatum) = 7 THEN musz = TRUE.
         IF musz = TRUE THEN DO:
             musz = FALSE.
             regdatum = regdatum + 1.
             IF regdatum > avdatum THEN LEAVE.
             NEXT.
         END.
         franvarotemp.TIMMAR = franvarotemp.TIMMAR + komptid.
         regdatum = regdatum + 1.
         IF regdatum > avdatum THEN LEAVE.
      END.   
   END.         
   FOR EACH franvarotemp WHERE franvarotemp.LART = "5916" AND  franvarotemp.FRAN NE franvarotemp.TILL:
      ASSIGN
      komptid = 0
      regdatum = franvarotemp.FRAN + 1
      avdatum = franvarotemp.TILL.
      komptid =  franvarotemp.TIMMAR.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      IF NOT AVAILABLE PERSONALTAB  THEN DO:
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      END.
      FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
      PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
      REPEAT:   
         musz = FALSE.
         FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND
         OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.   
         IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 1  THEN musz = TRUE.
         ELSE IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 7  THEN musz = TRUE.      
         ELSE IF WEEKDAY(regdatum) = 1 THEN musz = TRUE.
         ELSE IF WEEKDAY(regdatum) = 7 THEN musz = TRUE.
         IF musz = TRUE THEN DO:
             musz = FALSE.
             regdatum = regdatum + 1.
             IF regdatum > avdatum THEN LEAVE.
             NEXT.
         END.
         franvarotemp.TIMMAR = franvarotemp.TIMMAR + komptid.
         regdatum = regdatum + 1.
         IF regdatum > avdatum THEN LEAVE.
      END.   
   END.*/
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\sjkoll.d NO-ECHO.
   END.   

   
   FOR EACH franvarotemp WHERE franvarotemp.LART = "SJ" USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.  
   
   /*skilj ut karensdag*/
   /*FOR EACH franvarotemp WHERE franvarotemp.LART = "SJ":
      IF franvarotemp.FRAN NE franvarotemp.TILL THEN DO:
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
         IF NOT AVAILABLE PERSONALTAB  THEN DO:
            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
         END.
         IF AVAILABLE PERSONALTAB THEN DO:      
            FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
            USE-INDEX ANSTF NO-LOCK NO-ERROR.   
            FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = franvarotemp.FRAN AND 
            OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
            IF NOT AVAILABLE OVERAVTAB THEN dagnr = WEEKDAY(franvarotemp.FRAN).
            ELSE dagnr = OVERAVTAB.EQDAG.
            IF dagnr = 1 OR dagnr = 7 THEN dagnr = dagnr.
            ELSE DO:
               regdatum = franvarotemp.FRAN.
               REPEAT:            
                  regdatum = regdatum - 1.
                  FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND 
                  OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                  IF NOT AVAILABLE OVERAVTAB THEN dagnr = WEEKDAY(regdatum).
                  ELSE dagnr = OVERAVTAB.EQDAG.
                  IF dagnr = 1 OR dagnr = 7 THEN NEXT.
                  ELSE LEAVE.
               END.
               FIND FIRST FVARO WHERE FVARO.FRKOD = franvarotemp.LART NO-LOCK NO-ERROR.
               IF AVAILABLE FVARO THEN DO:            
                  FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
                  AND TIDREGITAB.DATUM = regdatum AND TIDREGITAB.AONR = FVARO.AONR
                  AND TIDREGITAB.TOTALT > 1  NO-LOCK NO-ERROR.
                  IF NOT AVAILABLE TIDREGITAB THEN DO:
                     CREATE fbuff.
                     BUFFER-COPY franvarotemp TO fbuff.
                     ASSIGN fbuff.FRAN = franvarotemp.FRAN
                     fbuff.TILL = franvarotemp.FRAN.
                     franvarotemp.FRAN = franvarotemp.FRAN + 1.
                  END.
               END.
            END.
         END.
      END.
   END.*/
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\sjkolle.d NO-ECHO.
   END.   

   
   FOR EACH franvarotemp WHERE franvarotemp.LART = "SJ" USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.  
   FOR EACH franvarotemp WHERE franvarotemp.FRAN NE franvarotemp.TILL:
      arbdg = 0.
      regdatum = franvarotemp.FRAN.
      adag:
      REPEAT:
         IF regdatum > franvarotemp.TILL THEN LEAVE adag.
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
         IF NOT AVAILABLE PERSONALTAB  THEN FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.            
         persrec = RECID(PERSONALTAB).         
         RUN REGVEC.P.
         RUN SLUTARB.P.      
         IF regstart = regslut THEN regstart = regstart.
         ELSE  arbdg = arbdg + 1.       
         regdatum = regdatum + 1.    
      END.
      franvarotemp.ARBDAGAR = arbdg.     
   END.
   DO TRANSACTION:
      FIND FIRST franvarotemp WHERE franvarotemp.PNR = " " OR franvarotemp.PNR =
      "000000000000" USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE franvarotemp THEN DELETE franvarotemp.
   END.
   REPEAT TRANSACTION:
      FIND NEXT franvarotemp WHERE franvarotemp.PNR = " " OR franvarotemp.PNR =
       "000000000000"  USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE franvarotemp THEN LEAVE.
      ELSE DELETE franvarotemp.
   END.
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\fransu.d NO-ECHO.
   END.   
   
   FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.  
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\frfelma.d NO-ECHO.
   END.   
   
   FOR EACH frfel USE-INDEX franvaro  NO-LOCK:
     EXPORT frfel.
   END.
   /*del2*/
   OPEN QUERY fq FOR EACH franvarotemp.
   GET FIRST fq NO-LOCK.
   DO WHILE AVAILABLE(franvarotemp):      
      IF MONTH(franvarotemp.FRAN) < MONTH(franvarotemp.TILL) THEN DO:              
         ASSIGN regdat1 = franvarotemp.TILL
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2
         regdat2 = regdat2 + 1.     
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.     
      END.
      IF MONTH(franvarotemp.FRAN) LE MONTH(vkdatum) AND MONTH(franvarotemp.TILL) > MONTH(vkdatum) THEN DO:                  
         regdat1 = franvarotemp.TILL.
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2.
         regdat2 = regdat2 + 1.
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.    
      END.
      GET NEXT fq NO-LOCK.
   END.      
   
   IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
      OUTPUT TO D:\elpool\delad\pro10s\EXPORT\lon\allfran.d NO-ECHO.
   END.   
   
   FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.  
   IF korvar = "" THEN prognamn3 = prognamn5 + "felman.d".   
   ELSE prognamn3 = prognamn5 + "felmanomk.d ".
   OUTPUT TO VALUE(prognamn3) NO-ECHO.
   
   kolldatum = DATE(MONTH(vkdatum),01,YEAR(vkdatum)).
   FOR EACH franvarotemp WHERE franvarotemp.FRAN < kolldatum USE-INDEX franvaro  NO-LOCK:   
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.
END PROCEDURE.
