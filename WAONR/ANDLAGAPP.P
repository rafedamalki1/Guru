/*ANDLAGAPP.P*/
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{GLOBVAR2DEL1.I}
{REGVAR.I}

{AONRDEF.I}
{AVTAONRTEMP.I}
{OMRTEMPW.I}
FIND FIRST FORETAG NO-LOCK NO-ERROR.
Guru.Konstanter:globforetag = FORETAG.FORETAG.
RUN STYRFORE.P (INPUT Guru.Konstanter:globforetag).
PROCEDURE btnok.
   DEFINE INPUT PARAMETER brec AS RECID NO-UNDO.
   DEFINE INPUT PARAMETER anv AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER date1 AS DATE NO-UNDO.
   DEFINE INPUT PARAMETER date2 AS DATE NO-UNDO.
   DEFINE INPUT PARAMETER mfied1 AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER mfied2 AS LOGICAL NO-UNDO.
   DO TRANSACTION:
      FIND FIRST AONRTIDLAGE WHERE RECID(AONRTIDLAGE) = brec EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE AONRTIDLAGE THEN DO:        
         ASSIGN 
         AONRTIDLAGE.DATUM1 = date1
         AONRTIDLAGE.DATUM2 = date2.
         IF mfied1 = TRUE THEN ASSIGN AONRTIDLAGE.ANVANDARE1 = anv.    
         IF mfied2 = TRUE THEN ASSIGN AONRTIDLAGE.ANVANDARE2 = anv.
      END.
   END.
   RELEASE AONRTIDLAGE.
   RETURN.
END PROCEDURE.

PROCEDURE koll.
   DEFINE INPUT PARAMETER aonrvar AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER delnrvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER gforetag AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER regdatum AS DATE NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR felmeddtemp.
   EMPTY TEMP-TABLE felmeddtemp NO-ERROR. 
   ASSIGN Guru.Konstanter:globforetag = gforetag.
   
   FIND FIRST AONRTAB WHERE AONRTAB.AONR = aonrvar AND 
   AONRTAB.DELNR = delnrvar NO-LOCK NO-ERROR. 
   IF AONRTAB.DELNR = 0 THEN DO:      
     IF Guru.Konstanter:globforetag = "GRAN" OR Guru.Konstanter:globforetag = "elpa" OR Guru.Konstanter:globforetag = "GKAL" THEN DO:         
        FIND LAST TIDREGITAB WHERE TIDREGITAB.AONR = AONRTAB.AONR 
        USE-INDEX AONR NO-LOCK NO-ERROR.
     END.
     ELSE DO:
        FIND LAST TIDREGITAB WHERE 
        TIDREGITAB.AONR = AONRTAB.AONR AND TIDREGITAB.DELNR = AONRTAB.DELNR
        USE-INDEX AONR NO-LOCK NO-ERROR.
     END.
  END.
  ELSE DO:
     FIND LAST TIDREGITAB WHERE 
     TIDREGITAB.AONR = AONRTAB.AONR AND TIDREGITAB.DELNR = AONRTAB.DELNR
     USE-INDEX AONR NO-LOCK NO-ERROR.
  END.
  IF AVAILABLE TIDREGITAB THEN DO:
    IF TIDREGITAB.DATUM > regdatum THEN DO:
       CREATE felmeddtemp.
       ASSIGN
       felmeddtemp.FELMEDD = Guru.Konstanter:gaol + " " + TIDREGITAB.AONR + "" + STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]) +
       " går inte att sätta TIDSTOPP på " + STRING(regdatum) + " för att " + TIDREGITAB.PERSONALKOD +
       " har skrivit tid på detta " + Guru.Konstanter:gaok + " " + STRING(TIDREGITAB.DAG) + " vecka " +
       STRING(TIDREGITAB.VECKONUMMER) + " Vill du se övriga personer med tidskrivning?"
       felmeddtemp.VAL = 1.
       RETURN.
     END.     
  END.
END PROCEDURE.
   
