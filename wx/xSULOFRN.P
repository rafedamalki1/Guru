/*XSULOFRN.P SKAPAR PA90FIL FRANVARO.*/  
&Scoped-define NEW  
&Scoped-define SHARED SHARED
{LONEDEF.I}
DEFINE SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE SHARED VARIABLE gvisatidpermanad AS LOGICAL NO-UNDO.
DEFINE SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
/*DEFINE SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.*/
DEFINE SHARED VARIABLE korvar AS CHARACTER NO-UNDO.

DEFINE VARIABLE rapphj1 AS CHARACTER FORMAT "X(8)" NO-UNDO.      /*HJALP ANTAL*/
DEFINE VARIABLE overrapp1 AS CHARACTER FORMAT "X(132)" NO-UNDO.      /*LON*/
DEFINE VARIABLE prognamn AS CHARACTER FORMAT "X(41)" NO-UNDO.
DEFINE VARIABLE anstall AS CHARACTER FORMAT "X(10)" NO-UNDO.
DEFINE VARIABLE anstperson LIKE PERSONALTAB.PERSONNUMMER NO-UNDO.
DEFINE VARIABLE antal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE proc1 AS INTEGER FORMAT "999" NO-UNDO.
DEFINE VARIABLE pnr LIKE PERSONALTAB.PERSONNUMMER NO-UNDO.      /*LON*/
DEFINE SHARED TEMP-TABLE frvarotemp
   FIELD PERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD TIMMAR AS DECIMAL FORMAT "99999.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"
   FIELD STARTKL LIKE TIDREGITAB.START
   FIELD SLUTKL LIKE TIDREGITAB.SLUT
   FIELD NAMN AS CHARACTER
   FIELD TIMMAR2 LIKE TIDREGITAB.LONTILLANTAL
   FIELD PROCENT2 AS DECIMAL FORMAT "999.9"    
   FIELD KOMMENTAR AS CHARACTER
   FIELD ARBDAGAR AS INTEGER
   FIELD TOTTIMMAR AS DECIMAL
   INDEX FRANVARO IS PRIMARY  PERSONNUMMER FRAN LART ASCENDING.  
/*
DEFINE SHARED TEMP-TABLE lonefil
   FIELD PPERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD START LIKE TIDREGITAB.START
   FIELD SLUT LIKE TIDREGITAB.SLUT
   FIELD PLONTILLAGG LIKE TIDREGITAB.LONTILLAGG
   FIELD PLONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD POVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL
   FIELD POVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD PTRAKTKOD LIKE TIDREGITAB.TRAKTKOD
   FIELD PTRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL
   FIELD PBEREDSKAP LIKE TIDREGITAB.BEREDSKAP
   FIELD PBERANTAL LIKE TIDREGITAB.BERANTAL
   FIELD PDATUM LIKE TIDREGITAB.DATUM
   FIELD SLUTDATUM LIKE TIDREGITAB.DATUM INITIAL ?
   FIELD PVECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   FIELD MANAD AS INTEGER
   FIELD PSORT AS CHARACTER FORMAT "XX"
   FIELD PPAR8 AS DECIMAL FORMAT "-99.99"
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD PAVTAL AS CHARACTER
   FIELD TID AS LOGICAL           /*frånvaro*/
   FIELD BERKOLL AS LOGICAL INITIAL FALSE
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD NAMN AS CHARACTER
   FIELD RESMAL AS CHARACTER
   FIELD ERSATTNING AS DECIMAL  
   INDEX PPERSONNUMMER IS PRIMARY PPERSONNUMMER ASCENDING PLONTILLAGG POVERTIDTILL PTRAKTKOD PBEREDSKAP PDATUM.
   */
DEFINE TEMP-TABLE r3till
   FIELD PPERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD START LIKE TIDREGITAB.START
   FIELD SLUT LIKE TIDREGITAB.SLUT
   FIELD PLONTILLAGG LIKE TIDREGITAB.LONTILLAGG
   FIELD PLONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD POVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL
   FIELD POVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD PTRAKTKOD LIKE TIDREGITAB.TRAKTKOD
   FIELD PTRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL
   FIELD PBEREDSKAP LIKE TIDREGITAB.BEREDSKAP
   FIELD PBERANTAL LIKE TIDREGITAB.BERANTAL
   FIELD PDATUM LIKE TIDREGITAB.DATUM
   FIELD SLUTDATUM LIKE TIDREGITAB.DATUM INITIAL ?
   FIELD PVECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   FIELD MANAD AS INTEGER
   FIELD PSORT AS CHARACTER FORMAT "XX"
   FIELD PPAR8 AS DECIMAL FORMAT "-99.99"
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD PAVTAL AS CHARACTER
   FIELD TID AS LOGICAL
   FIELD BERKOLL AS LOGICAL INITIAL FALSE
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD PLONTILLANTAL2 LIKE TIDREGITAB.LONTILLANTAL
   FIELD PROCENT2 AS DECIMAL FORMAT "999.9"
   FIELD NAMN AS CHARACTER
   FIELD RESMAL AS CHARACTER
   FIELD LART LIKE TIDREGITAB.LONTILLAGG
   FIELD VIJUDID AS CHARACTER
   FIELD ERSATTNING AS DECIMAL
   FIELD ARBDAGAR AS INTEGER
   FIELD TOTTIMMAR AS DECIMAL
   INDEX PPERSONNUMMER IS PRIMARY PPERSONNUMMER ASCENDING.
regdatum = TODAY.
RUN REGVEC.P.
if globforetag = "elpa" then DO:
   OUTPUT TO \\pc012\delad\pro8\GURU\apptemp\test22.d NO-ECHO.
   for each frvarotemp:
      display frvarotemp.
   end.
   output close.   
END.  


FOR EACH frvarotemp:
    CREATE r3till.
    ASSIGN r3till.PPERSONNUMMER = frvarotemp.PERSONNUMMER
	      r3till.PLONTILLAGG = frvarotemp.LART	       
          r3till.LART = frvarotemp.LART	       
          r3till.PLONTILLANTAL = frvarotemp.TIMMAR	       
	      r3till.PDATUM = frvarotemp.FRAN	
          r3till.SLUTDATUM = frvarotemp.TILL
	      r3till.AONR = frvarotemp.AONR
          r3till.DELNR = frvarotemp.DELNR           
          r3till.TID = TRUE
          r3till.START = frvarotemp.STARTKL
          r3till.SLUT = frvarotemp.SLUTKL
          r3till.PROCENT = frvarotemp.PROCENT
          r3till.NAMN = frvarotemp.NAMN
          r3till.PLONTILLANTAL2 = frvarotemp.TIMMAR2	       
          r3till.PROCENT2 = frvarotemp.PROCENT2
          r3till.RESMAL = frvarotemp.KOMMENTAR
          r3till.ARBDAGAR = frvarotemp.ARBDAGAR
          r3till.TOTTIMMAR = frvarotemp.TOTTIMMAR. 
END.

 
/*SPECIAL 4444 ÖVERSÄTTS TILL 5856, 0117 ÖVERSÄTTS TILL 0116*/
FOR EACH lonefil  WHERE lonefil.PBEREDSKAP = "4444":
   ASSIGN lonefil.PBEREDSKAP = "5856".
END.
FOR EACH lonefil  WHERE lonefil.PLONTILLAGG = "0117":
   ASSIGN lonefil.PLONTILLAGG = "0116".
END.
FOR EACH lonefil  WHERE lonefil.PLONTILLAGG = "5896":
   ASSIGN lonefil.PLONTILLAGG = "5899".
END.
FOR EACH lonefil  WHERE lonefil.PLONTILLAGG = "5897":
   ASSIGN lonefil.PLONTILLAGG = "5899".
END.
FOR EACH lonefil  WHERE lonefil.PLONTILLAGG = "5898":
   ASSIGN lonefil.PLONTILLAGG = "5899".
END.


anstperson = "".
FOR EACH lonefil  WHERE lonefil.PLONTILLAGG NE "" USE-INDEX PPERSONNUMMER
   BREAK BY lonefil.PPERSONNUMMER BY lonefil.PLONTILLAGG:
   ACCUMULATE lonefil.PLONTILLANTAL (TOTAL BY lonefil.PPERSONNUMMER BY lonefil.PLONTILLAGG).
   IF LAST-OF(lonefil.PLONTILLAGG) THEN DO:   
      CREATE r3till.
      ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
      r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
      r3till.LART = lonefil.PLONTILLAGG
	   r3till.PDATUM =  lonefil.PDATUM
	   r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
	   r3till.AONR = lonefil.AONR 
      r3till.DELNR =   lonefil.DELNR 
      r3till.MANAD =   lonefil.MANAD 
      r3till.PAVTAL  =   lonefil.PAVTAL 
      r3till.TID = FALSE
      r3till.NAMN = lonefil.NAMN
      r3till.RESMAL = lonefil.RESMAL
      r3till.PSORT = lonefil.PSORT
      r3till.ERSATTNING = lonefil.ERSATTNING
      r3till.PLONTILLANTAL = (ACCUM TOTAL BY lonefil.PLONTILLAGG lonefil.PLONTILLANTAL). 
      
   END.
END.
/* för 5089 semesterers skall datum synas dvs summera ej*/
/* Ej heller flerdygnförättningslönearter summerade*/
FOR EACH r3till WHERE r3till.PLONTILLAGG = "5089":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "5089":
    CREATE r3till.
    ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
    r3till.LART = lonefil.PLONTILLAGG
	r3till.PDATUM =  lonefil.PDATUM
	r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
	r3till.AONR = lonefil.AONR 
    r3till.DELNR =   lonefil.DELNR 
    r3till.MANAD =   lonefil.MANAD 
    r3till.PAVTAL  =   lonefil.PAVTAL 
    r3till.TID = FALSE
    r3till.NAMN = lonefil.NAMN
    r3till.RESMAL = lonefil.RESMAL
    r3till.PSORT = lonefil.PSORT
    r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
    r3till.ERSATTNING = lonefil.ERSATTNING.
END.
/*FOR EACH r3till WHERE r3till.PLONTILLAGG = "8379":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "8379" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM 
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.

FOR EACH r3till WHERE r3till.PLONTILLAGG = "8388":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "8388" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.
FOR EACH r3till WHERE r3till.PLONTILLAGG = "7211":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "7211" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.
FOR EACH r3till WHERE r3till.PLONTILLAGG = "7212":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "7212" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.
FOR EACH r3till WHERE r3till.PLONTILLAGG = "8385":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "8385" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.
FOR EACH r3till WHERE r3till.PLONTILLAGG = "8386":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "8386" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.
END.
FOR EACH r3till WHERE r3till.PLONTILLAGG = "8206":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PLONTILLAGG = "8206" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    /*FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.PLONTILLAGG = lonefil.PLONTILLAGG AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    */
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PLONTILLAGG = lonefil.PLONTILLAGG 	    
       r3till.LART = lonefil.PLONTILLAGG
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.PSORT = lonefil.PSORT
       r3till.PLONTILLANTAL = lonefil.PLONTILLANTAL
       r3till.ERSATTNING = lonefil.ERSATTNING.
    /*END.
    ELSE DO:
       ASSIGN
       r3till.PLONTILLANTAL = r3till.PLONTILLANTAL + lonefil.PLONTILLANTAL
       r3till.SLUTDATUM = lonefil.PDATUM.
    END.*/
END.*/


anstperson = "".
FOR EACH lonefil  WHERE /*lonefil.TID = FALSE AND*/
   lonefil.PTRAKTKOD NE "" USE-INDEX PPERSONNUMMER
   BREAK BY lonefil.PPERSONNUMMER BY lonefil.PTRAKTKOD:   
   ACCUMULATE lonefil.PTRAKTANTAL (TOTAL BY lonefil.PPERSONNUMMER BY lonefil.PTRAKTKOD).  
   IF LAST-OF(lonefil.PTRAKTKOD) THEN DO:   
      CREATE r3till.
      ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 
	   r3till.PTRAKTKOD = lonefil.PTRAKTKOD 	           
      r3till.LART = lonefil.PTRAKTKOD
	   r3till.PDATUM =  lonefil.PDATUM
	   r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
	   r3till.AONR = lonefil.AONR 
      r3till.DELNR =   lonefil.DELNR 
      r3till.MANAD =   lonefil.MANAD 
      r3till.PAVTAL  =   lonefil.PAVTAL 
      r3till.TID = FALSE      
      r3till.NAMN = lonefil.NAMN
      r3till.ERSATTNING = lonefil.ERSATTNING
      r3till.PTRAKTANTAL = (ACCUM TOTAL BY lonefil.PTRAKTKOD lonefil.PTRAKTANTAL).
   END.
END.       
/* Flerdygnsförrättningar skall ej summeras*/
/*FOR EACH r3till WHERE r3till.PTRAKTKOD = "8244":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PTRAKTKOD = "8244" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.LART = lonefil.PTRAKTKOD AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PTRAKTKOD = lonefil.PTRAKTKOD 	    
       r3till.LART = lonefil.PTRAKTKOD
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.ERSATTNING = lonefil.ERSATTNING
       r3till.PTRAKTANTAL = lonefil.PTRAKTANTAL. 
    END.
    ELSE DO:
       ASSIGN
       r3till.PTRAKTANTAL = r3till.PTRAKTANTAL + lonefil.PTRAKTANTAL
       r3till.SLUTDATUM = lonefil.PDATUM
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.    
END.
FOR EACH r3till WHERE r3till.PTRAKTKOD = "8216":
    DELETE r3till.
END.
FOR EACH lonefil WHERE lonefil.PTRAKTKOD = "8216" BY lonefil.PPERSONNUMMER BY lonefil.PDATUM:
    FIND FIRST r3till WHERE r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER AND
    r3till.LART = lonefil.PTRAKTKOD AND r3till.MANAD = lonefil.MANAD 
    AND r3till.SLUTDATUM GE  lonefil.PDATUM - 1 NO-ERROR.
    IF NOT AVAILABLE r3till THEN DO:    
       CREATE r3till.
       ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 	  
       r3till.PTRAKTKOD = lonefil.PTRAKTKOD 	    
       r3till.LART = lonefil.PTRAKTKOD
   	 r3till.PDATUM =  lonefil.PDATUM
       r3till.SLUTDATUM =  lonefil.PDATUM
   	 r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
   	 r3till.AONR = lonefil.AONR 
       r3till.DELNR =   lonefil.DELNR 
       r3till.MANAD =   lonefil.MANAD 
       r3till.PAVTAL  =   lonefil.PAVTAL 
       r3till.TID = FALSE
       r3till.NAMN = lonefil.NAMN
       r3till.RESMAL = lonefil.RESMAL
       r3till.ERSATTNING = lonefil.ERSATTNING
       r3till.PTRAKTANTAL = lonefil.PTRAKTANTAL. 
    END.
    ELSE DO:
       ASSIGN
       r3till.PTRAKTANTAL = r3till.PTRAKTANTAL + lonefil.PTRAKTANTAL
       r3till.SLUTDATUM = lonefil.PDATUM
       r3till.ERSATTNING = lonefil.ERSATTNING.
    END.    
END.*/

FOR EACH lonefil  WHERE lonefil.PBEREDSKAP NE "" USE-INDEX PPERSONNUMMER
   BREAK BY lonefil.PPERSONNUMMER BY lonefil.PBEREDSKAP:      
   ACCUMULATE lonefil.PBERANTAL (TOTAL BY lonefil.PPERSONNUMMER BY lonefil.PBEREDSKAP).  
   IF LAST-OF(lonefil.PBEREDSKAP) THEN DO:   
      CREATE r3till.
      ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 
	   r3till.PBEREDSKAP = lonefil.PBEREDSKAP 	           
      r3till.LART = lonefil.PBEREDSKAP
	   r3till.PDATUM =  lonefil.PDATUM
	   r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
	   r3till.AONR = lonefil.AONR 
      r3till.DELNR =   lonefil.DELNR 
      r3till.MANAD =   lonefil.MANAD 
      r3till.PAVTAL  =   lonefil.PAVTAL 
      r3till.TID = FALSE      
      r3till.NAMN = lonefil.NAMN.
      r3till.PBERANTAL = (ACCUM TOTAL BY lonefil.PBEREDSKAP lonefil.PBERANTAL).            
    /*  /* lunchen ska avrundas för sig*/
      r3till.ERSATTNING = (ACCUM TOTAL BY lonefil.PBEREDSKAP lonefil.ERSATTNING).      
      IF ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)) > 0 AND ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)) < 0.5 THEN DO: 
         r3till.PBERANTAL =  r3till.PBERANTAL  + 0.5 - ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)).         
      END.
      IF ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)) > 0.5 AND ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)) < 1 THEN DO: 
         r3till.PBERANTAL =  r3till.PBERANTAL  + 1 - ( r3till.ERSATTNING - TRUNCATE(r3till.ERSATTNING,0)).      
      END.*/

   END.
END.
/* Startdatum och slutdatum för hela beredskapen*/
FOR EACH r3till  WHERE r3till.PBEREDSKAP NE "" USE-INDEX PPERSONNUMMER:
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER AND PERSONALTAB.AKTIV = TRUE NO-LOCK NO-ERROR.
   IF AVAILABLE PERSONALTAB  THEN DO:
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND YEAR(TIDREGITAB.DATUM) = YEAR(r3till.PDATUM)
      AND MONTH(TIDREGITAB.DATUM) = r3till.MANAD AND TIDREGITAB.BEREDSKAP NE "" USE-INDEX PKOD NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:
         r3till.PDATUM = TIDREGITAB.DATUM.
      END.
      FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND YEAR(TIDREGITAB.DATUM) = YEAR(r3till.PDATUM)
      AND MONTH(TIDREGITAB.DATUM) = r3till.MANAD AND TIDREGITAB.BEREDSKAP NE "" USE-INDEX PKOD NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:
         r3till.SLUTDATUM = TIDREGITAB.DATUM.
      END.
   END.
END.


FOR EACH lonefil  WHERE lonefil.POVERTIDTILL NE "" USE-INDEX PPERSONNUMMER
   BREAK BY lonefil.PPERSONNUMMER BY lonefil.POVERTIDTILL:   
   ACCUMULATE lonefil.POVERANTAL (TOTAL BY lonefil.PPERSONNUMMER BY lonefil.POVERTIDTILL).  
   IF LAST-OF(lonefil.POVERTIDTILL) THEN DO:   
      CREATE r3till.
      ASSIGN r3till.PPERSONNUMMER = lonefil.PPERSONNUMMER 
	   r3till.POVERTIDTILL = lonefil.POVERTIDTILL 
      r3till.LART = lonefil.POVERTIDTILL
	   r3till.PDATUM =  lonefil.PDATUM
	   r3till.PVECKONUMMER = lonefil.PVECKONUMMER 
	   r3till.AONR = lonefil.AONR 
      r3till.DELNR =   lonefil.DELNR 
      r3till.MANAD =   lonefil.MANAD 
      r3till.PAVTAL  =   lonefil.PAVTAL 
      r3till.TID = FALSE      
      r3till.NAMN = lonefil.NAMN
      r3till.ERSATTNING = lonefil.ERSATTNING
      r3till.POVERANTAL = (ACCUM TOTAL BY lonefil.POVERTIDTILL lonefil.POVERANTAL).
   END.
END.       


FOR EACH r3till:
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER AND PERSONALTAB.AKTIV = TRUE NO-LOCK NO-ERROR.      
   IF NOT AVAILABLE PERSONALTAB THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER NO-LOCK NO-ERROR.      
   END.
   FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = PERSONALTAB.OMRADE NO-LOCK NO-ERROR.
   FIND FIRST AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK NO-ERROR.
   FIND FIRST JURPERS WHERE JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK NO-ERROR.
   IF AVAILABLE JURPERS THEN DO:
      ASSIGN r3till.VIJUDID = JURPERS.VIJUDID.
   END.
   IF r3till.LART = "8388" THEN DO:
      ASSIGN r3till.PLONTILLANTAL = r3till.PLONTILLANTAL * ( -1).
   END.
   IF r3till.LART = "8379" THEN DO:
      ASSIGN r3till.PLONTILLANTAL = r3till.PLONTILLANTAL * ( -1).
   END.
END.
IF globforetag = "SUND" THEN DO: 
   OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\r3till.d NO-ECHO.
   FOR EACH r3till BY r3till.PPERSONNUMMER:
      EXPORT r3till.
   END.
END.
/*ELNÄT*/
IF korvar = "" THEN DO:
   IF globforetag = "SUND" THEN DO: 
      OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\stanstid.d NO-ECHO.
   END.
   IF globforetag = "elpa" THEN DO:
      OUTPUT TO \\pc012\delad\pro8\GURU\apptemp\stanstid.d.
   END. 
END.
ELSE DO:
   IF globforetag = "SUND" THEN DO: 
      OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\stanstidomk.d NO-ECHO.
   END.
   IF globforetag = "elpa" THEN DO:
      OUTPUT TO \\pc012\delad\pro8\GURU\apptemp\stanstidomk.d.
   END. 
END.
anstperson = "".

FOR EACH r3till WHERE r3till.VIJUDID = "ELNÄT" BY r3till.PPERSONNUMMER  BY r3till.LART BY r3till.PDATUM:
   RUN filut_UI.
   /*IF anstperson NE r3till.PPERSONNUMMER THEN DO:
      IF anstperson NE "" THEN DO:        
         PUT SKIP (1). 
         ASSIGN overrapp1 = "".   
         ASSIGN
         SUBSTRING(overrapp1,132,1) = "$".           
         PUT overrapp1.   
         PUT SKIP. 
      END.
      /*PUT SKIP (1).*/
      ASSIGN overrapp1 = "".   
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER AND
      PERSONALTAB.AKTIV = TRUE NO-LOCK NO-ERROR. 
      IF NOT AVAILABLE PERSONALTAB THEN DO:      
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER NO-LOCK NO-ERROR. 
      END.
      ASSIGN
      SUBSTRING(overrapp1,2,11) = STRING(r3till.PPERSONNUMMER,"999999-9999").
      IF AVAILABLE PERSONALTAB THEN DO: 
         SUBSTRING(overrapp1,14,38) = PERSONALTAB.PERSONALKOD + " " + SUBSTRING(r3till.NAMN,1,30).  
      END.
      ELSE DO:
         SUBSTRING(overrapp1,14,38) = SUBSTRING(r3till.NAMN,1,30).  
      END.
      anstperson = r3till.PPERSONNUMMER.   
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP(1). 
   END.
   IF r3till.PLONTILLANTAL = 0 AND r3till.PTRAKTANTAL = 0 AND r3till.PBERANTAL = 0 
   AND r3till.POVERANTAL = 0   THEN overrapp1 = overrapp1.
   ELSE DO:
      ASSIGN overrapp1 = "".   
      ASSIGN
      /*SUBSTRING(overrapp1,2,10) = STRING(r3till.PPERSONNUMMER)*/
      SUBSTRING(overrapp1,40,10) = STRING(r3till.PDATUM,"9999/99/99").
      IF r3till.PLONTILLAGG NE "" AND r3till.TID = TRUE THEN DO:   /*FRÅNVARO*/
         IF LENGTH(r3till.PLONTILLAGG) = 2 THEN DO:
            SUBSTRING(overrapp1,2,2) = SUBSTRING(r3till.PLONTILLAGG,1,2).
         END.
         ELSE IF LENGTH(r3till.PLONTILLAGG) = 4 THEN DO:
            SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
         END.
         IF r3till.SLUTDATUM NE ? THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
         SUBSTRING(overrapp1,65,6) = STRING(r3till.PLONTILLANTAL2,">>9.99").         
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "KL" THEN overrapp1 = overrapp1.         
         ELSE IF r3till.PROCENT2 > 0  THEN DO:
            SUBSTRING(overrapp1,72,5) = STRING(r3till.PROCENT2 / 100,"9.999").
         END.
         IF r3till.PLONTILLANTAL > 0  THEN DO:
            nytid = r3till.PLONTILLANTAL.
            RUN TIMSEK.P.
            r3till.PLONTILLANTAL = (sekunder / 3600).		 
            SUBSTRING(overrapp1,78,8) = "(" + STRING(r3till.PLONTILLANTAL,">>9.99").
         END.
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "KL" THEN SUBSTRING(overrapp1,86,5) = ")".         
         ELSE IF r3till.PROCENT > 0  THEN DO:
            SUBSTRING(overrapp1,86,5) = STRING(r3till.PROCENT / 100,"9.999") + ")".
         END.
         IF r3till.PLONTILLAGG = "BT" OR r3till.PLONTILLAGG = "TL" THEN DO:         
            SUBSTRING(overrapp1,93,20) = SUBSTRING(r3till.RESMAL,1,20).
         END.
      END.
      ELSE IF r3till.PLONTILLAGG NE "" THEN DO:                   
          ASSIGN
          SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
          IF r3till.PLONTILLAGG = "0116" THEN DO:
             SUBSTRING(overrapp1,29,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
          END.         
          ELSE IF r3till.ERSATTNING > 0 THEN DO:
             SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
             SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
          END.
          ELSE IF r3till.PSORT = "KR" THEN DO:
             SUBSTRING(overrapp1,30,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").  
          END.
          ELSE DO:          
             SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
          END.

          IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
             SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
          END.
                    
          /*SUBSTRING(overrapp1,45,20) = SUBSTRING(r3till.RESMAL,1,20).*/
      END.    
      ELSE IF r3till.PTRAKTKOD NE "" THEN DO:
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PTRAKTKOD,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PTRAKTANTAL,">>>>>9.99").      
         SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
         IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
      END.   
      ELSE IF r3till.PBEREDSKAP NE "" THEN DO:
         
         IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0 AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.26 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0).
         ELSE IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.26  AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.76 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 0.50.
         ELSE  IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.76  THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 1.

         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PBEREDSKAP,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PBERANTAL,">>>>>9.99").
      END.     
      ELSE IF r3till.POVERTIDTILL NE "" THEN DO:                   
         IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0 AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) < 0.50 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 0.50.
         ELSE IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0.50  AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) LE 0.99 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 1.                  
         ASSIGN
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.POVERTIDTILL,1,4)
         SUBSTRING(overrapp1,7,9) = STRING(r3till.POVERANTAL,">>>>>9.99").
         /*SUBSTRING(overrapp1,45,20) = SUBSTRING(r3till.RESMAL,1,20).    */
      END.    
   END.
   
   anstperson = r3till.PPERSONNUMMER.   
   IF overrapp1 NE ""  THEN DO:
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP. 
   END. */
END.
OUTPUT CLOSE.

/*SEAB*/
IF korvar = "" THEN DO:
   IF globforetag = "SUND" THEN DO: 
      OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\stanstidSEAB.d NO-ECHO.
   END.
   IF globforetag = "elpa" THEN DO:
      OUTPUT TO \\pc012\delad\pro8\GURU\apptemp\stanstidSEAB.d.
   END. 
END.
ELSE DO:
   IF globforetag = "SUND" THEN DO: 
      OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\stanstidSEABomk.d NO-ECHO.
   END.
   IF globforetag = "elpa" THEN DO:
      OUTPUT TO \\pc012\delad\pro8\GURU\apptemp\stanstidSEABomk.d.
   END. 
END.
anstperson = "".

FOR EACH r3till WHERE r3till.VIJUDID = "SEAB" BY r3till.PPERSONNUMMER  BY r3till.LART BY r3till.PDATUM:
   RUN filut_UI.
   /*IF anstperson NE r3till.PPERSONNUMMER THEN DO:
      IF anstperson NE "" THEN DO:        
         PUT SKIP (1). 
         ASSIGN overrapp1 = "".   
         ASSIGN
         SUBSTRING(overrapp1,132,1) = "$".           
         PUT overrapp1.   
         PUT SKIP. 
      END.
      /*PUT SKIP (1).*/
      ASSIGN overrapp1 = "".   
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER AND
      PERSONALTAB.AKTIV = TRUE NO-LOCK NO-ERROR. 
      IF NOT AVAILABLE PERSONALTAB THEN DO:      
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER NO-LOCK NO-ERROR. 
      END.
      ASSIGN
      SUBSTRING(overrapp1,2,11) = STRING(r3till.PPERSONNUMMER,"999999-9999").
      IF AVAILABLE PERSONALTAB THEN DO: 
         SUBSTRING(overrapp1,14,38) = PERSONALTAB.PERSONALKOD + " " + SUBSTRING(r3till.NAMN,1,30).  
      END.
      ELSE DO:
         SUBSTRING(overrapp1,14,38) = SUBSTRING(r3till.NAMN,1,30).  
      END.
      anstperson = r3till.PPERSONNUMMER.   
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP(1). 
   END.
   IF r3till.PLONTILLANTAL = 0 AND r3till.PTRAKTANTAL = 0 AND r3till.PBERANTAL = 0 
   AND r3till.POVERANTAL = 0   THEN overrapp1 = overrapp1.
   ELSE DO:
      ASSIGN overrapp1 = "".   
      ASSIGN
      /*SUBSTRING(overrapp1,2,10) = STRING(r3till.PPERSONNUMMER)*/
      SUBSTRING(overrapp1,20,10) = STRING(r3till.PDATUM,"9999/99/99").
      IF r3till.PLONTILLAGG NE "" AND r3till.TID = TRUE THEN DO:   /*FRÅNVARO*/
         IF LENGTH(r3till.PLONTILLAGG) = 2 THEN DO:
            SUBSTRING(overrapp1,2,2) = SUBSTRING(r3till.PLONTILLAGG,1,2).
         END.
         ELSE IF LENGTH(r3till.PLONTILLAGG) = 4 THEN DO:
            SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
         END.
         IF r3till.SLUTDATUM NE ? THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
         SUBSTRING(overrapp1,65,6) = STRING(r3till.PLONTILLANTAL2,">>9.99").         
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "KL" THEN overrapp1 = overrapp1.         
         ELSE IF r3till.PROCENT2 > 0  THEN DO:
            SUBSTRING(overrapp1,72,5) = STRING(r3till.PROCENT2 / 100,"9.999").
         END.
         IF r3till.PLONTILLANTAL > 0  THEN DO:
            nytid = r3till.PLONTILLANTAL.
            RUN TIMSEK.P.
            r3till.PLONTILLANTAL = (sekunder / 3600).		 
            SUBSTRING(overrapp1,78,8) = "(" + STRING(r3till.PLONTILLANTAL,">>9.99").
         END.
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "KL" THEN SUBSTRING(overrapp1,66,5) = ")".         
         ELSE IF r3till.PROCENT > 0  THEN DO:
            SUBSTRING(overrapp1,86,5) = STRING(r3till.PROCENT / 100,"9.999") + ")".
         END.
         IF r3till.PLONTILLAGG = "BT" OR r3till.PLONTILLAGG = "TL" THEN DO:         
            SUBSTRING(overrapp1,93,20) = SUBSTRING(r3till.RESMAL,1,20).
         END.
      END.
      ELSE IF r3till.PLONTILLAGG NE "" THEN DO: 
         ASSIGN
          SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
          IF r3till.PLONTILLAGG = "0116" THEN DO:
             SUBSTRING(overrapp1,29,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
          END.         
          ELSE IF r3till.ERSATTNING > 0 THEN DO:
             SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
             SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
          END.
          ELSE IF r3till.PSORT = "KR" THEN DO:
             SUBSTRING(overrapp1,30,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").  
          END.
          ELSE DO:          
             SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").
          END.
          /*ASSIGN
          SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4)
          SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,">>>>>9.99").*/
          IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
             SUBSTRING(overrapp1,34,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
          END.
          /*SUBSTRING(overrapp1,45,20) = SUBSTRING(r3till.RESMAL,1,20).*/
      END.    
      ELSE IF r3till.PTRAKTKOD NE "" THEN DO:
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PTRAKTKOD,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PTRAKTANTAL,">>>>>9.99").      
         SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
         IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
            SUBSTRING(overrapp1,34,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
      END.   
      ELSE IF r3till.PBEREDSKAP NE "" THEN DO:
         
         IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0 AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.26 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0).
         ELSE IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.26  AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.76 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 0.50.
         ELSE  IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.76  THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 1.

         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PBEREDSKAP,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PBERANTAL,">>>>>9.99").
      END.     
      ELSE IF r3till.POVERTIDTILL NE "" THEN DO:                   
         IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0 AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) < 0.50 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 0.50.
         ELSE IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0.50  AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) LE 0.99 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 1.                  
         ASSIGN
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.POVERTIDTILL,1,4)
         SUBSTRING(overrapp1,7,9) = STRING(r3till.POVERANTAL,">>>>>9.99").
         /*SUBSTRING(overrapp1,45,20) = SUBSTRING(r3till.RESMAL,1,20).    */
      END.    
   END.
   
   anstperson = r3till.PPERSONNUMMER.   
   IF overrapp1 NE ""  THEN DO:
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP. 
   END.*/
END.
OUTPUT CLOSE.


IF globforetag = "SUND" THEN DO: 
   IF korvar = "" THEN DO:
      prognamn = "D:\delad\server\pro9s\EXPORT\lon\tid".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy D:\delad\server\pro9s\EXPORT\lon\stanstid.d VALUE(prognamn).    
      prognamn = "D:\delad\server\pro9s\EXPORT\lon\tidSEAB".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy D:\delad\server\pro9s\EXPORT\lon\stanstidSEAB.d VALUE(prognamn).    
      
   END.
   ELSE DO:
      prognamn = "D:\delad\server\pro9s\EXPORT\lon\tidomk".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy D:\delad\server\pro9s\EXPORT\lon\stanstidomk.d VALUE(prognamn).    
      prognamn = "D:\delad\server\pro9s\EXPORT\lon\tidSEABomk".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy D:\delad\server\pro9s\EXPORT\lon\stanstidSEABomk.d VALUE(prognamn).          
   END.
END.   
IF globforetag = "ELPA" THEN DO: 
   IF korvar = "" THEN DO:
      prognamn = "\\pc012\delad\pro8\GURU\apptemp\tid".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy \\pc012\delad\pro8\GURU\apptemp\stanstid.d VALUE(prognamn).    
      prognamn = "\\pc012\delad\pro8\GURU\apptemp\till".
      prognamn = prognamn +  STRING(TODAY,"999999") + ".d".    
      OS-copy \\pc012\delad\pro8\GURU\apptemp\stanstill.d VALUE(prognamn).
   END.
   ELSE DO:
      prognamn = "\\pc012\delad\pro8\GURU\apptemp\tidomk".
      prognamn = prognamn  + STRING(TODAY,"999999") + ".d".        
      OS-copy \\pc012\delad\pro8\GURU\apptemp\stanstidomk.d VALUE(prognamn).    
      prognamn = "\\pc012\delad\pro8\GURU\apptemp\tillomk".
      prognamn = prognamn +  STRING(TODAY,"999999") + ".d".    
      OS-copy \\pc012\delad\pro8\GURU\apptemp\stanstillomk.d VALUE(prognamn).
   END.

END.     
PROCEDURE filut_UI :   
   IF anstperson NE r3till.PPERSONNUMMER THEN DO:
      IF anstperson NE "" THEN DO:        
         PUT SKIP (1). 
         ASSIGN overrapp1 = "".   
         ASSIGN
         SUBSTRING(overrapp1,132,1) = "$".           
         PUT overrapp1.   
         PUT SKIP. 
      END.
      /*PUT SKIP (1).*/
      ASSIGN overrapp1 = "".   
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER AND
      PERSONALTAB.AKTIV = TRUE NO-LOCK NO-ERROR. 
      IF NOT AVAILABLE PERSONALTAB THEN DO:      
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = r3till.PPERSONNUMMER NO-LOCK NO-ERROR. 
      END.
      ASSIGN
      SUBSTRING(overrapp1,2,11) = STRING(r3till.PPERSONNUMMER,"999999-9999").
      IF AVAILABLE PERSONALTAB THEN DO: 
         SUBSTRING(overrapp1,14,38) = PERSONALTAB.PERSONALKOD + " " + SUBSTRING(r3till.NAMN,1,30).  
      END.
      ELSE DO:
         SUBSTRING(overrapp1,14,38) = SUBSTRING(r3till.NAMN,1,30).  
      END.
      anstperson = r3till.PPERSONNUMMER.   
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP(1). 
   END.
   IF r3till.PLONTILLANTAL = 0 AND r3till.PTRAKTANTAL = 0 AND r3till.PBERANTAL = 0 
   AND r3till.POVERANTAL = 0   THEN overrapp1 = overrapp1.
   ELSE DO:
      ASSIGN overrapp1 = "".   
      ASSIGN
      /*SUBSTRING(overrapp1,2,10) = STRING(r3till.PPERSONNUMMER)*/
      SUBSTRING(overrapp1,40,10) = STRING(r3till.PDATUM,"9999/99/99").
      IF r3till.PLONTILLAGG NE "" AND r3till.TID = TRUE THEN DO:   /*FRÅNVARO*/
         IF LENGTH(r3till.PLONTILLAGG) = 2 THEN DO:
            SUBSTRING(overrapp1,2,2) = SUBSTRING(r3till.PLONTILLAGG,1,2).
         END.
         ELSE IF LENGTH(r3till.PLONTILLAGG) = 3 THEN DO:
            SUBSTRING(overrapp1,2,3) = SUBSTRING(r3till.PLONTILLAGG,1,3).
         END.
         ELSE IF LENGTH(r3till.PLONTILLAGG) = 4 THEN DO:
            SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
         END.
         IF r3till.SLUTDATUM NE ? THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
         IF r3till.PLONTILLAGG = "860" OR r3till.PLONTILLAGG = "406"  THEN DO:            
            SUBSTRING(overrapp1,65,6) = STRING(r3till.TOTTIMMAR,">>9.99").         
         END.         
         ELSE IF r3till.PROCENT = 100  THEN DO:
            /* tillägg så att även deltidare får antal arbetsdagar*/
            SUBSTRING(overrapp1,69,2) = STRING(r3till.ARBDAGAR,">9").         
         END.
         ELSE IF r3till.PLONTILLANTAL2 < 8  THEN DO:
            SUBSTRING(overrapp1,65,6) = STRING(r3till.PLONTILLANTAL2,">>9.99").         
         END.
         ELSE DO:
            SUBSTRING(overrapp1,69,2) = STRING(r3till.ARBDAGAR,">9").         
         END.
         
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "860" THEN overrapp1 = overrapp1.         
         ELSE IF r3till.PROCENT2 > 0  THEN DO:
            SUBSTRING(overrapp1,72,5) = STRING(r3till.PROCENT2 / 100,"9.999").
         END.
         /*IF r3till.PLONTILLANTAL > 0  THEN DO:
            nytid = r3till.PLONTILLANTAL.
            RUN TIMSEK.P.
            r3till.PLONTILLANTAL = (sekunder / 3600).		 
            SUBSTRING(overrapp1,78,8) = "(" + STRING(r3till.PLONTILLANTAL,">>9.99").
         END.
         /*Ingen procent vid komp 20020528*/
         IF r3till.PLONTILLAGG = "KL" THEN SUBSTRING(overrapp1,86,5) = ")".         
         ELSE IF r3till.PROCENT > 0  THEN DO:
            SUBSTRING(overrapp1,86,5) = STRING(r3till.PROCENT / 100,"9.999") + ")".
         END.*/
         IF r3till.PLONTILLAGG = "663" OR r3till.PLONTILLAGG = "665"  THEN DO:                     
            SUBSTRING(overrapp1,78,30) = SUBSTRING(r3till.RESMAL,1,6) + "-" + SUBSTRING(r3till.RESMAL,7,4).
         END.
         IF r3till.PLONTILLAGG = "623" THEN DO:         
            SUBSTRING(overrapp1,78,30) = SUBSTRING(r3till.RESMAL,1,30).
         END.
      END.      
      ELSE IF r3till.PLONTILLAGG NE "" THEN DO:                   
         ASSIGN
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PLONTILLAGG,1,4).
         /* Avrundning Ob uppåt till jämna halvtimmar*/
         IF r3till.PLONTILLAGG = "310" OR r3till.PLONTILLAGG = "311" OR r3till.PLONTILLAGG = "312" THEN DO:
            IF ( r3till.PLONTILLANTAL - TRUNCATE(r3till.PLONTILLANTAL,0)) > 0 AND ( r3till.PLONTILLANTAL - TRUNCATE(r3till.PLONTILLANTAL,0)) < 0.50 THEN r3till.PLONTILLANTAL = TRUNCATE(r3till.PLONTILLANTAL,0) + 0.50.         
            ELSE IF ( r3till.PLONTILLANTAL - TRUNCATE(r3till.PLONTILLANTAL,0)) > 0.50  THEN r3till.PLONTILLANTAL = TRUNCATE(r3till.PLONTILLANTAL,0) + 1.
         END.
         IF r3till.PLONTILLAGG = "0116" THEN DO:
            SUBSTRING(overrapp1,29,9) = STRING(r3till.PLONTILLANTAL,"->>>>9.99").
         END.         
         ELSE IF r3till.ERSATTNING > 0 THEN DO:
            SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,"->>>>9.99").
            SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
         END.
         ELSE IF r3till.PSORT = "KR" THEN DO:
            SUBSTRING(overrapp1,30,9) = STRING(r3till.PLONTILLANTAL,"->>>>9.99").  
         END.
         ELSE DO:          
            SUBSTRING(overrapp1,7,9) = STRING(r3till.PLONTILLANTAL,"->>>>9.99").
         END.
         IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.          
      END.    
      ELSE IF r3till.PTRAKTKOD NE "" THEN DO:
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PTRAKTKOD,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PTRAKTANTAL,">>>>>9.99").      
         SUBSTRING(overrapp1,20,8) = STRING(r3till.ERSATTNING,">>>>9.99").
         IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
      END.   
      ELSE IF r3till.PBEREDSKAP NE "" THEN DO:
         /*Avrundning hundradelar mellan 0-0.24 = 0  0.25-0.74 = 0.5  0.75-1 = 1*/
         /*IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0 AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.25 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0).
         ELSE IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.25  AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.75 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 0.50.
         ELSE  IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) GE 0.75  THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 1.*/
         /* Avrundning hundradelar mellan 0.01- 0.49 = 0.5  0.51 -0.99 = 1*/
         /*IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) > 0 AND ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) < 0.50 THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 0.50.         
         ELSE  IF ( r3till.PBERANTAL - TRUNCATE(r3till.PBERANTAL,0)) > 0.50  THEN r3till.PBERANTAL = TRUNCATE(r3till.PBERANTAL,0) + 1.*/

         /*Avrundningen borttagen 2006-09-22 Pamela och Desiree har pratat med KFS*/
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.PBEREDSKAP,1,4).
         SUBSTRING(overrapp1,7,9) = STRING(r3till.PBERANTAL,">>>>>9.99").
         IF r3till.SLUTDATUM NE ? AND  r3till.SLUTDATUM NE r3till.PDATUM THEN DO:
            SUBSTRING(overrapp1,54,10) = STRING(r3till.SLUTDATUM,"9999/99/99").
         END.
      END.     
      ELSE IF r3till.POVERTIDTILL NE "" THEN DO:                   
         /*Avrundningen borttagen 2006-09-22 Pamela och Desiree har pratat med KFS*/
         /*IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0 AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) < 0.50 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 0.50.
         ELSE IF ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) > 0.50  AND ( r3till.POVERANTAL - TRUNCATE(r3till.POVERANTAL,0)) LE 0.99 THEN r3till.POVERANTAL = TRUNCATE(r3till.POVERANTAL,0) + 1.                  */
         ASSIGN
         SUBSTRING(overrapp1,2,4) = SUBSTRING(r3till.POVERTIDTILL,1,4)
         SUBSTRING(overrapp1,7,9) = STRING(r3till.POVERANTAL,">>>>>9.99").
         /*SUBSTRING(overrapp1,45,20) = SUBSTRING(r3till.RESMAL,1,20).    */
      END.          
   END.
   
   anstperson = r3till.PPERSONNUMMER.   
   IF overrapp1 NE ""  THEN DO:
      PUT overrapp1.   /*  r3tillen.P    */
      PUT SKIP. 
   END.
END PROCEDURE.
 
