/*Xeskorn.P. */
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.  
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.

DEFINE NEW SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.

DEFINE NEW SHARED VARIABLE appcon AS LOGICAL NO-UNDO.

DEFINE NEW SHARED VARIABLE tperiod AS INTEGER FORMAT "999" NO-UNDO.
DEFINE VARIABLE vknummer AS CHARACTER FORMAT "X(4)" NO-UNDO.
DEFINE TEMP-TABLE pa90fil
   FIELD PPERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD PLONTILLAGG LIKE TIDREGITAB.LONTILLAGG
   FIELD PLONTILLANTAL AS DECIMAL FORMAT "-999.99"
   FIELD POVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL
   FIELD POVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD PTRAKTKOD LIKE TIDREGITAB.TRAKTKOD
   FIELD PTRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL
   FIELD PBEREDSKAP LIKE TIDREGITAB.BEREDSKAP
   FIELD PBERANTAL LIKE TIDREGITAB.BERANTAL
   FIELD PDATUM LIKE TIDREGITAB.DATUM
   FIELD PVECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   FIELD PSORT AS CHARACTER FORMAT "XX"
   FIELD PPAR8 AS DECIMAL FORMAT "-99.99"
   FIELD PANSTNR LIKE PERSONALTAB.ANSTNR
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD PAVTAL AS CHARACTER
   FIELD BOLAG AS CHARACTER FORMAT "X(2)"
   INDEX PANSTNR IS PRIMARY PANSTNR ASCENDING.
globforetag = "ESAN".
globanv = CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79).
tperiod = 071.
vkdatum = 12/31/2000. 
CREATE SERVER Guru.Konstanter:apphand.
appcon = Guru.Konstanter:apphand:CONNECT("-S appesab -H elpaso.sydkraft.se -N TCP",CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79),"KAGGEN","") NO-ERROR. 
RUN ESVE1.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT vkdatum, INPUT Guru.Konstanter:globanv, INPUT tperiod).       
RUN ESFR1.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT vkdatum, INPUT Guru.Konstanter:globanv, INPUT tperiod).                       
/*  RUN ESINOMK.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT vkdatum).     */       
/*RUN ESFE1.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT vkdatum, INPUT Guru.Konstanter:globanv, INPUT tperiod).           */
regvnr = 105.
IF YEAR(TODAY) < 2000 THEN vknummer = "V" + STRING(regvnr, "999").
ELSE vknummer = "w" + STRING(today,"99999999").

DO:       
    OPEN QUERY vsatt FOR EACH TIDREGITAB WHERE TIDREGITAB.DATUM <= vkdatum AND
    TIDREGITAB.VECKOKORD = " "  NO-LOCK.  
    DO TRANSACTION:
       GET FIRST vsatt EXCLUSIVE-LOCK.
       IF AVAILABLE TIDREGITAB THEN DO:        
            IF TIDREGITAB.GODKAND = "F" THEN regdatum = regdatum.
            ELSE IF TIDREGITAB.GODKAND = " " THEN regdatum = regdatum.
            ELSE ASSIGN TIDREGITAB.VECKOKORD = vknummer.
       END.
     END.
     VKO:
     REPEAT TRANSACTION:
        GET NEXT vsatt EXCLUSIVE-LOCK.
        IF AVAILABLE TIDREGITAB THEN DO:
            IF TIDREGITAB.GODKAND = "F" THEN regdatum = regdatum.
            ELSE IF TIDREGITAB.GODKAND = " " THEN NEXT VKO.
            ELSE ASSIGN TIDREGITAB.VECKOKORD = vknummer.
         END. 
         ELSE LEAVE VKO. 
      END.             
   END.          
   CLOSE QUERY vsatt.   


IF Guru.Konstanter:appcon THEN Guru.Konstanter:appcon = Guru.Konstanter:apphand:DISCONNECT().
DELETE OBJECT Guru.Konstanter:apphand.
appcon = FALSE.

