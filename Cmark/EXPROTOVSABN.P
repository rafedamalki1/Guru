/*EXPROTOVSABN.P*/
{TIDUTTTNEW.I}
{FASTFORTEMP.I}

DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.



DEFINE VARIABLE kommando AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando2 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando3 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando4 AS CHARACTER FORMAT "X(20)" NO-UNDO.

DEFINE VARIABLE kommando20 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando21 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando31 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando41 AS CHARACTER FORMAT "X(20)" NO-UNDO.

DEFINE VARIABLE bladvar2 AS INTEGER NO-UNDO.
DEFINE VARIABLE protvar AS INTEGER NO-UNDO.

DEFINE VARIABLE fnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn1 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn2 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamnB AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn11 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn21 AS CHARACTER NO-UNDO.

DEFINE VARIABLE valvardnr AS INTEGER NO-UNDO.
DEFINE VARIABLE omravd AS INTEGER NO-UNDO.
DEFINE VARIABLE aovar AS CHARACTER NO-UNDO.
DEFINE VARIABLE delnrvar AS INTEGER NO-UNDO.
DEFINE VARIABLE ortvar AS CHARACTER NO-UNDO.   
DEFINE VARIABLE fkommun AS CHARACTER NO-UNDO.   
DEFINE VARIABLE fvaker AS CHARACTER NO-UNDO.   
DEFINE VARIABLE vman AS CHARACTER NO-UNDO.   
DEFINE VARIABLE vadress AS CHARACTER NO-UNDO.
DEFINE VARIABLE vpadress AS CHARACTER NO-UNDO.
DEFINE VARIABLE vtelef AS CHARACTER NO-UNDO.
DEFINE VARIABLE felmedd AS CHARACTER NO-UNDO.
DEFINE VARIABLE omromr AS CHARACTER NO-UNDO.
DEFINE VARIABLE hjproc AS INTEGER NO-UNDO.
DEFINE VARIABLE hjagare AS INTEGER NO-UNDO.
DEFINE VARIABLE projl AS CHARACTER NO-UNDO.
DEFINE VARIABLE arrendator AS CHARACTER NO-UNDO.
DEFINE VARIABLE ipfakt AS INTEGER NO-UNDO.
DEFINE VARIABLE ivfaktaker AS INTEGER NO-UNDO.
DEFINE VARIABLE bbelopp AS INTEGER NO-UNDO.
DEFINE VARIABLE pomr AS CHARACTER NO-UNDO.
DEFINE VARIABLE pfakt AS INTEGER NO-UNDO.
DEFINE VARIABLE vskog AS CHARACTER NO-UNDO.
DEFINE VARIABLE oktforekpi  AS DECIMAL NO-UNDO.
DEFINE VARIABLE kpi1995 AS DECIMAL NO-UNDO.
DEFINE VARIABLE kabersatt AS DECIMAL NO-UNDO.
DEFINE VARIABLE allnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE allpersnr AS CHARACTER NO-UNDO.
DEFINE VARIABLE antag AS INTEGER NO-UNDO.
DEFINE VARIABLE kontpers AS CHARACTER NO-UNDO.
DEFINE VARIABLE skogfast AS LOGICAL NO-UNDO.
DEFINE VARIABLE fdyr AS INTEGER NO-UNDO.
DEFINE VARIABLE skprotapph AS HANDLE NO-UNDO.
DEFINE VARIABLE andvardspecapph AS HANDLE NO-UNDO.
DEFINE VARIABLE extrarad AS INTEGER NO-UNDO.
DEFINE VARIABLE extrarad2 AS INTEGER NO-UNDO.
DEFINE VARIABLE revkost  AS INTEGER NO-UNDO.
DEFINE VARIABLE revtext AS CHARACTER NO-UNDO.
DEFINE VARIABLE adel AS CHARACTER NO-UNDO.
DEFINE VARIABLE lelitt AS CHARACTER NO-UNDO.
DEFINE VARIABLE pnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE pled AS CHARACTER NO-UNDO.
DEFINE VARIABLE konc AS CHARACTER NO-UNDO.
/*DEFINE VARIABLE domsaga AS CHARACTER NO-UNDO.*/
DEFINE VARIABLE nstn AS CHARACTER NO-UNDO.
DEFINE VARIABLE ktext AS CHARACTER NO-UNDO.
DEFINE VARIABLE linkbild AS CHARACTER NO-UNDO.
DEFINE VARIABLE fabet AS CHARACTER NO-UNDO.
DEFINE VARIABLE sidvar AS INTEGER NO-UNDO.
DEFINE VARIABLE sidvarB AS INTEGER NO-UNDO.
DEFINE VARIABLE hjlangd AS INTEGER NO-UNDO.
DEFINE VARIABLE hjbredd  AS DECIMAL NO-UNDO.
DEFINE VARIABLE kskapkr AS INTEGER NO-UNDO.
DEFINE VARIABLE nstnakerkr AS INTEGER NO-UNDO.
DEFINE VARIABLE nstnovrigkr AS INTEGER NO-UNDO.

DEFINE VARIABLE kablangd AS INTEGER NO-UNDO.

DEFINE VARIABLE pvaldomr AS INTEGER NO-UNDO.
DEFINE VARIABLE vardartal AS INTEGER NO-UNDO.
DEFINE VARIABLE akersum AS INTEGER NO-UNDO.
DEFINE VARIABLE ivvardedec AS DECIMAL NO-UNDO.
DEFINE VARIABLE antskap AS INTEGER NO-UNDO.
DEFINE VARIABLE antopto AS INTEGER NO-UNDO.
DEFINE VARIABLE antstn AS INTEGER NO-UNDO. 
DEFINE VARIABLE vardtel AS CHARACTER NO-UNDO.
DEFINE VARIABLE vort AS CHARACTER NO-UNDO.
DEFINE VARIABLE vepost AS CHARACTER NO-UNDO.
DEFINE VARIABLE metkab AS INTEGER NO-UNDO.
DEFINE VARIABLE azon1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE azon2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE afastb AS INTEGER NO-UNDO. 
DEFINE VARIABLE skogkrha AS INTEGER NO-UNDO.
DEFINE VARIABLE hjfastnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE sumsv AS DECIMAL NO-UNDO.
DEFINE VARIABLE expfakt AS DECIMAL NO-UNDO.

DEFINE VARIABLE iColumn                 AS INTEGER INITIAL 0.
DEFINE VARIABLE cColumn                 AS CHARACTER.
{SUMTEMP.I}
{MAGA.I}

DEFINE INPUT PARAMETER ponr AS CHARACTER FORMAT "X(12)" NO-UNDO.
DEFINE INPUT PARAMETER mall AS INTEGER  NO-UNDO.
DEFINE INPUT PARAMETER TABLE FOR maga.
DEFINE INPUT PARAMETER allamark AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER spmall AS LOGICAL NO-UNDO.
DEFINE INPUT PARAMETER fildir AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER skrivutmall AS LOGICAL NO-UNDO.
DEFINE OUTPUT PARAMETER ratt AS CHARACTER NO-UNDO.

{MARAG.I}

DEFINE TEMP-TABLE uppfoltemp   
   FIELD FORETAG AS CHARACTER
   FIELD ANVANDARE AS CHARACTER  
   FIELD ALLAMA AS LOGICAL
   FIELD VALVARD AS CHARACTER
   FIELD FORSTA AS LOGICAL
   FIELD STAMP AS LOGICAL.  

{allavardtemp.I}
     
DEFINE TEMP-TABLE fastaga         
   FIELD MARKNR AS INTEGER
   FIELD MARKAGARE AS CHARACTER
   FIELD PERSONNUMMER AS CHARACTER     
   INDEX MARKNR IS PRIMARY MARKNR ASCENDING.    
DEFINE TEMP-TABLE vilkafliktmp         
   FIELD MARKNR AS INTEGER
   FIELD BETECKNING AS CHARACTER
   FIELD SAMMAN AS LOGICAL INITIAL TRUE  
   FIELD AKER AS LOGICAL  INITIAL FALSE
   FIELD SKOG AS LOGICAL INITIAL FALSE
   FIELD TOMT AS LOGICAL INITIAL FALSE
   FIELD MARK AS LOGICAL INITIAL FALSE
   FIELD FAKTA AS LOGICAL INITIAL FALSE.
   
  
DEFINE TEMP-TABLE storskogadmtemp         
   FIELD NI AS DECIMAL
   FIELD NK AS DECIMAL
   FIELD TO3 AS DECIMAL   
   FIELD TO4A AS DECIMAL
   FIELD TO4B AS DECIMAL .
      

{GLOBVAR2DEL1.I}
&Scoped-define SHARED SHARED  
{MARKVAL.I}                         
&SCOPED-DEFINE NEW NEW
&SCOPED-DEFINE SHARED SHARED
{BLOB.I}
DEFINE VARIABLE bloblog AS LOGICAL NO-UNDO.
DEFINE VARIABLE blobproch AS HANDLE NO-UNDO.
DEFINE BUFFER marbuff FOR marag.
{EXECLIN.I}
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.
{EXTRADATA.I}
IF Guru.Konstanter:appcon THEN DO:
   RUN EXTRADATAHMT.P PERSISTENT SET edataapph ON Guru.Konstanter:apphand TRANSACTION DISTINCT. 
END.
ELSE DO:
  RUN EXTRADATAHMT.P PERSISTENT SET edataapph.  
END.
IF Guru.Konstanter:appcon THEN DO:
   RUN SKAPPROTOU7.P PERSISTENT SET skprotapph ON Guru.Konstanter:apphand TRANSACTION DISTINCT. 
END.
ELSE DO:
   RUN SKAPPROTOU7.P PERSISTENT SET skprotapph.
END.
 IF Guru.Konstanter:appcon THEN DO:
   RUN ANDVARDSPECAPP.P PERSISTENT SET andvardspecapph ON Guru.Konstanter:apphand TRANSACTION DISTINCT. 
END.
ELSE DO:
   RUN ANDVARDSPECAPP.P PERSISTENT SET andvardspecapph.
END.   
IF Guru.Konstanter:varforetypval[40] = 0 THEN expfakt = 1.                         
ELSE expfakt = 1.25.
extrarad = 0.
extrarad2 = 0.
/*IF mall = 23 THEN DO:     
   fnamn = "Bilakerjamt.xltm".
   fnamn1 = "Bilakerjamt".
   fnamn2 = ".xltm".      
   extrarad = 1.
   extrarad2 = 1.
END.*/

/*IF  mall = 53 THEN DO:
   /*sweo och SKOK har Boden*/     
   fnamn = "VPVATT2013.XLS".
   fnamn1 = "VPVATT2013".
   fnamn2 = ".XLS".
   IF Guru.Konstanter:globforetag = "SKOK" THEN DO:
      IF  mall = 53 THEN DO:
         fnamn = "VPVATT2013B.XLS".
         fnamn1 = "VPVATT2013B".
         fnamn2 = ".XLS".
       END.  
   END.   
   extrarad = 1.
   extrarad2 = 1.
END.
IF mall = 54 THEN DO:
   /*sweo och SKOK har Boden*/ 
   fnamn = "VPVATTLSP2013.XLS".
   fnamn1 = "VPVATT2013".
   fnamn2 = ".XLS".
   IF Guru.Konstanter:globforetag = "SKOK" THEN DO:
      IF  mall = 54 THEN DO:
         fnamn = "VPVATTLSP2013B.XLS".
         fnamn1 = "VPVATTLSP2013B".
         fnamn2 = ".XLS".
       END.  
   END.
   extrarad = 1.
END.*/
/*IF mall = 57  THEN DO:        
   IF Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "LULE"  THEN DO:
      fnamn = "VPVATT2013LU.XLSM".
      fnamn1 = "VPVATT2013LU".
      fnamn2 = ".XLSM".
   END.   
   extrarad = 1.
   extrarad2 = 1.
END.
IF mall = 58  THEN DO:    
   IF Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "LULE" THEN DO:
      fnamn = "VPVATTLSP2013LU.XLS".
      fnamn1 = "VPVATTLSP2013LU".
      fnamn2 = ".XLS".
   END.
   extrarad = 1.
END.*/
IF mall = 59  THEN DO:           
   fnamn = "VPKraftringen.XLSX".
   fnamn1 = "VPKraftringen".
   fnamn2 = ".XLSX".      
   extrarad = 1.
   extrarad2 = 1.
END.
/*IF mall = 64  THEN DO:        
   IF Guru.Konstanter:globforetag = "SKOK" THEN DO:
      fnamn = "VPVATT2013JU.XLS".
      fnamn1 = "VPVATT2013JU".
      fnamn2 = ".XLS".
   END.   
   extrarad = 1.
   extrarad2 = 1.
END.
IF mall = 65  THEN DO:    
   IF Guru.Konstanter:globforetag = "SKOK" THEN DO:
      fnamn = "VPVATTLSP2013JU.XLS".
      fnamn1 = "VPVATTLSP2013JU".
      fnamn2 = ".XLS".
   END.
   extrarad = 1.
END.*/
/*IF mall = 91  THEN DO:           
   fnamn = "VPPITE.XLS".
   fnamn1 = "VPPITE".
   fnamn2 = ".XLS".     
   extrarad = 1.
   extrarad2 = 1.
END.
IF mall = 92  THEN DO:       
   fnamn = "VPLSPPITE.XLS".
   fnamn1 = "VPLSPPITE".
   fnamn2 = ".XLS".
   extrarad = 1.
END.
IF mall = 22 THEN DO: 
   fnamn = "BIVAVP.XLS". 
   extrarad = 1.
   extrarad2 = 1.
END.*/

/*IF mall = 72 THEN DO:
   /*sweo har Jämtkraft*/
   fnamn = "VPJämt2015.XLS".
   fnamn1 = "VPJämt2015".
   fnamn2 = ".XLSm".   
   extrarad = 1. 
END.*/
/*IF mall = 74 THEN DO:     
   fnamn = "VPSNAT2015.XLSX".
   fnamn1 = "VPSNAT2015".
   fnamn2 = ".XLSX".
END.*/

IF mall = 107 THEN DO:
   /*dala kraft åt POWE*/
   fnamn = "VPDala.XLS".
   fnamn1 = "VPDala".
   fnamn2 = ".XLS".   
   extrarad = 3. 
   
END.
IF mall = 97 THEN DO:
   fnamn = "VPELLEVIO.XLSM".   
   fnamn1 = "VPELLEVIO".
   fnamn2 = ".XLSM".     
END.
IF mall = 98 THEN DO:
   fnamn = "VPREVELLEVIO.XLSM".   
   fnamn1 = "VPELLEVIO".
   fnamn2 = ".XLSM".     
      
END.
IF mall = 27 THEN DO:
   fnamn = "VPELLEVIO2022.XLSM".   
   fnamn1 = "VPELLEVIO2022".
   fnamn2 = ".XLSM".     
END.
IF mall = 28 THEN DO:
   fnamn = "VPREVELLEVIO2022.XLSM".   
   fnamn1 = "VPREVELLEVIO2022".
   fnamn2 = ".XLSM".     
      
END.
IF mall = 29 THEN DO:
   fnamn = "VPSTORSKOGELLEVIO2022.XLSM".   
   fnamn1 = "VPSTORSKOGELLEVIO2022".
   fnamn2 = ".XLSM".     
      
END.
IF Guru.Konstanter:appcon THEN RUN FINNSTABELL.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT "BLOBINFO", OUTPUT bloblog).
ELSE RUN FINNSTABELL.P (INPUT "BLOBINFO", OUTPUT bloblog).
IF bloblog = TRUE THEN DO:
   {FINNSDYNBLOB.I}
   DEFINE VARIABLE resid AS INTEGER NO-UNDO.
   RUN blobfil_UI IN blobproch (INPUT fnamn, OUTPUT resid).
   IF resid = ? THEN DO:
      kommando = SEARCH(fnamn).      
   END.
   ELSE DO:
      FIND FIRST blobinfotemp WHERE blobinfotemp.ID = resid NO-LOCK NO-ERROR.
      RUN blobopen_UI IN blobproch (INPUT blobinfotemp.FILNAMN, OUTPUT kommando).      
   END.
   RUN deleteproc_UI IN blobproch.
   IF VALID-HANDLE(blobproch) THEN DELETE PROCEDURE blobproch NO-ERROR.
END.
ELSE kommando = SEARCH(fnamn).   

IF kommando = ? THEN DO:
   MESSAGE "Hittade inte " fnamn VIEW-AS ALERT-BOX.
   RETURN.       
END.   
kommando2 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
kommando3 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
kommando4 = kommando.
{SESSIONTEMPDIR.I}
IF SESSION:CLIENT-TYPE = "WEBCLIENT" THEN DO:
    kommando2 = webclienttempdir.
    kommando3 = webclienttempdir.
END.    

OS-CREATE-DIR VALUE(kommando2) NO-ERROR.

IF spmall = TRUE AND fildir NE "" THEN DO:
   kommando2 = fildir  + "\".
   kommando3 = fildir  + "\".  
END.

/*IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
   kommando2 = kommando2 + fnamn.
END.
ELSE DO:
   kommando2 = kommando2 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn.
END.

OS-COPY VALUE(kommando) VALUE(kommando2).
kommando = kommando2.*/

   

fabet = "".
sidvar = 1.
sidvarB = 1.
/*RUN kskapnatbelopp_UI IN skprotapph (OUTPUT kskapkr, OUTPUT nstnakerkr  , OUTPUT nstnovrigkr).*/

IF NOT VALID-HANDLE(edataapph) THEN DO:
   RUN EXTRADATAHMT.P PERSISTENT SET edataapph.                           
END.



EMPTY TEMP-TABLE vilkafliktmp NO-ERROR. 
EMPTY TEMP-TABLE emarkval NO-ERROR.
IF allamark = "alla" THEN DO: 
   FOR EACH markval BY markval.BETECKNING:
      IF fabet NE markval.BETECKNING THEN DO:         
         CREATE emarkval.
         BUFFER-COPY markval TO emarkval.  
         CREATE vilkafliktmp.
         ASSIGN 
         vilkafliktmp.BETECKNING = emarkval.BETECKNING
         vilkafliktmp.MARKNR = emarkval.MARKNR.
                   
         IF sidvar = 1 THEN DO:            
            IF AVAILABLE emarkval THEN DO:
               hjfastnamn = emarkval.BETECKNING + " ".
               hjfastnamn = REPLACE(hjfastnamn,":"," ").
               hjfastnamn = REPLACE(hjfastnamn,"/"," "). 
               hjfastnamn = REPLACE(hjfastnamn,">"," ").
               hjfastnamn = REPLACE(hjfastnamn,"<"," ").    
               /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
               hjfastnamn = REPLACE(hjfastnamn,"\"," ").
               hjfastnamn = REPLACE(hjfastnamn,"*"," ").
               hjfastnamn = REPLACE(hjfastnamn,"|"," ").
               hjfastnamn = REPLACE(hjfastnamn,'"'," ").
               hjfastnamn = REPLACE(hjfastnamn,";"," ").      
               hjfastnamn = REPLACE(hjfastnamn,","," ").
               hjfastnamn = REPLACE(hjfastnamn,"'"," ").
               hjfastnamn = REPLACE(hjfastnamn,"+"," ").
               hjfastnamn = REPLACE(hjfastnamn,"."," ").           
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando3 + fnamn1 + " " + hjfastnamn + fnamn2.
               END.
               ELSE DO:
                  kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + " " + hjfastnamn +  fnamn2.
               END.
            END.
            ELSE DO:
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando2 + fnamn.
               END.
               ELSE DO:
                  kommando2 = kommando2 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn.
               END.
            END.
            OS-COPY VALUE(kommando) VALUE(kommando2).
            kommando = kommando2.
         END.
          
         IF  sidvar > 1 THEN DO:
            IF AVAILABLE emarkval THEN DO:
               hjfastnamn = emarkval.BETECKNING + " ".
               hjfastnamn = REPLACE(hjfastnamn,":"," "). 
               hjfastnamn = REPLACE(hjfastnamn,"/"," ").
               hjfastnamn = REPLACE(hjfastnamn,">"," ").
               hjfastnamn = REPLACE(hjfastnamn,"<"," ").
               /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
               hjfastnamn = REPLACE(hjfastnamn,"\"," ").
               hjfastnamn = REPLACE(hjfastnamn,"*"," ").
               hjfastnamn = REPLACE(hjfastnamn,"|"," ").
               hjfastnamn = REPLACE(hjfastnamn,'"'," ").
               hjfastnamn = REPLACE(hjfastnamn,";"," ").      
               hjfastnamn = REPLACE(hjfastnamn,","," ").
               hjfastnamn = REPLACE(hjfastnamn,"'"," ").
               hjfastnamn = REPLACE(hjfastnamn,"+"," ").
               hjfastnamn = REPLACE(hjfastnamn,"."," ").
               
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando3 + fnamn1 + " " + hjfastnamn + fnamn2.
               END.
               ELSE DO:
                  kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + " " + hjfastnamn +  fnamn2.
               END.
            END.
            ELSE DO:                              
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando3 + fnamn1 + string(sidvar) + fnamn2.
               END.
               ELSE DO:
                  kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + string(sidvar) + fnamn2.
               END.
            END.            
            
            
            OS-COPY VALUE(kommando4) VALUE(kommando2).   
            kommando = kommando2.    
                 
            CREATE "Excel.Application" chExcelApplication.
            IF spmall = TRUE THEN chExcelApplication:Visible = FALSE.
            ELSE IF  skrivutmall = TRUE THEN chExcelApplication:Visible = FALSE.
            ELSE chExcelApplication:Visible = TRUE.
            {OPENEXCEL.I}
            chWorkbook = chExcelApplication:Workbooks:OPEN(kommando).
            
            
         END.
         RUN skapavp_UI.
         
         IF akersum > 0 THEN   RUN bilagaaker_UI.   
         EMPTY TEMP-TABLE emarkval NO-ERROR.
         fabet = markval.BETECKNING.
      END.    
   END.
END.
ELSE IF allamark = "vald" THEN DO: 
   FOR EACH markval BY markval.BETECKNING BY markval.MARKNR:               
      CREATE emarkval.
      BUFFER-COPY markval TO emarkval.  
      CREATE vilkafliktmp.
      ASSIGN 
      vilkafliktmp.BETECKNING = emarkval.BETECKNING
      vilkafliktmp.MARKNR = emarkval.MARKNR.          
      
      IF sidvar = 1 THEN DO:            
         IF AVAILABLE emarkval THEN DO:
            hjfastnamn = emarkval.BETECKNING + " ".
            hjfastnamn = REPLACE(hjfastnamn,":"," ").
            hjfastnamn = REPLACE(hjfastnamn,"/"," "). 
            hjfastnamn = REPLACE(hjfastnamn,">"," ").
            hjfastnamn = REPLACE(hjfastnamn,"<"," ").     
            /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
            hjfastnamn = REPLACE(hjfastnamn,"\"," ").
            hjfastnamn = REPLACE(hjfastnamn,"*"," ").
            hjfastnamn = REPLACE(hjfastnamn,"|"," ").
            hjfastnamn = REPLACE(hjfastnamn,'"'," ").
            hjfastnamn = REPLACE(hjfastnamn,";"," ").      
            hjfastnamn = REPLACE(hjfastnamn,","," ").
            hjfastnamn = REPLACE(hjfastnamn,"'"," ").
            hjfastnamn = REPLACE(hjfastnamn,"+"," ").
            hjfastnamn = REPLACE(hjfastnamn,"."," ").          
            IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
               kommando2 = kommando3 + fnamn1 + " " + hjfastnamn + fnamn2.
            END.
            ELSE DO:
               kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + " " + hjfastnamn +  fnamn2.
            END.
         END.
         ELSE DO:
            IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
               kommando2 = kommando2 + fnamn.
            END.
            ELSE DO:
               kommando2 = kommando2 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn.
            END.
         END.
         OS-COPY VALUE(kommando) VALUE(kommando2).
         kommando = kommando2.
      
      END.         
      IF  sidvar > 1 THEN DO:
         IF AVAILABLE emarkval THEN DO:
            hjfastnamn = emarkval.BETECKNING + " ".
            hjfastnamn = REPLACE(hjfastnamn,":"," "). 
            hjfastnamn = REPLACE(hjfastnamn,"/"," ").
            hjfastnamn = REPLACE(hjfastnamn,">"," ").
            hjfastnamn = REPLACE(hjfastnamn,"<"," ").
            
            IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
               kommando2 = kommando3 + fnamn1 + " " + hjfastnamn + fnamn2.
            END.
            ELSE DO:
               kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + " " + hjfastnamn +  fnamn2.
            END.
         END.
         ELSE DO:                    
            IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
               kommando2 = kommando3 + fnamn1 + string(sidvar) + fnamn2.
            END.
            ELSE DO:
               kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + string(sidvar) + fnamn2.
            END.
         END.   
         OS-COPY VALUE(kommando4) VALUE(kommando2).   
         kommando = kommando2.   
               
         CREATE "Excel.Application" chExcelApplication.
         IF spmall = TRUE THEN chExcelApplication:Visible = FALSE.
         ELSE IF  skrivutmall = TRUE THEN chExcelApplication:Visible = FALSE.
         ELSE chExcelApplication:Visible = TRUE.
         {OPENEXCEL.I}
         chWorkbook = chExcelApplication:Workbooks:OPEN(kommando).
         
         
           
      END.
      RUN skapavp_UI.
      
      IF akersum > 0 THEN   RUN bilagaaker_UI.   
      EMPTY TEMP-TABLE emarkval NO-ERROR.       
   END.
END.       
IF VALID-HANDLE(skprotapph) THEN DELETE PROCEDURE skprotapph.      
skprotapph = ?.
IF VALID-HANDLE(edataapph) THEN DELETE PROCEDURE edataapph.      
edataapph = ?.

PROCEDURE skapavp_UI :   
   
   FIND FIRST emarkval NO-LOCK NO-ERROR.  
   IF Guru.Konstanter:appcon THEN DO:                           
      RUN EXVPFAKT.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT 
      (INPUT emarkval.VARDNR,INPUT emarkval.BETECKNING,INPUT TABLE emarkval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
      ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl, OUTPUT arrendator,
       OUTPUT ipfakt,OUTPUT ivfaktaker,OUTPUT pomr,OUTPUT bbelopp,OUTPUT pfakt,OUTPUT vskog,OUTPUT oktforekpi,OUTPUT kpi1995, OUTPUT kabersatt,OUTPUT TABLE marag ).
   END.
   ELSE DO:
      RUN EXVPFAKT.P 
      (INPUT emarkval.VARDNR,INPUT emarkval.BETECKNING,INPUT TABLE emarkval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
      ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl , OUTPUT arrendator,
       OUTPUT ipfakt,OUTPUT ivfaktaker,OUTPUT pomr,OUTPUT bbelopp,OUTPUT pfakt,OUTPUT vskog,OUTPUT oktforekpi,OUTPUT kpi1995, OUTPUT kabersatt,OUTPUT TABLE marag ).
   END.   
   ASSIGN       
   lelitt = ""
   pnamn = ""
   pled = ""
   konc = ""
   /*domsaga = ""*/
   nstn = "".
   
   IF ponr NE ? AND ponr NE ""  THEN DO:
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "NATPROJ"                   
      inextradatatemp.HUVUDCH = ponr.                    
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FIND FIRST extradatatemp NO-LOCK NO-ERROR.
      IF AVAILABLE extradatatemp THEN DO:      
         ASSIGN       
         lelitt = extradatatemp.SOKCHAR[1] 
         pnamn = extradatatemp.SOKCHAR[2] 
         pled = extradatatemp.SOKCHAR[3] 
         konc = extradatatemp.SOKCHAR[4] 
         /*domsaga = extradatatemp.SOKCHAR[5]*/ 
         nstn = extradatatemp.SOKCHAR[9].       
      END.   
   END.
   
   CREATE uppfoltemp.
   ASSIGN
   uppfoltemp.FORETAG = Guru.Konstanter:globforetag   
   uppfoltemp.ALLAMA = FALSE
   uppfoltemp.VALVARD = ""
   uppfoltemp.FORSTA = TRUE
   uppfoltemp.STAMP = TRUE.   
   FIND FIRST emarkval NO-LOCK NO-ERROR.  
   RUN vpVSAB_UI IN skprotapph
      (INPUT "" ,INPUT emarkval.BETECKNING,INPUT emarkval.MARKREC,INPUT TABLE uppfoltemp,INPUT TABLE emarkval,INPUT TABLE maga,OUTPUT TABLE akevard,
      OUTPUT TABLE svard ,OUTPUT TABLE akekab,OUTPUT TABLE sumtemp,OUTPUT allnamn, OUTPUT allpersnr,OUTPUT TABLE fastaga).
       
   FIND FIRST emarkval NO-LOCK NO-ERROR.  
   RUN fordyrad_UI IN skprotapph
      (INPUT emarkval.VARDNR ,INPUT emarkval.BETECKNING,OUTPUT fdyr).
   
   
   FIND FIRST emarkval NO-LOCK NO-ERROR.  
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "MARKFASTANDEL"                   
   inextradatatemp.HUVUDINT = emarkval.MARKNR.                    
   inextradatatemp.HUVUDCH = emarkval.BETECKNING.                    
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.
   IF AVAILABLE extradatatemp THEN DO:      
      ASSIGN     
      adel = extradatatemp.SOKCHAR[1].
   END.
   ELSE adel = "1/1".
  
      
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   EMPTY TEMP-TABLE extradatatemp NO-ERROR.    
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "FASTLOPNR"                   
   inextradatatemp.HUVUDCH = emarkval.BETECKNING.                    
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.
   IF AVAILABLE extradatatemp THEN DO:      
      IF extradatatemp.SOKINT[1] NE 0 THEN DO:      
         /*markägarnummer sparat på fastigheten*/
         FIND FIRST marbuff WHERE marbuff.BETECKNING = emarkval.BETECKNING AND marbuff.MARKNR = extradatatemp.SOKINT[1] NO-LOCK NO-ERROR.
         IF AVAILABLE marbuff THEN DO:
            kontpers = marbuff.MARKAGARE.
         END.
         ELSE RUN ktakt_UI IN skprotapph (INPUT emarkval.BETECKNING,INPUT extradatatemp.SOKINT[1],OUTPUT kontpers).
         
      END.
   END.
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   EMPTY TEMP-TABLE extradatatemp NO-ERROR.
   
   EMPTY TEMP-TABLE tidut NO-ERROR. 
   DEBUGGER:SET-BREAK().
   IF sidvar = 1 THEN DO:
            
      CREATE "Excel.Application" chExcelApplication.
      
      IF spmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE IF skrivutmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE chExcelApplication:Visible = TRUE.
      
      /**/
      {OPENEXCEL.I}
      chWorkbook = chExcelApplication:Workbooks:OPEN(kommando).
      IF mall = 97 OR  mall = 27 OR mall = 29 THEN DO:
         chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.
         IF  mall = 27 THEN chWorkSheet:PAGESETUP:printarea = "$A$1:$AH$49" .
         IF  mall = 29 THEN chWorkSheet:PAGESETUP:printarea = "$A$1:$AH$51" .
      END.   
      IF mall = 98 OR mall = 28 THEN DO:
         chWorkSheet = chExcelApplication:Sheets:Item(6) NO-ERROR.
         IF  mall = 28 THEN chWorkSheet:PAGESETUP:printarea = "$A$1:$AH$48" .
      END.      
      
      /*chWorkSheet:PAGESETUP:printarea = "$A$1:$AH$49" .*/
      
      
      
      
      /*RUN sidbrytbredd_UI (INPUT 1).*/
      
      
       
      /*chWorkSheet:PAGESETUP:printarea = "$A$1:$AH$135" .*/
      
     
     /*här  har radbryt försvunnit*/ 
   END.   
   FIND FIRST emarkval  NO-LOCK NO-ERROR.
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
   EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "VARDNRARTAL"                   
   inextradatatemp.HUVUDINT = emarkval.VARDNR.                    
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.
   IF AVAILABLE extradatatemp THEN DO:      
      ASSIGN
      vardartal = extradatatemp.SOKINT[1].      
   END.
   ELSE vardartal = YEAR(TODAY).   
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
   EMPTY TEMP-TABLE extradatatemp NO-ERROR.
   
   
   sidvar = sidvar + 1.
   RELEASE OBJECT chWorksheet NO-ERROR.
   DEBUGGER:SET-BREAK().
   IF mall = 97 OR mall = 98 OR mall = 27 OR mall = 28 OR mall = 29 THEN DO:  
      IF mall = 97 OR  mall = 27 OR mall = 29 THEN chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.
      IF mall = 98 OR mall = 28 THEN chWorkSheet = chExcelApplication:Sheets:Item(6) NO-ERROR.      
      /*test Ellevio*/      
      FIND FIRST emarkval WHERE emarkval.MARKERAD = TRUE NO-LOCK NO-ERROR.  
      FIND FIRST marag WHERE marag.MARKERAD = TRUE NO-LOCK NO-ERROR.
      FIND FIRST emarkval NO-LOCK NO-ERROR.  
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "MARKFASTANDEL"                   
      inextradatatemp.HUVUDINT = emarkval.MARKNR.                    
      inextradatatemp.HUVUDCH = emarkval.BETECKNING.                    
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FIND FIRST extradatatemp NO-LOCK NO-ERROR.
      IF AVAILABLE extradatatemp THEN DO:      
         ASSIGN emarkval.PRODEL = extradatatemp.SOKDEC[1].         
      END.          
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE extradatatemp NO-ERROR.
      IF konc NE "" THEN DO:    
         iColumn = 13.
         cColumn = STRING(iColumn).
         cRange = "J" + cColumn.
         chWorkSheet:Range(cRange):Value = INTEGER(konc) NO-ERROR.
      END.
      iColumn = 3.
      cColumn = STRING(iColumn).
      cRange = "E" + cColumn.
      chWorkSheet:Range(cRange):Value = fkommun + " " + emarkval.BETECKNING NO-ERROR.
      iColumn = 4.
      cColumn = STRING(iColumn).
      cRange = "E" + cColumn.
      chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
      iColumn = 5.
      cColumn = STRING(iColumn).
      cRange = "E" + cColumn.
      chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.
      iColumn = 7.
      cColumn = STRING(iColumn).
      cRange = "E" + cColumn.
      chWorkSheet:Range(cRange):Value = marag.POSTNUMMER  NO-ERROR.
      iColumn = 7.
      cColumn = STRING(iColumn).
      cRange = "N" + cColumn.
      chWorkSheet:Range(cRange):Value =  marag.POSTADRESS NO-ERROR.
            
      IF mall = 97 OR mall = 27 OR mall = 29 THEN DO:
         iColumn = 9.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         IF emarkval.PRODEL > 0 THEN chWorkSheet:Range(cRange):Value = STRING(emarkval.PRODEL / 100) NO-ERROR.
         ELSE IF emarkval.PRODEL = 0 THEN chWorkSheet:Range(cRange):Value = STRING(1) NO-ERROR.
         iColumn = 10.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         iColumn = 12.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.          
         RUN vardman4_UI IN skprotapph (INPUT emarkval.VARDNR , OUTPUT vman, OUTPUT vardtel,output vepost, OUTPUT vort ).      
         iColumn = 47.
         cColumn = STRING(iColumn).
         cRange = "V" + cColumn.
         IF vardtel NE "" THEN chWorkSheet:Range(cRange):Value = vardtel NO-ERROR.
         iColumn = 48.
         cColumn = STRING(iColumn).
         cRange = "V" + cColumn.
         IF vepost NE "" THEN  chWorkSheet:Range(cRange):Value = vepost NO-ERROR.
      END.
      IF mall = 98 OR mall = 28 THEN DO:         
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         iColumn = 12.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         iColumn = 13.
         cColumn = STRING(iColumn).
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
                   
         RUN vardman4_UI IN skprotapph (INPUT emarkval.VARDNR , OUTPUT vman, OUTPUT vardtel,output vepost, OUTPUT vort ).      
         iColumn = 46.
         cColumn = STRING(iColumn).
         cRange = "X" + cColumn.
         IF vardtel NE "" THEN chWorkSheet:Range(cRange):Value = vardtel NO-ERROR.
         iColumn = 47.
         cColumn = STRING(iColumn).
         cRange = "X" + cColumn.
         IF vepost NE "" THEN  chWorkSheet:Range(cRange):Value = vepost NO-ERROR.
         IF konc NE "" THEN DO:    
            iColumn = 14.
            cColumn = STRING(iColumn).
            cRange = "J" + cColumn.
            chWorkSheet:Range(cRange):Value = INTEGER(konc) NO-ERROR.
         END.
      END.   
      IF mall = 97 OR  mall = 27 OR mall = 29 THEN DO:      
         metkab = 0.
         FOR EACH akekab WHERE akekab.MARKNR = emarkval.MARKNR AND akekab.BETECKNING = emarkval.BETECKNING AND akekab.FASTPRIS = FALSE :
            metkab = metkab + akekab.L1.   
         END. 
         
         iColumn = 19.
         cColumn = STRING(iColumn).
         cRange = "V" + cColumn.
         IF metkab > 0 THEN chWorkSheet:Range(cRange):Value = STRING(metkab,">>>9") NO-ERROR.     
         
         
         IF mall = 97 OR  mall = 27  THEN chWorkSheet = chExcelApplication:Sheets:Item(9) NO-ERROR.
         ELSE IF  mall = 29 THEN chWorkSheet = chExcelApplication:Sheets:Item(11) NO-ERROR.
        
                    
         FOR EACH akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING   AND akevard.L5 = 1 AND akevard.STOLPNR NE 0  NO-LOCK BY  akevard.L3:                   
            IF akevard.KRONOR > 0 THEN DO:                                    
                IF akevard.L3 = 50 THEN DO:
                    iColumn = 10.
                    cColumn = STRING(iColumn).
                    cRange = "D" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.                 
                END.
                ELSE IF akevard.L3 = 51 THEN DO:
                    iColumn = 11.
                    cColumn = STRING(iColumn).
                    cRange = "D" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                    
                END.
                ELSE IF akevard.L3 = 52 THEN DO:
                    iColumn = 12.
                    cColumn = STRING(iColumn).
                    cRange = "D" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 53 THEN DO:
                    iColumn = 10.
                    cColumn = STRING(iColumn).
                    cRange = "F" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 54 THEN DO:
                    iColumn = 10.
                    cColumn = STRING(iColumn).
                    cRange = "H" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 55 THEN DO:
                    iColumn = 10.
                    cColumn = STRING(iColumn).
                    cRange = "J" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 56 THEN DO:
                    iColumn = 11.
                    cColumn = STRING(iColumn).
                    cRange = "F" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 57 THEN DO:
                    iColumn = 11.
                    cColumn = STRING(iColumn).
                    cRange = "H" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 58 THEN DO:
                    iColumn = 11.
                    cColumn = STRING(iColumn).
                    cRange = "J" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 59 THEN DO:
                    iColumn = 12.
                    cColumn = STRING(iColumn).
                    cRange = "F" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 60 THEN DO:
                    iColumn = 12.
                    cColumn = STRING(iColumn).
                    cRange = "H" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.
                ELSE IF akevard.L3 = 61 THEN DO:
                    iColumn = 12.
                    cColumn = STRING(iColumn).
                    cRange = "J" + cColumn.
                    chWorkSheet:Range(cRange):Value = STRING(akevard.L1) NO-ERROR.
                END.    
            END. 
         END.
         
         IF mall = 97 OR  mall = 27  THEN chWorkSheet = chExcelApplication:Sheets:Item(6) NO-ERROR.
         ELSE IF  mall = 29 THEN chWorkSheet = chExcelApplication:Sheets:Item(10) NO-ERROR.
         
         
         iColumn = 5.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = marag.PAKER NO-ERROR.

         iColumn = 8.
         cColumn = STRING(iColumn).
         FOR EACH akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING
         AND akevard.L5 = 0 AND akevard.STOLPNR NE 0 :
            
            /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris*/
            IF akevard.FASTPRIS = TRUE AND akevard.KRONOR > 0 THEN iColumn = iColumn.
            ELSE DO:   
               cColumn = STRING(iColumn).
               cRange = "A" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.STOLPNR,">>9")  + " " + akevard.BENAMNING NO-ERROR.
               
               cRange = "F" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.L1,">>>9") NO-ERROR.   
               cRange = "H" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.L2,">>>9") NO-ERROR.                
               cRange = "J" + cColumn.               
               chWorkSheet:Range(cRange):Value = STRING(akevard.L3,">>>9") NO-ERROR.
                  
               cRange = "K" + cColumn.   
               IF akevard.SORT = "Åker" THEN DO:               
                  chWorkSheet:Range(cRange):Value = "Å" NO-ERROR.
               END.
               IF akevard.SORT = "Betesmark" THEN DO:               
                  chWorkSheet:Range(cRange):Value = "B" NO-ERROR.
               END.
               IF akevard.SORT = "Impediment" THEN DO:               
                  chWorkSheet:Range(cRange):Value = "I" NO-ERROR.
               END.
               
               cRange = "L" + cColumn.          
               IF akevard.KR > 0 THEN DO:               
                  chWorkSheet:Range(cRange):Value = "N" NO-ERROR.
               END.
               ELSE DO:               
                  chWorkSheet:Range(cRange):Value = "B" NO-ERROR.
               END.
               
               iColumn = 5.
               cColumn = STRING(iColumn).
               cRange = "J" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(ROUND((ivfaktaker / 5.71),2)) NO-ERROR.
               
               
               iColumn = iColumn + 1.
               cColumn = STRING(iColumn).
            END.
         END.
         
         IF  mall = 27 THEN DO:                          
            IF mall = 27  THEN chWorkSheet = chExcelApplication:Sheets:Item(7) NO-ERROR.     
            /*ELSE IF mall = 107  THEN chWorkSheet = chExcelApplication:Sheets:Item(6) NO-ERROR.
            ELSE chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.*/
            sumsv = 0.   
            iColumn = 10.
            cColumn = STRING(iColumn).
            FOR EACH svard WHERE svard.MARKNR = emarkval.MARKNR AND svard.BETECKNING = emarkval.BETECKNING AND svard.FASTPRIS = TRUE:
               sumsv = sumsv + svard.KRONOR .
               /*cColumn = STRING(iColumn).
               cRange = "B" + cColumn.
               VisaExcel:DataOut(cRange,svard.BENAMNING).         
               cRange = "J" + cColumn.
               VisaExcel:DataOut(cRange,STRING(INTEGER(svard.KRONOR / expfakt))).
               /*IF Guru.Konstanter:varforetypval[40] = 0 THEN VisaExcel:DataOut(cRange,STRING(svard.KRONOR)).         
               ELSE VisaExcel:DataOut(cRange,STRING(INTEGER(svard.KRONOR / 1.25))).*/                                                       
               iColumn = iColumn + 1.
               cColumn = STRING(iColumn).*/            
            END.
            IF sumsv > 0 THEN DO:
               cRange = "B" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(INTEGER(sumsv / expfakt)) NO-ERROR.
            END.                  
         END.   

         IF  Guru.Konstanter:varforetypval[42] = 1 THEN DO:
            IF  mall = 29 THEN DO:
               chWorkSheet = chExcelApplication:Sheets:Item(9) NO-ERROR.
               FIND FIRST emarkval NO-LOCK NO-ERROR.  
               FIND FIRST marag NO-LOCK NO-ERROR.
               FIND FIRST svard WHERE svard.BETECKNING = emarkval.BETECKNING AND svard.FASTPRIS = FALSE NO-LOCK NO-ERROR.
               IF NOT AVAILABLE svard THEN DO:
                  /*dummy*/
                  FIND FIRST emarkval NO-LOCK NO-ERROR.
               END.
               IF AVAILABLE svard THEN DO:
                  RUN hmtkrhaN_UI IN andvardspecapph (INPUT emarkval.VARDNR, INPUT svard.MARKTYP, INPUT Guru.Konstanter:globforetag, OUTPUT skogkrha).
                  iColumn = 17.
                  cColumn = STRING(iColumn).
                  cRange = "F" + cColumn.
                  chWorkSheet:Range(cRange):Value = STRING(ROUND((skogkrha / 10000),2)) NO-ERROR.
                   
                         
                  FIND FIRST  svard WHERE svard.BETECKNING = emarkval.BETECKNING AND svard.MARKNR = emarkval.MARKNR AND svard.FASTPRIS = FALSE NO-LOCK NO-ERROR.
                  IF AVAILABLE svard THEN DO:
                     iColumn = 13.
                     cColumn = STRING(iColumn).                                                                    
                     cRange = "F" + cColumn.
                     chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.                     
                     iColumn = 15.
                     cColumn = STRING(iColumn).                                         
                     cRange = "F" + cColumn.                                     
                     chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR. 
                     FIND NEXT  svard WHERE svard.BETECKNING = emarkval.BETECKNING AND svard.MARKNR = emarkval.MARKNR AND svard.FASTPRIS = FALSE NO-LOCK NO-ERROR.
                     IF AVAILABLE svard THEN DO:
                        iColumn = 13.
                        cColumn = STRING(iColumn).                                                                    
                        cRange = "H" + cColumn.
                        chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.
                        iColumn = 15.
                        cColumn = STRING(iColumn).                                         
                        cRange = "H" + cColumn.
                        chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR.                  
                        FIND NEXT  svard WHERE svard.BETECKNING = emarkval.BETECKNING AND svard.MARKNR = emarkval.MARKNR AND svard.FASTPRIS = FALSE NO-LOCK NO-ERROR.
                        IF AVAILABLE svard THEN DO:
                           iColumn = 13.
                           cColumn = STRING(iColumn).                                                                    
                           cRange = "J" + cColumn.
                           chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.
                           iColumn = 15.
                           cColumn = STRING(iColumn).                                         
                           cRange = "J" + cColumn.
                           chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR.
                           FIND NEXT  svard WHERE svard.BETECKNING = emarkval.BETECKNING AND svard.MARKNR = emarkval.MARKNR AND svard.FASTPRIS = FALSE NO-LOCK NO-ERROR.
                           IF AVAILABLE svard THEN DO:
                              iColumn = 13.
                              cColumn = STRING(iColumn).                                                                    
                              cRange = "L" + cColumn.
                              chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.
                              iColumn = 15.
                              cColumn = STRING(iColumn).                                         
                              cRange = "L" + cColumn.
                              chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR.
                           END.                        
                        END.                        
                     END.
                  END.
               END.
             END.              
         END.  
      END.
      ELSE IF  mall = 98 OR mall = 28 THEN DO:
                  
         revkost = 0.
         revtext = "".
         
         EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
         EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
         CREATE inextradatatemp.          
         ASSIGN
         inextradatatemp.PROGRAM = "REVAVTAL"                   
         inextradatatemp.HUVUDINT = marag.VARDNR
         inextradatatemp.HUVUDCH = marag.BETECKNING.                          
         RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
         FOR EACH extradatatemp :         
            IF extradatatemp.SOKINT[1] = 1  THEN DO:
               iColumn = 18.
               cColumn = STRING(iColumn).
               cRange = "U" + cColumn.                            
               chWorkSheet:Range(cRange):Value = STRING(extradatatemp.SOKDEC[2]) NO-ERROR.       
            END.
            IF extradatatemp.SOKINT[1] = 2  THEN DO:          
               iColumn = 19.
               cColumn = STRING(iColumn).
               cRange = "U" + cColumn.                            
               chWorkSheet:Range(cRange):Value = STRING(extradatatemp.SOKDEC[2]) NO-ERROR.                      
            END.         
            
         END.
         iColumn = 23.
         cColumn = STRING(iColumn).
         cRange = "J" + cColumn.                            
         chWorkSheet:Range(cRange):Value = STRING(1) NO-ERROR.         
      END.      
              
   END.
   
   /*ELSE IF mall = 23 THEN DO:
      FIND FIRST emarkval NO-LOCK NO-ERROR.  
      FIND FIRST marag NO-LOCK NO-ERROR.
      chWorkSheet = chExcelApplication:Sheets:Item(1) NO-ERROR.
      iColumn = 6.
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.
      chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.
      
      IF oktforekpi NE 0 THEN DO:
         iColumn = 6.
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(oktforekpi,">99.99") NO-ERROR.
      END. 
      iColumn = 12.
      cColumn = STRING(iColumn).
      FOR EACH akekab WHERE akekab.MARKNR = emarkval.MARKNR AND akekab.BETECKNING = emarkval.BETECKNING AND akekab.FASTPRIS = FALSE :         
         {EXCELFEL.I}         
         cColumn = STRING(iColumn).            
         cRange = "B" + cColumn.
         IF akekab.BENAMNING NE "" THEN chWorkSheet:Range(cRange):Value = akekab.BENAMNING NO-ERROR.
         cRange = "D" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(akekab.L1,">>>9") NO-ERROR.   
         cRange = "E" + cColumn.
         IF akekab.L2 = 0 THEN chWorkSheet:Range(cRange):Value = STRING(1,">>>9") NO-ERROR.
         ELSE chWorkSheet:Range(cRange):Value = STRING(akekab.L2 + 1) NO-ERROR.
         iColumn = iColumn + 1.
         cColumn = STRING(iColumn).      
      END.  
      
   END.*/   
  /* IF  mall = 74  THEN DO:      
      /*ny mall vp 2015*/      
      FIND FIRST emarkval NO-LOCK NO-ERROR.  
      FIND FIRST marag NO-LOCK NO-ERROR.
      chWorkSheet = chExcelApplication:Sheets:Item(1) NO-ERROR.
      iColumn = 4.
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.
      chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.      
      iColumn = 5.
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.
      chWorkSheet:Range(cRange):Value = fkommun NO-ERROR.
      IF mall = 74  THEN DO:
         /*EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
         EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
         CREATE inextradatatemp.          
         ASSIGN
         inextradatatemp.PROGRAM = "VARDNRARTAL"                   
         inextradatatemp.HUVUDINT = emarkval.VARDNR.                    
         RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
         FIND FIRST extradatatemp NO-LOCK NO-ERROR.
         IF AVAILABLE extradatatemp THEN DO:      
            ASSIGN
            vardartal = extradatatemp.SOKINT[1].      
         END.
         ELSE vardartal = YEAR(TODAY).   
         EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
         EMPTY TEMP-TABLE extradatatemp NO-ERROR.*/
        
         
         
         IF mall = 74  THEN DO:
            iColumn = 1.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.
            chWorkSheet:Range(cRange):Value = "VÄRDERINGSPROTOKOLL " + STRING(vardartal) NO-ERROR.
            iColumn = 4.
            cColumn = STRING(iColumn).
            cRange = "H" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(bbelopp * 100) NO-ERROR.
            IF oktforekpi NE 0 THEN DO:
               iColumn = 13.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(oktforekpi,">99.99") NO-ERROR.
               iColumn = 24.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(oktforekpi,">99.99") NO-ERROR.
               iColumn = 39.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(oktforekpi,">99.99") NO-ERROR.
            END.                 
        END.    
      END.   
      IF mall = 74  THEN DO:
         IF pomr = "GSS" THEN pvaldomr = 1.
         IF pomr = "GMB" THEN pvaldomr = 2.
         IF pomr = "GNS" THEN pvaldomr = 3.
         IF pomr = "SS" THEN pvaldomr = 4.
         IF pomr = "GSK" THEN pvaldomr = 5.
         IF pomr = "SSK" THEN pvaldomr = 6.
         IF pomr = "NN" THEN pvaldomr = 7.
         IF pomr = "NÖ" THEN pvaldomr = 8.
         IF pvaldomr > 0 THEN DO:
            iColumn = 6.           
            cColumn = STRING(iColumn).
            cRange = "M" + cColumn.                 
            chWorkSheet:Range(cRange):Value = pvaldomr NO-ERROR.
         END.              
         IF allamark = "alla" THEN DO:
            iColumn = 7.           
            cColumn = STRING(iColumn).
            cRange = "C" + cColumn.         
            IF kontpers NE "" THEN chWorkSheet:Range(cRange):Value = kontpers NO-ERROR.         
            ELSE chWorkSheet:Range(cRange):Value = marag.MARKAGARE NO-ERROR.
            iColumn = 45.
            cColumn = STRING(iColumn).
            cRange = "E" + cColumn.   
            chWorkSheet:Range(cRange):NumberFormat = "??/??" NO-ERROR.
            chWorkSheet:Range(cRange):Value = "1/1" NO-ERROR.               
         END.
         ELSE DO:              
            /*Bara en markägare till VP*/
            iColumn = 7.           
            cColumn = STRING(iColumn).
            cRange = "C" + cColumn.                 
            chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
            iColumn = 45.
            cColumn = STRING(iColumn).
            cRange = "E" + cColumn.   
            chWorkSheet:Range(cRange):NumberFormat = "??/??" NO-ERROR.
            chWorkSheet:Range(cRange):Value = adel NO-ERROR.               
         END.                
         iColumn = 9.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.         
         chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.   
         iColumn = 10.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
         
         iColumn = 10.
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         
         iColumn = 6.
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         iColumn = 9.
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.
         chWorkSheet:Range(cRange):Value = TODAY NO-ERROR.
         
         iColumn = 7.
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
      END.
                  
      IF  mall = 74  THEN DO:
         iColumn = 16.
         cColumn = STRING(iColumn).
         FOR EACH akekab WHERE akekab.MARKNR = emarkval.MARKNR AND akekab.BETECKNING = emarkval.BETECKNING AND akekab.FASTPRIS = FALSE :         
            {EXCELFEL.I}         
            cColumn = STRING(iColumn).            
            cRange = "C" + cColumn.
            IF akekab.BENAMNING NE "" THEN chWorkSheet:Range(cRange):Value = akekab.BENAMNING NO-ERROR.
            cRange = "E" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(akekab.L1,">>>9") NO-ERROR.   
            cRange = "F" + cColumn.
            IF akekab.L2 = 0 THEN chWorkSheet:Range(cRange):Value = STRING(1,">>>9") NO-ERROR.
            ELSE chWorkSheet:Range(cRange):Value = STRING(akekab.L2 + 1) NO-ERROR.
            iColumn = iColumn + 1.
            cColumn = STRING(iColumn).      
         END.         
         iColumn = 41.
         cColumn = STRING(iColumn).
         FOR EACH akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING   AND akevard.L5 = 1 AND akevard.STOLPNR NE 0  NO-LOCK:
            /*Mxx 1 = Kabelskåp  Mxx 2 = NS Åker Mxx 3 = NS Övrig*/            
            IF akevard.KRONOR > 0 THEN DO:                     
               cRange = "C" + cColumn.
               IF akevard.BENAMNING NE " "  THEN chWorkSheet:Range(cRange):Value = akevard.BENAMNING NO-ERROR.                                  
               IF akevard.kronor > 0 THEN DO:   
                  /*akevard.L4 = 1 kabelskåp       akevard.L4 = 0 station*/
                  IF akevard.L4 = 1  THEN DO:
                     cRange = "G" + cColumn.
                     IF INTEGER(akevard.kronor / kskapkr) = 0 THEN chWorkSheet:Range(cRange):Value = STRING(1,">>>9") NO-ERROR.
                     ELSE chWorkSheet:Range(cRange):Value = STRING(INTEGER(akevard.kronor / kskapkr),">>>9") NO-ERROR.
                     cRange = "M" + cColumn.
                     chWorkSheet:Range(cRange):Value = 1 NO-ERROR.
                  END.
                  ELSE DO:                  
                     IF (akevard.kronor / nstnovrigkr) LE 1.00 THEN DO:
                        cRange = "G" + cColumn.
                        chWorkSheet:Range(cRange):Value = STRING(1,">>>9") NO-ERROR.
                        cRange = "M" + cColumn.
                        chWorkSheet:Range(cRange):Value = 3 NO-ERROR.
                     END. 
                     ELSE DO:
                        cRange = "G" + cColumn.
                        chWorkSheet:Range(cRange):Value = STRING(INTEGER(akevard.kronor / nstnakerkr),">>>9") NO-ERROR.                     
                        cRange = "M" + cColumn.
                        chWorkSheet:Range(cRange):Value = 2 NO-ERROR.
                     END.                                    
                  END.                              
                  iColumn = iColumn + 1.
                  cColumn = STRING(iColumn).
               END.      
            END.                  
         END.      
         iColumn = 27.
         cColumn = STRING(iColumn).
         FOR EACH akevard WHERE akevard.MARKNR = emarkval.MARKNR AND akevard.BETECKNING = emarkval.BETECKNING
         AND akevard.L5 = 0 AND akevard.STOLPNR NE 0 :            
            {EXCELFEL.I}
            /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris*/
            IF akevard.FASTPRIS = TRUE AND akevard.KRONOR > 0 THEN iColumn = iColumn.
            ELSE DO:   
               cColumn = STRING(iColumn).
               cRange = "B" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.STOLPNR,">>9") NO-ERROR.
               cRange = "C" + cColumn.
               chWorkSheet:Range(cRange):Value = akevard.BENAMNING NO-ERROR.
               cRange = "E" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.L1,">>>9") NO-ERROR.   
               cRange = "F" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.L2,">>>9") NO-ERROR.
               cRange = "G" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akevard.L3,">>>9") NO-ERROR.   
               /*Mxx 1 = Åker  Mxx 2 = Bete Mxx 3 = Impediment*/
               cRange = "M" + cColumn.
               IF akevard.SORT = "Åker" THEN chWorkSheet:Range(cRange):Value = 1 NO-ERROR.
               IF akevard.SORT = "Betesmark" THEN chWorkSheet:Range(cRange):Value = 2 NO-ERROR.
               IF akevard.SORT = "Impediment" THEN chWorkSheet:Range(cRange):Value = 3 NO-ERROR.               
               iColumn = iColumn + 1.
               cColumn = STRING(iColumn).
            END.
         END.         
         FIND FIRST svard WHERE svard.MARKNR = emarkval.MARKNR AND svard.BETECKNING = emarkval.BETECKNING AND svard.FASTPRIS = TRUE AND svard.KRONOR > 0 NO-ERROR.
         IF AVAILABLE svard THEN DO:  
            iColumn = 36.
            cColumn = STRING(iColumn).                               
            cRange = "D" + cColumn.
            IF Guru.Konstanter:varforetypval[40] = 0 THEN DO:
               chWorkSheet:Range(cRange):Value = STRING((svard.KRONOR * 1.25),">>>>>9") NO-ERROR.
            END.
            ELSE chWorkSheet:Range(cRange):Value = STRING((svard.KRONOR ),">>>>>9") NO-ERROR.                           
         END.
         IF NOT AVAILABLE svard THEN DO:
            FIND CURRENT emarkval NO-LOCK NO-ERROR.
         END.
         /* måste få veta mer  och kolla minimiersättning. På VP blir ers mindre om man fyller i 25% tillägg på virkes värde vid låg summa Bestående skada*/
         EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
         EMPTY TEMP-TABLE extradatatemp NO-ERROR.
         CREATE inextradatatemp.          
         ASSIGN
         inextradatatemp.PROGRAM = "VARDFAST2"     
         inextradatatemp.HUVUDINT = markval.VARDNR
         inextradatatemp.HUVUDCH = markval.BETECKNING.
         RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
         FIND FIRST extradatatemp NO-LOCK NO-ERROR.
         IF AVAILABLE extradatatemp THEN DO:    
            IF  extradatatemp.SOKLOG[2] = TRUE THEN DO:
               /* Tillvaratagande*/
               iColumn = 36.
               cColumn = STRING(iColumn).
               cRange = "M" + cColumn.
               chWorkSheet:Range(cRange):Value = 2.
               cRange = "H" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(extradatatemp.SOKINT[2]).            
               FIND FIRST sumtemp WHERE sumtemp.BETECKNING = emarkval.BETECKNING NO-LOCK NO-ERROR.            
               IF AVAILABLE sumtemp THEN DO:
                  IF fdyr > 0 THEN DO:
                     IF sumtemp.ROT > 0 THEN DO:
                        cRange = "E" + cColumn.
                        chWorkSheet:Range(cRange):Value = STRING(sumtemp.ROT ).
                     END.
                  END.   
               END.      
            END.
            IF  extradatatemp.SOKLOG[1] = TRUE THEN DO:            
               /* Försäljning*/
               iColumn = 36.
               cColumn = STRING(iColumn).
               cRange = "M" + cColumn.
               chWorkSheet:Range(cRange):Value = 1.              
               cRange = "E" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(extradatatemp.SOKINT[1]).
               cRange = "H" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(extradatatemp.SOKINT[2]).               
            END.
         END.
      END.   
                  
   END.*/         
   
   /*inte ellevio*/
   IF mall = 97 OR mall = 98 OR mall = 27 OR mall = 28 OR mall = 29 THEN.   
   ELSE DO:         
      /*ÖVRIGA MALLAR utom VP2015*/
      /*FLIK FAKTA*/
           
      IF mall = 59  THEN chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.     
      ELSE IF mall = 107  THEN chWorkSheet = chExcelApplication:Sheets:Item(6) NO-ERROR.
      ELSE chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.
      
      /*basbeloppet får inte ändras*/
      
      iColumn = 7.
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.
      chWorkSheet:Range(cRange):Value = STRING(bbelopp * 100) NO-ERROR.
   
        
      IF mall = 59 OR mall = 107 THEN.
      ELSE DO:      
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(ipfakt) NO-ERROR.
         iColumn = 14.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(ivfaktaker) NO-ERROR.
      END.   
      IF mall = 107 THEN.
      ELSE DO:   
         iColumn = 17.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = pomr NO-ERROR.      
         iColumn = 22.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         
         chWorkSheet:Range(cRange):Value = STRING(pfakt) NO-ERROR.
         
         iColumn = 24.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         IF vskog = "N" THEN chWorkSheet:Range(cRange):Value = "Norrl" NO-ERROR.
         IF vskog = "S" THEN chWorkSheet:Range(cRange):Value = "Svea" NO-ERROR.
         IF vskog = "G" THEN chWorkSheet:Range(cRange):Value = "Göta" NO-ERROR.
      END.   
      IF  mall = 107  THEN.
      ELSE DO:     
       
         /*om nytt år men ingen ny mall ska föregående års oktober läggas ut*/
         iColumn = 32.
         cColumn = STRING(iColumn).
         cRange = "C" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(oktforekpi,">99.99") NO-ERROR.       
      END.
               
      RELEASE OBJECT chWorksheet NO-ERROR.
      /*FLIK SAMMANDRAG*/                                                                 
      IF mall = 59 OR mall = 107  THEN chWorkSheet = chExcelApplication:Sheets:Item(1) NO-ERROR.      
      /*ELSE IF mall = 72 THEN  chWorkSheet = chExcelApplication:Sheets:Item(1) NO-ERROR.*/
      ELSE chWorkSheet = chExcelApplication:Sheets:Item(2) NO-ERROR.
      {EXCELFEL.I}
      FIND FIRST emarkval NO-LOCK NO-ERROR.  
      FIND FIRST marag NO-LOCK NO-ERROR. 
      
      IF mall = 59    THEN DO:
         iColumn = 5.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = fkommun NO-ERROR.
         iColumn = 6.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.
         iColumn = 8.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         IF allamark = "alla" THEN DO:      
            IF kontpers NE "" THEN DO:
               chWorkSheet:Range(cRange):Value = kontpers NO-ERROR.
            END.
            ELSE DO:
               chWorkSheet:Range(cRange):Value = marag.MARKAGARE NO-ERROR.
            END.
         END.
         ELSE DO:      
            /*Bara en markägare till VP*/                       
            FIND FIRST emarkval NO-ERROR.
            chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
            iColumn = 13.
            cColumn = STRING(iColumn).                  
            cRange = "B" + cColumn.   
            chWorkSheet:Range(cRange):NumberFormat = "??/??" NO-ERROR.
            chWorkSheet:Range(cRange):Value = adel NO-ERROR.
         END.
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.   
         chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.   
         iColumn = 12.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
         
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         
         iColumn = 7.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         iColumn = 12.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = TODAY NO-ERROR.
         
         iColumn = 10.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
            
      END.
      ELSE IF mall = 107    THEN DO:
         
         IF vardartal > 0 THEN DO:
            iColumn = 3.
            cColumn = STRING(iColumn).
            cRange = "H" + cColumn.
            chWorkSheet:Range(cRange):Value = vardartal NO-ERROR.
         END.
         iColumn = 7.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = fkommun NO-ERROR.
         iColumn = 8.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.
         iColumn = 9.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         IF allamark = "alla" THEN DO:      
            IF kontpers NE "" THEN DO:
               chWorkSheet:Range(cRange):Value = kontpers NO-ERROR.
            END.
            ELSE DO:
               chWorkSheet:Range(cRange):Value = marag.MARKAGARE NO-ERROR.
            END.
         END.
         ELSE DO:      
            /*Bara en markägare till VP*/                       
            FIND FIRST emarkval NO-ERROR.
            chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
            iColumn = 9.
            cColumn = STRING(iColumn).                  
            cRange = "E" + cColumn.   
            chWorkSheet:Range(cRange):NumberFormat = "??/??" NO-ERROR.
            chWorkSheet:Range(cRange):Value = adel NO-ERROR.
         END.
         iColumn = 10.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.   
         chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.   
         iColumn = 11.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
         
         iColumn = 12.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         
         iColumn = 13.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         iColumn = 13.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = TODAY NO-ERROR.
         
         iColumn = 14.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
            
      END.
      
      ELSE DO:
         /*ÖVRIGA MALLAR*/   
         iColumn = 6 - extrarad2.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = fkommun NO-ERROR.
         iColumn = 7 - extrarad2.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.             
         IF  mall = 59  THEN.  /*26 bytt 20110201*/
         ELSE DO:
            IF Guru.Konstanter:globforetag = "PICA"  OR Guru.Konstanter:globforetag = "SWEO" OR Guru.Konstanter:globforetag = "tect" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "JSBF"  OR Guru.Konstanter:globforetag = "ATS"  OR Guru.Konstanter:globforetag = "SKEL"  OR Guru.Konstanter:globforetag = "LULE" THEN DO:
                  
               cRange = "F" + cColumn.
               IF fkommun = "Haparanda" OR fkommun = "Kalix" OR fkommun = "Överkalix" OR fkommun =  "Övertorneå"   THEN DO:    
                  chWorkSheet:Range(cRange):Value = "Näsbyn 4:15              " NO-ERROR.        
               END.
               IF fkommun = "Gällivare" OR fkommun = "Jokkmokk" OR fkommun = "Kiruna" OR fkommun =  "Pajala"   THEN DO:    
                  chWorkSheet:Range(cRange):Value = "Videt 7                   " NO-ERROR.
               END.        
               IF fkommun = "Arvidsjaur" OR fkommun = "Arjeplog" OR fkommun = "Boden" OR fkommun =  "Piteå" OR fkommun =  "Älvsbyn"  THEN DO:    
                  chWorkSheet:Range(cRange):Value = "Arvidsjaur 6:20           " NO-ERROR.
               END.
               IF fvaker = "Västerbottens län" OR fvaker = "Västernorrlands län" THEN DO:
                  chWorkSheet:Range(cRange):Value = "Harrselsfors 1:22          " NO-ERROR.         
               END.                          
            END.         
            IF Guru.Konstanter:globforetag = "VAST"  OR Guru.Konstanter:globforetag = "Celpa" THEN DO:
              cRange = "F" + cColumn.
              IF omravd = 1 OR omravd = 2  THEN DO:    
                 chWorkSheet:Range(cRange):Value = "Begonian 10                  " NO-ERROR.              
              END.
              IF omravd = 3 THEN DO:
                 chWorkSheet:Range(cRange):Value = "Nyköpingsbruk 6              " NO-ERROR.                                                      
              END.
            END.
            IF Guru.Konstanter:globforetag = "tect" OR Guru.Konstanter:globforetag = "celpa" THEN DO:
               cRange = "F" + cColumn.
               chWorkSheet:Range(cRange):Value = "Harrselefors 1:22        " NO-ERROR.
            END.
         END.
         iColumn = 8 - extrarad2.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         
         IF allamark = "alla" THEN DO:      
            IF kontpers NE "" THEN  chWorkSheet:Range(cRange):Value = kontpers NO-ERROR.         
            ELSE chWorkSheet:Range(cRange):Value = marag.MARKAGARE NO-ERROR.               
         END.
         ELSE DO:      
            /*Bara en markägare till VP*/            
            FIND FIRST emarkval NO-ERROR.
            chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
            IF  mall = 59 THEN DO:
               iColumn = 7 .
               cColumn = STRING(iColumn).
               cRange = "E" + cColumn.   
               chWorkSheet:Range(cRange):NumberFormat = "??/??" NO-ERROR.
               chWorkSheet:Range(cRange):Value = adel NO-ERROR.
            END.   
                       
         END.
      
         {EXCELFEL.I}      
                
         IF mall = 59 THEN.                          
         ELSE DO:
            iColumn = 9 - extrarad2.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.
            IF Guru.Konstanter:globforetag = "TECT" OR Guru.Konstanter:globforetag = "PICA"  OR Guru.Konstanter:globforetag = "SWEO" OR Guru.Konstanter:globforetag = "GREL" OR Guru.Konstanter:globforetag = "REJI" OR Guru.Konstanter:globforetag = "ELPC" OR Guru.Konstanter:globforetag = "ETSA"
            OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "JSBF"  OR Guru.Konstanter:globforetag = "ATS"  OR Guru.Konstanter:globforetag = "SKEL"  OR Guru.Konstanter:globforetag = "WSP" OR Guru.Konstanter:globforetag = "PFBK" OR Guru.Konstanter:globforetag = "KEWA" OR Guru.Konstanter:globforetag = "LULE" 
            OR Guru.Konstanter:globforetag = "SSEL" OR Guru.Konstanter:globforetag = "GULL" OR Guru.Konstanter:globforetag = "SVKK"  THEN DO:
               IF AVAILABLE marbuff THEN DO:
                  IF marbuff.PNR2 BEGINS "0000" THEN chWorkSheet:Range(cRange):Value = STRING(marbuff.PERSONNUMMER,"999999-9999") NO-ERROR.
                  ELSE DO:
                     ASSIGN          
                     chWorkSheet:Range(cRange):Value = STRING(marbuff.PERSONNUMMER,"999999-9999") + " " + STRING(marbuff.PNR2,"999999-9999") NO-ERROR.      
                  END.            
               END.
               ELSE DO:
                  IF marag.PNR2 BEGINS "0000" THEN chWorkSheet:Range(cRange):Value = STRING(marag.PERSONNUMMER,"999999-9999") NO-ERROR.
                  ELSE DO:
                     ASSIGN          
                     chWorkSheet:Range(cRange):Value = STRING(marag.PERSONNUMMER,"999999-9999") + " " + STRING(marag.PNR2,"999999-9999") NO-ERROR.      
                  END.      
               END.
            END.
            ELSE IF allpersnr NE "" THEN DO:
               chWorkSheet:Range(cRange):Value = allpersnr NO-ERROR.
            END.
            ELSE DO:   
               IF marag.PNR2 BEGINS "0000" THEN chWorkSheet:Range(cRange):Value = STRING(marag.PERSONNUMMER,"999999-9999") NO-ERROR.
               ELSE DO:
                  ASSIGN          
                  chWorkSheet:Range(cRange):Value = STRING(marag.PERSONNUMMER,"999999-9999") + " " + STRING(marag.PNR2,"999999-9999") NO-ERROR.      
               END.      
            END.
         END.
         
         {EXCELFEL.I}
         IF mall = 59  THEN DO:
          
            iColumn = 9 - extrarad2.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.   
            chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.   
            iColumn = 10 - extrarad2.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.
            chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
         END.
         ELSE DO:
            iColumn = 10 - extrarad.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.            
            chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.
            
            iColumn = 11 - extrarad.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.
            chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
         END.
         
         iColumn = 11 - extrarad.
         cColumn = STRING(iColumn).
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = vman NO-ERROR.
         
         iColumn = 12 - extrarad.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = TODAY NO-ERROR.
         
         iColumn = 13 - extrarad.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
      END.


      revkost = 0.
      revtext = "".
      {EXCELFEL.I}
      EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "REVAVTAL"                   
      inextradatatemp.HUVUDINT = marag.VARDNR
      inextradatatemp.HUVUDCH = marag.BETECKNING.                          
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FOR EACH extradatatemp :         
         IF extradatatemp.SOKINT[1] = 1  THEN DO:            
            revtext = STRING(extradatatemp.SOKDEC[2]) + " m Zon1".       
         END.
         IF extradatatemp.SOKINT[1] = 2  THEN DO:          
            IF revtext = "" THEN revtext = revtext + STRING(extradatatemp.SOKDEC[2]) + " m Zon2". 
            ELSE revtext = revtext + "+ " + STRING(extradatatemp.SOKDEC[2]) + " m Zon2".       
         END.         
         revkost = revkost + extradatatemp.SOKDEC[3].
      END.
      /*EXPROP INGÅR I M-PRISET alltså samma för IF Guru.Konstanter:varforetypval[40] = 1 och IF Guru.Konstanter:varforetypval[40] =0. måste räknas ner till gamla Vp .*/
       revkost = revkost / 1.25.
      /*iColumn = 21 - extrarad. ÄNDRAT 20140411*/
      IF Guru.Konstanter:globforetag = "krin" THEN iColumn = 20. 
      ELSE iColumn = 22 - extrarad.
      cColumn = STRING(iColumn).
      cRange = "H" + cColumn.
      
      IF revkost > 0 THEN DO:
         chWorkSheet:Range(cRange):Value = STRING(revkost,">>999") NO-ERROR.  
      END.
      /*iColumn = 21 - extrarad.*/
      cColumn = STRING(iColumn).
      cRange = "B" + cColumn.
      IF revtext NE ""  THEN DO:
         chWorkSheet:Range(cRange):Value = revtext NO-ERROR.  
      END.
      IF revkost > 0 THEN DO:
         RUN revadmhmt_UI IN skprotapph (INPUT vardartal, OUTPUT azon1, OUTPUT azon2, OUTPUT afastb).
         IF Guru.Konstanter:globforetag = "krin" THEN iColumn = 21.
         ELSE iColumn = 24 - extrarad.
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.   
         chWorkSheet:Range(cRange):Value = "Fast belopp väghållare" NO-ERROR.           
         cColumn = STRING(iColumn).
         cRange = "H" + cColumn.   
         chWorkSheet:Range(cRange):Value = afastb NO-ERROR.
         /*EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
         EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
         CREATE inextradatatemp.          
         ASSIGN
         inextradatatemp.PROGRAM = "REVADM"                   
         inextradatatemp.HUVUDINT = 1                    
         inextradatatemp.HUVUDCH = "1".                          
         RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
         FIND FIRST extradatatemp  NO-LOCK NO-ERROR.
         IF AVAILABLE extradatatemp THEN DO: 
            IF Guru.Konstanter:globforetag = "krin" THEN iColumn = 21.
            ELSE iColumn = 24 - extrarad.
            cColumn = STRING(iColumn).
            cRange = "B" + cColumn.   
            chWorkSheet:Range(cRange):Value = "Fast belopp väghållare" NO-ERROR.           
            cColumn = STRING(iColumn).
            cRange = "H" + cColumn.   
            chWorkSheet:Range(cRange):Value = ( extradatatemp.SOKDEC[1] ) NO-ERROR.        
         END.*/
      END.
      ELSE DO:
         
         /*kabelskåp på övrigt*/
         IF mall = 107 THEN DO:
            iColumn =  25.
             
            FOR EACH akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING   AND akevard.L5 = 1 AND akevard.STOLPNR NE 0  NO-LOCK:
               /*Mxx 1 = Kabelskåp  Mxx 2 = NS Åker Mxx 3 = NS Övrig*/
               IF akevard.L4 = 1 THEN DO:
                  IF  akevard.L3 = 24 THEN DO:
                      /*KABELSKÅP*/
                      antskap = antskap + akevard.L1. 
                  END.
                  IF  akevard.L3 = 25 THEN DO:
                      /*OPTOBRUNN*/
                      antopto = antopto + akevard.L1. 
                  END.
               END.
               ELSE DO:  
                  IF  akevard.L3 = 26 THEN DO:
                     /*TRANSFORMATORSTATION*/
                     antstn = antstn + akevard.L1. 
                  END.
               END.           
            END.             
            IF antstn > 0 THEN DO:
               iColumn = 24.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(antstn) NO-ERROR.

            END.
            IF antskap > 0 THEN DO:
               iColumn = 25.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(antskap) NO-ERROR.
            END.
            IF antopto > 0 THEN DO:
               iColumn = 26.
               cColumn = STRING(iColumn).
               cRange = "D" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(antopto) NO-ERROR.
            END.              
         END.
         ELSE DO:                           
            IF  mall = 59 THEN iColumn = 22 - extrarad.  /*20110201*/            
            
            ELSE iColumn = 22 - extrarad.
            cColumn = STRING(iColumn).
            cRange = "H" + cColumn.
            FIND FIRST sumtemp NO-LOCK NO-ERROR.
            IF AVAILABLE sumtemp THEN DO:
               IF Guru.Konstanter:globforetag = "KRIN" THEN DO:
                  /*exprop på kabelskåk slås på senare*/
                  chWorkSheet:Range(cRange):Value = STRING((sumtemp.TSF - sumtemp.TSB + sumtemp.TSKF - sumtemp.TSKB),">>999") NO-ERROR.
               END.
               ELSE IF Guru.Konstanter:varforetypval[40] = 0 THEN DO:
                  chWorkSheet:Range(cRange):Value = STRING((1.25 *(sumtemp.TSF - sumtemp.TSB + sumtemp.TSKF - sumtemp.TSKB)),">>999") NO-ERROR.
               END.                              
               ELSE chWorkSheet:Range(cRange):Value = STRING((sumtemp.TSF - sumtemp.TSB + sumtemp.TSKF - sumtemp.TSKB),">>999") NO-ERROR.
            END.
            IF Guru.Konstanter:globforetag = "elpa"  THEN DO:      
               IF sumtemp.PASLAG > 0 THEN DO:      
                  iColumn = 30 - extrarad.
                  cColumn = STRING(iColumn).
                  cRange = "C" + cColumn.
                  chWorkSheet:Range(cRange):Value = "25 % påslag enligt förändring expropriationslag 1/8 2010" NO-ERROR.
                  cRange = "H" + cColumn.
                  FIND FIRST sumtemp NO-LOCK NO-ERROR.
                  IF AVAILABLE sumtemp THEN DO:           
                     chWorkSheet:Range(cRange):Value = STRING((sumtemp.PASLAG),">>999") NO-ERROR.
                  END.
               END.
            END.
         END.   
         IF Guru.Konstanter:globforetag = "PICA"  OR Guru.Konstanter:globforetag = "SWEO" OR Guru.Konstanter:globforetag = "tect" OR Guru.Konstanter:globforetag = "REJI" OR Guru.Konstanter:globforetag = "ELPC" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "JSBF" 
          OR Guru.Konstanter:globforetag = "SKEL" OR Guru.Konstanter:globforetag = "WSP" OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SSEL" THEN DO:
            /*storskog*/
            /*Magnus Myren förbjuder storskog på mallen 2013/10/21*/      
            /*FIND FIRST svard WHERE svard.MARKTYP = "Norrlands inland" OR svard.MARKTYP = "Norrlands kustland" OR svard.MARKTYP = "Svealand" OR svard.MARKTYP = "Götaland" NO-LOCK NO-ERROR.
            IF NOT AVAILABLE svard THEN DO:
               /*dummy för excelfel*/
              FIND FIRST svard NO-LOCK NO-ERROR.
              IF NOT AVAILABLE svard  THEN DO:
                 FIND FIRST sumtemp NO-LOCK NO-ERROR.
              END.
            END.
            ELSE DO:
              
               iColumn = 18 - extrarad.
               cColumn = STRING(iColumn).
               cRange = "B" + cColumn.
               chWorkSheet:Range(cRange):Value = "Storskogsbruksavtalet" NO-ERROR.                               
               
               iColumn = 27 - extrarad.
                        
               cColumn = STRING(iColumn).
               cRange = "H" + cColumn.
               FIND FIRST sumtemp NO-LOCK NO-ERROR.
               IF AVAILABLE sumtemp THEN DO:                               
                  IF (sumtemp.TILLAGG - ( sumtemp.ovrig - sumtemp.SMF - sumtemp.JKF - sumtemp.OMF)) > 0 THEN
                  chWorkSheet:Range(cRange):Value = STRING((sumtemp.TILLAGG),">>999") NO-ERROR.
                  /*måste lägga ut en tilläggspost för att få med  mellanskillnaden mellan tillägg för vanligt avtal och storskosavtalen
                  tex 2500 - 15% */
                  /*chWorkSheet:Range(cRange):Value = STRING((sumtemp.ovrig - sumtemp.TILLAGG),">>999") NO-ERROR.*/
               END.      
            END.*/
         END.
         
      END.
      {EXCELFEL.I}      
         /*kabelskåp på övrigt*/     
      
      IF  mall = 59 THEN iColumn = 21. 
      ELSE iColumn = 22 - extrarad.
      cColumn = STRING(iColumn).
     
      cRange = "B" + cColumn.
      ktext = "".
      
            FOR EACH akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING
      AND akevard.L5 = 1 AND akevard.STOLPNR NE 0  NO-LOCK:
         IF akevard.BENAMNING NE " "  THEN ktext = ktext + " " + TRIM(akevard.BENAMNING).
      END.
      IF ktext = " " THEN DO:
         FIND FIRST akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING
         AND akevard.L5 = 1 AND akevard.L4 = 1 AND akevard.STOLPNR NE 0   NO-LOCK NO-ERROR.
         IF AVAILABLE akevard THEN DO:
             ktext = "Kabelskåp".
         END.
         FIND FIRST akevard WHERE akevard.MARKNR = marag.MARKNR AND akevard.BETECKNING = marag.BETECKNING
         AND akevard.L5 = 1 AND akevard.L4 = 0 AND akevard.STOLPNR NE 0   NO-LOCK NO-ERROR.
         IF AVAILABLE akevard THEN DO:
             ktext = ktext + " Station".
         END.
      END.    
      IF  mall = 59 THEN DO:         
         /*ej skrivbart fält hos kraftringen*/
        
         IF ktext NE " " THEN chWorkSheet:Range(cRange):Value = ktext NO-ERROR.
      END. 
      ELSE DO: 
         IF ktext NE " " THEN chWorkSheet:Range(cRange):Value = ktext NO-ERROR.
      END.   
      
      
      FIND FIRST sumtemp NO-LOCK NO-ERROR.
      IF AVAILABLE sumtemp THEN DO:
         IF sumtemp.ROT > 0 THEN DO:
            /*FÖRDYRAD AVVERKNING*/            
            IF  mall = 59   THEN iColumn = 31 - extrarad.  /*20100201*/            
            ELSE iColumn = 29 - extrarad.
            cColumn = STRING(iColumn).
            cRange = "H" + cColumn.      
            chWorkSheet:Range(cRange):Value = STRING((sumtemp.ROT),">>>>99") NO-ERROR.
         END.
      END.
      RELEASE OBJECT chWorksheet NO-ERROR.
      /*FLIK ÅKER*/                 
      IF mall = 59 OR mall = 107  THEN chWorkSheet = chExcelApplication:Sheets:Item(2) NO-ERROR.           
      ELSE chWorkSheet = chExcelApplication:Sheets:Item(3) NO-ERROR.
     
      {EXCELFEL.I}
      FIND FIRST emarkval NO-LOCK NO-ERROR.  
      FIND FIRST marag NO-LOCK NO-ERROR.  
      
      iColumn = 12.
      cColumn = STRING(iColumn).
      FOR EACH akevard WHERE akevard.MARKNR = emarkval.MARKNR AND akevard.BETECKNING = emarkval.BETECKNING
      AND akevard.L5 = 0 AND akevard.STOLPNR NE 0 :
         IF AVAILABLE vilkafliktmp THEN DO:
            vilkafliktmp.AKER = TRUE.
         END.   
         {EXCELFEL.I}
         /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris*/
         IF akevard.FASTPRIS = TRUE AND akevard.KRONOR > 0 THEN iColumn = iColumn.
         ELSE DO:   
            cColumn = STRING(iColumn).
            cRange = "A" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(akevard.STOLPNR,">>9") NO-ERROR.
            cRange = "B" + cColumn.
            chWorkSheet:Range(cRange):Value = akevard.BENAMNING NO-ERROR.
            cRange = "E" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(akevard.L1,">>>9") NO-ERROR.   
            cRange = "G" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(akevard.L2,">>>9") NO-ERROR.
             
            cRange = "I" + cColumn.
            IF mall = 59 THEN DO:
               IF akevard.L3 GE 0 AND akevard.L3 < 1 THEN chWorkSheet:Range(cRange):Value = "0-1 m" NO-ERROR.
               IF akevard.L3 GE 1 AND akevard.L3 < 2 THEN chWorkSheet:Range(cRange):Value = "1-2 m" NO-ERROR.
               IF akevard.L3 GE 2 AND akevard.L3 < 3 THEN chWorkSheet:Range(cRange):Value = "2-3 m" NO-ERROR.
               IF akevard.L3 GE 3 AND akevard.L3 < 15 THEN chWorkSheet:Range(cRange):Value = "3-15 m" NO-ERROR.
               IF akevard.L3 GE 15  THEN chWorkSheet:Range(cRange):Value = STRING(">15 m",">>>9") NO-ERROR.
            END.   
            ELSE chWorkSheet:Range(cRange):Value = STRING(akevard.L3,">>>9") NO-ERROR.
            IF mall = 59 THEN cRange = "K" + cColumn.
            ELSE cRange = "J" + cColumn.   
            IF akevard.SORT = "Åker" THEN DO:               
               chWorkSheet:Range(cRange):Value = "Å" NO-ERROR.
            END.
            IF akevard.SORT = "Betesmark" THEN DO:               
               chWorkSheet:Range(cRange):Value = "B" NO-ERROR.
            END.
            IF akevard.SORT = "Impediment" THEN DO:               
               chWorkSheet:Range(cRange):Value = "I" NO-ERROR.
            END.
            IF mall = 59 THEN cRange = "M" + cColumn.
            ELSE cRange = "L" + cColumn.          
            IF akevard.KR > 0 THEN DO:               
               chWorkSheet:Range(cRange):Value = "N" NO-ERROR.
            END.
            ELSE DO:               
               chWorkSheet:Range(cRange):Value = "B" NO-ERROR.
            END.
            iColumn = iColumn + 1.
            cColumn = STRING(iColumn).
         END.
      END.
      RELEASE OBJECT chWorksheet NO-ERROR.
      /*FLIK SKOG*/
                        
      IF mall = 59 OR mall = 107  THEN chWorkSheet = chExcelApplication:Sheets:Item(3) NO-ERROR.           
      ELSE chWorkSheet = chExcelApplication:Sheets:Item(4).
      
      iColumn = 14.
      cColumn = STRING(iColumn).
      
      FOR EACH svard WHERE svard.MARKNR = emarkval.MARKNR AND svard.BETECKNING = emarkval.BETECKNING BY svard.BESTAND:
         IF AVAILABLE vilkafliktmp THEN DO:
            vilkafliktmp.SKOG = TRUE.
         END.
         {EXCELFEL.I}
         /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris
         tectel har  50 års skognorm och lägger in priset fast  som ska med*/
         skogfast = FALSE.
         IF Guru.Konstanter:globforetag = "VAST" OR Guru.Konstanter:globforetag = "VELD" OR Guru.Konstanter:globforetag = "CELPA"  THEN DO:              
            /*ändrat 20130916  lägger man in 0 kronor ska de t ej komma ut*/
            IF svard.FASTPRIS = TRUE  THEN skogfast = TRUE.
         END.
        
         IF Guru.Konstanter:globforetag = "TECT" OR Guru.Konstanter:globforetag = "PICA"  OR Guru.Konstanter:globforetag = "SWEO" OR Guru.Konstanter:globforetag = "REJI" OR Guru.Konstanter:globforetag = "ELPC" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "JSBF" 
         OR Guru.Konstanter:globforetag = "ATS" OR Guru.Konstanter:globforetag = "SKEL"  OR Guru.Konstanter:globforetag = "WSP" OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SSEL"  THEN DO:  
            
            IF svard.FASTPRIS = TRUE AND svard.KRONOR > 0 THEN DO: 
               skogfast = TRUE.
               cColumn = STRING(iColumn).
               cRange = "A" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(svard.BESTAND,">>9") NO-ERROR.
               cRange = "L" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING((svard.KRONOR / 1.25),">>>>>9") NO-ERROR.         
               iColumn = iColumn + 1.
               cColumn = STRING(iColumn).                  
            END.
         END.
         
         IF skogfast = TRUE THEN skogfast = FALSE.
         ELSE DO:
            /*KRIN Kraftringen har kvar förenklad skogsnorm tills vidare 20150908*/
            cColumn = STRING(iColumn).
            cRange = "A" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(svard.BESTAND,">>9") NO-ERROR.
            cRange = "B" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.
            cRange = "C" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR.
            cRange = "E" + cColumn.
            chWorkSheet:Range(cRange):Value = svard.MARKTYP NO-ERROR.
            
            cRange = "F" + cColumn.
            IF svard.BESTTYP = "1" THEN chWorkSheet:Range(cRange):Value = "plantskog" NO-ERROR.
            IF svard.BESTTYP = "2" THEN chWorkSheet:Range(cRange):Value = "röjningsskog" NO-ERROR.
            IF svard.BESTTYP = "3" THEN chWorkSheet:Range(cRange):Value = "massavedskog" NO-ERROR.
            IF svard.BESTTYP = "4" THEN chWorkSheet:Range(cRange):Value = "yngre_timmerskog" NO-ERROR.
            IF svard.BESTTYP = "5A" THEN chWorkSheet:Range(cRange):Value = "äldre_timmerskog" NO-ERROR.
            IF svard.BESTTYP = "5B" THEN chWorkSheet:Range(cRange):Value = "kalmark" NO-ERROR.           
            cRange = "G" + cColumn.
            chWorkSheet:Range(cRange):Value = svard.SLENH.
            cRange = "H" + cColumn.         
            chWorkSheet:Range(cRange):Value = INTEGER(SUBSTRING(svard.BARRLOV,1,INDEX(svard.BARRLOV,".",1) - 1)) NO-ERROR.
            cRange = "I" + cColumn.         
            chWorkSheet:Range(cRange):Value = INTEGER(SUBSTRING(svard.BARRLOV,INDEX(svard.BARRLOV,".",1) + 1)) NO-ERROR.
            cRange = "J" + cColumn.
            IF svard.PROCENT < 100 AND svard.PROCENT > 0 THEN chWorkSheet:Range(cRange):Value = STRING(svard.PROCENT) NO-ERROR.
            ELSE chWorkSheet:Range(cRange):Value = STRING(100) NO-ERROR.
                  
            iColumn = iColumn + 1.
            cColumn = STRING(iColumn).
                     
            /*/*Magnus Myren förbjuder storskog på mallen 2013/10/21
            Förenklad skogsnorm används ej heller !!*/
            IF svard.MARKTYP = "Norrlands inland" OR svard.MARKTYP = "Norrlands kustland" OR svard.MARKTYP = "Svealand" OR svard.MARKTYP = "Götaland" THEN.
            ELSE DO:      
               cColumn = STRING(iColumn).
               cRange = "A" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(svard.BESTAND,">>9") NO-ERROR.
               cRange = "B" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(svard.LANGD) NO-ERROR.
               cRange = "C" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(svard.BREDD) NO-ERROR.
               cRange = "E" + cColumn.
               chWorkSheet:Range(cRange):Value = svard.MARKTYP NO-ERROR.
               IF svard.MARKTYP = "Norrlands inland" OR svard.MARKTYP = "Norrlands kustland" OR svard.MARKTYP = "Svealand" OR svard.MARKTYP = "Götaland" THEN DO:
                  /*Magnus Myren förbjuder storskog på mallen 2013/10/21*/
                  cRange = "F" + cColumn.
                  chWorkSheet:Range(cRange):Value = "Storskog" NO-ERROR.
               END.   
               ELSE DO:
                  cRange = "F" + cColumn.
                  IF svard.BESTTYP = "1" THEN chWorkSheet:Range(cRange):Value = "plantskog" NO-ERROR.
                  IF svard.BESTTYP = "2" THEN chWorkSheet:Range(cRange):Value = "röjningsskog" NO-ERROR.
                  IF svard.BESTTYP = "3" THEN chWorkSheet:Range(cRange):Value = "massavedskog" NO-ERROR.
                  IF svard.BESTTYP = "4" THEN chWorkSheet:Range(cRange):Value = "yngre_timmerskog" NO-ERROR.
                  IF svard.BESTTYP = "5A" THEN chWorkSheet:Range(cRange):Value = "äldre_timmerskog" NO-ERROR.
                  IF svard.BESTTYP = "5B" THEN chWorkSheet:Range(cRange):Value = "kalmark" NO-ERROR.           
                  cRange = "G" + cColumn.
                  chWorkSheet:Range(cRange):Value = svard.SLENH.
                  cRange = "H" + cColumn.         
                  chWorkSheet:Range(cRange):Value = INTEGER(SUBSTRING(svard.BARRLOV,1,INDEX(svard.BARRLOV,".",1) - 1)) NO-ERROR.
                  cRange = "I" + cColumn.         
                  chWorkSheet:Range(cRange):Value = INTEGER(SUBSTRING(svard.BARRLOV,INDEX(svard.BARRLOV,".",1) + 1)) NO-ERROR.
                  cRange = "J" + cColumn.
                  IF svard.PROCENT < 100 AND svard.PROCENT > 0 THEN chWorkSheet:Range(cRange):Value = STRING(svard.PROCENT) NO-ERROR.
                  ELSE chWorkSheet:Range(cRange):Value = STRING(100) NO-ERROR.
               END.      
               /*IF svard.MARKTYP = "Norrlands inland" OR svard.MARKTYP = "Norrlands kustland" OR svard.MARKTYP = "Svealand" OR svard.MARKTYP = "Götaland" THEN DO:
                  /*Magnus Myren förbjuder storskog på mallen 2013/10/21*/         
                  /*storskog*/
                  cRange = "K" + cColumn.         
                  chWorkSheet:Range(cRange):Value = STRING((svard.KR-HA / 1.25 ),">>>>9") NO-ERROR.         
                  cRange = "L" + cColumn.         
                  chWorkSheet:Range(cRange):Value = STRING((svard.KRONOR / 1.25 ),">>>>>9") NO-ERROR.         
               END.*/
                  
               iColumn = iColumn + 1.
               cColumn = STRING(iColumn).
            END.*/                     
         END.
      
         
      END.
      RELEASE OBJECT chWorksheet NO-ERROR.
      {EXCELFEL.I}
      /*FLIK KABEL I MARK*/
                  
      IF mall = 59  THEN chWorkSheet = chExcelApplication:Sheets:Item(4) NO-ERROR.      
      ELSE IF mall = 107 THEN  chWorkSheet = chExcelApplication:Sheets:Item(5) NO-ERROR.  
      ELSE chWorkSheet = chExcelApplication:Sheets:Item(6)  NO-ERROR.
      
      iColumn = 12.
      cColumn = STRING(iColumn).
      FOR EACH akekab WHERE akekab.MARKNR = emarkval.MARKNR AND akekab.BETECKNING = emarkval.BETECKNING:
         IF AVAILABLE vilkafliktmp THEN DO:
            vilkafliktmp.MARK = TRUE.
         END.
         {EXCELFEL.I}
         
         /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris*/
         IF akekab.FASTPRIS = TRUE AND akekab.KRONOR GE 0 THEN DO:
            IF Guru.Konstanter:globforetag = "PICA"  OR Guru.Konstanter:globforetag = "SWEO" OR Guru.Konstanter:globforetag = "tect" OR Guru.Konstanter:globforetag = "REJI" OR Guru.Konstanter:globforetag = "ELPC" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "JSBF" 
            OR Guru.Konstanter:globforetag = "ATS"  OR Guru.Konstanter:globforetag = "SKEL"  OR Guru.Konstanter:globforetag = "WSP" OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SSEL"  THEN DO:           
               cColumn = STRING(iColumn).      
               cRange = "B" + cColumn.
               IF akekab.BENAMNING NE "" THEN chWorkSheet:Range(cRange):Value = akekab.BENAMNING NO-ERROR.
               cRange = "H" + cColumn.
               chWorkSheet:Range(cRange):Value = STRING(akekab.KRONOR,">>>>9") NO-ERROR.   
               iColumn = iColumn + 1.
            END.
         END.
         ELSE DO:
            cColumn = STRING(iColumn).      
            cRange = "B" + cColumn.
            IF akekab.BENAMNING NE "" THEN chWorkSheet:Range(cRange):Value = akekab.BENAMNING NO-ERROR.
            cRange = "D" + cColumn.
            chWorkSheet:Range(cRange):Value = STRING(akekab.L1,">>>9") NO-ERROR.   
            cRange = "E" + cColumn.
            IF akekab.L2 = 0 THEN chWorkSheet:Range(cRange):Value = STRING(1,">>>9") NO-ERROR.
            chWorkSheet:Range(cRange):Value = STRING(akekab.L2 + 1) NO-ERROR.
            iColumn = iColumn + 1.
            cColumn = STRING(iColumn).
         END.
      END.
     
      
   END.    
   IF spmall = TRUE OR skrivutmall = TRUE  THEN DO:
            
      chExcelApplication:displayalerts = FALSE.      
      chWorkbook:SaveAs(kommando,,,,,,,,,).        
      chExcelApplication:displayalerts = TRUE.
      IF skrivutmall = TRUE THEN DO:
         DEBUGGER:SET-BREAK().
         IF AVAILABLE vilkafliktmp THEN DO:            
            IF vilkafliktmp.SAMMAN = TRUE THEN DO:
               /*IF  mall = 74  THEN chWorkSheet = chExcelApplication:Sheets:ITEM(1) NO-ERROR.  */               
               chWorkSheet = chExcelApplication:Sheets:ITEM(2) NO-ERROR.
               chWorkSheet:SELECT NO-ERROR.     
               RUN screenexcel_UI.
               RUN slutmedprintmark_UI (INPUT 2).
               RELEASE OBJECT chWorksheet NO-ERROR.
            END.
            IF vilkafliktmp.AKER = TRUE THEN DO:               
               chWorkSheet = chExcelApplication:Sheets:ITEM(3) NO-ERROR.
               chWorkSheet:SELECT NO-ERROR.     
               RUN screenexcel_UI.
               RUN slutmedprintmark_UI (INPUT 2).
               RELEASE OBJECT chWorksheet NO-ERROR.
            END.
            IF vilkafliktmp.SKOG = TRUE THEN DO:               
               chWorkSheet = chExcelApplication:Sheets:ITEM(4) NO-ERROR.
               chWorkSheet:SELECT NO-ERROR.     
               RUN screenexcel_UI.
               RUN slutmedprintmark_UI (INPUT 2).
               RELEASE OBJECT chWorksheet NO-ERROR.
            END.
            IF vilkafliktmp.MARK = TRUE THEN DO:               
               chWorkSheet = chExcelApplication:Sheets:ITEM(6) NO-ERROR.
               chWorkSheet:SELECT NO-ERROR.     
               RUN screenexcel_UI.
               RUN slutmedprintmark_UI (INPUT 2).
               RELEASE OBJECT chWorksheet NO-ERROR.
            END.
         END.
         ELSE DO:
         END.         
      END.               
      RELEASE OBJECT chWorksheetRange NO-ERROR.             
      RELEASE OBJECT cActiveCell NO-ERROR.      
      RELEASE OBJECT chWorksheet NO-ERROR.                  
      NO-RETURN-VALUE chWorkbook:CLOSE() no-error.
      NO-RETURN-VALUE chExcelApplication:QUIT().
      RELEASE OBJECT chWorkbook NO-ERROR.    
      RELEASE OBJECT chExcelApplication NO-ERROR.           
      RELEASE OBJECT chWindow NO-ERROR.                  
                           
   END.             
                       
   RELEASE OBJECT chExcelApplication NO-ERROR.      
   RELEASE OBJECT chWorkbook NO-ERROR.
   RELEASE OBJECT chWorksheet NO-ERROR.
      
END PROCEDURE .

PROCEDURE bilagaaker_UI :

   IF Guru.Konstanter:appcon THEN RUN FINNSTABELL.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT "BLOBINFO", OUTPUT bloblog).
   ELSE RUN FINNSTABELL.P (INPUT "BLOBINFO", OUTPUT bloblog).
   IF bloblog = TRUE THEN DO:
      {FINNSDYNBLOB.I}
      DEFINE VARIABLE resid AS INTEGER NO-UNDO.
      RUN blobfil_UI IN blobproch (INPUT fnamnB, OUTPUT resid).
      IF resid = ? THEN DO:
         kommando20 = SEARCH(fnamnB).      
      END.
      ELSE DO:
         FIND FIRST blobinfotemp WHERE blobinfotemp.ID = resid NO-LOCK NO-ERROR.
         RUN blobopen_UI IN blobproch (INPUT blobinfotemp.FILNAMN, OUTPUT kommando20).      
      END.
      RUN deleteproc_UI IN blobproch.
      IF VALID-HANDLE(blobproch) THEN DELETE PROCEDURE blobproch NO-ERROR.
   END.
   ELSE kommando20 = SEARCH(fnamnB).   
   IF kommando20 = ? THEN DO:
      MESSAGE "Hittade inte " fnamnB VIEW-AS ALERT-BOX.
      RETURN.       
   END.   
   kommando21 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
   kommando31 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
   kommando41 = kommando20.
   {SESSIONTEMPDIR.I}
   IF SESSION:CLIENT-TYPE = "WEBCLIENT" THEN DO:
       kommando21 = webclienttempdir.
       kommando31 = webclienttempdir.
   END.    
   
   OS-CREATE-DIR VALUE(kommando2) NO-ERROR.
   
   IF spmall = TRUE AND fildir NE "" THEN DO:
      kommando21 = fildir  + "\".
      kommando31 = fildir  + "\".  
   END.
   
   IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
      kommando21 = kommando21 + fnamnB.
   END.
   ELSE DO:
      kommando21 = kommando21 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamnB.
   END.

   OS-COPY VALUE(kommando20) VALUE(kommando21).
   kommando20 = kommando21.
   IF sidvarB = 1 THEN DO:
      CREATE "Excel.Application" chExcelApplication.
      IF spmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE IF skrivutmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE chExcelApplication:Visible = TRUE.
      {OPENEXCEL.I}
      chWorkbook = chExcelApplication:Workbooks:OPEN(kommando20).
   END.   
  
   IF  sidvarB > 1 THEN DO:            
      IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
         kommando21 = kommando31 + fnamn11 + string(sidvarB) + fnamn21.
      END.
      ELSE DO:
         kommando21 = kommando31 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn11 + string(sidvarB) + fnamn21.
      END.
      
      OS-COPY VALUE(kommando41) VALUE(kommando20).   
      kommando20 = kommando21.         
      CREATE "Excel.Application" chExcelApplication.
      IF spmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE IF  skrivutmall = TRUE THEN chExcelApplication:Visible = FALSE.
      ELSE chExcelApplication:Visible = TRUE.
      {OPENEXCEL.I}
      chWorkbook = chExcelApplication:Workbooks:OPEN(kommando20).
      
   END.
   sidvarB = sidvarB + 1.
   FIND FIRST emarkval NO-LOCK NO-ERROR.  
   FIND FIRST marag NO-LOCK NO-ERROR.
   chWorkSheet = chExcelApplication:Sheets:Item(1) NO-ERROR.
   iColumn = 4.
   cColumn = STRING(iColumn).
   cRange = "C" + cColumn.
   chWorkSheet:Range(cRange):Value = emarkval.BETECKNING NO-ERROR.      
   iColumn = 5.
   cColumn = STRING(iColumn).
   cRange = "C" + cColumn.
   chWorkSheet:Range(cRange):Value = fkommun NO-ERROR.
   
   IF pomr = "GSS" THEN pvaldomr = 1.
   IF pomr = "GMB" THEN pvaldomr = 2.
   IF pomr = "GNS" THEN pvaldomr = 3.
   IF pomr = "SS" THEN pvaldomr = 4.
   IF pomr = "GSK" THEN pvaldomr = 5.
   IF pomr = "SSK" THEN pvaldomr = 6.
   IF pomr = "NN" THEN pvaldomr = 7.
   IF pomr = "NÖ" THEN pvaldomr = 8.
   IF pvaldomr > 0 THEN DO:
      iColumn = 4.           
      cColumn = STRING(iColumn).
      cRange = "M" + cColumn.                 
      chWorkSheet:Range(cRange):Value = pvaldomr NO-ERROR.
   END.

   iColumn = 7.
   cColumn = STRING(iColumn).
   cRange = "C" + cColumn.         
   chWorkSheet:Range(cRange):Value = marag.GATUADRESS NO-ERROR.   
   iColumn = 8.
   cColumn = STRING(iColumn).
   cRange = "C" + cColumn.
   chWorkSheet:Range(cRange):Value = marag.POSTNUMMER + " " + marag.POSTADRESS NO-ERROR.
   
   iColumn = 8.
   cColumn = STRING(iColumn).
   cRange = "H" + cColumn.
   chWorkSheet:Range(cRange):Value = vman NO-ERROR.
   
   iColumn = 5.
   cColumn = STRING(iColumn).
   cRange = "H" + cColumn.
   chWorkSheet:Range(cRange):Value = lelitt NO-ERROR.
   iColumn = 7.
   cColumn = STRING(iColumn).
   cRange = "H" + cColumn.
   chWorkSheet:Range(cRange):Value = TODAY NO-ERROR.
   
   iColumn = 6.
   cColumn = STRING(iColumn).
   cRange = "H" + cColumn.
   chWorkSheet:Range(cRange):Value = ponr NO-ERROR.
   IF allamark = "alla" THEN DO:
      iColumn = 6.           
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.         
      IF kontpers NE "" THEN chWorkSheet:Range(cRange):Value = kontpers NO-ERROR.         
      ELSE chWorkSheet:Range(cRange):Value = marag.MARKAGARE NO-ERROR.                    
   END.
   ELSE DO:              
      /*Bara en markägare till VP*/
      iColumn = 6.           
      cColumn = STRING(iColumn).
      cRange = "C" + cColumn.                 
      chWorkSheet:Range(cRange):Value = emarkval.MARKAGARE NO-ERROR.
                     
   END.
   iColumn = 12.
   cColumn = STRING(iColumn).
   FOR EACH akevard WHERE akevard.MARKNR = emarkval.MARKNR AND akevard.BETECKNING = emarkval.BETECKNING
   AND akevard.L5 = 0 AND akevard.STOLPNR NE 0 :            
      {EXCELFEL.I}
      /*Tillfällig skada regleras separat- dvs fast pris ska inte med förrutom borttaget intrång som jag har lagt som fast pris*/
      IF akevard.FASTPRIS = TRUE AND akevard.KRONOR > 0 THEN iColumn = iColumn.
      ELSE DO:            
         cColumn = STRING(iColumn).
         cRange = "B" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(akevard.STOLPNR,">>9") + " " + akevard.BENAMNING  NO-ERROR.
         
         cRange = "E" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(akevard.L1,">>>9") NO-ERROR.   
         cRange = "F" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(akevard.L2,">>>9") NO-ERROR.
         cRange = "G" + cColumn.
         chWorkSheet:Range(cRange):Value = STRING(akevard.L3,">>>9") NO-ERROR.   
         /*Mxx 1 = Åker  Mxx 2 = Bete Mxx 3 = Impediment*/
         cRange = "M" + cColumn.
         IF akevard.SORT = "Åker" THEN chWorkSheet:Range(cRange):Value = 1 NO-ERROR.
         IF akevard.SORT = "Betesmark" THEN chWorkSheet:Range(cRange):Value = 2 NO-ERROR.
         IF akevard.SORT = "Impediment" THEN chWorkSheet:Range(cRange):Value = 3 NO-ERROR.
         
        
         iColumn = iColumn + 1.
         cColumn = STRING(iColumn).
      END.
   END.


   IF spmall = TRUE OR skrivutmall = TRUE  THEN DO:
      chExcelApplication:displayalerts = FALSE.      
      chWorkbook:SaveAs(kommando20,,,,,,,,,).        
      chExcelApplication:displayalerts = TRUE.
      IF skrivutmall = TRUE THEN DO:

         chWorkSheet = chExcelApplication:Sheets:ITEM(1) NO-ERROR.                       
         chWorkSheet:SELECT NO-ERROR.     
         RUN screenexcel_UI.
         RUN slutmedprintmark_UI (INPUT 2).
         RELEASE OBJECT chWorksheet NO-ERROR.
            
      END.               
      RELEASE OBJECT chWorksheetRange NO-ERROR.             
      RELEASE OBJECT cActiveCell NO-ERROR.      
      RELEASE OBJECT chWorksheet NO-ERROR.                  
      NO-RETURN-VALUE chWorkbook:CLOSE() no-error.
      NO-RETURN-VALUE chExcelApplication:QUIT().
      RELEASE OBJECT chWorkbook NO-ERROR.    
      RELEASE OBJECT chExcelApplication NO-ERROR.           
      RELEASE OBJECT chWindow NO-ERROR.                  
                           
   END.             
                       
   RELEASE OBJECT chExcelApplication NO-ERROR.      
   RELEASE OBJECT chWorkbook NO-ERROR.
   RELEASE OBJECT chWorksheet NO-ERROR.

END PROCEDURE .   


PROCEDURE imageexcel2_UI.   
   ASSIGN iColumn = iColumn + 1.
   cColumn = STRING(iColumn).
   cRange = "F" + cColumn.
   chWorkSheet:Range(cRange):SELECT NO-ERROR.  
   IF link NE  ? THEN DO:
      chWorksheetRange = chWorkSheet:Pictures:INSERT(link) NO-ERROR.
      chWorksheetRange:TOP = 1.      
   END.
   chExcelApplication:VISIBLE = TRUE NO-ERROR.
   ASSIGN iColumn = iColumn + 7.
   {EXCELFEL.I}
END PROCEDURE.


