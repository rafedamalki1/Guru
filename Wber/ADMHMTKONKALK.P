/*ADMHMTKONKALK.P PROGRAMMET HÄMTAR kalkylkoder i admin 
BERSPARKONMTR.P  NEJKOMBALLTVEN.P
BERHMTKONMTRL.P NEJKOMBBERU.P
ADMHMTKONMTRL.P  NEJKOMBU.P
ADMHMTKONKALK.P  NEJKOMBU2.P
KALKKOPPUN.W
*/

{STARTFORAPP.I}
{KONVALTEMP.I}

  
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{SMTRL.I}
&Scoped-define NEW 

DEFINE INPUT PARAMETER valnum LIKE BERVAL.NUM NO-UNDO.
DEFINE INPUT PARAMETER TABLE FOR kon_val.
DEFINE INPUT PARAMETER p2p3var AS INTEGER NO-UNDO.
DEFINE OUTPUT PARAMETER TABLE FOR spec_mtrl. 

DEFINE QUERY mtrlq FOR KALKBER.

/*HUVUDPROGRAM*/   
   FIND FIRST kon_val WHERE kon_val.NUM = valnum AND kon_val.KSKAP = FALSE 
   NO-LOCK NO-ERROR.        
   RUN val_UI.    
   
   
/*SLUT HUVUDPROGRAM*/   
   
PROCEDURE val_UI.   
   /*OM ENDAST KONSTRUKTIONEN MARKERAD HÄMTA DESS KODER ANNARS
   HÄMTA DE KODER SOM ÄR KOPPLAT TILL VALET. 
   GÄLLER VID ADMINISTRATION*/
   IF kon_val.F2 = " " AND kon_val.F3 = " " AND
   kon_val.F4 = " " AND kon_val.F5 = " " AND kon_val.F6 = " " THEN DO:
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F1 = "" AND KALKBER.F2 = " " AND KALKBER.F3 = " " AND KALKBER.F4 = " " AND KALKBER.F5 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.         
   IF kon_val.F2 NE "" THEN DO: 
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F1 = kon_val.F2 AND KALKBER.F2 = " " AND KALKBER.F3 = " " AND
      KALKBER.F4 = " " AND KALKBER.F5 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.     
   IF kon_val.F3 NE "" THEN DO: 
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F2 = kon_val.F3 AND KALKBER.F1 = " " AND KALKBER.F3 = " " AND
      KALKBER.F4 = " " AND KALKBER.F5 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.   
   IF kon_val.F4 NE "" THEN DO: 
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F3 = kon_val.F4 AND KALKBER.F1 = " " AND KALKBER.F2 = " " AND
      KALKBER.F4 = " " AND KALKBER.F5 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.   
   IF kon_val.F5 NE "" THEN DO: 
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F4 = kon_val.F5 AND KALKBER.F1 = " " AND KALKBER.F2 = " " AND
      KALKBER.F3 = " " AND KALKBER.F5 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.   
   IF kon_val.F6 NE "" THEN DO: 
      OPEN QUERY mtrlq FOR EACH KALKBER WHERE KALKBER.KTYPKOD = kon_val.F1 AND
      KALKBER.F5 = kon_val.F6 AND KALKBER.F1 = " " AND KALKBER.F2 = " " AND
      KALKBER.F3 = " " AND KALKBER.F4 = " " USE-INDEX AR NO-LOCK. 
      GET FIRST mtrlq NO-LOCK.
      DO WHILE AVAILABLE(KALKBER):
         RUN skapa_UI.
         GET NEXT mtrlq NO-LOCK. 
      END.
      CLOSE QUERY mtrlq.      
   END.      
END PROCEDURE.  
   
PROCEDURE skapa_UI :  
  
   CREATE spec_mtrl. 
   ASSIGN
   spec_mtrl.ARBKOD = KALKBER.ARBKOD
   spec_mtrl.LOPNR = KALKBER.LOPNR
   spec_mtrl.BENAMNING = KALKBER.BENAMNING
   spec_mtrl.ENHET = KALKBER.ENHET
   spec_mtrl.ANTAL = KALKBER.ANTAL.      
END PROCEDURE.      
