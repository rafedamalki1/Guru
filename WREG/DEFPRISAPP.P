/*
     Filename: DEFPRISAPP.P
      Created: 03.09.0004 11:45ELPAO     
     Modified: 
*/

/********************************** Variables **********************************/

/********************************** Temp-Tables **********************************/

DEFINE TEMP-TABLE befprislisttemp NO-UNDO 
   FIELD NAMN        AS CHARACTER FORMAT "x(20)"
   FIELD PRISID      AS CHARACTER FORMAT "X(8)"
   FIELD BEFATTNING  AS CHARACTER FORMAT "x(20)"
   FIELD PRISA       AS DECIMAL FORMAT "->>>>9.99"
   FIELD PRISRES     AS DECIMAL FORMAT "->>>>9.99"
   INDEX PRISID AS PRIMARY PRISID BEFATTNING.

DEFINE TEMP-TABLE otextpristemp NO-UNDO 
   FIELD PRISID      AS CHARACTER FORMAT "X(8)"
   FIELD START       AS DECIMAL FORMAT "99.99" INITIAL 7.00
   FIELD SLUT        AS DECIMAL FORMAT "99.99" INITIAL 16.00
   FIELD BEFATTNING  AS CHARACTER FORMAT "x(20)"
   FIELD EQDAG       AS INTEGER FORMAT "9"
   FIELD PRISA       AS DECIMAL FORMAT "->>>>9.99"
   FIELD DAGTYP      AS CHARACTER FORMAT "X(8)"
   FIELD OTEXT       AS CHARACTER FORMAT "X(25)"
   FIELD OTEXTID     AS CHARACTER FORMAT "X(8)"
   INDEX PRISID AS PRIMARY PRISID BEFATTNING EQDAG START SLUT.

&SCOPED-DEFINE NEW 
&SCOPED-DEFINE SHARED 
{OVERTEXTEMP.I}
DEFINE TEMP-TABLE extraopltemp LIKE overprislisttemp.

/********************************** DEFPRISL.W **********************************/

PROCEDURE PrisFakt_UI :
  
   DEFINE OUTPUT PARAMETER TABLE FOR befprislisttemp.
   EMPTY TEMP-TABLE befprislisttemp NO-ERROR. 
   FIND LAST KALKYLKATALOG WHERE KALKYLKATALOG.BENAMNING BEGINS "EBR" USE-INDEX VISARTAL NO-LOCK NO-ERROR.
   FOR EACH KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOG.HKLOGSUBID AND KALKYLPRISER.EGENKODUPP = TRUE NO-LOCK:
      CREATE befprislisttemp.
      ASSIGN
      befprislisttemp.NAMN = KALKYLPRISER.BENAMNING
      befprislisttemp.BEFATTNING = KALKYLPRISER.BENAMNING
      befprislisttemp.PRISA = 0
      befprislisttemp.PRISRES = 1.
         
   END.
   FOR EACH KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOG.HKLOGSUBID AND KALKYLPRISER.EGENPRISUPP = TRUE NO-LOCK:
      FIND FIRST befprislisttemp WHERE befprislisttemp.NAMN = KALKYLPRISER.BENAMNING NO-LOCK NO-ERROR.
      IF NOT AVAILABLE befprislisttemp THEN DO:
         CREATE befprislisttemp.
         ASSIGN 
         befprislisttemp.PRISRES = 1
         befprislisttemp.NAMN = KALKYLPRISER.BENAMNING
         befprislisttemp.BEFATTNING = KALKYLPRISER.BENAMNING.
      END.
      ASSIGN
      befprislisttemp.PRISA = KALKYLPRISER.PRIS.
   END.
   
END PROCEDURE.
PROCEDURE KalPrisSpar_UI :
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR defpristemp.
   DEFINE INPUT PARAMETER TABLE FOR befprislisttemp.
   FIND FIRST defpristemp WHERE defpristemp.PRISID = defprisid NO-LOCK NO-ERROR.
   DO TRANSACTION:
      IF AVAILABLE defpristemp THEN DO:
         FIND FIRST DEFPRISLISTA WHERE DEFPRISLISTA.PRISID = defpristemp.PRISID EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE DEFPRISLISTA THEN DO:
            BUFFER-COPY defpristemp TO DEFPRISLISTA.
         END.
      END.
   END.   
   FOR EACH befprislisttemp:
      DO TRANSACTION:
         FIND FIRST PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid AND PRISLISTFAKT.BEFATTNING = befprislisttemp.BEFATTNING EXCLUSIVE-LOCK NO-ERROR.
         IF NOT AVAILABLE PRISLISTFAKT THEN DO:
            CREATE PRISLISTFAKT.
         END. 
         BUFFER-COPY befprislisttemp TO PRISLISTFAKT.
         PRISLISTFAKT.PRISID = defprisid.
      END.
   END.
END PROCEDURE.
PROCEDURE tabortdefpris_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DO TRANSACTION:
      FIND DEFPRISLISTA WHERE DEFPRISLISTA.PRISID = defprisid EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE DEFPRISLISTA THEN DO:
         OPEN QUERY prisq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = DEFPRISLISTA.PRISID NO-LOCK.
         GET FIRST prisq EXCLUSIVE-LOCK.
         DO WHILE AVAILABLE(PRISLISTFAKT):
            DELETE PRISLISTFAKT.
            GET NEXT prisq EXCLUSIVE-LOCK.
         END.
         OPEN QUERY prisoverq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = DEFPRISLISTA.PRISID NO-LOCK.
         GET FIRST prisoverq EXCLUSIVE-LOCK.
         DO WHILE AVAILABLE(OVERPRISLISTA):
            DELETE OVERPRISLISTA.
            GET NEXT prisoverq EXCLUSIVE-LOCK.
         END.
      END.
      FIND FIRST PRISLISTOVRIGT WHERE PRISLISTOVRIGT.PRISID = DEFPRISLISTA.PRISID
      EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE PRISLISTOVRIGT THEN DO:
         DELETE PRISLISTOVRIGT.
      END.
      DELETE DEFPRISLISTA.
   END.
END PROCEDURE.

/********************************** DPRISNY.W **********************************/

PROCEDURE btnavbprisny_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.

   DO TRANSACTION:
      FIND DEFPRISLISTA WHERE DEFPRISLISTA.PRISID = defprisid EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE DEFPRISLISTA THEN DO:
         OPEN QUERY prisq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid NO-LOCK.
         GET FIRST prisq EXCLUSIVE-LOCK.
         DO WHILE AVAILABLE(PRISLISTFAKT):
            DELETE PRISLISTFAKT.
            GET NEXT prisq EXCLUSIVE-LOCK.
         END.
         OPEN QUERY prisoverq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = defprisid NO-LOCK.
         GET FIRST prisoverq EXCLUSIVE-LOCK.
         DO WHILE AVAILABLE(OVERPRISLISTA):
            DELETE OVERPRISLISTA.
            GET NEXT prisoverq EXCLUSIVE-LOCK.
         END.
         FIND FIRST PRISLISTOVRIGT WHERE PRISLISTOVRIGT.PRISID = defprisid
         EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE PRISLISTOVRIGT THEN DO:
            DELETE PRISLISTOVRIGT.
         END.      
         DELETE DEFPRISLISTA.
      END.
   END.
END PROCEDURE.


PROCEDURE btnokdprisny_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR defpristemp.
   DEFINE INPUT PARAMETER TABLE FOR prislotemp.
   DEFINE INPUT PARAMETER TABLE FOR befprislisttemp.

   FIND FIRST defpristemp WHERE defpristemp.PRISID = defprisid NO-LOCK NO-ERROR.
   FIND FIRST prislotemp WHERE prislotemp.PRISID = defprisid NO-LOCK NO-ERROR.
   DO TRANSACTION:
      IF AVAILABLE defpristemp THEN DO:
         FIND FIRST DEFPRISLISTA WHERE DEFPRISLISTA.PRISID = defpristemp.PRISID EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE DEFPRISLISTA THEN DO:
            BUFFER-COPY defpristemp TO DEFPRISLISTA.
         END.
      END.
      IF AVAILABLE prislotemp THEN DO:   
         FIND FIRST PRISLISTOVRIGT WHERE PRISLISTOVRIGT.PRISID = prislotemp.PRISID EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE PRISLISTOVRIGT THEN DO:
            BUFFER-COPY prislotemp TO PRISLISTOVRIGT.
         END.
      END.   
      OPEN QUERY pfq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid NO-LOCK, 
      EACH befprislisttemp WHERE befprislisttemp.BEFATTNING = PRISLISTFAKT.BEFATTNING NO-LOCK.
      GET FIRST pfq EXCLUSIVE-LOCK.
      DO WHILE AVAILABLE(PRISLISTFAKT):
         BUFFER-COPY befprislisttemp TO PRISLISTFAKT.
         GET NEXT pfq EXCLUSIVE-LOCK.
      END.

   END.
   IF AVAILABLE DEFPRISLISTA THEN RELEASE DEFPRISLISTA.
   IF AVAILABLE PRISLISTOVRIGT THEN RELEASE PRISLISTOVRIGT.
   IF AVAILABLE PRISLISTFAKT THEN RELEASE PRISLISTFAKT.
   RUN BESTTABPRIS.P.
END PROCEDURE.

PROCEDURE laddajointables_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR befprislisttemp.
   DEFINE OUTPUT PARAMETER TABLE FOR otextpristemp.
   EMPTY TEMP-TABLE befprislisttemp NO-ERROR. 
   EMPTY TEMP-TABLE otextpristemp NO-ERROR. 
   OPEN QUERY bq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid NO-LOCK, 
   EACH BEFATTNINGSTAB WHERE BEFATTNINGSTAB.BEFATTNING = PRISLISTFAKT.BEFATTNING 
   NO-LOCK BY BEFATTNINGSTAB.NAMN. 
   GET FIRST bq NO-LOCK.
   DO WHILE AVAILABLE(PRISLISTFAKT):
      CREATE befprislisttemp.
      BUFFER-COPY PRISLISTFAKT TO befprislisttemp.
      befprislisttemp.NAMN = BEFATTNING.NAMN.
      GET NEXT bq NO-LOCK.
   END.
   FIND FIRST befprislisttemp WHERE NO-LOCK NO-ERROR.
   IF NOT AVAILABLE befprislisttemp THEN DO:
      OPEN QUERY bpq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid NO-LOCK. 
      GET FIRST bpq NO-LOCK.
      DO WHILE AVAILABLE(PRISLISTFAKT):
         CREATE befprislisttemp.
         BUFFER-COPY PRISLISTFAKT TO befprislisttemp.
         befprislisttemp.NAMN = PRISLISTFAKT.BEFATTNING.
         GET NEXT bpq NO-LOCK.
      END.
   END.
   OPEN QUERY oq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = defprisid NO-LOCK,
   EACH OVERTEXTFAKT WHERE OVERTEXTFAKT.OTEXTID = OVERPRISLISTA.OTEXTID NO-LOCK.
   GET FIRST oq NO-LOCK.
   DO WHILE AVAILABLE(OVERPRISLISTA):
      CREATE otextpristemp.
      BUFFER-COPY OVERPRISLISTA TO otextpristemp.
      otextpristemp.OTEXT = OVERTEXTFAKT.OTEXT.
      GET NEXT oq NO-LOCK.
   END.   
END PROCEDURE.


PROCEDURE nylistdprisny_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER overtidlog AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER varfore AS INTEGER NO-UNDO.

   DEFINE VARIABLE morgon AS DECIMAL NO-UNDO.
   DEFINE VARIABLE kvall AS DECIMAL NO-UNDO.
   IF overtidlog = TRUE THEN DO TRANSACTION:
      OPEN QUERY befq FOR EACH BEFATTNINGSTAB USE-INDEX BEF NO-LOCK.
      GET FIRST befq NO-LOCK.
      DO WHILE AVAILABLE(BEFATTNINGSTAB):
         ASSIGN
         morgon = 7.00
         kvall = 16.00.
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         USE-INDEX PBEF NO-LOCK NO-ERROR.
         IF NOT AVAILABLE PERSONALTAB THEN DO:
            ASSIGN
            morgon = 7.00
            kvall = 16.00.
         END.
         ELSE DO:
            FIND FIRST VECKOARBETID WHERE VECKOARBETID.VECKOSCHEMA = PERSONALTAB.VECKOSCHEMA
            USE-INDEX VECKOSCHEMA NO-LOCK NO-ERROR.
            IF AVAILABLE VECKOARBETID THEN DO:
               FIND FIRST ARBETSTIDTAB WHERE ARBETSTIDTAB.ARBTIDKOD = VECKOARBETID.ARBTIDMAN
               USE-INDEX ARBTIDKOD NO-LOCK NO-ERROR.
               IF AVAILABLE ARBETSTIDTAB THEN DO:
                  ASSIGN
                  morgon = ARBETSTIDTAB.START
                  kvall = ARBETSTIDTAB.SLUT.
               END.               
            END.            
         END.
         FIND FIRST OVERTEXTFAKT WHERE OVERTEXTFAKT.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         NO-LOCK NO-ERROR.
         CREATE OVERPRISLISTA.
         ASSIGN
         OVERPRISLISTA.PRISID = defprisid
         OVERPRISLISTA.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         OVERPRISLISTA.OTEXTID = OVERTEXTFAKT.OTEXTID
         OVERPRISLISTA.DAGTYP = "VARDAGAR"
         OVERPRISLISTA.EQDAG = 2
         OVERPRISLISTA.PRISA = BEFATTNINGSTAB.PRISA
         OVERPRISLISTA.START = 00.00
         OVERPRISLISTA.SLUT = morgon.
         CREATE OVERPRISLISTA.
         ASSIGN
         OVERPRISLISTA.PRISID = defprisid
         OVERPRISLISTA.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         OVERPRISLISTA.OTEXTID = OVERTEXTFAKT.OTEXTID
         OVERPRISLISTA.DAGTYP = "VARDAGAR"
         OVERPRISLISTA.EQDAG = 2
         OVERPRISLISTA.PRISA = BEFATTNINGSTAB.PRISA
         OVERPRISLISTA.START = kvall
         OVERPRISLISTA.SLUT = 24.00.
         CREATE OVERPRISLISTA.
         ASSIGN
         OVERPRISLISTA.PRISID = defprisid
         OVERPRISLISTA.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         OVERPRISLISTA.OTEXTID = OVERTEXTFAKT.OTEXTID
         OVERPRISLISTA.DAGTYP = "LÖRDAGAR"
         OVERPRISLISTA.EQDAG = 7
         OVERPRISLISTA.PRISA = BEFATTNINGSTAB.PRISA
         OVERPRISLISTA.START = 00.00
         OVERPRISLISTA.SLUT = 24.00.
         CREATE OVERPRISLISTA.
         ASSIGN
         OVERPRISLISTA.PRISID = defprisid
         OVERPRISLISTA.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         OVERPRISLISTA.OTEXTID = OVERTEXTFAKT.OTEXTID
         OVERPRISLISTA.DAGTYP = "SÖNDAGAR"
         OVERPRISLISTA.EQDAG = 8
         OVERPRISLISTA.PRISA = BEFATTNINGSTAB.PRISA
         OVERPRISLISTA.START = 00.00
         OVERPRISLISTA.SLUT = 24.00.
         GET NEXT befq NO-LOCK.
      END.
   END.
   ELSE DO TRANSACTION:
      OPEN QUERY befatq FOR EACH BEFATTNINGSTAB USE-INDEX BEF NO-LOCK.
      GET FIRST befatq NO-LOCK.
      DO WHILE AVAILABLE(BEFATTNINGSTAB):
         CREATE PRISLISTFAKT.
         ASSIGN
         PRISLISTFAKT.PRISID = defprisid
         PRISLISTFAKT.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         PRISLISTFAKT.PRISA = BEFATTNINGSTAB.PRISA.
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.BEFATTNING = BEFATTNINGSTAB.BEFATTNING
         USE-INDEX PBEF NO-LOCK NO-ERROR.
         IF AVAILABLE PERSONALTAB THEN DO:
            IF varfore = 1 THEN DO:         
               FIND LAST PERSONALPRIS WHERE PERSONALPRIS.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
               PERSONALPRIS.BEFATTNING = 'RESTID...' AND PERSONALPRIS.STARTDATUM <= TODAY  
               AND PERSONALPRIS.SLUTDATUM >= TODAY NO-LOCK NO-ERROR.
               IF NOT AVAILABLE PERSONALPRIS THEN DO:
                  FIND LAST PERSONALPRIS WHERE PERSONALPRIS.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
                  PERSONALPRIS.BEFATTNING = 'RESTID...' USE-INDEX PSTART NO-LOCK NO-ERROR.
               END.
               IF NOT AVAILABLE PERSONALPRIS THEN DO:
                  FIND LAST PERSONALPRIS WHERE PERSONALPRIS.BEFATTNING = 'RESTID...' USE-INDEX PSTART NO-LOCK NO-ERROR.
               END.
               ASSIGN PRISLISTFAKT.PRISRES = PERSONALPRIS.PRIS.  
            END.
            ELSE DO:
               FIND FIRST TIMKOSTNADSTAB WHERE 
               TIMKOSTNADSTAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
               TIMKOSTNADSTAB.PRISTYP = 'RESTID...' 
               USE-INDEX PRISPERS NO-LOCK NO-ERROR.
               IF AVAILABLE TIMKOSTNADSTAB THEN ASSIGN PRISLISTFAKT.PRISRES = TIMKOSTNADSTAB.PRISA.
            END.
         END.
         GET NEXT befatq NO-LOCK.
      END.
      FIND FIRST PRISLISTOVRIGT WHERE PRISLISTOVRIGT.PRISID = defprisid NO-LOCK NO-ERROR.
      IF NOT AVAILABLE PRISLISTOVRIGT THEN DO:
         CREATE PRISLISTOVRIGT.
         PRISLISTOVRIGT.PRISID = defprisid.
      END.
   END.
   {musarrow.i}
   CLOSE QUERY befatq.
   IF AVAILABLE PRISLISTOVRIGT THEN RELEASE PRISLISTOVRIGT.
   IF AVAILABLE PRISLISTFAKT THEN RELEASE PRISLISTFAKT.
   IF AVAILABLE OVERPRISLISTA THEN RELEASE OVERPRISLISTA.
END PROCEDURE.

PROCEDURE nyprislista_UI:
   DEFINE OUTPUT PARAMETER defprisid AS CHARACTER NO-UNDO. 
   DEFINE VARIABLE tempi AS INTEGER NO-UNDO.
   OPEN QUERY defq FOR EACH DEFPRISLISTA BY INTEGER(PRISID).
   GET LAST defq NO-LOCK.
   IF NOT AVAILABLE DEFPRISLISTA THEN DO:
      CREATE DEFPRISLISTA.
      ASSIGN 
      DEFPRISLISTA.PRISID = STRING(1)
      DEFPRISLISTA.STARTDATUM = TODAY.
   END.
   ELSE DO:
      tempi = INTEGER(DEFPRISLISTA.PRISID).
      tempi = tempi + 1.
      CREATE DEFPRISLISTA.
      ASSIGN 
      DEFPRISLISTA.PRISID = STRING(tempi)
      DEFPRISLISTA.STARTDATUM = TODAY.
   END.
   defprisid = DEFPRISLISTA.PRISID.
   IF AVAILABLE DEFPRISLISTA THEN RELEASE DEFPRISLISTA.
END PROCEDURE.

/********************************** DEFPRISL.W **********************************/
PROCEDURE kopiera_UI:
   DEFINE INPUT PARAMETER franprisid AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tillprisid AS CHARACTER NO-UNDO.
   DEFINE BUFFER kundobuff FOR PRISLISTFAKT.
   DEFINE BUFFER priobuff FOR PRISLISTOVRIGT.
   OPEN QUERY bq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = tillprisid NO-LOCK,
   EACH BEFATTNINGSTAB WHERE BEFATTNINGSTAB.BEFATTNING = PRISLISTFAKT.BEFATTNING NO-LOCK.
   DO TRANSACTION:
      GET FIRST bq EXCLUSIVE-LOCK.
      DO WHILE AVAILABLE(PRISLISTFAKT):
         DELETE PRISLISTFAKT.
         GET NEXT bq EXCLUSIVE-LOCK.
      END.
   END.
   OPEN QUERY pq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = franprisid NO-LOCK,
   EACH BEFATTNINGSTAB WHERE BEFATTNINGSTAB.BEFATTNING = PRISLISTFAKT.BEFATTNING NO-LOCK.
   GET FIRST pq NO-LOCK.
   DO WHILE AVAILABLE(PRISLISTFAKT):
      DO TRANSACTION:
         CREATE  kundobuff.
         ASSIGN
         kundobuff.BEFATTNING = PRISLISTFAKT.BEFATTNING
         kundobuff.PRISID = tillprisid
         kundobuff.PRISA = PRISLISTFAKT.PRISA
         kundobuff.PRISRES = PRISLISTFAKT.PRISRES.
      END.
      GET NEXT pq NO-LOCK.
   END.
   DO TRANSACTION:
      FIND FIRST priobuff WHERE priobuff.PRISID = tillprisid
      EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE priobuff THEN DO:
         CREATE priobuff.
         priobuff.PRISID = tillprisid.
      END.
      FIND FIRST PRISLISTOVRIGT WHERE PRISLISTOVRIGT.PRISID = franprisid
      NO-LOCK NO-ERROR.
      IF AVAILABLE PRISLISTOVRIGT THEN DO:
         ASSIGN
         priobuff.ENTRAK = PRISLISTOVRIGT.ENTRAK
         priobuff.FLERTRAK = PRISLISTOVRIGT.FLERTRAK
         priobuff.FRTJPA = PRISLISTOVRIGT.FRTJPA
         priobuff.MIL = PRISLISTOVRIGT.MIL
         priobuff.MTRLPA = PRISLISTOVRIGT.MTRLPA.
      END.
   END.
END PROCEDURE.

PROCEDURE laddabefprislisttemp_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR befprislisttemp.
   EMPTY TEMP-TABLE befprislisttemp NO-ERROR.    
   OPEN QUERY bq FOR EACH PRISLISTFAKT WHERE PRISLISTFAKT.PRISID = defprisid NO-LOCK, 
   EACH BEFATTNINGSTAB WHERE BEFATTNINGSTAB.BEFATTNING = PRISLISTFAKT.BEFATTNING 
   NO-LOCK BY BEFATTNINGSTAB.NAMN. 
   GET FIRST bq NO-LOCK.
   DO WHILE AVAILABLE(PRISLISTFAKT):
      CREATE befprislisttemp.
      BUFFER-COPY PRISLISTFAKT TO befprislisttemp.
      befprislisttemp.NAMN = BEFATTNING.NAMN.
      GET NEXT bq NO-LOCK.
   END.   
END PROCEDURE.

/********************************** NYDEFPDO.W **********************************/

PROCEDURE btnoknydef_UI:
   DEFINE INPUT PARAMETER TABLE FOR extraopltemp.
   FIND FIRST extraopltemp NO-LOCK NO-ERROR.
   IF AVAILABLE extraopltemp THEN DO:
      OPEN QUERY overq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = extraopltemp.PRISID AND
      OVERPRISLISTA.BEFATTNING = extraopltemp.BEFATTNING AND 
      OVERPRISLISTA.DAGTYP = extraopltemp.DAGTYP NO-LOCK.
      GET FIRST overq EXCLUSIVE-LOCK.
      DO WHILE AVAILABLE(OVERPRISLISTA):                         
         IF OVERPRISLISTA.START >= extraopltemp.START AND OVERPRISLISTA.SLUT <= extraopltemp.SLUT THEN DO:               
            DELETE OVERPRISLISTA.                
         END. 
         ELSE IF OVERPRISLISTA.START >= extraopltemp.START AND OVERPRISLISTA.START <= extraopltemp.SLUT AND
         OVERPRISLISTA.SLUT > extraopltemp.SLUT THEN DO:                
            ASSIGN OVERPRISLISTA.START = extraopltemp.SLUT.                
         END.
         ELSE IF OVERPRISLISTA.START <= extraopltemp.START AND OVERPRISLISTA.SLUT >= extraopltemp.START AND
         OVERPRISLISTA.SLUT < extraopltemp.SLUT THEN DO:                
            ASSIGN OVERPRISLISTA.SLUT = extraopltemp.START.                
         END.
         ELSE IF OVERPRISLISTA.START = OVERPRISLISTA.SLUT THEN DO:
            DELETE OVERPRISLISTA.                
         END.               
         ELSE IF extraopltemp.START = extraopltemp.SLUT THEN DO:                
            IF OVERPRISLISTA.SLUT = extraopltemp.START THEN DO:                  
               DELETE OVERPRISLISTA.
            END.                
         END.      
         ELSE IF OVERPRISLISTA.SLUT >= extraopltemp.START AND OVERPRISLISTA.SLUT <= extraopltemp.SLUT THEN DO:               
            DELETE OVERPRISLISTA.                
         END. 
         GET NEXT overq EXCLUSIVE-LOCK. 
      END. 
      CLOSE QUERY overq.
      CREATE OVERPRISLISTA.
      BUFFER-COPY extraopltemp TO OVERPRISLISTA.
      IF AVAILABLE OVERPRISLISTA THEN RELEASE OVERPRISLISTA.
   END.
END PROCEDURE.

PROCEDURE tabortnydef_UI:
   DEFINE INPUT PARAMETER TABLE FOR extraopltemp.
   FIND FIRST extraopltemp NO-LOCK NO-ERROR.
   FIND FIRST OVERPRISLISTA WHERE OVERPRISLISTA.EQDAG = extraopltemp.EQDAG AND
   OVERPRISLISTA.START = extraopltemp.START AND OVERPRISLISTA.SLUT = extraopltemp.SLUT AND 
   OVERPRISLISTA.BEFATTNING = extraopltemp.BEFATTNING EXCLUSIVE-LOCK NO-ERROR.
   IF AVAILABLE OVERPRISLISTA THEN DELETE OVERPRISLISTA.
END PROCEDURE.

/********************************** DEFKUNDO.W **********************************/

PROCEDURE laddaotextpris_UI:
   DEFINE INPUT PARAMETER defprisid AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR otextpristemp.
   EMPTY TEMP-TABLE otextpristemp NO-ERROR.    
   OPEN QUERY oq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = defprisid NO-LOCK,
   EACH OVERTEXTFAKT WHERE OVERTEXTFAKT.OTEXTID = OVERPRISLISTA.OTEXTID NO-LOCK.
   GET FIRST oq NO-LOCK.
   DO WHILE AVAILABLE(OVERPRISLISTA):
      CREATE otextpristemp.
      BUFFER-COPY OVERPRISLISTA TO otextpristemp.
      otextpristemp.OTEXT = OVERTEXTFAKT.OTEXT.
      GET NEXT oq NO-LOCK.
   END.   
END PROCEDURE.


PROCEDURE kopoverpris_UI:
   DEFINE INPUT PARAMETER franprisid AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tillprisid AS CHARACTER NO-UNDO.
   DEFINE BUFFER kundobuff FOR OVERPRISLISTA.
   OPEN QUERY tq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = tillprisid NO-LOCK.
   DO TRANSACTION:
      GET FIRST tq EXCLUSIVE-LOCK.
      DO WHILE AVAILABLE(OVERPRISLISTA):
         DELETE OVERPRISLISTA.
         GET NEXT tq EXCLUSIVE-LOCK.
      END.
   END.
   OPEN QUERY fq FOR EACH OVERPRISLISTA WHERE OVERPRISLISTA.PRISID = franprisid NO-LOCK.
   GET FIRST fq NO-LOCK.
   DO WHILE AVAILABLE(OVERPRISLISTA):
      DO TRANSACTION:
         CREATE  kundobuff.
         BUFFER-COPY OVERPRISLISTA TO kundobuff.
         kundobuff.PRISID = tillprisid.         
      END.
      GET NEXT fq NO-LOCK.
   END.   
END PROCEDURE.
