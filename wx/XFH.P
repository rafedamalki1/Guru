OPEN QUERY fpq FOR EACH FAKTPLAN WHERE FAKTPLAN.HANVANDARE = "" NO-LOCK.
   gET first fpq no-LOCK.   
do while available(FAKTPLAN):         
  
   FIND FIRST FAKTAONR WHERE FAKTAONR.FAKTNR = FAKTPLAN.FAKTNR NO-LOCK NO-ERROR.
   IF AVAILABLE FAKTAONR THEN DO transaction:
       
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = FAKTAONR.AONR AND
      AONRTAB.DELNR = FAKTAONR.DELNR EXCLUSIVE-LOCK NO-ERROR.
      get current fpq exclusive-lock. 
      IF AVAILABLE AONRTAB THEN DO:
         IF AONRTAB.ANVANDARE NE "" THEN DO:
            ASSIGN 
            FAKTPLAN.HANVANDARE = AONRTAB.ANVANDARE.
         END.     
         ELSE DO:
            ASSIGN 
            AONRTAB.ANVANDARE = FAKTPLAN.ANVANDARE.
            FAKTPLAN.HANVANDARE = FAKTPLAN.ANVANDARE.
         END.         
      END.      
      MESSAGE FAKTPLAN.FAKTNR FAKTPLAN.ANVANDARE FAKTPLAN.HANVANDARE.
   END.      
   gET next fpq no-LOCK.   
END.
