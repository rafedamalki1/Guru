/*VSABEDI.P*/
DEFINE VARIABLE N1 AS INTEGER.
DEFINE VARIABLE N2 AS INTEGER.
DEFINE VARIABLE N3 AS INTEGER.
DEFINE VARIABLE N4 AS INTEGER.
DEFINE VARIABLE S1 AS INTEGER.
DEFINE VARIABLE S2 AS INTEGER.
DEFINE VARIABLE S3 AS INTEGER.
DEFINE VARIABLE S4 AS INTEGER.
DEFINE TEMP-TABLE btemp
   FIELD BERNR AS INTEGER
   FIELD OMRADE AS CHARACTER
   FIELD SUMMA AS DECIMAL.   
DEFINE TEMP-TABLE bmtemp
   FIELD ENR AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD LEVKOD AS CHARACTER
   FIELD ANTAL AS INTEGER   
   FIELD PRIS AS DECIMAL
   FIELD SUMMA AS DECIMAL
   INDEX ENR ENR .   
{AMERICANEUROPEAN.I}
FOR EACH BESTSTAT WHERE YEAR(BESTSTAT.DATUM) = 2008 AND BESTSTAT.BERNR > 0  /*AND BESTSTAT.BESTNR = 0*/ AND BESTSTAT.BESTALLD = "Elektroniskt beställd": /*AND BESTSTAT.OMRADE = "TEV7"*/
   FIND FIRST btemp WHERE btemp.BERNR = BESTSTAT.BERNR AND btemp.OMRADE = BESTSTAT.OMRADE NO-LOCK NO-ERROR.
   IF NOT AVAILABLE btemp THEN DO:
      CREATE btemp.
      ASSIGN
      btemp.BERNR = BESTSTAT.BERNR
      btemp.OMRADE = BESTSTAT.OMRADE.
   END.
END.
FOR EACH btemp:
   OPEN QUERY mq FOR EACH BERMTRL WHERE BERMTRL.AONR = STRING(btemp.BERNR) AND
   BERMTRL.OMRADE = btemp.OMRADE AND BERMTRL.INKOP = TRUE AND BERMTRL.KLAR = TRUE AND
   (BERMTRL.LEVKOD = "16" OR BERMTRL.LEVKOD = "17")  NO-LOCK.
   GET FIRST MQ NO-LOCK.
   DO WHILE AVAILABLE(BERMTRL):
      FIND FIRST bmtemp WHERE bmtemp.ENR = BERMTRL.ENR AND bmtemp.LEVKOD = BERMTRL.LEVKOD NO-ERROR.
      IF NOT AVAILABLE bmtemp  THEN DO:
         CREATE bmtemp. 
         FIND FIRST MTRL  WHERE MTRL.LEVKOD = BERMTRL.LEVKOD AND MTRL.ENR = BERMTRL.ENR AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
         IF AVAILABLE MTRL THEN DO:
            ASSIGN
            bmtemp.PRIS = MTRL.NPRIS
            bmtemp.BENAMNING = MTRL.BENAMNING.
         END.
      END.
      ASSIGN
      bmtemp.ENR = BERMTRL.ENR
      bmtemp.LEVKOD = BERMTRL.LEVKOD
      bmtemp.ANTAL = bmtemp.ANTAL + BERMTRL.ANTAL      
      bmtemp.SUMMA = bmtemp.SUMMA + (BERMTRL.PRIS * BERMTRL.ANTAL).
      GET NEXT MQ NO-LOCK.
   END.
END.
OUTPUT TO c:\vsabm2008.txt.
FOR EACH bmtemp USE-INDEX ENR NO-LOCK:
   DISP bmtemp.ENR bmtemp.BENAMNING bmtemp.ANTAL bmtemp.PRIS bmtemp.SUMMA FORMAT ">>>>>>>9.99" bmtemp.LEVKOD.
   
END.
OUTPUT CLOSE.
{EUROPEANAMERICAN.I}
   /*
   OUTPUT TO e:\delad\pro9\guru\vsabedi2.txt APPEND.
   PUT STRING(btemp.BERNR) " " btemp.SUMMA FORMAT "9999999.99" SKIP.
   OUTPUT CLOSE.
   */
   /*FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE=  btemp.OMRADE NO-LOCK NO-ERROR.
   IF AVAILABLE OMRADETAB THEN DO:
      IF OMRADETAB.AVDELNINGNR >= 9 THEN DO:
         IF btemp.SUMMA <= 100000 THEN N1 = N1 + 1.
         ELSE IF btemp.SUMMA > 100000 AND btemp.SUMMA <= 300000 THEN N2 = N2 + 1.
         ELSE IF btemp.SUMMA > 300000 AND btemp.SUMMA <= 500000 THEN N3 = N3 + 1.
         ELSE N4 = N4 + 1.         
      END.
      ELSE DO:
         IF btemp.SUMMA <= 100000 THEN S1 = S1 + 1.
         ELSE IF btemp.SUMMA > 100000 AND btemp.SUMMA <= 300000 THEN S2 = S2 + 1.
         ELSE IF btemp.SUMMA > 300000 AND btemp.SUMMA <= 500000 THEN S3 = S3 + 1.
         ELSE S4 = S4 + 1.
      END.
   END.
END.

OUTPUT TO e:\delad\pro9\guru\vsabedi.txt APPEND.
PUT "N1 " N1 " N2 " N2 " N3 " N3 " N4 " N4 " S1 " S1 " S2 " S2 " S3 " S3 " S4 " S4 SKIP.
OUTPUT CLOSE.*/
