{SOKDEF.I}
DEFINE BUFFER pbuff FOR PERSONALTAB.
OUTPUT TO D:\delad\server\PRO9S\PPRISFEL.txt .
FOR EACH PERSONALTAB WHERE PERSONALTAB.AKTIV = TRUE NO-LOCK,
EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.VECKOKORD = "W20060206" NO-LOCK.
   {SOKSTART.I}
   ASSIGN
   soktemp.SOKVAL = 1
   soktemp.SOKINT[1] = 1
   soktemp.SOKCHAR[2] = PERSONALTAB.PERSONALKOD
   soktemp.SOKCHAR[3] = 'TOT.PRIS.'
   soktemp.SOKCHAR[4] = TIDREGITAB.OVERTIDTILL 
   soktemp.SOKDATE[1] = TIDREGITAB.DATUM.

   IF soktemp.SOKCHAR[4] = "" THEN DO:
      FIND FIRST pbuff WHERE 
      pbuff.PERSONALKOD = soktemp.SOKCHAR[2] 
      NO-LOCK NO-ERROR.         
      soktemp.SOKCHAR[4] = pbuff.BEFATTNING.
   END.
   IF soktemp.SOKCHAR[3] = "FRÅNVARO." OR soktemp.SOKCHAR[3] = "RESTID..." THEN DO:
      FIND FIRST PERSONALPRIS WHERE 
      PERSONALPRIS.PERSONALKOD = soktemp.SOKCHAR[2] AND
      PERSONALPRIS.BEFATTNING = soktemp.SOKCHAR[3] AND 
      PERSONALPRIS.STARTDATUM <= soktemp.SOKDATE[1]  
      AND PERSONALPRIS.SLUTDATUM >= soktemp.SOKDATE[1] 
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE PERSONALPRIS THEN DO:
         FIND LAST PERSONALPRIS WHERE 
         PERSONALPRIS.PERSONALKOD = soktemp.SOKCHAR[2] AND
         PERSONALPRIS.BEFATTNING = soktemp.SOKCHAR[3] 
         USE-INDEX PSTART NO-LOCK NO-ERROR.
      END.
      IF NOT AVAILABLE PERSONALPRIS THEN DO:
         DISPLAY "A" soktemp.SOKCHAR[2] soktemp.SOKCHAR[3] soktemp.SOKDATE[1] soktemp.SOKCHAR[4].
      END.
      ELSE DO:      
         soktemp.SOKDECI[1] = PERSONALPRIS.PRIS.  
      END.
   END.
   ELSE DO:
      FIND FIRST PERSONALPRIS WHERE 
      PERSONALPRIS.PERSONALKOD = soktemp.SOKCHAR[2] AND
      PERSONALPRIS.BEFATTNING = soktemp.SOKCHAR[4] AND 
      PERSONALPRIS.STARTDATUM <= soktemp.SOKDATE[1]  AND 
      PERSONALPRIS.SLUTDATUM >= soktemp.SOKDATE[1] 
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE PERSONALPRIS THEN DO:
         FIND LAST PERSONALPRIS WHERE 
         PERSONALPRIS.PERSONALKOD = soktemp.SOKCHAR[2] AND
         PERSONALPRIS.BEFATTNING = soktemp.SOKCHAR[4] 
         USE-INDEX PSTART NO-LOCK NO-ERROR.
      END.
      IF NOT AVAILABLE PERSONALPRIS THEN DO:
         DISPLAY "B" soktemp.SOKCHAR[2] soktemp.SOKCHAR[3] soktemp.SOKDATE[1] soktemp.SOKCHAR[4].
      END.
      ELSE DO:      
         soktemp.SOKDECI[1] = PERSONALPRIS.PRIS.  
      END.
   END.

END.
