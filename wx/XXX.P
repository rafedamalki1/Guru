
/*FAKUPPAR.p*/
DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE VARIABLE musz AS LOGICAL NO-UNDO.

OPEN QUERY fpq FOR EACH FAKTPLAN WHERE FAKTPLAN.SLUTFAKT = FALSE AND 
FAKTPLAN.FAKTTYP = "Takprisfakt." AND
FAKTPLAN.FAKTTYPUNDER = 4 NO-LOCK,
EACH FAKTAONR WHERE FAKTAONR.FAKTNR = FAKTPLAN.FAKTNR NO-LOCK. 
RUN kost_UI.

PROCEDURE kost_UI.
   GET FIRST fpq NO-LOCK.
   DO WHILE AVAILABLE(FAKTAONR): 
      musz = TRUE.
      IF FAKTPLAN.FAKTTYPUNDER = 4 THEN DO:
         FIND FIRST FAKTUPPARB WHERE FAKTUPPARB.FAKTNR = FAKTPLAN.FAKTNR AND
         FAKTUPPARB.AONR = FAKTAONR.AONR AND FAKTUPPARB.DELNR = FAKTAONR.DELNR AND
         FAKTUPPARB.KRITERIUM = "SLUT" NO-LOCK NO-ERROR.
         IF AVAILABLE FAKTUPPARB THEN DO:
            IF FAKTUPPARB.FAKTURERAD = TRUE THEN musz = FALSE.
         END.
      END.
      IF musz = FALSE THEN DO:
         IF FAKTPLAN.FAKTTYPUNDER = 4 THEN RUN uparbtyp4_UI (INPUT FAKTAONR.AONR, INPUT FAKTAONR.DELNR).
      END.
      
      GET NEXT fpq NO-LOCK.
   END.
END PROCEDURE.
PROCEDURE uparbtyp4_UI :
   DEFINE INPUT PARAMETER aonrvar LIKE AONRTAB.AONR NO-UNDO.
   DEFINE INPUT PARAMETER delnrvar LIKE AONRTAB.DELNR NO-UNDO.
   DEFINE VARIABLE tidfaktbelopp AS DECIMAL NO-UNDO.
   DEFINE VARIABLE nyttbeloppvar AS DECIMAL NO-UNDO.
   DEFINE VARIABLE totaltupparbbeloppvar AS DECIMAL NO-UNDO.
   DEFINE VARIABLE takbelopp AS DECIMAL NO-UNDO.  
   /*HUR MYCKET ÄR FAKTURERAT*/
   tidfaktbelopp = 0.
   OPEN QUERY fuppq FOR EACH FAKTUPPARB WHERE FAKTUPPARB.FAKTNR = FAKTPLAN.FAKTNR AND
   FAKTUPPARB.AONR = aonrvar AND FAKTUPPARB.DELNR = delnrvar AND
   FAKTUPPARB.FAKTURERAD = TRUE NO-LOCK. 
   GET FIRST fuppq NO-LOCK.         
   DO WHILE AVAILABLE(FAKTUPPARB):
      ASSIGN
      tidfaktbelopp = tidfaktbelopp + FAKTUPPARB.FAKTBELOPP.         
      GET NEXT fuppq NO-LOCK.
   END.      
   IF FAKTAONR.OPRIS > tidfaktbelopp THEN DO: 
       CREATE FAKTUPPARB.
      ASSIGN
      FAKTUPPARB.FAKTURERAD = FALSE            
      FAKTUPPARB.FULL = FALSE
      FAKTUPPARB.FAKTNR = FAKTPLAN.FAKTNR
      FAKTUPPARB.AONR = aonrvar  
      FAKTUPPARB.DELNR = delnrvar         
      FAKTUPPARB.FAKTBELOPP = FAKTAONR.OPRIS - tidfaktbelopp.
      DISPLAY FAKTPLAN.FAKTNR  aonrvar delnrvar FAKTAONR.OPRIS tidfaktbelopp FAKTUPPARB.FAKTBELOPP
      WITH FRAME CC.
      DOWN 1 WITH FRAME CC.
   END.
   
END PROCEDURE.
