/*PLOCKEXCAPP.P*/
{STARTFORAPP.I}
&Scoped-define NEW 
&Scoped-define SHARED 
{BEREDNINGTEMP.I}
{ANVPERS.I}
DEFINE VARIABLE globanvpkod AS CHARACTER NO-UNDO.
DEFINE TEMP-TABLE mtrl_temp2   
   {MTRLTEMP2TT.I}
DEFINE TEMP-TABLE emtrl_temp2 LIKE mtrl_temp2.

PROCEDURE hamta_UI:
   DEFINE INPUT PARAMETER globanvpkod2 AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER valaonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER valomrade AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER aonrvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER delnrvar AS INTEGER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR beredningtemp.
   DEFINE OUTPUT PARAMETER TABLE FOR personaltemp.
   DEFINE OUTPUT PARAMETER TABLE FOR anvandartemp.
   DEFINE OUTPUT PARAMETER sokpkod AS CHARACTER NO-UNDO.
   globanvpkod = globanvpkod2.
   EMPTY TEMP-TABLE beredningtemp NO-ERROR. 
   EMPTY TEMP-TABLE personaltemp NO-ERROR. 
   EMPTY TEMP-TABLE anvandartemp NO-ERROR. 

   FIND FIRST BEREDNING WHERE BEREDNING.BERNR = INTEGER(valaonr) AND 
   BEREDNING.OMRADE = valomrade USE-INDEX BERNR NO-LOCK NO-ERROR. 
   IF AVAILABLE BEREDNING THEN DO:
      CREATE beredningtemp.
      BUFFER-COPY BEREDNING TO beredningtemp.
   END.
   
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = globanvpkod
   NO-LOCK NO-ERROR.
   IF AVAILABLE PERSONALTAB THEN DO:
      FIND FIRST BEREDAONR WHERE BEREDAONR.PERSONALKOD = globanvpkod
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
      IF NOT AVAILABLE BEREDAONR THEN DO TRANSACTION:
         CREATE BEREDAONR.
         ASSIGN
         BEREDAONR.PERSONALKOD = PERSONALTAB.PERSONALKOD
         BEREDAONR.FORNAMN = PERSONALTAB.FORNAMN
         BEREDAONR.EFTERNAMN = PERSONALTAB.EFTERNAMN.         
      END.
      sokpkod = PERSONALTAB.PERSONALKOD.
      CREATE personaltemp.
      BUFFER-COPY PERSONALTAB TO personaltemp.
      Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + PERSONALTAB.PERSONALKOD.
      RELEASE BEREDAONR NO-ERROR.
   END.
   FIND FIRST ANVANDARE WHERE ANVANDARE.ANVANDARE = BEREDNING.ANVANDARE
   USE-INDEX ANDV NO-LOCK NO-ERROR.
   IF AVAILABLE ANVANDARE THEN DO:  
      CREATE anvandartemp.
      BUFFER-COPY ANVANDARE TO anvandartemp.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = ANVANDARE.PERSONALKOD
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
      IF AVAILABLE PERSONALTAB THEN DO:
         sokpkod = PERSONALTAB.PERSONALKOD. 
         CREATE personaltemp.
         BUFFER-COPY PERSONALTAB TO personaltemp.
         Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + PERSONALTAB.PERSONALKOD.
      END.
   END.
   IF BEREDNING.AONR NE ? THEN DO:
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = BEREDNING.AONR AND
      AONRTAB.DELNR = BEREDNING.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF AVAILABLE AONRTAB THEN DO:
         ASSIGN
         aonrvar = AONRTAB.AONR
         delnrvar = AONRTAB.DELNR.
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = AONRTAB.BEREDARE
         NO-LOCK NO-ERROR.
         IF AVAILABLE PERSONALTAB THEN DO:
            sokpkod = PERSONALTAB.PERSONALKOD.
            CREATE personaltemp.
            BUFFER-COPY PERSONALTAB TO personaltemp.
            Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + PERSONALTAB.PERSONALKOD.
         END.   
      END.
   END.
   
   {GDPRLOGGCLIENT.I}
   RETURN.

END PROCEDURE.

PROCEDURE enrcheck_UI:
   DEFINE INPUT PARAMETER TABLE FOR  emtrl_temp2.
   DEFINE OUTPUT PARAMETER finnsenr AS CHARACTER   NO-UNDO.   
   finnsenr = "".
   FIND FIRST emtrl_temp2  WHERE NO-LOCK NO-ERROR.
   FIND FIRST MTRL WHERE MTRL.LEVKOD = emtrl_temp2.LEVKOD AND MTRL.KALKNR = 0 AND MTRL.ENR = emtrl_temp2.ENR NO-LOCK NO-ERROR.
   IF NOT AVAILABLE MTRL THEN finnsenr = "Finns ej hos lev".
   /*dummy*/
   FIND FIRST emtrl_temp2  WHERE NO-LOCK NO-ERROR.
     
   
END PROCEDURE.
