DEFINE VARIABLE NYTTNR AS INTEGER NO-UNDO.
OPEN QUERY lq FOR EACH LEVTRP WHERE BERNR NE 0 NO-LOCK BY BERNR.
GET FIRST lq NO-LOCK.
DO WHILE AVAILABLE(levtrp):   
   FIND FIRST bermtrl WHERE bermtrl.aonr = STRING(levtrp.BERNR) AND 
   bermtrl.omrade = levtrp.OMRADE AND BERMTRL.INKOP = TRUE 
   USE-INDEX DATUM NO-LOCK NO-ERROR.
   IF AVAILABLE BERMTRL THEN DO:  
      /*DISPLAY LEVTRP.BERNR LEVTRP.OMRADE LEVTRP.LEVKOD BERMTRL.DATUM LEVTRP.BESTALLD.*/

      FIND LAST LEVTRP2 WHERE LEVTRP2.OMRADE = LEVTRP.OMRADE AND
      LEVTRP2.BERNR = LEVTRP.BERNR USE-INDEX NR NO-LOCK NO-ERROR.
      IF AVAILABLE LEVTRP2 THEN DO TRANSACTION:
         nyttnr = LEVTRP2.BESTNR + 1.
         CREATE LEVTRP2.               
         ASSIGN
         LEVTRP2.BERNR = LEVTRP.BERNR
         LEVTRP2.OMRADE = LEVTRP.OMRADE
         LEVTRP2.LEVKOD = LEVTRP.LEVKOD
         LEVTRP2.DATUM = BERMTRL.DATUM
         LEVTRP2.BESTNR = nyttnr
         LEVTRP2.BESTALLD = LEVTRP.BESTALLD.
      END.   
      ELSE DO TRANSACTION:
         CREATE LEVTRP2.
         ASSIGN         
         LEVTRP2.BERNR = LEVTRP.BERNR
         LEVTRP2.OMRADE = LEVTRP.OMRADE
         LEVTRP2.LEVKOD = LEVTRP.LEVKOD
         LEVTRP2.DATUM = BERMTRL.DATUM
         LEVTRP2.BESTNR = 1
         LEVTRP2.BESTALLD = LEVTRP.BESTALLD.         
      END.               
   END.
   GET NEXT LQ NO-LOCK.
END.   
