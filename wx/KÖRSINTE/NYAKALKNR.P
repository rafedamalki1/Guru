/*NYAKALKNR.P*/
DEFINE VARIABLE NRVAR AS INTEGER.   
OPEN QUERY kq FOR EACH FASTSPEC WHERE FASTSPEC.OMRADE = "TEÖ5" USE-INDEX aonr NO-LOCK. 
GET FIRST kq NO-LOCK.   
IF FASTSPEC.KALKNR NE 0 THEN DO:   
   DO TRANSACTION:      
      FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = FASTSPEC.OMRADE 
      USE-INDEX OMR EXCLUSIVE-LOCK NO-ERROR.      
      ASSIGN                 
      nrvar = OMRADETAB.KALKYLSIST.
      ASSIGN OMRADETAB.KALKYLSIST = OMRADETAB.KALKYLSIST + 1. 
   END.
   RUN UPDATE_UI.
   DO TRANSACTION:
      GET CURRENT kq EXCLUSIVE-LOCK.
      FASTSPEC.KALKNR = nrvar.
   END.
END.
REPEAT:
   GET NEXT kq NO-LOCK.
   IF AVAILABLE FASTSPEC THEN DO:         
      IF FASTSPEC.KALKNR NE 0 THEN DO:   
         DO TRANSACTION:      
            FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = FASTSPEC.OMRADE 
            USE-INDEX OMR EXCLUSIVE-LOCK NO-ERROR.      
            ASSIGN                 
            nrvar = OMRADETAB.KALKYLSIST.
            ASSIGN OMRADETAB.KALKYLSIST = OMRADETAB.KALKYLSIST + 1. 
         END.
         RUN UPDATE_UI.
         DO TRANSACTION:
            GET CURRENT kq EXCLUSIVE-LOCK.
            FASTSPEC.KALKNR = nrvar.
         END.
      END.
   END.
   ELSE LEAVE.
END.
CLOSE QUERY kq.
PROCEDURE UPDATE_UI :
   OPEN QUERY kkq FOR EACH FASTKALK WHERE FASTKALK.OMRADE = FASTSPEC.OMRADE AND
   FASTKALK.KALKNR = FASTSPEC.KALKNR NO-LOCK.
   DO TRANSACTION:       
      GET FIRST kkq EXCLUSIVE-LOCK.
      IF AVAILABLE FASTKALK THEN FASTKALK.KALKNR = nrvar.
   END.
   REPEAT:  
      DO TRANSACTION:
         GET NEXT kkq EXCLUSIVE-LOCK.
         IF AVAILABLE FASTKALK THEN FASTKALK.KALKNR = nrvar.    
         ELSE LEAVE.      
      END.         
   END.   
   CLOSE QUERY kkq.
   IF FASTSPEC.KALKNR NE 0 THEN DO:
      OPEN QUERY befq FOR EACH KALKBEF WHERE KALKBEF.OMRADE = FASTSPEC.OMRADE AND
      KALKBEF.KALKNR = FASTSPEC.KALKNR USE-INDEX OMRADE NO-LOCK.
      DO TRANSACTION:
         GET FIRST befq EXCLUSIVE-LOCK.
         IF AVAILABLE KALKBEF THEN KALKBEF.KALKNR = nrvar.
      END.
      REPEAT:   
         DO TRANSACTION:     
            GET NEXT befq EXCLUSIVE-LOCK.
            IF AVAILABLE KALKBEF THEN KALKBEF.KALKNR = nrvar.
            ELSE LEAVE.
         END.   
      END.      
      CLOSE QUERY befq.   
   END.      
   IF FASTSPEC.FAKTOR = TRUE THEN DO TRANSACTION:
      FIND FIRST FAKTOR WHERE FAKTOR.OMRADE = FASTSPEC.OMRADE AND
      FAKTOR.KALKNR = FASTSPEC.KALKNR USE-INDEX OMRADE EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE FAKTOR THEN FAKTOR.KALKNR = nrvar.
   END. 
   DO TRANSACTION:      
      FIND FIRST KALKUPP WHERE KALKUPP.KALKNR = FASTSPEC.KALKNR
      USE-INDEX KALKNR EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KALKUPP THEN KALKUPP.KALKNR = nrvar.        
   END.
   IF FASTSPEC.EGETMTRL = TRUE THEN DO:
      IF FASTSPEC.KALKNR NE 0 THEN DO:
         OPEN QUERY mtrlq FOR EACH MTRL WHERE MTRL.KALKNR = FASTSPEC.KALKNR 
         USE-INDEX KALK NO-LOCK.
         DO TRANSACTION:
            GET FIRST mtrlq EXCLUSIVE-LOCK.
            IF AVAILABLE MTRL THEN MTRL.KALKNR = nrvar.
         END.
         REPEAT:   
            DO TRANSACTION:
               GET NEXT mtrlq EXCLUSIVE-LOCK.
               IF AVAILABLE MTRL THEN MTRL.KALKNR = nrvar.          
               ELSE LEAVE.                                        
            END.   
         END.
         CLOSE QUERY mtrlq.
      END.  
   END.
   OPEN QUERY forq FOR EACH KALKFOR WHERE KALKFOR.KALKNR = FASTSPEC.KALKNR 
   NO-LOCK.
   DO TRANSACTION:
      GET FIRST forq EXCLUSIVE-LOCK.
      IF AVAILABLE KALKFOR THEN KALKFOR.KALKNR = nrvar.
   END.
   REPEAT:   
      DO TRANSACTION:
         GET NEXT forq EXCLUSIVE-LOCK.
         IF AVAILABLE KALKFOR THEN KALKFOR.KALKNR = nrvar.          
         ELSE LEAVE.                                        
      END.   
   END.
   CLOSE QUERY forq.
   DO TRANSACTION:
      FIND FIRST KALKKUND WHERE KALKKUND.KALKNR = FASTSPEC.KALKNR
      USE-INDEX KALKNR EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KALKKUND THEN KALKKUND.KALKNR = nrvar.
   END.

   DO TRANSACTION:   
      FIND FIRST KALKAONR WHERE KALKAONR.KALKNR = FASTSPEC.KALKNR
      EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KALKAONR THEN KALKAONR.KALKNR = nrvar.
   END.
END PROCEDURE.
