/*ANDGODAP.P*/
&Scoped-define NEW NEW
{TIDPERS.I}
{GODTEMP.I}
DEFINE INPUT PARAMETER regar AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER regmnr AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER regvnr AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER globanv AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER TABLE FOR tidpers.
DEFINE OUTPUT PARAMETER TABLE FOR godmarkpers.
FIND FIRST ANVANDARE WHERE ANVANDARE.ANVANDARE = globanv USE-INDEX ANDV NO-LOCK NO-ERROR.
FOR EACH tidpers USE-INDEX PERSONALKOD:               
   IF Guru.Konstanter:globanv = CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79)   THEN Guru.Konstanter:globanv = Guru.Konstanter:globanv.
   ELSE IF tidpers.PERSONALKOD = ANVANDARE.PERSONALKOD THEN NEXT.
      
   FIND FIRST GODKOLL WHERE 
   GODKOLL.PERSONALKOD = tidpers.PERSONALKOD AND               
   GODKOLL.DATAR = regar AND GODKOLL.DATMAN = regmnr                  
   USE-INDEX PKODAR NO-LOCK NO-ERROR.
   IF NOT AVAILABLE GODKOLL THEN NEXT.
   ELSE DO:          
      FIND FIRST TIDREGITAB WHERE 
      TIDREGITAB.PERSONALKOD = tidpers.PERSONALKOD AND
      YEAR(TIDREGITAB.DATUM) = regar AND 
      MONTH(TIDREGITAB.DATUM) = regmnr AND
      TIDREGITAB.GODKAND NE '' AND TIDREGITAB.VECKOKORD = ""   
      NO-LOCK NO-ERROR. 
      
      CREATE godmarkpers.
      ASSIGN            
      godmarkpers.VECKONUMMER = regvnr
      godmarkpers.EFTERNAMN = tidpers.EFTERNAMN
      godmarkpers.FORNAMN = tidpers.FORNAMN
      godmarkpers.PERSONALKOD = tidpers.PERSONALKOD
      godmarkpers.GODKAND = "G" + STRING(GODKOLL.VECKONUMMER,"999")    
      godmarkpers.TIDPERSREC = tidpers.TIDPERSREC.
   END.                                      
END. 
