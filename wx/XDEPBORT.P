/*XDEPBORT.P*/
DEFINE VARIABLE depnr AS INTEGER NO-UNDO.
DEFINE VARIABLE bestallnr AS INTEGER NO-UNDO. 
DEFINE TEMP-TABLE best_nr NO-UNDO
    FIELD bestnr LIKE BESTDEP.Bestnr
    INDEX NR bestnr DESCENDING. 

depnr = 40.    
 FOR EACH BESTDEP WHERE BESTDEP.DEPNR = depnr  USE-INDEX BEST NO-LOCK:
    FIND FIRST best_nr WHERE best_nr.bestnr = BESTDEP.Bestnr NO-ERROR.
    IF NOT AVAILABLE best_nr  THEN DO:
       CREATE best_nr.
       ASSIGN best_nr.bestnr =  BESTDEP.Bestnr.
    END.
 END.   
         
  
FOR EACH best_nr USE-INDEX nr:      
   OPEN QUERY bestq FOR EACH BESTDEP WHERE BESTDEP.DEPNR = depnr AND 
   BESTDEP.BESTNR = best_nr.bestnr USE-INDEX BEST NO-LOCK.     
   GET FIRST bestq NO-LOCK.
   DO WHILE AVAILABLE(BESTDEP):
      DO TRANSACTION:
         GET CURRENT bestq EXCLUSIVE-LOCK. 
         DELETE BESTDEP. 
      END.        
      GET NEXT bestq NO-LOCK. 
   END.
   CLOSE QUERY bestq.
    
   OPEN QUERY trpq FOR EACH LEVTRP WHERE LEVTRP.DEP-NR = depnr AND
   LEVTRP.BESTNR = best_nr.bestnr AND LEVTRP.BERNR = 0 NO-LOCK.
   GET FIRST trpq NO-LOCK.
   DO WHILE AVAILABLE(LEVTRP):
      DO TRANSACTION:
         GET CURRENT trpq EXCLUSIVE-LOCK. 
         DELETE LEVTRP. 
      END.
      GET NEXT trpq NO-LOCK.
   END.
   CLOSE QUERY trpq.
  
   OPEN QUERY statq FOR EACH BESTSTAT WHERE BESTSTAT.DEP-NR = depnr AND
   BESTSTAT.BESTNR = best_nr.bestnr AND BESTSTAT.BERNR = 0 NO-LOCK.
   GET FIRST statq NO-LOCK.
   DO WHILE AVAILABLE(BESTSTAT):
      DO TRANSACTION:
         GET CURRENT statq EXCLUSIVE-LOCK. 
         DELETE BESTSTAT. 
      END.
      GET NEXT statq NO-LOCK.
   END.
   CLOSE QUERY statq.
END.   
RELEASE BESTSTAT NO-ERROR.
RELEASE LEVTRP NO-ERROR.
RELEASE BESTDEP NO-ERROR.
