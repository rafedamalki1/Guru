DEFINE NEW SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.
DEFINE NEW SHARED VARIABLE globlos LIKE ANVANDARE.AV-LOSEN NO-UNDO.
DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE NEW SHARED VARIABLE plusaonr LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE NEW SHARED VARIABLE plusdnr LIKE TIDREGITAB.DELNR NO-UNDO.
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
globforetag = FORETAG.FORETAG. 
RUN namn_UI.
RUN namnd_UI.
PROCEDURE namn_UI:
   NAMN1:
   FOR EACH PERSONALTAB USE-INDEX PERSONALKOD NO-LOCK:                                                
      IF globforetag = "NORD" THEN DO:
         FIND FIRST TIMKOSTNADSTAB WHERE 
         TIMKOSTNADSTAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
         TIMKOSTNADSTAB.PRISTYP = "INTERNPRI" USE-INDEX PRISPERS NO-LOCK NO-ERROR.
      END.   
      DO TRANSACTION:
         FIND FIRST SUMTID WHERE 
         SUMTID.PERSONALKOD = PERSONALTAB.PERSONALKOD 
         USE-INDEX PERSONALKOD EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTID THEN NEXT NAMN1.
         ELSE DO:
            ASSIGN 
            SUMTID.FORNAMN = PERSONALTAB.FORNAMN 
            SUMTID.EFTERNAMN = PERSONALTAB.EFTERNAMN
            SUMTID.OMRADE = PERSONALTAB.OMRADE
            SUMTID.BEFATTNING = PERSONALTAB.BEFATTNING 
            SUMTID.PERSMASK = PERSONALTAB.PERSMASK.  
            IF AVAILABLE TIMKOSTNADSTAB THEN DO:
               ASSIGN SUMTID.PRISI = TIMKOSTNADSTAB.PRISA.
            END.                     
            ELSE DO: 
               ASSIGN SUMTID.PRISI =  SUMTID.PRIS.
            END.
         END.
      END.                                      
      NAMN2:
      REPEAT TRANSACTION:
         FIND NEXT SUMTID WHERE  
         SUMTID.PERSONALKOD = PERSONALTAB.PERSONALKOD 
         USE-INDEX PERSONALKOD EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTID THEN LEAVE NAMN2.
         ELSE DO:
            ASSIGN 
            SUMTID.FORNAMN = PERSONALTAB.FORNAMN 
            SUMTID.EFTERNAMN = PERSONALTAB.EFTERNAMN
            SUMTID.OMRADE = PERSONALTAB.OMRADE
            SUMTID.BEFATTNING = PERSONALTAB.BEFATTNING 
            SUMTID.PERSMASK = PERSONALTAB.PERSMASK.
            IF AVAILABLE TIMKOSTNADSTAB THEN DO:
               ASSIGN SUMTID.PRISI = TIMKOSTNADSTAB.PRISA.
            END.                     
            ELSE DO: 
               ASSIGN SUMTID.PRISI =  SUMTID.PRIS.
            END.
         END.
      END.       
   END.                                     
   AONAMN1:
   FOR EACH AONRTAB USE-INDEX AONR NO-LOCK:                                                
      DO TRANSACTION:
         FIND FIRST SUMTID WHERE 
         SUMTID.AONR = AONRTAB.AONR AND
         SUMTID.DELNR = AONRTAB.DELNR
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTID THEN NEXT AONAMN1.
         ELSE DO:
            ASSIGN 
            SUMTID.FASTAAONR = AONRTAB.FASTAAONR          
            SUMTID.GEOMRADE = AONRTAB.OMRADE 
            SUMTID.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = " " THEN ASSIGN SUMTID.OMRADE = SUMTID.OMRADE.
         END.
      END.                                 
      AONAMN2:
      REPEAT TRANSACTION:
         FIND NEXT SUMTID WHERE 
         SUMTID.AONR = AONRTAB.AONR AND
         SUMTID.DELNR = AONRTAB.DELNR
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTID THEN LEAVE AONAMN2.
         ELSE DO :
            ASSIGN           
            SUMTID.FASTAAONR = AONRTAB.FASTAAONR         
            SUMTID.GEOMRADE = AONRTAB.OMRADE 
            SUMTID.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = "" THEN ASSIGN SUMTID.OMRADE = SUMTID.OMRADE.
         END.
      END.       
   END.
END PROCEDURE.   
PROCEDURE namnd_UI.
   NAMN4:	   
   FOR EACH PERSONALTAB USE-INDEX PERSONALKOD NO-LOCK:                                                
      IF globforetag = "NORD" THEN DO:
         FIND FIRST TIMKOSTNADSTAB WHERE 
         TIMKOSTNADSTAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
         TIMKOSTNADSTAB.PRISTYP = "INTERNPRI" USE-INDEX PRISPERS NO-LOCK NO-ERROR.
      END.   
      DO TRANSACTION:
         FIND FIRST SUMTIDDAG WHERE 
         SUMTIDDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD 
         USE-INDEX PERSONALKOD EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTIDDAG THEN NEXT NAMN4.
         ELSE DO :
            ASSIGN 
            SUMTIDDAG.FORNAMN = PERSONALTAB.FORNAMN 
            SUMTIDDAG.EFTERNAMN = PERSONALTAB.EFTERNAMN
            SUMTIDDAG.OMRADE = PERSONALTAB.OMRADE
            SUMTIDDAG.BEFATTNING = PERSONALTAB.BEFATTNING 
            SUMTIDDAG.PERSMASK = PERSONALTAB.PERSMASK.  
            IF AVAILABLE TIMKOSTNADSTAB THEN DO:
               ASSIGN SUMTIDDAG.PRISI = TIMKOSTNADSTAB.PRISA.
            END.                     
            ELSE DO: 
               ASSIGN SUMTIDDAG.PRISI =  SUMTIDDAG.PRIS.
            END.
         END.
      END.
      NAMN5:    
      REPEAT TRANSACTION:
         FIND NEXT SUMTIDDAG WHERE 
         SUMTIDDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD 
         USE-INDEX PERSONALKOD EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTIDDAG THEN LEAVE NAMN5.
         ELSE DO :
            ASSIGN 
            SUMTIDDAG.FORNAMN = PERSONALTAB.FORNAMN 
            SUMTIDDAG.EFTERNAMN = PERSONALTAB.EFTERNAMN
            SUMTIDDAG.OMRADE = PERSONALTAB.OMRADE
            SUMTIDDAG.BEFATTNING = PERSONALTAB.BEFATTNING 
            SUMTIDDAG.PERSMASK = PERSONALTAB.PERSMASK.
            IF AVAILABLE TIMKOSTNADSTAB THEN DO:
               ASSIGN SUMTIDDAG.PRISI = TIMKOSTNADSTAB.PRISA.
            END.                     
            ELSE DO: 
               ASSIGN SUMTIDDAG.PRISI =  SUMTIDDAG.PRIS.
            END.
         END.
      END.       
   END.       
   AONAMN4:
   FOR EACH AONRTAB USE-INDEX AONR NO-LOCK:                                                
      DO TRANSACTION:
         FIND FIRST SUMTIDDAG WHERE 
         SUMTIDDAG.AONR = AONRTAB.AONR AND
         SUMTIDDAG.DELNR = AONRTAB.DELNR
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTIDDAG THEN NEXT AONAMN4.
         ELSE DO :
            ASSIGN 
            SUMTIDDAG.FASTAAONR = AONRTAB.FASTAAONR          
            SUMTIDDAG.GEOMRADE = AONRTAB.OMRADE 
            SUMTIDDAG.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = "" THEN ASSIGN SUMTIDDAG.OMRADE = SUMTIDDAG.OMRADE.
         END.
      END.                                           
      AONAMN5:
      REPEAT TRANSACTION:
         FIND NEXT SUMTIDDAG WHERE 
         SUMTIDDAG.AONR = AONRTAB.AONR AND
         SUMTIDDAG.DELNR = AONRTAB.DELNR
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE SUMTIDDAG THEN LEAVE AONAMN5.
         ELSE DO :
            ASSIGN           
            SUMTIDDAG.FASTAAONR = AONRTAB.FASTAAONR         
            SUMTIDDAG.GEOMRADE = AONRTAB.OMRADE 
            SUMTIDDAG.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = "" THEN ASSIGN SUMTIDDAG.OMRADE = SUMTIDDAG.OMRADE.
         END.
      END.       
   END.           
END PROCEDURE.