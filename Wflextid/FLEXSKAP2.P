/*FLEXSKAP2.P*/

&Scoped-define NEW NEW
{GLOBVAR2DEL1.I}
{FLEXAPPDEF.I} 
{SOKDEF.I}
DEFINE INPUT PARAMETER program AS CHARACTER NO-UNDO.
DEFINE INPUT-OUTPUT PARAMETER TABLE FOR flexapp.
DEFINE OUTPUT PARAMETER TABLE FOR felmeddtemp.
DEFINE NEW SHARED VARIABLE fnytid AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE flexrec AS RECID NO-UNDO.   
DEFINE NEW SHARED VARIABLE fldrec AS RECID NO-UNDO.  
DEFINE NEW SHARED VARIABLE flexpers AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE aonrrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE aonummer AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE delnummer AS INTEGER NO-UNDO.   
DEFINE NEW SHARED VARIABLE valaonrrec AS RECID NO-UNDO. 
DEFINE NEW SHARED VARIABLE ovut AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE ovkoll AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE regstart AS DECIMAL NO-UNDO. 
DEFINE NEW SHARED VARIABLE regslut AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE onr AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE onr2 AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE dnr2 AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE dnr AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE tid AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE tra AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE typ AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE tpris AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE tid3 AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE manad AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE frustarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE fruslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffestart AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffeslut AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchstarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE regtotalt AS DECIMAL NO-UNDO.   
DEFINE NEW SHARED VARIABLE regstartsek AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE regslutsek AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE bustart3 AS DECIMAL NO-UNDO. 
DEFINE NEW SHARED VARIABLE vaxla AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE perssokrec AS RECID NO-UNDO. 
DEFINE NEW SHARED VARIABLE tidtabrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE tidtabrec2 AS RECID NO-UNDO.  
DEFINE NEW SHARED VARIABLE tidsedrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE tidsedlog AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE andvisrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE anvrec AS RECID NO-UNDO. 
DEFINE NEW SHARED VARIABLE persrec2 AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE muszval AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE vartgamla AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE NEW SHARED VARIABLE andvisvnr AS INTEGER FORMAT "999" NO-UNDO.  
DEFINE NEW SHARED VARIABLE aonrrec2 AS RECID NO-UNDO.
/*
DEFINE NEW SHARED VARIABLE printer AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE printer1 AS CHARACTER NO-UNDO.
*/
DEFINE NEW SHARED VARIABLE skrivut AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.        
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE bdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE avdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE bilforare AS LOGICAL FORMAT "JA/NEJ" NO-UNDO.
DEFINE NEW SHARED VARIABLE enflerdygns AS LOGICAL FORMAT "ENDAGS/FLERDYGNS" NO-UNDO.
DEFINE NEW SHARED VARIABLE vart AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE klocka AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE vartpro AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE NEW SHARED VARIABLE valkalknr AS INTEGER NO-UNDO. 
DEFINE NEW SHARED VARIABLE kalkmtrl AS LOGICAL NO-UNDO. 
DEFINE NEW SHARED VARIABLE kalkregvar AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE florsak AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE flrec AS RECID NO-UNDO.

DEFINE VARIABLE kommando AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE avb-mus AS LOGICAL NO-UNDO.
DEFINE VARIABLE overant AS INTEGER NO-UNDO.
DEFINE VARIABLE otim AS INTEGER NO-UNDO.
DEFINE VARIABLE otim2 AS INTEGER NO-UNDO.
DEFINE VARIABLE tiden AS INTEGER NO-UNDO.
DEFINE VARIABLE kollen AS INTEGER NO-UNDO.    
DEFINE VARIABLE kollen2 AS INTEGER NO-UNDO.
DEFINE VARIABLE kollen3 AS INTEGER NO-UNDO.
DEFINE VARIABLE flkoll AS INTEGER NO-UNDO.
DEFINE VARIABLE lunchut AS INTEGER NO-UNDO.
DEFINE VARIABLE tid2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE tid4 AS DECIMAL NO-UNDO. 
DEFINE VARIABLE tid5 AS DECIMAL NO-UNDO. 
DEFINE VARIABLE tid6 AS DECIMAL NO-UNDO. 
DEFINE VARIABLE kollfv1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE kollfv2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE hjtidanr AS DECIMAL NO-UNDO.
DEFINE VARIABLE aonr3 AS CHARACTER NO-UNDO.
DEFINE VARIABLE dnr3 AS INTEGER NO-UNDO.    
DEFINE VARIABLE pltid AS LOGICAL NO-UNDO.
DEFINE VARIABLE ejtid AS LOGICAL INITIAL FALSE NO-UNDO.
DEFINE VARIABLE plus AS INTEGER NO-UNDO.
DEFINE VARIABLE flhjrec AS RECID NO-UNDO.   
DEFINE VARIABLE flsaldo AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE status-ok AS LOGICAL NO-UNDO.
DEFINE VARIABLE regdatumspar AS DATE NO-UNDO. 
DEFINE VARIABLE my1hand AS WIDGET-HANDL NO-UNDO.
DEFINE VARIABLE flexkvst AS DECIMAL NO-UNDO.     
DEFINE VARIABLE flexkvsl AS DECIMAL NO-UNDO. 
DEFINE VARIABLE flexmost AS DECIMAL NO-UNDO.     
DEFINE VARIABLE flexmosl AS DECIMAL NO-UNDO. 
DEFINE VARIABLE tidreg AS LOGICAL NO-UNDO.
DEFINE VARIABLE typ3 AS CHARACTER NO-UNDO.
DEFINE VARIABLE tpris3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE tidslut AS DECIMAL NO-UNDO. 
DEFINE VARIABLE seku AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE sok1 AS CHARACTER NO-UNDO.
DEFINE VARIABLE sok2 AS INTEGER NO-UNDO.
DEFINE VARIABLE sok3 AS CHARACTER NO-UNDO.
DEFINE VARIABLE sok4 AS CHARACTER NO-UNDO.
DEFINE VARIABLE sok5 AS DECIMAL NO-UNDO.
DEFINE VARIABLE dagplus AS DECIMAL NO-UNDO.
DEFINE VARIABLE maxarbkort AS DECIMAL NO-UNDO.     
DEFINE VARIABLE dagtotal AS DECIMAL NO-UNDO.
DEFINE VARIABLE kolllu AS INTEGER NO-UNDO.
DEFINE VARIABLE totarbkort AS DECIMAL NO-UNDO.
DEFINE VARIABLE avarfor AS INTEGER NO-UNDO.
DEFINE VARIABLE foremaxarbkort AS DECIMAL NO-UNDO.
DEFINE VARIABLE frisktid AS DECIMAL NO-UNDO.
DEFINE VARIABLE luextr AS DECIMAL NO-UNDO.
{TIDAPPDEF.I}
DEFINE BUFFER flexbuff FOR FLEXTID.   
DEFINE BUFFER tidbuff FOR TIDREGITAB.          
DEFINE QUERY traktq FOR tidbuff.

DEFINE VARIABLE gplhuvudbuffh AS HANDLE NO-UNDO.
DEFINE VARIABLE gplaktbuffh AS HANDLE NO-UNDO.
DEFINE VARIABLE qString       AS CHARACTER  NO-UNDO.


CREATE WIDGET-POOL "DynTableFL" NO-ERROR.


{FLEXAPPUT.I}
RUN REGDAG.P.
FIND FIRST FORETAG NO-LOCK NO-ERROR.
Guru.Konstanter:globforetag = FORETAG.FORETAG.
{FORESTYR.I}
FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = flexapp.PERSONALKOD NO-LOCK NO-ERROR.
FIND FIRST FLEXAVT WHERE FLEXAVT.PERSONALKOD = PERSONALTAB.PERSONALKOD NO-LOCK NO-ERROR.
FIND FIRST ANSTFORMTAB WHERE ANSTFORM.ANSTALLNING = PERSONALTAB.ANSTALLNING
USE-INDEX ANSTF NO-LOCK NO-ERROR.  
FIND FIRST UTRYCKNING WHERE  UTRYCKNING.KOD = ANSTFORMTAB.KOD
USE-INDEX UT NO-LOCK NO-ERROR.  
FIND FIRST FLEXREG WHERE FLEXREG.KOD = FLEXAVT.FLEXKOD USE-INDEX FLEX NO-LOCK 
NO-ERROR.  
FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.

END FUNCTION.
FUNCTION klock60 RETURNS DECIMAL
  ( INPUT ber100 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  TRUNCATE(ber100,0) + ((ber100 - TRUNCATE(ber100,0)) * 60 / 100 ).

END FUNCTION.
ASSIGN
flexpers = PERSONALTAB.PERSONALKOD
persrec = RECID(PERSONALTAB).
RUN VALUE(program).
{FLEXAPPIN.I}
FOR EACH flexapp WHERE NO-LOCK:
   Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + flexapp.PERSONALKOD.
END.
{GDPRLOGGCLIENT.I}   
PROCEDURE anin_UI :
   regdatum = TODAY.
   RUN REGVEC.P.
   ASSIGN tid = tid5.   
   IF Guru.Konstanter:globforetag = "celpa" THEN tid5 = 7.45.
   RUN SLFLARB.P.   
   DO TRANSACTION:
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum         
         FLEXDAG.START = regstart
         FLEXDAG.SLUT = regslut.
      END.
      ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      IF FLEXREG.MINSLU = 0 THEN tid2 = regslut.
      ELSE tid2 = FLEXREG.MINSLU.
      IF kollen = 0 THEN DO:                  
         ASSIGN FLEXDAG.START = regstart FLEXDAG.SLUT = tid2.    
         CREATE TIDREGITAB.
         ASSIGN 
         TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = regstart     
         TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = 'F'
         TIDREGITAB.AONR = aonr3 
         TIDREGITAB.DELNR = dnr3 
         TIDREGITAB.PRISTYP = typ3
         TIDREGITAB.PRIS = tpris3.
         RUN pris_UI.
         IF aonr3 = onr AND dnr3 = dnr THEN ASSIGN TIDREGITAB.SLUT = regslut.
         ELSE ASSIGN TIDREGITAB.SLUT = tid5.
         ASSIGN
         
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.
         regdatum = TIDREGITAB.DATUM.         
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.
         tidtabrec = RECID(TIDREGITAB). 
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
            kollfv1 = regstart + 1.
            kollfv2 = tid5 - 1.
         END.
         IF Guru.Konstanter:globforetag = "MISV" THEN DO:            
            kollfv1 = klock60(klock100(regstart) + 1.25).
            kollfv2 = klock60(klock100(tid5) - 1.25).
         END.         
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV"  OR Guru.Konstanter:globforetag = "elpa" THEN DO:            
            IF aonr3 = "140" AND tid5 > kollfv1   THEN DO:            
               /*special vid friskvård i kombination med flex*/
               ASSIGN
               TIDREGITAB.TRAKTAMENTE = 0 
               TIDREGITAB.OVERTIDUTTAG = 'F'
               TIDREGITAB.AONR = "155" 
               TIDREGITAB.DELNR = 0 
               TIDREGITAB.PRISTYP = "FRÅNVARO."
               TIDREGITAB.PRIS = 0             
               TIDREGITAB.SLUT = kollfv2.
               ASSIGN               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               regstartsek = sekunder.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               regslutsek = sekunder.
               regdatum = TIDREGITAB.DATUM.         
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.
               tidtabrec = RECID(TIDREGITAB). 
               CREATE TIDREGITAB.
               ASSIGN TIDREGITAB.PERSONALKOD = flexpers
               TIDREGITAB.START = kollfv2     
               TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
               TIDREGITAB.DATUM = regdatum
               TIDREGITAB.DAG = regdagnamn 
               TIDREGITAB.VECKONUMMER = regvnr
               TIDREGITAB.TRAKTAMENTE = tra 
               TIDREGITAB.OVERTIDUTTAG = 'F'
               TIDREGITAB.AONR = aonr3 
               TIDREGITAB.DELNR = dnr3 
               TIDREGITAB.PRISTYP = typ3
               TIDREGITAB.PRIS = tpris3.
               RUN pris_UI.
               TIDREGITAB.SLUT = tid5.               
               ASSIGN            
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               regstartsek = sekunder.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               regslutsek = sekunder.
               regdatum = TIDREGITAB.DATUM.            
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.
               ASSIGN FLEXDAG.FLARB = 0 - nytid.
               tidtabrec = RECID(TIDREGITAB).
               RUN TRAKTBER.P.
               
            END.
         END.         
         IF aonr3 = onr AND dnr3 = dnr THEN nytid = nytid.
         ELSE DO:   
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris             
            TIDREGITAB.SLUT = regslut.
            RUN pris_UI.
            ASSIGN
            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
         END.   
         RUN TRAKTBER.P.      
      END.
      ELSE DO:
         FIND LAST TIDREGITAB WHERE 
         TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
         TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' AND
         TIDREGITAB.SLUT = regslut USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE TIDREGITAB THEN DO:                       
            IF TIDREGITAB.AONR = onr AND TIDREGITAB.DELNR = dnr THEN nytid = nytid.
            ELSE DO:
               ASSIGN tid = tid5
               TIDREGITAB.SLUT = tid5
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.          
               ASSIGN
               regdatumspar = regdatum
               regslutsek = sekunder
               regdatum = TIDREGITAB.DATUM.
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.       
               CREATE TIDREGITAB.
               ASSIGN TIDREGITAB.PERSONALKOD = flexpers
               TIDREGITAB.START = tid     
               TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
               TIDREGITAB.DATUM = regdatum
               TIDREGITAB.DAG = regdagnamn 
               TIDREGITAB.VECKONUMMER = regvnr
               TIDREGITAB.TRAKTAMENTE = tra 
               TIDREGITAB.OVERTIDUTTAG = 'F'
               TIDREGITAB.AONR = onr 
               TIDREGITAB.DELNR = dnr 
               TIDREGITAB.PRISTYP = typ
               TIDREGITAB.PRIS = tpris             
               TIDREGITAB.SLUT = tid2.
               RUN pris_UI.
               ASSIGN
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               regstartsek = sekunder.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               ASSIGN
               regslutsek = sekunder
               regdatum = TIDREGITAB.DATUM.               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.
               tidtabrec = RECID(TIDREGITAB).
               RUN TRAKTBER.P.   
            END.   
         END.
      END.
   END.   
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.      
END PROCEDURE.
   
PROCEDURE anut_UI :   
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.         
   ASSIGN tid = tid5.
   IF Guru.Konstanter:globforetag = "celpa" THEN tid = 14.15.
   DO TRANSACTION:
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum         
         FLEXDAG.START = regstart
         FLEXDAG.SLUT = regslut.
      END.
      ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      fldrec = RECID(FLEXDAG).
      IF tid < regslut THEN ASSIGN FLEXDAG.SLUT = regslut.   
      ELSE IF tid > flexkvsl THEN FLEXDAG.SLUT = flexkvsl.
      ELSE ASSIGN FLEXDAG.SLUT = tid.    
      FIND LAST TIDREGITAB WHERE 
      TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
      TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' AND
      TIDREGITAB.SLUT = regslut USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:  
         /* SAMMA AONR SKALL EJ SKAPA TIDREG*/
         IF TIDREGITAB.AONR = onr AND TIDREGITAB.DELNR = dnr THEN nytid = nytid.
         ELSE IF tid < TIDREGITAB.SLUT AND tid > TIDREGITAB.START THEN DO:            
            nytid = tid.
            RUN TIMSEK.P.        
            ASSIGN
            tiden = sekunder 
            TIDREGITAB.SLUT = tid
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            ASSIGN regstartsek = sekunder
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            ASSIGN regslutsek = sekunder
            regdatum = TIDREGITAB.DATUM.
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.           
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris             
            TIDREGITAB.SLUT = regslut.
            RUN pris_UI.
            ASSIGN            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P.
                        
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               kolllu = 0.
               IF lunchstarten NE lunchslutet AND tid GE lunchslutet THEN kolllu = 1.
               IF lunchstarten =  lunchslutet AND tid > regstart  THEN kolllu =  1.
               /*halvdagar har ingen lunch*/
               IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
                  kollfv1 = regslut - 1.
                  kollfv2 = tid + 1.
               END.
               IF Guru.Konstanter:globforetag = "MISV" THEN DO:            
                  kollfv1 = klock60(klock100(regslut) - 1.25).
                  kollfv2 = klock60(klock100(tid) + 1.25).
               END.               
               IF onr = "140" AND tid <  kollfv1 AND kolllu =  1   THEN DO:                             
                  /*special vid friskvård i kombination med flex*/
                  ASSIGN
                  TIDREGITAB.SLUT = kollfv2                 
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  ASSIGN regstartsek = sekunder
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.
                  ASSIGN regslutsek = sekunder
                  regdatum = TIDREGITAB.DATUM.
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.
                  VALIDATE TIDREGITAB.                  
                  CREATE TIDREGITAB.
                  ASSIGN TIDREGITAB.PERSONALKOD = flexpers
                  TIDREGITAB.START = kollfv2     
                  TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
                  TIDREGITAB.DATUM = regdatum
                  TIDREGITAB.DAG = regdagnamn 
                  TIDREGITAB.VECKONUMMER = regvnr
                  TIDREGITAB.TRAKTAMENTE = 0 
                  TIDREGITAB.OVERTIDUTTAG = 'F'
                  TIDREGITAB.AONR = "155" 
                  TIDREGITAB.DELNR = 0 
                  TIDREGITAB.PRISTYP = "FRÅNVARO."
                  TIDREGITAB.PRIS = 0             
                  TIDREGITAB.SLUT = regslut.
                  RUN pris_UI.
                  ASSIGN            
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  regstartsek = sekunder.
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.
                  regslutsek = sekunder.
                  regdatum = TIDREGITAB.DATUM.            
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.
                  VALIDATE TIDREGITAB.
                  tidtabrec = RECID(TIDREGITAB).
                  RUN TRAKTBER.P.
               END.
            END.            
         END.      
      END.   
      IF FLEXREG.FULLARB = TRUE THEN DO:
         FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec NO-LOCK NO-ERROR.
         IF AVAILABLE FLEXDAG  THEN DO:
            IF FLEXDAG.OVINPLUS > 0 AND FLEXDAG.PLUS < 0 THEN DO:
               RUN overinjust_UI.
            END.   
         END.
      END. 
   END.   
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.
   
END PROCEDURE.
   
PROCEDURE btnanin_UI :
   kollen = 0.
   sekunder = TIME.
   RUN SEKTIM.P.
   tid5 = nytid.
   IF Guru.Konstanter:globforetag = "celpa" THEN tid5 = 7.45.
   IF Guru.Konstanter:globforetag = "cSUND" THEN DO:
      IF Guru.Konstanter:globanv = "TEST" OR Guru.Konstanter:globanv = "TEST2" THEN tid5 = 8.45.
   END.         
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLFLARB.P.
   IF tid5 < regstart THEN DO:                                                         
      CREATE felmeddtemp. 
      felmeddtemp.FELMEDD = "Du kan inte registrera annan tid in innan ordinarie arbetstid!".
      RETURN.   
   END.       
   ELSE IF tid5 >= regslut THEN DO:                                                         
      CREATE felmeddtemp. 
      felmeddtemp.FELMEDD = "Du kan inte registrera annan tid in efter ordinarie arbetstid!".
      RETURN.   
   END.    
   ejtid = FALSE.
   DO TRANSACTION:
      FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD 
      AND FLEXTID.DATUM = TODAY USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.  
      IF AVAILABLE FLEXTID THEN DO:
         IF FLEXTID.KNAPP = "Annat ut" THEN DO:
            ASSIGN kollen = 1
            FLEXTID.GICK = FALSE.
         END.   
         ELSE DO:
            CREATE felmeddtemp. 
            felmeddtemp.FELMEDD = "Du har redan stämplat in idag.".            
            RETURN.
         END.
      END.
      ELSE DO:
         FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
         TIDREGITAB.DATUM = TODAY AND TIDLOG = TRUE AND TIDREGITAB.START < regslut AND
         TIDREGITAB.SLUT > TIDREGITAB.START AND TIDREGITAB.SLUT > regstart USE-INDEX PKOD
         NO-LOCK NO-ERROR.
         IF AVAILABLE TIDREGITAB THEN DO:
            CREATE felmeddtemp. 
            ASSIGN
            felmeddtemp.FELMEDD = "Det finns redan en tidregistrering i intervallet. Vill du registrera ändå? " +
            "Tidregistreringen kommer då inte att uppdateras."
            felmeddtemp.VAL = 1.                      
         END.        
      END.   
   END.  
   IF kollen = 0 THEN DO:   
      CREATE felmeddtemp. 
      ASSIGN
      felmeddtemp.FELMEDD = ""        
      felmeddtemp.VAL = 2.       
      RETURN.
   END.
   ELSE DO:
      CREATE felmeddtemp. 
      ASSIGN
      felmeddtemp.FELMEDD = ""        
      felmeddtemp.VAL = 3.       
   END.     
   FIND FIRST AONRTAB WHERE AONRTAB.AONR = onr AND AONRTAB.DELNR = dnr NO-LOCK NO-ERROR.
   IF AVAILABLE AONRTAB THEN DO:
      typ = AONRTAB.PRISTYP.
      {SOKSTART.I}
      ASSIGN
      soktemp.SOKVAL = 1
      soktemp.SOKINT[1] = Guru.Konstanter:varforetypval[4]
      soktemp.SOKCHAR[2] = PERSONALTAB.PERSONALKOD
      soktemp.SOKCHAR[3] = AONRTAB.PRISTYP
      soktemp.SOKCHAR[4] = PERSONALTAB.BEFATTNING 
      soktemp.SOKDATE[1] = TODAY.
      {SOKANROP.I}      
      ASSIGN      
      tpris = soktemp.SOKDECI[1].  
   END.
   IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" THEN DO: 
      tra = 0.
   END.
END PROCEDURE.
PROCEDURE btnanin2_UI.
   ASSIGN 
   flexpers = PERSONALTAB.PERSONALKOD
   musz = FALSE.
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Annat in").   
   IF ejtid = TRUE THEN ejtid = ejtid.
   ELSE RUN anin_UI.   
END PROCEDURE.
              
PROCEDURE btnanut_UI :
   
   flexpers = PERSONALTAB.PERSONALKOD.    
   persrec = RECID(PERSONALTAB).             
   IF Guru.Konstanter:globforetag = "Celpa" THEN DO: 
      IF Guru.Konstanter:globanv = CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79)   THEN tid5 = 14.15.
   END.
   IF Guru.Konstanter:globforetag = "cSUND" THEN DO:
      IF Guru.Konstanter:globanv = "TEST" OR Guru.Konstanter:globanv = "TEST2" OR Guru.Konstanter:globanv = "Celpao" THEN tid5 = 15.15.
   END.     
   /*INLAGT 20180502  missat kontroll mot arbetstid Lena*/
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.
   IF tid5 >= regslut THEN DO:                                                         
      CREATE felmeddtemp. 
      felmeddtemp.FELMEDD = "Du kan inte registrera Annat Ut efter ordinarie arbetstid! Använd Ut istället".
      RETURN.   
   END.
   IF tid5 <= regstart THEN DO:                                                         
      CREATE felmeddtemp. 
      felmeddtemp.FELMEDD = "Du kan inte registrera Annat Ut före ordinarie arbetstid!".
      RETURN.   
   END.
       
   RUN cflex_UI (INPUT FALSE , INPUT TRUE, INPUT "Annat ut").
   RUN anut_UI.         
      
END PROCEDURE.
              
PROCEDURE btnflin_UI :     
   FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD 
   AND FLEXTID.DATUM = TODAY USE-INDEX FLEX NO-LOCK NO-ERROR.  
   IF AVAILABLE FLEXTID THEN DO TRANSACTION:
      FIND CURRENT FLEXTID EXCLUSIVE-LOCK NO-ERROR.
      IF FLEXTID.KNAPP = "Flex ut" THEN DO:
         ASSIGN kollen = 1
         FLEXTID.GICK = FALSE.
      END.   
      ELSE IF FLEXTID.KNAPP = "Lunch ut" THEN DO:
         ASSIGN kollen = 1
         FLEXTID.GICK = FALSE.
      END.   
      ELSE DO:
         CREATE felmeddtemp. 
         felmeddtemp.FELMEDD = "Du har redan stämplat in idag.".            
         RETURN.
      END.
   END. 
   ELSE DO:   
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.DATUM = TODAY AND TIDLOG = TRUE AND TIDREGITAB.START < tid5 AND
      TIDREGITAB.SLUT > TIDREGITAB.START AND TIDREGITAB.SLUT > regstart USE-INDEX PKOD
      NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:       
         IF AVAILABLE TIDREGITAB THEN DO:
            CREATE felmeddtemp. 
            ASSIGN
            felmeddtemp.FELMEDD = "Det finns redan en tidregistrering i intervallet. Vill du registrera ändå? " +
            "Tidregistreringen kommer då inte att uppdateras."
            felmeddtemp.VAL = 1.                      
            RETURN.
         END.
      END.      
   END.  
   RETURN.
END PROCEDURE.
PROCEDURE btnflin2_UI :
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Flex in").
   IF ejtid = TRUE THEN ejtid = FALSE.
   ELSE RUN flin_UI.         
END PROCEDURE.

PROCEDURE btnflut_UI :
   FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD 
   AND FLEXTID.DATUM = TODAY USE-INDEX FLEX NO-LOCK NO-ERROR.  
   IF NOT AVAILABLE FLEXTID THEN DO:      
      CREATE felmeddtemp. 
      ASSIGN
      felmeddtemp.FELMEDD = "Du har inte stämpat in idag. Vill du registrera ändå?"
      felmeddtemp.VAL = 1.                          
   END. 
   ELSE DO:
      IF FLEXTID.KNAPP = "FLEX UT" THEN DO:
         CREATE felmeddtemp. 
         ASSIGN
         felmeddtemp.FELMEDD ="Du har redan flexat ut idag".         
         RETURN.         
      END.
      IF FLEXTID.KNAPP = "ANNAT UT" THEN DO:
         CREATE felmeddtemp. 
         ASSIGN
         felmeddtemp.FELMEDD ="Du har redan stämplat Annat ut idag".         
         RETURN.         
      END.
      IF FLEXTID.KNAPP = "UT"   THEN DO:
         CREATE felmeddtemp. 
         ASSIGN
         felmeddtemp.FELMEDD ="Du har redan stämplat Ut idag".         
         RETURN.         
      END.
   END.
END PROCEDURE.
PROCEDURE btnflut2_UI :
   flexpers = PERSONALTAB.PERSONALKOD.    
   persrec = RECID(PERSONALTAB).             
   RUN cflex_UI (INPUT FALSE , INPUT TRUE, INPUT "Flex ut").
   RUN flut_UI.             
END PROCEDURE.

PROCEDURE btnin_UI :
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY
   USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF AVAILABLE FLEXTID AND DATUM = TODAY THEN DO:
      IF FLEXTID.KNAPP = "In" THEN DO:
         CREATE felmeddtemp. 
         felmeddtemp.FELMEDD = "Du har redan stämplat in.".         
         RETURN.
      END.   
   END.
   ELSE DO: 
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.DATUM = TODAY AND TIDLOG = TRUE AND TIDREGITAB.START < regslut AND
      TIDREGITAB.SLUT > TIDREGITAB.START AND TIDREGITAB.SLUT > regstart USE-INDEX PKOD
      NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:       
         CREATE felmeddtemp. 
         ASSIGN
         felmeddtemp.FELMEDD = "Det finns redan en tidregistrering i intervallet. Vill du registrera ändå? Tidregistreringen kommer då inte att uppdateras."
         felmeddtemp.VAL = 1.                                   
      END.   
   END.   
END PROCEDURE.
PROCEDURE btnin2_UI :
   RUN cflex_UI (INPUT TRUE , INPUT FALSE, INPUT "In").   
   ASSIGN florsak = "".
   IF ejtid = TRUE THEN ejtid = FALSE.
   ELSE RUN in_UI.        
END PROCEDURE.

PROCEDURE btnluin_UI :
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY AND FLEXTID.KNAPP = "LUNCH IN" USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF AVAILABLE FLEXTID THEN DO:
      CREATE felmeddtemp. 
      ASSIGN
      felmeddtemp.FELMEDD ="Du har redan stämplat lunch in idag.".           
      RETURN.
   END.
   lunchut = 0.
   DO TRANSACTION:             
      FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXTID.DATUM = TODAY
      USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.  
      IF AVAILABLE FLEXTID AND FLEXTID.DATUM = TODAY THEN DO:
         IF FLEXTID.KNAPP = "Flex ut" THEN DO:       
            ASSIGN 
            lunchut = 1
            FLEXTID.GICK = FALSE.
         END.   
         ELSE IF FLEXTID.KNAPP = "Lunch ut" THEN  ASSIGN lunchut = 1.
         ELSE ASSIGN lunchut = 0.
      END.
   END.  
   IF lunchut = 0 THEN DO:
      CREATE felmeddtemp. 
      ASSIGN
      felmeddtemp.FELMEDD = "Du har inte registrerat lunch ut än. Vill du registrera lunch in ändå?".
      felmeddtemp.VAL = 1.      
   END.  
END PROCEDURE.
PROCEDURE btnluin2_UI :
   flexrec = RECID(FLEXTID).
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Lunch in").
   RUN luin_UI.       
END PROCEDURE.

PROCEDURE btnluut_UI :  
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY AND KNAPP = "LUNCH IN" USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF AVAILABLE FLEXTID THEN DO:
      CREATE felmeddtemp.  
      ASSIGN               
      felmeddtemp.FELMEDD = "Du kan inte registrera lunch ut efter lunch in.".      
      RETURN.
   END.
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY AND KNAPP = "LUNCH UT" USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF AVAILABLE FLEXTID THEN DO:
      CREATE felmeddtemp.  
      ASSIGN               
      felmeddtemp.FELMEDD = "Du har redan stämplat lunch ut idag.".      
      RETURN.
   END.
   flexpers = PERSONALTAB.PERSONALKOD.    
   persrec = RECID(PERSONALTAB). 
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Lunch ut").     
END PROCEDURE.

PROCEDURE btnovin_UI :
   ovkoll = 0.
   sekunder = TIME.
   RUN SEKTIM.P.  
   tid5 = nytid.
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Övertid in").
   RUN overin_UI.     
END PROCEDURE.

PROCEDURE btnovut_UI :
   kollen = 0. 
   kollen2 = 0.
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
   FLEXTID.DATUM = TODAY AND FLEXTID.KOM = TRUE USE-INDEX FLEX NO-LOCK NO-ERROR.  
   IF NOT AVAILABLE FLEXTID THEN DO:
      FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
      FLEXTID.DATUM = TODAY USE-INDEX FLEX NO-LOCK NO-ERROR.  
   END.
   IF NOT AVAILABLE FLEXTID THEN DO:
       /* OM DENNA SKALL GÅ IGENOM HUR GÖRS JÄMNA HALVTIMMAR ?????*/
       CREATE felmeddtemp.  
       ASSIGN               
       felmeddtemp.FELMEDD = "Det finns ingen in-registrering finns denna dag.".       
       RETURN.
   END.             
   IF FLEXTID.KNAPP = "Övertid in" THEN DO:
      IF regstart = regslut THEN kollen = 0.
      ELSE IF FLEXTID.TID > regslut THEN kollen = 0.
      ELSE IF FLEXTID.TID < regstart AND TIME > regslut THEN kollen = 1.
   END.   
   IF FLEXTID.KNAPP = "In" OR FLEXTID.KNAPP = "Annat in" OR FLEXTID.KNAPP = "Flex in" OR kollen = 1 THEN DO: 
      kollen3 = 1.
      kollen2 = 1.
      RETURN.
   END.   
   RETURN.
END PROCEDURE.   
PROCEDURE btnovut2_UI :
   RUN cflex_UI (INPUT FALSE , INPUT FALSE, INPUT "Övertid ut").
   RUN overut_UI.       
END PROCEDURE.
   
PROCEDURE btnut_UI :
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.  
   flkoll = 1.
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY AND FLEXTID.KNAPP = "Ut" USE-INDEX FLEX NO-LOCK NO-ERROR.     
   IF AVAILABLE FLEXTID THEN DO:
      CREATE felmeddtemp.  
      ASSIGN                        
      felmeddtemp.FELMEDD = "Du har redan stämplat ut idag!".      
      RETURN.
   END.   
   IF regstart NE regslut THEN DO:    
      FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXTID.DATUM = TODAY AND FLEXTID.KNAPP = "Övertid in" AND FLEXTID.TID
      > regslut USE-INDEX FLEX NO-LOCK NO-ERROR.     
      IF AVAILABLE FLEXTID THEN DO:
         CREATE felmeddtemp.  
         ASSIGN                        
         felmeddtemp.FELMEDD ="Du har stämplat övertid in nu måste du stämpla övertid ut!".         
         RETURN.
      END.   
   END.       
   FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
   AND TIDREGITAB.DATUM = TODAY AND TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.OVERTIDUTTAG NE "F"
   AND TIDREGITAB.START < tid5 AND TIDREGITAB.SLUT > regslut NO-LOCK NO-ERROR.
   IF AVAILABLE TIDREGITAB THEN DO:         
      CREATE felmeddtemp. 
      felmeddtemp.felmedd = "Det finns redan en övertidsregistrering med start " + STRING(TIDREGITAB.START) + " och slut " + STRING(TIDREGITAB.SLUT).
      RETURN.
   END.
   FIND LAST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY AND FLEXTID.GICK = TRUE USE-INDEX FLEX NO-LOCK NO-ERROR.     
   IF AVAILABLE FLEXTID THEN DO:
      nytid = FLEXTID.TID.
      RUN TIMSEK.P.
      IF TIME < sekunder + 120 THEN DO:      
         MESSAGE "Du har redan stämplat ut idag!" VIEW-AS ALERT-BOX.
         RUN gom_UI.
         RETURN.
      END.
      ELSE IF FLEXTID.KNAPP = "Flex ut" THEN DO TRANSACTION:
         FIND CURRENT FLEXTID EXCLUSIVE-LOCK NO-ERROR.   
         ASSIGN FLEXTID.GICK = FALSE.
      END.
      ELSE IF FLEXTID.KNAPP = "Lunch ut" THEN DO TRANSACTION:
         FIND CURRENT FLEXTID EXCLUSIVE-LOCK NO-ERROR.   
         ASSIGN FLEXTID.GICK = FALSE.
      END.      
   END.  
   
   FOR EACH FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   FLEXTID.DATUM = TODAY USE-INDEX FLEX NO-LOCK:
      IF (FLEXTID.KNAPP = "In" OR FLEXTID.KNAPP = "Annat in" OR FLEXTID.KNAPP = "Övertid in" OR
      FLEXTID.KNAPP = "Flex in") 
      THEN flkoll = 0.
   END. 
   
   flexpers = PERSONALTAB.PERSONALKOD.
   persrec = RECID(PERSONALTAB).                        
   flexrec = RECID(FLEXTID). 
   RUN cflex_UI (INPUT FALSE , INPUT TRUE, INPUT "Ut").
   RUN ut_UI.     
   
END PROCEDURE.

PROCEDURE cflex_UI :

   DEFINE INPUT PARAMETER varkom AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER vargick AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER varknapp AS CHARACTER NO-UNDO.   
   
   DO TRANSACTION:
      CREATE FLEXTID.
      ASSIGN FLEXTID.PERSONALKOD = flexpers 
      FLEXTID.DATUM = TODAY
      FLEXTID.KOM = varkom 
      FLEXTID.GICK = vargick 
      FLEXTID.KNAPP = varknapp 
      FLEXTID.TID = tid5
      FLEXTID.AONR = onr 
      FLEXTID.DELNR = dnr
      flexrec = RECID(FLEXTID). 
      IF varknapp = "In" THEN DO:
         IF florsak NE "" THEN ASSIGN FLEXTID.ORSAK = florsak.   
      END.
      IF varknapp = "Ut" THEN DO:
         ASSIGN
         FLEXTID.AONR = "" 
         FLEXTID.DELNR = 0.
         IF florsak NE "" THEN ASSIGN FLEXTID.ORSAK = florsak.
      END.
      IF varknapp = "Annat in" THEN DO:      
         FIND FIRST AONRTAB WHERE AONRTAB.AONR = aonr3 AND AONRTAB.DELNR = dnr3 NO-LOCK NO-ERROR.
         IF AVAILABLE AONRTAB THEN ASSIGN FLEXTID.ORSAK = AONRTAB.ORT.   
         IF kollen = 0 THEN ASSIGN FLEXTID.KOM = TRUE varkom = TRUE.  
         hjtidanr = 1.
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
            IF onr = "140" THEN hjtidanr = 1.
         END.
         IF Guru.Konstanter:globforetag = "MISV"  THEN DO:
            IF onr = "140" THEN hjtidanr = 1.25.
         END.
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
            IF Guru.Konstanter:globforetag = "cmisv" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               IF onr = "161" THEN DO:
                  RUN aforkortin_UI.
                  IF AVAILABLE felmeddtemp THEN DO:
                     DELETE felmeddtemp.
                     hjtidanr =  maxarbkort - totarbkort.
                  END.
               END.         
            END.               
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               kollfv1 = regstart + hjtidanr.
               kollfv2 = tid5 - hjtidanr.
            END.
            IF Guru.Konstanter:globforetag = "MISV" THEN DO:            
               kollfv1 = klock60(klock100(regstart) + hjtidanr).
               kollfv2 = klock60(klock100(tid5) - hjtidanr).
            END.         
            IF aonr3 = "140" AND tid5 > kollfv1  THEN DO:
               ASSIGN varknapp = "Flex in"               
               FLEXTID.KNAPP = varknapp
               FLEXTID.TID = kollfv2.
            END.
            IF Guru.Konstanter:globforetag = "CMISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               IF aonr3 = "161" AND tid5 > kollfv1  THEN DO:
                  ASSIGN varknapp = "Flex in"               
                  FLEXTID.KNAPP = varknapp
                  FLEXTID.TID = kollfv2.
               END.
            END.
         END.
      END.   
      IF varknapp = "Annat ut" THEN DO:
         FIND FIRST AONRTAB WHERE AONRTAB.AONR = onr AND AONRTAB.DELNR = dnr NO-LOCK NO-ERROR.
         IF AVAILABLE AONRTAB THEN ASSIGN FLEXTID.ORSAK = AONRTAB.ORT.     
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
            regdatum = TODAY.
            RUN REGVEC.P.
            RUN SLUTARB.P.            
            hjtidanr = 1.
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               IF onr = "140" THEN hjtidanr = 1.
            END.
            IF Guru.Konstanter:globforetag = "MISV"  THEN DO:
               IF onr = "140" THEN hjtidanr = 1.25.
            END.
            IF Guru.Konstanter:globforetag = "cmisv" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               IF onr = "161" THEN DO:
                  RUN aforkortut_UI.
                  IF AVAILABLE felmeddtemp THEN DO:
                     DELETE felmeddtemp.
                     hjtidanr =  maxarbkort - totarbkort.
                  END.
               END.         
            END.               
            kolllu = 0.
            IF lunchstarten NE lunchslutet AND tid5 GE lunchslutet THEN kolllu = 1.
            IF lunchstarten =  lunchslutet AND tid5 > regstart  THEN kolllu =  1.
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               kollfv1 = regslut - hjtidanr.
               kollfv2 = tid5 + hjtidanr.
            END.
            IF Guru.Konstanter:globforetag = "MISV" THEN DO:            
               kollfv1 = klock60(klock100(regslut) - hjtidanr).
               kollfv2 = klock60(klock100(tid5) + hjtidanr).
            END.
            IF onr = "140" AND tid5 < kollfv1 AND kolllu =  1   THEN DO:               
               ASSIGN varknapp = "Flex ut" 
               FLEXTID.KNAPP = varknapp
               FLEXTID.TID = kollfv2.
            END.       
            IF Guru.Konstanter:globforetag = "CMISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
               IF onr = "161" AND tid5 < kollfv1 AND kolllu =  1   THEN DO:               
                  ASSIGN varknapp = "Flex ut" 
                  FLEXTID.KNAPP = varknapp
                  FLEXTID.TID = kollfv2.
               END.
            END.               
         END.
      END.
      IF varknapp = "Lunch in" THEN DO:
         ASSIGN
         FLEXTID.AONR = "" 
         FLEXTID.DELNR = 0.
      END.
      IF varknapp = "Lunch ut" THEN DO:
         ASSIGN
         FLEXTID.AONR = "" 
         FLEXTID.DELNR = 0.
      END.      
      IF varknapp = "Flex in" THEN DO:
         IF kollen = 0 THEN ASSIGN FLEXTID.KOM = TRUE varkom = TRUE.  
      END.
      IF varknapp = "Flex ut" THEN DO:
         musz = musz.
      END.
      IF varknapp = "Övertid in" THEN DO:
         musz = musz.
      END.
      IF varknapp = "Övertid ut" THEN DO:
         ASSIGN
         FLEXTID.AONR = "" 
         FLEXTID.DELNR = 0.
      END.     
   END.    
   FIND CURRENT FLEXTID NO-LOCK NO-ERROR.
   
   IF Guru.Konstanter:varforetypchar[9] = "1" THEN RUN persligg_UI (INPUT varkom, INPUT vargick, INPUT varknapp ).
         
END PROCEDURE.

PROCEDURE persligg_UI:
   
   DEFINE INPUT PARAMETER varkom AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER vargick AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER varknapp AS CHARACTER NO-UNDO.
   DEFINE VARIABLE plaid AS INTEGER NO-UNDO INITIAL 0.
   DEFINE VARIABLE hjplid AS INTEGER NO-UNDO INITIAL 0.
   
   /*skapa post i personalliggare*/   
   CREATE BUFFER gplhuvudbuffh FOR TABLE "GPLHUVUD" IN WIDGET-POOL "DynTableFL".
   CREATE BUFFER gplaktbuffh FOR TABLE "GPLAKTIVITET" IN WIDGET-POOL "DynTableFL".
   FIND FIRST ANVANDARE WHERE ANVANDARE.PERSONALKOD = flexpers NO-LOCK NO-ERROR.
   IF AVAILABLE ANVANDARE THEN DO:  
   
      IF varknapp = "In" OR  varknapp = "Flex in" OR  varknapp = "Annat in" THEN DO:
          /*arbetspass startar*/
         IF varkom = TRUE THEN DO:         
            gplhuvudbuffh:FIND-FIRST("WHERE AONRAONR = '" + onr + "' AND AONRDELNR =  " + STRING(dnr), NO-LOCK) NO-ERROR.
            IF gplhuvudbuffh:AVAILABLE THEN DO TRANSACTION:
               IF gplhuvudbuffh:BUFFER-FIELD("AKTIV"):BUFFER-VALUE = TRUE THEN DO:     
               /*flex ska bara gå in på aktiva personalliggare ???*/           
                  gplaktbuffh:FIND-LAST("WHERE PLID = " + gplhuvudbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE  + " USE-INDEX PLAID",EXCLUSIVE-LOCK) NO-ERROR.
                  IF gplaktbuffh:AVAILABLE THEN DO:
                     plaid = gplaktbuffh:BUFFER-FIELD("PLAID"):BUFFER-VALUE NO-ERROR.
                  END.
                  plaid = plaid + 1.                        
                  gplaktbuffh:BUFFER-CREATE().
                  gplaktbuffh:BUFFER-FIELD("PERSONALKOD"):BUFFER-VALUE = flexpers.
                  gplaktbuffh:BUFFER-FIELD("ANVANDARE"):BUFFER-VALUE = ANVANDARE.ANVANDARE.                             
                  gplaktbuffh:BUFFER-FIELD("STARTTID"):BUFFER-VALUE = DATETIME(TODAY, MTIME ).
                  gplaktbuffh:BUFFER-FIELD("LOGGTID"):BUFFER-VALUE = DATETIME(TODAY, MTIME ).        
                  gplaktbuffh:BUFFER-FIELD("SKAPADAV"):BUFFER-VALUE =  Guru.Konstanter:globanv.
                  gplaktbuffh:BUFFER-FIELD("PLAID"):BUFFER-VALUE = plaid.
                  gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE = gplhuvudbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE.
                  gplaktbuffh:BUFFER-FIELD("SKAPADI"):BUFFER-VALUE =  varknapp.
                  gplaktbuffh:BUFFER-FIELD("RATTELSE"):BUFFER-VALUE = FALSE.     
                  gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE = "IN".
               END.          
            END.    
            gplaktbuffh:BUFFER-RELEASE ( )   NO-ERROR.
            DELETE OBJECT gplaktbuffh.   
            gplaktbuffh = ?.
             
         END.
      END.
      
         
      IF varknapp = "Ut" OR  varknapp = "Flex ut" OR  varknapp = "Annat ut" THEN DO:
         IF vargick = TRUE THEN DO:                                  
            DO TRANSACTION :          
               /*hitta sista registrering på aktivitet denna dag för en person , om detta är en start-reg skapa en slut-reg*/
               qString = "WHERE GPLAKTIVITET.PERSONALKOD = '" + flexpers  + "' AND DATE(GPLAKTIVITET.LOGGTID) EQ " + STRING(DATE(DATETIME-TZ(TODAY))) .                                
               gplaktbuffh:FIND-LAST(qString ,NO-LOCK) NO-ERROR.
               IF gplaktbuffh:AVAILABLE THEN DO:               
                  IF gplaktbuffh:BUFFER-FIELD("SLUTTID"):BUFFER-VALUE = ? THEN DO:                     
                     hjplid = gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE.                                      
                     gplaktbuffh:FIND-LAST("WHERE PLID = " + STRING(hjplid)  + " USE-INDEX PLAID",EXCLUSIVE-LOCK) NO-ERROR.
                     IF gplaktbuffh:AVAILABLE THEN DO:
                        plaid = gplaktbuffh:BUFFER-FIELD("PLAID"):BUFFER-VALUE NO-ERROR.
                     END.
                     plaid = plaid + 1.                        
                     gplaktbuffh:BUFFER-CREATE().
                     gplaktbuffh:BUFFER-FIELD("PERSONALKOD"):BUFFER-VALUE = flexpers.
                     gplaktbuffh:BUFFER-FIELD("ANVANDARE"):BUFFER-VALUE = ANVANDARE.ANVANDARE.                             
                     gplaktbuffh:BUFFER-FIELD("SLUTTID"):BUFFER-VALUE = DATETIME(TODAY, MTIME ).
                     gplaktbuffh:BUFFER-FIELD("LOGGTID"):BUFFER-VALUE = DATETIME(TODAY, MTIME ).        
                     gplaktbuffh:BUFFER-FIELD("SKAPADAV"):BUFFER-VALUE =  Guru.Konstanter:globanv.
                     gplaktbuffh:BUFFER-FIELD("PLAID"):BUFFER-VALUE = plaid.
                     gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE = hjplid.
                     gplaktbuffh:BUFFER-FIELD("SKAPADI"):BUFFER-VALUE =  varknapp.
                     gplaktbuffh:BUFFER-FIELD("RATTELSE"):BUFFER-VALUE = FALSE.     
                     gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE = "UT".       
                  END.
               END.
            END.          
            gplaktbuffh:BUFFER-RELEASE ( )   NO-ERROR.
            DELETE OBJECT gplaktbuffh.   
            gplaktbuffh = ?.
         
         END.
      END.
   END.   
      
   DELETE WIDGET-POOL "DynTableFL" NO-ERROR.
END PROCEDURE.   
   
PROCEDURE flin_UI :
   
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.  
   ASSIGN tid = tid5.
   DO TRANSACTION:
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum         
         FLEXDAG.START = regstart
         FLEXDAG.SLUT = regslut.
      END.
      ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      IF FLEXREG.MINSLU = 0 THEN tid2 = regslut.
      ELSE tid2 = FLEXREG.MINSLU.
      IF kollen = 0 THEN DO:
         ASSIGN FLEXDAG.START = regstart FLEXDAG.SLUT = tid2. /*obs flextidstart 8 */
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = regstart     
         TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = 'F'
         TIDREGITAB.AONR = aonr3 
         TIDREGITAB.DELNR = dnr3 
         TIDREGITAB.PRISTYP = typ3
         TIDREGITAB.PRIS = tpris3             
         TIDREGITAB.SLUT = tid5.
         RUN pris_UI.
         ASSIGN
         
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.
         regdatum = TIDREGITAB.DATUM.
         
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.
         ASSIGN FLEXDAG.FLARB = 0 - nytid.
         tidtabrec = RECID(TIDREGITAB).     
         /*IF tidreg = TRUE THEN DO:*/
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris             
            TIDREGITAB.SLUT = regslut.
            RUN pris_UI.
            ASSIGN
            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.
            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P. 
         /*END. */    
      END.
      ELSE DO:  /* flex inom ordarb */
         ASSIGN FLEXDAG.SLUT = tid2.         
         FIND LAST TIDREGITAB WHERE 
         TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
         TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' 
         AND TIDREGITAB.START LE tid5 AND TIDREGITAB.SLUT GE tid5
         USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.     
         IF AVAILABLE TIDREGITAB THEN DO:              
            tidslut = TIDREGITAB.SLUT.
            ASSIGN tid = tid5.
            ASSIGN TIDREGITAB.SLUT = tid5
            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            ASSIGN regstartsek = sekunder
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.          
            ASSIGN
            regdatumspar = regdatum
            regslutsek = sekunder
            regdatum = TIDREGITAB.DATUM.
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.        
            ASSIGN FLEXDAG.FLARB = 0 - nytid.
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" THEN DO:
               ASSIGN TIDREGITAB.AONR = "155" TIDREGITAB.DELNR = 0.
            END.            
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid5     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris.             
            RUN pris_UI.
            IF tid5 > tid2 THEN ASSIGN TIDREGITAB.SLUT = tid5.
            ELSE ASSIGN TIDREGITAB.SLUT = tid2.
            IF tidslut < TIDREGITAB.SLUT THEN ASSIGN TIDREGITAB.SLUT = tidslut.
            ASSIGN            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.               
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P.               
         END.
         ELSE DO:
            /*flex in efter ord arbetstid slut*/
            IF tid5 > regslut THEN DO:            
               FIND LAST TIDREGITAB WHERE 
               TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
               TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' 
               AND TIDREGITAB.START LE tid5 AND TIDREGITAB.SLUT = regslut
               USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.     
               IF AVAILABLE TIDREGITAB THEN DO:              
                  tidslut = TIDREGITAB.SLUT.
                  ASSIGN tid = tid5.
                  ASSIGN TIDREGITAB.SLUT = tid5               
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  ASSIGN regstartsek = sekunder
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.          
                  ASSIGN
                  regdatumspar = regdatum
                  regslutsek = sekunder
                  regdatum = TIDREGITAB.DATUM.
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.        
                  ASSIGN FLEXDAG.FLARB = 0 - nytid.
                  IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" THEN DO:
                     ASSIGN TIDREGITAB.AONR = "155" TIDREGITAB.DELNR = 0.
                  END.               
                  CREATE TIDREGITAB.
                  ASSIGN TIDREGITAB.PERSONALKOD = flexpers
                  TIDREGITAB.START = tid5     
                  TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
                  TIDREGITAB.DATUM = regdatum
                  TIDREGITAB.DAG = regdagnamn 
                  TIDREGITAB.VECKONUMMER = regvnr
                  TIDREGITAB.TRAKTAMENTE = tra 
                  TIDREGITAB.OVERTIDUTTAG = 'F'
                  TIDREGITAB.AONR = onr 
                  TIDREGITAB.DELNR = dnr 
                  TIDREGITAB.PRISTYP = typ
                  TIDREGITAB.PRIS = tpris.             
                  RUN pris_UI.
                  IF tid5 > tid2 THEN ASSIGN TIDREGITAB.SLUT = tid5.
                  ELSE ASSIGN TIDREGITAB.SLUT = tid2.
                  IF tidslut < TIDREGITAB.SLUT AND tidslut > TIDREGITAB.START THEN ASSIGN TIDREGITAB.SLUT = tidslut.
                  ASSIGN                  
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  regstartsek = sekunder.
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.
                  regslutsek = sekunder.
                  regdatum = TIDREGITAB.DATUM.               
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.
                  VALIDATE TIDREGITAB.
                  tidtabrec = RECID(TIDREGITAB).
                  RUN TRAKTBER.P.                  
               END.
            END.
         END.
      END.      
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.
END PROCEDURE.

PROCEDURE flut_UI :
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P. 
   ASSIGN tid = tid5.
   DO TRANSACTION:
      FIND FIRST TIDREGITAB WHERE 
      TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
      TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' 
      AND TIDREGITAB.START LE tid5 AND TIDREGITAB.SLUT GE tid5
      AND TIDREGITAB.TIDLOG = TRUE USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.     
      IF AVAILABLE TIDREGITAB THEN DO:  
         tidslut = TIDREGITAB.SLUT.
         nytid = tid5.
         RUN TIMSEK.P.        
         ASSIGN
         tiden = sekunder 
         
         TIDREGITAB.SLUT = tid5
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         ASSIGN regstartsek = sekunder
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         ASSIGN regslutsek = sekunder
         regdatum = TIDREGITAB.DATUM.         
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.           
         FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
         FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
         IF NOT AVAILABLE FLEXDAG THEN DO:
            CREATE FLEXDAG.
            ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
            FLEXDAG.DATUM = regdatum            
            FLEXDAG.START = regstart
            FLEXDAG.SLUT = regslut.
         END.
         ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
         fldrec = RECID(FLEXDAG).
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = tid5     
         TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = 'F'
         TIDREGITAB.AONR = onr 
         TIDREGITAB.DELNR = dnr 
         TIDREGITAB.PRISTYP = typ
         TIDREGITAB.PRIS = tpris.
         RUN pris_UI.
         IF tid5 > regslut THEN ASSIGN TIDREGITAB.SLUT = tid5.
         ELSE ASSIGN TIDREGITAB.SLUT = regslut.
         IF tidslut < TIDREGITAB.SLUT THEN ASSIGN TIDREGITAB.SLUT = tidslut.      
         ASSIGN
         
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.
         regdatum = TIDREGITAB.DATUM.         
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.
         tidtabrec = RECID(TIDREGITAB).
         RUN TRAKTBER.P.
      END.      
      
      ELSE DO:
         FIND FIRST TIDREGITAB WHERE 
         TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
         TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' 
         AND TIDREGITAB.START LE tid5 AND TIDREGITAB.SLUT = regslut
         AND TIDREGITAB.TIDLOG = TRUE USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.     
         IF AVAILABLE TIDREGITAB  THEN DO:

         END.
         ELSE DO:
            /*ingen tidreg samma dag*/         
            nytid = tid5.
            RUN TIMSEK.P.        
            ASSIGN
            tiden = sekunder. 
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = regstart
            TIDREGITAB.SLUT = tid5     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris.      
            RUN pris_UI.
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            ASSIGN regstartsek = sekunder
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            ASSIGN regslutsek = sekunder
            regdatum = TIDREGITAB.DATUM
            Guru.GlobalaVariabler:plustidrec = RECID(TIDREGITAB).
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.           
            FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
            FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE FLEXDAG THEN DO:
               CREATE FLEXDAG.
               ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
               FLEXDAG.DATUM = regdatum            
               FLEXDAG.START = regstart
               FLEXDAG.SLUT = regslut.
            END.
            ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
            fldrec = RECID(FLEXDAG).
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid5     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris.
            RUN pris_UI.
            IF tid5 > regslut THEN ASSIGN TIDREGITAB.SLUT = tid5.
            ELSE ASSIGN TIDREGITAB.SLUT = regslut.
            ASSIGN
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P.
         END.
   
      END.
      IF FLEXREG.FULLARB = TRUE THEN DO:
         FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec NO-LOCK NO-ERROR.
         IF AVAILABLE FLEXDAG THEN DO:
            IF FLEXDAG.OVINPLUS > 0 AND FLEXDAG.PLUS < 0 THEN DO:
               RUN overinjust_UI.
            END.   
         END.
      END. 
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.
END PROCEDURE.
    
PROCEDURE in_UI :
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.
   ASSIGN
   tid = tid5.   
   DO TRANSACTION:
      IF PERSONALTAB.OVERTIDUTTAG = "I" AND tid < flexmost THEN DO:
         CREATE tidbuff.
         ASSIGN 
         tidbuff.PERSONALKOD = PERSONALTAB.PERSONALKOD
         tidbuff.START = tid     
         tidbuff.SLUT = flexmost 
         tidbuff.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         tidbuff.DATUM = regdatum
         tidbuff.DAG = regdagnamn 
         tidbuff.VECKONUMMER = regvnr
         tidbuff.TRAKTAMENTE = tra 
         tidbuff.OVERTIDUTTAG = 'I'
         tidbuff.AONR = onr 
         tidbuff.DELNR = dnr 
         tidbuff.PRISTYP = typ
         tidbuff.PRIS = tpris.   
         RUN pristb_UI.                      
         ASSIGN
         nytid = tidbuff.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = tidbuff.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.         
         regdatum = tidbuff.DATUM.         
         RUN TOTTID.P.
         ASSIGN tidbuff.TOTALT = nytid.
         VALIDATE tidbuff.
      END.
      
      IF tid < flexmost THEN tid = flexmost.
      IF FLEXREG.MINSLU = 0 THEN tid2 = regslut.
      ELSE tid2 = FLEXREG.MINSLU.
      FIND FIRST TIDREGITAB WHERE 
      TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
      TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F'
      USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR. 
      IF NOT AVAILABLE TIDREGITAB THEN DO:  
         /* KOM MORGON ANDRA FINNS inte DENNA DAG*/
         FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
         FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
         IF NOT AVAILABLE FLEXDAG THEN DO:
            CREATE FLEXDAG.
            ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
            FLEXDAG.DATUM = regdatum            
            FLEXDAG.START = regstart
            FLEXDAG.SLUT = regslut.
         END.
         ASSIGN FLEXDAG.KONTROLL = "Ejkontroll"
         FLEXDAG.START = tid FLEXDAG.SLUT = tid2.
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = tid     
         TIDREGITAB.PROGRAM = 'FLEXAUTO' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = 'F'
         TIDREGITAB.AONR = onr 
         TIDREGITAB.DELNR = dnr 
         TIDREGITAB.PRISTYP = typ
         TIDREGITAB.PRIS = tpris.             
         RUN pris_UI.
         ASSIGN 
         TIDREGITAB.SLUT = tid2
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         ASSIGN regstartsek = sekunder
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         ASSIGN 
         regslutsek = sekunder
         regdatumspar = regdatum.
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         tidtabrec = RECID(TIDREGITAB).
         VALIDATE TIDREGITAB.  
         RUN TRAKTBER.P.
      END.          
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR. 
END PROCEDURE.

PROCEDURE luin_UI :
   RUN REGVEC.P.
   RUN SLUTARB.P.
   DO TRANSACTION:
      FIND LAST TIDREGITAB WHERE 
      TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
      TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' AND
      TIDREGITAB.SLUT = regslut USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:  
         /* SAMMA AONR SKALL EJ SKAPA TIDREG*/
         IF TIDREGITAB.AONR = onr AND TIDREGITAB.DELNR = dnr THEN nytid = nytid.
         ELSE DO:
            nytid = tid5.
            RUN TIMSEK.P.        
            ASSIGN
            tiden = sekunder 
            TIDREGITAB.SLUT = tid5
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            ASSIGN regstartsek = sekunder
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            ASSIGN regslutsek = sekunder
            regdatum = TIDREGITAB.DATUM.            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.           
            CREATE TIDREGITAB.
            ASSIGN 
            TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = tid5     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = 'F'
            TIDREGITAB.AONR = onr 
            TIDREGITAB.DELNR = dnr 
            TIDREGITAB.PRISTYP = typ
            TIDREGITAB.PRIS = tpris             
            TIDREGITAB.SLUT = regslut.
            RUN pris_UI.
            ASSIGN
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P.
         END.   
      END.   
      OPEN QUERY traktq
      FOR EACH tidbuff WHERE tidbuff.PERSONALKOD = flexpers AND
      tidbuff.DATUM = TODAY AND tidbuff.TIDLOG = TRUE 
      USE-INDEX PSTART NO-LOCK.
      GET FIRST traktq EXCLUSIVE-LOCK.   
      DO WHILE AVAILABLE(tidbuff):
         nytid = tidbuff.TOTALT.
         RUN TIMSEK.P.
         nytid = tidbuff.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = tidbuff.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.
         regdatum = tidbuff.DATUM.
         RUN TOTTID.P.
         ASSIGN tidbuff.TOTALT = nytid.         
         GET NEXT traktq EXCLUSIVE-LOCK.        
      END.                     
      CLOSE QUERY traktq. 
   END.
   RELEASE TIDREGITAB NO-ERROR.
END PROCEDURE.

PROCEDURE overin_UI :
   ASSIGN tid = tid5.    
   DO TRANSACTION:
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum         
         FLEXDAG.START = regstart
         FLEXDAG.SLUT = regslut.
      END. 
      ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      fldrec = RECID(FLEXDAG).
      FIND FIRST TIDREGITAB WHERE 
      TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
      TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F'
      USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:  
         IF tid > regslut  THEN musz = musz.
         ELSE DO:
            MESSAGE "Det finns redan en flex-registrering denna dag.". 
            RELEASE FLEXDAG NO-ERROR.
            IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
            RELEASE TIDREGITAB NO-ERROR.
            RETURN.
         END.   
      END.     
      IF regstart NE regslut AND tid < regslut THEN DO: 
         FIND FLEXTID WHERE RECID(FLEXTID) = flexrec EXCLUSIVE-LOCK NO-ERROR.
         ASSIGN FLEXTID.KOM = TRUE.
      END.   
      IF regstart = regslut OR tid > regslut THEN DO:  /*HELG*/
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = tid     
         TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = ovut
         TIDREGITAB.AONR = onr 
         TIDREGITAB.DELNR = dnr 
         TIDREGITAB.PRISTYP = typ
         TIDREGITAB.PRIS = tpris             
         TIDREGITAB.SLUT = tid.
         RUN pris_UI.
         ASSIGN
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         ASSIGN regstartsek = sekunder
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         ASSIGN regslutsek = sekunder
         regdatum = TIDREGITAB.DATUM.         
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.   
      END.
      ELSE DO:
         /*all tid före regstart är övertid*/
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = tid     
         TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = ovut
         TIDREGITAB.AONR = onr 
         TIDREGITAB.DELNR = dnr 
         TIDREGITAB.PRISTYP = typ
         TIDREGITAB.PRIS = tpris             
         TIDREGITAB.SLUT = regstart
         TIDREGITAB.RESMAL = florsak.  
         RUN pris_UI.
         ASSIGN
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         regstartsek = sekunder.
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         regslutsek = sekunder.
         regdatum = TIDREGITAB.DATUM.
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         VALIDATE TIDREGITAB.
         tidtabrec = RECID(TIDREGITAB).         
         EMPTY TEMP-TABLE tidapptemp NO-ERROR.                   
         CREATE tidapptemp.
         ASSIGN
         tidapptemp.FORETAG = Guru.Konstanter:globforetag
         tidapptemp.ANVANDARE = Guru.Konstanter:globanv
         tidapptemp.RECPERS = persrec
         tidapptemp.RECTID = tidtabrec
         tidapptemp.DATUM = regdatum.            
         RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
         musz = FALSE.   
         RUN TRAKTBER.P.                                     
      END.
   END.  
END PROCEDURE.

PROCEDURE overut_UI :      
   ASSIGN tid6 = tid5.
   kollen = 0.              
   pltid = FALSE.                 
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = flexpers AND FLEXTID.DATUM = regdatum
   AND FLEXTID.KOM = TRUE  USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF NOT AVAILABLE FLEXTID THEN DO:
      FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = flexpers AND FLEXTID.DATUM = regdatum
      AND FLEXTID.KNAPP = "Övertid In" NO-LOCK NO-ERROR.
   END.
   IF NOT AVAILABLE FLEXTID THEN DO:   
      CREATE felmeddtemp.  
      ASSIGN               
      felmeddtemp.FELMEDD = "Det finns ingen in-registrering denna dag.Lägg upp en in-stämpling via glömd först.".
      RETURN.
   END.   
   FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = flexpers AND FLEXTID.DATUM = regdatum
   AND FLEXTID.GICK = TRUE  USE-INDEX FLEX NO-LOCK NO-ERROR.
   IF AVAILABLE FLEXTID THEN DO:
      CREATE felmeddtemp.  
      ASSIGN                        
      felmeddtemp.FELMEDD = "Du har redan stämplat ut idag!".      
      RETURN.
   END.   
   FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = flexpers
   AND TIDREGITAB.DATUM = regdatum AND TIDLOG = TRUE 
   AND TIDREGITAB.OVERTIDUTTAG = "Ö" AND TIDREGITAB.START GE regslut AND TIDREGITAB.START <  tid6 NO-LOCK NO-ERROR.
   IF AVAILABLE TIDREGITAB THEN DO:         
      CREATE felmeddtemp. 
      felmeddtemp.felmedd = "Det finns redan en övertidsregistrering med start :" + STRING(TIDREGITAB.START) + " slut: " + STRING(TIDREGITAB.SLUT).
      RETURN.
   END.
   FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = flexpers
   AND TIDREGITAB.DATUM = regdatum AND TIDLOG = TRUE 
   AND TIDREGITAB.OVERTIDUTTAG = "K" AND TIDREGITAB.START GE regslut AND TIDREGITAB.START < tid6 NO-LOCK NO-ERROR.
   IF AVAILABLE TIDREGITAB THEN DO:         
      CREATE felmeddtemp. 
      felmeddtemp.felmedd = "Det finns redan en övertidsregistrering med start :" + STRING(TIDREGITAB.START) + " slut: " + STRING(TIDREGITAB.SLUT).
      RETURN.
   END.     
   FIND FLEXTID WHERE RECID(FLEXTID) = flexrec NO-LOCK NO-ERROR.
   FIND PREV FLEXTID WHERE FLEXTID.PERSONALKOD = flexpers AND FLEXTID.DATUM = regdatum USE-INDEX FLEX NO-LOCK NO-ERROR.
   ASSIGN flhjrec = RECID(FLEXTID).
   FIND flexbuff WHERE RECID(flexbuff) = flhjrec NO-LOCK NO-ERROR.   
   IF flexbuff.KNAPP = "Övertid in" THEN DO:
      IF regstart = regslut THEN kollen = 0.
      ELSE IF flexbuff.TID > regslut THEN kollen = 0.
      ELSE IF flexbuff.TID < regstart AND tid6 > regslut THEN kollen = 1.
   END.   
   IF flexbuff.KNAPP = "In" OR flexbuff.KNAPP = "Flex in" OR flexbuff.KNAPP = "Annat in" OR kollen = 1 THEN DO TRANSACTION: 
      FIND FLEXTID WHERE RECID(FLEXTID) = flexrec EXCLUSIVE-LOCK NO-ERROR.
      ASSIGN FLEXTID.GICK = TRUE.
   END.
   RUN REGVEC.P.
   RUN SLUTARB.P.   
   DO TRANSACTION:
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX NO-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum         
         FLEXDAG.START = regstart
         FLEXDAG.SLUT = regslut.
      END.                       
      ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      fldrec = RECID(FLEXDAG).
      IF FLEXREG.FULLARB = FALSE THEN pltid = TRUE.                       
      FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec NO-LOCK NO-ERROR.
      
      /*Kolla om full arbetstid uppnådd vid ordinarie arbetstids slut*/
      RUN dagtot_UI (INPUT FLEXDAG.START, INPUT lunchstarten , INPUT lunchslutet, INPUT tid6, INPUT FLEXDAG.FLARB, OUTPUT dagtotal).                                                      
     
      FIND FLEXTID WHERE RECID(FLEXTID) = flexrec NO-LOCK NO-ERROR.
      FIND flexbuff WHERE RECID(flexbuff) = flhjrec NO-LOCK NO-ERROR.
      IF flexbuff.KNAPP = "Övertid in" THEN DO:
         IF regstart = regslut THEN kollen = 0.
         ELSE IF flexbuff.TID > regslut THEN kollen = 0.
         ELSE IF flexbuff.TID < regstart AND tid6 > regslut THEN kollen = 1.
      END.   
      IF flexbuff.KNAPP = "In" OR flexbuff.KNAPP = "Lunch in" OR flexbuff.KNAPP = "Lunch ut"
      OR flexbuff.KNAPP = "Annat in" OR flexbuff.KNAPP = "Flex in" OR kollen = 1 THEN DO: 
         FIND FLEXTID WHERE RECID(FLEXTID) = flexrec EXCLUSIVE-LOCK NO-ERROR.
         FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec EXCLUSIVE-LOCK NO-ERROR.         
         IF FLEXREG.FULLARB = TRUE  THEN DO:        
            IF (dagtotal - regtotalt) > 0 THEN DO:
               tid2 =  klock60(klock100(tid6) - klock100(dagtotal) + klock100(regtotalt)).
               /* tid2 - när full arbetstid är uppnådd*/          
               IF tid2 > regslut THEN DO:           
                  /*dela upp i flex och övertid*/
                  FLEXDAG.SLUT  = tid2.     
                  FIND LAST TIDREGITAB WHERE 
                  TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
                  TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' AND
                  TIDREGITAB.SLUT = regslut USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
                  IF AVAILABLE TIDREGITAB THEN DO: 
                     ASSIGN TIDREGITAB.SLUT = tid2.
                     nytid = TIDREGITAB.TOTALT.
                     RUN TIMSEK.P.
                     ASSIGN                    
                     nytid = TIDREGITAB.START.
                     RUN TIMSEK.P.
                     ASSIGN
                     regstartsek = sekunder
                     nytid = TIDREGITAB.SLUT.
                     RUN TIMSEK.P.
                     ASSIGN
                     regslutsek = sekunder
                     regdatum = TIDREGITAB.DATUM
                     regvnr = TIDREGITAB.VECKONUMMER.
                     RUN TOTTID.P.
                     ASSIGN TIDREGITAB.TOTALT = nytid.                                         
                     VALIDATE TIDREGITAB. 
  
                     CREATE TIDREGITAB.
                     ASSIGN TIDREGITAB.PERSONALKOD = flexpers
                     TIDREGITAB.START = tid2     
                     TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
                     TIDREGITAB.DATUM = regdatum
                     TIDREGITAB.DAG = regdagnamn 
                     TIDREGITAB.VECKONUMMER = regvnr
                     TIDREGITAB.TRAKTAMENTE = tra 
                     TIDREGITAB.OVERTIDUTTAG = ovut
                     TIDREGITAB.AONR = aonr3 
                     TIDREGITAB.DELNR = dnr3 
                     TIDREGITAB.PRISTYP = typ3
                     TIDREGITAB.PRIS = tpris3             
                     TIDREGITAB.SLUT = tid6
                     TIDREGITAB.RESMAL = florsak.  
                     RUN pris_UI.
                     ASSIGN                     
                     nytid = TIDREGITAB.START.
                     RUN TIMSEK.P.
                     regstartsek = sekunder.
                     nytid = TIDREGITAB.SLUT.
                     RUN TIMSEK.P.
                     regslutsek = sekunder.
                     regdatum = TIDREGITAB.DATUM.                     
                     RUN TOTTID.P.
                     ASSIGN TIDREGITAB.TOTALT = nytid.
                     VALIDATE TIDREGITAB.
                     tidtabrec = RECID(TIDREGITAB).     
                     EMPTY TEMP-TABLE tidapptemp NO-ERROR.                   
                     CREATE tidapptemp.
                     ASSIGN
                     tidapptemp.FORETAG = Guru.Konstanter:globforetag
                     tidapptemp.ANVANDARE = Guru.Konstanter:globanv
                     tidapptemp.RECPERS = persrec
                     tidapptemp.RECTID = tidtabrec
                     tidapptemp.DATUM = regdatum.            
                     RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
                     musz = FALSE.   
                     RUN TRAKTBER.P.                     
                  END.
               END.
               ELSE DO:
                  /*all tid efter regslut är övertid*/
                  CREATE TIDREGITAB.
                  ASSIGN TIDREGITAB.PERSONALKOD = flexpers
                  TIDREGITAB.START = regslut     
                  TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
                  TIDREGITAB.DATUM = regdatum
                  TIDREGITAB.DAG = regdagnamn 
                  TIDREGITAB.VECKONUMMER = regvnr
                  TIDREGITAB.TRAKTAMENTE = tra 
                  TIDREGITAB.OVERTIDUTTAG = ovut
                  TIDREGITAB.AONR = aonr3 
                  TIDREGITAB.DELNR = dnr3 
                  TIDREGITAB.PRISTYP = typ3
                  TIDREGITAB.PRIS = tpris3             
                  TIDREGITAB.SLUT = tid6
                  TIDREGITAB.RESMAL = florsak.  
                  RUN pris_UI.
                  ASSIGN
                  
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  regstartsek = sekunder.
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.
                  regslutsek = sekunder.
                  regdatum = TIDREGITAB.DATUM.                  
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.
                  VALIDATE TIDREGITAB.
                  tidtabrec = RECID(TIDREGITAB).                  
                  EMPTY TEMP-TABLE tidapptemp NO-ERROR.                   
                  CREATE tidapptemp.
                  ASSIGN
                  tidapptemp.FORETAG = Guru.Konstanter:globforetag
                  tidapptemp.ANVANDARE = Guru.Konstanter:globanv
                  tidapptemp.RECPERS = persrec
                  tidapptemp.RECTID = tidtabrec
                  tidapptemp.DATUM = regdatum.            
                  RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
                  musz = FALSE.   
                  RUN TRAKTBER.P.                               
               END.
            END.
            ELSE DO:
               /*full arbetstid ej uppnådd - allt är flex*/         
               FLEXDAG.SLUT  = tid6.
               FIND LAST TIDREGITAB WHERE 
               TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
               TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG = 'F' AND
               TIDREGITAB.SLUT = regslut USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
               IF AVAILABLE TIDREGITAB THEN DO: 
                  ASSIGN TIDREGITAB.SLUT = tid6.
                  nytid = TIDREGITAB.TOTALT.
                  RUN TIMSEK.P.
                  ASSIGN
                  
                  nytid = TIDREGITAB.START.
                  RUN TIMSEK.P.
                  ASSIGN
                  regstartsek = sekunder
                  nytid = TIDREGITAB.SLUT.
                  RUN TIMSEK.P.
                  ASSIGN
                  regslutsek = sekunder
                  regdatum = TIDREGITAB.DATUM
                  regvnr = TIDREGITAB.VECKONUMMER.
                  RUN TOTTID.P.
                  ASSIGN TIDREGITAB.TOTALT = nytid.                                         
                  VALIDATE TIDREGITAB. 
               END.
            END.
         END.
         ELSE DO:
            /*övertid all tid efter ordinarie arbetstid*/
            CREATE TIDREGITAB.
            ASSIGN TIDREGITAB.PERSONALKOD = flexpers
            TIDREGITAB.START = regslut     
            TIDREGITAB.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            TIDREGITAB.DATUM = regdatum
            TIDREGITAB.DAG = regdagnamn 
            TIDREGITAB.VECKONUMMER = regvnr
            TIDREGITAB.TRAKTAMENTE = tra 
            TIDREGITAB.OVERTIDUTTAG = ovut
            TIDREGITAB.AONR = aonr3 
            TIDREGITAB.DELNR = dnr3 
            TIDREGITAB.PRISTYP = typ3
            TIDREGITAB.PRIS = tpris3             
            TIDREGITAB.SLUT = tid6
            TIDREGITAB.RESMAL = florsak.  
            RUN pris_UI.
            ASSIGN
            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = TIDREGITAB.DATUM.
            
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid.
            VALIDATE TIDREGITAB.
            tidtabrec = RECID(TIDREGITAB).
            EMPTY TEMP-TABLE tidapptemp NO-ERROR.                   
            CREATE tidapptemp.
            ASSIGN
            tidapptemp.FORETAG = Guru.Konstanter:globforetag
            tidapptemp.ANVANDARE = Guru.Konstanter:globanv
            tidapptemp.RECPERS = persrec
            tidapptemp.RECTID = tidtabrec
            tidapptemp.DATUM = regdatum.            
            RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
            musz = FALSE.   
            RUN TRAKTBER.P.                               
         END.
      END.
      ELSE IF flexbuff.KNAPP = "Övertid in" AND kollen = 0 THEN DO:
         FIND FLEXTID WHERE RECID(FLEXTID) = flexrec EXCLUSIVE-LOCK NO-ERROR.
         ASSIGN FLEXTID.GICK = TRUE.
         IF UTRYCKNING.HALV = TRUE THEN DO:
            FIND LAST TIDREGITAB WHERE 
            TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
            TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG NE 'F' AND
            TIDREGITAB.SLUT = TIDREGITAB.START USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
            IF AVAILABLE TIDREGITAB THEN DO: 
               nytid = tid6.
               RUN TIMSEK.P.        
               ASSIGN
               tiden = sekunder
               nytid = TIDREGITAB.START.    
               RUN TIMSEK.P.
               ASSIGN overant = tiden - sekunder  
               otim = TRUNCATE(overant / 1800 ,0)
               otim2 = overant - (otim * 1800)
               sekunder = tiden - otim2.
               RUN SEKTIM.P.
               ASSIGN TIDREGITAB.SLUT = nytid
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               regstartsek = sekunder.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               regslutsek = sekunder.    
               regdatum = TIDREGITAB.DATUM.               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.                        
               tidtabrec = RECID(TIDREGITAB).               
               EMPTY TEMP-TABLE tidapptemp NO-ERROR.                
               CREATE tidapptemp.
               ASSIGN
               tidapptemp.FORETAG = Guru.Konstanter:globforetag
               tidapptemp.ANVANDARE = Guru.Konstanter:globanv
               tidapptemp.RECPERS = persrec
               tidapptemp.RECTID = tidtabrec
               tidapptemp.DATUM = regdatum.            
               RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
               musz = FALSE.   
               RUN TRAKTBER.P.
            END.
         END.
         ELSE DO:
            FIND LAST TIDREGITAB WHERE 
            TIDREGITAB.TIDLOG = TRUE AND TIDREGITAB.DATUM = regdatum  AND
            TIDREGITAB.PERSONALKOD = flexpers AND TIDREGITAB.OVERTIDUTTAG NE 'F' AND
            TIDREGITAB.SLUT = TIDREGITAB.START USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
            IF AVAILABLE TIDREGITAB THEN DO:        
               /*FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec EXCLUSIVE-LOCK NO-ERROR.*/                                                     
               ASSIGN TIDREGITAB.SLUT = tid6
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               regstartsek = sekunder.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               regslutsek = sekunder.
               regdatum = TIDREGITAB.DATUM.
               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.   
               tidtabrec = RECID(TIDREGITAB).               
               EMPTY TEMP-TABLE tidapptemp NO-ERROR.                
               CREATE tidapptemp.
               ASSIGN
               tidapptemp.FORETAG = Guru.Konstanter:globforetag
               tidapptemp.ANVANDARE = Guru.Konstanter:globanv
               tidapptemp.RECPERS = persrec
               tidapptemp.RECTID = tidtabrec
               tidapptemp.DATUM = regdatum.            
               RUN TIDUPPDE.P (INPUT TABLE tidapptemp).                  
               musz = FALSE.   
               RUN TRAKTBER.P.
            END.   
         END. 
      END.         
      
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.         
END PROCEDURE.

PROCEDURE overinjust_UI :   
   regdatum = TODAY.
   RUN REGVEC.P.
   RUN SLUTARB.P.     
   DO TRANSACTION:
      FIND FIRST FLEXTID WHERE FLEXTID.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXTID.DATUM = regdatum AND FLEXTID.KNAPP = "Övertid in" USE-INDEX FLEX NO-LOCK NO-ERROR.
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START = FLEXTID.TID USE-INDEX PKOD
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE TIDREGITAB THEN DO:
         FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
         TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START GE FLEXTID.TID USE-INDEX PKOD
         NO-LOCK NO-ERROR.
      END.  
      IF AVAILABLE TIDREGITAB THEN DO:
         IF TIDREGITAB.OVERTIDUTTAG = 'F' THEN regdatum = regdatum.
         ELSE DO:
            tidtabrec = RECID(TIDREGITAB).
            tid2 = TIDREGITAB.SLUT.
            FIND FIRST tidbuff WHERE tidbuff.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
            tidbuff.DATUM = regdatum AND tidbuff.START = TIDREGITAB.SLUT USE-INDEX PKOD
            NO-LOCK NO-ERROR.
            IF  AVAILABLE tidbuff THEN DO:
               tidtabrec2 = RECID(tidbuff).    
            END.             
            FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec EXCLUSIVE-LOCK NO-ERROR.
            nytid = FLEXDAG.OVINPLUS.
            RUN TIMSEK.P.        
            ASSIGN
            tiden = sekunder
            nytid = FLEXDAG.PLUS.
            RUN TIMSEK.P.     
            ASSIGN
            overant = tiden + sekunder.
            otim = TRUNCATE(overant / 1800 ,0).
            otim2 = overant - (otim * 1800).
            IF UTRYCKNING.HALV = TRUE AND
            FLEXREG.SPILL = TRUE  THEN DO:
               FIND TIDREGITAB WHERE RECID(TIDREGITAB) = tidtabrec EXCLUSIVE-LOCK NO-ERROR.
               FIND tidbuff WHERE RECID(tidbuff) = tidtabrec2 EXCLUSIVE-LOCK NO-ERROR.
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               tiden = sekunder + (otim * 1800).
               RUN SEKTIM.P.
               ASSIGN TIDREGITAB.SLUT = nytid 
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = TIDREGITAB.DATUM.               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.            
              
               ASSIGN tidbuff.START = nytid.
               ASSIGN 
                  
               nytid = tidbuff.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = tidbuff.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = tidbuff.DATUM.               
               RUN TOTTID.P.
               ASSIGN tidbuff.TOTALT = nytid.
               VALIDATE tidbuff.            
               sekunder = otim2.
               RUN FSEKTIM.P.
               ASSIGN
               FLEXDAG.PLUS = fnytid.
               FLEXDAG.START = TIDREGITAB.SLUT.
            END.           
            ELSE IF UTRYCKNING.HALV = TRUE AND
            FLEXREG.SPILL = FALSE  THEN DO:     
               FIND TIDREGITAB WHERE RECID(TIDREGITAB) = tidtabrec EXCLUSIVE-LOCK NO-ERROR.
               FIND tidbuff WHERE RECID(tidbuff) = tidtabrec2 EXCLUSIVE-LOCK NO-ERROR.
               nytid = FLEXTID.TID.
               RUN TIMSEK.P.
               tiden = sekunder + otim2.
               RUN SEKTIM.P.
               ASSIGN TIDREGITAB.START = nytid.
               tiden = tiden + (otim * 1800).
               RUN SEKTIM.P.
               ASSIGN TIDREGITAB.SLUT = nytid
               
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = TIDREGITAB.DATUM.               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.  
               ASSIGN tidbuff.START = nytid.
               ASSIGN 
                  
               nytid = tidbuff.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = tidbuff.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = tidbuff.DATUM.               
               RUN TOTTID.P.
               ASSIGN tidbuff.TOTALT = nytid.
               VALIDATE tidbuff.            
              
               ASSIGN
               FLEXDAG.PLUS = 0.
               FLEXDAG.START = TIDREGITAB.SLUT.
            END.     
            ELSE DO:
               FIND TIDREGITAB WHERE RECID(TIDREGITAB) = tidtabrec EXCLUSIVE-LOCK NO-ERROR.
               FIND tidbuff WHERE RECID(tidbuff) = tidtabrec2 EXCLUSIVE-LOCK NO-ERROR.
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               tiden = sekunder.
               nytid = FLEXDAG.PLUS.
               RUN TIMSEK.P.
               tiden = tiden + sekunder.
               RUN SEKTIM.P.
               ASSIGN TIDREGITAB.SLUT = nytid.
                ASSIGN 
                   
               nytid = TIDREGITAB.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = TIDREGITAB.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = TIDREGITAB.DATUM.               
               RUN TOTTID.P.
               ASSIGN TIDREGITAB.TOTALT = nytid.
               VALIDATE TIDREGITAB.  
               ASSIGN tidbuff.START = nytid.
               ASSIGN 
               nytid = tidbuff.START.
               RUN TIMSEK.P.
               ASSIGN regstartsek = sekunder
               nytid = tidbuff.SLUT.
               RUN TIMSEK.P.
               ASSIGN regslutsek = sekunder
               regdatum = tidbuff.DATUM.               
               RUN TOTTID.P.
               ASSIGN tidbuff.TOTALT = nytid.
               VALIDATE tidbuff.     
               ASSIGN
               FLEXDAG.PLUS = 0.
               FLEXDAG.START = TIDREGITAB.SLUT.
            END.   
         END.
      END.      
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.
END PROCEDURE.

PROCEDURE ut_UI :
   regdatum = TODAY.   
   ASSIGN tid = tid5.   
   DO TRANSACTION:
      /*egentligen borde kollektiv vatten ha en egen anstformtab med arbetstid 7-16 den alla på vatten har är 8-17
      8-17 jämfört med KV flexavtal6-17 gör att de inte har någorn flexmån på kvällen . de borde ha en timme*/                 
      IF FLEXAVT.FLEXKOD = "KV" AND PERSONALTAB.DELTID = TRUE THEN flexkvsl = flexkvsl + 1.         
      FIND FIRST FLEXDAG WHERE FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      FLEXDAG.DATUM = regdatum  USE-INDEX FLEX EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FLEXDAG THEN DO:
         CREATE FLEXDAG.
         ASSIGN FLEXDAG.PERSONALKOD = PERSONALTAB.PERSONALKOD
         FLEXDAG.DATUM = regdatum
         FLEXDAG.KONTROLL = "Ejkontroll"
         FLEXDAG.START = regstart.         
         IF tid > flexkvsl THEN ASSIGN FLEXDAG.SLUT = flexkvsl.
         ELSE ASSIGN FLEXDAG.SLUT = tid.      
      END.
      ELSE DO:
         IF tid > flexkvsl THEN ASSIGN FLEXDAG.SLUT = flexkvsl.
         ELSE ASSIGN FLEXDAG.SLUT = tid.
         ASSIGN FLEXDAG.KONTROLL = "Ejkontroll".
      END.   
      fldrec = RECID(FLEXDAG).
      IF flkoll = 1 THEN DO:   
         IF FLEXREG.MINSTA = 0 THEN tid2 = regstart.
         ELSE tid2 = FLEXREG.MINSTA.            
         FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec EXCLUSIVE-LOCK NO-ERROR.
         ASSIGN FLEXDAG.START = tid2 .
         CREATE TIDREGITAB.
         ASSIGN TIDREGITAB.PERSONALKOD = flexpers
         TIDREGITAB.START = tid2     
         TIDREGITAB.PROGRAM = 'FLEXAUTO' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
         TIDREGITAB.DATUM = regdatum
         TIDREGITAB.DAG = regdagnamn 
         TIDREGITAB.VECKONUMMER = regvnr
         TIDREGITAB.TRAKTAMENTE = tra 
         TIDREGITAB.OVERTIDUTTAG = 'F'     
         TIDREGITAB.AONR = onr 
         TIDREGITAB.DELNR = dnr 
         TIDREGITAB.PRISTYP = typ
         TIDREGITAB.PRIS = tpris.             
         RUN pris_UI.
         /*OM EJ INSTÄMPLING*/
         FIND LAST tidbuff WHERE tidbuff.PERSONALKOD = flexpers
         AND tidbuff.PRISTYP NE "FRÅNVARO." AND tidbuff.TIDLOG = TRUE  NO-LOCK NO-ERROR.
         IF AVAILABLE tidbuff THEN DO: 
            FIND FIRST AONRTAB WHERE AONRTAB.AONR = tidbuff.AONR AND AONRTAB.DELNR = tidbuff.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.  
            /*SE PRIS_ui*/
            FIND FIRST TIMKOSTNADSTAB WHERE TIMKOSTNADSTAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
            TIMKOSTNADSTAB.PRISTYP = AONRTAB.PRISTYP USE-INDEX PRISPERS NO-LOCK NO-ERROR.               
            ASSIGN
            TIDREGITAB.AONR = tidbuff.AONR 
            TIDREGITAB.DELNR = tidbuff.DELNR 
            TIDREGITAB.PRISTYP = TIMKOSTNADSTAB.PRISTYP
            TIDREGITAB.PRIS = TIMKOSTNADSTAB.PRISA.             
            RUN pris_UI.         
         END.
         ASSIGN 
         TIDREGITAB.SLUT = FLEXDAG.SLUT.
         nytid = TIDREGITAB.START.
         RUN TIMSEK.P.
         ASSIGN regstartsek = sekunder
         nytid = TIDREGITAB.SLUT.
         RUN TIMSEK.P.
         ASSIGN regslutsek = sekunder
         regdatum = TIDREGITAB.DATUM.         
         regdatumspar = regdatum.
         RUN TOTTID.P.
         ASSIGN TIDREGITAB.TOTALT = nytid.
         tidtabrec = RECID(TIDREGITAB).
         VALIDATE TIDREGITAB.  
         /*reg tid efter flexgräns EJÖV 20110520 lena*/
         IF PERSONALTAB.OVERTIDUTTAG = "I" AND tid > flexkvsl THEN DO:
            CREATE tidbuff.
            ASSIGN 
            tidbuff.PERSONALKOD = flexpers
            tidbuff.START = flexkvsl     
            tidbuff.SLUT = tid
            tidbuff.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            tidbuff.DATUM = regdatum
            tidbuff.DAG = regdagnamn 
            tidbuff.VECKONUMMER = regvnr
            tidbuff.TRAKTAMENTE = tra 
            tidbuff.OVERTIDUTTAG = 'I'
            tidbuff.AONR = TIDREGITAB.AONR  
            tidbuff.DELNR = TIDREGITAB.DELNR 
            tidbuff.PRISTYP = TIDREGITAB.PRISTYP
            tidbuff.PRIS = TIDREGITAB.PRIS.     
            RUN pristb_UI.                    
            ASSIGN
            nytid = tidbuff.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = tidbuff.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = tidbuff.DATUM.         
            RUN TOTTID.P.
            ASSIGN tidbuff.TOTALT = nytid.
            VALIDATE tidbuff.
         END.       
         RUN TRAKTBER.P.
      END.
      ELSE DO:
         FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = flexpers AND
         TIDREGITAB.DATUM = regdatum AND TIDREGITAB.TIDLOG = TRUE AND
         TIDREGITAB.START <= tid AND TIDREGITAB.OVERTIDUTTAG = 'F'
         USE-INDEX PSTART NO-LOCK NO-ERROR.
         IF NOT AVAILABLE TIDREGITAB THEN DO:
            RELEASE FLEXDAG NO-ERROR.         
            IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
            RETURN.
         END.  
         ELSE DO:         
            ASSIGN tid = tid5.
            IF tid > flexkvsl THEN tid = flexkvsl.
            FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec EXCLUSIVE-LOCK NO-ERROR.
            ASSIGN FLEXDAG.SLUT = tid.
            tidtabrec = RECID(TIDREGITAB).
            FIND FIRST TIDREGITAB WHERE RECID(TIDREGITAB) = tidtabrec EXCLUSIVE-LOCK
            NO-ERROR.
            ASSIGN TIDREGITAB.SLUT = tid
            onr = TIDREGITAB.AONR
            dnr = TIDREGITAB.DELNR
            
            nytid = TIDREGITAB.START.
            RUN TIMSEK.P.
            ASSIGN regstartsek = sekunder
            nytid = TIDREGITAB.SLUT.
            RUN TIMSEK.P.          
            ASSIGN
            regdatumspar = regdatum
            regslutsek = sekunder
            regdatum = TIDREGITAB.DATUM.
            RUN TOTTID.P.
            ASSIGN TIDREGITAB.TOTALT = nytid. 
            RUN VECODAT.P.       
            tidtabrec = RECID(TIDREGITAB).
            RUN TRAKTBER.P.
         END.                                
         /*reg tid efter flexgräns EJÖV 20110520 lena*/
         IF PERSONALTAB.OVERTIDUTTAG = "I" AND tid5 > flexkvsl THEN DO:
            CREATE tidbuff.
            ASSIGN 
            tidbuff.PERSONALKOD = flexpers
            tidbuff.START = flexkvsl     
            tidbuff.SLUT = tid5
            tidbuff.PROGRAM = 'FLEXTID' + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv
            tidbuff.DATUM = regdatum
            tidbuff.DAG = regdagnamn 
            tidbuff.VECKONUMMER = regvnr
            tidbuff.TRAKTAMENTE = tra 
            tidbuff.OVERTIDUTTAG = 'I'
            tidbuff.AONR = TIDREGITAB.AONR  
            tidbuff.DELNR = TIDREGITAB.DELNR 
            tidbuff.PRISTYP = TIDREGITAB.PRISTYP
            tidbuff.PRIS = TIDREGITAB.PRIS.      
            RUN pristb_UI.                   
            ASSIGN
            nytid = tidbuff.START.
            RUN TIMSEK.P.
            regstartsek = sekunder.
            nytid = tidbuff.SLUT.
            RUN TIMSEK.P.
            regslutsek = sekunder.
            regdatum = tidbuff.DATUM.         
            RUN TOTTID.P.
            ASSIGN tidbuff.TOTALT = nytid.
            VALIDATE tidbuff.
         END.
      END.   
      IF FLEXREG.FULLARB = TRUE THEN DO:
         FIND FLEXDAG WHERE RECID(FLEXDAG) = fldrec NO-LOCK NO-ERROR.
         IF AVAILABLE FLEXDAG THEN DO:
            IF FLEXDAG.OVINPLUS > 0 AND FLEXDAG.PLUS < 0 THEN DO:
               RUN overinjust_UI.
            END.   
         END.
      END.   
   END.
   RELEASE FLEXDAG NO-ERROR.
   IF AVAILABLE FLEXTID THEN RELEASE FLEXTID NO-ERROR.
   RELEASE TIDREGITAB NO-ERROR.
END PROCEDURE.

PROCEDURE pris_UI :
   {PRISBEFTYP.I}   
END PROCEDURE.

PROCEDURE pristb_UI :
   {PRISBEFTYPTB.I}   
END PROCEDURE.
PROCEDURE aforkortin_UI :   
   /* arbetstidsförkortning*/
   DEFINE BUFFER tidbuff10 FOR TIDREGITAB.   
   regdatum = TODAY.
   RUN REGVEC.P.
   IF onr = "160" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "160"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.        
      ASSIGN 
      nytid = regstart.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = tid5.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).      
      /*atkgräns*/
      IF Guru.Konstanter:globforetag = "gkal"  THEN foremaxarbkort = 63.
      ELSE IF Guru.Konstanter:globforetag = "SNAT"  THEN foremaxarbkort = 63.
      ELSE IF Guru.Konstanter:globforetag = "SUND"  THEN foremaxarbkort = 54.
      ELSE IF Guru.Konstanter:globforetag = "LULE"  THEN foremaxarbkort = 63.            
      ELSE foremaxarbkort = 63.
      avarfor = 0.      
      IF Guru.Konstanter:globforetag = "gkal" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:   
         RUN havafor (INPUT PERSONALTAB.PERSONALKOD, OUTPUT avarfor).                        
      END.         
      IF avarfor > 0 THEN maxarbkort = avarfor.
      ELSE  maxarbkort = foremaxarbkort.      
      IF totarbkort > maxarbkort THEN DO:
         totarbkort = totarbkort -  klock100(nytid).
         CREATE felmeddtemp.  
         felmeddtemp.felmedd = "Max " + STRING(maxarbkort) + " timmar per år får skrivas på arbetstidförkortning,du har redan skrivit"  + STRING(totarbkort) + "timmar".
         RETURN.                  
      END.            
   END.  
   IF onr = "161" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "161"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.               
      ASSIGN 
      nytid = regstart.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = tid5.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).
      /*atkgräns*/            
      IF TODAY GE 01/01/2004 THEN maxarbkort = 27.
      
      IF totarbkort > maxarbkort THEN DO:
         totarbkort = totarbkort - klock100(nytid).
         CREATE felmeddtemp.  
         felmeddtemp.felmedd = "Max " + STRING(maxarbkort) + " timmar per år får skrivas på arbetstidförkortning,du har redan skrivit"  + STRING(totarbkort) + "timmar".
         RETURN.                  
      END.            
   END.  
   IF onr = "135" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "135"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.               
      ASSIGN 
      nytid = regstart.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = tid5.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).            
      
   END.  
END PROCEDURE.

PROCEDURE aforkortut_UI :   
   /* arbetstidsförkortning*/
   DEFINE BUFFER tidbuff10 FOR TIDREGITAB.
   DEFINE VARIABLE totarbkort AS DECIMAL NO-UNDO.
   DEFINE VARIABLE avarfor AS INTEGER NO-UNDO.
   regdatum = TODAY.
   RUN REGVEC.P.
   IF onr = "160" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "160"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.               
      ASSIGN 
      nytid = tid5.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = regslut.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).   
      IF Guru.Konstanter:globforetag = "gkal"  THEN foremaxarbkort = 63.
      ELSE IF Guru.Konstanter:globforetag = "SNAT"  THEN foremaxarbkort = 63.
      ELSE IF Guru.Konstanter:globforetag = "LULE"  THEN foremaxarbkort = 63.            
      ELSE foremaxarbkort = 54.   
      avarfor = 0.
      IF Guru.Konstanter:globforetag = "gkal" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "elpa" THEN DO:   
         RUN havafor (INPUT PERSONALTAB.PERSONALKOD, OUTPUT avarfor).                        
      END.         
      IF avarfor > 0 THEN maxarbkort = avarfor.
      ELSE maxarbkort = foremaxarbkort.      
      IF totarbkort > maxarbkort THEN DO:
         totarbkort = totarbkort - klock100(nytid).
         CREATE felmeddtemp.  
         felmeddtemp.felmedd = "Max " + STRING(maxarbkort) + " timmar per år får skrivas på arbetstidförkortning,du har redan skrivit"  + STRING(totarbkort) + "timmar".
         RETURN.                  
      END.            
   END.  
   IF onr = "161" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "161"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.               
      ASSIGN 
      nytid = tid5.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = regslut.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).            
      IF TODAY GE 01/01/2004 THEN maxarbkort = 27.
      ELSE maxarbkort = 18.
      IF totarbkort > maxarbkort THEN DO:
         totarbkort = totarbkort - klock100(nytid).
         CREATE felmeddtemp.  
         felmeddtemp.felmedd = "Max " + STRING(maxarbkort) + " timmar per år får skrivas på arbetstidförkortning,du har redan skrivit"  + STRING(totarbkort) + "timmar".
         RETURN.                  
      END.            
   END.  
   IF onr = "135" THEN DO:                     
      totarbkort = 0.                        
      FOR EACH tidbuff10 WHERE tidbuff10.PERSONALKOD = PERSONALTAB.PERSONALKOD AND tidbuff10.AONR = "135"
      AND YEAR(tidbuff10.DATUM) = YEAR(TODAY) AND tidbuff10.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(tidbuff10.TOTALT).
      END.               
      ASSIGN 
      nytid = tid5.
      RUN TIMSEK.P.
      regstartsek = sekunder.
      nytid = regslut.
      RUN TIMSEK.P.
      regslutsek = sekunder. 
      RUN TOTTID.P.            
      totarbkort = totarbkort +  klock100(nytid).                  
   END.  
END PROCEDURE.
PROCEDURE dagtot_UI :
   DEFINE INPUT PARAMETER dagstart  AS DECIMAL NO-UNDO.
   DEFINE INPUT PARAMETER lstarten  AS DECIMAL NO-UNDO.
   DEFINE INPUT PARAMETER lslutet AS DECIMAL NO-UNDO.
   DEFINE INPUT PARAMETER dagslut  AS DECIMAL NO-UNDO.
   DEFINE INPUT PARAMETER vflarb AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER dagtotal AS DECIMAL NO-UNDO.
   dagtotal = klock60(klock100(dagslut) - klock100(dagstart) - klock100(lslutet) + klock100(lstarten) + klock100(vflarb)).
END PROCEDURE.

{AVAFOR.I}


