/*STEG7.P EXTRA KÖRNING LULEÅ FÖR ATT ÅTERSTÄLLA PRISER SOM DE VAR INNAN UPPDATERINGEN 20061127*/
DEFINE VARIABLE prisvar AS DECIMAL NO-UNDO.

DEFINE TEMP-TABLE tidinah
   FIELD ENR                AS CHARACTER       
   FIELD BENAMNING          AS CHARACTER 
   FIELD ENHET              AS CHARACTER
   FIELD PRISFORE           AS DECIMAL        
   FIELD PRISEFTER          AS DECIMAL        
   FIELD PRISIDEPA          AS DECIMAL        
   FIELD PRISCHAR           AS CHARACTER        
   FIELD PRISINKOP          AS DECIMAL        
   INDEX ENR IS PRIMARY ENR.


DEFINE TEMP-TABLE infil
   FIELD PROGNAMN AS CHARACTER FORMAT "X(78)" 
   INDEX PRO IS PRIMARY PROGNAMN.

DEFINE VARIABLE filnamn AS CHARACTER NO-UNDO.   
 {AMERICANEUROPEAN.I}
{muswait.i} 
OUTPUT TO D:\ELPOOL\DELAD\PRO9\koll.txt APPEND.
PUT "Start KÖRNING. " SKIP.
OUTPUT CLOSE.
/*SÄKERHETSKOPIERING*/
OUTPUT TO D:\ELPOOL\DELAD\PRO9\mtrldep070326.d.
OPEN QUERY AQ FOR EACH MTRLDEP NO-LOCK.
GET FIRST AQ NO-LOCK.
DO WHILE AVAILABLE(MTRLDEP):
   EXPORT MTRLDEP.
   GET NEXT AQ NO-LOCK.
END.
CLOSE QUERY AQ.
OUTPUT CLOSE.

ASSIGN
   /*filnamn = "\\server04\d\elpool\elpnj\LULEÅ\STEG62.skv".*/
filnamn = "D:\ELPOOL\DELAD\PRO9\STEG62.skv".

EMPTY TEMP-TABLE tidinah NO-ERROR.

SESSION:NUMERIC-FORMAT = "EUROPEAN".
INPUT FROM VALUE(filnamn) NO-ECHO.
REPEAT:
   DO TRANSACTION: 
      CREATE tidinah.
      ASSIGN.
      IMPORT DELIMITER ";" tidinah   NO-ERROR.
   END.               
END.   
FOR EACH tidinah WHERE tidinah.ENR = "":
   DELETE tidinah.
END.            
FOR EACH tidinah:
   IF tidinah.PRISCHAR NE "" THEN DO:
      tidinah.PRISINKOP = DECIMAL(tidinah.PRISCHAR).
   END.   
   ELSE DO:
      tidinah.PRISINKOP = tidinah.PRISFORE.
   END.
END.
      
OUTPUT TO D:\ELPOOL\DELAD\PRO9\koll.txt APPEND.
PUT "Inläsning fil klart. " SKIP.
OUTPUT CLOSE.

SESSION:NUMERIC-FORMAT = "AMERICAN".
                                
/* OUTPUT TO C:\STEG6.TXT.                                             */
/* FOR EACH tidinah:                                                   */
/*    PUT TIDINAH.ENR ";" TIDINAH.PRISFORE ";" TIDINAH.PRISINKOP SKIP. */
/* END.                                                                */
/* OUTPUT CLOSE.                                                       */


OPEN QUERY IQ FOR EACH MTRLDEP WHERE MTRLDEP.DEPNR = 1 AND MTRLDEP.IBDATUM = 09/15/06 AND MTRLDEP.INVDATUM NE ? NO-LOCK.
DO TRANSACTION:
   GET FIRST IQ EXCLUSIVE-LOCK.
   FIND FIRST tidinah WHERE tidinah.ENR = MTRLDEP.ENR NO-LOCK NO-ERROR.
   IF AVAILABLE tidinah THEN DO:
      ASSIGN
      MTRLDEP.NPRIS = tidinah.PRISFORE
      MTRLDEP.BPRIS = tidinah.PRISFORE.
   END.
END.
REPEAT :
   DO TRANSACTION:
      GET NEXT IQ EXCLUSIVE-LOCK.
      IF AVAILABLE MTRLDEP THEN DO:
         FIND FIRST tidinah WHERE tidinah.ENR = MTRLDEP.ENR NO-LOCK NO-ERROR.
         IF AVAILABLE tidinah THEN DO:
            ASSIGN
            MTRLDEP.NPRIS = tidinah.PRISFORE
            MTRLDEP.BPRIS = tidinah.PRISFORE.
         END.
      END.
      ELSE LEAVE.
   END.
END. 


OPEN QUERY IQ FOR EACH MTRLDEP WHERE MTRLDEP.DEPNR = 1 AND MTRLDEP.IBDATUM = ? NO-LOCK.
DO TRANSACTION:
   GET FIRST IQ EXCLUSIVE-LOCK.
   FIND FIRST tidinah WHERE tidinah.ENR = MTRLDEP.ENR NO-LOCK NO-ERROR.
   IF AVAILABLE tidinah THEN DO:
      ASSIGN
      MTRLDEP.NPRIS = tidinah.PRISINKOP
      MTRLDEP.BPRIS = tidinah.PRISINKOP.
   END.
END.
REPEAT :
   DO TRANSACTION:
      GET NEXT IQ EXCLUSIVE-LOCK.
      IF AVAILABLE MTRLDEP THEN DO:
         FIND FIRST tidinah WHERE tidinah.ENR = MTRLDEP.ENR NO-LOCK NO-ERROR.
         IF AVAILABLE tidinah THEN DO:
            ASSIGN
            MTRLDEP.NPRIS = tidinah.PRISINKOP
            MTRLDEP.BPRIS = tidinah.PRISINKOP.
         END.
      END.
      ELSE LEAVE.
   END.
END. 


OUTPUT TO D:\ELPOOL\DELAD\PRO9\koll.txt APPEND.
PUT "Körning klart. " SKIP.
OUTPUT CLOSE.
{EUROPEANAMERICAN.I}
