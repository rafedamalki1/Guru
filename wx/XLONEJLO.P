 /*XLONEJLO.P*/
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO. 
DEFINE VARIABLE lonbelopp LIKE EKRAPPRESULT.ELONBELOPP NO-UNDO. 
DEFINE VARIABLE pkod LIKE PERSONALTAB.PERSONALKOD NO-UNDO.
DEFINE TEMP-TABLE lontilltemp
   FIELD ERSATTNING LIKE LONTILL.ERSATTNING 
   FIELD KOD LIKE LONTILL.KOD 
   FIELD LONTILLAGG LIKE LONTILL.LONTILLAGG 
   FIELD MULTI LIKE LONTILL.MULTIP 
   FIELD TYPKOD LIKE LONTILL.TYPKOD
   FIELD ENHET LIKE LONTILL.ENHET
   INDEX LON IS PRIMARY KOD LONTILLAGG. 
DEFINE TEMP-TABLE tidtemp
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD AONR LIKE TIDREGITAB.AONR 
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD DATUM LIKE TIDREGITAB.DATUM 
   FIELD LONTILLAGG LIKE TIDREGITAB.LONTILLAGG 
   FIELD LONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL 
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP
   FIELD AKOD LIKE ANSTFORMTAB.KOD
   FIELD PRIS LIKE TIDREGITAB.PRIS
   INDEX PERS IS PRIMARY PERSONALKOD DATUM AONR
   INDEX AONR AONR DATUM PERSONALKOD
   INDEX AKOD AKOD
    INDEX LONTILLAGG LONTILLAGG.

DEFINE QUERY lq FOR LONTILL.
DEFINE QUERY tq FOR TIDREGITAB.          
DEFINE QUERY lqtq FOR lontilltemp, tidtemp SCROLLING.
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
globforetag = FORETAG.FORETAG. 
OPEN QUERY lq FOR EACH LONTILL /*WHERE SUBSTRING(LONTILL.TYPKOD,1,3) = "LON" OR 
SUBSTRING(LONTILL.TYPKOD,1,3) = "MIL" OR SUBSTRING(LONTILL.TYPKOD,1,3) = "TRA" OR
SUBSTRING(LONTILL.TYPKOD,1,3) = "REL" */
USE-INDEX LON NO-LOCK.
GET FIRST lq NO-LOCK.
DO WHILE AVAILABLE(LONTILL):
   CREATE lontilltemp.
   ASSIGN
   lontilltemp.ERSATTNING = LONTILL.ERSATTNING 
   lontilltemp.KOD = LONTILL.KOD 
   lontilltemp.LONTILLAGG = LONTILL.LONTILLAGG 
   lontilltemp.MULTI = LONTILL.MULTIP 
   lontilltemp.TYPKOD = LONTILL.TYPKOD
   lontilltemp.ENHET = LONTILL.ENHET.
   GET NEXT lq NO-LOCK.
END.
/*
OPEN QUERY tq FOR EACH TIDREGITAB WHERE  
YEAR(TIDREGITAB.DATUM) = 1998 AND TIDREGITAB.VECKOKORD NE "" AND 
TIDREGITAB.LONTILLAGG NE "" USE-INDEX AONR NO-LOCK.
*/
OPEN QUERY tq FOR EACH TIDREGITAB WHERE  
YEAR(TIDREGITAB.DATUM) = 1997 AND TIDREGITAB.AONR = "220162" AND
MONTH(TIDREGITAB.DATUM) = 03 AND
TIDREGITAB.LONTILLAGG NE "" USE-INDEX AONR NO-LOCK.
GET FIRST tq NO-LOCK.
DO WHILE AVAILABLE(TIDREGITAB):
   CREATE tidtemp.
   ASSIGN
   tidtemp.PERSONALKOD = TIDREGITAB.PERSONALKOD
   tidtemp.AONR = TIDREGITAB.AONR 
   tidtemp.DELNR = TIDREGITAB.DELNR
   tidtemp.DATUM = TIDREGITAB.DATUM 
   tidtemp.LONTILLAGG = TIDREGITAB.LONTILLAGG
   tidtemp.LONTILLANTAL = TIDREGITAB.LONTILLANTAL 
   tidtemp.PRISTYP = TIDREGITAB.PRISTYP
   tidtemp.PRIS = TIDREGITAB.PRIS.          
   GET NEXT tq NO-LOCK.
END.
REPEAT:
   FIND FIRST tidtemp WHERE tidtemp.AKOD = "" USE-INDEX AKOD NO-LOCK NO-ERROR.
   IF AVAILABLE tidtemp THEN DO:
      IF pkod NE tidtemp.PERSONALKOD THEN DO: 
         pkod = tidtemp.PERSONALKOD.  
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = tidtemp.PERSONALKOD 
         USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
         IF AVAILABLE PERSONALTAB THEN DO:
            FIND FIRST ANSTFORMTAB WHERE
            ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
            USE-INDEX ANSTF NO-LOCK NO-ERROR.
         END.
         ELSE DO:
            FIND FIRST BORTPERS WHERE BORTPERS.PERSONALKOD = tidtemp.PERSONALKOD 
            USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
            IF AVAILABLE BORTPERS THEN DO:
               FIND FIRST ANSTFORMTAB WHERE
               ANSTFORMTAB.ANSTALLNING = BORTPERS.ANSTALLNING
               USE-INDEX ANSTF NO-LOCK NO-ERROR.
            END.
         END.
         IF AVAILABLE ANSTFORMTAB THEN DO:
            FOR EACH tidtemp WHERE tidtemp.PERSONALKOD = pkod USE-INDEX PERS:
               ASSIGN
               tidtemp.AKOD = ANSTFORMTAB.KOD.
            END.              
         END.      
         ELSE DO:
            FOR EACH tidtemp WHERE tidtemp.PERSONALKOD = pkod USE-INDEX PERS:
               DELETE tidtemp.
            END.
         END.
      END.
   END.
   ELSE LEAVE.
END. 
OPEN QUERY lqtq FOR EACH lontilltemp USE-INDEX LON NO-LOCK,
EACH tidtemp WHERE tidtemp.LONTILLAGG = lontilltemp.LONTILLAGG AND tidtemp.AKOD = lontilltemp.KOD  
USE-INDEX PERS NO-LOCK.    
GET FIRST lqtq NO-LOCK.
DO WHILE AVAILABLE(lontilltemp):
   IF lontilltemp.TYPKOD = "REL" THEN DO:      
      nytid = tidtemp.LONTILLANTAL.
      RUN TIMSEK.P.
      tidtemp.LONTILLANTAL = (sekunder / 3600).                 
      lonbelopp = (tidtemp.PRIS * lontilltemp.MULTI) * tidtemp.LONTILLANTAL. 
   END.
   ELSE DO:
      IF lontilltemp.ENHET = "KR" THEN DO:
         lonbelopp = tidtemp.LONTILLANTAL.          
      END.
      ELSE IF lontilltemp.ENHET = "TI" THEN DO:
         nytid = tidtemp.LONTILLANTAL.
         RUN TIMSEK.P.            
         lonbelopp = (sekunder / 3600) * lontilltemp.ERSATTNING.
      END.
      ELSE DO:
         lonbelopp = tidtemp.LONTILLANTAL * lontilltemp.ERSATTNING.           
      END.         
      IF globforetag  = "NORD" THEN DO:
         IF lontilltemp.LONTILLAGG = "FRUK" OR 
         lontilltemp.LONTILLAGG = "LUNC" OR 
         lontilltemp.LONTILLAGG = "MIDD" OR 
         lontilltemp.LONTILLAGG = "FRLU" OR
         lontilltemp.LONTILLAGG = "FRMI" OR 
         lontilltemp.LONTILLAGG = "LUMI" OR 
         lontilltemp.LONTILLAGG = "FLMI" THEN DO:
            lontilltemp.LONTILLAGG = "850".
            lonbelopp = lonbelopp * -1 * lontilltemp.ERSATTNING.
         END.
      END.
      IF globforetag = 'GRAN' OR globforetag = "GADM" OR 
      globforetag = 'ROSL' OR globforetag = 'MALA'  THEN DO:                                                   
         IF lontilltemp.LONTILLAGG = "720" OR 
         lontilltemp.LONTILLAGG = "721" OR 
         lontilltemp.LONTILLAGG = "722" OR 
         lontilltemp.LONTILLAGG = "726" OR
         lontilltemp.LONTILLAGG = "727" OR 
         lontilltemp.LONTILLAGG = "728" OR 
         lontilltemp.LONTILLAGG = "729" THEN DO:               
            lonbelopp = lonbelopp * -1.
         END.
      END.
   END.
   DO TRANSACTION:
      FIND FIRST SUMEJLON WHERE SUMEJLON.PERSONALKOD = tidtemp.PERSONALKOD AND
      SUMEJLON.AONR = tidtemp.AONR AND SUMEJLON.DELNR = tidtemp.DELNR AND
      SUMEJLON.DATUM = tidtemp.DATUM AND SUMEJLON.PRISTYP = tidtemp.PRISTYP AND
      SUMEJLON.TYPKOD = lontilltemp.TYPKOD
      USE-INDEX TYPKOD EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE SUMEJLON THEN CREATE SUMEJLON.
      ASSIGN
      SUMEJLON.PERSONALKOD = tidtemp.PERSONALKOD 
      SUMEJLON.AONR = tidtemp.AONR 
      SUMEJLON.DELNR = tidtemp.DELNR 
      SUMEJLON.TYPKOD = lontilltemp.TYPKOD
      SUMEJLON.DATUM = tidtemp.DATUM 
      SUMEJLON.PRISTYP = tidtemp.PRISTYP
      SUMEJLON.LONKOST = SUMEJLON.LONKOST + lonbelopp.
   END.
   GET NEXT lqtq NO-LOCK.
END.            
