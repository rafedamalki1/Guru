/*XKALKAONR.P kalkrutin
KALKAONR.AKTIV 
KALKAONR.AONR 
KALKAONR.ARTAL 
KALKAONR.DELNR 
KALKAONR.KALKNR 
KALKAONR.LASTA 
KALKAONR.OMRADE 
KALKAONR.PLANNR 
KALKAONR.STATUSNIV 
KALKAONR.TYP


*/
FOR EACH aonrtab WHERE aonrtab.aonravdatum = ?:
   aonrtab.aonravdatum = 01/01/1991.
END.
FOR EACH plannrtab WHERE plannrtab.plannravdatum = ?:
   plannrtab.plannravdatum = 01/01/1991.
END.
DEFINE BUFFER kalkaobuff FOR KALKAONR.
DEFINE QUERY kq FOR KALKAONR.
OPEN QUERY fq FOR EACH FASTSPEC NO-LOCK.
GET FIRST fq NO-LOCK.
DO WHILE AVAILABLE(FASTSPEC):
   DO TRANSACTION:
      FIND FIRST KALKAONR WHERE KALKAONR.KALKNR = FASTSPEC.KALKNR 
      EXCLUSIVE-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKAONR THEN CREATE KALKAONR.
      ASSIGN 
      KALKAONR.AKTIV  = FASTSPEC.AKTIV 
      KALKAONR.KALKNR = FASTSPEC.KALKNR
      KALKAONR.OMRADE = FASTSPEC.OMRADE
      KALKAONR.TYP    = FASTSPEC.TYP   
      KALKAONR.LASTA = FALSE.
      IF FASTSPEC.AONR = "?" THEN DO:
         GET CURRENT fq EXCLUSIVE-LOCK.
         FASTSPEC.AONR = ?.
      END.
      IF FASTSPEC.PLANNR = "?" THEN DO:
         GET CURRENT fq EXCLUSIVE-LOCK.
         FASTSPEC.PLANNR = ?.
      END.
      IF FASTSPEC.AONR NE ? THEN DO:
         ASSIGN
         KALKAONR.AONR      = FASTSPEC.AONR  
         KALKAONR.DELNR     = FASTSPEC.DELNR 
         KALKAONR.STATUSNIV = "HUV".
      END.
      ELSE IF FASTSPEC.PLANNR NE ? THEN DO:
         ASSIGN
         KALKAONR.PLANNR      = FASTSPEC.PLANNR  
         KALKAONR.ARTAL     = FASTSPEC.ARTAL 
         KALKAONR.STATUSNIV = "HUV".     
      END.
      ELSE DO:
         IF FASTSPEC.SLUTDAG NE "" THEN DO:         
            ASSIGN
            KALKAONR.AONR     = FASTSPEC.SLUTDAG  
            KALKAONR.DELNR    = FASTSPEC.SLUTVNR 
            KALKAONR.STATUSNIV = "ALT".
            GET CURRENT fq EXCLUSIVE-LOCK.
            ASSIGN
            FASTSPEC.AONR  = FASTSPEC.SLUTDAG 
            FASTSPEC.DELNR = FASTSPEC.SLUTVNR.
            ASSIGN
            FASTSPEC.SLUTDAG = ""
            FASTSPEC.SLUTVNR = 0.
         END.
         ELSE DO:
            KALKAONR.STATUSNIV = "HUV".
         END.
      END.
      IF KALKAONR.AONR = "" THEN DO:
         ASSIGN
         KALKAONR.AONR = ?
         KALKAONR.DELNR = ?.      
      END.
      IF KALKAONR.PLANNR = "" THEN DO:
         ASSIGN
         KALKAONR.PLANNR = ?
         KALKAONR.ARTAL = ?.
      END.   
      FIND FIRST KALKNATT WHERE KALKNATT.AONR = FASTSPEC.AONR AND KALKNATT.DELNR = FASTSPEC.DELNR AND
      KALKNATT.TYP = FASTSPEC.TYP
      EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KALKNATT THEN DO:
         ASSIGN
         KALKNATT.AONR = "" 
         KALKNATT.DELNR = FASTSPEC.KALKNR.
      END.
   END.
   
   GET NEXT fq NO-LOCK.
END.

OPEN QUERY ksq FOR EACH KALKSPEC NO-LOCK.
GET FIRST ksq NO-LOCK.
DO WHILE AVAILABLE(KALKSPEC):
   OPEN QUERY tq FOR EACH KALKYL WHERE KALKYL.RECKALKYL = RECID(KALKSPEC) NO-LOCK.
   GET FIRST TQ NO-LOCK.
   DO WHILE AVAILABLE(KALKYL):
      DO TRANSACTION:
         GET CURRENT TQ EXCLUSIVE-LOCK.
         KALKYL.RECKALKYL = KALKSPEC.KALKNR.
      END.
      GET NEXT TQ NO-LOCK.
   END.
   DO TRANSACTION:
      FIND FIRST KALKAONR WHERE KALKAONR.KALKNR = KALKSPEC.KALKNR 
      EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE KALKAONR THEN CREATE KALKAONR.
      ASSIGN 
      KALKAONR.AKTIV  = KALKSPEC.AKTIV 
      KALKAONR.KALKNR = KALKSPEC.KALKNR
      KALKAONR.OMRADE = KALKSPEC.OMRADE
      KALKAONR.TYP    = 6   
      KALKAONR.LASTA = FALSE.
      IF KALKSPEC.AONR = "?" THEN DO:
         GET CURRENT ksq EXCLUSIVE-LOCK.
         KALKSPEC.AONR = ?.
      END.
      IF KALKSPEC.PLANNR = "?" THEN DO:
         GET CURRENT ksq EXCLUSIVE-LOCK.
         KALKSPEC.PLANNR = ?.
      END.
      IF KALKSPEC.AONR NE ? THEN DO:
         ASSIGN
         KALKAONR.AONR      = KALKSPEC.AONR  
         KALKAONR.DELNR     = KALKSPEC.DELNR 
         KALKAONR.STATUSNIV = "HUV".
      END.
      ELSE IF KALKSPEC.PLANNR NE ? THEN DO:
         ASSIGN
         KALKAONR.PLANNR      = KALKSPEC.PLANNR  
         KALKAONR.ARTAL     = KALKSPEC.ARTAL 
         KALKAONR.STATUSNIV = "HUV".
      END.
      IF KALKAONR.AONR = ? THEN KALKAONR.AONR = "".
      IF KALKAONR.PLANNR = ? THEN KALKAONR.PLANNR = "".
      FIND FIRST KALKNATT WHERE KALKNATT.AONR = KALKSPEC.AONR AND KALKNATT.DELNR = KALKSPEC.DELNR 
      EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KALKNATT THEN DO:
         ASSIGN
         KALKNATT.AONR = "" 
         KALKNATT.DELNR = KALKSPEC.KALKNR.
      END.
   END.
   GET NEXT ksq NO-LOCK.
END.
RUN satt_UI (INPUT 2).
RUN satt_UI (INPUT 1).
RUN satt_UI (INPUT 3).
RUN satt_UI (INPUT 4).
RUN satt_UI (INPUT 5).
RUN satt_UI (INPUT 6).
PROCEDURE satt_UI: 
   DEFINE INPUT PARAMETER ktyp AS INTEGER NO-UNDO.
   OPEN QUERY kq FOR EACH KALKAONR WHERE KALKAONR.AONR NE ? AND KALKAONR.TYP = ktyp NO-LOCK.
   GET FIRST kq NO-LOCK.
   DO WHILE AVAILABLE(KALKAONR):
      RUN koll_UI.
      GET NEXT kq NO-LOCK.
   END.
   OPEN QUERY kq FOR EACH KALKAONR WHERE KALKAONR.PLANNR NE ? AND KALKAONR.TYP = ktyp NO-LOCK.
   GET FIRST kq NO-LOCK.
   DO WHILE AVAILABLE(KALKAONR):
      RUN koll_UI.
      GET NEXT kq NO-LOCK.
   END.
END PROCEDURE.
PROCEDURE koll_UI:
   IF KALKAONR.STATUSNIV = "UF" THEN RETURN.
   DO TRANSACTION:
      GET CURRENT kq EXCLUSIVE-LOCK.
      IF KALKAONR.AONR NE ? THEN DO:
         FIND FIRST kalkaobuff WHERE kalkaobuff.AONR = KALKAONR.AONR AND
         kalkaobuff.DELNR = KALKAONR.DELNR AND kalkaobuff.STATUSNIV = "UF"
         EXCLUSIVE-LOCK NO-ERROR. 
      END.
      ELSE DO:
         FIND FIRST kalkaobuff WHERE kalkaobuff.PLANNR = KALKAONR.PLANNR AND
         kalkaobuff.ARTAL = KALKAONR.ARTAL AND kalkaobuff.STATUSNIV = "UF"
         EXCLUSIVE-LOCK NO-ERROR. 
      END.
      IF AVAILABLE kalkaobuff THEN DO:
         IF KALKAONR.AONR NE "" THEN DO:
            FIND FIRST kalkaobuff WHERE kalkaobuff.AONR = KALKAONR.AONR AND
            kalkaobuff.DELNR = KALKAONR.DELNR AND kalkaobuff.STATUSNIV = "HUV"
            AND kalkaobuff.TYP = KALKAONR.TYP
            EXCLUSIVE-LOCK NO-ERROR. 
         END.
         ELSE DO:
            FIND FIRST kalkaobuff WHERE kalkaobuff.PLANNR = KALKAONR.PLANNR AND
            kalkaobuff.ARTAL = KALKAONR.ARTAL AND kalkaobuff.STATUSNIV = "HUV"
            AND kalkaobuff.TYP = KALKAONR.TYP
            EXCLUSIVE-LOCK NO-ERROR. 
         END.
         IF AVAILABLE kalkaobuff THEN DO:
            KALKAONR.STATUSNIV = "ALT".
         END.
         ELSE DO:
            KALKAONR.STATUSNIV = "HUV".
         END.
      END.
      ELSE DO:
         KALKAONR.STATUSNIV = "UF".
      END.
   END.
END PROCEDURE.

