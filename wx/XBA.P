OPEN QUERY aq FOR EACH AONRTAB NO-LOCK.
GET FIRST AQ NO-LOCK.
DO WHILE AVAILABLE(AONRTAB):
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = AONRTAB.BEREDARE 
   NO-LOCK NO-ERROR.
   IF NOT AVAILABLE PERSONALTAB THEN DO TRANSACTION:
      GET CURRENT AQ EXCLUSIVE-LOCK.
      AONRTAB.BEREDARE = AONRTAB.ARBANSVARIG.
   END.
   FIND FIRST BEREDAONR WHERE BEREDAONR.PERSONALKOD = AONRTAB.BEREDARE 
   USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.   
   IF NOT AVAILABLE BEREDAONR THEN DO:        
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = AONRTAB.BEREDARE 
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
      IF AVAILABLE PERSONALTAB THEN DO TRANSACTION:         
         CREATE BEREDAONR.
         ASSIGN BEREDAONR.PERSONALKOD = PERSONALTAB.PERSONALKOD
         BEREDAONR.FORNAMN = PERSONALTAB.FORNAMN
         BEREDAONR.EFTERNAMN = PERSONALTAB.EFTERNAMN.                   
      END.
   END.   
   MESSAGE AONRTAB.AONR DELNR.
   PAUSE 0.
   GET NEXT AQ NO-LOCK.
END.
