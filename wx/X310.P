DEFINE VARIABLE tidtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE pkod AS CHARACTER NO-UNDO.
DEFINE VARIABLE tid100 AS DECIMAL NO-UNDO. 
DEFINE VARIABLE otidtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE arrhjsum LIKE TIDREGITAB.BERANTAL NO-UNDO.    
DEFINE VARIABLE arrhjsumtid LIKE TIDREGITAB.BERANTAL NO-UNDO.  
DEFINE VARIABLE arrhjsumotid LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrhjsumove LIKE TIDREGITAB.BERANTAL NO-UNDO.
DEFINE VARIABLE arrhjsumtra LIKE TIDREGITAB.BERANTAL NO-UNDO.   
DEFINE VARIABLE arrhjsumlon LIKE TIDREGITAB.BERANTAL NO-UNDO.   

DEFINE TEMP-TABLE tidkoll
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD                  
   FIELD MANAD AS INTEGER
   FIELD TIMMAR AS DECIMAL
   FIELD OTIMMAR AS DECIMAL
   FIELD AVTAL LIKE PERSONALTAB.ANSTALLNING
   INDEX PKOD IS PRIMARY PERSONALKOD
   INDEX AVTAL AVTAL.

DEFINE TEMP-TABLE SLUTSUM
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD                  
   FIELD MANAD AS INTEGER
   FIELD TIMMAR AS DECIMAL
   FIELD OTIMMAR AS DECIMAL
   FIELD AVTAL LIKE PERSONALTAB.ANSTALLNING
   INDEX PKOD IS PRIMARY MANAD AVTAL
   INDEX AVTAL AVTAL.
DEFINE TEMP-TABLE SLUTSUM1
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD                  
   FIELD MANAD AS INTEGER
   FIELD TIMMAR AS DECIMAL
   FIELD OTIMMAR AS DECIMAL
   FIELD AVTAL LIKE PERSONALTAB.ANSTALLNING
   INDEX PKOD IS PRIMARY MANAD AVTAL
   INDEX AVTAL AVTAL.

OUTPUT TO PRINTER.
OPEN QUERY tq FOR EACH TIDREGITAB WHERE TIDREGITAB.AONR = "130310" AND 
YEAR(TIDREGITAB.DATUM) = 1998 NO-LOCK.
GET FIRST tq NO-LOCK.
DO WHILE AVAILABLE(TIDREGITAB):
   ASSIGN
   tidtim = 0
   otidtim = 0.   
   IF TIDREGITAB.OKOD1 = " " AND TIDREGITAB.OKOD2 = " " AND TIDREGITAB.OKOD3 = " " THEN DO:   
      tidtim = DECIMAL(SUBSTRING(STRING(TIDREGITAB.TOTALT,"99.99"),1,2)).
      tid100 = DECIMAL(SUBSTRING(STRING(TIDREGITAB.TOTALT,"99.99"),4,2)) / 60.
      tidtim = tidtim + tid100.     
   END.
   ELSE DO:
      otidtim = DECIMAL(SUBSTRING(STRING(TIDREGITAB.TOTALT,"99.99"),1,2)).
      tid100 = DECIMAL(SUBSTRING(STRING(TIDREGITAB.TOTALT,"99.99"),4,2)) / 60.
      otidtim = otidtim + tid100.     
   END.
   CREATE tidkoll.
   ASSIGN 
   tidkoll.PERSONALKOD = TIDREGITAB.PERSONALKOD                  
   tidkoll.MANAD = MONTH(TIDREGITAB.DATUM)
   tidkoll.TIMMAR = tidtim
   tidkoll.OTIMMAR = otidtim.
   GET NEXT tq NO-LOCK.
END.
REPEAT:
   FIND FIRST tidkoll WHERE tidkoll.AVTAL = "" USE-INDEX AVTAL NO-LOCK NO-ERROR.
   IF NOT AVAILABLE tidkoll THEN LEAVE.
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = tidkoll.PERSONALKOD NO-LOCK NO-ERROR.
   IF NOT AVAILABLE PERSONALTAB THEN DO:
      FIND FIRST BORTPERS WHERE BORTPERS.PERSONALKOD = tidkoll.PERSONALKOD NO-LOCK NO-ERROR.                  
      IF NOT AVAILABLE BORTPERS THEN DO:
         pkod = TIDKOLL.PERSONALKOD.
         DO TRANSACTION:
            FOR EACH tidkoll WHERE tidkoll.PERSONALKOD = pkod USE-INDEX PKOD:
               ASSIGN
               tidkoll.AVTAL = "XX".
            END.
         END.        
      END.   
      ELSE DO:
         DO TRANSACTION:
            FOR EACH tidkoll WHERE tidkoll.PERSONALKOD = BORTPERS.PERSONALKOD USE-INDEX PKOD:
               ASSIGN
               tidkoll.AVTAL = BORTPERS.ANSTALLNING.
            END.     
         END.
      END.
   END.
   ELSE DO:   
      DO TRANSACTION:
         FOR EACH tidkoll WHERE tidkoll.PERSONALKOD = PERSONALTAB.PERSONALKOD USE-INDEX PKOD:
            ASSIGN
            tidkoll.AVTAL = PERSONALTAB.ANSTALLNING.
         END.     
      END.
   END.
END.   
   FOR EACH tidkoll BREAK BY tidkoll.AVTAL BY tidkoll.MANAD:           
      ACCUMULATE 
      tidkoll.TIMMAR (TOTAL BY tidkoll.AVTAL BY tidkoll.MANAD). 
      ACCUMULATE 
      tidkoll.OTIMMAR (TOTAL BY tidkoll.AVTAL BY tidkoll.MANAD). 
      IF LAST-OF(tidkoll.MANAD) THEN DO TRANSACTION:
         CREATE slutsum.
         ASSIGN 
         slutsum.MANAD = tidkoll.MANAD
         slutsum.AVTAL = tidkoll.AVTAL                   
         slutsum.TIMMAR = (ACCUM TOTAL tidkoll.TIMMAR) - arrhjsumtid 
         slutsum.OTIMMAR = (ACCUM TOTAL tidkoll.OTIMMAR) - arrhjsumotid
         arrhjsumtid = ACCUM TOTAL tidkoll.TIMMAR. 
         arrhjsumotid = ACCUM TOTAL tidkoll.OTIMMAR.         
      END.     
   END. 
   FOR EACH SLUTSUM:
   DISPLAY slutsum.MANAD slutsum.TIMMAR slutsum.OTIMMAR slutsum.AVTAL WITH FRAME CC DOWN.
   END.
   arrhjsumtid = 0.
   arrhjsumotid = 0.
   FOR EACH slutsum BREAK BY slutsum.AVTAL :           
      ACCUMULATE 
      slutsum.TIMMAR (TOTAL BY slutsum.AVTAL). 
      ACCUMULATE 
      slutsum.OTIMMAR (TOTAL BY slutsum.AVTAL). 
      IF LAST-OF(slutsum.AVTAL) THEN DO TRANSACTION:
         CREATE slutsum1.
         ASSIGN          
         slutsum1.AVTAL = slutsum.AVTAL                   
         slutsum1.TIMMAR = (ACCUM TOTAL slutsum.TIMMAR) - arrhjsumtid 
         slutsum1.OTIMMAR = (ACCUM TOTAL slutsum.OTIMMAR) - arrhjsumotid
         arrhjsumtid = ACCUM TOTAL slutsum.TIMMAR. 
         arrhjsumotid = ACCUM TOTAL slutsum.OTIMMAR.         
      END.     
   END. 
   FOR EACH SLUTSUM1:
   DISPLAY slutsum1.TIMMAR slutsum1.OTIMMAR slutsum1.AVTAL WITH FRAME CC1 DOWN.
   END.
