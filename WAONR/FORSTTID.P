/*FORSTTID.P*/
OPEN QUERY aonrq FOR EACH AONRTAB WHERE AONRTAB.AONRAVDATUM = 01/01/91 
USE-INDEX AONR NO-LOCK.   
GET FIRST aonrq NO-LOCK.
DO WHILE AVAILABLE(AONRTAB):  
   FIND FIRST TIDREGITAB WHERE TIDREGITAB.AONR = AONRTAB.AONR AND 
   TIDREGITAB.DELNR = AONRTAB.DELNR
   USE-INDEX AONR NO-LOCK NO-ERROR.

   IF NOT AVAILABLE TIDREGITAB THEN DO :
      IF AONRTAB.STARTDATUM NE ? THEN DO TRANSACTION:
         GET CURRENT aonrq EXCLUSIVE-LOCK NO-WAIT.
         IF LOCKED(AONRTAB) = FALSE THEN  DO:
            ASSIGN AONRTAB.STARTDATUM = ?.
            FIND FIRST AONRTIDLAGE WHERE 
            AONRTIDLAGE.AONR = AONRTAB.AONR AND 
            AONRTIDLAGE.DELNR = AONRTAB.DELNR AND
            AONRTIDLAGE.IDTIDLAG = "TIDFÖRD"
            EXCLUSIVE-LOCK NO-ERROR.
            IF AVAILABLE AONRTIDLAGE THEN DO:
               DELETE AONRTIDLAGE.         
            END.
         END.
      END.
   END.
   ELSE IF AONRTAB.STARTDATUM NE TIDREGITAB.DATUM THEN DO:
      DO TRANSACTION:
         GET CURRENT aonrq EXCLUSIVE-LOCK NO-WAIT.
         IF LOCKED(AONRTAB) = FALSE THEN  DO:
            ASSIGN
            AONRTAB.STARTDATUM = TIDREGITAB.DATUM.
         END.
      END.
      GET CURRENT aonrq NO-LOCK.
      RUN TLAGAUTO.P  
      (INPUT "NATT", INPUT RECID(AONRTAB), INPUT "TIDFÖRD").                  
   END.
   GET NEXT aonrq NO-LOCK.
END.
   
   
