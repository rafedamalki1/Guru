/*PROGRESSSTARTN.P*/

{KALKYLKAT.I}
{KALKYLPRODATA.i}
DEFINE VARIABLE LocalAppServerHandle  AS HANDLE NO-UNDO.
RUN Andra_UI (INPUT 101126, input "0910").
PROCEDURE Andra_UI :
   DEFINE INPUT  PARAMETER kalknr AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER omrvar AS CHARACTER NO-UNDO.
   RUN ConKalkyldb_UI.
   RUN LaddaKalkyl IN LocalAppServerHandle (INPUT kalknr,INPUT omrvar,OUTPUT DATASET KalkylDS).
   RUN KalkTracking(TRUE).
   FOR LAST kalknumtt  WHERE NO-LOCK BY NUM:
      IF kalknumtt.ARBKOD = "egen" then.
      ELSE DO:
         DISPLAY kalknumtt.ARBKOD kalknumtt.LOPNR kalknumtt.ANTAL kalknumtt.num.
         
      END.
   END.   
   RUN KalkSpara.
   RUN DisConKalkyldb_UI. 
END PROCEDURE.   
PROCEDURE KalkTracking :
   DEFINE INPUT PARAMETER onoff AS LOGICAL NO-UNDO.
   TEMP-TABLE kalknumtt:TRACKING-CHANGES = onoff.
   TEMP-TABLE kalknumsubtt:TRACKING-CHANGES = onoff.
      
END PROCEDURE.

PROCEDURE KalkSpara :

   DEFINE VARIABLE hDSChanges AS HANDLE NO-UNDO.
   RUN KalkTracking(false).
   CREATE DATASET hDSChanges.
   hDSChanges:CREATE-LIKE (DATASET KalkylDS:HANDLE).
   hDSChanges:GET-CHANGES (DATASET KalkylDS:HANDLE).
   RUN SparaProDataSetKalkylDS IN LocalAppServerHandle(INPUT DATASET-HANDLE hDSChanges).
   hDSChanges:MERGE-CHANGES(DATASET KalkylDS:HANDLE).
   RUN KalkTracking(TRUE).
   

END PROCEDURE.
/*con av db då ej oo*/
PROCEDURE ConKalkyldb_UI:
   RUN KALKBERAPPDS.p PERSISTENT SET LocalAppServerHandle (INPUT CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79)).
   
END PROCEDURE.
PROCEDURE DisConKalkyldb_UI :
    IF VALID-HANDLE(LocalAppServerHandle) THEN DELETE PROCEDURE LocalAppServerHandle.
END PROCEDURE.  
/*
DEFINE TEMP-TABLE kalkhuvtt NO-UNDO  
   BEFORE-TABLE kalkhuvttbef
   FIELD KALKNR AS INTEGER
   FIELD OMRADE AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD KLOGID AS INTEGER
   FIELD TYPKALK AS INTEGER 
   FIELD EGETMTRL AS LOGICAL
   FIELD EGNAPRISER AS LOGICAL
   FIELD FAKTORER AS LOGICAL
   FIELD TTRECID AS RECID
   FIELD ANMARKNING AS CHARACTER
   FIELD BESTID AS CHARACTER
   FIELD KALKANV AS CHARACTER
   FIELD ANVANDARE AS CHARACTER
   FIELD AKTIV AS LOGICAL INITIAL TRUE
   FIELD UTYP AS INTEGER INITIAL 1
   INDEX KALKNR KALKNR
   INDEX TYPKALK TYPKALK.
DEFINE TEMP-TABLE ekalkhuvtt NO-UNDO LIKE kalkhuvtt.
DEFINE  TEMP-TABLE kalknumtt NO-UNDO
   BEFORE-TABLE kalknumttbef
   FIELD KALKNR AS INTEGER
   FIELD OMRADE AS CHARACTER
   FIELD KLOGSUBID AS INTEGER
   FIELD ARBKOD AS CHARACTER
   FIELD LOPNR AS INTEGER    
   FIELD NUM AS INTEGER
   FIELD MATRIS AS INTEGER 
   FIELD BENAMNING AS CHARACTER
   FIELD ANTAL AS DECIMAL  LABEL "Antal"  DECIMALS 6  /*OBS MÅNGA DECIMALER*/
   FIELD ENHET AS CHARACTER
   FIELD KOMMENTAR AS CHARACTER
   FIELD ANMARKNING AS CHARACTER
   FIELD TTRECID AS RECID
   FIELD TYPKALK AS INTEGER 
   FIELD TOTKOST AS DECIMAL   DECIMALS 4 /*OBS MÅNGA DECIMALER*/  
   FIELD MARKNING AS CHARACTER
   FIELD MARKSUB AS CHARACTER
   FIELD RISK AS DECIMAL  DECIMALS 4
   FIELD VINST AS DECIMAL  DECIMALS 4
   FIELD FRITOTKOST AS DECIMAL DECIMALS 4
  
   FIELD SID AS INTEGER   
   FIELD BERNUM AS INTEGER
   INDEX SID SID ARBKOD LOPNR
   INDEX BERNUM BERNUM ARBKOD LOPNR
   
   INDEX KALKNR KALKNR 
   INDEX MATRIS KALKNR MATRIS
   INDEX KLOGSUBID KLOGSUBID
   INDEX ARBKOD IS PRIMARY ARBKOD LOPNR NUM
   INDEX NUM NUM.
   
   /*FIELD STTOTKOST  AS DECIMAL  /*styckkostnad lena*/  
   FIELD STFRITOTKOST  AS DECIMAL
   FIELD STPROJKOST  AS DECIMAL
   FIELD STFRIPROJKOST  AS DECIMAL
   FIELD STUTSMET  AS DECIMAL
   FIELD STFRIUTSMET  AS DECIMAL*/
   
   
   
DEFINE BUFFER kalknumttbuf FOR kalknumtt.   
DEFINE TEMP-TABLE ekalknumtt NO-UNDO LIKE kalknumtt.
   
DEFINE TEMP-TABLE kalknumsubtt NO-UNDO
   BEFORE-TABLE kalknumsubttbef
   FIELD KALKNR AS INTEGER
   FIELD OMRADE AS CHARACTER
   FIELD NUM AS INTEGER 
   FIELD NUMSUBID AS INTEGER  
   FIELD KPID AS INTEGER
   FIELD TIMMAR AS DECIMAL     DECIMALS 10
   FIELD KOSTNAD AS DECIMAL         DECIMALS 4                                
   FIELD BENAMNING AS CHARACTER
   FIELD PRIS AS DECIMAL      DECIMALS 10
   FIELD MARKNING AS CHARACTER
   FIELD MARKSUB AS CHARACTER
   FIELD FRITIMMAR AS DECIMAL   DECIMALS 10
   FIELD FRIKOSTNAD AS DECIMAL   DECIMALS 10
   FIELD FRIBENAMNING AS CHARACTER
   FIELD AVRUND AS DECIMAL     DECIMALS 10
   FIELD FRIAVRUND AS DECIMAL     DECIMALS 10
   FIELD FRIPRIS AS DECIMAL       DECIMALS 10
   FIELD TTRECID AS RECID
   FIELD EGENPRISUPP AS LOGICAL
   FIELD EGENKODUPP AS LOGICAL
   INDEX NUM NUM NUMSUBID
   INDEX BENAMNING IS PRIMARY BENAMNING.

DEFINE DATASET KalkylDS FOR kalkhuvtt,kalknumtt,kalknumsubtt
DATA-RELATION huvNumsDR FOR kalkhuvtt, kalknumtt RELATION-FIELDS (kalkhuvtt.KALKNR,kalknumtt.KALKNR,kalkhuvtt.OMRADE,kalknumtt.OMRADE)
DATA-RELATION numSubsDR FOR kalknumtt, kalknumsubtt RELATION-FIELDS (kalknumtt.KALKNR,kalknumsubtt.KALKNR,kalknumtt.OMRADE,kalknumsubtt.OMRADE,kalknumtt.NUM,kalknumsubtt.NUM).

DEFINE VARIABLE LocalAppServerHandle  AS HANDLE NO-UNDO.
/*
RUN XKNUM.P.
*/
RUN Andra_UI (INPUT 101126, input "0910").


/*ändra kalkyl*/

PROCEDURE Andra_UI :
   DEFINE INPUT  PARAMETER kalknr AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER omrvar AS CHARACTER NO-UNDO.
   RUN ConKalkyldb_UI.
   RUN LaddaKalkyl IN LocalAppServerHandle (INPUT kalknr,INPUT omrvar,OUTPUT DATASET KalkylDS).
   RUN KalkTracking(TRUE).
   FOR LAST kalknumtt  WHERE NO-LOCK BY NUM:
      IF kalknumtt.ARBKOD = "egen" then.
      ELSE DO:
         DISPLAY kalknumtt.ARBKOD kalknumtt.LOPNR kalknumtt.ANTAL kalknumtt.num.
         FOR EACH kalknumsubtt WHERE kalknumsubtt.NUM = kalknumtt.num NO-LOCK:
            DELETE kalknumsubtt.
         END.
         DELETE kalknumtt.
      END.
   END.   
   RUN KalkSpara.
   RUN DisConKalkyldb_UI. 
END PROCEDURE.   
PROCEDURE KalkTracking :
   DEFINE INPUT PARAMETER onoff AS LOGICAL NO-UNDO.
   TEMP-TABLE kalknumtt:TRACKING-CHANGES = onoff.
   TEMP-TABLE kalknumsubtt:TRACKING-CHANGES = onoff.
      
END PROCEDURE.

PROCEDURE KalkSpara :

   DEFINE VARIABLE hDSChanges AS HANDLE NO-UNDO.
   RUN KalkTracking(false).
   CREATE DATASET hDSChanges.
   hDSChanges:CREATE-LIKE (DATASET KalkylDS:HANDLE).
   hDSChanges:GET-CHANGES (DATASET KalkylDS:HANDLE).
   RUN SparaProDataSetKalkylDS IN LocalAppServerHandle(INPUT DATASET-HANDLE hDSChanges).
   hDSChanges:MERGE-CHANGES(DATASET KalkylDS:HANDLE).
   RUN KalkTracking(TRUE).
   

END PROCEDURE.
/*con av db då ej oo*/
PROCEDURE ConKalkyldb_UI:
   RUN ProgressKALKBERAPPDS.p PERSISTENT SET LocalAppServerHandle .
   
END PROCEDURE.
/* discon av db då ej oo*/
PROCEDURE DisConKalkyldb_UI :
    IF VALID-HANDLE(LocalAppServerHandle) THEN DELETE PROCEDURE LocalAppServerHandle.
END PROCEDURE.  
*/

