/*GFYTTRANDE.P*/
DEFINE VARIABLE markag AS INTEGER NO-UNDO.
DEFINE VARIABLE extrarader AS INTEGER NO-UNDO.
DEFINE VARIABLE extrarader2 AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE extram AS INTEGER NO-UNDO.
DEFINE VARIABLE emg AS INTEGER NO-UNDO.
DEFINE VARIABLE uColumn  AS INTEGER INITIAL 0.
DEFINE VARIABLE fnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn1 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn2 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamntom AS CHARACTER NO-UNDO.
DEFINE VARIABLE link AS CHARACTER NO-UNDO.
DEFINE VARIABLE bytcol AS LOGICAL NO-UNDO.
DEFINE VARIABLE bytacol AS CHARACTER NO-UNDO.
DEFINE VARIABLE bytbcol AS CHARACTER NO-UNDO.
DEFINE VARIABLE bytccol AS CHARACTER NO-UNDO.
DEFINE VARIABLE bytgcol AS CHARACTER NO-UNDO.
DEFINE VARIABLE bythcol AS CHARACTER NO-UNDO.

DEFINE VARIABLE valvardnr AS INTEGER NO-UNDO.
DEFINE VARIABLE omravd AS INTEGER NO-UNDO.
DEFINE VARIABLE aovar AS CHARACTER NO-UNDO.
DEFINE VARIABLE delnrvar AS INTEGER NO-UNDO.
DEFINE VARIABLE ortvar AS CHARACTER NO-UNDO.   
DEFINE VARIABLE fkommun AS CHARACTER NO-UNDO.   
DEFINE VARIABLE fvaker AS CHARACTER NO-UNDO.   
DEFINE VARIABLE vman AS CHARACTER NO-UNDO.   
DEFINE VARIABLE vadress AS CHARACTER NO-UNDO.
DEFINE VARIABLE vboxnr AS CHARACTER NO-UNDO.
DEFINE VARIABLE vpadress AS CHARACTER NO-UNDO.
DEFINE VARIABLE vtelef AS CHARACTER NO-UNDO.
DEFINE VARIABLE felmedd AS CHARACTER NO-UNDO.
DEFINE VARIABLE omromr AS CHARACTER NO-UNDO.
DEFINE VARIABLE hjproc AS DECIMAL NO-UNDO.
DEFINE VARIABLE hjagare AS INTEGER NO-UNDO.
DEFINE VARIABLE projl AS CHARACTER NO-UNDO.
DEFINE VARIABLE arrendator AS CHARACTER NO-UNDO.
DEFINE VARIABLE allnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE allpersnr AS CHARACTER NO-UNDO.
DEFINE VARIABLE lujona AS CHARACTER NO-UNDO.
DEFINE VARIABLE minimi AS INTEGER NO-UNDO.
DEFINE VARIABLE skprotapph AS HANDLE NO-UNDO.
DEFINE VARIABLE lelitt AS CHARACTER NO-UNDO.
DEFINE VARIABLE pnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE pled AS CHARACTER NO-UNDO.
DEFINE VARIABLE konc AS CHARACTER NO-UNDO.
DEFINE VARIABLE diarienr AS CHARACTER NO-UNDO.
DEFINE VARIABLE hjbete AS CHARACTER NO-UNDO.
/*DEFINE VARIABLE domsaga AS CHARACTER NO-UNDO.*/

DEFINE VARIABLE nstn AS CHARACTER NO-UNDO.


DEFINE VARIABLE antfast AS INTEGER NO-UNDO.
DEFINE VARIABLE fbet AS CHARACTER NO-UNDO.
DEFINE VARIABLE flerfastsum AS INTEGER NO-UNDO.
DEFINE VARIABLE lled AS INTEGER NO-UNDO.
DEFINE VARIABLE jkab AS INTEGER NO-UNDO.
DEFINE VARIABLE nats AS INTEGER NO-UNDO.
DEFINE VARIABLE jklsp AS INTEGER NO-UNDO.
DEFINE VARIABLE kskap AS INTEGER NO-UNDO.
DEFINE VARIABLE ovg AS INTEGER NO-UNDO.
DEFINE VARIABLE tlgg AS INTEGER NO-UNDO.
DEFINE VARIABLE mmini AS INTEGER NO-UNDO.
DEFINE VARIABLE ttalt AS INTEGER NO-UNDO.
DEFINE VARIABLE mg AS CHARACTER NO-UNDO.
DEFINE VARIABLE fabet AS CHARACTER NO-UNDO.
DEFINE VARIABLE telearb AS CHARACTER NO-UNDO.
DEFINE VARIABLE telebost AS CHARACTER NO-UNDO.
DEFINE VARIABLE mobil AS CHARACTER NO-UNDO.
DEFINE VARIABLE epost AS CHARACTER NO-UNDO.
DEFINE VARIABLE tkost AS DECIMAL NO-UNDO.

DEFINE VARIABLE ipfakt AS INTEGER NO-UNDO.
DEFINE VARIABLE ivfaktaker AS INTEGER NO-UNDO.
DEFINE VARIABLE bbelopp AS INTEGER NO-UNDO.
DEFINE VARIABLE pomr AS CHARACTER NO-UNDO.
DEFINE VARIABLE pfakt AS INTEGER NO-UNDO.
DEFINE VARIABLE vskog AS CHARACTER NO-UNDO.
DEFINE VARIABLE oktforekpi  AS DECIMAL NO-UNDO.
DEFINE VARIABLE kpi1995 AS DECIMAL NO-UNDO.
DEFINE VARIABLE kabersatt AS DECIMAL NO-UNDO.
DEFINE VARIABLE datvar AS CHARACTER NO-UNDO.
DEFINE VARIABLE antflik AS INTEGER NO-UNDO.
DEFINE VARIABLE hjantflik AS INTEGER NO-UNDO.
DEFINE VARIABLE bgfarg AS INTEGER NO-UNDO.
DEFINE VARIABLE bgfarg2 AS INTEGER NO-UNDO.
DEFINE VARIABLE sidvar AS INTEGER NO-UNDO.
DEFINE VARIABLE bilnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE utanord AS DATE NO-UNDO.
DEFINE VARIABLE unamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE attest AS CHARACTER NO-UNDO.
DEFINE VARIABLE pn  AS CHARACTER NO-UNDO.
DEFINE VARIABLE sumfast AS INTEGER NO-UNDO.
DEFINE VARIABLE sumfasttot AS INTEGER NO-UNDO.
DEFINE VARIABLE berman AS CHARACTER NO-UNDO.
DEFINE VARIABLE bertel AS CHARACTER NO-UNDO.
DEFINE VARIABLE berepost AS CHARACTER NO-UNDO.
DEFINE VARIABLE berforetag AS CHARACTER NO-UNDO.
DEFINE VARIABLE bermane AS CHARACTER NO-UNDO.
DEFINE VARIABLE bertele AS CHARACTER NO-UNDO.
DEFINE VARIABLE bereposte AS CHARACTER NO-UNDO.

DEFINE VARIABLE vardman AS CHARACTER NO-UNDO.
DEFINE VARIABLE vardtel AS CHARACTER NO-UNDO.
DEFINE VARIABLE vort AS CHARACTER NO-UNDO.

DEFINE VARIABLE vpostnr AS CHARACTER NO-UNDO.
DEFINE VARIABLE vpostadress AS CHARACTER NO-UNDO.
DEFINE VARIABLE vtelefonvxl AS CHARACTER NO-UNDO.
DEFINE VARIABLE varstil AS CHARACTER NO-UNDO.
DEFINE VARIABLE varstorlek AS DECIMAL NO-UNDO.
DEFINE VARIABLE varfet AS LOGICAL NO-UNDO.
DEFINE VARIABLE vardanv AS CHARACTER NO-UNDO.
DEFINE VARIABLE beranv AS CHARACTER NO-UNDO.
DEFINE VARIABLE anvtext AS CHARACTER NO-UNDO.
DEFINE VARIABLE plats AS CHARACTER NO-UNDO.
DEFINE VARIABLE tidpunkt AS CHARACTER NO-UNDO.
DEFINE VARIABLE artal AS CHARACTER NO-UNDO.
DEFINE VARIABLE azon1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE azon2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE afastb AS INTEGER NO-UNDO.
DEFINE VARIABLE vardartal AS INTEGER NO-UNDO.
DEF VARIABLE hjfastnamn AS CHARACTER.

{MARAG.I}        
{TIDUTTT.I}
{MAGA.I}
{allavardtemp.I}   
DEFINE TEMP-TABLE fastaga         
   FIELD MARKNR AS INTEGER
   FIELD MARKAGARE AS CHARACTER
   FIELD PERSONNUMMER AS CHARACTER     
   INDEX MARKNR IS PRIMARY MARKNR ASCENDING.  
{SUMTEMP.I}     

DEFINE TEMP-TABLE uppfoltemp   
   FIELD FORETAG AS CHARACTER
   FIELD ANVANDARE AS CHARACTER  
   FIELD ALLAMA AS LOGICAL
   FIELD VALVARD AS CHARACTER
   FIELD FORSTA AS LOGICAL
   FIELD STAMP AS LOGICAL.  
{FASTFORTEMP.I}   
   
   
DEFINE VARIABLE kommando AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando2 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando3 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommando4 AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommandohela AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommandoarbets AS CHARACTER FORMAT "X(20)" NO-UNDO.
DEFINE VARIABLE kommandotom AS CHARACTER FORMAT "X(20)" NO-UNDO.

DEFINE VARIABLE chWord AS COM-HANDLE     NO-UNDO.
DEFINE VARIABLE chDocguru        AS COM-HANDLE NO-UNDO.

DEFINE VARIABLE chDoc  AS COM-HANDLE     NO-UNDO. 
DEFINE VARIABLE chWord2 AS COM-HANDLE     NO-UNDO.
DEFINE VARIABLE chDoc2  AS COM-HANDLE     NO-UNDO.
DEFINE VARIABLE SELECTION AS COM-HANDLE NO-UNDO.
DEFINE VARIABLE bokvalue AS CHARACTER NO-UNDO.
DEFINE VARIABLE bokname AS CHARACTER NO-UNDO.
DEFINE VARIABLE antagare AS INTEGER NO-UNDO.

DEFINE INPUT PARAMETER ponr AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER avtal AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER spmall AS LOGICAL NO-UNDO.
DEFINE INPUT PARAMETER fildir AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER skrivutmall AS LOGICAL NO-UNDO.

{GLOBVAR2DEL1.I}
&Scoped-define SHARED SHARED  
{MARKVAL.I}                         
DEFINE BUFFER markvalbuff FOR markval.
DEFINE BUFFER fastfbuff FOR fastfortemp.

&SCOPED-DEFINE NEW NEW
&SCOPED-DEFINE SHARED SHARED
{BLOB.I}
DEFINE VARIABLE bloblog AS LOGICAL NO-UNDO.
DEFINE VARIABLE blobproch AS HANDLE NO-UNDO.

DEFINE VARIABLE cDocPath AS CHARACTER NO-UNDO.
DEFINE VARIABLE cDocName AS CHARACTER NO-UNDO.
DEFINE VARIABLE wdGoToBookmark AS INTEGER NO-UNDO INITIAL -1.
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.
{EXTRADATA.I}

{FASTEXTRA.I}        
DEFINE TEMP-TABLE blandnamntemp NO-UNDO
   FIELD NAMN AS CHARACTER.    
IF Guru.Konstanter:appcon THEN DO:
   RUN EXTRADATAHMT.P PERSISTENT SET edataapph ON Guru.Konstanter:apphand TRANSACTION DISTINCT. 
END.
ELSE DO:
  RUN EXTRADATAHMT.P PERSISTENT SET edataapph.  
END.

IF Guru.Konstanter:appcon THEN DO:
   RUN SKAPPROTOU7.P PERSISTENT SET skprotapph ON Guru.Konstanter:apphand TRANSACTION DISTINCT. 
END.
ELSE DO:
   RUN SKAPPROTOU7.P PERSISTENT SET skprotapph.
END.
EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
CREATE inextradatatemp.          
ASSIGN
inextradatatemp.PROGRAM = "NATPROJ"                   
inextradatatemp.HUVUDCH = ponr.                    
RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
FIND FIRST extradatatemp NO-LOCK NO-ERROR.
IF AVAILABLE extradatatemp THEN DO:      
       
   ASSIGN       
   lelitt = extradatatemp.SOKCHAR[1] 
   pnamn = extradatatemp.SOKCHAR[2] 
   pled = extradatatemp.SOKCHAR[3] 
   konc = extradatatemp.SOKCHAR[4] 
   diarienr = extradatatemp.SOKCHAR[5]
   utanord = extradatatemp.SOKDATE[1] 
   unamn = extradatatemp.SOKCHAR[6] 
   attest = extradatatemp.SOKCHAR[7]
   pn = extradatatemp.SOKCHAR[8]       
   pnamn = extradatatemp.SOKCHAR[2].       
END.
EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
CREATE inextradatatemp.          
ASSIGN
inextradatatemp.PROGRAM = "NATPROJ2"                   
inextradatatemp.HUVUDCH = ponr.                    
RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
FIND FIRST extradatatemp NO-LOCK NO-ERROR.
IF AVAILABLE extradatatemp THEN DO:      
   ASSIGN                
   plats = extradatatemp.SOKCHAR[1] 
   tidpunkt = extradatatemp.SOKCHAR[2]
   artal = extradatatemp.SOKCHAR[3].                       
END.


EMPTY TEMP-TABLE marag NO-ERROR. 

IF Guru.Konstanter:globforetag = "umea"  THEN DO:  
   FIND FIRST markval NO-LOCK NO-ERROR.  
   IF AVAILABLE markval THEN DO:
      IF Guru.Konstanter:appcon THEN DO:                           
         RUN EXKABLUAPP3.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT 
         (INPUT markval.VARDNR,INPUT markval.BETECKNING,INPUT TABLE markval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
         ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl, OUTPUT arrendator,OUTPUT TABLE marag ).
      END.
      ELSE DO:
         RUN EXKABLUAPP3.P 
         (INPUT markval.VARDNR,INPUT markval.BETECKNING,INPUT TABLE markval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
         ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl , OUTPUT arrendator,OUTPUT TABLE marag ).
      END.   
   END.
END.
ELSE DO:
   FIND FIRST markval NO-LOCK NO-ERROR.  
   IF Guru.Konstanter:appcon THEN DO:                           
      RUN EXVPFAKT.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT 
      (INPUT markval.VARDNR,INPUT markval.BETECKNING,INPUT TABLE markval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
      ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl, OUTPUT arrendator,
       OUTPUT ipfakt,OUTPUT ivfaktaker,OUTPUT pomr,OUTPUT bbelopp,OUTPUT pfakt,OUTPUT vskog,OUTPUT oktforekpi,OUTPUT kpi1995, OUTPUT kabersatt,OUTPUT TABLE marag ).
   END.
   ELSE DO:
      RUN EXVPFAKT.P 
      (INPUT markval.VARDNR,INPUT markval.BETECKNING,INPUT TABLE markval,OUTPUT omravd,OUTPUT omromr,OUTPUT aovar,OUTPUT delnrvar,OUTPUT ortvar,OUTPUT fkommun,OUTPUT fvaker
      ,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress, OUTPUT vtelef , OUTPUT projl , OUTPUT arrendator,
       OUTPUT ipfakt,OUTPUT ivfaktaker,OUTPUT pomr,OUTPUT bbelopp,OUTPUT pfakt,OUTPUT vskog,OUTPUT oktforekpi,OUTPUT kpi1995, OUTPUT kabersatt,OUTPUT TABLE marag ).
   END.   
END.

EMPTY TEMP-TABLE marag2 NO-ERROR. 
FOR EACH marag:
   CREATE marag2.
   BUFFER-COPY marag TO marag2.
END.

RUN mval_UI.
FIND FIRST mval NO-LOCK NO-ERROR.
EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
CREATE inextradatatemp.          
ASSIGN
inextradatatemp.PROGRAM = "VARDNRARTAL"                   
inextradatatemp.HUVUDINT = mval.VARDNR.                    
RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
FIND FIRST extradatatemp NO-LOCK NO-ERROR.
IF AVAILABLE extradatatemp THEN DO:      
   ASSIGN
   vardartal = extradatatemp.SOKINT[1].      
END.
ELSE vardartal = YEAR(TODAY).   
EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
EMPTY TEMP-TABLE extradatatemp NO-ERROR.



IF avtal = "7" THEN DO:  
   IF Guru.Konstanter:globforetag = "UMEA" THEN  fnamn = "Bygglovumea.Doc".
   ELSE fnamn = "BygglovumeaOP.Doc".
END.

IF avtal = "10"   THEN DO:  
   /*Umeå 10 Rev-avtal Umeå*/
   fnamn = "REV-avtum.Doc".
   /* är inte fixat med att spara flera av dessa revavtal än Lena 20221101*/
   fnamn1 = "REV-avtum".
   fnamn2 = ".doc".   
END.
IF  avtal = "25"  THEN DO:  
   /*Umeå 25 Rev-avtal Umenet*/      
   fnamn = "REVUMopto.Doc".
   fnamn1 = "REVUMopto".
   fnamn2 = ".doc".   
END.
IF  avtal = "24"   THEN DO:  
   /*Umeå 24 Rev-avtal UE   */   
   IF Guru.Konstanter:globforetag = "umbr" THEN DO:
      fnamn = "REVUMoptoUE.Doc".
      fnamn1 = "REVUMoptoUE".
      fnamn2 = ".doc".
   END.      
END.

IF avtal = "19" THEN DO:  
   /*Sundsvall Elnät rev-avtal*/
   fnamn = "REV-avtSNAT.Doc".
   fnamn1 = "REV-avtSNAT".
   fnamn2 = ".doc".
END.

IF avtal = "14" THEN DO:  
   /*svensk energi rev-avtal*/
   fnamn = "REV VATT 2022.Docx".
   fnamn1 = "REV VATT 2022".
   fnamn2 = ".Docx".

END.
IF avtal = "20" THEN DO:  
   /*svensk energi rev-avtal*/
   fnamn = "REV VATT 2021.Docx".
   fnamn1 = "REV VATT 2021".
   fnamn2 = ".Docx".
END.
IF avtal = "21" THEN DO:  
   /*svensk energi rev-avtal  Luleå anpassning ingen vattenfall logga*/
   fnamn = "REV avtal Luleå.doc".
   fnamn1 = "REV avtal Luleå".
   fnamn2 = ".doc".
END.
IF avtal = "26" THEN DO:  
   /*svensk energi rev-avtal  EON anpassning ingen vattenfall logga*/
   fnamn = "Rev Eon D17-0000620 Enskild väg.docx".
   fnamn1 = "Rev Eon D17-0000620 Enskild väg".
   fnamn2 = ".docx".
END.

IF avtal = "15" THEN DO:  
   /*svensk energi rev-avtal  JBF*/
   fnamn = "REV2014JBF.Doc".
   fnamn1 = "REV2014JBF".
   fnamn2 = ".doc".
END.


IF avtal = "50" THEN DO:  
   /*tect markägaravtal*/
   fnamn = "TMarkag.DOC".
END.
/*IF avtal = "51" THEN DO:  
   /*UTANORDNING*/
   fnamn = "UTANORDNINGV.doc".
   fnamn1 = "UTANORDNINGV".
   fnamn2 = ".doc".
   fnamntom = "tomUTANORDNINGV.doc".
END.*/

/*IF avtal = "52" THEN DO:  
   /*AB*/
   fnamn = "AB2.doc".
   fnamn1 = "AB2".
   fnamn2 = ".doc".
END.*/
/*IF avtal = "53" THEN DO:  
   /*AB*/
   fnamn = "BrevNatag.doc".
   fnamn1 = "BrevNatag".
   fnamn2 = ".doc".
END.*/
IF avtal = "54" THEN DO:  
   /*Informationsbrev 1 förstärkning*/
   fnamn = "Infofor1.docx".
   fnamn1 = "Infofor1".
   fnamn2 = ".docx".
END.
IF avtal = "55" THEN DO:  
   /*Informationsbrev 2 förstärkning*/
   fnamn = "Infofor2.docx".
   fnamn1 = "Infofor2".
   fnamn2 = ".docx".
END.
IF avtal = "62" THEN DO:  
   /*Informationsbrev 3 förstärkning*/
   fnamn = "Infofor3.docx".
   fnamn1 = "Infofor3".
   fnamn2 = ".docx".
END.
IF avtal = "56" THEN DO:  
   /*Informationsbrev Vilhelmina*/
   fnamn = "InfoforVil.docx".
   fnamn1 = "InfoforVil".
   fnamn2 = ".docx".
END.
IF avtal = "57" THEN DO:  
   /*Informationsbrev Vilhelmina*/
   fnamn = "InfoforByv.docx".
   fnamn1 = "InfoforByv".
   fnamn2 = ".docx".
END.
IF avtal = "58" THEN DO:  
   /*Informationsbrev stakningstillstånd*/
   fnamn = "Stakningstillstånd.doc".
   fnamn1 = "Stakningstillstånd".
   fnamn2 = ".doc".
END.
IF avtal = "60" THEN DO:  
   /*Informationsbrev 1*/
   fnamn = "Infobrev1.docx".
   fnamn1 = "Infobrev1".
   fnamn2 = ".docx".
END.
IF avtal = "61" THEN DO:  
   /*Informationsbrev 1*/
   fnamn = "Infobrev2.docx".
   fnamn1 = "Infobrev2".
   fnamn2 = ".docx".
END.


IF Guru.Konstanter:appcon THEN RUN FINNSTABELL.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT (INPUT "BLOBINFO", OUTPUT bloblog).
ELSE RUN FINNSTABELL.P (INPUT "BLOBINFO", OUTPUT bloblog).
IF bloblog = TRUE THEN DO:
  {FINNSDYNBLOB.I}
   DEFINE VARIABLE resid AS INTEGER NO-UNDO.
   RUN blobfil_UI IN blobproch (INPUT fnamn, OUTPUT resid).
   IF resid = ? THEN DO:
      kommando = SEARCH(fnamn).      
   END.
   ELSE DO:
      FIND FIRST blobinfotemp WHERE blobinfotemp.ID = resid NO-LOCK NO-ERROR.
      RUN blobopen_UI IN blobproch (INPUT blobinfotemp.FILNAMN, OUTPUT kommando).
   END.
   RUN deleteproc_UI IN blobproch.
   IF VALID-HANDLE(blobproch) THEN DELETE PROCEDURE blobproch NO-ERROR.
END.
ELSE kommando = SEARCH(fnamn).   
IF kommando = ? THEN DO:
   MESSAGE "Hittade inte " fnamn VIEW-AS ALERT-BOX.
   RETURN.       
END.  

kommando2 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
kommando3 = SESSION:TEMP-DIRECTORY + Guru.Konstanter:globanv + "\".
kommando4 = kommando.
{SESSIONTEMPDIR.I}
IF SESSION:CLIENT-TYPE = "WEBCLIENT" THEN DO:
    kommando2 = webclienttempdir.
    kommando3 = webclienttempdir.
 END.   

OS-CREATE-DIR VALUE(kommando2) NO-ERROR.
DEBUGGER:SET-BREAK().
IF spmall = TRUE AND fildir NE "" THEN DO:
      kommando2 = fildir  + "\".
      kommando3 = fildir  + "\".  
END.

FIND FIRST marag2 USE-INDEX beteckning NO-LOCK NO-ERROR.
hjfastnamn = marag2.BETECKNING.
hjfastnamn = REPLACE(hjfastnamn,":"," ").
hjfastnamn = REPLACE(hjfastnamn,"/"," ").
hjfastnamn = REPLACE(hjfastnamn,"-"," ").
hjfastnamn = REPLACE(hjfastnamn,">"," ").
hjfastnamn = REPLACE(hjfastnamn,"<"," "). 
IF fnamn1 NE "" AND fnamn2 NE "" THEN DO:             
   IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
      kommando2 = kommando3 + fnamn1 + hjfastnamn + fnamn2.
   END.
   ELSE DO:
      kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + hjfastnamn + fnamn2.
   END.
END.
ELSE DO:      
   IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
      kommando2 = kommando2 + fnamn.
   END.
   ELSE DO:
      kommando2 = kommando2 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn.
   END.
END.
OS-COPY VALUE(kommando) VALUE(kommando2).
kommando = kommando2.

   
   

CREATE "Word.Application" chWord NO-ERROR.

IF ERROR-STATUS:ERROR = FALSE THEN DO:
   DEBUGGER:SET-BREAK().
   chWord:Options:AllowReadingMode = FALSE NO-ERROR. /*Fix för excel 2013*/
   chDoc = chWord:Documents:Open(kommando,,,,,,,,,).   
   chDoc:Protect(2) NO-ERROR.
   chWord:VISIBLE = TRUE.
   IF spmall = TRUE THEN chWord:Visible = FALSE.
   ELSE IF  skrivutmall = TRUE THEN chWord:Visible = FALSE.
   chDoc = chWord:ActiveDocument.

   EMPTY TEMP-TABLE tidut NO-ERROR. 
   ASSIGN
   hjproc = 0
   hjagare = 0.
   FIND FIRST mval NO-LOCK NO-ERROR.  
   IF AVAILABLE mval THEN DO:
      ASSIGN mval.AONR = aovar
      mval.DELNR = delnrvar.   
   END.
   
   
   
   IF avtal = "7"  THEN DO:    /*bygglov umeå*/
      
      RUN inbokvaluetnr12_UI (INPUT "datum" ,INPUT STRING(TODAY,"9999-99-99")).   
      RUN inbokvaluetnr12_UI (INPUT "adress" ,INPUT  "Storgatan 34  Box 224    901 05 Umeå" ).                  
         
      IF Guru.Konstanter:globforetag = "umea"  THEN DO:
          RUN inbokvaluetnr12_UI (INPUT "pnr1" ,INPUT "556086-8225").
          RUN inbokvaluetnr12_UI (INPUT "Fägare1" ,INPUT "Umeå Energi Elnät AB").
       END.   
      IF Guru.Konstanter:globforetag = "UMBR"  THEN DO:
          RUN inbokvaluetnr12_UI (INPUT "pnr1" ,INPUT "556619-3057").
          RUN inbokvaluetnr12_UI (INPUT "Fägare1" ,INPUT "Umeå Energi Umenet AB").
      END.    
      FIND FIRST marag2 USE-INDEX BETECKNING NO-LOCK NO-ERROR .
      IF AVAILABLE marag2 THEN DO:
         RUN tuppg2_UI IN skprotapph (INPUT marag2.MARKNR,OUTPUT telearb,OUTPUT telebost,OUTPUT mobil,OUTPUT epost).
         /*ägare 1*/              
         FIND FIRST marag2 USE-INDEX BETECKNING NO-LOCK NO-ERROR .
         IF AVAILABLE marag2 THEN DO:
            RUN inbokvaluetnr12_UI (INPUT "Fastighet" ,INPUT marag2.BETECKNING).                     
         END.
      
      END.      
   END.
  
   IF avtal = "14" OR avtal = "15"  OR avtal = "20" OR avtal = "21" OR avtal = "26" THEN DO:    /*rev-Vatt även JBF*/
      hjbete = "".
      FOR EACH marag2 USE-INDEX BETECKNING NO-LOCK:
         IF marag2.BETECKNING = hjbete THEN.
         ELSE antflik = antflik + 1.
         hjbete = marag2.BETECKNING.
      END.
      sidvar = 1.
      hjbete = "".
      FOR EACH marag2  USE-INDEX BETKON NO-LOCK.
      /*bara en markägare vid revavtal . Ta kontaktperson  eller den som kommer först , borde bara vara en*/
         IF hjbete = marag2.BETECKNING THEN.
         ELSE DO:            
            IF antflik > 1 AND sidvar > 1 THEN DO:
               hjfastnamn = marag2.BETECKNING.
               hjfastnamn = REPLACE(hjfastnamn,":"," ").
               hjfastnamn = REPLACE(hjfastnamn,"/"," ").
               hjfastnamn = REPLACE(hjfastnamn,"-"," ").
               hjfastnamn = REPLACE(hjfastnamn,">"," ").
               hjfastnamn = REPLACE(hjfastnamn,"<"," "). 
               /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
               hjfastnamn = REPLACE(hjfastnamn,"\"," ").
               hjfastnamn = REPLACE(hjfastnamn,"*"," ").
               hjfastnamn = REPLACE(hjfastnamn,"|"," ").
               hjfastnamn = REPLACE(hjfastnamn,'"'," ").
               hjfastnamn = REPLACE(hjfastnamn,";"," ").      
               hjfastnamn = REPLACE(hjfastnamn,","," ").
               hjfastnamn = REPLACE(hjfastnamn,"'"," ").
               hjfastnamn = REPLACE(hjfastnamn,"+"," ").
               hjfastnamn = REPLACE(hjfastnamn,"."," ").
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando3 + fnamn1 + hjfastnamn + fnamn2.
               END.
               ELSE DO:
                  kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + hjfastnamn + fnamn2.
               END.
               DEBUGGER:SET-BREAK().
                                       
               OS-COPY VALUE(kommando4) VALUE(kommando2).
               kommando = kommando2.
               CREATE "Word.Application" chWord NO-ERROR.
               IF ERROR-STATUS:ERROR = FALSE THEN DO:
                  chDoc = chWord:Documents:Open(kommando,,,,,,,,,).
                  chDoc:Protect(2) NO-ERROR.                  
                  chWord:VISIBLE = TRUE.
                  IF spmall = TRUE THEN chWord:Visible = FALSE.
                  ELSE IF  skrivutmall = TRUE THEN chWord:Visible = FALSE.
                  chDoc = chWord:ActiveDocument.
               END.                                    
            END.
            IF ERROR-STATUS:ERROR = FALSE THEN DO:
   
               {AMERICANEUROPEAN.I}
               SESSION:NUMERIC-FORMAT = "EUROPEAN".
               tkost = 0.
               RUN inbokvaluetnr12_UI (INPUT "Text6",INPUT marag2.MARKAGARE).
               /*FIND FIRST marag2 USE-INDEX BETECKNING NO-LOCK NO-ERROR .
               IF AVAILABLE marag2 THEN DO:                  
                  RUN inbokvaluetnr12_UI (INPUT "Text6",INPUT marag2.MARKAGARE).           
               END.*/
               IF fkommun NE "" THEN RUN inbokvaluetnr12_UI (INPUT "Text4" ,INPUT fkommun).
               /*FIND FIRST marag2 USE-INDEX BETECKNING NO-LOCK NO-ERROR .*/      
               EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
               EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
               CREATE inextradatatemp.          
               ASSIGN
               inextradatatemp.PROGRAM = "REVAVTAL"                   
               inextradatatemp.HUVUDINT = marag2.VARDNR                    
               inextradatatemp.HUVUDCH = marag2.BETECKNING.                          
               RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
               FOR EACH extradatatemp :         
                  IF extradatatemp.SOKINT[1] = 1  THEN DO:                          
                     RUN inbokvaluetnr12_UI (INPUT "Text10" ,INPUT extradatatemp.SOKDEC[2]).      
                     RUN inbokvaluetnr12_UI (INPUT "Text12" ,INPUT extradatatemp.SOKDEC[3]).                              
                  END.
                  IF extradatatemp.SOKINT[1] = 2  THEN DO:                                                  
                     RUN inbokvaluetnr12_UI (INPUT "Text11" ,INPUT extradatatemp.SOKDEC[2]).      
                     RUN inbokvaluetnr12_UI (INPUT "Text13" ,INPUT extradatatemp.SOKDEC[3]).                  
                  END.         
                  tkost = tkost + extradatatemp.SOKDEC[3].
               END.
               RUN revadmhmt_UI IN skprotapph (INPUT vardartal, OUTPUT azon1, OUTPUT azon2, OUTPUT afastb).
               
               RUN inbokvaluetnr12_UI (INPUT "fastbelopp" ,INPUT afastb).    
               RUN inbokvaluetnr12_UI (INPUT "zon1" ,INPUT azon1).
               RUN inbokvaluetnr12_UI (INPUT "zon2" ,INPUT azon2).                                      
               tkost = tkost + afastb.
                      
               RUN inbokvaluetnr12_UI (INPUT "Text14" ,INPUT tkost).
              
               /* test med att lägga in kontaktperson. Men vägföreningens kontaktperson är väl inte det som ligger registrerat som fastighetens kontaktperson??*/
               RUN tuppgREV_UI IN skprotapph (INPUT marag2.BETECKNING,OUTPUT vman,OUTPUT vadress,OUTPUT vpadress,OUTPUT vtelef,OUTPUT telebost,OUTPUT mobil,OUTPUT epost).
               RUN inbokvalue_UI (INPUT "Text15" ,INPUT vman).  
               RUN inbokvalue_UI (INPUT "Text16" ,INPUT vadress).  
               RUN inbokvalue_UI (INPUT "Text17" ,INPUT vpadress). 
               IF vtelef NE "" THEN RUN inbokvalue_UI (INPUT "Text18" ,INPUT vtelef).
               ELSE IF telebost NE "" THEN RUN inbokvalue_UI (INPUT "Text18" ,INPUT telebost).
               ELSE IF mobil NE "" THEN RUN inbokvalue_UI (INPUT "Text18" ,INPUT mobil).           
               RUN inbokvalue_UI (INPUT "Text19" ,INPUT epost).
            END.
         END.
         hjbete = marag2.BETECKNING.
         sidvar = sidvar + 1.         
         
         IF spmall = TRUE OR skrivutmall = true THEN DO:
            chWord:displayalerts = FALSE.      
            chDoc:SaveAs(kommando,,,,,,,,,).        
            chWord:displayalerts = TRUE.
            IF skrivutmall = TRUE THEN DO:                                 
               chWord:ScreenUpdating = FALSE.
               chDoc:PrintOut(,,,,STRING(SESSION:PRINTER-NAME),,,).                           
            END.              
            NO-RETURN-VALUE chDoc:CLOSE().
            NO-RETURN-VALUE chWord:QUIT().
         END.  
         RELEASE OBJECT chDoc NO-ERROR.
      END.         
                                       
   END.
      
   IF avtal = "10" OR avtal = "19" or avtal = "24" or  avtal = "25"   THEN DO:    /*rev-avtaln*/
   
      hjbete = "".
      FOR EACH marag2 USE-INDEX BETECKNING NO-LOCK:
         IF marag2.BETECKNING = hjbete THEN.
         ELSE antflik = antflik + 1.
         hjbete = marag2.BETECKNING.
      END.
      sidvar = 1.
      hjbete = "".
      FOR EACH marag2  USE-INDEX BETKON NO-LOCK.
      /*bara en markägare vid revavtal . Ta kontaktperson  eller den som kommer först , borde bara vara en*/
         IF hjbete = marag2.BETECKNING THEN.
         ELSE DO:            
            IF antflik > 1 AND sidvar > 1 THEN DO:
               hjfastnamn = marag2.BETECKNING.
               hjfastnamn = REPLACE(hjfastnamn,":"," ").
               hjfastnamn = REPLACE(hjfastnamn,"/"," ").
               hjfastnamn = REPLACE(hjfastnamn,"-"," ").
               hjfastnamn = REPLACE(hjfastnamn,">"," ").
               hjfastnamn = REPLACE(hjfastnamn,"<"," "). 
               /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
               hjfastnamn = REPLACE(hjfastnamn,"\"," ").
               hjfastnamn = REPLACE(hjfastnamn,"*"," ").
               hjfastnamn = REPLACE(hjfastnamn,"|"," ").
               hjfastnamn = REPLACE(hjfastnamn,'"'," ").
               hjfastnamn = REPLACE(hjfastnamn,";"," ").      
               hjfastnamn = REPLACE(hjfastnamn,","," ").
               hjfastnamn = REPLACE(hjfastnamn,"'"," ").
               hjfastnamn = REPLACE(hjfastnamn,"+"," ").
               hjfastnamn = REPLACE(hjfastnamn,"."," ").
               
               IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
                  kommando2 = kommando3 + fnamn1 + hjfastnamn + fnamn2.
               END.
               ELSE DO:
                  kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + hjfastnamn + fnamn2.
               END.
               DEBUGGER:SET-BREAK().
                                       
               OS-COPY VALUE(kommando4) VALUE(kommando2).
               kommando = kommando2.
               CREATE "Word.Application" chWord NO-ERROR.
               IF ERROR-STATUS:ERROR = FALSE THEN DO:
                  chDoc = chWord:Documents:Open(kommando,,,,,,,,,).
                  chDoc:Protect(2) NO-ERROR.                  
                  chWord:VISIBLE = TRUE.
                  IF spmall = TRUE THEN chWord:Visible = FALSE.
                  ELSE IF  skrivutmall = TRUE THEN chWord:Visible = FALSE.
                  chDoc = chWord:ActiveDocument.
               END.                                    
            END.
            IF ERROR-STATUS:ERROR = FALSE THEN DO:               
               IF avtal = "10" or avtal = "24" or  avtal = "25" THEN DO: 
                  IF ponr NE ? AND ponr NE ""  THEN DO:                     
                     IF ponr NE "" THEN RUN inbokvalue_UI (INPUT "ponr" ,INPUT ponr).
                     IF lelitt NE "" THEN RUN inbokvalue_UI (INPUT "lelitt" ,INPUT lelitt).                         
                     /*IF nstn NE "" THEN RUN inbokvalue_UI (INPUT "nstn" ,INPUT nstn).*/    
                     IF pnamn NE "" THEN RUN inbokvalue_UI (INPUT "Projektnamn" ,INPUT pnamn).               
                     IF pled NE "" THEN RUN inbokvalue_UI (INPUT "Projektledare" ,INPUT pled).
                     RUN inbokvalue_UI (INPUT "vardnr",INPUT marag2.VARDNR).                                                             
                  END.
               END.   
               IF avtal = "24" THEN DO:
                  RUN inbokvalue_UI (INPUT "foretag" ,INPUT "UMEÅ ENERGI AB").
                  RUN inbokvalue_UI (INPUT "foretagorg" ,INPUT "556097-8602").
                  RUN inbokvalue_UI (INPUT "foretag2" ,INPUT "UMEÅ ENERGI AB").
                  RUN inbokvalue_UI (INPUT "foretagorg2" ,INPUT "556097-8602").
                  RUN inbokvalue_UI (INPUT "diarienr" ,INPUT diarienr).                   
               END.
               IF avtal = "25" THEN DO:                  
                  RUN inbokvalue_UI (INPUT "foretag" ,INPUT "Umeå Energi Umenet AB").
                  RUN inbokvalue_UI (INPUT "foretagorg" ,INPUT "556619-3057").                  
                  RUN inbokvalue_UI (INPUT "foretag2" ,INPUT "Umeå Energi Umenet AB").
                  RUN inbokvalue_UI (INPUT "foretagorg2" ,INPUT "556619-3057").
                  RUN inbokvalue_UI (INPUT "diarienr" ,INPUT diarienr).     
                               
               END.                          
               tkost = 0.             
               RUN inbokvaluetnr12_UI (INPUT "datum",INPUT STRING(TODAY,"9999-99-99")).      
               RUN inbokvaluetnr12_UI (INPUT "väghållarefa",INPUT marag2.BETECKNING).
               RUN inbokvaluetnr12_UI (INPUT "vägföreningfa",INPUT marag2.BETECKNING).
               RUN inbokvaluetnr12_UI (INPUT "vägföreningmä",INPUT marag2.MARKAGARE).
               RUN inbokvaluetnr12_UI (INPUT "väghållare",INPUT marag2.BETECKNING).  
               IF marag2.personnummer NE "000000-0000" THEN RUN inbokvaluetnr12_UI (INPUT "orgnr",INPUT marag2.PERSONNUMMER).
               IF marag2.GATUADRESS NE "" THEN DO:            
                  RUN inbokvaluetnr12_UI (INPUT "KontaktAdress" ,INPUT marag2.GATUADRESS).            
               END.   
               IF marag2.POSTADRESS NE "" THEN DO:                     
                  RUN inbokvaluetnr12_UI (INPUT "KontaktPostadress" ,INPUT (STRING(marag2.POSTNUMMER,"999 99") + " " + marag2.POSTADRESS)).            
               END. 
               IF vtelef NE "" THEN  DO:
                  RUN inbokvaluetnr12_UI (INPUT "KontaktTele" ,INPUT vtelef).
               END.                     
      
               EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
               EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
               CREATE inextradatatemp.          
               ASSIGN
               inextradatatemp.PROGRAM = "REVAVTAL"                   
               inextradatatemp.HUVUDINT = marag2.VARDNR                    
               inextradatatemp.HUVUDCH = marag2.BETECKNING.                          
               RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
               FOR EACH extradatatemp :         
                  IF extradatatemp.SOKINT[1] = 1  THEN DO:            
                     RUN inbokvaluetnr12_UI (INPUT "krmzon1" ,INPUT extradatatemp.SOKDEC[1]).               
                     RUN inbokvaluetnr12_UI (INPUT "krmzon11" ,INPUT extradatatemp.SOKDEC[1]).               
                     RUN inbokvaluetnr12_UI (INPUT "mzon1" ,INPUT extradatatemp.SOKDEC[2]).      
                     RUN inbokvaluetnr12_UI (INPUT "krzon1" ,INPUT extradatatemp.SOKDEC[3]).
                     RUN inbokvaluetnr12_UI (INPUT "fmzon1" ,INPUT extradatatemp.SOKDEC[2]).      
                                                   
                  END.
                  IF extradatatemp.SOKINT[1] = 2  THEN DO:            
                     RUN inbokvaluetnr12_UI (INPUT "krmzon2" ,INPUT extradatatemp.SOKDEC[1]).               
         
                     RUN inbokvaluetnr12_UI (INPUT "krmzon2d1" ,INPUT TRUNCATE(extradatatemp.SOKDEC[1],0)).               
                     RUN inbokvaluetnr12_UI (INPUT "krmzon2d2" ,INPUT ((extradatatemp.SOKDEC[1] - TRUNCATE(extradatatemp.SOKDEC[1],0)) * 100)).               
                     
                     RUN inbokvaluetnr12_UI (INPUT "mzon2" ,INPUT extradatatemp.SOKDEC[2]).      
                     RUN inbokvaluetnr12_UI (INPUT "krzon2" ,INPUT extradatatemp.SOKDEC[3]). 
                     RUN inbokvaluetnr12_UI (INPUT "fmzon2" ,INPUT extradatatemp.SOKDEC[2]).                 
                  END.         
                  tkost = tkost + extradatatemp.SOKDEC[3].
               END.
               RUN revadmhmt_UI IN skprotapph (INPUT vardartal, OUTPUT azon1, OUTPUT azon2, OUTPUT afastb).
               
               RUN inbokvaluetnr12_UI (INPUT "fastbelopp" ,INPUT afastb).
               RUN inbokvaluetnr12_UI (INPUT "fastbelopp1" ,INPUT afastb).    
               RUN inbokvaluetnr12_UI (INPUT "zon1" ,INPUT azon1).
               RUN inbokvaluetnr12_UI (INPUT "zon2" ,INPUT azon2).                                      
               tkost = tkost + afastb.
                      
               RUN inbokvaluetnr12_UI (INPUT "totalt" ,INPUT tkost).
                                       
            END.
         END.
         hjbete = marag2.BETECKNING.
         sidvar = sidvar + 1.         
         
         IF spmall = TRUE OR skrivutmall = true THEN DO:
            chWord:displayalerts = FALSE.      
            chDoc:SaveAs(kommando,,,,,,,,,).        
            chWord:displayalerts = TRUE.
            IF skrivutmall = TRUE THEN DO:                                 
               chWord:ScreenUpdating = FALSE.
               chDoc:PrintOut(,,,,STRING(SESSION:PRINTER-NAME),,,).                           
            END.              
            NO-RETURN-VALUE chDoc:CLOSE().
            NO-RETURN-VALUE chWord:QUIT().
         END.  
         RELEASE OBJECT chDoc NO-ERROR.
      END.      
      
   END.
   IF avtal = "50"  THEN DO:        
      /*RUN inbokvaluetnr10_UI (INPUT "datum" ,INPUT STRING(TODAY,"9999-99-99")).*/         
      FIND FIRST marag2 USE-INDEX BETECKNING NO-LOCK NO-ERROR .
      IF AVAILABLE marag2 THEN DO:      
         /*ägare 1*/                 
         RUN inbokvaluecal12_UI (INPUT "Fastighet" ,INPUT marag2.BETECKNING).         
         RUN inbokvaluecal11_UI (INPUT "Fägare1" ,INPUT marag2.MARKAGARE).    
         FIND FIRST mval WHERE mval.MARKNR =  marag2.MARKNR NO-ERROR.
         IF AVAILABLE mval THEN DO:
            RUN inbokvaluecal11_UI (INPUT "Andel1" ,INPUT mval.ANDEL).
         END.     
      END.
      FIND NEXT marag2 USE-INDEX BETECKNING  NO-LOCK NO-ERROR.
      IF AVAILABLE marag2 THEN DO:
         /*ägare 2*/            
         RUN inbokvaluecal11_UI (INPUT "Fägare2" ,INPUT marag2.MARKAGARE).
         FIND FIRST mval WHERE mval.MARKNR =  marag2.MARKNR NO-ERROR.
         IF AVAILABLE mval THEN DO:
            RUN inbokvaluecal11_UI (INPUT "Andel2" ,INPUT mval.ANDEL).
         END.            
         FIND NEXT marag2 USE-INDEX BETECKNING  NO-LOCK NO-ERROR.
         IF AVAILABLE marag2 THEN DO:
            /*ägare 3*/            
            RUN inbokvaluecal11_UI (INPUT "Fägare3" ,INPUT marag2.MARKAGARE).
            FIND FIRST mval WHERE mval.MARKNR =  marag2.MARKNR NO-ERROR.
            IF AVAILABLE mval THEN DO:
               RUN inbokvaluecal11_UI (INPUT "Andel3" ,INPUT mval.ANDEL).
            END.            
         END.
         FIND NEXT marag2 USE-INDEX BETECKNING  NO-LOCK NO-ERROR.
         IF AVAILABLE marag2 THEN DO:
            /*ägare 4*/            
            RUN inbokvaluecal11_UI (INPUT "Fägare4" ,INPUT marag2.MARKAGARE).
            FIND FIRST mval WHERE mval.MARKNR =  marag2.MARKNR NO-ERROR.
            IF AVAILABLE mval THEN DO:
               RUN inbokvaluecal11_UI (INPUT "Andel4" ,INPUT mval.ANDEL).
            END.    
            FIND NEXT marag2 USE-INDEX BETECKNING  NO-LOCK NO-ERROR.
            IF AVAILABLE marag2 THEN DO:
               /*ägare 5*/            
               RUN inbokvaluecal11_UI (INPUT "Fägare5" ,INPUT marag2.MARKAGARE).
               FIND FIRST mval WHERE mval.MARKNR =  marag2.MARKNR NO-ERROR.
               IF AVAILABLE mval THEN DO:
                  RUN inbokvaluecal11_UI (INPUT "Andel5" ,INPUT mval.ANDEL).
               END.            
            END.        
         END.
      END.
      RUN inbokvaluetnr11_UI (INPUT "kabersatt" ,INPUT STRING(kabersatt,">9.99")).
      RUN inbokvaluecal12_UI (INPUT "Ort" ,INPUT "Nordingrå").
      datvar = string(YEAR(today)) + "-" +  string(MONTH(today),"99") +  "........".
      RUN inbokvaluecal12_UI (INPUT "Datum" ,INPUT datvar).
      RUN inbokvaluecal12_UI (INPUT "Natagare" ,INPUT "Göran Edlund").               
   END.
   
   IF   avtal = "54" OR avtal = "55" OR avtal = "56" OR avtal = "57" OR avtal = "58" OR avtal = "60" OR avtal = "61" OR avtal = "62" THEN DO:
          
      DEBUGGER:SET-BREAK().   
      EMPTY TEMP-TABLE fastfortemp NO-ERROR. 
      FIND FIRST markval NO-LOCK NO-ERROR.  
      IF Guru.Konstanter:appcon THEN DO:                           
         RUN EXFASTFORAPPN2.P ON Guru.Konstanter:apphand TRANSACTION DISTINCT 
         (INPUT TABLE markval,OUTPUT TABLE fastfortemp,OUTPUT ortvar, OUTPUT vman).
      END.
      ELSE DO:
         RUN EXFASTFORAPPN2.P 
         (INPUT TABLE markval,OUTPUT TABLE fastfortemp,OUTPUT ortvar, OUTPUT vman).
      END.   
     

                  
      FOR EACH fastfortemp :
         FIND FIRST fastfbuff WHERE fastfbuff.BETECKNING = fastfortemp.BETECKNING AND fastfbuff.MARKNR NE fastfortemp.MARKNR 
         AND fastfbuff.GATUADRESS = fastfortemp.GATUADRESS  NO-ERROR.
         IF AVAILABLE fastfbuff AND fastfbuff.GATUADRESS NE "" AND fastfbuff.INTE1 = 1  AND fastfbuff.INTE2 = 2  THEN DO:
            ASSIGN
            fastfortemp.MARKAGARE = fastfortemp.MARKAGARE + " " + fastfbuff.MARKAGARE
            fastfortemp.INTE1 = 1 fastfortemp.INTE2 = 1.         
            DELETE fastfbuff.
         END.
      END.
      FOR EACH fastfortemp :
         FIND FIRST fastfbuff WHERE fastfbuff.BETECKNING = fastfortemp.BETECKNING AND fastfbuff.MARKNR = fastfortemp.MARKNR AND fastfbuff.VARDNR NE fastfortemp.VARDNR  NO-ERROR.
         IF AVAILABLE fastfbuff THEN DO:
            /* om samma fastighet förekommer på flera delnr ska fastigheten bara ut 1 gång , men med hela summan*/
            DELETE fastfortemp.
         END.   
      END.
      FOR EACH fastfortemp :
         antflik = antflik + 1.         
      END.
      hjantflik = 2.
      DO:   
         EMPTY TEMP-TABLE fastextra NO-ERROR. 
         FOR EACH fastfortemp NO-LOCK:
            FIND FIRST fastextra WHERE fastextra.BETECKNING = fastfortemp.BETECKNING NO-LOCK NO-ERROR.
            IF NOT AVAILABLE fastextra THEN DO:
               CREATE fastextra.
               ASSIGN
               fastextra.VARDNR = fastfortemp.VARDNR
               fastextra.BETECKNING = fastfortemp.BETECKNING.
            END.
            EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
            EMPTY TEMP-TABLE extradatatemp NO-ERROR.
            CREATE inextradatatemp.          
            ASSIGN
            inextradatatemp.PROGRAM = "VARDFAST"     
            inextradatatemp.HUVUDINT = fastfortemp.VARDNR
            inextradatatemp.HUVUDCH = fastfortemp.BETECKNING.         
            RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
            FIND FIRST extradatatemp NO-LOCK NO-ERROR.
            IF AVAILABLE extradatatemp THEN DO:      
               ASSIGN               
               fastextra.CH1 = extradatatemp.SOKCH[1]
               fastextra.CH2 = extradatatemp.SOKCH[2]
               fastextra.CH3 = extradatatemp.SOKCH[3]
               fastextra.CH4 = extradatatemp.SOKCH[4]
               fastextra.CH5 = extradatatemp.SOKCH[5]
               fastextra.CH6 = extradatatemp.SOKCH[6]
               fastextra.CH7 = extradatatemp.SOKCH[7]
               fastextra.CH8 = extradatatemp.SOKCH[8]
               fastextra.CH9 = extradatatemp.SOKCH[9]
               fastextra.CH10 = extradatatemp.SOKCH[10].         
            END.     
            EMPTY TEMP-TABLE inextradatatemp NO-ERROR.
            EMPTY TEMP-TABLE extradatatemp NO-ERROR.
            CREATE inextradatatemp.          
            ASSIGN
            inextradatatemp.PROGRAM = "VARDFAST2"     
            inextradatatemp.HUVUDINT = fastfortemp.VARDNR
            inextradatatemp.HUVUDCH = fastfortemp.BETECKNING.
            RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
            FIND FIRST extradatatemp NO-LOCK NO-ERROR.
            IF AVAILABLE extradatatemp THEN DO:      
               ASSIGN
               fastextra.CH11 = extradatatemp.SOKCH[1]   
               fastextra.CH14 = extradatatemp.SOKCH[2]                     /*KEWA VÄRDERING KLAR*/
               fastextra.CH15 =  extradatatemp.SOKCH[3]                     /*KEWA ROTPOST*/
               fastextra.CH16 = extradatatemp.SOKCH[4]                    /*KEWA TILL NÄTÄGAREN*/      
               fastextra.LG1 = extradatatemp.SOKLOG[1]        
               fastextra.LG2 = extradatatemp.SOKLOG[2]
               fastextra.LG3 = extradatatemp.SOKLOG[3]
               fastextra.INT1 = extradatatemp.SOKINT[1]        
               fastextra.INT2 = extradatatemp.SOKINT[2]
               fastextra.INT3 = extradatatemp.SOKINT[3].
            END.    
         END.            
      END.
      EMPTY TEMP-TABLE sumtemp NO-ERROR. 
      CREATE uppfoltemp.
      ASSIGN
      uppfoltemp.FORETAG = Guru.Konstanter:globforetag   
      uppfoltemp.ALLAMA = FALSE
      uppfoltemp.VALVARD = ""
      uppfoltemp.FORSTA = TRUE
      uppfoltemp.STAMP = FALSE.
               
      FIND FIRST fastfortemp USE-INDEX ORDNING NO-LOCK NO-ERROR.
      FIND FIRST markval WHERE markval.BETECKNING = fastfortemp.BETECKNING NO-LOCK NO-ERROR.  
      IF AVAILABLE markval THEN DO:                  
         RUN markupp_UI IN skprotapph
         (INPUT "" ,INPUT markval.BETECKNING,INPUT markval.MARKREC,INPUT TABLE uppfoltemp,INPUT TABLE markval,INPUT TABLE maga,OUTPUT TABLE sumtemp).      
      END.   
      sidvar = 1.
      /*start*/      
      FOR EACH fastfortemp USE-INDEX ORDNING NO-LOCK.
         IF antflik > 1 AND sidvar > 1 THEN DO:
            hjfastnamn = fastfortemp.BETECKNING.
            hjfastnamn = REPLACE(hjfastnamn,":"," ").
            hjfastnamn = REPLACE(hjfastnamn,"/"," ").
            hjfastnamn = REPLACE(hjfastnamn,"-"," ").
            hjfastnamn = REPLACE(hjfastnamn,">"," ").
            hjfastnamn = REPLACE(hjfastnamn,"<"," "). 
            /*kompletterat med tecken som ej får finnas i filnamn lena 20221124*/
            hjfastnamn = REPLACE(hjfastnamn,"\"," ").
            hjfastnamn = REPLACE(hjfastnamn,"*"," ").
            hjfastnamn = REPLACE(hjfastnamn,"|"," ").
            hjfastnamn = REPLACE(hjfastnamn,'"'," ").
            hjfastnamn = REPLACE(hjfastnamn,";"," ").      
            hjfastnamn = REPLACE(hjfastnamn,","," ").
            hjfastnamn = REPLACE(hjfastnamn,"'"," ").
            hjfastnamn = REPLACE(hjfastnamn,"+"," ").
            hjfastnamn = REPLACE(hjfastnamn,"."," ").
            IF Guru.GlobalaVariabler:plusaonr = "" OR Guru.GlobalaVariabler:plusaonr = ? THEN DO:
               kommando2 = kommando3 + fnamn1 + hjfastnamn + fnamn2.
            END.
            ELSE DO:
               kommando2 = kommando3 + TRIM (Guru.GlobalaVariabler:plusaonr) + TRIM(STRING(Guru.GlobalaVariabler:plusdnr,Guru.Konstanter:varforetypchar[1])) + fnamn1 + hjfastnamn + fnamn2.
            END.
            DEBUGGER:SET-BREAK().
                                    
            OS-COPY VALUE(kommando4) VALUE(kommando2).
            kommando = kommando2.
            CREATE "Word.Application" chWord NO-ERROR.
            IF ERROR-STATUS:ERROR = FALSE THEN DO:
               chDoc = chWord:Documents:Open(kommando,,,,,,,,,).
               chDoc:Protect(2) NO-ERROR.
               
               chWord:VISIBLE = TRUE.
               IF spmall = TRUE THEN chWord:Visible = FALSE.
               ELSE IF  skrivutmall = TRUE THEN chWord:Visible = FALSE.
               chDoc = chWord:ActiveDocument.
            END.
                                 
         END.
         IF ERROR-STATUS:ERROR = FALSE THEN DO:            
            
            IF avtal = "54" OR avtal = "55" OR avtal = "56" OR avtal = "57" OR avtal = "58"  OR avtal = "62" THEN DO:
               /*FÄRG 2 = BLÅ*/
               IF avtal = "54" OR avtal = "56" OR avtal = "57" THEN DO:
                  varstil = "Arial Narrow".
                  varstorlek = 11.
                  varfet = TRUE.
               END.
               IF  avtal = "55" THEN DO:
                  varstil = "Calibri (Brödtext)".
                  varstorlek = 11.
                  varfet = TRUE.
               END.
               IF   avtal = "62"  THEN DO:
                  varstil = "Calibri (Brödtext)".
                  varstorlek = 12.
                  varfet = TRUE.
               END.
               IF avtal = "58"  THEN DO:
                  varstil = "Arial".
                  varstorlek = 10.
                  varfet = FALSE.
               END.                     
               FIND FIRST markval WHERE markval.MARKNR = fastfortemp.MARKNR NO-LOCK NO-ERROR.
               RUN inbokvaluealla_UI (INPUT "prnr" ,INPUT ponr,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).               
               /*IF pnamn NE "" THEN RUN inbokvalue_UI (INPUT "Projektnamn" ,INPUT pnamn,"Arial Narrow", INPUT 11,INPUT TRUE, INPUT 0 ).*/
                
               IF markval.MARKAGARE NE "" THEN RUN inbokvaluealla_UI (INPUT "markagare" ,INPUT markval.MARKAGARE,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               IF markval.GATUADRESS NE "" THEN RUN inbokvaluealla_UI (INPUT "madress" ,INPUT markval.GATUADRESS,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               IF markval.POSTADRESS NE "" THEN RUN inbokvaluealla_UI (INPUT "mpostadress" ,INPUT (STRING(markval.POSTNUMMER,"xxx xx") + " " + markval.POSTADRESS),INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0 ).
               IF markval.BETECKNING NE "" THEN RUN inbokvaluealla_UI (INPUT "beteckning" ,INPUT markval.BETECKNING,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               /* det skall vara Refnr beställare  (NIS-nr) inte aonr Lena 20140516*
               IF aovar NE "" THEN RUN inbokvaluealla_UI (INPUT "prnr" ,INPUT aovar,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).*/
               RUN vardberanv_UI IN skprotapph (INPUT markval.VARDNR, OUTPUT vardanv, OUTPUT BERANV).
            
               anvtext = "". 
               IF beranv NE "" THEN anvtext = "/" + CAPS(BERANV).
               IF vardanv NE "" THEN anvtext = anvtext + "/" + CAPS(vardanv).
               IF anvtext NE "" THEN RUN inbokvaluealla_UI (INPUT "anvandare" ,INPUT anvtext,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).
               RUN inbokvaluealla_UI (INPUT "datum" ,INPUT STRING(TODAY,"9999-99-99"),INPUT varstil, INPUT varstorlek,INPUT FALSE, INPUT 0).
               
               IF fkommun NE "" THEN RUN inbokvaluealla_UI (INPUT "fkommun" ,INPUT fkommun,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               RUN berman3_UI IN skprotapph (INPUT markval.VARDNR, OUTPUT berman, OUTPUT bertel, OUTPUT berepost, OUTPUT bermane, OUTPUT bertele, OUTPUT bereposte).               
               IF berman NE "" THEN RUN inbokvaluealla_UI (INPUT "beredare2" ,INPUT berman,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF berman NE "" THEN RUN inbokvaluealla_UI (INPUT "beredare3" ,INPUT berman,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF bermane NE "" THEN RUN inbokvaluealla_UI (INPUT "beredare4" ,INPUT bermane,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).               
               IF bertel NE "" THEN RUN inbokvaluealla_UI (INPUT "telefon2" ,INPUT bertel,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF bertel NE "" THEN RUN inbokvaluealla_UI (INPUT "telefon3" ,INPUT bertel,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF bertele NE "" THEN RUN inbokvaluealla_UI (INPUT "telefon4" ,INPUT bertele,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).               
                                 
               IF berepost NE "" THEN RUN inbokvaluealla_UI (INPUT "epost2" ,INPUT berepost,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF berepost NE "" THEN RUN inbokvaluealla_UI (INPUT "epost3" ,INPUT berepost,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF bereposte NE "" THEN RUN inbokvaluealla_UI (INPUT "epost4" ,INPUT bereposte,INPUT varstil, INPUT 10,INPUT FALSE, INPUT 0).                  
               RUN vardman3_UI IN skprotapph (INPUT markval.VARDNR , OUTPUT vardman, OUTPUT vardtel, OUTPUT vadress,OUTPUT vboxnr, OUTPUT vpostnr, OUTPUT vpostadress , OUTPUT vtelefonvxl ).
               IF vardman NE "" THEN RUN inbokvaluealla_UI (INPUT "vardman" ,INPUT vardman,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort" ,INPUT vpostadress,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort2" ,INPUT vpostadress,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort3" ,INPUT CAPS(vpostadress),INPUT varstil, INPUT 10,INPUT TRUE, INPUT 2).
               
               IF vboxnr NE "" THEN RUN inbokvaluealla_UI (INPUT "vboxnr" ,INPUT vboxnr,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
               ELSE IF vadress NE "" THEN  RUN inbokvaluealla_UI (INPUT "vboxnr" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
                             
               IF vadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmadress" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0). 
               IF vadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmadress2" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).               
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmpostadress" ,INPUT (STRING(vpostnr,"xxx xx") + " " + vpostadress),INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
               IF vtelefonvxl NE "" THEN RUN inbokvaluealla_UI (INPUT "vmtelefonvxl" ,INPUT vtelefonvxl,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).            
           END.
           ELSE IF avtal = "60" OR avtal = "61"  THEN DO:
               /*FÄRG 2 = BLÅ*/               
               varstil = "Calibri (Brödtext)".
               varstorlek = 11.
               varfet = TRUE.     
               
               FIND FIRST markval WHERE markval.MARKNR = fastfortemp.MARKNR NO-LOCK NO-ERROR.
               /*RUN inbokvaluearialN10_UI (INPUT "projektnummer" ,INPUT ponr).
               IF pnamn NE "" THEN RUN inbokvalue_UI (INPUT "Projektnamn" ,INPUT pnamn,"Arial Narrow", INPUT 11,INPUT TRUE, INPUT 0 ).*/
                
               IF markval.MARKAGARE NE "" THEN RUN inbokvaluealla_UI (INPUT "markagare" ,INPUT markval.MARKAGARE,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               IF markval.GATUADRESS NE "" THEN RUN inbokvaluealla_UI (INPUT "madress" ,INPUT markval.GATUADRESS,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               IF markval.POSTADRESS NE "" THEN RUN inbokvaluealla_UI (INPUT "mpostadress" ,INPUT (STRING(markval.POSTNUMMER,"xxx xx") + " " + markval.POSTADRESS),INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0 ).
               IF markval.BETECKNING NE "" THEN RUN inbokvaluealla_UI (INPUT "beteckning" ,INPUT markval.BETECKNING,INPUT varstil, INPUT varstorlek,INPUT varfet, INPUT 0).
               IF aovar NE "" THEN RUN inbokvaluealla_UI (INPUT "prnr" ,INPUT aovar,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).
               RUN inbokvaluealla_UI (INPUT "datum" ,INPUT STRING(TODAY,"9999-99-99"),INPUT varstil, INPUT varstorlek,INPUT FALSE, INPUT 0).
               RUN berman3_UI IN skprotapph (INPUT markval.VARDNR, OUTPUT berman, OUTPUT bertel, OUTPUT berepost, OUTPUT bermane, OUTPUT bertele, OUTPUT bereposte).               
               IF berman NE "" THEN RUN inbokvaluealla_UI (INPUT "beredare" ,INPUT berman,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF bertel NE "" THEN RUN inbokvaluealla_UI (INPUT "telefon" ,INPUT bertel,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).                                 
               IF berepost NE "" THEN RUN inbokvaluealla_UI (INPUT "epost" ,INPUT berepost,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).                  
               RUN vardman3_UI IN skprotapph (INPUT markval.VARDNR , OUTPUT vardman, OUTPUT vardtel, OUTPUT vadress,OUTPUT vboxnr, OUTPUT vpostnr, OUTPUT vpostadress , OUTPUT vtelefonvxl ).
               IF vardman NE "" THEN RUN inbokvaluealla_UI (INPUT "vardman" ,INPUT vardman,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort" ,INPUT vpostadress,INPUT varstil, INPUT 11,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort2" ,INPUT vpostadress,INPUT varstil, INPUT 12,INPUT FALSE, INPUT 0).
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vort3" ,INPUT CAPS(vpostadress),INPUT varstil, INPUT 10,INPUT TRUE, INPUT 2).
               
               IF vboxnr NE "" THEN RUN inbokvaluealla_UI (INPUT "vboxnr" ,INPUT vboxnr,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
               ELSE IF vadress NE "" THEN  RUN inbokvaluealla_UI (INPUT "vboxnr" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
                             
               IF vadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmadress" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0). 
               IF vadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmadress2" ,INPUT vadress,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).               
               IF vpostadress NE "" THEN RUN inbokvaluealla_UI (INPUT "vmpostadress" ,INPUT (STRING(vpostnr,"xxx xx") + " " + vpostadress),INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).
               IF vtelefonvxl NE "" THEN RUN inbokvaluealla_UI (INPUT "vmtelefonvxl" ,INPUT vtelefonvxl,INPUT varstil, INPUT 8,INPUT FALSE, INPUT 0).            
           END.
              
                                 
         END.
         DEBUGGER:SET-BREAK().
                    
         sidvar = sidvar + 1.
         /*chDoc:Protect(2) NO-ERROR.*/
         
         IF spmall = TRUE OR skrivutmall = true THEN DO:
            chWord:displayalerts = FALSE.      
            chDoc:SaveAs(kommando,,,,,,,,,).        
            chWord:displayalerts = TRUE.
            IF skrivutmall = TRUE THEN DO:                                 
               chWord:ScreenUpdating = FALSE.
               chDoc:PrintOut(,,,,STRING(SESSION:PRINTER-NAME),,,).                           
            END.              
            NO-RETURN-VALUE chDoc:CLOSE().
            NO-RETURN-VALUE chWord:QUIT().
         END.  
         RELEASE OBJECT chDoc NO-ERROR.
      END.              
   END.  
   SESSION:NUMERIC-FORMAT = "AMERICAN".
   {EUROPEANAMERICAN.I}   
   
         
   RELEASE OBJECT chWord NO-ERROR.

END.

       
 
RELEASE OBJECT chWord NO-ERROR.
IF VALID-HANDLE(skprotapph) THEN DELETE PROCEDURE skprotapph.      
skprotapph = ?.
IF VALID-HANDLE(edataapph) THEN DELETE PROCEDURE edataapph.   
edataapph = ?.

PROCEDURE inbokvalue_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      IF bokvalue <> ? THEN chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
      /*chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      
   END.
END PROCEDURE.

PROCEDURE inbokvaluetnr12_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = "Times New Roman".
         chWord:SELECTION:FONT:SIZE = 12.*/
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.

PROCEDURE inbokvaluetnr11_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = "Times New Roman".
         chWord:SELECTION:FONT:SIZE = 11.*/
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.

PROCEDURE inbokvaluecal11_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = "Calibri".
         chWord:SELECTION:FONT:SIZE = 11.*/
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.
PROCEDURE inbokvaluecal12_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = "Calibri".
         chWord:SELECTION:FONT:SIZE = 12.*/
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.
PROCEDURE inbokvaluetnr10_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = "Times New Roman".
         chWord:SELECTION:FONT:SIZE = 10.*/
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.

 


PROCEDURE inbokvaluealla_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER varstil AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER varsize AS INTEGER   NO-UNDO.
   DEFINE INPUT PARAMETER varbold AS LOGICAL   NO-UNDO.   
   DEFINE INPUT PARAMETER varfarg AS INTEGER   NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         /*  behövs inte och funkar inte
         chWord:SELECTION:FONT:NAME = varstil.
         chWord:SELECTION:FONT:SIZE = varsize.
         chWord:SELECTION:FONT:BOLD = varbold.*/
         IF varfarg NE 0 THEN chWord:SELECTION:FONT::ColorIndex = varfarg NO-ERROR.
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.     
   END.
END PROCEDURE.


PROCEDURE inbokvaluearial10_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         chWord:SELECTION:FONT:NAME = "Arial".
         chWord:SELECTION:FONT:SIZE = 10.
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.     
   END.
END PROCEDURE.
PROCEDURE inbokvaluearial65_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         chWord:SELECTION:FONT:NAME = "Arial".
         chWord:SELECTION:FONT:SIZE = 6.5.
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.
PROCEDURE inbokvaluetba12_UI.
   DEFINE INPUT PARAMETER bokname AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER bokvalue AS CHARACTER NO-UNDO.
   IF chDoc:Bookmarks:EXISTS( bokname ) = TRUE THEN DO:
      chWord:SELECTION:GOTO (wdGoToBookmark BY-VARIANT-POINTER,,,bokname BY-VARIANT-POINTER).  
      IF bokvalue <> ? THEN DO: 
         chWord:SELECTION:FONT:NAME = "Book Antiqua".
         chWord:SELECTION:FONT:SIZE = 12.
         chDoc:FormFields:item(bokname):RESULT = bokvalue NO-ERROR .
         /*chWord:SELECTION:TypeText ( bokvalue ) NO-ERROR.*/ 
      END.
     
   END.
END PROCEDURE.

PROCEDURE mval_UI :
   EMPTY TEMP-TABLE mval NO-ERROR. 
   FOR EACH markval:      
      CREATE mval.
      BUFFER-COPY markval TO mval.
      ASSIGN mval.PRODEL = mval.PROCENT
      mval.ANDEL = "".
      /*markägare andel*/
      IF Guru.Konstanter:varforetypval[22] = 1 THEN DO:      
      
         IF mval.PROCENT = 100 THEN DO:
            ASSIGN
            mval.ANDEL = "1/1"        
            mval.PRODEL = mval.PROCENT.         
         END.
         ELSE DO:      
            EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
            CREATE inextradatatemp.          
            ASSIGN
            inextradatatemp.PROGRAM = "MARKFASTANDEL"                   
            inextradatatemp.HUVUDINT = mval.MARKNR.                    
            inextradatatemp.HUVUDCH = mval.BETECKNING.                    
            RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
            FIND FIRST extradatatemp NO-LOCK NO-ERROR.
            IF AVAILABLE extradatatemp THEN DO:      
               ASSIGN
               mval.ANDEL = extradatatemp.SOKCHAR[1]               
               mval.PRODEL = extradatatemp.SOKDEC[1].         
            END.       
            ELSE DO:
               mval.PRODEL = mval.PROCENT.
               IF mval.PROCENT = 100 THEN mval.ANDEL = "1/1".
               ELSE IF mval.PROCENT = 80 THEN mval.ANDEL = "4/5".         
               ELSE IF mval.PROCENT = 66 THEN mval.ANDEL = "2/3".         
               ELSE IF mval.PROCENT = 60 THEN mval.ANDEL = "3/5".         
               ELSE IF mval.PROCENT = 50 THEN mval.ANDEL = "1/2".         
               ELSE IF mval.PROCENT = 40 THEN mval.ANDEL = "2/5".         
               ELSE IF mval.PROCENT = 33 THEN mval.ANDEL = "1/3".         
               ELSE IF mval.PROCENT = 34 THEN mval.ANDEL = "1/3".   
               ELSE IF mval.PROCENT = 25 THEN mval.ANDEL = "1/4".
               ELSE IF mval.PROCENT = 20 THEN mval.ANDEL = "1/5".
               ELSE IF mval.PROCENT = 10 THEN mval.ANDEL = "1/10".
               ELSE mval.ANDEL = STRING(mval.PROCENT) + "/100".
            END.
         END.
      END.
   END.

END PROCEDURE.
PROCEDURE bladnamn_UI :
   DEFINE INPUT-OUTPUT PARAMETER inblad AS CHARACTER NO-UNDO.
   DEFINE VARIABLE i AS INTEGER NO-UNDO.
   DEFINE VARIABLE orgblad AS CHARACTER NO-UNDO.
   orgblad = inblad.
   i = 1.
   REPEAT:
      FIND FIRST blandnamntemp WHERE blandnamntemp.NAMN = inblad NO-LOCK NO-ERROR.
      IF NOT AVAILABLE blandnamntemp THEN DO:
         CREATE blandnamntemp.
         blandnamntemp.NAMN = inblad.
         LEAVE.
      END.
      i = i + 1.
      inblad = orgblad + " (" + STRING(i) + ")".  
   END.
END PROCEDURE.



