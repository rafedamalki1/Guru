DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.     
DEFINE VARIABLE vnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE TEMP-TABLE persres 
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD tidres AS DECIMAL   
   FIELD sumares AS DECIMAL   
   FIELD sumdagres AS DECIMAL
   INDEX RES PERSONALKOD.   
DEFINE VARIABLE ressumar AS DECIMAL NO-UNDO.        
DEFINE VARIABLE ressumdag AS DECIMAL NO-UNDO. 
DEFINE VARIABLE restidreg AS DECIMAL NO-UNDO.
DEFINE QUERY tq FOR TIDREGITAB.
DEFINE QUERY saq FOR SUMTID.    
DEFINE QUERY sdq FOR SUMTIDDAG.
DEFINE BUFFER sumbuff FOR SUMTIDDAG.    
DEFINE BUFFER sumarbuff FOR SUMTID.
OPEN QUERY sdq FOR EACH SUMTIDDAG WHERE  
SUMTIDDAG.PRISTYP = "RESTID..." AND YEAR(SUMTIDDAG.DATUM) = 1997 AND
SUMTIDDAG.VECKOKORD NE "" USE-INDEX AONR NO-LOCK. 
DO TRANSACTION:
   GET FIRST sdq EXCLUSIVE-LOCK.
   IF SUMTIDDAG.VECKOKORD NE "" THEN DO: 
      regdatum = SUMTIDDAG.DATUM.
      RUN REGVEC.P.
      vnr = INTEGER(SUBSTRING(SUMTIDDAG.VECKOKORD,2,3)).
      IF regvnr >= vnr THEN DELETE SUMTIDDAG.   
      /*
      ELSE DO:
         FIND FIRST sumbuff WHERE sumbuff.AONR = SUMTIDDAG.AONR AND 
         sumbuff.DELNR = SUMTIDDAG.DELNR AND
         sumbuff.PERSONALKOD = SUMTIDDAG.PERSONALKOD AND 
         sumbuff.PRISTYP = "RESTID..." AND RECID(sumbuff) NE RECID(SUMTIDDAG) AND
         sumbuff.DATUM = SUMTIDDAG.DATUM AND
         sumbuff.VECKOKORD NE ""
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE sumbuff THEN DO:
            IF sumbuff.TBELOPP = 0 THEN DELETE sumbuff.
            ELSE IF SUMTIDDAG.TBELOPP = 0 THEN DELETE SUMTIDDAG.
            ELSE DELETE sumbuff.      
         END.
      END. 
      */
   END. 
END.   
REPEAT:   
   DO TRANSACTION:
      GET NEXT sdq EXCLUSIVE-LOCK.       
      IF NOT AVAILABLE SUMTIDDAG THEN LEAVE.
      IF SUMTIDDAG.VECKOKORD NE "" THEN DO: 
         regdatum = SUMTIDDAG.DATUM.
         RUN REGVEC.P.
         vnr = INTEGER(SUBSTRING(SUMTIDDAG.VECKOKORD,2,3)).
         IF regvnr >= vnr THEN DELETE SUMTIDDAG.
         /*
         ELSE DO:            
            FIND FIRST sumbuff WHERE sumbuff.AONR = SUMTIDDAG.AONR AND 
            sumbuff.DELNR = SUMTIDDAG.DELNR AND
            sumbuff.PERSONALKOD = SUMTIDDAG.PERSONALKOD AND 
            sumbuff.PRISTYP = "RESTID..." AND RECID(sumbuff) NE RECID(SUMTIDDAG)
            AND sumbuff.DATUM = SUMTIDDAG.DATUM AND
            sumbuff.VECKOKORD NE ""
            USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR.
            IF AVAILABLE sumbuff THEN DO:
               IF sumbuff.TBELOPP = 0 THEN DELETE sumbuff.
               ELSE IF SUMTIDDAG.TBELOPP = 0 THEN DELETE SUMTIDDAG.
               ELSE DELETE sumbuff.      
            END.
         END.
         */
      END. 
   END.
END.         
OPEN QUERY saq FOR EACH SUMTID WHERE 
SUMTID.PRISTYP = "RESTID..." AND SUMTID.DATUM = 01/01/97 AND
SUMTID.VECKOKORD NE "" 
USE-INDEX AONR NO-LOCK. 
DO TRANSACTION:
   GET FIRST saq EXCLUSIVE-LOCK.
   IF SUMTID.VECKOKORD NE "" THEN DO: 
      ASSIGN SUMTID.TIMMAR = 0.
   END.
END.   
DO WHILE AVAILABLE(SUMTID):  
   DO TRANSACTION:
      GET NEXT saq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN DO:
         IF SUMTID.VECKOKORD NE "" THEN DO: 
            ASSIGN SUMTID.TIMMAR = 0.
         END.
      END.
   END.   
END. 
CLOSE QUERY saq.   
   
GET FIRST sdq NO-LOCK.
DO WHILE AVAILABLE(SUMTIDDAG):      
   IF SUMTIDDAG.VECKOKORD NE "" THEN DO TRANSACTION:    
      FIND FIRST SUMTID WHERE SUMTID.AONR = SUMTIDDAG.AONR AND 
      SUMTID.DELNR = SUMTIDDAG.DELNR AND
      SUMTID.PERSONALKOD = SUMTIDDAG.PERSONALKOD AND 
      SUMTID.PRISTYP = "RESTID..." AND
      SUMTID.DATUM = 01/01/97 AND SUMTID.VECKOKORD NE ""
      USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR.
      
      IF AVAILABLE SUMTID THEN DO:
         ASSIGN SUMTID.TIMMAR = SUMTID.TIMMAR + SUMTIDDAG.TIMMAR.
        /*
         FIND FIRST sumarbuff WHERE sumarbuff.AONR = SUMTID.AONR AND 
         sumarbuff.DELNR = SUMTID.DELNR AND
         sumarbuff.PERSONALKOD = SUMTID.PERSONALKOD AND 
         sumarbuff.PRISTYP = "RESTID..." AND RECID(sumarbuff) NE RECID(SUMTID) AND
         sumarbuff.DATUM = SUMTID.DATUM AND sumarbuff.VECKOKORD NE ""
         USE-INDEX AONR EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE sumarbuff THEN DO:
            DELETE sumarbuff.                  
         END. 
         */
      END.  
      ELSE DO:
         CREATE SUMTID.
         ASSIGN
         SUMTID.AONR = SUMTIDDAG.AONR  
         SUMTID.DELNR = SUMTIDDAG.DELNR 
         SUMTID.PERSONALKOD = SUMTIDDAG.PERSONALKOD  
         SUMTID.PRISTYP = "RESTID..." 
         SUMTID.DATUM = 01/01/97 
         SUMTID.VECKOKORD = SUMTIDDAG.VECKOKORD
         SUMTID.TIMMAR = SUMTIDDAG.TIMMAR
         SUMTID.ORT = SUMTIDDAG.ORT  
         SUMTID.PRIS = SUMTIDDAG.PRIS 
         SUMTID.GEOMRADE = SUMTIDDAG.GEOMRADE  
         SUMTID.AUTODATUM = SUMTIDDAG.AUTODATUM
         SUMTID.EFTERNAMN = SUMTIDDAG.EFTERNAMN
         SUMTID.FORNAMN = SUMTIDDAG.FORNAMN   
         SUMTID.PERSMASK = SUMTIDDAG.PERSMASK
         SUMTID.FASTAAONR = SUMTIDDAG.FASTAAONR  
         SUMTID.BEFATTNING = SUMTIDDAG.BEFATTNING.   
         validate sumtid.
      END.
   END.
   GET NEXT sdq NO-LOCK. 
END.                        
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
OUTPUT TO restidfil APPEND.
display "Rrestid klar" FORETAG.FORETAG.
OUTPUT CLOSE. 
/*
RUN XTRAKT.P.
*/