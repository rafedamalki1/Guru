
/*SKAPKATEKGAPP.P*/


{EKGEBREGURU.I}
{EKGKAT.I}
{KaladmimportTT.I}
DEFINE VARIABLE ekgp1frekvensTTh   AS HANDLE NO-UNDO.
DEFINE VARIABLE ekgp2frekvensTTh   AS HANDLE NO-UNDO.
DEFINE VARIABLE dynqueh AS HANDLE NO-UNDO.
ekgp1frekvensTTh = TEMP-TABLE ekgp1frekvensTT:HANDLE:DEFAULT-BUFFER-HANDLE.
ekgp2frekvensTTh = TEMP-TABLE ekgp2frekvensTT:HANDLE:DEFAULT-BUFFER-HANDLE.
DEFINE NEW SHARED VARIABLE quotervar AS CHARACTER FORMAT "X(256)" NO-UNDO.




DEFINE VARIABLE filnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE dirnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE OKvald AS LOGICAL NO-UNDO.
DEFINE VARIABLE dirspar AS CHARACTER NO-UNDO.
DEFINE VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE VARIABLE dynxml AS HANDLE NO-UNDO.
DEFINE VARIABLE filnamnuppxml AS CHARACTER NO-UNDO.
DEFINE VARIABLE servervar AS CHARACTER LABEL "Smtp Server" NO-UNDO.
DEFINE VARIABLE franvar AS CHARACTER NO-UNDO.
DEFINE VARIABLE tillepost AS CHARACTER NO-UNDO.
DEFINE VARIABLE klogvar AS INTEGER NO-UNDO.
DEFINE VARIABLE mskpris  AS INTEGER NO-UNDO.

DEFINE VARIABLE ebrmont AS DECIMAL NO-UNDO.
DEFINE VARIABLE ebrber AS DECIMAL NO-UNDO.
DEFINE VARIABLE ebrbervit AS DECIMAL NO-UNDO.   
DEFINE VARIABLE ebrmask1 AS DECIMAL NO-UNDO.   
DEFINE VARIABLE ebrmask2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ebrmask3 AS DECIMAL NO-UNDO.   
DEFINE VARIABLE rorlig AS DECIMAL NO-UNDO.
DEFINE VARIABLE ebrmask1vit AS DECIMAL NO-UNDO.


DEFINE VARIABLE bloblog AS LOGICAL NO-UNDO.
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.

DEFINE BUFFER KALKYLKATALOGSUBbuff FOR KALKYLKATALOGSUB.
DEFINE BUFFER KALKYLKATALOGSUBbuff2 FOR KALKYLKATALOGSUB.   
DEFINE BUFFER KALKYLPRISERbuff FOR KALKYLPRISER.
DEFINE BUFFER KALKNUMbuff FOR KALKNUM.
DEFINE BUFFER KALKNUMSUBbuff FOR KALKNUMSUB.
DEFINE VARIABLE kpostid AS ROWID NO-UNDO.

DEFINE TEMP-TABLE tidin
   FIELD ARBKOD                 AS CHARACTER
   FIELD LOPNR                  AS CHARACTER    
   FIELD BENAMNING              AS CHARACTER
   FIELD INGAREJ                AS CHARACTER.

DEFINE TEMP-TABLE tidin2
   FIELD ARBKOD                 AS CHARACTER
   FIELD LOPNR                  AS CHARACTER 
   FIELD BENAMNING              AS CHARACTER
   FIELD INGAREJ                AS CHARACTER
   INDEX ARBKOD ARBKOD LOPNR.
   
DEFINE TEMP-TABLE p2komtt NO-UNDO
   FIELD ARBKOD AS CHARACTER
   FIELD LOPNR AS INTEGER
   FIELD ANM AS CHARACTER.
   
DEFINE TEMP-TABLE Ebr-Data_P2KomGuru NO-UNDO    
    FIELD P2ARBKOD AS CHARACTER  
    FIELD P2LOPNR AS INTEGER        
    FIELD SVEPLOPNR AS CHARACTER   
    FIELD ANMARKNING AS CHARACTER 
    FIELD INGAREJ AS CHARACTER
    INDEX P2ARBKOD P2ARBKOD P2LOPNR.   

RUN aretstimpriser_UI.
/*RUN fjolaretstimpriser_UI.*/

PROCEDURE aretspriserhmt_UI :
   DEFINE OUTPUT PARAMETER ebrmont AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrber AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrbervit AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrmask1 AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrmask2 AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrmask3 AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER rorlig AS DECIMAL NO-UNDO.
   DEFINE OUTPUT PARAMETER ebrmask1vit AS DECIMAL NO-UNDO.
    /*2022*/
   ASSIGN
   ebrmont  = 847
   ebrber  = 927
   ebrbervit  = 1030   
   ebrmask1    = 882
   ebrmask2    = 867
   ebrmask3    = 907
   rorlig      = 453.6
   ebrmask1vit    = 1389.
   /*/*2021*/
   ASSIGN
   ebrmont  = 822
   ebrber  = 890
   ebrbervit  = 989   
   ebrmask1    = 811
   ebrmask2    = 794
   ebrmask3    = 828
   rorlig      = 440
   ebrmask1vit    = 1272.
   /*2020*/
   ASSIGN
   ebrmont  = 806
   ebrber  = 874
   ebrbervit  = 970.6   
   ebrmask1    = 811
   ebrmask2    = 802
   ebrmask3    = 835
   rorlig      = 432
   ebrmask1vit    = 1272.
   /*2019*/
   ASSIGN
   ebrmont  = 789
   ebrber  = 853.3
   ebrbervit  = 949.9   
   ebrmask1    = 788
   ebrmask2    = 779
   ebrmask3    = 812
   rorlig      = 422.55
   ebrmask1vit    = 1240.*/
   /*/*2018*/
   ASSIGN
   ebrmont  = 771
   ebrber  = 823.4
   ebrbervit  = 926.9   
   ebrmask1    = 760
   ebrmask2    = 752
   ebrmask3    = 784
   rorlig      = 413.1
   ebrmask1vit    = 872.5.
   /*2017*/
   ASSIGN
   ebrmont  = 756
   ebrber  = 800.4
   ebrbervit  = 908.5   
   ebrmask1    = 748
   ebrmask2    = 736
   ebrmask3    = 769
   rorlig      = 405
   ebrmask1vit    = 858.7.*/
END PROCEDURE.

PROCEDURE aretstimpriser_UI :
   /*2020*/
   ASSIGN
   ebrmont  = 822
   ebrber  = 890
   ebrbervit  = 989   
   ebrmask1    = 811
   ebrmask2    = 794
   ebrmask3    = 828
   rorlig      = 440
   ebrmask1vit    = 1272.
   /*/*2020*/
   ASSIGN
   ebrmont  = 806
   ebrber  = 874
   ebrbervit  = 970.6   
   ebrmask1    = 811
   ebrmask2    = 802
   ebrmask3    = 835
   rorlig      = 432
   ebrmask1vit    = 1272.
   /*2019*/
   ASSIGN
   ebrmont  = 789
   ebrber  = 853.3
   ebrbervit  = 949.9   
   ebrmask1    = 788
   ebrmask2    = 779
   ebrmask3    = 812
   rorlig      = 422.55
   ebrmask1vit    = 1240.*/
   /*/*2018*/
   ASSIGN
   ebrmont  = 771
   ebrber  = 823.4
   ebrbervit  = 926.9   
   ebrmask1    = 760
   ebrmask2    = 752
   ebrmask3    = 784
   rorlig      = 413.1
   ebrmask1vit    = 872.5.
   /*2017*/
   ASSIGN
   ebrmont  = 756
   ebrber  = 800.4
   ebrbervit  = 908.5   
   ebrmask1    = 748
   ebrmask2    = 736
   ebrmask3    = 769
   rorlig      = 405
   ebrmask1vit    = 858.7.*/
END PROCEDURE.

PROCEDURE valtartimpriser_UI :
 
   IF Ebr-Data_Katalog.year = "2022" THEN DO: 
      /*2022*/
      ASSIGN
      ebrmont  = 847
      ebrber  = 927
      ebrbervit  = 1030   
      ebrmask1    = 882
      ebrmask2    = 867
      ebrmask3    = 907
      rorlig      = 453.6
      ebrmask1vit    = 1389.

   END.   
   ELSE IF Ebr-Data_Katalog.year = "2021" THEN DO: 
      /*2021*/
      ASSIGN
      ebrmont  = 822
      ebrber  = 890
      ebrbervit  = 989   
      ebrmask1    = 811
      ebrmask2    = 794
      ebrmask3    = 828
      rorlig      = 440
      ebrmask1vit    = 1272.
   END.
   ELSE IF Ebr-Data_Katalog.year = "2020" THEN DO:   
     /*2020*/
      ASSIGN
      ebrmont  = 806
      ebrber  = 874
      ebrbervit  = 970.6   
      ebrmask1    = 811
      ebrmask2    = 802
      ebrmask3    = 835
      rorlig      = 432
      ebrmask1vit    = 1272.
   END.    
   ELSE IF Ebr-Data_Katalog.year = "2019" THEN DO:
      /*2019*/
      ASSIGN
      ebrmont  = 789
      ebrber  = 853.3
      ebrbervit  = 949.9   
      ebrmask1    = 788
      ebrmask2    = 779
      ebrmask3    = 812
      rorlig      = 422.55
      ebrmask1vit    = 1240.
   END.
   ELSE IF Ebr-Data_Katalog.year = "2018" THEN DO:
      /*2018*/
      ASSIGN
      ebrmont  = 771
      ebrber  = 823.4
      ebrbervit  = 926.9   
      ebrmask1    = 760
      ebrmask2    = 752
      ebrmask3    = 784
      rorlig      = 413.1
      ebrmask1vit    = 872.5.
   END.
   ELSE IF Ebr-Data_Katalog.year = "2017" THEN DO:   
      /*2017*/
      ASSIGN
      ebrmont  = 756
      ebrber  = 800.4
      ebrbervit  = 908.5   
      ebrmask1    = 748
      ebrmask2    = 736
      ebrmask3    = 769
      rorlig      = 405
      ebrmask1vit    = 858.7.
  END.    
END PROCEDURE.
PROCEDURE fjolaretstimpriser_UI :
   /*2020*/
   ASSIGN
   ebrmont  = 806
   ebrber  = 874
   ebrbervit  = 970.6   
   ebrmask1    = 811
   ebrmask2    = 802
   ebrmask3    = 835
   rorlig      = 432
   ebrmask1vit    = 1272.
   /*/*2019*/
   ASSIGN
   ebrmont  = 789
   ebrber  = 853.3
   ebrbervit  = 949.9   
   ebrmask1    = 788
   ebrmask2    = 779
   ebrmask3    = 812
   rorlig      = 422.55
   ebrmask1vit    = 1240.
   /*2018*/
   ASSIGN
   ebrmont  = 771
   ebrber  = 823.4
   ebrbervit  = 926.9   
   ebrmask1    = 760
   ebrmask2    = 752
   ebrmask3    = 784
   rorlig      = 413.1
   ebrmask1vit    = 872.5.
   /*2017*/
   ASSIGN
   ebrmont  = 756
   ebrber  = 800.4
   ebrbervit  = 908.5   
   ebrmask1    = 748
   ebrmask2    = 736
   ebrmask3    = 769
   rorlig      = 405
   ebrmask1vit    = 858.7.
   /*2016*/
   ASSIGN
   ebrmont  = 725.76
   ebrber  = 725.76
   ebrbervit  = 874   
   ebrmask1    = 726
   ebrmask2    = 715
   ebrmask3    = 747
   rorlig      = 388.8
   ebrmask1vit    = 822.
   /*2015*/
   ASSIGN
   ebrmont  = 713.16
   ebrbervit  = 857.9    
   ebrmask1    = 726
   ebrmask2    = 715
   ebrmask3    = 747
   rorlig      = 382.05
   ebrmask1vit    = 747.*/ 
   /*/*2014*/
   ASSIGN
   ebrmont  = 703.53
   ebrbervit  = 847.04    
   ebrmask1    = 723
   ebrmask2    = 712
   ebrmask3    = 744
   rorlig      = 376.89.*/
END PROCEDURE.


PROCEDURE rensa_UI :
   {Ebr-DataRensa.i}
   ekgp1frekvensTTh:EMPTY-TEMP-TABLE() NO-ERROR.
   ekgp2frekvensTTh:EMPTY-TEMP-TABLE() NO-ERROR.
     
   
   EMPTY TEMP-TABLE tidin NO-ERROR. 
   EMPTY TEMP-TABLE tidin2 NO-ERROR. 
   EMPTY TEMP-TABLE p2komtt NO-ERROR. 
END PROCEDURE.

PROCEDURE p2kom_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   FOR EACH p2komtt WHERE NO-LOCK:
      DO TRANSACTION:
         FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.ARBKOD = p2komtt.ARBKOD AND 
         KALKYLLOPPOSTER.LOPNR = p2komtt.LOPNR EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE KALKYLLOPPOSTER THEN KALKYLLOPPOSTER.KOMMENTAR = p2komtt.ANM.
      END.    
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.
END PROCEDURE.
PROCEDURE komP2KLG1_UI :
   DEFINE VARIABLE spos AS INTEGER NO-UNDO.
   DEFINE VARIABLE startvar AS INTEGER NO-UNDO.
   DEFINE VARIABLE slutvar AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR tidin.
   EMPTY TEMP-TABLE tidin2 NO-ERROR. 
   FOR EACH tidin:
      IF tidin.BENAMNING = "" THEN .
      ELSE DO:
         FIND FIRST tidin2 WHERE tidin2.ARBKOD = tidin.ARBKOD AND tidin2.LOPNR = tidin.LOPNR USE-INDEX ARBKOD 
         NO-LOCK NO-ERROR.
         IF NOT AVAILABLE tidin2 THEN DO:      
            CREATE tidin2.
            ASSIGN
            tidin2.ARBKOD = tidin.ARBKOD.
            tidin2.LOPNR = tidin.LOPNR.      
            IF tidin.INGAREJ = "X" THEN tidin2.INGAREJ = tidin.BENAMNING.
            ELSE tidin2.BENAMNING = tidin.BENAMNING.
         END.
         ELSE DO:
            IF tidin.INGAREJ = "X" THEN tidin2.INGAREJ = tidin2.INGAREJ + CHR(10) + tidin.BENAMNING.
            ELSE tidin2.BENAMNING = tidin2.BENAMNING + CHR(10) + tidin.BENAMNING.      
         END.
      END.   
   END.


   FOR EACH tidin2:  
      IF SUBSTRING(tidin2.LOPNR,1,1) = "." THEN spos = 1.
      ELSE spos = 0.
      /*IF SUBSTRING(tidin2.ARBKOD,6,1) = "-" THEN DO:*/    
      IF SUBSTRING(tidin2.LOPNR,3 + spos,1) = "-" THEN DO:
         ASSIGN
         startvar = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2))
         slutvar  = INTEGER(SUBSTRING(tidin2.LOPNR,4 + spos,2)).
         DO WHILE startvar <= slutvar:
            FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) AND p2komtt.LOPNR = startvar NO-LOCK NO-ERROR.
            IF NOT AVAILABLE p2komtt THEN DO:
               CREATE p2komtt.
               ASSIGN
               p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
               p2komtt.LOPNR  = startvar.
            END.
            IF p2komtt.ANM = "" THEN DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = tidin2.BENAMNING.
            END.
            ELSE DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
            END.
            startvar = startvar + 1.
         END.
      END.
      ELSE IF SUBSTRING(tidin2.LOPNR,3 + spos,1) = "," THEN DO:
         FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)) NO-LOCK NO-ERROR.
         IF NOT AVAILABLE p2komtt THEN DO:
            CREATE p2komtt.            
            ASSIGN
            p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
            p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)).
         END.  
         IF p2komtt.ANM = "" THEN DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = tidin2.BENAMNING.
         END.
         ELSE DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
         END.      
         FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,4 + spos,2)) NO-LOCK NO-ERROR.
         IF NOT AVAILABLE p2komtt THEN DO:
            CREATE p2komtt.
            ASSIGN
            p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
            p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)).
         END. 
         IF p2komtt.ANM  = "" THEN DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM  =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM  = tidin2.BENAMNING.
         END.
         ELSE DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
         END.      
      END.
      ELSE DO:               
         /*IF SUBSTRING(tidin2.ARBKOD,4,2) = "00" THEN DO:*/
         IF tidin2.LOPNR = "" THEN DO:
            OPEN QUERY pq FOR EACH KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND
            KALKYLLOPPOSTER.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) NO-LOCK.
            GET FIRST pq NO-LOCK.
            DO WHILE AVAILABLE(KALKYLLOPPOSTER):
               FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) AND p2komtt.LOPNR = KALKYLLOPPOSTER.LOPNR NO-LOCK NO-ERROR.
               IF NOT AVAILABLE p2komtt THEN DO:
                  CREATE p2komtt.
                  ASSIGN
                  p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
                  p2komtt.LOPNR  = KALKYLLOPPOSTER.LOPNR.
               END. 
               IF p2komtt.ANM = "" THEN DO:
                  IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
                  ELSE p2komtt.ANM = tidin2.BENAMNING.
               END.
               ELSE DO:
                  IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
                  ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
               END.   
               GET NEXT pq NO-LOCK.
            END.
         END.
         ELSE DO:
            FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)) NO-LOCK NO-ERROR.
            IF NOT AVAILABLE p2komtt THEN DO:
               CREATE p2komtt.
               ASSIGN
               p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
               p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)).
            END.  
            IF p2komtt.ANM = "" THEN DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = tidin2.BENAMNING.
            END.
            ELSE DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
            END.
         END.
      END.
   END.
   FOR EACH p2komtt WHERE NO-LOCK:
      DO TRANSACTION:
         FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.ARBKOD = p2komtt.ARBKOD AND 
         KALKYLLOPPOSTER.LOPNR = p2komtt.LOPNR EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE KALKYLLOPPOSTER THEN KALKYLLOPPOSTER.KOMMENTAR = p2komtt.ANM.
      END.    
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.
END PROCEDURE.
PROCEDURE komP2KLG2_UI :
   DEFINE VARIABLE spos AS INTEGER NO-UNDO.
   DEFINE VARIABLE startvar AS INTEGER NO-UNDO.
   DEFINE VARIABLE slutvar AS INTEGER NO-UNDO.
   DEFINE VARIABLE hjP2arbkod AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR tidin.
   EMPTY TEMP-TABLE tidin2 NO-ERROR. 
   FOR EACH tidin:
      IF tidin.BENAMNING = "" THEN .
      ELSE DO:
         FIND FIRST tidin2 WHERE tidin2.ARBKOD = tidin.ARBKOD AND tidin2.LOPNR = tidin.LOPNR USE-INDEX ARBKOD 
         NO-LOCK NO-ERROR.
         IF NOT AVAILABLE tidin2 THEN DO:      
            CREATE tidin2.
            ASSIGN
            tidin2.ARBKOD = tidin.ARBKOD.
            tidin2.LOPNR = tidin.LOPNR.               
            IF tidin.INGAREJ = "X" THEN tidin2.INGAREJ = tidin.BENAMNING.
            ELSE tidin2.BENAMNING = tidin.BENAMNING.
         END.
         ELSE DO:
            IF tidin.INGAREJ = "X" THEN tidin2.INGAREJ = tidin2.INGAREJ + CHR(10) + tidin.BENAMNING.
            ELSE tidin2.BENAMNING = tidin2.BENAMNING + CHR(10) + tidin.BENAMNING.      
         END.
      END.   
   END.
   FOR EACH tidin2:  
      IF SUBSTRING(tidin2.LOPNR,1,1) = "." THEN spos = 1.
      ELSE spos = 0.
       /*IF SUBSTRING(tidin2.ARBKOD,6,1) = "-" THEN DO:*/    
      IF SUBSTRING(tidin2.LOPNR,3 + spos,1) = "-" THEN DO:
         ASSIGN
         startvar = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2))
         slutvar = INTEGER(SUBSTRING(tidin2.LOPNR,4 + spos,2)).
         DO WHILE startvar <= slutvar:
            FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,2) AND p2komtt.LOPNR = startvar NO-LOCK NO-ERROR.
            IF NOT AVAILABLE p2komtt THEN DO:
               CREATE p2komtt.
               ASSIGN
               p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
               p2komtt.LOPNR  = startvar.
            END.          
            IF p2komtt.ANM = "" THEN DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = tidin2.BENAMNING.
            END.
            ELSE DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
            END.               
            startvar = startvar + 1.            
         END.
      END.
      /*ELSE IF SUBSTRING(tidin2.ARBKOD,6,1) = "," THEN DO:*/
      ELSE IF SUBSTRING(tidin2.LOPNR,3 + spos,1) = "," THEN DO:
         FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,2) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)) NO-LOCK NO-ERROR.      
         IF NOT AVAILABLE p2komtt THEN DO:
            CREATE p2komtt.
            ASSIGN
            p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
            p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)).
         END.          
         IF p2komtt.ANM = "" THEN DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = tidin2.BENAMNING.
         END.
         ELSE DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
         END. 
         FIND FIRST p2komtt WHERE p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,2) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,4 + spos,2)) NO-LOCK NO-ERROR.     
         IF NOT AVAILABLE p2komtt THEN DO:
            CREATE p2komtt.
            ASSIGN
            p2komtt.ARBKOD = SUBSTRING(tidin2.ARBKOD,1,3)
            p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,4 + spos,2)).
         END.          
         IF p2komtt.ANM = "" THEN DO:
            IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = tidin2.BENAMNING.
         END.
         ELSE DO:
            IF tidin2.INGAREJ NE "" THEN
            p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
            ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
         END.      
      END.
      ELSE DO:               
         /*IF SUBSTRING(tidin2.ARBKOD,4,2) = "00" THEN DO:*/
         IF tidin2.LOPNR = "" THEN DO:
            OPEN QUERY pq FOR EACH KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND
            KALKYLLOPPOSTER.ARBKOD = " " + SUBSTRING(tidin2.ARBKOD,1,2) NO-LOCK.
            GET FIRST pq NO-LOCK.
            DO WHILE AVAILABLE(KALKYLLOPPOSTER):
               FIND FIRST p2komtt WHERE p2komtt.ARBKOD = " " + SUBSTRING(tidin2.ARBKOD,1,2) AND p2komtt.LOPNR = KALKYLLOPPOSTER.LOPNR NO-LOCK NO-ERROR.
               IF NOT AVAILABLE p2komtt THEN DO:
                  CREATE p2komtt.
                  ASSIGN
                  p2komtt.ARBKOD = " " + SUBSTRING(tidin2.ARBKOD,1,2)
                  p2komtt.LOPNR  = KALKYLLOPPOSTER.LOPNR.
               END. 
               IF p2komtt.ANM = "" THEN DO:
                  IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
                  ELSE p2komtt.ANM = tidin2.BENAMNING.
               END.
               ELSE DO:
                  IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
                  ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
               END.   
               GET NEXT pq NO-LOCK.
            END.         
         END.
         ELSE DO:
            FIND FIRST p2komtt WHERE p2komtt.ARBKOD = " " + SUBSTRING(tidin2.ARBKOD,1,2) AND p2komtt.LOPNR = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)) NO-LOCK NO-ERROR.
            IF NOT AVAILABLE p2komtt THEN DO:
               CREATE p2komtt.
               ASSIGN
               p2komtt.ARBKOD = " " + SUBSTRING(tidin2.ARBKOD,1,2)
               p2komtt.LOPNR  = INTEGER(SUBSTRING(tidin2.LOPNR,1 + spos,2)).
            END.         
            IF p2komtt.ANM = "" THEN DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM =  tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = tidin2.BENAMNING.
            END.
            ELSE DO:
               IF tidin2.INGAREJ NE "" THEN p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING + CHR(10) + CHR(10) + "Ingår ej:" + tidin2.INGAREJ.
               ELSE p2komtt.ANM = p2komtt.ANM + CHR(10) + tidin2.BENAMNING.               
            END.
         END.               
      END.     
   END.
   
   FOR EACH p2komtt WHERE NO-LOCK:
      hjP2arbkod = " " + SUBSTRING(p2komtt.ARBKOD,1,2).
      p2komtt.ARBKOD = hjP2arbkod.
      
   END.
   
   FOR EACH p2komtt WHERE NO-LOCK:
      DO TRANSACTION:
         FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.ARBKOD = p2komtt.ARBKOD AND 
         KALKYLLOPPOSTER.LOPNR = p2komtt.LOPNR EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE KALKYLLOPPOSTER THEN KALKYLLOPPOSTER.KOMMENTAR = p2komtt.ANM.
      END.    
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.
  /* RUN p2kom_UI (INPUT klogsubidvar).*/
   
END PROCEDURE.
PROCEDURE frekvensP1P2_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   /*
   DEFINE INPUT  PARAMETER Ebr-Data_P1P2Frekvensh AS HANDLE NO-UNDO.
   */
   /*DEFINE INPUT  PARAMETER ekgp1frekvensTTh AS HANDLE NO-UNDO.*/
   DEFINE VARIABLE Ebr-Data_P1P2Frekvensh AS HANDLE NO-UNDO.
     
   Ebr-Data_P1P2Frekvensh = TEMP-TABLE Ebr-Data_P1P2Frekvens:HANDLE:DEFAULT-BUFFER-HANDLE.
   DEFINE VARIABLE hjP1arbkod AS CHARACTER NO-UNDO.
   DEFINE VARIABLE hjP2arbkod AS CHARACTER NO-UNDO.
   FIND FIRST KALKYLKATALOGSUB WHERE KALKYLKATALOGSUB.KLOGSUBID = klogsubidvar NO-LOCK NO-ERROR.
   
    CREATE QUERY dynqueh.
   dynqueh:SET-BUFFERS(Ebr-Data_P1P2Frekvensh).
   dynqueh:QUERY-PREPARE("FOR EACH " + Ebr-Data_P1P2Frekvensh:TABLE ).
   dynqueh:QUERY-OPEN() .
   dynqueh:GET-FIRST(NO-LOCK).
   DO WHILE Ebr-Data_P1P2Frekvensh:AVAILABLE: 
      IF KALKYLKATALOGSUB.BENAMNING MATCHES "*KLG2*" THEN DO:
         hjP1arbkod = SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,1,1) + " " + SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,2,2).
         hjP2arbkod = " " + SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
      END.
      ELSE DO:
         IF LENGTH(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE) = 3 THEN DO:
          /*konverterad databas har klg1 och klg2 i samma*/  
            hjP1arbkod = SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,1,1) + " " + SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,2,2).
            hjP2arbkod = " " + SUBSTRING(Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
         END.   
         ELSE DO:
            hjP1arbkod = Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE.
            hjP2arbkod = Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE.
         END.   
      END.      
         
      DO TRANSACTION:
         CREATE FREKVENSKATALOG.
         ASSIGN 
         FREKVENSKATALOG.KLOGSUBID = klogsubidvar
         FREKVENSKATALOG.ARBKOD = hjP1arbkod 
         FREKVENSKATALOG.LOPNR =  Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P1LOPNR"):BUFFER-VALUE 
         FREKVENSKATALOG.FREKOD = hjP2arbkod
         FREKVENSKATALOG.FREKNR = Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P2LOPNR"):BUFFER-VALUE
         FREKVENSKATALOG.ANTAL = Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("ANTAL"):BUFFER-VALUE
         FREKVENSKATALOG.BENAMNING = Ebr-Data_P1P2Frekvensh:BUFFER-FIELD("P2BENAMNING"):BUFFER-VALUE.         
      
         FIND FIRST KALKYLLOPPOSTER  WHERE KALKYLLOPPOSTER.KLOGSUBID = FREKVENSKATALOG.KLOGSUBID AND KALKYLLOPPOSTER.ARBKOD = FREKVENSKATALOG.FREKOD AND KALKYLLOPPOSTER.LOPNR = FREKVENSKATALOG.FREKNR NO-LOCK NO-ERROR.         
         IF AVAILABLE KALKYLLOPPOSTER THEN DO:
            FREKVENSKATALOG.ENHET = KALKYLLOPPOSTER.ENHET.
         END.   
      END.         
      /*OUTPUT TO c:\FREKP1P2.txt append.
      PUT UNFORMATTED FREKVENSKATALOG.KLOGSUBID AT 1
            " " FREKVENSKATALOG.ARBKOD " "
            FREKVENSKATALOG.LOPNR " "
            FREKVENSKATALOG.FREKOD " "
            FREKVENSKATALOG.FREKNR " "
            FREKVENSKATALOG.ANTAL " "                       
            SKIP.
      OUTPUT CLOSE.*/
      dynqueh:GET-NEXT(NO-LOCK).        
   END.
   dynqueh:QUERY-CLOSE().   
   RELEASE FREKVENSKATALOG NO-ERROR.
     
 /*  CREATE QUERY dynqueh.
   dynqueh:SET-BUFFERS(ekgp1frekvensTTh).
   dynqueh:QUERY-PREPARE("FOR EACH " + ekgp1frekvensTTh:TABLE ).
   dynqueh:QUERY-OPEN() .
   dynqueh:GET-FIRST(NO-LOCK).
   DO WHILE ekgp1frekvensTTh:AVAILABLE: 
      IF KALKYLKATALOGSUB.BENAMNING MATCHES "*KLG2*" THEN DO:
         hjP1arbkod = SUBSTRING(ekgp1frekvensTTh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,1,1) + " " + SUBSTRING(ekgp1frekvensTTh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE,2,2).
         hjP2arbkod = " " + SUBSTRING(ekgp1frekvensTTh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
      END.
      ELSE DO:
         hjP1arbkod = ekgp1frekvensTTh:BUFFER-FIELD("P1ARBKOD"):BUFFER-VALUE.
         hjP2arbkod = ekgp1frekvensTTh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE.
      END.         
      CREATE FREKVENSKATALOG.
      ASSIGN 
      FREKVENSKATALOG.KLOGSUBID = klogsubidvar
      FREKVENSKATALOG.ARBKOD = hjP1arbkod 
      FREKVENSKATALOG.LOPNR =  ekgp1frekvensTTh:BUFFER-FIELD("P1LOPNR"):BUFFER-VALUE 
      FREKVENSKATALOG.FREKOD = hjP2arbkod
      FREKVENSKATALOG.FREKNR = ekgp1frekvensTTh:BUFFER-FIELD("P2LOPNR"):BUFFER-VALUE
      FREKVENSKATALOG.ANTAL = ekgp1frekvensTTh:BUFFER-FIELD("ANTAL"):BUFFER-VALUE 
      FREKVENSKATALOG.BENAMNING = ekgp1frekvensTTh:BUFFER-FIELD("P2BENAMNING"):BUFFER-VALUE.         
      dynqueh:GET-NEXT(NO-LOCK).        
   END.
   dynqueh:QUERY-CLOSE().   
   RELEASE FREKVENSKATALOG NO-ERROR.*/
   
 
END PROCEDURE.
PROCEDURE frekvensP2P3_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
  /*
   DEFINE INPUT  PARAMETER Ebr-Data_P2P3Frekvensh AS HANDLE NO-UNDO.
   */
   /*DEFINE INPUT  PARAMETER ekgp2frekvensTTh AS HANDLE NO-UNDO.*/
   DEFINE VARIABLE Ebr-Data_P2P3Frekvensh AS HANDLE NO-UNDO.
   DEFINE VARIABLE hjP2arbkod AS CHARACTER NO-UNDO.
   DEFINE VARIABLE hjP3arbkod AS CHARACTER NO-UNDO.
   Ebr-Data_P2P3Frekvensh = TEMP-TABLE Ebr-Data_P2P3Frekvens:HANDLE:DEFAULT-BUFFER-HANDLE.
   FIND FIRST KALKYLKATALOGSUB WHERE KALKYLKATALOGSUB.KLOGSUBID = klogsubidvar NO-LOCK NO-ERROR.
   
   CREATE QUERY dynqueh.
   dynqueh:SET-BUFFERS(Ebr-Data_P2P3Frekvensh).
   dynqueh:QUERY-PREPARE("FOR EACH " + Ebr-Data_P2P3Frekvensh:TABLE ).
   dynqueh:QUERY-OPEN() .
   dynqueh:GET-FIRST(NO-LOCK).
   DO WHILE Ebr-Data_P2P3Frekvensh:AVAILABLE: 
      IF KALKYLKATALOGSUB.BENAMNING MATCHES "*KLG2*" THEN DO:         
         hjP2arbkod = " " + SUBSTRING(Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
         IF Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "510" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "850" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "855" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "856"
         OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "857" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "863" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "999" THEN DO:
            hjP3arbkod = "R" + Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
         END.   
         ELSE hjP3arbkod = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
      END.
      ELSE DO:
         IF LENGTH(Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE) = 2 THEN DO:
            /*konverterad databas har klg1 och klg2 i samma*/
            hjP2arbkod = " " + SUBSTRING(Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
            IF Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "510" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "850" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "855" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "856"
            OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "857" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "863" OR Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "999" THEN DO:
               hjP3arbkod = "R" + Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
            END.   
            ELSE hjP3arbkod = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
         END.
         ELSE DO: 
            hjP2arbkod = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE.
            hjP3arbkod = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
         END.   
      END.     
      DO TRANSACTION:    
         CREATE FREKVENSKATALOG.
         ASSIGN 
         FREKVENSKATALOG.KLOGSUBID = klogsubidvar
         FREKVENSKATALOG.ARBKOD = hjP2arbkod 
         FREKVENSKATALOG.LOPNR =  Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P2LOPNR"):BUFFER-VALUE 
         FREKVENSKATALOG.FREKOD = hjP3arbkod
         FREKVENSKATALOG.FREKNR = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3LOPNR"):BUFFER-VALUE
         FREKVENSKATALOG.ANTAL = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("ANTAL"):BUFFER-VALUE 
         FREKVENSKATALOG.BENAMNING = Ebr-Data_P2P3Frekvensh:BUFFER-FIELD("P3BENAMNING"):BUFFER-VALUE.
         FIND FIRST KALKYLLOPPOSTER  WHERE KALKYLLOPPOSTER.KLOGSUBID = FREKVENSKATALOG.KLOGSUBID AND KALKYLLOPPOSTER.ARBKOD = FREKVENSKATALOG.FREKOD AND KALKYLLOPPOSTER.LOPNR = FREKVENSKATALOG.FREKNR NO-LOCK NO-ERROR.
         IF AVAILABLE KALKYLLOPPOSTER THEN DO:
            FREKVENSKATALOG.ENHET = KALKYLLOPPOSTER.ENHET.
         END.
      END.            
      dynqueh:GET-NEXT(NO-LOCK).        
   END.
   dynqueh:QUERY-CLOSE().
   RELEASE FREKVENSKATALOG NO-ERROR.
     
   /*CREATE QUERY dynqueh.
   dynqueh:SET-BUFFERS(ekgp2frekvensTTh).
   dynqueh:QUERY-PREPARE("FOR EACH " + ekgp2frekvensTTh:TABLE ).
   dynqueh:QUERY-OPEN() .
   dynqueh:GET-FIRST(NO-LOCK).
   DO WHILE ekgp2frekvensTTh:AVAILABLE: 
      IF KALKYLKATALOGSUB.BENAMNING MATCHES "*KLG2*" THEN DO:         
         hjP2arbkod = " " + SUBSTRING(ekgp2frekvensTTh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE,1,2).
         IF ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "850" OR ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "855" OR ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "856"
         OR ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "857" OR ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "863" OR ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE = "999" THEN DO:
            hjP3arbkod = "R" + ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
         END.   
         ELSE hjP3arbkod = ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
      END.
      ELSE DO:
         hjP2arbkod = ekgp2frekvensTTh:BUFFER-FIELD("P2ARBKOD"):BUFFER-VALUE.
         hjP3arbkod = ekgp2frekvensTTh:BUFFER-FIELD("P3ARBKOD"):BUFFER-VALUE.
      END.         
      CREATE FREKVENSKATALOG.
      ASSIGN 
      FREKVENSKATALOG.KLOGSUBID = klogsubidvar
      FREKVENSKATALOG.ARBKOD = hjP2arbkod 
      FREKVENSKATALOG.LOPNR =  ekgp2frekvensTTh:BUFFER-FIELD("P2LOPNR"):BUFFER-VALUE 
      FREKVENSKATALOG.FREKOD = hjP3arbkod
      FREKVENSKATALOG.FREKNR = ekgp2frekvensTTh:BUFFER-FIELD("P3LOPNR"):BUFFER-VALUE
      FREKVENSKATALOG.ANTAL = ekgp2frekvensTTh:BUFFER-FIELD("ANTAL"):BUFFER-VALUE 
      FREKVENSKATALOG.BENAMNING = ekgp2frekvensTTh:BUFFER-FIELD("P3BENAMNING"):BUFFER-VALUE.         
      dynqueh:GET-NEXT(NO-LOCK).        
   END.
   dynqueh:QUERY-CLOSE().
   RELEASE FREKVENSKATALOG NO-ERROR.*/
   
END PROCEDURE. 

PROCEDURE anmark_UI :
   /*Anders Olsson Elpool i Umeå AB  14 nov 2014 15:45:16 
   görs vid export 
   */
   /*
   DEFINE VARIABLE loprid AS ROWID NO-UNDO.
   
   FOR EACH Ebr-Data_lop WHERE Ebr-Data_lop.Lopnummer = "0" OR Ebr-Data_lop.work_construction = "" NO-LOCK:
      CREATE Ebr-Data_lopanm.
      BUFFER-COPY Ebr-Data_lop TO Ebr-Data_lopanm.
      DELETE Ebr-Data_lop.
   END.
   
   FOR EACH Ebr-Data_lop NO-LOCK:
      loprid = ?.
      FIND FIRST Ebr-Data_lopanm WHERE Ebr-Data_lopanm.code = Ebr-Data_lop.code AND Ebr-Data_lopanm.number <= Ebr-Data_lop.Lopnummer NO-LOCK NO-ERROR.
      REPEAT: 
         IF AVAILABLE Ebr-Data_lopanm THEN loprid = ROWID(Ebr-Data_lopanm).
         ELSE LEAVE.
         FIND NEXT Ebr-Data_lopanm WHERE Ebr-Data_lopanm.code = Ebr-Data_lop.code AND Ebr-Data_lopanm.number <= Ebr-Data_lop.Lopnummer NO-LOCK NO-ERROR.
      END.   
      IF loprid NE ? THEN DO:
         FIND Ebr-Data_lopanm WHERE ROWID(Ebr-Data_lopanm) = loprid NO-LOCK NO-ERROR.
         Ebr-Data_lop.comments = TRIM(Ebr-Data_lopanm.comments) + " " + TRIM(Ebr-Data_lop.comments).
      END.
   END. 
   */
END PROCEDURE.
    

PROCEDURE katskap_UI:
   FIND FIRST Ebr-Data_Katalog.
   

   FIND LAST KALKYLKATALOG USE-INDEX KLOGID NO-LOCK NO-ERROR.
   IF AVAILABLE KALKYLKATALOG THEN DO:
      klogvar = KALKYLKATALOG.KLOGID + 1.
   END.
   ELSE  klogvar = 1.
   
   IF AVAILABLE Ebr-Data_Katalog THEN DO:
      IF Ebr-Data_Katalog.type = 1 THEN DO:
         DO TRANSACTION :
            FIND FIRST KALKYLKATALOG WHERE KALKYLKATALOG.BENAMNING = "EBR " + Ebr-Data_Katalog.year EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE KALKYLKATALOG THEN DO:
               CREATE KALKYLKATALOG.
               ASSIGN
               KALKYLKATALOG.KLOGID = klogvar
               KALKYLKATALOG.BENAMNING = "EBR " + Ebr-Data_Katalog.year 
               KALKYLKATALOG.INDATUM = TODAY
               KALKYLKATALOG.VISARTAL  = INTEGER(Ebr-Data_Katalog.year).
            END.            
            RUN katskapsub_UI (INPUT "EBR KLG1 " + Ebr-Data_Katalog.year ).
            IF AVAILABLE KALKYLKATALOGSUB THEN DO:
               KALKYLKATALOG.HKLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID.
            END.   
         END.
      END.
      ELSE DO:
         DO TRANSACTION :
            FIND FIRST  KALKYLKATALOG WHERE KALKYLKATALOG.BENAMNING = "EBR " + Ebr-Data_Katalog.year EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE KALKYLKATALOG THEN DO:            
               CREATE KALKYLKATALOG.
               ASSIGN
               KALKYLKATALOG.KLOGID = klogvar
               KALKYLKATALOG.BENAMNING = "EBR " + Ebr-Data_Katalog.year 
               KALKYLKATALOG.INDATUM = TODAY
               KALKYLKATALOG.VISARTAL  = integer(Ebr-Data_Katalog.year).
            END.   
            RUN katskapsub_UI (INPUT "EBR KLG2 " + Ebr-Data_Katalog.year ).
            IF AVAILABLE KALKYLKATALOGSUB THEN DO:
               IF KALKYLKATALOG.HKLOGSUBID = 0 THEN KALKYLKATALOG.HKLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID.
            END.   
            
         END.              
     END.         
   END.
   FIND CURRENT KALKYLKATALOGSUB  NO-LOCK NO-ERROR.
   IF AVAILABLE KALKYLKATALOGSUB THEN DO:      
      RUN valtartimpriser_UI.
      RUN kvisskap_UI (INPUT 1,INPUT "Beredare",INPUT  "Arbete",INPUT FALSE,INPUT 1,INPUT 1). 
      RUN kvisskap_UI (INPUT 2,INPUT "Montör",INPUT  "Arbete",INPUT TRUE,INPUT 2,INPUT 1).
      RUN kvisskap_UI (INPUT 3,INPUT "Maskin",INPUT  "Maskin",INPUT TRUE,INPUT 3,INPUT 3).
      RUN kvisskap_UI (INPUT 4,INPUT "",INPUT  "Övrigt",INPUT FALSE,INPUT 1,INPUT 4).
      RUN kvisskap_UI (INPUT 5,INPUT "",INPUT  "Materiel",INPUT FALSE,INPUT 1,INPUT 2).
      RUN kvisskap_UI (INPUT 6,INPUT "Utrustning",INPUT  "Utrustning",INPUT TRUE,INPUT 1,INPUT 5).
      RUN kvisskap_UI (INPUT 7,INPUT "",INPUT  "Övrigt",INPUT TRUE,INPUT 1,INPUT 4).   
      FIND CURRENT KALKYLKATALOGSUB  NO-LOCK NO-ERROR.  
      IF Ebr-Data_Katalog.type = 1 THEN DO:
         /*KLG1*/      
         RUN kalkylpristab_UI (INPUT 0, INPUT "RÖRLIGKOSTNAD EA",INPUT "RÖRLIGKOSTNAD EA",INPUT rorlig,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 4, INPUT "ÖVRIGKOSTNAD",INPUT "ÖVRIGKOSTNAD",INPUT 0,INPUT FALSE,INPUT TRUE).
         RUN kalkylpristab_UI (INPUT 4, INPUT "ENTREP",INPUT "ENTREPNÖR",INPUT 0,INPUT FALSE,INPUT TRUE).
         RUN kalkylpristab_UI (INPUT 5, INPUT "MATERIEL",INPUT "MATERIEL",INPUT 0,INPUT FALSE,INPUT TRUE).
         /*RUN kalkylpristab_UI (INPUT 6, INPUT "UTRUSTNING",INPUT "UTRUSTNING",INPUT 0,INPUT FALSE,INPUT TRUE). /*???*/*/
         RUN kalkylpristab_UI (INPUT 7, INPUT "ÖVRIGKOSTNADEA",INPUT "ÖVRIGKOSTNAD MED EA",INPUT 0,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 1, INPUT "BEREDARE",INPUT "BEREDARE",INPUT ebrber,INPUT TRUE,INPUT TRUE).       
         /*RUN kalkylpristab_UI (INPUT 1, INPUT "BEREDARE REGION",INPUT "BEREDARE REGION",INPUT ebrbervit,INPUT TRUE,INPUT TRUE).*/            
         RUN kalkylpristab_UI (INPUT 2, INPUT "MONTÖR",INPUT "MONTÖR",INPUT ebrmont,INPUT TRUE,INPUT TRUE).
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN1",INPUT "LEDNB.MASK",INPUT ebrmask1,INPUT TRUE,INPUT TRUE).
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN2",INPUT "KAB SCH MASK",INPUT ebrmask2,INPUT TRUE,INPUT TRUE).      
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN3",INPUT "RUNT.OM.MASK",INPUT ebrmask3,INPUT TRUE,INPUT TRUE).                       
      END.
      ELSE DO:
         /*klg2*/
         RUN kalkylpristab_UI (INPUT 0, INPUT "RÖRLIGKOSTNAD EA",INPUT "RÖRLIGKOSTNAD EA",INPUT rorlig,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 4, INPUT "ÖVRIGKOSTNAD",INPUT "ÖVRIGKOSTNAD",INPUT 0,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 4, INPUT "ENTREP",INPUT "ENTREPNÖR",INPUT 0,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 5, INPUT "MATERIEL",INPUT "MATERIEL",INPUT 0,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 6, INPUT "UTRUSTNING",INPUT "UTRUSTNING",INPUT 0,INPUT FALSE,INPUT TRUE). /*???*/
         /*RUN kalkylpristab_UI (INPUT 7, INPUT "ÖVRIGKOSTNADEA",INPUT "ÖVRIGKOSTNAD MED EA",INPUT 0,INPUT FALSE,INPUT FALSE).*/
         /*RUN kalkylpristab_UI (INPUT 1, INPUT "BEREDARE",INPUT "BEREDARE",INPUT ebrmont,INPUT TRUE,INPUT TRUE).*/       
         RUN kalkylpristab_UI (INPUT 1, INPUT "BEREDARE REGION",INPUT "BEREDARE REGION",INPUT ebrbervit,INPUT TRUE,INPUT TRUE).            
         RUN kalkylpristab_UI (INPUT 2, INPUT "MONTÖR",INPUT "MONTÖR",INPUT ebrmont,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN1",INPUT "LEDNB.MASK",INPUT ebrmask1vit,INPUT FALSE,INPUT FALSE).
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN2",INPUT "KAB SCH MASK",INPUT ebrmask2,INPUT FALSE,INPUT FALSE).      
         RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN3",INPUT "RUNT.OM.MASK",INPUT ebrmask3,INPUT FALSE,INPUT FALSE).
      END.   
   END.
   RELEASE KALKYLKATALOG NO-ERROR.      
END PROCEDURE.

PROCEDURE katskapextra_UI:
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   /*/*OBS avrundat värde*/
   ebrmont  = 704.*/
   FIND FIRST KALKYLKATALOGSUBbuff2 WHERE KALKYLKATALOGSUBbuff2.KLOGSUBID = klogsubidvar NO-LOCK NO-ERROR.
   DO TRANSACTION:
      IF NOT AVAILABLE KALKYLKATALOGSUBbuff2 THEN DO:      
         CREATE KALKYLKATALOGSUB.
         RUN sistasubid_UI (OUTPUT KALKYLKATALOGSUB.KLOGSUBID).
         ASSIGN
         KALKYLKATALOGSUB.KLOGID = ?
         KALKYLKATALOGSUB.BENAMNING = "Extra koder"
         KALKYLKATALOGSUB.INDATUM = TODAY.
      END.
      ELSE DO:      
         CREATE KALKYLKATALOGSUB.
         RUN sistasubid_UI (OUTPUT KALKYLKATALOGSUB.KLOGSUBID).
         ASSIGN
         KALKYLKATALOGSUB.KLOGID = KALKYLKATALOGSUBbuff2.KLOGID
         KALKYLKATALOGSUB.BENAMNING = "Extra koder"
         KALKYLKATALOGSUB.INDATUM = TODAY.                
      END.
   END.
   FIND CURRENT KALKYLKATALOGSUB  NO-LOCK NO-ERROR.
   IF AVAILABLE KALKYLKATALOGSUB THEN DO: 
      RUN kvisskap_UI (INPUT 1,INPUT "Beredare",INPUT  "Arbete",INPUT FALSE,INPUT 1,INPUT 1). 
      RUN kvisskap_UI (INPUT 2,INPUT "Montör",INPUT  "Arbete",INPUT TRUE,INPUT 2,INPUT 1).
      RUN kvisskap_UI (INPUT 3,INPUT "Maskin",INPUT  "Maskin",INPUT TRUE,INPUT 3,INPUT 3).
      RUN kvisskap_UI (INPUT 4,INPUT "",INPUT  "Övrigt",INPUT FALSE,INPUT 1,INPUT 4).
      RUN kvisskap_UI (INPUT 5,INPUT "",INPUT  "Materiel",INPUT FALSE,INPUT 1,INPUT 2).
      RUN kvisskap_UI (INPUT 6,INPUT "Utrustning",INPUT  "Utrustning",INPUT TRUE,INPUT 1,INPUT 5).
      RUN kvisskap_UI (INPUT 7,INPUT "",INPUT  "Övrigt",INPUT TRUE,INPUT 1,INPUT 4).   
        
      FIND CURRENT KALKYLKATALOGSUB  NO-LOCK NO-ERROR.        
      /*KLG1*/      
      RUN kalkylpristab_UI (INPUT 0, INPUT "RÖRLIGKOSTNAD EA",INPUT "RÖRLIGKOSTNAD EA",INPUT rorlig,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 4, INPUT "ÖVRIGKOSTNAD",INPUT "ÖVRIGKOSTNAD",INPUT 0,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 4, INPUT "ENTREP",INPUT "ENTREPNÖR",INPUT 0,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 5, INPUT "MATERIEL",INPUT "MATERIEL",INPUT 0,INPUT FALSE,INPUT FALSE).         
      RUN kalkylpristab_UI (INPUT 7, INPUT "ÖVRIGKOSTNADEA",INPUT "ÖVRIGKOSTNAD MED EA",INPUT 0,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 1, INPUT "BEREDARE",INPUT "BEREDARE",INPUT ebrber,INPUT FALSE,INPUT FALSE).                           
      RUN kalkylpristab_UI (INPUT 2, INPUT "MONTÖR",INPUT "MONTÖR",INPUT ebrmont,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN1",INPUT "LEDNB.MASK",INPUT ebrmask1,INPUT FALSE,INPUT FALSE).
      RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN2",INPUT "KAB SCH MASK",INPUT ebrmask2,INPUT FALSE,INPUT FALSE).      
      RUN kalkylpristab_UI (INPUT 3, INPUT "MASKIN3",INPUT "RUNT.OM.MASK",INPUT ebrmask3,INPUT FALSE,INPUT FALSE).                                
   END.      
END PROCEDURE.


/*PRISER PER SUBKATALOG*/
PROCEDURE kalkylpristab_UI :
   DEFINE INPUT  PARAMETER vid AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER sokbvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER bvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER prisvar AS DECIMAL NO-UNDO.
   DEFINE INPUT  PARAMETER egetp AS LOGICAL NO-UNDO.
   DEFINE INPUT  PARAMETER egenk AS LOGICAL NO-UNDO.
   DO TRANSACTION:
      CREATE KALKYLPRISER.
      RUN sistaprisid_UI (OUTPUT KALKYLPRISER.KPID).
      ASSIGN
      KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID
      KALKYLPRISER.KVID = vid
      KALKYLPRISER.SOKBENAMNING = sokbvar
      KALKYLPRISER.BENAMNING = bvar
      KALKYLPRISER.PRIS = prisvar.
      IF KALKYLKATALOGSUB.BENAMNING BEGINS "EBR" THEN  DO:
         KALKYLPRISER.EGENPRISUPP = egetp.
         KALKYLPRISER.EGENKODUPP  = egenk.
      END.   
      ELSE DO:
         KALKYLPRISER.EGENPRISUPP = FALSE.
         KALKYLPRISER.EGENKODUPP  = FALSE.
      END.   
   END.
   RELEASE KALKYLPRISER NO-ERROR.
END PROCEDURE. 
/*MED VID VISNING*/
PROCEDURE kvisskap_UI :
   DEFINE INPUT  PARAMETER vid AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER timtypvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER kostypvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER eavar AS LOGICAL NO-UNDO.
   DEFINE INPUT  PARAMETER otmar AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER okost AS INTEGER NO-UNDO.
   FIND FIRST KALKVISNING WHERE KALKVISNING.KVID = vid NO-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKVISNING THEN DO TRANSACTION:
      CREATE KALKVISNING.
      ASSIGN
      KALKVISNING.KVID = vid 
      KALKVISNING.TIMTYP = timtypvar
      KALKVISNING.KOSTTYP = kostypvar
      KALKVISNING.EABER = eavar
      KALKVISNING.ORDNINGTIMMAR = otmar
      KALKVISNING.ORDNINGKOSTNAD = okost.
   END.
   FIND CURRENT KALKVISNING NO-LOCK NO-ERROR.
END PROCEDURE.

/*SISTA NUMMRET*/
PROCEDURE sistaprisid_UI :
   DEFINE OUTPUT PARAMETER hjraknare AS INTEGER NO-UNDO.
   FIND LAST KALKYLPRISERbuff WHERE KALKYLPRISERbuff.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID USE-INDEX KPID NO-LOCK NO-ERROR.
   IF AVAILABLE KALKYLPRISERbuff THEN DO:
      hjraknare = KALKYLPRISERbuff.KPID + 1.
   END.
   ELSE hjraknare = hjraknare + 1.
END PROCEDURE.  

/*SKAPAR SUBKATALOG*/
PROCEDURE katskapsub_UI :
   DEFINE INPUT  PARAMETER katnamnvar AS CHARACTER NO-UNDO.
   
   FIND FIRST KALKYLKATALOGSUBbuff WHERE KALKYLKATALOGSUBbuff.BENAMNING = katnamnvar NO-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKYLKATALOGSUBbuff THEN DO:
      CREATE KALKYLKATALOGSUB.
      RUN sistasubid_UI (OUTPUT KALKYLKATALOGSUB.KLOGSUBID).
      ASSIGN
      KALKYLKATALOGSUB.KLOGID = KALKYLKATALOG.KLOGID
      KALKYLKATALOGSUB.BENAMNING = katnamnvar
      KALKYLKATALOGSUB.INDATUM = TODAY.
   END.
   ELSE DO:
      IF KALKYLKATALOGSUBbuff.KLOGID = ? THEN KALKYLKATALOGSUBbuff.KLOGSUBID = KALKYLKATALOG.KLOGID.
      ELSE DO:
         FIND FIRST KALKYLKATALOGSUBbuff WHERE KALKYLKATALOGSUBbuff.BENAMNING = katnamnvar AND KALKYLKATALOGSUBbuff.KLOGID = KALKYLKATALOG.KLOGID NO-LOCK NO-ERROR.
         IF NOT AVAILABLE KALKYLKATALOGSUBbuff THEN DO:
            CREATE KALKYLKATALOGSUB.
            RUN sistasubid_UI (OUTPUT KALKYLKATALOGSUB.KLOGSUBID).
             ASSIGN
            KALKYLKATALOGSUB.KLOGID = KALKYLKATALOG.KLOGID
            KALKYLKATALOGSUB.BENAMNING = katnamnvar
            KALKYLKATALOGSUB.INDATUM = TODAY.
         END.
      END.             
   END.
   
   /* innan ÄNDRAT LENA 20140918
   CREATE KALKYLKATALOGSUB.
   FIND FIRST KALKYLKATALOGSUBbuff WHERE KALKYLKATALOGSUBbuff.BENAMNING = katnamnvar NO-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKYLKATALOGSUBbuff THEN DO:
      RUN sistasubid_UI (OUTPUT KALKYLKATALOGSUB.KLOGSUBID).
   END.
   ELSE DO:
      KALKYLKATALOGSUB.KLOGSUBID = KALKYLKATALOGSUBbuff.KLOGSUBID.
   END.
   ASSIGN
   KALKYLKATALOGSUB.KLOGID = KALKYLKATALOG.KLOGID
   KALKYLKATALOGSUB.BENAMNING = katnamnvar
   KALKYLKATALOGSUB.INDATUM = TODAY.*/

END PROCEDURE.

/*SISTA SUBKATALOGEN*/                 
PROCEDURE sistasubid_UI :
   DEBUGGER:SET-BREAK().
   DEFINE OUTPUT PARAMETER hjraknare AS INTEGER NO-UNDO.
   FIND LAST KALKYLKATALOGSUBbuff USE-INDEX KLOGSUBID NO-LOCK NO-ERROR.
   IF AVAILABLE KALKYLKATALOGSUBbuff THEN DO:
      hjraknare = KALKYLKATALOGSUBbuff.KLOGSUBID + 1.
   END.
   ELSE hjraknare = hjraknare + 1.
END PROCEDURE.

PROCEDURE arbetskoder_UI :
   DEFINE VARIABLE vartyp AS INTEGER NO-UNDO.
   DEFINE VARIABLE hjarbkod AS CHARACTER NO-UNDO.
  
   FOR EACH Ebr-Data_PLevel  NO-LOCK:
      IF Ebr-Data_PLevel.Level = "p1" THEN vartyp = 1.
      IF Ebr-Data_PLevel.Level = "p2" THEN vartyp = 2.
      IF Ebr-Data_PLevel.Level = "p3" THEN vartyp = 3. 
      FOR EACH Ebr-Data_Arbetskod WHERE Ebr-Data_Arbetskod.Level = Ebr-Data_PLevel.Level:
         /*klg1*/
         IF Ebr-Data_Katalog.type = 1 THEN DO:
            hjarbkod = Ebr-Data_Arbetskod.ArbetsKod.
         END.
         ELSE DO:
            /*klg2*/
            IF Ebr-Data_PLevel.Level = "p1" THEN DO:
               hjarbkod = SUBSTRING(Ebr-Data_Arbetskod.ArbetsKod,1,1) + " " + SUBSTRING(Ebr-Data_Arbetskod.ArbetsKod,2,2).
               
            END.
            IF Ebr-Data_PLevel.Level = "p2" THEN DO:
               hjarbkod = " " + SUBSTRING(Ebr-Data_Arbetskod.ArbetsKod,1,2).
            END.
            IF Ebr-Data_PLevel.Level = "p3" THEN DO:
               /*510 även tillagd i KLG1 P2 20170403*/
               IF Ebr-Data_Arbetskod.ArbetsKod = "510" OR Ebr-Data_Arbetskod.ArbetsKod = "850" OR Ebr-Data_Arbetskod.ArbetsKod = "855" OR Ebr-Data_Arbetskod.ArbetsKod = "856" OR 
                  Ebr-Data_Arbetskod.ArbetsKod = "857" OR Ebr-Data_Arbetskod.ArbetsKod = "863" OR Ebr-Data_Arbetskod.ArbetsKod = "999"  THEN DO: 
                  hjarbkod = "R" +  Ebr-Data_Arbetskod.ArbetsKod.   
               END.
               ELSE DO:
                  hjarbkod = Ebr-Data_Arbetskod.ArbetsKod. 
               END.                                  
            END.   
         END.  
         FIND FIRST KALKYLARBKODER WHERE KALKYLARBKODER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID AND
         KALKYLARBKODER.ARBKOD = hjarbkod   NO-LOCK NO-ERROR.       
         IF NOT AVAILABLE KALKYLARBKODER THEN DO:
            DO TRANSACTION: 
               CREATE KALKYLARBKODER.
               ASSIGN 
               KALKYLARBKODER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID
               KALKYLARBKODER.TYPKALK = vartyp 
               KALKYLARBKODER.ARBKOD = hjarbkod.
               ASSIGN  
               KALKYLARBKODER.BENAMNING = Ebr-Data_Arbetskod.Arbete
               KALKYLARBKODER.KOMMENTAR = Ebr-Data_Arbetskod.Kommentar.
              
               /*klg2*/
               IF Ebr-Data_Katalog.type = 2 THEN DO:
                  KALKYLARBKODER.REGION = TRUE.
                  KALKYLARBKODER.MARKNING = "Region".
               END.               
            END.
         END.
         RUN lopkoder_UI (INPUT hjarbkod, INPUT vartyp).    
      END.
   END.
   RELEASE KALKYLARBKODER NO-ERROR.
END PROCEDURE.

PROCEDURE arbetskoderextra_UI :
       
   FOR EACH KaladmimportTT:
      IF KaladmimportTT.LOPNR = 0 THEN DO:
         /*klg1*/                  
         FIND FIRST KALKYLARBKODER WHERE KALKYLARBKODER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID AND
         KALKYLARBKODER.ARBKOD = KaladmimportTT.ARBKOD  NO-LOCK NO-ERROR.       
         IF NOT AVAILABLE KALKYLARBKODER THEN DO:
            DO TRANSACTION: 
               CREATE KALKYLARBKODER.
               ASSIGN 
               KALKYLARBKODER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID
               KALKYLARBKODER.TYPKALK = 2 
               KALKYLARBKODER.ARBKOD = KaladmimportTT.ARBKOD.                                   
               KALKYLARBKODER.BENAMNING = KaladmimportTT.BENAMNING.
               KALKYLARBKODER.KOMMENTAR = KaladmimportTT.KOMM.                                             
            END.
         END.
      END.
      ELSE RUN lopkoderextra_UI .    
   END.   
   RELEASE KALKYLARBKODER NO-ERROR.
END PROCEDURE.

PROCEDURE lopkoder_UI:
   DEFINE INPUT  PARAMETER hjarbkod AS CHARACTER NO-UNDO. 
   DEFINE INPUT  PARAMETER vartyp AS INTEGER NO-UNDO.
   FOR EACH Ebr-Data_lop WHERE Ebr-Data_lop.ArbetsKod = Ebr-Data_Arbetskod.ArbetsKod NO-LOCK:
      FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLLOPPOSTER.ARBKOD =  hjarbkod AND KALKYLLOPPOSTER.LOPNR = INTEGER(Ebr-Data_lop.Lopnummer)       
      NO-LOCK NO-ERROR.                         
      IF NOT AVAILABLE KALKYLLOPPOSTER THEN DO:         
         DO TRANSACTION:
            CREATE KALKYLLOPPOSTER.
            ASSIGN 
            KALKYLLOPPOSTER.MARKNING = KALKYLARBKODER.MARKNING
            KALKYLLOPPOSTER.TYPKALK = vartyp
            KALKYLLOPPOSTER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID
            KALKYLLOPPOSTER.ARBKOD = hjarbkod
            KALKYLLOPPOSTER.LOPNR = INTEGER(Ebr-Data_lop.Lopnummer)
            KALKYLLOPPOSTER.BENAMNING = Ebr-Data_lop.Arbete
            KALKYLLOPPOSTER.KOMMENTAR = Ebr-Data_lop.Kommentar
            KALKYLLOPPOSTER.ENHET = Ebr-Data_lop.Enhet
            KALKYLLOPPOSTER.EAMANGD = Ebr-Data_lop.Ea_Tid.     
         END.                  
         IF Ebr-Data_Katalog.type = 2 THEN DO:
            FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
            KALKYLPRISER.SOKBENAMNING = "BEREDARE REGION" NO-LOCK NO-ERROR.
         END.    
         ELSE DO:
            FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
            KALKYLPRISER.SOKBENAMNING = "BEREDARE" NO-LOCK NO-ERROR.
         END.
                       
         /*beredare*/
         DO TRANSACTION:
            RUN katlopsub_UI (INPUT Ebr-Data_lop.Bered_Tid, INPUT 0).
         END.            
         /*montör*/
         FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
         KALKYLPRISER.SOKBENAMNING = "MONTÖR" NO-LOCK NO-ERROR.
         DO TRANSACTION:
            RUN katlopsub_UI (INPUT Ebr-Data_lop.Mont_Tid, INPUT 0).
         END. 
         
         IF Ebr-Data_lop.Maskin_Tid NE 0 THEN DO:
            
            IF vartyp = 3 THEN DO:  
               DEBUGGER:SET-BREAK().          
               /*P3 HAR INGA KOSTNADER UTSKRIVNA MÅSTE RÄKNAS FRAM MED RÖRL EA OCH TIMMAR*/
               RUN maskklgP3_UI (INPUT Ebr-Data_lop.Maskin_Tid, INPUT Ebr-Data_lop.Ea_Tid, INPUT Ebr-Data_lop.Mont_Tid, OUTPUT mskpris ).
               /*så att det ska gå ett räkna fram utrustningskost*/
               Ebr-Data_lop.Maskin_Kost = mskpris * Ebr-Data_lop.Maskin_Tid.
               
            END.
            ELSE DO:   
               DO TRANSACTION:
                  RUN maskklg_UI (INPUT Ebr-Data_lop.Maskin_Tid, INPUT Ebr-Data_lop.Maskin_Kost).
               END.
            END.
         END.                  
         /*MATERIEL*/
         FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
         KALKYLPRISER.SOKBENAMNING = "MATERIEL" NO-LOCK NO-ERROR.
         DO TRANSACTION:
            RUN katlopsub_UI (INPUT 0, INPUT Ebr-Data_lop.Material_Kost).
         END.                   
         /*UTRUSTNING*/         
         IF Ebr-Data_Katalog.type = 2 THEN DO:
            IF Ebr-Data_lop.Utrust_Tid NE 0 THEN DO:
               FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
               KALKYLPRISER.SOKBENAMNING = "UTRUSTNING" NO-LOCK NO-ERROR.
               IF vartyp = 3 THEN DO:
                  /*P3 HAR INGA KOSTNADER UTSKRIVNA MÅSTE RÄKNAS FRAM MED RÖRL EA OCH TIMMAR*/
                  DO TRANSACTION:    
                                             
                     RUN katlopsub_UI (INPUT Ebr-Data_lop.Utrust_Tid, INPUT (Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig))) * rorlig).
                  END.
                                      
               END.
               ELSE DO:
                  DO TRANSACTION:               
                     RUN katlopsub_UI (INPUT Ebr-Data_lop.Utrust_Tid, INPUT Ebr-Data_lop.Utrust_Kost).
                  END.
               END.
            END.      
            /*ÖVRIGKOSTNAD*/
            FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
            KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNAD" NO-LOCK NO-ERROR.
            DO TRANSACTION:
               RUN katlopsub_UI (INPUT 0, INPUT Ebr-Data_lop.Ovrigt_Kost).
            END.            
         END.
         ELSE DO:            
            IF vartyp = 3 THEN DO:
               /*P3 HAR INGA KOSTNADER UTSKRIVNA MÅSTE RÄKNAS FRAM MED RÖRL EA OCH TIMMAR*/                                    
               IF Ebr-Data_lop.Maskin_Tid = 0 THEN DO:
                  /* om maskintiden är 0 lägg som övrig kostnad ea, annars inkludera i maskkost*/
                  IF ROUND(Ebr-Data_lop.Mont_Tid ,2) NE ROUND(Ebr-Data_lop.Ea_Tid,2) THEN DO:
                     FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
                     KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNADEA" NO-LOCK NO-ERROR.                                 
                     DO TRANSACTION:                                         
                        RUN katlopsub_UI (INPUT 0, INPUT INTEGER((Ebr-Data_lop.Ea_Tid - Ebr-Data_lop.Mont_Tid) * rorlig)).
                     END.                                                                                                         
                  END.
               END.                                                                
           END.   
           ELSE DO:           
              IF ROUND(Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig),2) NE ROUND(Ebr-Data_lop.Ea_Tid,2) THEN DO:
                  FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
                  KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNADEA" NO-LOCK NO-ERROR.            
                  IF Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig)) > 0.3 OR Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig)) < -0.3 THEN DO:
                     DO TRANSACTION:                                         
                        RUN katlopsub_UI (INPUT 0, INPUT INTEGER((Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig))) * rorlig)).
                     END.
                     IF INTEGER(Ebr-Data_lop.Ovrigt_Kost) > INTEGER((Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig))) * rorlig) THEN DO:
                        /*ÖVRIGKOSTNAD*/
                        FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
                        KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNAD" NO-LOCK NO-ERROR.
                        DO TRANSACTION:               
                           RUN katlopsub_UI (INPUT 0, INPUT (Ebr-Data_lop.Ovrigt_Kost - INTEGER((Ebr-Data_lop.Ea_Tid - (Ebr-Data_lop.Mont_Tid + (Ebr-Data_lop.Maskin_Kost / rorlig))) * rorlig))).
                        END.
                     END.                        
                  END.
                  ELSE DO:
                     /*ÖVRIGKOSTNAD*/
                     FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
                     KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNAD" NO-LOCK NO-ERROR.
                     DO TRANSACTION:               
                        RUN katlopsub_UI (INPUT 0, INPUT Ebr-Data_lop.Ovrigt_Kost).
                     END.                                 
                  END.                       
               END.
               ELSE DO:
                  /*ÖVRIGKOSTNAD*/
                  FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
                  KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNAD" NO-LOCK NO-ERROR.
                  DO TRANSACTION:                
                     RUN katlopsub_UI (INPUT 0, INPUT Ebr-Data_lop.Ovrigt_Kost).
                  END.   
                                 
               END.                  
            END.                                               
         END.
      END.   
   END.  
   
   RELEASE KALKYLLOPSUB NO-ERROR.
   RELEASE KALKYLLOPPOSTER NO-ERROR.   
END PROCEDURE.

PROCEDURE lopkoderextra_UI:
   
   FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID AND
   KALKYLLOPPOSTER.ARBKOD =  KaladmimportTT.ARBKOD AND KALKYLLOPPOSTER.LOPNR = KaladmimportTT.LOPNR  NO-LOCK NO-ERROR.                         
   IF NOT AVAILABLE KALKYLLOPPOSTER THEN DO:         
      DO TRANSACTION:
         CREATE KALKYLLOPPOSTER.
         ASSIGN 
         KALKYLLOPPOSTER.MARKNING = KALKYLARBKODER.MARKNING
         KALKYLLOPPOSTER.TYPKALK = 2
         KALKYLLOPPOSTER.KLOGSUBID =  KALKYLKATALOGSUB.KLOGSUBID
         KALKYLLOPPOSTER.ARBKOD = KaladmimportTT.ARBKOD
         KALKYLLOPPOSTER.LOPNR = KaladmimportTT.LOPNR
         KALKYLLOPPOSTER.BENAMNING = KaladmimportTT.BENAMNING
         KALKYLLOPPOSTER.KOMMENTAR = KaladmimportTT.KOMM
         KALKYLLOPPOSTER.ENHET = KaladmimportTT.ENHET
         KALKYLLOPPOSTER.EAMANGD = 0.     
      END.                           
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = "BEREDARE" NO-LOCK NO-ERROR.                       
      /*beredare*/
      DO TRANSACTION:
         RUN katlopsub_UI (INPUT KaladmimportTT.BANTAL, INPUT 0).
      END.            
      /*montör*/
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = "MONTÖR" NO-LOCK NO-ERROR.
      DO TRANSACTION:
         RUN katlopsub_UI (INPUT KaladmimportTT.MOANTAL, INPUT 0).
      END. 
      DO TRANSACTION:
         RUN maskklg_UI (INPUT KaladmimportTT.MAANTAL, INPUT KaladmimportTT.MASKKOST).
      END.         
      /*MATERIEL*/
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = "MATERIEL" NO-LOCK NO-ERROR.
      DO TRANSACTION:
         RUN katlopsub_UI (INPUT 0, INPUT KaladmimportTT.MATERIEL).
      END.            
      /*ÖVRIGKOSTNAD*/
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = "ÖVRIGKOSTNAD" NO-LOCK NO-ERROR.
      DO TRANSACTION:                
         RUN katlopsub_UI (INPUT 0, INPUT KaladmimportTT.OVRKOST).
      END.                                   
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.       
END PROCEDURE.

/*LÖPNUMMER*/
PROCEDURE katlopsub_UI :
   DEFINE INPUT  PARAMETER timvar AS DECIMAL NO-UNDO.
   DEFINE INPUT  PARAMETER kostvar AS DECIMAL NO-UNDO.
   IF AVAILABLE KALKYLPRISER THEN DO:
      CREATE KALKYLLOPSUB.
      ASSIGN
      KALKYLLOPSUB.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID
      KALKYLLOPSUB.ARBKOD = KALKYLLOPPOSTER.ARBKOD
      KALKYLLOPSUB.LOPNR = KALKYLLOPPOSTER.LOPNR
      KALKYLLOPSUB.KPID = KALKYLPRISER.KPID  
      KALKYLLOPSUB.TIMMAR = timvar
      KALKYLLOPSUB.KOSTNAD =  kostvar.
   END.  
      
END PROCEDURE.

PROCEDURE maskklg_UI :
   DEFINE INPUT  PARAMETER timmarvar AS DECIMAL NO-UNDO.
   DEFINE INPUT  PARAMETER kostvar AS DECIMAL NO-UNDO.
   DEFINE VARIABLE maskinvar AS CHARACTER NO-UNDO.
   DEFINE VARIABLE maskinnr AS INTEGER NO-UNDO.
   DEFINE VARIABLE utkost AS DECIMAL NO-UNDO.
   IF timmarvar = 0 OR kostvar = 0 THEN RETURN.    
   utkost =  ROUND(kostvar / timmarvar,0).
   FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KVID = 3 AND KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND KALKYLPRISER.PRIS = utkost
   NO-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKYLPRISER THEN DO:
      DEBUGGER:SET-BREAK().
      FIND LAST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND  KALKYLPRISER.KVID = 3 AND KALKYLPRISER.SOKBENAMNING BEGINS "MASKIN" 
      USE-INDEX KPID NO-LOCK NO-ERROR.
      maskinnr = INTEGER(SUBSTRING(KALKYLPRISER.SOKBENAMNING,7)) + 1.
      maskinvar = "MASKIN" + STRING(maskinnr).
      RUN kalkylpristab_UI (INPUT 3, INPUT maskinvar,INPUT maskinvar,INPUT utkost ,INPUT FALSE,INPUT FALSE).
      
      
      /*OUTPUT TO c:\LOP.txt append.
      PUT UNFORMATTED maskinvar KALKYLLOPPOSTER.KLOGSUBID " " KALKYLLOPPOSTER.ARBKOD " "
            KALKYLLOPPOSTER.LOPNR " "  KALKYLLOPPOSTER.BENAMNING " " utkost      
            SKIP.
      OUTPUT CLOSE.*/
            
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = maskinvar NO-LOCK NO-ERROR.   
   END.
     
      
   RUN katlopsub_UI (INPUT timmarvar, INPUT 0).  
   
END PROCEDURE.
PROCEDURE maskklgP3_UI :
   DEFINE INPUT  PARAMETER timmarvar AS DECIMAL NO-UNDO.
   DEFINE INPUT  PARAMETER eatimmarvar AS DECIMAL NO-UNDO.
   DEFINE INPUT  PARAMETER monttimmarvar AS DECIMAL NO-UNDO.
   DEFINE OUTPUT  PARAMETER mskpris AS DECIMAL NO-UNDO.
   
   /*DEFINE INPUT  PARAMETER kostvar AS DECIMAL NO-UNDO.*/
   DEFINE VARIABLE maskinvar AS CHARACTER NO-UNDO.
   DEFINE VARIABLE maskinnr AS INTEGER NO-UNDO.
      
   mskpris = ROUND(((eatimmarvar - monttimmarvar) * rorlig) / timmarvar,0).      
   IF timmarvar = 0 OR mskpris = 0 THEN RETURN.     
   FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KVID = 3 AND KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND KALKYLPRISER.PRIS = mskpris  NO-LOCK NO-ERROR.
   IF NOT AVAILABLE KALKYLPRISER THEN DO:
      DEBUGGER:SET-BREAK().
      FIND LAST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND  KALKYLPRISER.KVID = 3 AND KALKYLPRISER.SOKBENAMNING BEGINS "MASKIN" 
      USE-INDEX KPID NO-LOCK NO-ERROR.
      maskinnr = INTEGER(SUBSTRING(KALKYLPRISER.SOKBENAMNING,7)) + 1.
      maskinvar = "MASKIN" + STRING(maskinnr).
      RUN kalkylpristab_UI (INPUT 3, INPUT maskinvar,INPUT maskinvar,INPUT mskpris ,INPUT FALSE,INPUT FALSE).
      /*OUTPUT TO c:\LOPP3.txt append.
      PUT UNFORMATTED maskinvar " " KALKYLLOPPOSTER.KLOGSUBID " " KALKYLLOPPOSTER.ARBKOD " "
            KALKYLLOPPOSTER.LOPNR " "  KALKYLLOPPOSTER.BENAMNING " "    mskpris " "  eatimmarvar " " monttimmarvar " " rorlig " " timmarvar  
            SKIP.
      OUTPUT CLOSE.*/
      FIND FIRST KALKYLPRISER WHERE KALKYLPRISER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND
      KALKYLPRISER.SOKBENAMNING = maskinvar NO-LOCK NO-ERROR.   
   END.
     
      
   RUN katlopsub_UI (INPUT timmarvar, INPUT 0).  
   
END PROCEDURE.

PROCEDURE startinxmlkat_UI :
   DEFINE INPUT  PARAMETER DATASET FOR Ebr-DataDS.
   RUN anmark_UI.
   RUN katskap_UI.
   IF AVAILABLE KALKYLKATALOGSUB THEN DO:
      RUN arbetskoder_UI.
   END.   
   RUN rensa_UI.
END PROCEDURE.

PROCEDURE startkomP2XML_UI:
   DEFINE INPUT  PARAMETER DATASET FOR Ebr-DataP2KomDS.
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.    
    /*OUTPUT TO C:\FF.TXT.    
    FOR EACH Ebr-Data_P2Kom  WHERE NO-LOCK:
       PUT Ebr-Data_P2Kom.P2ARBKOD " " Ebr-Data_P2Kom.P2LOPNR " " Ebr-Data_P2Kom.SVEPLOPNR " " Ebr-Data_P2Kom.ANMARKNING SKIP.
    END.    
    OUTPUT CLOSE.*/    
    EMPTY TEMP-TABLE Ebr-Data_P2KomGuru NO-ERROR. 
    FOR EACH Ebr-Data_P2Kom USE-INDEX P2ARBKOD NO-LOCK:
       FIND FIRST Ebr-Data_P2KomGuru WHERE Ebr-Data_P2KomGuru.P2ARBKOD = Ebr-Data_P2Kom.P2ARBKOD AND Ebr-Data_P2KomGuru.SVEPLOPNR = Ebr-Data_P2Kom.SVEPLOPNR NO-LOCK NO-ERROR.
       IF NOT AVAILABLE Ebr-Data_P2KomGuru THEN DO:
          CREATE Ebr-Data_P2KomGuru.
          ASSIGN 
          Ebr-Data_P2KomGuru.P2ARBKOD = Ebr-Data_P2Kom.P2ARBKOD 
          Ebr-Data_P2KomGuru.SVEPLOPNR = Ebr-Data_P2Kom.SVEPLOPNR.
          IF Ebr-Data_P2Kom.INGAREJ = "X" THEN Ebr-Data_P2KomGuru.INGAREJ = Ebr-Data_P2Kom.ANMARKNING.
          ELSE Ebr-Data_P2KomGuru.ANMARKNING =  Ebr-Data_P2Kom.ANMARKNING.
      END.
      ELSE DO:
         IF Ebr-Data_P2Kom.INGAREJ = "X" THEN Ebr-Data_P2KomGuru.INGAREJ = Ebr-Data_P2KomGuru.INGAREJ +  CHR(10) +  Ebr-Data_P2Kom.ANMARKNING.
         ELSE Ebr-Data_P2KomGuru.ANMARKNING = Ebr-Data_P2KomGuru.ANMARKNING + CHR(10) +  Ebr-Data_P2Kom.ANMARKNING.
      END.           
    END.
    /*blanka alla kommentarer först för alla p2 koder*/
    FOR EACH KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.TYPKALK = 2 EXCLUSIVE-LOCK:
       ASSIGN 
       KALKYLLOPPOSTER.KOMMENTAR = "".
    END.
    FOR EACH Ebr-Data_P2KomGuru :
       DO TRANSACTION:
          FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.ARBKOD = Ebr-Data_P2KomGuru.P2ARBKOD AND 
          KALKYLLOPPOSTER.LOPNR = INTEGER(Ebr-Data_P2KomGuru.SVEPLOPNR) EXCLUSIVE-LOCK NO-ERROR.
          IF AVAILABLE KALKYLLOPPOSTER THEN DO:
             KALKYLLOPPOSTER.KOMMENTAR = Ebr-Data_P2KomGuru.ANMARKNING.
             IF Ebr-Data_P2KomGuru.INGAREJ NE "" THEN DO:
                KALKYLLOPPOSTER.KOMMENTAR = Ebr-Data_P2KomGuru.ANMARKNING +  CHR(10) + CHR(10) + "Ingår ej:"   + CHR(10) + Ebr-Data_P2KomGuru.INGAREJ.
             END.   
         END.    
      END.    
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.
       
   RUN rensa_UI.
END PROCEDURE.

PROCEDURE startkomP2XMLK2_UI:
   DEFINE INPUT  PARAMETER DATASET FOR Ebr-DataP2KomDS.
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.  
   DEFINE VARIABLE hjarbkod AS CHARACTER NO-UNDO.  
    /*OUTPUT TO C:\FF.TXT.    
    FOR EACH Ebr-Data_P2Kom  WHERE NO-LOCK:
       PUT Ebr-Data_P2Kom.P2ARBKOD " " Ebr-Data_P2Kom.P2LOPNR " " Ebr-Data_P2Kom.SVEPLOPNR " " Ebr-Data_P2Kom.ANMARKNING SKIP.
    END.    
    OUTPUT CLOSE.*/    
    EMPTY TEMP-TABLE Ebr-Data_P2KomGuru NO-ERROR. 
    FOR EACH Ebr-Data_P2Kom USE-INDEX P2ARBKOD NO-LOCK:       
       FIND FIRST Ebr-Data_P2KomGuru WHERE Ebr-Data_P2KomGuru.P2ARBKOD = Ebr-Data_P2Kom.P2ARBKOD AND Ebr-Data_P2KomGuru.SVEPLOPNR = Ebr-Data_P2Kom.SVEPLOPNR NO-LOCK NO-ERROR.
       IF NOT AVAILABLE Ebr-Data_P2KomGuru THEN DO:
          CREATE Ebr-Data_P2KomGuru.
          ASSIGN 
          Ebr-Data_P2KomGuru.P2ARBKOD = Ebr-Data_P2Kom.P2ARBKOD 
          Ebr-Data_P2KomGuru.SVEPLOPNR = Ebr-Data_P2Kom.SVEPLOPNR.
          IF Ebr-Data_P2Kom.INGAREJ = "X" THEN Ebr-Data_P2KomGuru.INGAREJ = Ebr-Data_P2Kom.ANMARKNING.
          ELSE Ebr-Data_P2KomGuru.ANMARKNING =  Ebr-Data_P2Kom.ANMARKNING.
      END.
      ELSE DO:
         IF Ebr-Data_P2Kom.INGAREJ = "X" THEN Ebr-Data_P2KomGuru.INGAREJ = Ebr-Data_P2KomGuru.INGAREJ +  CHR(10) +  Ebr-Data_P2Kom.ANMARKNING.
         ELSE Ebr-Data_P2KomGuru.ANMARKNING = Ebr-Data_P2KomGuru.ANMARKNING + CHR(10) +  Ebr-Data_P2Kom.ANMARKNING.
      END.           
    END.
    
    /*blanka alla kommentarer först för alla p2 koder*/
    FOR EACH KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.TYPKALK = 2 EXCLUSIVE-LOCK:
       ASSIGN 
       KALKYLLOPPOSTER.KOMMENTAR = "".
    END.
    FOR EACH Ebr-Data_P2KomGuru :
       hjarbkod = " " + SUBSTRING(Ebr-Data_P2KomGuru.P2ARBKOD,1,2).
       DO TRANSACTION:
          FIND FIRST KALKYLLOPPOSTER WHERE KALKYLLOPPOSTER.KLOGSUBID = klogsubidvar AND KALKYLLOPPOSTER.ARBKOD = hjarbkod AND 
          KALKYLLOPPOSTER.LOPNR = INTEGER(Ebr-Data_P2KomGuru.SVEPLOPNR) EXCLUSIVE-LOCK NO-ERROR.
          IF AVAILABLE KALKYLLOPPOSTER THEN DO:
             KALKYLLOPPOSTER.KOMMENTAR = Ebr-Data_P2KomGuru.ANMARKNING.
             IF Ebr-Data_P2KomGuru.INGAREJ NE "" THEN DO:
                KALKYLLOPPOSTER.KOMMENTAR = Ebr-Data_P2KomGuru.ANMARKNING +  CHR(10) + CHR(10) + "Ingår ej:"   + CHR(10) + Ebr-Data_P2KomGuru.INGAREJ.
             END.   
         END.    
      END.    
   END.
   RELEASE KALKYLLOPPOSTER NO-ERROR.
       
   RUN rensa_UI.
END PROCEDURE.

PROCEDURE startkomP2_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR tidin.
   RUN komP2KLG1_UI (INPUT klogsubidvar,INPUT TABLE tidin). 
  /* RUN p2kom_UI (INPUT klogsubidvar).*/
END PROCEDURE.

PROCEDURE startkomP2K2_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR tidin.
   RUN komP2KLG2_UI  (INPUT klogsubidvar, INPUT TABLE tidin).
END PROCEDURE.
PROCEDURE startfrekP1P2_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER DATASET FOR Ebr-DataP1P2DS.
  /* DEFINE INPUT  PARAMETER Ebr-Data_P1P2Frekvensh AS HANDLE NO-UNDO.*/
   
   
   RUN frekvensP1P2_UI (INPUT klogsubidvar) .
  
   RUN rensa_UI.
END PROCEDURE.
PROCEDURE startfrekP2P3_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT  PARAMETER DATASET FOR Ebr-DataP2P3DS.
   /*
   DEFINE INPUT  PARAMETER Ebr-Data_P2P3Frekvensh AS HANDLE NO-UNDO.
   */
   
   RUN frekvensP2P3_UI (INPUT klogsubidvar).
   
   RUN rensa_UI.
END PROCEDURE.

PROCEDURE startdelkat_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR KaladmimportTT.
   DEFINE INPUT  PARAMETER svar1 AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER svar2 AS CHARACTER NO-UNDO.
     
   RUN delkata_UI (INPUT klogsubidvar,INPUT TABLE KaladmimportTT, INPUT svar1,input svar2). 
  
END PROCEDURE.

PROCEDURE delkata_UI :
   DEFINE INPUT  PARAMETER klogsubidvar AS INTEGER NO-UNDO.   
   DEFINE INPUT PARAMETER TABLE FOR KaladmimportTT.
   DEFINE INPUT  PARAMETER svar1 AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER svar2 AS CHARACTER NO-UNDO.   
    /*skicka med om det är årets timpriser eller fjolårets timpriser som skall användas*/
   IF svar1 = "Yes" THEN DO:
      RUN aretstimpriser_UI.
   END.
   ELSE RUN  fjolaretstimpriser_UI.     
   /*skicka med om timpriser skall vara avrundarde utan decimaler*/  
   IF svar2 = "Yes" THEN ebrmont  = ROUND(ebrmont,0). 
   
   RUN katskapextra_UI (INPUT klogsubidvar).
   IF AVAILABLE KALKYLKATALOGSUB THEN DO:
      
      RUN arbetskoderextra_UI.
   END.   
   RUN rensa_UI.
END PROCEDURE.
