/*schaktadminupplKLG.P*/

/*skapa schaktupplägg från ebr katalog*/
DEFINE VARIABLE rakn AS INTEGER NO-UNDO.
/*DEFINE INPUT PARAMETER globforetag LIKE FORETAG.FORETAG NO-UNDO.*/
DEFINE VARIABLE globforetag AS CHARACTER NO-UNDO.
DEFINE VARIABLE prognamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE prognamn2 AS CHARACTER NO-UNDO.
DEFINE VARIABLE ovar AS INTEGER NO-UNDO.
DEFINE VARIABLE idvar AS INTEGER NO-UNDO.
DEFINE VARIABLE finnskod AS LOGICAL NO-UNDO.
DEFINE BUFFER HDHANDELSEBUFF FOR HDHANDELSE.
    

FIND FIRST FORETAG  NO-LOCK NO-ERROR.
globforetag = FORETAG.FORETAG.

/*om hela KLG1 skall användas istället för schaktupplägg - kör först*/
/*FOR EACH FORLAGG:
   ASSIGN FORLAGG.BORT = TRUE.   
END.
FOR EACH HDHANDELSE:
/*   ASSIGN HDHANDELSE.BORT = TRUE.*/   
END.
FOR EACH YTBELAGG:
   ASSIGN YTBELAGG.BORT = TRUE.
END.
/*FOR EACH HDKKOPP:   
   DELETE HDKKOPP.
END.*/
*/
/*FOR EACH HDHANDELSEBUFF WHERE  SUBSTRING(HDHANDELSEBUFF.BENAMNING,6,1) = "G" EXCLUSIVE-LOCK:        
   FIND FIRST HDKKOPP WHERE  HDKKOPP.ID = HDHANDELSEBUFF.ID AND HDKKOPP.TYP = HDHANDELSEBUFF.SORTCHAR EXCLUSIVE-LOCK NO-ERROR.
   IF AVAILABLE HDKKOPP THEN DELETE HDKKOPP.
   DELETE HDHANDELSEBUFF.
END.      
   
FOR EACH FORLAGG WHERE  SUBSTRING(FORLAGG.FORLAGG,6,1) = "G" EXCLUSIVE-LOCK NO-ERROR.
   FIND FIRST HDKKOPP WHERE  HDKKOPP.ID = FORLAGG.ID AND HDKKOPP.TYP = "f"  EXCLUSIVE-LOCK NO-ERROR.         
   IF AVAILABLE HDKKOPP THEN DELETE HDKKOPP.            
   DELETE  FORLAGG.  
END.*/
 


FIND LAST HDHANDELSEBUFF USE-INDEX ID NO-LOCK NO-ERROR.
IF AVAILABLE HDHANDELSEBUFF THEN idvar = HDHANDELSEBUFF.ID.
idvar = idvar + 1.
FOR EACH  HDHANDELSEBUFF NO-LOCK BY HDHANDELSEBUFF.ORDNING :
   ovar =  HDHANDELSEBUFF.ORDNING.
END.
ovar = ovar + 1.
IF globforetag = "akea" THEN DO:
/*   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 9 NO-LOCK NO-ERROR.  /*2020 ebr*/
   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 8 NO-LOCK NO-ERROR.  /*2019 höganäs*/
   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 7 NO-LOCK NO-ERROR.  /*2019 landskrona*/
   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 6 NO-LOCK NO-ERROR.  /*2019 kraftringen*/
   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 5 NO-LOCK NO-ERROR.  /*2019 ats*/*/
   FIND FIRST  KALKYLKATALOG  WHERE KALKYLKATALOG.KLOGID = 4 NO-LOCK NO-ERROR.  /*2019 ebr*/
END.
ELSE DO:
   FIND LAST KALKYLKATALOG  WHERE NO-LOCK NO-ERROR.
END.      

FOR EACH KALKYLKATALOGSUB WHERE KALKYLKATALOGSUB.KLOGID = KALKYLKATALOG.KLOGID  NO-LOCK,
EACH KALKYLLOPPOSTER  WHERE KALKYLLOPPOSTER.KLOGSUBID = KALKYLKATALOGSUB.KLOGSUBID AND KALKYLLOPPOSTER.TYPKALK = 2 USE-INDEX LOPNR NO-LOCK:
   finnskod = FALSE.   
   IF LENGTH(KALKYLLOPPOSTER.ARBKOD) = 3 THEN DO:
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) LE 2 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,3) = KALKYLLOPPOSTER.ARBKOD AND SUBSTRING(HDHANDELSEBUFF.BENAMNING,4,2) = STRING(KALKYLLOPPOSTER.LOPNR,"99") AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) = 3 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,3) = KALKYLLOPPOSTER.ARBKOD AND SUBSTRING(HDHANDELSEBUFF.BENAMNING,4,3) = STRING(KALKYLLOPPOSTER.LOPNR,"999") AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.   
      
      IF finnskod = FALSE THEN DO TRANSACTION:                          
         CREATE HDHANDELSE.
         ASSIGN 
         HDHANDELSE.ID = idvar
         HDHANDELSE.ORDNING = ovar.
         IF KALKYLLOPPOSTER.ENHET = "ST" THEN HDHANDELSE.SORTCHAR = "PH".
         ELSE  HDHANDELSE.SORTCHAR = "FH".
         IF KALKYLLOPPOSTER.ENHET = "KM" THEN HDHANDELSE.ENHET = "m".
         ELSE HDHANDELSE.ENHET = KALKYLLOPPOSTER.ENHET.       
         IF KALKYLLOPPOSTER.LOPNR > 99 THEN DO:
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"999") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.
         ELSE DO:    
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"99") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.     
         HDHANDELSE.BORT = FALSE.
         idvar = idvar + 1.
         ovar = ovar + 1.
         
         CREATE HDKKOPP.
         ASSIGN
         HDKKOPP.ARBKOD = STRING(KALKYLLOPPOSTER.ARBKOD)
         HDKKOPP.LOPNR = KALKYLLOPPOSTER.LOPNR
         HDKKOPP.ID = HDHANDELSE.ID
         HDKKOPP.TYP = HDHANDELSE.SORTCHAR      
         HDKKOPP.KKID = 1
         HDKKOPP.ANTAL = 1.
      END.  
                           
   END.
   /*ELSE IF LENGTH(KALKYLLOPPOSTER.ARBKOD) = 4 THEN DO:
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) = 2 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,4) = KALKYLLOPPOSTER.ARBKOD AND INTEGER(SUBSTRING(HDHANDELSEBUFF.BENAMNING,5,2)) = KALKYLLOPPOSTER.LOPNR AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) = 3 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,4) = KALKYLLOPPOSTER.ARBKOD AND INTEGER(SUBSTRING(HDHANDELSEBUFF.BENAMNING,5,3)) = KALKYLLOPPOSTER.LOPNR AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.   
      
      IF finnskod = FALSE THEN DO TRANSACTION:                          
         CREATE HDHANDELSE.
         ASSIGN 
         HDHANDELSE.ID = idvar
         HDHANDELSE.ORDNING = ovar.
         IF KALKYLLOPPOSTER.ENHET = "ST" THEN HDHANDELSE.SORTCHAR = "PH".
         ELSE  HDHANDELSE.SORTCHAR = "FH".
         IF KALKYLLOPPOSTER.ENHET = "KM" THEN HDHANDELSE.ENHET = "m".
         ELSE HDHANDELSE.ENHET = KALKYLLOPPOSTER.ENHET.       
         IF KALKYLLOPPOSTER.LOPNR > 99 THEN DO:
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"999") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.
         ELSE DO:    
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"99") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.     
         HDHANDELSE.BORT = FALSE.
         idvar = idvar + 1.
         ovar = ovar + 1.
         
         CREATE HDKKOPP.
         ASSIGN
         HDKKOPP.ARBKOD = STRING(KALKYLLOPPOSTER.ARBKOD)
         HDKKOPP.LOPNR = KALKYLLOPPOSTER.LOPNR
         HDKKOPP.ID = HDHANDELSE.ID
         HDKKOPP.TYP = HDHANDELSE.SORTCHAR      
         HDKKOPP.KKID = 1
         HDKKOPP.ANTAL = 1.
      END.
      
           
   END.
   ELSE IF LENGTH(KALKYLLOPPOSTER.ARBKOD) = 5 THEN DO:
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) = 2 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,5) = KALKYLLOPPOSTER.ARBKOD AND INTEGER(SUBSTRING(HDHANDELSEBUFF.BENAMNING,6,2)) = KALKYLLOPPOSTER.LOPNR AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.
      IF LENGTH(KALKYLLOPPOSTER.LOPNR) = 3 THEN DO:
         FIND FIRST HDHANDELSEBUFF WHERE SUBSTRING(HDHANDELSEBUFF.BENAMNING,1,5) = KALKYLLOPPOSTER.ARBKOD AND INTEGER(SUBSTRING(HDHANDELSEBUFF.BENAMNING,6,3)) = KALKYLLOPPOSTER.LOPNR AND HDHANDELSEBUFF.bort = FALSE  NO-LOCK NO-ERROR.
         IF AVAILABLE HDHANDELSEBUFF THEN finnskod = TRUE.
      END.   
      
      IF finnskod = FALSE THEN DO TRANSACTION:                          
         CREATE HDHANDELSE.
         ASSIGN 
         HDHANDELSE.ID = idvar
         HDHANDELSE.ORDNING = ovar.
         IF KALKYLLOPPOSTER.ENHET = "ST" THEN HDHANDELSE.SORTCHAR = "PH".
         ELSE  HDHANDELSE.SORTCHAR = "FH".
         IF KALKYLLOPPOSTER.ENHET = "KM" THEN HDHANDELSE.ENHET = "m".
         ELSE HDHANDELSE.ENHET = KALKYLLOPPOSTER.ENHET.       
         IF KALKYLLOPPOSTER.LOPNR > 99 THEN DO:
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"999") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.
         ELSE DO:    
            HDHANDELSE.BENAMNING = KALKYLLOPPOSTER.ARBKOD + STRING(KALKYLLOPPOSTER.LOPNR,"99") + " " + KALKYLLOPPOSTER.BENAMNING.
         END.     
         HDHANDELSE.BORT = FALSE.
         idvar = idvar + 1.
         ovar = ovar + 1.
         
         CREATE HDKKOPP.
         ASSIGN
         HDKKOPP.ARBKOD = STRING(KALKYLLOPPOSTER.ARBKOD)
         HDKKOPP.LOPNR = KALKYLLOPPOSTER.LOPNR
         HDKKOPP.ID = HDHANDELSE.ID
         HDKKOPP.TYP = HDHANDELSE.SORTCHAR      
         HDKKOPP.KKID = 1
         HDKKOPP.ANTAL = 1.
      END.
      
           
   END.*/   
      
END.
   
    
   

