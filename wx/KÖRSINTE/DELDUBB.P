DEFINE BUFFER MTRLBUFF FOR MTRL.
OPEN QUERY DQ FOR EACH MTRL WHERE MTRL.LEVKOD = "1" AND MTRL.KALKNR = 0 NO-LOCK.
DO TRANSACTION:
   GET FIRST DQ NO-LOCK.
   FOR EACH MTRLBUFF WHERE MTRLBUFF.LEVKOD = MTRL.LEVKOD AND
   MTRLBUFF.KALKNR = 0 AND MTRLBUFF.ENR = MTRL.ENR AND
   RECID(MTRLBUFF) NE RECID(MTRL) EXCLUSIVE-LOCK:
      DELETE MTRLBUFF.
   END.
END.
REPEAT:
   DO TRANSACTION:
      GET NEXT DQ NO-LOCK.
      IF AVAILABLE MTRL THEN DO: 
         FOR EACH MTRLBUFF WHERE MTRLBUFF.LEVKOD = MTRL.LEVKOD AND
         MTRLBUFF.KALKNR = 0 AND MTRLBUFF.ENR = MTRL.ENR AND
         RECID(MTRLBUFF) NE RECID(MTRL) EXCLUSIVE-LOCK:
            DELETE MTRLBUFF.
         END.
      END.
      ELSE LEAVE.
   END.
END.   
