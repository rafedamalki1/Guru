    /*SUFRHOGIA7.P filformatet 214007 from 20170824 */
{LESAMMAN.I}
{STANSLONEDEF.I}  
DEFINE INPUT PARAMETER kordatum AS DATE NO-UNDO.
DEFINE INPUT PARAMETER koranv LIKE ANVANDARE.ANVANDARE NO-UNDO.
DEFINE INPUT PARAMETER gkorvar AS CHARACTER NO-UNDO.
DEFINE INPUT-OUTPUT PARAMETER TABLE FOR stanslonefil.
DEFINE OUTPUT PARAMETER TABLE FOR perskoll.
DEFINE OUTPUT PARAMETER TABLE FOR franvarotemp.
RUN sammut_UI (INPUT 1).
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{LONEDEF.I}
{BLOB.I}
DEFINE VARIABLE bloblog AS LOGICAL NO-UNDO.
DEFINE VARIABLE blobproch AS HANDLE NO-UNDO.
 
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE gvisatidpermanad AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE regstart LIKE TIDREGITAB.START NO-UNDO. 
DEFINE NEW SHARED VARIABLE regslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.        
DEFINE NEW SHARED VARIABLE regtotalt LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE NEW SHARED VARIABLE frustarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE fruslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffestart AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffeslut AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchstarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE korvar AS CHARACTER NO-UNDO.
DEFINE VARIABLE onr LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE onr2 LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE dnr LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE dnr2 LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE starttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE sluttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE antal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE antal2 LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE personal LIKE PERSONALTAB.PERSONALKOD NO-UNDO.
DEFINE VARIABLE panstnr AS CHARACTER NO-UNDO.
DEFINE VARIABLE pnr LIKE PERSONALTAB.PERSONNUMMER NO-UNDO.      /*LON*/
DEFINE VARIABLE pc LIKE FVARO.PROC NO-UNDO.
DEFINE VARIABLE fkod LIKE FVARO.FRKOD NO-UNDO.
DEFINE VARIABLE del1 LIKE FVARO.DEL NO-UNDO.
DEFINE VARIABLE regdatum2 AS DATE NO-UNDO.  
DEFINE VARIABLE regdat3 AS DATE NO-UNDO.
DEFINE VARIABLE regdat4 AS DATE NO-UNDO. 
DEFINE VARIABLE regdat5 AS DATE NO-UNDO.
DEFINE VARIABLE tott1 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE tott2 AS INTEGER NO-UNDO.
DEFINE VARIABLE tott3 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE proc1 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE proc2 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE seku AS INTEGER NO-UNDO.
DEFINE VARIABLE anst LIKE ANSTFORM.KOD NO-UNDO.
DEFINE VARIABLE krav AS INTEGER FORMAT "9" NO-UNDO.
DEFINE VARIABLE frstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE frslut LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE avdatum AS DATE NO-UNDO.
DEFINE VARIABLE komptid AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE kommentar AS CHARACTER NO-UNDO.
DEFINE VARIABLE arbdg AS INTEGER NO-UNDO.
DEFINE VARIABLE dagtot AS DECIMAL NO-UNDO.
DEFINE VARIABLE regdat1 AS DATE NO-UNDO.
DEFINE VARIABLE regdat2 AS DATE NO-UNDO.  
DEFINE VARIABLE prognamn AS CHARACTER FORMAT "X(41)" NO-UNDO.
DEFINE VARIABLE prognamn5 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn6 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn3 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE prognamn4 AS CHARACTER  NO-UNDO.
DEFINE VARIABLE kolldatum AS DATE NO-UNDO.
DEFINE VARIABLE lonfil AS CHARACTER NO-UNDO.
DEFINE VARIABLE anstperson AS CHARACTER NO-UNDO.
DEFINE VARIABLE overrapp1 AS CHARACTER FORMAT "X(250)" NO-UNDO.      /*LON*/
DEFINE VARIABLE overrapp2 AS CHARACTER FORMAT "X(250)" NO-UNDO.      /*LON*/
DEFINE VARIABLE omfatt AS DECIMAL NO-UNDO.
DEFINE VARIABLE frantim AS INTEGER NO-UNDO.
DEFINE VARIABLE startm AS LOGICAL NO-UNDO.
DEFINE VARIABLE slutm AS LOGICAL NO-UNDO.
DEFINE VARIABLE startdatum AS DATE NO-UNDO.
DEFINE VARIABLE slutdatum AS DATE NO-UNDO.
DEFINE VARIABLE stregtid AS DECIMAL NO-UNDO.
DEFINE VARIABLE stttid AS DECIMAL NO-UNDO.
DEFINE VARIABLE slregtid AS DECIMAL NO-UNDO.
DEFINE VARIABLE slttid AS DECIMAL NO-UNDO.
DEFINE VARIABLE koll1 AS LOGICAL NO-UNDO.

DEFINE VARIABLE fnamn AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn2 AS CHARACTER NO-UNDO.
DEFINE VARIABLE fnamn3 AS CHARACTER NO-UNDO.
DEFINE VARIABLE kommando AS CHARACTER NO-UNDO.
DEFINE VARIABLE kommando2 AS CHARACTER NO-UNDO.
DEFINE VARIABLE kommando3 AS CHARACTER NO-UNDO.
DEFINE VARIABLE radrakn AS INTEGER NO-UNDO.
DEFINE VARIABLE iColumn                 AS INTEGER INITIAL 0.
DEFINE VARIABLE cColumn                 AS CHARACTER.
DEFINE VARIABLE cRange                  AS CHARACTER.
DEFINE VARIABLE chExcelApplication      AS COM-HANDLE.
DEFINE VARIABLE chWorkbook              AS COM-HANDLE.
DEFINE VARIABLE chWorksheet             AS COM-HANDLE.
DEFINE VARIABLE chChart                 AS COM-HANDLE.
DEFINE VARIABLE chWorksheetRange        AS COM-HANDLE.
DEFINE VARIABLE felexcel AS LOGICAL NO-UNDO.
DEFINE VARIABLE tider AS CHARACTER NO-UNDO.
DEFINE VARIABLE traff AS LOGICAL NO-UNDO.

DEFINE STREAM frlule. 
DEFINE STREAM frlulekop. 
/*DEFINE STREAM stanslule. */
DEFINE BUFFER frbuff FOR TIDREGITAB.
DEFINE BUFFER tidbuff FOR TIDREGITAB.
DEFINE BUFFER  stlonbuff  FOR stanslonefil.
DEFINE BUFFER  stlonbuff2  FOR stanslonefil.
DEFINE TEMP-TABLE frvarotempsj NO-UNDO LIKE franvarotemp.
DEFINE TEMP-TABLE frfel
   FIELD PERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD TIMMAR AS DECIMAL FORMAT "99.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"
   INDEX FRANVARO IS PRIMARY  PERSONNUMMER FRAN LART ASCENDING. 

DEFINE BUFFER fbuff FOR  franvarotemp .
DEFINE BUFFER fbuff2 FOR  franvarotemp .
DEFINE BUFFER fbuff3 FOR  franvarotemp .

FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/
   RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.
END FUNCTION.
{AMERICANEUROPEAN.I}
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
ASSIGN
Guru.Konstanter:globforetag = FORETAG.FORETAG
vkdatum = kordatum
gvisatidpermanad = TRUE
korvar = gkorvar.

IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
   prognamn5 = "D:\DELAD\PRO10S\BACKEXPORT\lonelnat\".   
   prognamn6 = "D:\DELAD\PRO10S\EXPORT\lonelnat\lonfiler\".                 
END.

OPEN QUERY persq FOR EACH PERSONALTAB WHERE PERSONALTAB.PERSMASK = TRUE 
AND PERSONALTAB.BRAVO = TRUE USE-INDEX PERSONALKOD NO-LOCK.
GET FIRST persq NO-LOCK.
DO WHILE AVAILABLE(PERSONALTAB):
   persrec = RECID(PERSONALTAB).
   personal = PERSONALTAB.PERSONALKOD.
   pnr = PERSONALTAB.PERSONNUMMER.
   panstnr = PERSONALTAB.ANSTNR.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
   PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
   anst = ANSTFORMTAB.KOD.  
   OPEN QUERY tidq FOR EACH TIDREGITAB WHERE
   TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
   TIDREGITAB.GODKAND BEGINS "G" AND TIDREGITAB.VECKOKORD = korvar AND
   TIDREGITAB.DATUM <= vkdatum AND TIDREGITAB.TIDLOG = TRUE
   USE-INDEX PSTART NO-LOCK.          
   GET FIRST tidq NO-LOCK.         
   DO WHILE AVAILABLE(TIDREGITAB):         
      krav = 0.             
      FIND FIRST FRDEL WHERE FRDEL.PERSONALKOD = personal AND
      FRDEL.AONR = TIDREGITAB.AONR USE-INDEX FRDEL NO-LOCK NO-ERROR.
      IF AVAILABLE FRDEL THEN ASSIGN onr = FRDEL.AONR dnr = FRDEL.DELNR krav = 1.      
      FIND FIRST FVARO WHERE FVARO.AONR = TIDREGITAB.AONR
      AND FVARO.DELNR = TIDREGITAB.DELNR USE-INDEX FVARO NO-LOCK NO-ERROR.
      IF NOT AVAILABLE FVARO THEN krav = 1. 
      regdatum = TIDREGITAB.DATUM.
      regvnr = TIDREGITAB.VECKONUMMER.
      RUN SLUTARB.P.
      IF regstart = regslut THEN krav = 1.
      IF regstart NE regslut THEN DO:
         IF TIDREGITAB.START GE regslut AND TIDREGITAB.SLUT > regslut THEN krav = 1.
         IF TIDREGITAB.START < regstart AND TIDREGITAB.SLUT LE regstart THEN krav = 1.
      END.   
      IF TIDREGITAB.TOTALT = 0 THEN krav = 1.
      IF krav = 0 THEN DO:  
         ASSIGN
         /*rec = RECID(TIDREGITAB)*/
         onr2 = TIDREGITAB.AONR
         dnr2 = TIDREGITAB.DELNR
         kommentar = TIDREGITAB.RESMAL.
         FIND FIRST FVARO WHERE FVARO.AONR = onr2
         AND FVARO.DELNR = dnr2 USE-INDEX FVARO NO-LOCK NO-ERROR.
         IF AVAILABLE FVARO THEN DO TRANSACTION:	
            ASSIGN
            fkod = FVARO.FRKOD
	         pc = FVARO.PROC
	         del1 = FVARO.DEL   /* ti-timmar pr-procent he-heldag */
            frstart = TIDREGITAB.START
            frslut = TIDREGITAB.SLUT. 
            FIND LAST franvarotemp WHERE franvarotemp.PNR = pnr AND
	         franvarotemp.AONR = onr2 AND franvarotemp.DELNR = dnr2
	         USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE franvarotemp THEN DO:
               ASSIGN
	            regdatum = TIDREGITAB.DATUM
	            regvnr = TIDREGITAB.VECKONUMMER.
	            RUN SLUTARB.P.
	            nytid = regstart.
	            RUN TIMSEK.P.              /* raknar ut totala tiden */
               ASSIGN
	            starttiden = sekunder
	            nytid = regslut.
               RUN TIMSEK.P.
               ASSIGN
               sluttiden = sekunder
               regdatum = TIDREGITAB.DATUM
               regvnr = TIDREGITAB.VECKONUMMER.
     	         RUN NORDFTO.P.
     	         tott1 = nytid.
     	        RUN TIMSEK.P.
     	        tott2 = sekunder.
     	        IF regstart = regslut THEN ASSIGN proc1 = 000 antal = 0.      	        
	           ELSE IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
	           THEN DO:
	              nytid = TIDREGITAB.TOTALT.
	              RUN TIMSEK.P.
	              IF tott2 LE 0 THEN proc1 = 0.
	              ELSE  proc1 = 100 * sekunder / tott2.               
	              IF pc NE TRUE THEN  antal = TIDREGITAB.TOTALT.	              
	           END. 
              ELSE IF TIDREGITAB.AONR = "160" OR TIDREGITAB.AONR = "161" OR TIDREGITAB.AONR = "162"  OR TIDREGITAB.AONR = "170" OR TIDREGITAB.AONR = "300"   
              OR TIDREGITAB.AONR = "137" /*OR TIDREGITAB.AONR = "171"*/    THEN DO:                                  
                 /* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna
                 627 - REHAB GODKÄND AV AG 137 20190605                                                   
                 406- arbetstidsförkortning 160
                 406- arbetstidsförkortning 161 SVAB
                 860- kompledighet 170
                 861- 6 JUNI 162
                 693 - förtroendemannauppdrag 300 SEAB
                 - veckovila 171                                                   
                 franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
                 franvarotemp.TTID- TIMMAR DEL AV DAG
                 */
                 antal = TIDREGITAB.TOTALT.
              END.
              ELSE ASSIGN   proc1 = 100  antal = 0.                 	          
              /*Avrunda inte frånvaro*/ 
              ASSIGN
              antal2 =  klock100(antal)
              tott3 = klock100(tott1)                          
              proc2 = 100 * antal2 / tott3
              regdat3 = TIDREGITAB.DATUM
              regdat4 = TIDREGITAB.DATUM
              frstart = TIDREGITAB.START
              frslut = TIDREGITAB.SLUT. 
	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3  AND
	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
	              ASSIGN
	              regdat3 = TIDREGITAB.DATUM - 1 
                 regdat5 = regdat3
                 frstart = 00.00.
                 
                 /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                 regdatum = regdat3.
                 RUN REGVEC.P.
                 RUN SLUTARB.P.          
                 IF regstart = regslut THEN regdat3 = regdat3 - 1.                                                       
                 ELSE DO:
                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                    IF AVAILABLE OVERAVTAB THEN DO:
                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
                    END.
                 END.                                  
                 dat:
                 REPEAT:
                    IF regdat5 = regdat3 THEN LEAVE dat.
                    IF regdat5 > regdat3 THEN DO:    
                       regdat5 = regdat3.
                       /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                       regdatum = regdat3.
                       RUN REGVEC.P.
                       RUN SLUTARB.P.          
                       IF regstart = regslut THEN regdat3 = regdat3 - 1.                        
                       ELSE DO:
                          FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                          OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                          IF AVAILABLE OVERAVTAB THEN DO:
                             IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
                          END.
                       END.
                    END.
                 END.   
                 IF DAY(regdat3) GE 26 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
                    IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                    ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
                 END.  	     
                 ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                 
              END.              	         	        
              ELSE IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
              DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	           ASSIGN
   	           regdat4 = TIDREGITAB.DATUM + 1 
   	           regdat5 = regdat4
                 frslut = 24.00.    
                 /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                 regdatum = regdat4.
                 RUN REGVEC.P.
                 RUN SLUTARB.P.          
                 IF regstart = regslut THEN regdat4 = regdat4 + 1.      	           
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	              END.
   	           END. 
   	           IF regdat4 = regdat5 THEN ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	           
   	           dat2:
   	           REPEAT:
   	              IF regdat4 = regdat5 THEN LEAVE dat2. 
    	              IF regdat4 > regdat5 THEN DO:
   	                 regdat5 = regdat4.
   	                 /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                       regdatum = regdat4.
                       RUN REGVEC.P.
                       RUN SLUTARB.P.          
                       IF regstart = regslut THEN regdat4 = regdat4 + 1.                       
                       ELSE DO:
   	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                    END.
   	                 END.    
   	              END.
   	           END.   
   	           IF DAY(regdat4) LE 3 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
      	              FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
   	              IF AVAILABLE frbuff THEN DO: 
   	                 IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                    ASSIGN
   	                    regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                    regdat4 = regdat5 - 1.
   	                 END.
   	                 ELSE  ASSIGN regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))  regdat4 = regdat5 - 1.   	                 
   	              END.  
   	              ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                                            
   	           END.              
                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                  
                 IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	              ASSIGN
   	              regdat3 =  TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3.
                    frstart = 00.00.
                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                    regdatum = regdat3.
                    RUN REGVEC.P.
                    RUN SLUTARB.P.          
                    IF regstart = regslut THEN regdat3 = regdat3 - 1.   	              
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
   	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
   	                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                          regdatum = regdat3.
                          RUN REGVEC.P.
                          RUN SLUTARB.P.          
                          IF regstart = regslut THEN regdat3 = regdat3 - 1.                           
                          ELSE DO:
     	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   	       
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1  AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                    END.                 
   	              /*2010/02/19  IF AVAILABLE frbuff THEN regdat3 = regdat3 + 1 .	              */
                    IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                    ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
   	           END.                                  
   	        END.    	    
   	        ELSE IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	           ASSIGN
   	           regdat3 = TIDREGITAB.DATUM - 1 
   	           regdat5 = regdat3.
                 frstart = 00.00.
                 /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                 regdatum = regdat3.
                 RUN REGVEC.P.
                 RUN SLUTARB.P.          
                 IF regstart = regslut THEN regdat3 = regdat3 - 1.   	           
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	              END.
   	           END.                                  
   	           dat:
   	           REPEAT:
   	              IF regdat5 = regdat3 THEN LEAVE dat.
   	              IF regdat5 > regdat3 THEN DO:    
   	                 regdat5 = regdat3.
   	                 /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                       regdatum = regdat3.
                       RUN REGVEC.P.
                       RUN SLUTARB.P.          
                       IF regstart = regslut THEN regdat3 = regdat3 - 1.                        
                       ELSE DO:
     	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                    END.
   	                 END.
   	              END.
   	           END.   	                   
                 IF onr2 = "118" THEN DO:
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 AND frbuff.RESMAL = kommentar NO-LOCK NO-ERROR.
                 END.
                 ELSE DO:                 
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                 END.   	           
                 IF AVAILABLE frbuff THEN regdat3 = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).                    
                 ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                 
   	        END.              	                           
   	        CREATE franvarotemp.
   	        ASSIGN    	        
              franvarotemp.PERSONALKOD = personal  franvarotemp.PNR = pnr franvarotemp.ANSTNR = panstnr franvarotemp.AONR = onr2
   	        franvarotemp.DELNR = dnr2 franvarotemp.LART = fkod
   	        franvarotemp.FRAN = regdat3 franvarotemp.TILL = regdat4
   	        franvarotemp.PROCENT = proc1 franvarotemp.TIMMAR = antal2 franvarotemp.PKOD = anst              
              franvarotemp.KOMMENTAR  = kommentar.                     
              ASSIGN
    	        franvarotemp.FRTID = frstart 
   	        franvarotemp.TITID = frslut
   	        franvarotemp.START = TIDREGITAB.START
              franvarotemp.SLUT = TIDREGITAB.SLUT.  
              FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
              FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = PERSONALTAB.OMRADE NO-LOCK NO-ERROR.
              FIND FIRST AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK NO-ERROR.
              FIND FIRST JURPERS WHERE JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK NO-ERROR.      
              IF AVAILABLE JURPERS THEN ASSIGN franvarotemp.VIJUDID = JURPERS.VIJUDID.     
               FIND FIRST AONRTAB WHERE AONRTAB.AONR = franvarotemp.AONR  NO-LOCK NO-ERROR.
               IF AVAILABLE AONRTAB THEN  franvarotemp.ORT = AONRTAB.ORT.      
   	     END.           
           ELSE DO:
   	        regdatum = TIDREGITAB.DATUM - 1.
   	        RUN REGVEC.P.
   	        RUN SLUTARB.P.
   	        IF regstart = regslut THEN DO:
   	           REPEAT:
   	              IF regstart ne regslut THEN LEAVE.
   	              /*SÅ ATT DET INTE SKA BLI LOP OM PERSONEN STARTAR SIN ANSTÄLLNING MED FRÅNVARO*/
                    IF regdatum < ( TIDREGITAB.DATUM - 31 ) THEN LEAVE.
   	              regdatum = regdatum - 1.
   	              RUN REGVEC.P.
   	              RUN SLUTARB.P.
   	           END.
   	        END.
   	        ASSIGN
   	        regdatum2 = regdatum
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN SLUTARB.P.	   
   	        nytid = regstart.
   	        RUN TIMSEK.P. 
   	        ASSIGN             /* raknar ut totala tiden */
   	        starttiden = sekunder
   	        nytid = regslut.
   	        RUN TIMSEK.P.
   	        ASSIGN
   	        sluttiden = sekunder
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN NORDFTO.P.
   	        tott1 = nytid.
   	        RUN TIMSEK.P.
   	        tott2 = sekunder.	                 
   	        IF franvarotemp.TILL < regdatum2
   	        OR franvarotemp.PROCENT < 100
   	        OR TIDREGITAB.TOTALT < tott1 OR TIDREGITAB.SLUT = 24 THEN DO:
   	           IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
   	           THEN DO:                  
   	              nytid = TIDREGITAB.TOTALT.
   	              RUN TIMSEK.P.               
   	              IF tott2 LE 0 THEN proc1 = 0.
   	              ELSE proc1 = 100 * sekunder / tott2.	           
   	              IF pc NE TRUE THEN antal = nytid.		             	              
   	           END.	    	           
                 ELSE IF  TIDREGITAB.AONR = "160" OR TIDREGITAB.AONR = "161"  OR TIDREGITAB.AONR = "162" OR TIDREGITAB.AONR = "170"  OR TIDREGITAB.AONR = "300" 
                 OR TIDREGITAB.AONR = "137" /*OR TIDREGITAB.AONR = "171"*/   THEN DO:                                  
                    /* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna   
                    627 - REHAB GODKÄND AV AG 137 20190605                                                   
                    406- arbetstidsförkortning 160
                    406- arbetstidsförkortning 161 SVAB
                    860- kompledighet 170
                    861- 6 JUNI 162
                    693- förtroendemannauppdrag SEAB 300
                    - veckovila 171                                                      
                    franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
                    franvarotemp.TTID- TIMMAR DEL AV DAG
                    */
                    antal = TIDREGITAB.TOTALT.
                 END.
                 ELSE DO:
   	              ASSIGN  proc1 = 100  antal = 0.                    
   	           END.                                       
                 /*Inga avrundningar på frånvaro*/
                 ASSIGN
                 antal2 =  klock100(antal)
                 tott3 = klock100(tott1).                 
                 proc2 = 100 * antal2  / tott3. 
                 regdat3 = TIDREGITAB.DATUM.
                 frstart = TIDREGITAB.START.
   	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3 AND
   	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
   	              ASSIGN
   	              regdat3 = TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3
                    frstart = 00.00.
                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                    regdatum = regdat3.
                    RUN REGVEC.P.
                    RUN SLUTARB.P.          
                    IF regstart = regslut THEN regdat3 = regdat3 - 1.   	              
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
     	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
   	                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/    
                          regdatum = regdat3.
                          RUN REGVEC.P.
                          RUN SLUTARB.P.          
                          IF regstart = regslut THEN regdat3 = regdat3 - 1.                           
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   
   	              IF DAY(regdat3) GE 26 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN regdat3 =  DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).
         	           ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                       
   	              END.  	   
   	              ELSE ASSIGN regdat3 = TIDREGITAB.DATUM frstart = TIDREGITAB.START.                    
   	           END.              	         
   	           ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                  
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4
                    frslut = 24.00.                     
                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/
                    regdatum = regdat4.
                    RUN REGVEC.P.
                    RUN SLUTARB.P.          
                    IF regstart = regslut THEN regdat4 = regdat4 + 1.   	              
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                       IF AVAILABLE OVERAVTAB THEN DO:
    	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
      	           END.   
   	              IF regdat4 = regdat5 THEN ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	              
   	              dat2:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat2. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
   	                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/
                          regdatum = regdat4.
                          RUN REGVEC.P.
                          RUN SLUTARB.P.          
                          IF regstart = regslut THEN regdat4 = regdat4 + 1.                          
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                           IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
     	                    END.      
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO:
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                       ASSIGN
   	                       regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))
     	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                        
   	              END.                              
   	              ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                     
   	           END.  	    
   	           CREATE franvarotemp.
   	           ASSIGN franvarotemp.PERSONALKOD = personal franvarotemp.PNR = pnr franvarotemp.ANSTNR = panstnr franvarotemp.AONR = onr2
   	           franvarotemp.DELNR = dnr2 franvarotemp.LART = fkod
   	           franvarotemp.FRAN = regdat3 franvarotemp.TILL = regdat4
   	           franvarotemp.PROCENT = proc1 franvarotemp.TIMMAR = antal2 franvarotemp.PKOD = anst
                 franvarotemp.KOMMENTAR  = kommentar.                    	           
                 ASSIGN
                 franvarotemp.START = TIDREGITAB.START
                 franvarotemp.SLUT = TIDREGITAB.SLUT
    	           franvarotemp.FRTID = frstart 
   	           franvarotemp.TITID = frslut.
                 FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                 FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE = PERSONALTAB.OMRADE NO-LOCK NO-ERROR.
                 FIND FIRST AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK NO-ERROR.
                 FIND FIRST JURPERS WHERE JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK NO-ERROR.      
                 IF AVAILABLE JURPERS THEN ASSIGN franvarotemp.VIJUDID = JURPERS.VIJUDID.          
                 FIND FIRST AONRTAB WHERE AONRTAB.AONR = franvarotemp.AONR  NO-LOCK NO-ERROR.
                 IF AVAILABLE AONRTAB THEN  franvarotemp.ORT = AONRTAB.ORT.       
   	        END.
              ELSE DO:      
                 ASSIGN
   	           regdat4 = TIDREGITAB.DATUM
                 frslut = TIDREGITAB.SLUT
                 dagtot = 0.                                 
                 /* Ingen avrundning på frånvaro*/
                 dagtot = klock100(TIDREGITAB.TOTALT).
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4.
                    frslut = 24.00.                     
                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/
                    regdatum = regdat4.
                    RUN REGVEC.P.
                    RUN SLUTARB.P.          
                    IF regstart = regslut THEN regdat4 = regdat4 + 1.                                           	              
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
   	              END.        
   	              IF regdat4 = regdat5 THEN  ASSIGN regdat4 = regdat4 - 1 regdat5 = regdat4.   	              
   	              dat3:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat3. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
   	                    /*skift jobbar helg , kan inte avgöra på lördag söndag lena 20190814*/
                          regdatum = regdat4.
                          RUN REGVEC.P.
                          RUN SLUTARB.P.          
                          IF regstart = regslut THEN regdat4 = regdat4 + 1.                          
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
   	                    END.    
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO: 
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO: 
                             ASSIGN regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)                          
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM)).
   	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE ASSIGN regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                        
   	              END.
   	              ELSE ASSIGN  regdat4 = TIDREGITAB.DATUM frslut = TIDREGITAB.SLUT.                     
   	           END.  	    
                 ASSIGN franvarotemp.TILL = regdat4
                 franvarotemp.TITID = frslut.                                                          
              END. 
            END.
            IF del1 = FALSE AND franvarotemp.PROCENT < 100 THEN DO:
               CREATE frfel.
               ASSIGN frfel.PERSONNUMMER = franvarotemp.PNR frfel.AONR = franvarotemp.AONR  
  	            frfel.DELNR = franvarotemp.DELNR frfel.LART = franvarotemp.LART
	            frfel.FRAN =   franvarotemp.FRAN frfel.TILL = franvarotemp.TILL 
	            frfel.PROCENT = franvarotemp.PROCENT frfel.TIMMAR = franvarotemp.TIMMAR.
	         END.      
         END.
      END.
      GET NEXT tidq NO-LOCK.
   END.
   GET NEXT persq NO-LOCK.
END.       
DEBUGGER:SET-BREAK().
FOR EACH franvarotemp WHERE NO-LOCK:
   FIND FIRST perskoll WHERE perskoll.PNR  = franvarotemp.PNR NO-LOCK NO-ERROR.
   IF NOT AVAILABLE perskoll  THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  NO-LOCK NO-ERROR.
      IF AVAILABLE PERSONALTAB THEN DO:
         CREATE perskoll.
         ASSIGN      
         perskoll.PERSONALKOD = PERSONALTAB.PERSONALKOD
         perskoll.FORNAMN = PERSONALTAB.FORNAMN
         perskoll.EFTERNAMN = PERSONALTAB.EFTERNAMN
         perskoll.OMRADE = PERSONALTAB.OMRADE
         perskoll.PNR = franvarotemp.PNR
         perskoll.ANSTNR = franvarotemp.ANSTNR
         perskoll.VIJUDID = franvarotemp.VIJUDID .      
      END.
   END.
END.   
FOR EACH stanslonefil WHERE NO-LOCK:
   IF stanslonefil.HEROSORT = "TILLÄGG" OR stanslonefil.HEROSORT = "RESTID" OR stanslonefil.HEROSORT = "RESA" THEN DO:
      IF stanslonefil.RESMAL BEGINS "Resans start:" OR stanslonefil.RESMAL BEGINS "Resans slut:"  OR 
      stanslonefil.RESMAL BEGINS "Utlandsresans start:" OR stanslonefil.RESMAL BEGINS "Utlandsresans slut:" THEN DO:
         DEBUGGER:SET-BREAK().         
         regdatum = stanslonefil.PDATUM.      
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = stanslonefil.PPERSONNUMMER NO-LOCK.
         IF AVAILABLE PERSONALTAB THEN DO:    
                          
            persrec = RECID(PERSONALTAB).                  
            RUN REGVEC.P.
            RUN SLUTARB.P.
            stanslonefil.RESMAL = stanslonefil.RESMAL + " (" + STRING(regstart,"99.99") + " - " + STRING(regslut,"99.99") + ")".
         END.   
      END.   
   END.   
   
   FIND FIRST perskoll WHERE perskoll.PNR  = stanslonefil.PPERSONNUMMER NO-LOCK NO-ERROR.
   IF NOT AVAILABLE perskoll  THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = stanslonefil.PPERSONNUMMER  NO-LOCK NO-ERROR.
      IF AVAILABLE PERSONALTAB THEN DO:
         CREATE perskoll.
         ASSIGN      
         perskoll.PERSONALKOD = PERSONALTAB.PERSONALKOD
         perskoll.FORNAMN = PERSONALTAB.FORNAMN
         perskoll.EFTERNAMN = PERSONALTAB.EFTERNAMN
         perskoll.OMRADE = PERSONALTAB.OMRADE
         perskoll.PNR = stanslonefil.PPERSONNUMMER
         perskoll.ANSTNR = stanslonefil.ANSTNR
         perskoll.VIJUDID = stanslonefil.VIJUDID.      
      END.
   END.      
END.
FOR EACH stanslonefil WHERE stanslonefil.RESMAL BEGINS "Resans start:" NO-LOCK:   
   FIND FIRST stlonbuff WHERE stlonbuff.PPERSONNUMMER = stanslonefil.PPERSONNUMMER AND stlonbuff.RESMAL BEGINS "Resans slut:" AND stlonbuff.PDATUM >  stanslonefil.PDATUM NO-LOCK NO-ERROR.
   IF NOT AVAILABLE stlonbuff THEN DO:
      /* alla tjänsteresor som går över kommande månadsskifte sätts med BEVAKNING*/
      FOR EACH stlonbuff WHERE stlonbuff.PPERSONNUMMER = stanslonefil.PPERSONNUMMER  AND stlonbuff.PDATUM GE  stanslonefil.PDATUM AND stlonbuff.ppar8 = 1:
         stlonbuff.RESMAL = stlonbuff.RESMAL + " BEVAKNING".         
      END.
   END.
END.
FOR EACH stanslonefil WHERE stanslonefil.RESMAL BEGINS "Resans slut:" NO-LOCK:
   FIND FIRST stlonbuff WHERE stlonbuff.PPERSONNUMMER = stanslonefil.PPERSONNUMMER AND stlonbuff.RESMAL BEGINS "Resans start:" AND stlonbuff.PDATUM < stanslonefil.PDATUM NO-LOCK NO-ERROR.
   IF NOT AVAILABLE stlonbuff THEN DO:
      /* alla tjänsteresor som påbörjades förra månaden men avslutas denna månad ska skickas med. Alltså med tidstämpel VECKOKORD*/
      FOR EACH stlonbuff WHERE stlonbuff.PPERSONNUMMER = stanslonefil.PPERSONNUMMER  AND stlonbuff.PDATUM LE  stanslonefil.PDATUM AND stlonbuff.ppar8 = 1:
         stlonbuff.RESMAL = stlonbuff.RESMAL + " BEVAKNING".         
      END.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = stanslonefil.PPERSONNUMMER  NO-LOCK NO-ERROR.
      IF AVAILABLE PERSONALTAB THEN DO:
         FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
         IF AVAILABLE ANSTFORMTAB THEN DO:
            anst = ANSTFORMTAB.KOD.
         END.   
         FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD =  PERSONALTAB.PERSONALKOD AND MONTH(TIDREGITAB.DATUM) = (MONTH(stanslonefil.PDATUM) - 1) AND
         TIDREGITAB.ENFLERDAGS NE "" AND TIDREGITAB.RESMAL BEGINS "Resans start:" USE-INDEX PSTART  NO-LOCK NO-ERROR.
         IF AVAILABLE TIDREGITAB THEN DO:
            FOR EACH tidbuff WHERE tidbuff.PERSONALKOD =  PERSONALTAB.PERSONALKOD AND MONTH(tidbuff.DATUM) = (MONTH(stanslonefil.PDATUM) - 1) 
            AND tidbuff.DATUM GE  TIDREGITAB.DATUM AND   tidbuff.ENFLERDAGS NE ""  USE-INDEX PSTART NO-LOCK:
                                     
               IF tidbuff.LONTILLAGG NE " " AND tidbuff.LONTILLANTAL NE 0 THEN DO TRANSACTION:                  
                    CREATE stlonbuff2.
                    ASSIGN stlonbuff2.PPERSONNUMMER = PERSONALTAB.PERSONNUMMER
                    stlonbuff2.ANSTNR = PERSONALTAB.ANSTNR
                    stlonbuff2.PLONTILLAGG = tidbuff.LONTILLAGG
                    stlonbuff2.PLONTILLANTAL = tidbuff.LONTILLANTAL
                    stlonbuff2.PDATUM = tidbuff.DATUM
                    stlonbuff2.PVECKONUMMER = tidbuff.VECKONUMMER
                    stlonbuff2.AONR = tidbuff.AONR
                    stlonbuff2.DELNR = tidbuff.DELNR
                    stlonbuff2.MANAD = MONTH(tidbuff.DATUM)
                    stlonbuff2.PAVTAL = ANST.          
                    IF tidbuff.ENFLERDAGS NE "" THEN DO:
                       stlonbuff2.RESMAL = tidbuff.RESMAL + " BEVAKNING".                                     
                    END. 
                    FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = stlonbuff2.PLONTILLAGG
                    AND LONTILL.KOD = stlonbuff2.PAVTAL USE-INDEX LON NO-LOCK NO-ERROR.       
                    IF AVAILABLE LONTILL THEN DO:              
                       ASSIGN stlonbuff2.PSORT = LONTILL.ENHET.                                                                                            
                       stlonbuff2.PPAR8 = 0.
                       IF tidbuff.TIDLOG = TRUE THEN DO:
                          ASSIGN
                          stlonbuff2.START = tidbuff.START
                          stlonbuff2.SLUT = tidbuff.SLUT
                          stlonbuff2.OVERTIDUTTAG = tidbuff.OVERTIDUTTAG
                          stlonbuff2.TOTALT = klock100(tidbuff.TOTALT).
                          IF stlonbuff2.PLONTILLAGG = "4610" OR stlonbuff2.PLONTILLAGG = "4611" THEN stlonbuff2.HEROSORT = "RESTID". 
                          ELSE stlonbuff2.HEROSORT = "TILLÄGG".
                       END.   
                       ELSE stlonbuff2.HEROSORT = "TILLÄGG".
                       IF tidbuff.ENFLERDAGS NE "" THEN DO:                 
                          stlonbuff2.PPAR8 = 1.
                       END.
                       FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = stlonbuff2.PLONTILLAGG
                        AND LONTILL.KOD = stlonbuff2.PAVTAL USE-INDEX LON NO-LOCK NO-ERROR.
                        IF AVAILABLE LONTILL AND SUBSTRING(LONTILL.TYPKOD,1,3) = "BIL" THEN DELETE stlonbuff2.
                        ELSE IF NOT AVAILABLE LONTILL THEN DO:
                           FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = stlonbuff2.PLONTILLAGG USE-INDEX LON NO-LOCK NO-ERROR.
                           IF AVAILABLE LONTILL AND SUBSTRING(LONTILL.TYPKOD,1,3) = "BIL" THEN DELETE stlonbuff2.
                           ELSE IF AVAILABLE LONTILL THEN DO: 
                              ASSIGN 
                              stlonbuff2.PLONTILLAGG = LONTILL.VILART     
                              stlonbuff2.KLARTEXT = LONTILL.LONKODTEXT.     
                           END.
                        END.
                        ELSE IF AVAILABLE LONTILL THEN DO: 
                           ASSIGN 
                           stlonbuff2.PLONTILLAGG = LONTILL.VILART
                           stlonbuff2.KLARTEXT = LONTILL.LONKODTEXT.                  
                        END.       
                    END.
                 END.          
                 IF tidbuff.TRAKTKOD NE " " AND tidbuff.TRAKTANTAL NE 0
                 THEN DO TRANSACTION:
                    CREATE stlonbuff2.
                    ASSIGN stlonbuff2.PPERSONNUMMER = PERSONALTAB.PERSONNUMMER
                    stlonbuff2.ANSTNR = PERSONALTAB.ANSTNR
                    stlonbuff2.PTRAKTKOD = tidbuff.TRAKTKOD
                    stlonbuff2.PTRAKTANTAL = tidbuff.TRAKTANTAL
                    stlonbuff2.PDATUM = tidbuff.DATUM
                    stlonbuff2.PVECKONUMMER = tidbuff.VECKONUMMER
                    stlonbuff2.AONR = tidbuff.AONR
                    stlonbuff2.DELNR = tidbuff.DELNR
                    stlonbuff2.MANAD = MONTH(tidbuff.DATUM)
                    stlonbuff2.PAVTAL = PERSONALTAB.TRAAVTAL
                    stlonbuff2.TID = FALSE
                    stlonbuff2.PSORT = "ST".                               
                    ASSIGN
                    stlonbuff2.START = tidbuff.START
                    stlonbuff2.SLUT = tidbuff.SLUT
                    stlonbuff2.PLONTILLAGG = tidbuff.TRAKTKOD
                    stlonbuff2.PLONTILLANTAL = tidbuff.TRAKTANTAL
                    stlonbuff2.OVERTIDUTTAG = tidbuff.OVERTIDUTTAG           
                    stlonbuff2.RESMAL = tidbuff.RESMAL  + " BEVAKNING"
                    stlonbuff2.HEROSORT = "TILLÄGG".
                    stlonbuff2.PPAR8 = 0.
                    IF tidbuff.ENFLERDAGS NE "" THEN DO:              
                       stlonbuff2.PPAR8 = 1.
                    END.
                    FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = stlonbuff2.PLONTILLAGG
                    AND TRAKTATAB.TRAAVTAL = stlonbuff2.PAVTAL USE-INDEX TRAAV NO-LOCK NO-ERROR.
                    IF NOT AVAILABLE TRAKTATAB  THEN DO:
                       FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = stlonbuff2.PLONTILLAGG USE-INDEX TRAAV NO-LOCK NO-ERROR.
                    END.
                    IF AVAILABLE TRAKTATAB THEN DO: 
                       ASSIGN stlonbuff2.PLONTILLAGG = TRAKTATAB.VILART.
                       stlonbuff2.KLARTEXT = TRAKTATAB.FORKL.            
                    END.           
                 END.
              END.
           END.
        END.                     
   END.   
END.
   
     
/* timavdrag skall läggas ut med timmar i antal . Om det gäller flera dagar summeras timmarna
frånvarolöneart
627 - REHAB GODKÄND AV AG 137 20190605 
406- arbetstidsförkortning 160
406- arbetstidsförkortning 161 svab
693 - förtroendemannauppdrag 300 SEAB
860- kompledighet 170
861- 6 JUNI 162
franvarotemp.TOTTID -TOTALT ANTAL TIMMAR FÖR PERIOD
franvarotemp.TTID- regtotalt DEL AV DAG
*/


FOR EACH franvarotemp WHERE franvarotemp.LART = "406"  OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861" OR franvarotemp.LART = "627" :
   IF franvarotemp.FRAN NE franvarotemp.TILL THEN DO:
      IF MONTH(franvarotemp.FRAN) < MONTH(franvarotemp.TILL) THEN DO:              
         ASSIGN regdat1 = franvarotemp.TILL
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2
         regdat2 = regdat2 + 1.     
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.     
      END.
      ASSIGN       
      regdatum = franvarotemp.FRAN 
      avdatum = franvarotemp.TILL.
      komptid = 0.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
      persrec = RECID(PERSONALTAB).
      REPEAT:      
         RUN REGVEC.P.
         RUN SLUTARB.P.
         IF regstart NE regslut THEN komptid = komptid + klock100(regtotalt).                      
         regdatum = regdatum + 1.
         IF regdatum > avdatum THEN LEAVE.         
      END.
      franvarotemp.TOTTID = komptid.

   END.   
END.


RUN ftemp_UI.


 FOR EACH franvarotemp WHERE LENGTH(franvarotemp.PNR) = 10:
   IF SUBSTRING(franvarotemp.PNR,1,1) = "0" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE IF SUBSTRING(franvarotemp.PNR,1,1) = "1" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE IF SUBSTRING(franvarotemp.PNR,1,1) = "2" THEN franvarotemp.PNR = "20" + franvarotemp.PNR.
   ELSE franvarotemp.PNR = "19" + franvarotemp.PNR.
END.

/* kör på klient
tider = REPLACE(STRING(TIME,"HH:MM"),":","").
fnamn = "Mall stanstid.XLSX".
fnamn2 = "Mall stanstid Elnät " + STRING(TODAY,"99999999") + tider +  ".XLSX".
fnamn3 = "OmkMall stanstid Elnät " + STRING(TODAY,"99999999") + tider +  ".XLSX".
RUN mallut_UI (INPUT "ELNÄT").

tider = REPLACE(STRING(TIME,"HH:MM"),":","").
fnamn = "Mall stanstid.XLSX".
fnamn2 = "Mall stanstid ServaNet " + STRING(TODAY,"99999999") + tider +  ".XLSX".
fnamn3 = "OmkMall stanstid ServaNet " + STRING(TODAY,"99999999") + tider +  ".XLSX".
RUN mallut_UI (INPUT "ServaNet").
*/


/*DO TRANSACTION:      
   IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
         
      /*/*Sundsvall Energi ELNÄT AB*/
      IF korvar = "" THEN DO:
         prognamn3 = prognamn5 + "stanstid.d".
         OUTPUT STREAM stanslule TO VALUE(prognamn3) APPEND.      
      END.
      ELSE DO:
         prognamn3 = prognamn5 + "stanstidflomk.d".
         OUTPUT STREAM stanslule TO VALUE(prognamn3) APPEND.      
      END.*/
         
      IF korvar = "" THEN DO:      
           
         prognamn3 = prognamn5 + "SUNDELNAT.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.
         lonfil =  "SUNDELNATfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.           
      END.
      ELSE DO:           
         prognamn3 = prognamn5 + "SUNDELNATomk.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.      
         lonfil =  "SUNDELNATomkfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.            
      END.         
      anstperson = "".
      FOR EACH franvarotemp WHERE franvarotemp.VIJUDID = "ELNÄT" USE-INDEX VIJUDID:
         overrapp2 = "".
         IF anstperson NE franvarotemp.PNR THEN DO: 
            /*overrapp2 = "".
            PUT STREAM stanslule overrapp2 SKIP.
            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR NO-LOCK NO-ERROR.            
            ASSIGN
            SUBSTRING(overrapp2,2,11) = STRING(franvarotemp.PNR,"999999-9999").
            IF AVAILABLE PERSONALTAB THEN SUBSTRING(overrapp2,14,38) = PERSONALTAB.PERSONALKOD + " " + PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN.           
            anstperson = franvarotemp.PNR.            
            PUT STREAM stanslule overrapp2 SKIP.*/
         END.      
         ASSIGN overrapp2 = "".   
         ASSIGN                        
         SUBSTRING(overrapp2,2,8) = SUBSTRING(franvarotemp.LART,1,8)
         SUBSTRING(overrapp2,24,10) = STRING(franvarotemp.FRAN,"99999999")
         SUBSTRING(overrapp2,39,10) = STRING(franvarotemp.TILL,"99999999").               
         IF franvarotemp.LART = "600" OR franvarotemp.LART = "605" OR franvarotemp.LART = "606" 
         OR franvarotemp.LART = "601" OR franvarotemp.LART = "603" OR franvarotemp.LART = "604"  OR franvarotemp.LART = "615" THEN DO:                 
            IF franvarotemp.TIMMAR > 0 THEN DO:                                     
               omfatt = 0.
               IF franvarotemp.TTID > 0 THEN DO:      
                  omfatt = 100  * franvarotemp.TIMMAR / franvarotemp.TTID .
                  IF omfatt > 100 THEN omfatt = 100.
               END.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               STRING(omfatt,"999.99")
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
            END.
            ELSE DO:         
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               "100.00" 
               + franvarotemp.KOMMENTAR. 
               SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
            END.         
         END.   
         ELSE IF franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861" OR franvarotemp.LART = "627" THEN  DO:         
            /*timavdrag*/         
            /*rgr = "    ".*/            
            IF franvarotemp.TIMMAR > 0 THEN DO:  
               IF franvarotemp.FRAN = franvarotemp.TILL THEN DO:               
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00"          
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                  
               END.
               ELSE DO:            
                  frantim = franvarotemp.TOTTID * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TOTTID,"999.99").                  
               END.
            END.            
         END.      
         ELSE IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100 THEN  DO:
            /*timavdrag för föräldraledighet del av dag 20071106*/         
            franvarotemp.LART = "660".  
            IF franvarotemp.TIMMAR > 0 THEN DO:              
               frantim = franvarotemp.TIMMAR * 100.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "L" + franvarotemp.LART + 
               STRING(frantim,"-999999999") +
               "000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +
               "0000000000000000" +
               "00000 " +         
               "                    " +
               "                    " +
               "            " +
               "                    " +              
               "100.00"          
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                        
            END.         
         END.
         ELSE DO:
            /*kalenderdagavdrag*/      
            IF franvarotemp.TIMMAR > 0 THEN DO:                          
               IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100 THEN franvarotemp.LART = "660".            
               IF franvarotemp.LART = "621" AND franvarotemp.PROCENT < 100 THEN franvarotemp.LART = "620".            
               IF franvarotemp.LART = "620" THEN DO:
                  /* Timavdrag om det är det av dag för tjäntledighet utan lön enligt Ingrid 20080812*/              
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00"          
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                                 
               END.
               ELSE DO:            
                  omfatt = 0.
                  IF franvarotemp.TTID > 0 THEN DO:      
                     omfatt = ( franvarotemp.TIMMAR / franvarotemp.TTID) * 100.
                     IF omfatt > 100 THEN omfatt = 100.
                  END.            
                  IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:
                     /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal ,omfattningen ändras till 100*/
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART + 
                     STRING(omfatt,"-999999999") +
                     "000000000000000000000000000" +                                   
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +               
                     "100.00"                      
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  "100.00".
                  END.
                  ELSE DO:            
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART +                      
                     "0000000000" +
                     "000000000000000000000000000" +
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +
                     STRING(omfatt,"999.99") 
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
                  END.
               END.
            END.
            ELSE DO:
               /* lägg in hela dagar sem lart 501*/
               ASSIGN
               startm = FALSE
               slutm = FALSE
               startdatum = ?
               slutdatum = ?.
               IF franvarotemp.LART = "661" OR franvarotemp.LART = "621"  THEN DO:
                  IF DAY(franvarotemp.FRAN)  > 01 AND DAY(franvarotemp.FRAN)  LE 04 THEN DO:
                     regdatum = franvarotemp.FRAN - 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN regdatum = regdatum - 1.                     
                        ELSE LEAVE.                     
                        IF DAY(regdatum) > DAY(franvarotemp.FRAN) THEN DO: 
                           regdatum = regdatum + 1.
                           IF DAY(regdatum) = 01 THEN DO: 
                              ASSIGN startm = TRUE
                              startdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.
                  END.
                  IF DAY(franvarotemp.TILL)  > 26 AND DAY(franvarotemp.TILL + 1) > 26 THEN DO:
                     regdatum = franvarotemp.TILL + 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN regdatum = regdatum + 1.                     
                        ELSE LEAVE.                     
                        IF DAY(regdatum) < DAY(franvarotemp.TILL) THEN DO: 
                           regdatum = regdatum - 1.
                           IF DAY(regdatum + 1 ) = 01 THEN DO: 
                              ASSIGN slutm = TRUE
                              slutdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.                  
                  END.
                  IF startm = TRUE AND slutm = TRUE THEN DO:
                     IF startdatum NE ? AND slutdatum NE ? THEN DO:                  
                        ASSIGN
                        franvarotemp.FRAN = startdatum
                        franvarotemp.TILL = slutdatum.
                     END.
                  END.
               END.
               IF franvarotemp.LART = "661" THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "662".                           
               IF franvarotemp.LART = "621" THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "622".                           
               /*IF franvarotemp.LART = "694"  THEN DO:
                  IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN DO:
                     ASSIGN franvarotemp.LART = "695".
                  END.
               END.   */
   
               IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:               
                  /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal*/               
                  IF franvarotemp.FRAN = franvarotemp.TILL  THEN omfatt = 100.
                  ELSE omfatt = franvarotemp.ARBDAGAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                   STRING(omfatt,"-999999999") +                                   
                  "000000000000000000000000000" +                                
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  "100.00".
               END.
               ELSE DO:            
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + "0000000000000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
               END.
            END.             
         END.         
         PUT STREAM frlule overrapp1 SKIP.
         PUT STREAM frlulekop overrapp1 SKIP.
        /* PUT STREAM stanslule overrapp2 SKIP.*/
         
         DELETE franvarotemp.
      END.   
      overrapp1 = "999999".
      PUT STREAM frlule overrapp1 SKIP.
      PUT STREAM frlulekop overrapp1 SKIP.
          
      OUTPUT STREAM frlule CLOSE.
      OUTPUT STREAM frlulekop CLOSE.
      
         
      /*ServaNet AB*/
               
      IF korvar = "" THEN DO:      
         
         prognamn3 = prognamn5 + "SUNDServaNet.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.
         lonfil =  "SUNDServaNetfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.           
      END.
      ELSE DO:        
         prognamn3 = prognamn5 + "SUNDServaNetomk.d".
         OUTPUT STREAM frlule TO VALUE(prognamn3) APPEND.      
         lonfil =  "SUNDServaNetomkfran" + STRING(TODAY,"99999999") + ".d".
         prognamn3 = prognamn5  + lonfil.                 
         OUTPUT STREAM frlulekop TO VALUE(prognamn3) NO-ECHO.            
      END.
      anstperson = "".
      FOR EACH franvarotemp WHERE franvarotemp.VIJUDID = "ServaNet" USE-INDEX VIJUDID:
         overrapp2 = "".
         IF anstperson NE franvarotemp.PNR THEN DO: 
            overrapp2 = "".                                 
            anstperson = franvarotemp.PNR.                       
         END.
         
         ASSIGN overrapp2 = "".   
         ASSIGN                        
         SUBSTRING(overrapp2,2,8) = SUBSTRING(franvarotemp.LART,1,8)
         SUBSTRING(overrapp2,24,10) = STRING(franvarotemp.FRAN,"99999999")
         SUBSTRING(overrapp2,39,10) = STRING(franvarotemp.TILL,"99999999").         
         
         IF franvarotemp.LART = "600" OR franvarotemp.LART = "605" OR franvarotemp.LART = "606"
         OR franvarotemp.LART = "601" OR franvarotemp.LART = "603" OR franvarotemp.LART = "604"  OR franvarotemp.LART = "615" THEN DO:                 
            IF franvarotemp.TIMMAR > 0 THEN DO:                                      
               omfatt = 0.
               IF franvarotemp.TTID > 0 THEN DO:      
                  omfatt = ( franvarotemp.TIMMAR / franvarotemp.TTID) * 100.
                  IF omfatt > 100 THEN omfatt = 100.
               END.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               STRING(omfatt,"999.99") 
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
            END.
            ELSE DO:         
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "A" + franvarotemp.LART + "0000000000000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +            
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +            
               "0000000000000000" +
               "00000 " +         
               "                                                                        " +
               "100.00" 
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
            END.         
         END.            
         ELSE IF franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693"  OR franvarotemp.LART = "861" OR franvarotemp.LART = "627" THEN  DO:
            /*timavdrag*/         
            /*rgr = "    ".*/            
            IF franvarotemp.TIMMAR > 0 THEN DO:  
               IF franvarotemp.FRAN = franvarotemp.TILL THEN DO:               
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                  
               END.
               ELSE DO:            
                  frantim = franvarotemp.TOTTID * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TOTTID,"999.99").                  
               END.
            END.            
         END.
         ELSE IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100 THEN  DO:
            /*timavdrag för föräldraledighet del av dag 20071106*/         
            franvarotemp.LART = "660".  
            IF franvarotemp.TIMMAR > 0 THEN DO:              
               frantim = franvarotemp.TIMMAR * 100.
               overrapp1 = "214007" + "0" + franvarotemp.PNR +
               "L" + franvarotemp.LART + 
               STRING(frantim,"-999999999") +
               "000000000000000000000000000" +
               STRING(franvarotemp.FRAN,"99999999") +
               "00000" +
               STRING(franvarotemp.TILL,"99999999") + 
               "00000" +
               "0000000000000000" +
               "00000 " +         
               "                    " +
               "                    " +
               "            " +
               "                    " +              
               "100.00"          
               + franvarotemp.KOMMENTAR.     
               SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                        
            END.         
         END.
         ELSE DO:
            /*kalenderdagavdrag*/      
            IF franvarotemp.TIMMAR > 0 THEN DO:                          
               IF franvarotemp.LART = "661" AND franvarotemp.PROCENT < 100  THEN franvarotemp.LART = "660".            
               IF franvarotemp.LART = "621" AND franvarotemp.PROCENT < 100 THEN franvarotemp.LART = "620". 
               IF franvarotemp.LART = "620" THEN DO:
                  /* Timavdrag om det är det av dag för tjäntledighet utan lön enligt Ingrid 20080812*/              
                  frantim = franvarotemp.TIMMAR * 100.
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                  STRING(frantim,"-999999999") +
                  "000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +              
                  "100.00"          
                  + franvarotemp.KOMMENTAR.     
   
                  SUBSTRING(overrapp2,50,5) = STRING(franvarotemp.TIMMAR,"999.99").                
               END.
               ELSE DO:            
                  omfatt = 0.
                  IF franvarotemp.TTID > 0 THEN DO:      
                     omfatt = ( franvarotemp.TIMMAR / franvarotemp.TTID) * 100.
                     IF omfatt > 100 THEN omfatt = 100.
                  END.
                  IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:
                     /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal*/
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART + 
                     STRING(omfatt,"-999999999") +
                     "000000000000000000000000000" +                                   
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +
                     "100.00"                     
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  "100.00".
                  END.
                  ELSE DO:
                     overrapp1 = "214007" + "0" + franvarotemp.PNR +
                     "L" + franvarotemp.LART +                      
                     "0000000000" +
                     "000000000000000000000000000" +
                     STRING(franvarotemp.FRAN,"99999999") +
                     "00000" +
                     STRING(franvarotemp.TILL,"99999999") + 
                     "00000" +
                     "0000000000000000" +
                     "00000 " +         
                     "                    " +
                     "                    " +
                     "            " +
                     "                    " +
                     STRING(omfatt,"999.99") 
                     + franvarotemp.KOMMENTAR.     
                     SUBSTRING(overrapp2,57,5) =  STRING(omfatt,"999.99").
                  END.
               END.
            END.
            ELSE DO:
               /* lägg in hela dagar sem lart 501*/
               ASSIGN
               startm = FALSE
               slutm = FALSE
               startdatum = ?
               slutdatum = ?.
               IF franvarotemp.LART = "661" OR franvarotemp.LART = "621" /*OR franvarotemp.LART = "694"*/ THEN DO:
                  IF DAY(franvarotemp.FRAN)  > 01 AND DAY(franvarotemp.FRAN)  LE 04 THEN DO:
                     regdatum = franvarotemp.FRAN - 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN DO:
                           regdatum = regdatum - 1.
                        END.
                        ELSE LEAVE.                     
                        IF DAY(regdatum) > DAY(franvarotemp.FRAN) THEN DO: 
                           regdatum = regdatum + 1.
                           IF DAY(regdatum) = 01 THEN DO: 
                              startm = TRUE.
                              startdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.
                  END.
                  IF DAY(franvarotemp.TILL)  > 26 AND DAY(franvarotemp.TILL + 1) > 26 THEN DO:
                     regdatum = franvarotemp.TILL + 1.
                     FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD NO-LOCK NO-ERROR.      
                     persrec = RECID(PERSONALTAB).         
                     REPEAT:                  
                        RUN REGVEC.P.
                        RUN SLUTARB.P.
                        IF regstart = regslut THEN regdatum = regdatum + 1.                     
                        ELSE LEAVE.                     
                        IF DAY(regdatum) < DAY(franvarotemp.TILL) THEN DO: 
                           regdatum = regdatum - 1.
                           IF DAY(regdatum + 1 ) = 01 THEN DO: 
                              slutm = TRUE.
                              slutdatum = regdatum.
                           END.
                           LEAVE.
                        END.
                     END.                  
                  END.
                  IF startm = TRUE AND slutm = TRUE THEN DO:
                     IF startdatum NE ? AND slutdatum NE ? THEN DO:                  
                        ASSIGN
                        franvarotemp.FRAN = startdatum
                        franvarotemp.TILL = slutdatum.
                     END.
                  END.
               END.
               IF franvarotemp.LART = "661" THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "662".                           
               IF franvarotemp.LART = "621"  THEN IF DAY(franvarotemp.FRAN) = 01 AND DAY(franvarotemp.TILL + 1) = 01 THEN ASSIGN franvarotemp.LART = "622".                           
               IF franvarotemp.LART = "623" OR  franvarotemp.LART = "670"  THEN  DO:
                  /*enskild angelägenhet 135 vård av närstående 116 skall omfattningen ut i antal*/
                  IF franvarotemp.FRAN = franvarotemp.TILL  THEN omfatt = 100.
                  ELSE omfatt = franvarotemp.ARBDAGAR * 100.                             
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + 
                   STRING(omfatt,"-999999999") +                                   
                  "000000000000000000000000000" +                                
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  "100.00".
               END.
               ELSE DO:            
                  overrapp1 = "214007" + "0" + franvarotemp.PNR +
                  "L" + franvarotemp.LART + "0000000000000000000000000000000000000" +
                  STRING(franvarotemp.FRAN,"99999999") +
                  "00000" +
                  STRING(franvarotemp.TILL,"99999999") + 
                  "00000" +
                  "0000000000000000" +
                  "00000 " +         
                  "                    " +
                  "                    " +
                  "            " +
                  "                    " +
                  "100.00" 
                  + franvarotemp.KOMMENTAR.     
                  SUBSTRING(overrapp2,57,5) =  STRING(100.00,"999.99").
               END.
            END.              
         END.         
         PUT STREAM frlule overrapp1 SKIP.
         PUT STREAM frlulekop overrapp1 SKIP.        
         DELETE franvarotemp.
   
      END.   
      overrapp1 = "999999".
      PUT STREAM frlule overrapp1 SKIP.
      PUT STREAM frlulekop overrapp1 SKIP.             
      OUTPUT STREAM frlule CLOSE.
      OUTPUT STREAM frlulekop CLOSE.         
   END.               
END.*/


/*IF korvar = "" THEN prognamn3 = prognamn5 + "fransu.d".   
ELSE prognamn3 = prognamn5 + "fransuomk.d".   
OUTPUT TO VALUE(prognamn3) NO-ECHO.

FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
  EXPORT franvarotemp.
END.
OUTPUT CLOSE.
IF korvar = "" THEN prognamn3 = prognamn5 + "felpers.d".   
ELSE prognamn3 = prognamn5 + "felpersomk.d".   
OUTPUT TO VALUE(prognamn3) APPEND.
FOR EACH franvarotemp USE-INDEX franvaro  NO-LOCK:
  EXPORT franvarotemp.
END.
OUTPUT CLOSE.
IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
   IF korvar = "" THEN DO:   
      lonfil =  "SUNDELNAT" + STRING(TODAY,"99999999") + ".wli".
      prognamn = prognamn6  + lonfil.        
      prognamn3 = prognamn5 + "SUNDELNAT.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn). 
      prognamn = prognamn5  + lonfil.              
      OS-COPY VALUE(prognamn3) VALUE(prognamn).                                 
      lonfil =  "SUNDServaNet" + STRING(TODAY,"99999999") + ".wli".
      prognamn = prognamn6  + lonfil.        
      prognamn3 = prognamn5 + "SUNDServaNet.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn). 
      prognamn = prognamn5  + lonfil.              
      OS-COPY VALUE(prognamn3) VALUE(prognamn).                                    
   END.
   ELSE DO:   
      prognamn = prognamn5 + "SUNDELNATomk" + STRING(TODAY,"999999") + ".wli".        
      prognamn3 = prognamn5 + "SUNDELNATomk.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn).                          
      prognamn = prognamn5 + "SUNDServaNetomk" + STRING(TODAY,"999999") + ".wli".        
      prognamn3 = prognamn5 + "SUNDServaNetomk.d".      
      OS-COPY VALUE(prognamn3) VALUE(prognamn).                              
   END.
END.
*/

RUN sammut_UI (INPUT 2).
{EUROPEANAMERICAN.I}
PROCEDURE ftemp_UI:
   
   FOR EACH franvarotemp WHERE franvarotemp.FRAN = franvarotemp.TILL :   
      IF franvarotemp.TIMMAR > 0 THEN DO:   
         /*regtotalt DEL AV DAG*/
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
         persrec = RECID(PERSONALTAB).       
         regdatum = franvarotemp.FRAN. 
         RUN REGVEC.P.
         RUN SLUTARB.P.
         ASSIGN
         franvarotemp.TTID = klock100(regtotalt).         
      END.   
   END.   
   /*IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
      /*SNATBERGET*/
      OUTPUT TO d:\delad\pro10s\EXPORT\lonelnat\allfranfskift.d NO-ECHO.
   END.   
   FOR EACH franvarotemp  USE-INDEX franvaro  NO-LOCK:
     EXPORT franvarotemp.
   END.
   OUTPUT CLOSE.*/  
   /*SKIFT dela upp i skiftdygnet*/
   FOR EACH franvarotemp WHERE franvarotemp.TITID = 24 AND franvarotemp.FRAN = franvarotemp.TILL BY franvarotemp.PERSONALKOD BY franvarotemp.FRAN:
      IF franvarotemp.LART = "406" OR franvarotemp.LART = "860" OR franvarotemp.LART = "693" OR franvarotemp.LART = "861" OR franvarotemp.LART = "627"  THEN.
      ELSE DO:         
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = franvarotemp.PERSONALKOD USE-INDEX PERSONALKOD NO-LOCK.       
         persrec = RECID(PERSONALTAB).       
         regdatum = franvarotemp.FRAN. 
         RUN REGVEC.P.
         RUN SLUTARB.P.      
         ASSIGN
         stregtid = klock100(franvarotemp.TITID) - klock100(franvarotemp.FRTID).      
         IF regstart = 0 THEN stttid = klock100(regslut) - klock100(lunchslutet).
         ELSE stttid = klock100(regslut) - klock100(regstart).
         regdatum = regdatum + 1.
         RUN REGVEC.P.
         RUN SLUTARB.P.
         IF regslut = 24 THEN slttid = klock100(lunchstarten) - klock100(regstart).
         ELSE slttid = klock100(regslut) - klock100(regstart).                          
         FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.FRAN = franvarotemp.TILL + 1
         AND fbuff.LART = franvarotemp.LART AND fbuff.FRTID = 00 NO-ERROR.
         IF AVAILABLE fbuff THEN DO:
            ASSIGN
            slregtid = klock100(fbuff.TITID) - klock100(fbuff.FRTID).                
            koll1 = FALSE.
            IF stregtid = stttid AND slregtid = slttid THEN koll1 = TRUE.
            IF stregtid = stttid AND fbuff.FRAN NE fbuff.TILL THEN koll1 = TRUE.
            IF koll1 = TRUE THEN DO:
               FIND FIRST fbuff2 WHERE fbuff2.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff2.TILL = franvarotemp.FRAN - 1
               AND fbuff2.LART = franvarotemp.LART  NO-ERROR.            
               IF stttid > slttid THEN DO:
                  ASSIGN franvarotemp.PROCENT = 100 franvarotemp.TIMMAR = stregtid + slregtid 
                  franvarotemp.TTID = franvarotemp.TIMMAR franvarotemp.TITID = fbuff.TITID.               
                  DELETE fbuff.
               END.
               ELSE DO:
                  FIND FIRST fbuff3 WHERE fbuff3.PERSONALKOD = franvarotemp.PERSONALKOD AND
                  fbuff3.FRAN = franvarotemp.FRAN AND fbuff3.LART = franvarotemp.LART AND RECID(fbuff3) NE RECID(franvarotemp)  NO-ERROR.
                  ASSIGN fbuff.PROCENT = 100 fbuff.TIMMAR = stregtid + slregtid 
                  fbuff.FRTID = franvarotemp.FRTID fbuff.TTID = fbuff.TIMMAR.
                  IF AVAILABLE fbuff2 THEN DO:                                    
                     /*IF NOT AVAILABLE fbuff3 THEN DO:
                        /*problem vid hoptolkning bakåt. Första dagen 7-15 nästa dag 22-07 ger då 3 dagar ej 2 . carina bergman Ok skicka med uppehåll?*/
                        ASSIGN fbuff.FRAN = franvarotemp.FRAN.
                     END.                  */
                     
                  END.
                  IF NOT AVAILABLE fbuff3 THEN DO:
                     DELETE franvarotemp.   
                  END.
               END.
            END.
            ELSE DO:
               IF franvarotemp.FRAN = franvarotemp.TILL THEN DO: 
                  ASSIGN franvarotemp.PROCENT = ( stregtid / (stttid + slttid)) * 100            
                  franvarotemp.TIMMAR = stregtid 
                  franvarotemp.TTID = stttid + slttid.
               END.
               IF fbuff.FRAN = fbuff.TILL THEN DO: 
                  ASSIGN fbuff.PROCENT = ( slregtid / (stttid + slttid)) * 100
                  fbuff.TIMMAR = slregtid 
                  fbuff.TTID = stttid + slttid.
               END.         
            END.
         END.
         ELSE DO:
            
            IF franvarotemp.FRAN = franvarotemp.TILL THEN DO: 
               ASSIGN franvarotemp.PROCENT = ( stregtid / (stttid + slttid)) * 100
               franvarotemp.TIMMAR = stregtid 
               franvarotemp.TTID = stttid + slttid.  
            END.
         END.
      END.   
   END.
   
   /*summera ej frånvaro per dag för stanstid
   /*test att ta bort*/
   FOR EACH franvarotemp WHERE franvarotemp.FRAN = franvarotemp.TILL AND franvarotemp.TTID NE franvarotemp.TIMMAR :   
      /*Om uppdelning på flera registreringar samma dag , slå ihop till 1 registrering 20070423*/
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.TILL = franvarotemp.TILL
      AND fbuff.FRAN = franvarotemp.FRAN AND fbuff.LART = franvarotemp.LART AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
      IF AVAILABLE fbuff THEN DO:
         franvarotemp.TIMMAR = franvarotemp.TIMMAR + fbuff.TIMMAR.   
         franvarotemp.PROCENT = franvarotemp.PROCENT + fbuff.PROCENT.         
         DELETE fbuff.
      END.
   END.*/
   
   /*skift tolka ihop period FÖR SJUKDOM*/
   FOR EACH franvarotemp WHERE franvarotemp.LART = "600" AND franvarotemp.PROCENT GE 100:   
      
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
      IF AVAILABLE fbuff THEN DO:
         FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
         AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
         IF NOT AVAILABLE TIDREGITAB THEN DO:
            ASSIGN franvarotemp.TILL = fbuff.till.
            DELETE fbuff.         
            FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
            IF AVAILABLE fbuff THEN DO:
               FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
               AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
               IF NOT AVAILABLE TIDREGITAB THEN DO:
                  ASSIGN franvarotemp.TILL = fbuff.till.
                  DELETE fbuff.
                  FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
                  IF AVAILABLE fbuff THEN DO:
                     FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
                     AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
                     IF NOT AVAILABLE TIDREGITAB THEN DO:
                        ASSIGN franvarotemp.TILL = fbuff.till.
                        DELETE fbuff.
                        FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
                        IF AVAILABLE fbuff THEN DO:
                           FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
                           AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
                           IF NOT AVAILABLE TIDREGITAB THEN DO:
                              ASSIGN franvarotemp.TILL = fbuff.till.
                              DELETE fbuff.
                              FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
                              IF AVAILABLE fbuff THEN DO:
                                 FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
                                 AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
                                 IF NOT AVAILABLE TIDREGITAB THEN DO:
                                    ASSIGN franvarotemp.TILL = fbuff.till.
                                    DELETE fbuff.
                                    FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 "AND fbuff.PROCENT GE 100 AND  fbuff.FRAN > franvarotemp.TILL  NO-ERROR.
                                    IF AVAILABLE fbuff THEN DO:
                                       FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = franvarotemp.PERSONALKOD AND TIDREGITAB.DATUM GE franvarotemp.TILL 
                                       AND TIDREGITAB.DATUM LE fbuff.TILL AND TIDREGITAB.AONR NE "110"  NO-LOCK NO-ERROR.
                                       IF NOT AVAILABLE TIDREGITAB THEN DO:
                                          ASSIGN franvarotemp.TILL = fbuff.till.
                                          DELETE fbuff.
                                       END.
                                    END.
                                 END.
                              END.
                           END.
                        END.
                     END.   
                  END.                                       
               END.
            END.    
         END.
      END.
      FOR EACH fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = "600 " AND fbuff.PROCENT GE 100 AND  fbuff.FRAN GE franvarotemp.FRAN AND fbuff.TILL LE franvarotemp.TILL
      AND RECID(fbuff) NE RECID(franvarotemp):      
         DELETE fbuff.
      END.      
   END.
   
   FOR EACH franvarotemp WHERE franvarotemp.FRAN NE franvarotemp.TILL :   
      /*Ta bort dubbelregistrering MITT I PERIODEN FÖR SKIFT*/
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = franvarotemp.LART  
      AND fbuff.FRAN GE franvarotemp.FRAN AND fbuff.TILL LE franvarotemp.TILL
      AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
      IF AVAILABLE fbuff THEN DO:      
         DELETE fbuff.
         FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = franvarotemp.LART  
         AND fbuff.FRAN GE franvarotemp.FRAN AND fbuff.TILL LE franvarotemp.TILL
         AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
         IF AVAILABLE fbuff THEN DO:      
            DELETE fbuff.
            FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.LART = franvarotemp.LART  
            AND fbuff.FRAN GE franvarotemp.FRAN AND fbuff.TILL LE franvarotemp.TILL
            AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
            IF AVAILABLE fbuff THEN DO:      
               DELETE fbuff.
            END.
         END.      
      END.
   END.
   
   
   
   FOR EACH franvarotemp WHERE franvarotemp.FRAN NE franvarotemp.TILL :   
      /*Ta bort dubbelregistrering startdag*/
      FIND FIRST fbuff WHERE fbuff.PERSONALKOD = franvarotemp.PERSONALKOD AND fbuff.FRAN = franvarotemp.FRAN AND
      fbuff.LART = franvarotemp.LART AND RECID(fbuff) NE RECID(franvarotemp) NO-ERROR.
      IF AVAILABLE fbuff THEN DO:      
         DELETE fbuff.
      END.
   END.
   /*117- 663 pappaledgihet vid barns födelse
    118 - 655 Tillfällig vård av barn
    119 - 660,661,662 Föräldraledighet tillaggt 20081002
    135 -623  Enskild angelägenhet
    skicka kommentar
    118 -655 ejlängre kommentar till lön Ingrid 20100825  tillbaka Victoria Rosengran 20220506
    191,192,194,195 deltid fl styrs alla till 661 = barnetspersonnummer kommer med*/
   FOR EACH franvarotemp :
       IF franvarotemp.LART = "663" OR franvarotemp.LART = "655" THEN franvarotemp.KOMMENTAR = SUBSTRING(franvarotemp.KOMMENTAR,1,6) + "-" + SUBSTRING(franvarotemp.KOMMENTAR,7,4).      
       ELSE IF franvarotemp.LART = "660" OR franvarotemp.LART = "661" OR franvarotemp.LART = "662" THEN
       franvarotemp.KOMMENTAR = SUBSTRING(franvarotemp.KOMMENTAR,1,6) + "-" + SUBSTRING(franvarotemp.KOMMENTAR,7,4).      
       ELSE IF franvarotemp.LART = "623"  THEN franvarotemp.KOMMENTAR = franvarotemp.KOMMENTAR .
       ELSE ASSIGN franvarotemp.KOMMENTAR = "".    
   END.
      
      FOR EACH franvarotemp WHERE franvarotemp.FRAN NE franvarotemp.TILL:
      arbdg = 0.
      regdatum = franvarotemp.FRAN.
      adag:
      REPEAT:
         IF regdatum > franvarotemp.TILL THEN LEAVE adag.
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
         IF NOT AVAILABLE PERSONALTAB  THEN FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = franvarotemp.PNR  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.            
         persrec = RECID(PERSONALTAB).         
         RUN REGVEC.P.
         RUN SLUTARB.P.      
         IF regstart = regslut THEN regstart = regstart.
         ELSE  arbdg = arbdg + 1.       
         regdatum = regdatum + 1.    
      END.
      franvarotemp.ARBDAGAR = arbdg.     
   END.
   DO TRANSACTION:
      FIND FIRST franvarotemp WHERE franvarotemp.PNR = " " OR franvarotemp.PNR =
      "000000000000" USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE franvarotemp THEN DELETE franvarotemp.
   END.
   REPEAT TRANSACTION:
      FIND NEXT franvarotemp WHERE franvarotemp.PNR = " " OR franvarotemp.PNR =
       "000000000000"  USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE franvarotemp THEN LEAVE.
      ELSE DELETE franvarotemp.
   END.
   
   /*del2*/
   OPEN QUERY fq FOR EACH franvarotemp.
   GET FIRST fq NO-LOCK.
   DO WHILE AVAILABLE(franvarotemp):      
      IF MONTH(franvarotemp.FRAN) < MONTH(franvarotemp.TILL) THEN DO:              
         ASSIGN regdat1 = franvarotemp.TILL
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2
         regdat2 = regdat2 + 1.     
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.     
      END.
      IF MONTH(franvarotemp.FRAN) LE MONTH(vkdatum) AND MONTH(franvarotemp.TILL) > MONTH(vkdatum) THEN DO:                  
         regdat1 = franvarotemp.TILL.
         regdat2 = regdat1.     
         REPEAT:
            regdat2 = regdat2 - 1.
            IF MONTH(regdat2) < MONTH(regdat1) THEN LEAVE.
         END.
         ASSIGN franvarotemp.TILL = regdat2.
         regdat2 = regdat2 + 1.
         CREATE fbuff.
         BUFFER-COPY franvarotemp TO fbuff.
         ASSIGN
         fbuff.FRAN = regdat2
         fbuff.TILL = regdat1.    
      END.
      GET NEXT fq NO-LOCK.
   END.      
 
END PROCEDURE.
PROCEDURE utexcel_UI :
   DEFINE INPUT PARAMETER typsnitt AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER storlek AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER varde AS CHARACTER NO-UNDO.
   IF varde = "" THEN RETURN.
   IF varde = ? THEN RETURN.
   ASSIGN
   chWorkSheet:Range(cRange):Font:NAME = typsnitt NO-ERROR.
   chWorkSheet:Range(cRange):Font:SIZE = storlek  NO-ERROR.
   chWorkSheet:Range(cRange):Value = varde NO-ERROR.  
   {EXCELFEL.I}
END PROCEDURE.

