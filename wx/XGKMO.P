DEFINE VARIABLE RAD AS INTEGER NO-UNDO.
DEFINE VARIABLE uttagsatt AS INTEGER NO-UNDO.
MESSAGE "DLETE START".
FOR EACH KOSTREG WHERE KOSTREG.BOKKONTO = "Uttag" :
   DELETE KOSTREG.
END.
MESSAGE "DLETE KLAR".
FOR EACH BERBEST WHERE  BERBEST.OFFERT = FALSE NO-LOCK BY AONR:
   IF BERBEST.UTTAG = TRUE THEN uttagsatt = 1.
   ELSE uttagsatt = -1.
   DO TRANSACTION:
      FIND FIRST KOSTREG WHERE KOSTREG.AONR = BERBEST.AONR AND KOSTREG.DELNR = BERBEST.DELNR AND 
      KOSTREG.KOSTAUTO = TRUE AND KOSTREG.FAKTURERAD = ? AND
      KOSTREG.BOKKONTO = "Uttag" AND 
      YEAR(KOSTREG.REGDATUM) = YEAR(BERBEST.Bestdatum) AND MONTH(KOSTREG.REGDATUM) = MONTH(BERBEST.Bestdatum)
      EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE KOSTREG THEN DO:         
         FIND LAST KOSTREG WHERE KOSTREG.AONR = BERBEST.AONR AND 
         KOSTREG.DELNR = BERBEST.DELNR
         USE-INDEX KOST NO-LOCK NO-ERROR.  
         rad = 1.                                                                      
         IF AVAILABLE KOSTREG THEN rad = KOSTREG.RADNR + 1.          
         CREATE KOSTREG.
         ASSIGN  
         KOSTREG.RADNR = rad
         KOSTREG.AONR = BERBEST.AONR
         KOSTREG.DELNR = BERBEST.DELNR.
      END.
      ASSIGN
      KOSTREG.REGDATUM = DATE(MONTH(BERBEST.Bestdatum),01,YEAR(BERBEST.Bestdatum))
      KOSTREG.BETDATUM = DATE(MONTH(BERBEST.Bestdatum),01,YEAR(BERBEST.Bestdatum))
      KOSTREG.BENAMNING = "Uttag från depå"
      KOSTREG.BOKKONTO = "Uttag"
      KOSTREG.FAKTNR = ""
      KOSTREG.FAKTURERAD = ?
      KOSTREG.LEVKOD = "10"
      SUBSTRING(KOSTREG.ANVANDARE,1,12) = SUBSTRING(BERBEST.BESTALLARE,1,12)
      KOSTREG.KOSTAUTO = TRUE. 
      VALIDATE KOSTREG.                  
      ASSIGN KOSTREG.MTRL = KOSTREG.MTRL + uttagsatt * (BERBEST.PRIS * BERBEST.ANTAL * 1.2).          
   END.
END.
MESSAGE "KLAR" VIEW-AS ALERT-BOX.
