/*ANDFASTIGUAPP.P*/
{FASTIGHET.I}
{SOKDEF.I}

DEFINE VARIABLE FILL-IN_BETECKNING AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_KOMMUN     AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_SOCKEN     AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_LAN        AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_ANAMN      AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN-ANMARK     AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_APERNR     AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_AADRESS    AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_APONR      AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_APADRESS   AS CHARACTER NO-UNDO.
DEFINE VARIABLE FILL-IN_ARRENDATOR AS LOGICAL NO-UNDO.


PROCEDURE ladda.
   DEFINE OUTPUT PARAMETER TABLE FOR pakerregtemp.
   DEFINE OUTPUT PARAMETER TABLE FOR vskogregtemp.
   DEFINE OUTPUT PARAMETER TABLE FOR volskogtemp.
   DEFINE OUTPUT PARAMETE TABLE FOR akervardtemp.
   EMPTY TEMP-TABLE pakerregtemp NO-ERROR. 
   EMPTY TEMP-TABLE vskogregtemp NO-ERROR. 
   EMPTY TEMP-TABLE volskogtemp NO-ERROR. 
   EMPTY TEMP-TABLE akervardtemp NO-ERROR. 

   FOR EACH PAKERREG NO-LOCK:
      CREATE pakerregtemp.
      BUFFER-COPY PAKERREG TO pakerregtemp.   
   END.
   FOR EACH VSKOGREG NO-LOCK.
      CREATE vskogregtemp.
      BUFFER-COPY VSKOGREG TO vskogregtemp.   
   END.
   FOR EACH VOLSKOG NO-LOCK:
      CREATE volskogtemp.
      BUFFER-COPY VOLSKOG TO volskogtemp.   
   END.
   FOR EACH AKERVARD NO-LOCK:
      CREATE akervardtemp.
      BUFFER-COPY AKERVARD TO akervardtemp.   
   END.   
   
END PROCEDURE.

PROCEDURE test.
   DEFINE OUTPUT PARAMETER fildir AS character.
   fildir = SESSION:TEMP-DIRECTORY + "gurubest" + "\".
   
END PROCEDURE.      .
     
   /*{SESSIONTEMPDIR.I}
   IF SESSION:CLIENT-TYPE = "WEBCLIENT" THEN fildir = webclienttempdir.*/



PROCEDURE klar.
   DEFINE INPUT-OUTPUT PARAMETER fastighbet AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR valsoktemp.
   DEFINE INPUT PARAMETER CMB_GOMRTALL AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER CMB_GOMRGRAN AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER CMB_PAKER AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER CMB_VSKOG AS CHARACTER NO-UNDO. 
   DEFINE OUTPUT PARAMETER TABLE FOR fastighettemp.
   EMPTY TEMP-TABLE fastighettemp NO-ERROR. 
   FIND FIRST valsoktemp NO-LOCK NO-ERROR.
   ASSIGN 
   FILL-IN_BETECKNING =  valsoktemp.SOKCHAR[1]
   FILL-IN_KOMMUN     =  valsoktemp.SOKCHAR[2]
   FILL-IN_SOCKEN     =  valsoktemp.SOKCHAR[3]
   FILL-IN_LAN        =  valsoktemp.SOKCHAR[4]
   FILL-IN_ANAMN      =  substring(valsoktemp.SOKCHAR[5],1,30)
   FILL-IN-ANMARK     =  valsoktemp.SOKCHAR[10]
   FILL-IN_APERNR     =  valsoktemp.SOKCHAR[6]
   FILL-IN_AADRESS    =  valsoktemp.SOKCHAR[7]
   FILL-IN_APONR      =  valsoktemp.SOKCHAR[8]
   FILL-IN_APADRESS   = valsoktemp.SOKCHAR[9]
   FILL-IN_ARRENDATOR = valsoktemp.SOKLOG[1].   
   DELETE valsoktemp. 
   DO TRANSACTION:
      FIND FIRST FASTIGHET WHERE FASTIGHET.BETECKNING = fastighbet EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE FASTIGHET THEN DO:
         CREATE FASTIGHET.
      END.      
      ASSIGN
      FASTIGHET.BETECKNING = FILL-IN_BETECKNING
      FASTIGHET.KOMMUN  =  FILL-IN_KOMMUN
      FASTIGHET.SOCKEN  =  FILL-IN_SOCKEN
      FASTIGHET.VAKER  =  FILL-IN_LAN      
      FASTIGHET.ARRENDATOR  =  FILL-IN_ARRENDATOR.
      IF FASTIGHET.ARRENDATOR = TRUE THEN DO: 
         ASSIGN
         SUBSTRING(FASTIGHET.ANAMN,1)  =  SUBSTRING(FILL-IN_ANAMN,1,30)
         SUBSTRING(FASTIGHET.ANAMN,31,80)  =  FILL-IN-ANMARK
         FASTIGHET.APERNR  =  FILL-IN_APERNR
         FASTIGHET.AADRESS  =  FILL-IN_AADRESS
         FASTIGHET.APONR  =  FILL-IN_APONR
         FASTIGHET.APADRESS  =  FILL-IN_APADRESS.
      END.
      ELSE DO:
         ASSIGN
         SUBSTRING(FASTIGHET.ANAMN,1)  =  "                              "
         SUBSTRING(FASTIGHET.ANAMN,31,80)  =  SUBSTRING(FILL-IN-ANMARK,1,80)
         FASTIGHET.APERNR  =  "0000000000"
         FASTIGHET.AADRESS  =  ""
         FASTIGHET.APONR  =  ""
         FASTIGHET.APADRESS  =  "".
      END.     
      ASSIGN
      /*FASTIGHET.VAKER  = CMB_VAKER*/
      FASTIGHET.GOMRTALL  = CMB_GOMRTALL
      FASTIGHET.GOMRGRAN  = CMB_GOMRGRAN.
      FIND FIRST PAKERREG WHERE PAKERREG.BENAMNING = CMB_PAKER USE-INDEX PRODOMR NO-LOCK NO-ERROR.
      IF AVAILABLE PAKERREG THEN DO:
         ASSIGN FASTIGHET.PAKER  = PAKERREG.PRODOMR.
      END.
      FIND FIRST VSKOGREG WHERE VSKOGREG.BENAMNING = CMB_VSKOG USE-INDEX VARDOMR NO-LOCK NO-ERROR.
      IF AVAILABLE VSKOGREG THEN DO:
         ASSIGN FASTIGHET.VSKOG  = VSKOGREG.VARDOMR.
      END.
      CREATE fastighettemp.
      BUFFER-COPY FASTIGHET TO fastighettemp.
      ASSIGN fastighbet = FILL-IN_BETECKNING.

   END.
   RELEASE FASTIGHET NO-ERROR.

END PROCEDURE.

PROCEDURE kontakt.
   DEFINE INPUT PARAMETER manr AS INTEGER NO-UNDO.
   DEFINE OUTPUT PARAMETER mnamn AS CHARACTER.
   mnamn = "".
   FIND FIRST MARKAGARE WHERE MARKAGARE.MARKNR = manr NO-LOCK NO-ERROR.
   IF AVAILABLE MARKAGARE THEN DO:
      mnamn = MARKAGARE.MARKAGARE.
   END.

END PROCEDURE.

PROCEDURE fastkoll_UI.
   DEFINE INPUT PARAMETER fastighbet AS CHARACTER NO-UNDO.   
   DEFINE OUTPUT PARAMETER finns AS LOGICAL.
   finns = FALSE.
   FIND FIRST FASTIGHET WHERE FASTIGHET.BETECKNING = fastighbet NO-LOCK NO-ERROR.
   IF AVAILABLE FASTIGHET THEN DO:
      finns = TRUE.
   END.

END PROCEDURE.
