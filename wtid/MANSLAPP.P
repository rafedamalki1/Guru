/*MANSLAPP.P*/
{TIDUTTTNEW.I}
DEFINE INPUT PARAMETER CMB_TAR AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER CMB_TMANAD AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER pkod AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER borjdat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER avdat AS DATE NO-UNDO.
DEFINE OUTPUT PARAMETER TABLE FOR tidut.
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{GLOBVAR2DEL1.I}
{REGVAR.I}
FIND FIRST FORETAG NO-LOCK NO-ERROR.
ASSIGN
bdatum = borjdat
avdatum = avdat
Guru.Konstanter:globforetag  = FORETAG.FORETAG.
RUN STYRFORE.P (INPUT Guru.Konstanter:globforetag).
DEFINE NEW SHARED VARIABLE tillrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE varansf LIKE ANSTFORMTAB.KOD NO-UNDO. 
DEFINE NEW SHARED VARIABLE varberav LIKE BERKOD.BEREDSKAPSAVTAL NO-UNDO.
DEFINE NEW SHARED VARIABLE vartraktav LIKE TRAKTATAB.TRAAVTAL NO-UNDO.
DEFINE NEW SHARED VARIABLE perssokrec AS RECID NO-UNDO.  
DEFINE NEW SHARED VARIABLE tidtabrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE bustart3 LIKE TIDREGITAB.START NO-UNDO. 
DEFINE NEW SHARED VARIABLE fnytid AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE TEMP-TABLE tidsedel         
   FIELD ENHET LIKE LONTILL.ENHET 
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD ORT LIKE AONRTAB.ORT   
   FIELD BERANTAL LIKE TIDREGITAB.BERANTAL 
   FIELD BEREDSKAP LIKE TIDREGITAB.BEREDSKAP 
   FIELD DAG LIKE TIDREGITAB.DAG 
   FIELD DATUM LIKE TIDREGITAB.DATUM 
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD ENFLERDAGS LIKE TIDREGITAB.ENFLERDAGS 
   FIELD GODKAND LIKE TIDREGITAB.GODKAND
   FIELD VECKOKORD LIKE TIDREGITAB.VECKOKORD 
   FIELD LONAUTO LIKE TIDREGITAB.LONAUTO 
   FIELD LONTILLAGG LIKE TIDREGITAB.LONTILLAGG 
   FIELD LONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD OVERTIDUTTAG LIKE TIDREGITAB.OVERTIDUTTAG
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL   
   FIELD OVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD OANT1 LIKE TIDREGITAB.OANT1 
   FIELD OANT2 LIKE TIDREGITAB.OANT2 
   FIELD OANT3 LIKE TIDREGITAB.OANT3 
   FIELD OKOD1 LIKE TIDREGITAB.OKOD1 
   FIELD OKOD2 LIKE TIDREGITAB.OKOD2 
   FIELD OKOD3 LIKE TIDREGITAB.OKOD3    
   FIELD OVERAUTO LIKE TIDREGITAB.OVERAUTO 
   FIELD RECTIDVIS LIKE TIDREGITAB.RECTIDVIS 
   FIELD RESMAL LIKE TIDREGITAB.RESMAL 
   FIELD SLUT LIKE TIDREGITAB.SLUT 
   FIELD START LIKE TIDREGITAB.START 
   FIELD TOTALT LIKE TIDREGITAB.TOTALT
   FIELD TOTALT1 LIKE TIDREGITAB.TOTALT
   FIELD TRAKTKOD LIKE TIDREGITAB.TRAKTKOD 
   FIELD TRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL 
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER  
   FIELD ENKEL LIKE OVERKOD.ENKEL    
   FIELD UTRYCKNING LIKE TIDREGITAB.UTRYCKNING 
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD BILFORARE LIKE TIDREGITAB.BILFORARE 
   FIELD AVDRAG LIKE LONTILL.ERSATTNING 
   FIELD ENY AS LOGICAL INITIAL FALSE  
   INDEX PSTART IS PRIMARY  DATUM START SLUT ASCENDING
   INDEX PVNR VECKONUMMER ASCENDING.
DEFINE TEMP-TABLE veckotemp 
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   INDEX VECKO IS PRIMARY VECKONUMMER.
DEFINE TEMP-TABLE bertemp    
   FIELD BEREDSKAP LIKE BERKOD.BEREDSKAP 
   FIELD LONKODTEXT LIKE BERKOD.LONKODTEXT
   FIELD ENHET LIKE BERKOD.ENHET  
   FIELD BERANTAL LIKE TIDREGITAB.BERANTAL
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD DELNR LIKE TIDREGITAB.DELNR
   INDEX BERE IS PRIMARY BEREDSKAP. 
DEFINE TEMP-TABLE lontemp    
   FIELD LONTILLAGG LIKE LONTILL.LONTILLAGG 
   FIELD LONKODTEXT LIKE LONTILL.LONKODTEXT
   FIELD ENHET LIKE LONTILL.ENHET
   FIELD LONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD DELNR LIKE TIDREGITAB.DELNR
   INDEX LON IS PRIMARY LONTILLAGG.  
DEFINE TEMP-TABLE traktemp    
   FIELD TRAKTKOD LIKE TRAKTATAB.TRAKTKOD 
   FIELD LONKODTEXT LIKE TRAKTATAB.FORKL
   FIELD ENHET LIKE LONTILL.ENHET
   FIELD TRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD DELNR LIKE TIDREGITAB.DELNR
   INDEX TRAAVTAL IS PRIMARY TRAKTKOD.
DEFINE TEMP-TABLE tidtemp    
   FIELD TOTALT AS DECIMAL
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD ORT LIKE AONRTAB.ORT  
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD OVERANTAL AS DECIMAL
   FIELD OVERTIDUTTAG LIKE TIDREGITAB.OVERTIDUTTAG
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL
   FIELD ENKEL LIKE OVERKOD.ENKEL 
   FIELD KOMPANTAL AS DECIMAL 
   FIELD ENKELANTAL AS DECIMAL 
   FIELD KVALANTAL AS DECIMAL   
   INDEX AONR IS PRIMARY AONR DELNR.      
DEFINE TEMP-TABLE overtemp    
   FIELD TOTALT AS DECIMAL
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD ORT LIKE AONRTAB.ORT  
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD OVERANTAL AS DECIMAL
   FIELD OVERTIDUTTAG LIKE TIDREGITAB.OVERTIDUTTAG
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL 
   FIELD ENKEL LIKE OVERKOD.ENKEL  
   FIELD MULTIP LIKE OVERKOD.MULTIP            
   FIELD LONKODTEXT LIKE OVERKOD.LONKODTEXT 
   FIELD ENHET LIKE LONTILL.ENHET
   FIELD KOMPANTAL AS DECIMAL
   FIELD ENKELANTAL AS DECIMAL
   FIELD KVALANTAL AS DECIMAL
   INDEX AONR IS PRIMARY AONR DELNR
   INDEX OVER OVERTIDTILL.
DEFINE TEMP-TABLE resovertemp    
   FIELD TOTALT AS DECIMAL
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD ORT LIKE AONRTAB.ORT  
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD OVERANTAL AS DECIMAL
   FIELD OVERTIDUTTAG LIKE TIDREGITAB.OVERTIDUTTAG
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL 
   FIELD ENKEL LIKE OVERKOD.ENKEL  
   FIELD MULTIP LIKE OVERKOD.MULTIP            
   FIELD LONKODTEXT LIKE OVERKOD.LONKODTEXT 
   FIELD ENHET LIKE LONTILL.ENHET
   FIELD KOMPANTAL AS DECIMAL
   FIELD ENKELANTAL AS DECIMAL
   FIELD KVALANTAL AS DECIMAL
   INDEX AONR IS PRIMARY AONR DELNR
   INDEX OVER OVERTIDTILL.                             
DEFINE BUFFER sedelbuff FOR tidsedel.    
DEFINE TEMP-TABLE overtidhj  
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD VECKOKORD LIKE TIDREGITAB.VECKOKORD  
   FIELD OVERTIDUTTAG LIKE TIDREGITAB.OVERTIDUTTAG
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL   
   FIELD OVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD OVERAUTO LIKE TIDREGITAB.OVERAUTO
   FIELD MANAD AS INTEGER
   FIELD MULTIP AS DECIMAL
   FIELD KOMPANTAL AS decimal
   FIELD ANTMULT AS DECIMAL
   FIELD KOMPUTTAG AS DECIMAL
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL. 

         
DEFINE TEMP-TABLE ftemp   
   FIELD DATUM AS DATE
   FIELD DAG AS CHARACTER
   FIELD OSTART AS DECIMAL 
   FIELD OSLUT AS DECIMAL
   FIELD FSTART AS DECIMAL 
   FIELD FSLUT AS DECIMAL 
   FIELD MKFLEX AS INTEGER
   FIELD MKTFLEX AS DECIMAL
   FIELD TFLEX AS INTEGER
   FIELD TOTFLEX AS DECIMAL
   FIELD LFLEX AS DECIMAL
   FIELD MFLEX AS DECIMAL
   FIELD KFLEX AS DECIMAL.
   
DEFINE TEMP-TABLE oversum   
   FIELD MANAD AS INTEGER
   FIELD OVERANTAL AS DECIMAL
   FIELD ANTMULT AS DECIMAL   
   FIELD KOMPUTTAG AS DECIMAL
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL.       
DEFINE TEMP-TABLE overksum LIKE  oversum.
    
DEFINE TEMP-TABLE overhela   
   FIELD KOMP1 AS DECIMAL
   FIELD KOMP2 AS DECIMAL
   FIELD KOMP3 AS DECIMAL
   FIELD KOMP4 AS DECIMAL
   FIELD KOMP5 AS DECIMAL
   FIELD KOMP6 AS DECIMAL
   FIELD KOMP7 AS DECIMAL
   FIELD KOMP8 AS DECIMAL
   FIELD KOMP9 AS DECIMAL
   FIELD KOMP10 AS DECIMAL
   FIELD KOMP11 AS DECIMAL
   FIELD KOMP12 AS DECIMAL
   FIELD KOMPTOT AS DECIMAL
   FIELD KOMPUT1 AS DECIMAL
   FIELD KOMPUT2 AS DECIMAL
   FIELD KOMPUT3 AS DECIMAL
   FIELD KOMPUT4 AS DECIMAL
   FIELD KOMPUT5 AS DECIMAL
   FIELD KOMPUT6 AS DECIMAL
   FIELD KOMPUT7 AS DECIMAL
   FIELD KOMPUT8 AS DECIMAL
   FIELD KOMPUT9 AS DECIMAL
   FIELD KOMPUT10 AS DECIMAL
   FIELD KOMPUT11 AS DECIMAL
   FIELD KOMPUT12 AS DECIMAL
   FIELD KOMPUTTOT AS DECIMAL
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL.     
      

DEFINE VARIABLE kompsum AS DECIMAL NO-UNDO.                   
DEFINE VARIABLE arrtidsum AS DECIMAL NO-UNDO.
DEFINE VARIABLE restidsum AS DECIMAL NO-UNDO.   
DEFINE VARIABLE frantidsum AS DECIMAL NO-UNDO.
DEFINE VARIABLE overenk AS DECIMAL NO-UNDO.
DEFINE VARIABLE overkval AS DECIMAL NO-UNDO.
DEFINE VARIABLE adrsum LIKE LONTILL.ERSATTNING NO-UNDO.  
DEFINE VARIABLE beren AS CHARACTER FORMAT "X(5)" NO-UNDO. 
DEFINE VARIABLE str AS CHARACTER FORMAT "X(140)" NO-UNDO.
DEFINE VARIABLE startdatum AS DATE NO-UNDO.
DEFINE VARIABLE slutdatum AS DATE NO-UNDO. 
DEFINE VARIABLE tidao LIKE AONRTAB.AONR NO-UNDO.
DEFINE VARIABLE tiddelnr LIKE AONRTAB.DELNR NO-UNDO. 
DEFINE VARIABLE tidove LIKE OVERKOD.OVERTIDTILL NO-UNDO.
DEFINE VARIABLE berraknare AS INTEGER NO-UNDO.
DEFINE VARIABLE bermax AS INTEGER NO-UNDO.  
DEFINE VARIABLE bersummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE lonraknare AS INTEGER NO-UNDO.    
DEFINE VARIABLE lonsummax AS INTEGER NO-UNDO.   
DEFINE VARIABLE trasummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE traraknare AS INTEGER NO-UNDO.   
DEFINE VARIABLE ovesummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE overaknare AS INTEGER NO-UNDO. 
DEFINE VARIABLE sekunder1 AS INTEGER FORMAT "-9999999" NO-UNDO.   
DEFINE VARIABLE sekunder2 AS INTEGER FORMAT "-9999999" NO-UNDO.  
DEFINE VARIABLE sekunder3 AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE hjvnr AS INTEGER FORMAT "999" NO-UNDO.   
DEFINE VARIABLE hjvnr2 AS INTEGER FORMAT "999" NO-UNDO.  
DEFINE VARIABLE arnr AS INTEGER FORMAT "9999" NO-UNDO. 
DEFINE VARIABLE manadnr AS INTEGER FORMAT "99" NO-UNDO.   
DEFINE VARIABLE godktid AS LOGICAL NO-UNDO.  
DEFINE VARIABLE arrhjsum LIKE TIDREGITAB.BERANTAL NO-UNDO.                   
DEFINE VARIABLE luft AS INTEGER NO-UNDO.
DEFINE VARIABLE luft1 AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE VARIABLE par8 AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE VARIABLE regvnrspar AS INTEGER FORMAT "999" NO-UNDO.
DEFINE VARIABLE atltot AS INTEGER NO-UNDO.
DEFINE VARIABLE fdatum AS DATE NO-UNDO.
DEFINE VARIABLE fltid AS INTEGER NO-UNDO.
DEFINE VARIABLE kolldatum AS DATE NO-UNDO.
DEFINE VARIABLE lufl AS INTEGER NO-UNDO.
DEFINE VARIABLE lunorm AS INTEGER NO-UNDO.
DEFINE VARIABLE seku AS INTEGER NO-UNDO.
DEFINE VARIABLE plflex AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE VARIABLE flextot LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE VARIABLE debkred AS INTEGER FORMAT "-9" NO-UNDO.
DEFINE VARIABLE ejover AS LOGICAL NO-UNDO.
DEFINE VARIABLE hjstart LIKE TIDREGITAB.START NO-UNDO.  
DEFINE VARIABLE hjslut LIKE TIDREGITAB.SLUT NO-UNDO.   
DEFINE VARIABLE ehjstart LIKE TIDREGITAB.START NO-UNDO.  
DEFINE VARIABLE eover AS INTEGER NO-UNDO.
DEFINE VARIABLE spregdat AS DATE NO-UNDO.
DEFINE VARIABLE ftro AS LOGICAL NO-UNDO.
DEFINE VARIABLE rtidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE ftidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE ordarbman AS DECIMAL NO-UNDO.
DEFINE VARIABLE otidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE visstdat AS DATE NO-UNDO.
DEFINE VARIABLE vissldat AS DATE NO-UNDO.
DEFINE VARIABLE mbdatum AS DATE NO-UNDO.
DEFINE VARIABLE mavdatum AS DATE NO-UNDO.
DEFINE VARIABLE acckompvman  AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompvmandat AS DATE NO-UNDO.
DEFINE VARIABLE acckompsenast AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompsenasttot AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompsenastdat AS DATE NO-UNDO.
DEFINE VARIABLE komplog AS LOGICAL NO-UNDO.
DEFINE VARIABLE kompapph AS HANDLE NO-UNDO.
DEFINE VARIABLE berkomp AS DECIMAL NO-UNDO.
DEFINE VARIABLE hjdat AS DATE NO-UNDO.
DEFINE VARIABLE heltidtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE valdheltidtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE kompaonr AS CHARACTER NO-UNDO.
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.
{EXTRADATA.I}
RUN EXTRADATAHMT.P PERSISTENT SET edataapph.

FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):

  RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.

END FUNCTION.
FUNCTION klock60 RETURNS DECIMAL
  ( INPUT ber100 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  TRUNCATE(ber100,0) + ((ber100 - TRUNCATE(ber100,0)) * 60 / 100 ).

END FUNCTION.


DEFINE QUERY tidq FOR TIDREGITAB.
RUN noll_UI.                     
arnr = CMB_TAR.       
IF CMB_TMANAD = STRING("januari") THEN manadnr = 1.
ELSE IF CMB_TMANAD = STRING("februari") THEN manadnr = 2.      
ELSE IF CMB_TMANAD = STRING("mars") THEN manadnr = 3.      
ELSE IF CMB_TMANAD = STRING("april") THEN manadnr = 4. 
ELSE IF CMB_TMANAD = STRING("maj") THEN manadnr = 5.
ELSE IF CMB_TMANAD = STRING("juni") THEN manadnr = 6.
ELSE IF CMB_TMANAD = STRING("juli") THEN manadnr = 7.
ELSE IF CMB_TMANAD = STRING("augusti") THEN manadnr = 8.
ELSE IF CMB_TMANAD = STRING("september") THEN manadnr = 9.
ELSE IF CMB_TMANAD = STRING("oktober") THEN manadnr = 10.
ELSE IF CMB_TMANAD = STRING("november") THEN manadnr = 11.
ELSE IF CMB_TMANAD = STRING("december") THEN manadnr = 12.

ASSIGN
tidtabrec = 0.   
FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod NO-LOCK NO-ERROR.
Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + PERSONALTAB.PERSONALKOD.
Guru.GlobalaVariabler:GDPRtyp = "TI".
{GDPRLOGGCLIENT.I}
persrec = RECID(PERSONALTAB).
IF CMB_TMANAD = "hela året" THEN DO:
   mbdatum = DATE(01,01,arnr).   
   FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = pkod AND TIDREGITAB.DATUM < DATE(12,31,arnr) USE-INDEX PKOD NO-LOCK NO-ERROR.  
   IF AVAILABLE TIDREGITAB THEN mavdatum  = TIDREGITAB.DATUM .
   ELSE mavdatum  = DATE(12,31,arnr). 
   IF YEAR(TODAY) > YEAR(mavdatum) THEN mavdatum  = DATE(12,31,arnr).          
END.
ELSE DO:
   mbdatum = DATE(manadnr,01,arnr).
   IF manadnr = 12 THEN  mavdatum  = DATE(12,31,arnr).           
   ELSE mavdatum = DATE(manadnr + 1,01,arnr) - 1 .
END.      

RUN avtal_UI.              
RUN tolk_UI.
  
PROCEDURE avtal_UI : 
   FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE= PERSONALTAB.OMRADE
   USE-INDEX OMR NO-LOCK NO-ERROR.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
   USE-INDEX ANSTF NO-LOCK NO-ERROR.
   ASSIGN 
   varansf = ANSTFORMTAB.KOD
   varberav = PERSONALTAB.BEREDSKAPSAVTAL 
   vartraktav = PERSONALTAB.TRAAVTAL.
   FIND FIRST UTRYCKNING WHERE UTRYCKNING.KOD = ANSTFORMTAB.KOD USE-INDEX UT
   NO-LOCK NO-ERROR. 
   FIND FIRST BEREDSKAPTAB WHERE BEREDSKAPTAB.BEREDSKAPSAVTAL = 
   PERSONALTAB.BEREDSKAPSAVTAL USE-INDEX BERED NO-LOCK NO-ERROR.
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL > 0 THEN beren = "ANTAL".
      ELSE beren = "TI MI".          
   END.
   ELSE beren = "TI MI".           
   FIND FIRST ORDARB WHERE ORDARB.ANSTALLNING = PERSONALTAB.ANSTALLNING 
   USE-INDEX ORDARB NO-LOCK NO-ERROR.
   IF AVAILABLE ORDARB THEN DO TRANSACTION:      
      sekunder = ORDARB.START1.
      RUN SEKTIM.P.
      ASSIGN
      hjstart = nytid
      ehjstart = hjstart.
      IF ORDARB.OBKOD NE "" THEN DO:
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV"  OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:         
            FIND FIRST FLEXAVT WHERE FLEXAVT.PERSONALKOD = PERSONALTAB.PERSONALKOD NO-LOCK NO-ERROR.
            FIND FIRST FLEXREG WHERE FLEXREG.KOD = FLEXAVT.FLEXKOD NO-LOCK NO-ERROR.
         END.
         ELSE DO:         
            FIND FIRST FLEXREG WHERE FLEXREG.KOD = ANSTFORMTAB.KOD NO-LOCK NO-ERROR.
         END.
         IF NOT AVAILABLE FLEXREG THEN DO:
            FIND FIRST FLEXREG WHERE FLEXREG.KOD = "" NO-LOCK NO-ERROR.
         END.      
         IF AVAILABLE FLEXREG THEN DO:
            IF MONTH(regdatum) > MONTH(FLEXREG.SOMMARST) AND MONTH(regdatum) < MONTH(FLEXREG.SOMMARSL) THEN DO:               
               ASSIGN hjslut = DECIMAL(ORDARB.OBKOD).
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.               
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD = "TU" THEN hjstart = ehjstart.
               
               IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.                              
               
               IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.                                              
            END.
            ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARSL) AND DAY(regdatum) <= DAY(FLEXREG.SOMMARSL) THEN DO:
               ASSIGN hjslut = DECIMAL(ORDARB.OBKOD).
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD = "TU" THEN hjstart = ehjstart.
               
               IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.                              
                    
               IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.                                
            END.
            ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARST) AND DAY(regdatum) >= DAY(FLEXREG.SOMMARST) THEN DO: 
               ASSIGN hjslut = DECIMAL(ORDARB.OBKOD).
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.
               IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD = "TU" THEN hjstart = ehjstart.
               
               IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.                              
                              
               IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN hjstart = 7.30.               
               /*IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD = "KV" THEN hjstart = 7.30.*/               
            END.
            ELSE DO:
               sekunder = ORDARB.STOPP1.
               RUN SEKTIM.P.
               hjslut = nytid.                   
            END. 
         END. 
         ELSE DO:
            sekunder = ORDARB.STOPP1.
            RUN SEKTIM.P.
            hjslut = nytid.            
         END.  
      END. 
      ELSE DO:
         sekunder = ORDARB.STOPP1.
         RUN SEKTIM.P.
         hjslut = nytid.         
      END.   
   END.  
END PROCEDURE.

PROCEDURE beredskap_UI :
   ASSIGN     
   arrhjsum = 0  
   berraknare = 0.
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL = 0 THEN DO:
         FOR EACH tidsedel BY tidsedel.BEREDSKAP:
            IF tidsedel.BERANTAL = 0 THEN NEXT.
            nytid = tidsedel.BERANTAL.
            RUN TIMSEK.P.
            ASSIGN tidsedel.BERANTAL = sekunder.         
         END.      
      END.   
   END.
   
 FOR EACH tidsedel BREAK BY tidsedel.BEREDSKAP:      
      ACCUMULATE tidsedel.BERANTAL (TOTAL BY tidsedel.BEREDSKAP).
      IF LAST-OF(tidsedel.BEREDSKAP) THEN DO:
         CREATE bertemp.
         ASSIGN 
         bertemp.BERANTAL = (ACCUM TOTAL BY tidsedel.BEREDSKAP tidsedel.BERANTAL)        
         bertemp.BEREDSKAP = tidsedel.BEREDSKAP.   
      END.
   END.     
 
   
   FOR EACH bertemp WHERE bertemp.BEREDSKAP = "":
      DELETE bertemp.         
   END.             
   berraknare = 0.                                       
END PROCEDURE.

PROCEDURE huvud_UI :
   CREATE tidut. 
   ASSIGN
   SUBSTRING(tidut.UT,4) = "TIDFÖRDELNING FÖR TJÄNSTESTÄLLE:"
   SUBSTRING(tidut.UT,40) = OMRADETAB.NAMN     
   SUBSTRING(tidut.UT,60) = STRING(TODAY)
   SUBSTRING(tidut.UT,70) = STRING(TIME,"HH:MM:SS").
   CREATE tidut.  
   ASSIGN
   SUBSTRING(tidut.UT,4) = "NAMN:"
   SUBSTRING(tidut.UT,10) = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN.   
   IF Guru.Konstanter:globforetag = "GKAL" THEN musz = musz.
   ELSE SUBSTRING(tidut.UT,60) = STRING(PERSONALTAB.PERSONNUMMER,"999999-9999").
   ASSIGN
   SUBSTRING(tidut.UT,72) = "SIGN:"
   SUBSTRING(tidut.UT,78) = PERSONALTAB.PERSONALKOD.  
   CREATE tidut.               
   IF CMB_TMANAD = "hela året" THEN DO:
      SUBSTRING(tidut.UT,4) = "FÖR SAMTLIGA TIDSEDLAR UNDER ÅR " + STRING(arnr).
   END.
   ELSE DO:
      ASSIGN
      SUBSTRING(tidut.UT,4) = "MÅNADSSAMMANSTÄLLNING FÖR" + " " + CAPS(CMB_TMANAD) + " " + STRING(CMB_TAR).      
   END.
   IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
      RUN FINNSTABELL.P (INPUT "KOMPSALDO", OUTPUT komplog).
      IF komplog = TRUE THEN DO:   
         IF NOT VALID-HANDLE(kompapph) THEN RUN KOMPSMANTAB.P PERSISTENT SET kompapph.
         IF VALID-HANDLE(kompapph) THEN DO:
            DEBUGGER:SET-BREAK().
            RUN viskompsal IN kompapph (INPUT PERSONALTAB.PERSONALKOD, INPUT avdatum, OUTPUT acckompvman, OUTPUT acckompvmandat, OUTPUT acckompsenast,  OUTPUT acckompsenastdat).
            FIND FIRST overksum WHERE NO-LOCK NO-ERROR.
            IF AVAILABLE overksum THEN DO:                              
              acckompsenasttot  = klock60( acckompsenast + overksum.ANTMULT - overksum.KOMPUTTAG ).              
            END.   
            ELSE acckompsenasttot  = klock60( acckompsenast).
            IF acckompsenasttot NE 0 THEN DO:
               CREATE tidut.
               ASSIGN
               SUBSTRING(tidut.UT,4) = "Totalt kompsaldo:"
               SUBSTRING(tidut.UT,24) = STRING(acckompsenasttot,"->>9.99").
               CREATE tidut.
               ASSIGN                                                    
               SUBSTRING(tidut.UT,4) = "Inarbetad el uttagen komp sedan månadskörning:".
               IF AVAILABLE overksum THEN SUBSTRING(tidut.UT,75) = STRING(klock60(overksum.ANTMULT - overksum.KOMPUTTAG),"->>9.99").
               ELSE SUBSTRING(tidut.UT,75) = STRING(0,"->>9.99"). 
               IF berkomp > 0 THEN DO:
                  CREATE tidut.
                  ASSIGN
                  SUBSTRING(tidut.UT,4) = "Varav kompsaldo pga lart 260- Fyllnadslön mot ledighet vid beredskap:".
                  SUBSTRING(tidut.UT,75) = STRING(klock60(berkomp),"->>9.99").
               END.      
            END.       
            CREATE tidut.
         END.
      END.
   END.
   
   IF Guru.Konstanter:globforetag = "CGKAL" THEN DO:
      
      IF CMB_TMANAD = "hela året" THEN DO:
         hjdat = DATE(01,01,arnr).       
      END.
      ELSE DO:
         hjdat = DATE(manadnr,01,arnr).                 
      END.      
      ASSIGN
      valdheltidtim = 0
      heltidtim = 0.
      REPEAT:
         IF CMB_TMANAD = "hela året" THEN DO:
            IF hjdat > DATE(12,31,arnr) THEN LEAVE.       
         END.
         ELSE DO:
            IF manadnr = 12 THEN DO:
               IF hjdat > DATE(12,31,arnr)  THEN LEAVE.
            END.   
            ELSE IF hjdat > DATE(manadnr + 1,01,arnr) - 1 THEN LEAVE.                 
         END.                 
         ASSIGN
         regdatum = hjdat.
         RUN REGDAG.P.
         RUN REGVEC.P.
         pkod = PERSONALTAB.PERSONALKOD.
         /*SPECIALPROGRAM som räknar ut arbetstid för veckoscheman 5 och 15 med avvikelsekalender och sommartid*/
         RUN UFSLFLARBW.P 
         (INPUT-OUTPUT pkod,INPUT-OUTPUT regstart,INPUT-OUTPUT regslut, 
         INPUT-OUTPUT regvnr,INPUT-OUTPUT regdagnamn,INPUT-OUTPUT regdatum, 
         INPUT-OUTPUT regtotalt,INPUT-OUTPUT frustarten,INPUT-OUTPUT fruslutet, 
         INPUT-OUTPUT kaffestart,INPUT-OUTPUT kaffeslut,INPUT-OUTPUT lunchstarten,
         INPUT-OUTPUT lunchslutet,INPUT-OUTPUT nytid,INPUT-OUTPUT sekunder).
         heltidtim = heltidtim + klock100(regtotalt).              
         hjdat = hjdat + 1.
      END.
      CREATE tidut.
      IF CMB_TMANAD = "hela året" THEN DO:
         SUBSTRING(tidut.UT,4) = "Årsarbetstid :".
         SUBSTRING(tidut.UT,20) = STRING(heltidtim).
      END.
      ELSE DO:
         ASSIGN
         SUBSTRING(tidut.UT,4) = "Månadens normalarbetstid:".
         SUBSTRING(tidut.UT,30) = STRING(heltidtim).                 
      END.
   END.         
   CREATE tidut.                                          
   CREATE tidut.                                  
   ASSIGN
   SUBSTRING(tidut.UT,1) = CAPS(Guru.Konstanter:gaok)
   SUBSTRING(tidut.UT,12) = "ORT"     
   SUBSTRING(tidut.UT,33) = "NORMAL"
   SUBSTRING(tidut.UT,41) = "ÖVERTID"
   SUBSTRING(tidut.UT,49) = "ÖVERTID"
   SUBSTRING(tidut.UT,57) = "SUMMA"
   SUBSTRING(tidut.UT,65) = "RESTID"   
   SUBSTRING(tidut.UT,72) = "KOMPTID"     
   SUBSTRING(tidut.UT,80) = "FRÅNVARO".  
   CREATE tidut.                            
   ASSIGN                             
   SUBSTRING(tidut.UT,33) = "ARBTID"
   SUBSTRING(tidut.UT,41) = "ENKEL"
   SUBSTRING(tidut.UT,49) = "KVAL"
   SUBSTRING(tidut.UT,57) = "TIMMAR".  
   str =                                                                                                                            
   "==========.====================.=======.=======.=======.=======.======.=======.========.".             
   CREATE tidut.                  
   ASSIGN
   SUBSTRING(tidut.UT,1) = str.   
END PROCEDURE.

PROCEDURE lontill_UI :
   ASSIGN 
   lonraknare = 0
   arrhjsum = 0.  
   FOR EACH tidsedel BY tidsedel.LONTILLAGG:
      IF tidsedel.LONTILLANTAL = 0 THEN NEXT.      
      FIND FIRST LONTILL WHERE LONTILL.KOD = varansf AND LONTILL.LONTILLAGG = tidsedel.LONTILLAGG      
      USE-INDEX LONTIL NO-LOCK NO-ERROR.
      IF LONTIL.ENHET = "TI" THEN DO:
         nytid = tidsedel.LONTILLANTAL.
         RUN TIMSEK.P.
         ASSIGN tidsedel.LONTILLANTAL = sekunder
         tidsedel.ENHET = LONTILL.ENHET.  
      END.
      ELSE DO:
         FIND FIRST MALTAB WHERE MALTAB.AVDRAGSKOD = tidsedel.LONTILLAGG
         USE-INDEX MALTAB NO-LOCK NO-ERROR.
         IF AVAILABLE MALTAB THEN DO:                           
            tidsedel.AVDRAG = tidsedel.LONTILLANTAL * LONTILL.ERSATTNING.               
         END.           
      END.          
   END.
   IF  Guru.Konstanter:globforetag = "GKAL" THEN DO:       
      FOR EACH tidsedel BREAK BY tidsedel.LONTILLAGG BY tidsedel.AONR BY tidsedel.DELNR:      
         ACCUMULATE tidsedel.LONTILLANTAL (TOTAL BY tidsedel.LONTILLAGG BY tidsedel.AONR BY tidsedel.DELNR).  
         ACCUMULATE tidsedel.AVDRAG (TOTAL BY tidsedel.LONTILLAGG BY tidsedel.AONR BY tidsedel.DELNR). 
         IF LAST-OF(tidsedel.DELNR) THEN DO:
            CREATE lontemp.      
            ASSIGN
            adrsum = (ACCUM  TOTAL BY tidsedel.DELNR tidsedel.AVDRAG)
            lontemp.LONTILLANTAL = (ACCUM TOTAL BY tidsedel.DELNR tidsedel.LONTILLANTAL)                     
            lontemp.LONTILLAGG = tidsedel.LONTILLAGG  
            lontemp.ENHET = tidsedel.ENHET
            lontemp.AONR = tidsedel.AONR
            lontemp.DELNR = tidsedel.DELNR.  
         END.
     END.         
   END.
   ELSE DO:
      FOR EACH tidsedel BREAK BY tidsedel.LONTILLAGG:      
         ACCUMULATE tidsedel.LONTILLANTAL (TOTAL BY tidsedel.LONTILLAGG).  
         ACCUMULATE tidsedel.AVDRAG (TOTAL BY tidsedel.LONTILLAGG). 
         IF LAST-OF(tidsedel.LONTILLAGG) THEN DO:
            CREATE lontemp.      
            ASSIGN
            adrsum = (ACCUM TOTAL tidsedel.AVDRAG)
            lontemp.LONTILLANTAL = (ACCUM TOTAL BY tidsedel.LONTILLAGG tidsedel.LONTILLANTAL)         
            lontemp.LONTILLAGG = tidsedel.LONTILLAGG  
            lontemp.ENHET = tidsedel.ENHET.  
         END.
     END.         
   END.  
   FOR EACH lontemp WHERE lontemp.LONTILLANTAL = 0:
      DELETE lontemp.
   END.  
                                                            
END PROCEDURE.

PROCEDURE noll_UI :
   EMPTY TEMP-TABLE tidut NO-ERROR. 
   EMPTY TEMP-TABLE tidsedel NO-ERROR. 
   EMPTY TEMP-TABLE overtidhj  NO-ERROR. 
   EMPTY TEMP-TABLE veckotemp  NO-ERROR. 
   EMPTY TEMP-TABLE bertemp  NO-ERROR. 
   EMPTY TEMP-TABLE lontemp NO-ERROR. 
   EMPTY TEMP-TABLE traktemp NO-ERROR. 
   EMPTY TEMP-TABLE tidtemp NO-ERROR. 
   EMPTY TEMP-TABLE overtemp  NO-ERROR.    
   ASSIGN      
   berraknare = 0
   bermax = 0  
   bersummax = 0 
   lonraknare = 0    
   lonsummax = 0   
   trasummax = 0 
   traraknare = 0   
   ovesummax = 0 
   overaknare = 0 
   sekunder1 = 0   
   sekunder2 = 0  
   sekunder3 = 0    
   arrhjsum = 0                      
   luft = 0
   luft1 = 0.       
                                  
END PROCEDURE.

PROCEDURE overtill_UI :
   ASSIGN   
   luft = 0  
   luft1 = 0 
   overaknare = 0  
   arrhjsum = 0.  
      
   DEBUGGER:SET-BREAK().
   FOR EACH tidsedel:
      ASSIGN 
      sekunder = 0
      sekunder1 = 0
      sekunder2 = 0
      sekunder3 = 0.          
      IF tidsedel.PRISTYP NE "FRÅNVARO." THEN DO:   
         IF tidsedel.PRISTYP NE "RESTID..." THEN DO:
            IF tidsedel.OANT1 > 0  THEN DO:      
               CREATE overtidhj.         
               nytid = tidsedel.OANT1.
               RUN TIMSEK.P.
               sekunder1 = sekunder. 
               ASSIGN 
               overtidhj.AONR = tidsedel.AONR
               overtidhj.DELNR = tidsedel.DELNR
               overtidhj.VECKOKORD = tidsedel.VECKOKORD  
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG  
               overtidhj.OVERANTAL = sekunder
               overtidhj.KOMPANTAL = klock100(tidsedel.OANT1) 
               overtidhj.OVERTIDTILL = tidsedel.OKOD1
               overtidhj.OVERAUTO = tidsedel.OVERAUTO
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG
               overtidhj.MANAD = MONTH(tidsedel.DATUM)
               overtidhj.MULTIP = 1.
               FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = tidsedel.OKOD1 AND OVERKOD.KOD = varansf USE-INDEX OVER NO-LOCK NO-ERROR.
               IF AVAILABLE  OVERKOD THEN DO:                                               
                  IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj.MULTIP = OVERKOD.MULTIP.
                  ELSE overtidhj.MULTIP =  OVERKOD.ERSATTNING.
               END.
               /*overtidhj.ANTMULT = (1 + overtidhj.MULTIP) * overtidhj.KOMPANTAL.*/               
               IF tidsedel.OVERTIDUTTAG = "K" THEN DO: 
                  overtidhj.ANTMULT = (1 + overtidhj.MULTIP) * overtidhj.KOMPANTAL.
                  overtidhj.VERKKO = overtidhj.KOMPANTAL.
               END.
               IF tidsedel.OVERTIDUTTAG = "Ö" THEN DO:                   
                  overtidhj.VERKOV = overtidhj.KOMPANTAL.
               END.
                                                    
            END. 
            IF tidsedel.OANT2 > 0  THEN DO:      
               CREATE overtidhj.
               nytid = tidsedel.OANT2.
               RUN TIMSEK.P.
               sekunder2 = sekunder. 
               ASSIGN 
               overtidhj.AONR = tidsedel.AONR
               overtidhj.DELNR = tidsedel.DELNR
               overtidhj.VECKOKORD = tidsedel.VECKOKORD
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG 
               overtidhj.OVERANTAL = sekunder 
               overtidhj.KOMPANTAL = klock100(tidsedel.OANT2)
               overtidhj.OVERTIDTILL = tidsedel.OKOD2
               overtidhj.OVERAUTO = tidsedel.OVERAUTO
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG
               overtidhj.MANAD = MONTH(tidsedel.DATUM)
               overtidhj.MULTIP = 1.                        
               FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = tidsedel.OKOD2 AND OVERKOD.KOD = varansf USE-INDEX OVER NO-LOCK NO-ERROR.
               IF AVAILABLE  OVERKOD THEN DO:                                               
                  IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj.MULTIP = OVERKOD.MULTIP.
                  ELSE overtidhj.MULTIP =  OVERKOD.ERSATTNING.
               END.          
               IF tidsedel.OVERTIDUTTAG = "K" THEN DO: 
                  overtidhj.ANTMULT = (1 + overtidhj.MULTIP) * overtidhj.KOMPANTAL.
                  overtidhj.VERKKO = overtidhj.KOMPANTAL.
               END.
               IF tidsedel.OVERTIDUTTAG = "Ö" THEN DO:                   
                  overtidhj.VERKOV = overtidhj.KOMPANTAL.
               END.
            END.                    
            IF tidsedel.OANT3 > 0  THEN DO:      
               CREATE overtidhj.
               nytid = tidsedel.OANT3.
               RUN TIMSEK.P.
               sekunder3 = sekunder. 
               ASSIGN 
               overtidhj.AONR = tidsedel.AONR
               overtidhj.DELNR = tidsedel.DELNR
               overtidhj.VECKOKORD = tidsedel.VECKOKORD
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG 
               overtidhj.OVERANTAL = sekunder 
               overtidhj.KOMPANTAL = klock100(tidsedel.OANT3)
               overtidhj.OVERTIDTILL = tidsedel.OKOD3
               overtidhj.OVERAUTO = tidsedel.OVERAUTO
               overtidhj.OVERTIDUTTAG = tidsedel.OVERTIDUTTAG
               overtidhj.MANAD = MONTH(tidsedel.DATUM)
               overtidhj.MULTIP = 1.                          
               FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = tidsedel.OKOD3 AND OVERKOD.KOD = varansf USE-INDEX OVER NO-LOCK NO-ERROR.
               IF AVAILABLE  OVERKOD THEN DO:                                               
                  IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj.MULTIP = OVERKOD.MULTIP.
                  ELSE overtidhj.MULTIP =  OVERKOD.ERSATTNING.
               END.                
               IF tidsedel.OVERTIDUTTAG = "K" THEN DO: 
                  overtidhj.ANTMULT = (1 + overtidhj.MULTIP) * overtidhj.KOMPANTAL.
                  overtidhj.VERKKO = overtidhj.KOMPANTAL.
               END.
               IF tidsedel.OVERTIDUTTAG = "Ö" THEN DO:                   
                  overtidhj.VERKOV = overtidhj.KOMPANTAL.
               END.
            END.
         END.
      END.
      /*LUFT*/ 
      IF UTRYCKNING.PARA8 = TRUE AND tidsedel.UTRYCKNING = TRUE AND 
      tidsedel.OVERAUTO = TRUE THEN DO:         
         IF tidsedel.OANT1 = 0 AND tidsedel.OANT2 = 0 AND tidsedel.OANT3 = 0
         THEN nytid = nytid.
         ELSE DO:
            luft = luft + ((sekunder1 + sekunder2 + sekunder3) - tidsedel.TOTALT1).            
         END.
      END. 
      ELSE IF UTRYCKNING.PARA8 = TRUE AND 
      tidsedel.OVERAUTO = TRUE THEN DO:         
         IF tidsedel.OANT1 = 0 AND tidsedel.OANT2 = 0 AND tidsedel.OANT3 = 0
         THEN nytid = nytid.
         ELSE DO:            
            luft = luft + ((sekunder1 + sekunder2 + sekunder3) - tidsedel.TOTALT1).
         END.
      END. 
   END.
   /*intjänad och uttagen komp månadsvis  Lena 20161129*/
   IF Guru.Konstanter:globforetag = "GKAL" THEN kompaonr = "171".
   ELSE kompaonr = "170".
   FOR EACH tidsedel WHERE tidsedel.AONR = kompaonr  NO-LOCK.   
      CREATE overtidhj.                          
      ASSIGN                                                         
      overtidhj.MANAD = MONTH(tidsedel.DATUM).
      overtidhj.VECKOKORD = tidsedel.VECKOKORD.
      overtidhj.KOMPUTTAG = klock100(tidsedel.TOTALT).         
      overtidhj.MULTIP = 1.              
   END.  
   IF Guru.Konstanter:globforetag = "snat" THEN DO:
      /*berdskapstolkning när veckvila inträffar under klämdag genererar lart 260 = Fyllnadslön mot ledighet vid beredskap Lena 20190611*/         
      FOR EACH tidsedel WHERE tidsedel.LONTILLAGG = "260":   
         CREATE overtidhj.                
         ASSIGN          
         overtidhj.VECKOKORD = tidsedel.VECKOKORD
         overtidhj.OVERANTAL = klock100(tidsedel.LONTILLANTAL) 
         overtidhj.OVERTIDTILL = tidsedel.LONTILLAGG
         overtidhj.ANTMULT =  overtidhj.OVERANTAL
         overtidhj.OVERTIDUTTAG = "K"         
         overtidhj.MULTIP = 0
         overtidhj.VERKKO = 0.                     
      END.
      /*berdskapstolkning klämdagar halvdagar genererar lart 260 = Fyllnadslön mot ledighet vid beredksp Lena 20190611*/      
      FOR EACH tidsedel WHERE tidsedel.BEREDSKAP = "260":         
         CREATE overtidhj.                
         ASSIGN          
         overtidhj.VECKOKORD = tidsedel.VECKOKORD
         overtidhj.OVERANTAL = klock100(tidsedel.BERANTAL) 
         overtidhj.OVERTIDTILL = tidsedel.BEREDSKAP
         overtidhj.ANTMULT =  overtidhj.OVERANTAL
         overtidhj.OVERTIDUTTAG = "K"         
         overtidhj.MULTIP = 0         
         /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena */               
         overtidhj.VERKKO = 0.
               
      END.
   END.
   
   FOR EACH overtidhj /*WHERE overtidhj.OVERTIDUTTAG = "K"*/ BREAK  BY overtidhj.MANAD:                  
      ACCUMULATE overtidhj.ANTMULT (TOTAL  BY overtidhj.MANAD).
      ACCUMULATE overtidhj.KOMPUTTAG (TOTAL BY overtidhj.MANAD).
      ACCUMULATE overtidhj.VERKKO (TOTAL BY overtidhj.MANAD).
      ACCUMULATE overtidhj.VERKOV (TOTAL BY overtidhj.MANAD).                   
      IF LAST-OF(overtidhj.MANAD) THEN DO:      
         CREATE oversum.
         ASSIGN                          
         oversum.MANAD =   overtidhj.MANAD.                                   
         oversum.ANTMULT = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.ANTMULT).
         oversum.KOMPUTTAG = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.KOMPUTTAG).     
         oversum.VERKKO = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.VERKKO).
         oversum.VERKOV = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.VERKOV).
                                                
      END.
   END.
      
   FOR EACH oversum   :       
      FIND FIRST overhela NO-ERROR.
      IF NOT AVAILABLE overhela  THEN DO:
         CREATE overhela.                  
      END.                                    
      overhela.KOMPTOT = overhela.KOMPTOT + oversum.ANTMULT.
      overhela.KOMPUTTOT = overhela.KOMPUTTOT + oversum.KOMPUTTAG.
      overhela.VERKKO = overhela.VERKKO + oversum.VERKKO.
      overhela.VERKOV = overhela.VERKOV + oversum.VERKOV.      
      IF oversum.MANAD  = 1 THEN ASSIGN overhela.KOMP1 = oversum.ANTMULT   overhela.KOMPUT1 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 2 THEN ASSIGN overhela.KOMP2 = oversum.ANTMULT   overhela.KOMPUT2 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 3 THEN ASSIGN overhela.KOMP3 = oversum.ANTMULT   overhela.KOMPUT3 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 4 THEN ASSIGN overhela.KOMP4 = oversum.ANTMULT   overhela.KOMPUT4 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 5 THEN ASSIGN overhela.KOMP5 = oversum.ANTMULT   overhela.KOMPUT5 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 6 THEN ASSIGN overhela.KOMP6 = oversum.ANTMULT   overhela.KOMPUT6 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 7 THEN ASSIGN overhela.KOMP7 = oversum.ANTMULT   overhela.KOMPUT7 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 8 THEN ASSIGN overhela.KOMP8 = oversum.ANTMULT   overhela.KOMPUT8 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 9 THEN ASSIGN overhela.KOMP9 = oversum.ANTMULT   overhela.KOMPUT9 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 10 THEN ASSIGN overhela.KOMP10 = oversum.ANTMULT   overhela.KOMPUT10 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 11 THEN ASSIGN overhela.KOMP11 = oversum.ANTMULT   overhela.KOMPUT11 = oversum.KOMPUTTAG.
      IF oversum.MANAD  = 12 THEN ASSIGN overhela.KOMP12 = oversum.ANTMULT   overhela.KOMPUT12 = oversum.KOMPUTTAG.
   END.
   /*TA BARA MED EJ KÖRDA LART 260  resten går in i KOMPSALDO vid körning*/
   berkomp = 0.   
   FOR EACH overtidhj WHERE overtidhj.VECKOKORD = "" AND overtidhj.OVERTIDTILL = "260":
      berkomp = berkomp + overtidhj.OVERANTAL.   
   END.
   /*ej körd kompsaldo*/
   EMPTY TEMP-TABLE overksum NO-ERROR. 
   FOR EACH overtidhj WHERE overtidhj.VECKOKORD = ""  BREAK BY overtidhj.MANAD:    
      ACCUMULATE overtidhj.OVERANTAL (TOTAL  BY overtidhj.MANAD).        
      ACCUMULATE overtidhj.ANTMULT (TOTAL  BY overtidhj.MANAD).
      ACCUMULATE overtidhj.KOMPUTTAG (TOTAL  BY overtidhj.MANAD).
      ACCUMULATE overtidhj.VERKKO (TOTAL  BY overtidhj.MANAD).
      ACCUMULATE overtidhj.VERKOV (TOTAL  BY overtidhj.MANAD).              
      IF LAST-OF(overtidhj.MANAD) THEN DO:      
         CREATE overksum.                         
         overksum.OVERANTAL = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.OVERANTAL).                  
         overksum.ANTMULT = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.ANTMULT).
         overksum.KOMPUTTAG = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.KOMPUTTAG).
         overksum.VERKKO = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.VERKKO).
         overksum.VERKOV = (ACCUM TOTAL BY overtidhj.MANAD overtidhj.VERKOV).                                             
      END.
   END.
      
   /*intjänad uttagen komp*/
   arrhjsum = 0.    
   FOR EACH overtidhj WHERE overtidhj.OVERANTAL = 0:
      DELETE overtidhj.
   END.   
   FOR EACH overtidhj WHERE overtidhj.OVERAUTO = FALSE:
      FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = overtidhj.OVERTIDTILL AND
      OVERKOD.KOD = varansf  USE-INDEX OVER NO-LOCK NO-ERROR.
      IF AVAILABLE OVERKOD THEN DO:
         ASSIGN overtidhj.OVERTIDUTTAG = OVERKOD.OVERTIDUTTAG.
      END.
   END.    
   FOR EACH overtidhj BREAK BY overtidhj.AONR BY overtidhj.DELNR 
   BY overtidhj.OVERTIDTILL BY overtidhj.OVERTIDUTTAG:     
      ACCUMULATE overtidhj.OVERANTAL (TOTAL BY overtidhj.AONR BY overtidhj.DELNR 
      BY overtidhj.OVERTIDTILL BY overtidhj.OVERTIDUTTAG).
      IF LAST-OF(overtidhj.OVERTIDUTTAG) THEN DO:
         CREATE overtemp.
         ASSIGN   
         overtemp.AONR = overtidhj.AONR
         overtemp.DELNR = overtidhj.DELNR  
         overtemp.OVERTIDUTTAG = overtidhj.OVERTIDUTTAG     
         overtemp.OVERANTAL = (ACCUM TOTAL overtidhj.OVERANTAL) - arrhjsum         
         overtemp.OVERTIDUTTAG = overtidhj.OVERTIDUTTAG  
         overtemp.OVERTIDTILL = overtidhj.OVERTIDTILL            
         arrhjsum = ACCUM TOTAL overtidhj.OVERANTAL.                                          
      END.
   END.  
                                
   sekunder = luft.
   RUN SEKTIM.P.
   luft1 = nytid.

                   
                                            
END PROCEDURE.

&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE skaptidsed_UI WINDOW-2 
PROCEDURE skaptidsed_UI :
   EMPTY TEMP-TABLE ftemp NO-ERROR. 
   ASSIGN
   regvnr = 0  
   godktid = FALSE
   fdatum = ?
   ejover = FALSE
   eover = 0
   rtidman = 0
   ftidman = 0      
   otidman = 0.
   IF PERSONALTAB.OVERTIDUTTAG = "I" THEN ejover = TRUE.
   /*Förtroendetid*/   
   /*förtroendetid   kalmar skriver fritt tid*/      
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
   ftro = FALSE.
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "FORTRO"                   
   inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.            
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
   IF AVAILABLE extradatatemp THEN DO:      
     ftro = extradatatemp.SOKLOG[1].         
   END.   
   ELSE ftro = FALSE.
   IF CMB_TMANAD = "hela året" THEN DO:
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE 
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDREGITAB.DATUM) = arnr USE-INDEX PSTART NO-LOCK.
   END.
   ELSE DO: 
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE 
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDREGITAB.DATUM) = arnr AND MONTH(TIDREGITAB.DATUM) = manadnr USE-INDEX PSTART NO-LOCK.
   END.
   GET FIRST tidq NO-LOCK. 
   IF AVAILABLE TIDREGITAB THEN tidtabrec = RECID(TIDREGITAB). 
   ELSE godktid = TRUE.
   DO WHILE AVAILABLE(TIDREGITAB):         
      CREATE tidsedel.
      ASSIGN
      tidsedel.AONR = TIDREGITAB.AONR 
      tidsedel.BERANTAL = TIDREGITAB.BERANTAL 
      tidsedel.BEREDSKAP = TIDREGITAB.BEREDSKAP 
      tidsedel.DAG = TIDREGITAB.DAG 
      tidsedel.DATUM = TIDREGITAB.DATUM 
      tidsedel.DELNR = TIDREGITAB.DELNR 
      tidsedel.ENFLERDAGS = TIDREGITAB.ENFLERDAGS 
      tidsedel.GODKAND = TIDREGITAB.GODKAND
      tidsedel.VECKOKORD = TIDREGITAB.VECKOKORD 
      tidsedel.LONAUTO = TIDREGITAB.LONAUTO 
      tidsedel.LONTILLAGG = TIDREGITAB.LONTILLAGG 
      tidsedel.LONTILLANTAL = TIDREGITAB.LONTILLANTAL 
      tidsedel.OVERTIDUTTAG = TIDREGITAB.OVERTIDUTTAG 
      tidsedel.OANT1 = TIDREGITAB.OANT1 
      tidsedel.OANT2 = TIDREGITAB.OANT2 
      tidsedel.OANT3 = TIDREGITAB.OANT3 
      tidsedel.OKOD1 = TIDREGITAB.OKOD1 
      tidsedel.OKOD2 = TIDREGITAB.OKOD2 
      tidsedel.OKOD3 = TIDREGITAB.OKOD3          
      tidsedel.OVERAUTO = TIDREGITAB.OVERAUTO 
      tidsedel.RECTIDVIS = TIDREGITAB.RECTIDVIS 
      tidsedel.RESMAL = TIDREGITAB.RESMAL 
      tidsedel.SLUT = TIDREGITAB.SLUT 
      tidsedel.START = TIDREGITAB.START 
      tidsedel.TOTALT = TIDREGITAB.TOTALT
      tidsedel.TRAKTKOD = TIDREGITAB.TRAKTKOD 
      tidsedel.TRAKTANTAL = TIDREGITAB.TRAKTANTAL      
      tidsedel.VECKONUMMER = TIDREGITAB.VECKONUMMER
      tidsedel.UTRYCKNING = TIDREGITAB.UTRYCKNING
      tidsedel.PRISTYP = TIDREGITAB.PRISTYP
      tidsedel.BILFORARE = TIDREGITAB.BILFORARE.                   
      IF RECID(TIDREGITAB) = tidtabrec THEN tidtabrec = RECID(tidsedel). 
      IF regvnr NE TIDREGITAB.VECKONUMMER THEN DO:
         regvnr = TIDREGITAB.VECKONUMMER.
         FIND FIRST veckotemp WHERE veckotemp.VECKONUMMER = TIDREGITAB.VECKONUMMER
         USE-INDEX VECKO EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE veckotemp  THEN CREATE veckotemp.
         ASSIGN veckotemp.VECKONUMMER = regvnr.
      END.
      IF ejover = TRUE THEN DO:            
         /*Förtroendetid*/                        
         IF ftro = TRUE THEN DO:
            IF TIDREGITAB.PRISTYP = "RESTID..." THEN.
            ELSE DO:                            
               IF TIDREGITAB.OANT1 = 0 AND TIDREGITAB.OANT2 = 0 AND TIDREGITAB.OANT3 = 0  THEN DO:
                  rtidman =  rtidman +  klock100(TIDREGITAB.TOTALT).                  
                  IF  TIDREGITAB.PRISTYP = "FRÅNVARO." THEN ftidman  =  ftidman + klock100(TIDREGITAB.TOTALT).                                     
               END.
               ELSE  DO:
                  /*övertid*/
                  otidman = otidman + klock100(TIDREGITAB.OANT1) + + klock100(TIDREGITAB.OANT2) + + klock100(TIDREGITAB.OANT3).                                                                                                                                       
               END.      
            END.               
         END.             
         IF ftro = FALSE THEN DO:                        
            spregdat = regdatum.
            regdatum = TIDREGITAB.DATUM.
            RUN avtal_UI.
            IF TIDREGITAB.OVERTIDUTTAG = "I" AND TIDREGITAB.START NE TIDREGITAB.SLUT THEN DO:            
               IF TIDREGITAB.PRISTYP = "RESTID..." THEN.
               ELSE DO:                                    
                  IF TIDREGITAB.DAG = "LÖR" OR TIDREGITAB.DAG = "SÖN" THEN DO:
                     nytid = TIDREGITAB.SLUT.
                     RUN TIMSEK.P.
                     seku = sekunder.
                     nytid = TIDREGITAB.START.
                     RUN TIMSEK.P.
                     sekunder = seku - sekunder.
                     RUN FSEKTIM.P.                               
                     eover = eover + sekunder.                     
                  END.
                  ELSE IF TIDREGITAB.SLUT LE hjstart OR TIDREGITAB.START GE hjslut THEN DO:
                     nytid = TIDREGITAB.SLUT.
                     RUN TIMSEK.P.
                     seku = sekunder.
                     nytid = TIDREGITAB.START.
                     RUN TIMSEK.P.
                     sekunder = seku - sekunder.
                     RUN FSEKTIM.P.                               
                     eover = eover + sekunder.                                          
                  END.
               END.               
            END.
         END.
      END.
      IF CMB_TMANAD = "hela året" THEN musz = musz.
      ELSE DO:         
         IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:                    
            IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.
            IF TIDREGITAB.OVERTIDUTTAG NE "F" THEN musz = musz.
            ELSE IF TIDREGITAB.DATUM NE fdatum THEN DO:                                    
               regdatum = TIDREGITAB.DATUM.
               regvnr = TIDREGITAB.VECKONUMMER.
               pkod = TIDREGITAB.PERSONALKOD.
               RUN SLUTARBW.P 
               (INPUT-OUTPUT pkod,INPUT-OUTPUT regstart,INPUT-OUTPUT regslut, 
               INPUT-OUTPUT regvnr,INPUT-OUTPUT regdagnamn,INPUT-OUTPUT regdatum, 
               INPUT-OUTPUT regtotalt,INPUT-OUTPUT frustarten,INPUT-OUTPUT fruslutet, 
               INPUT-OUTPUT kaffestart,INPUT-OUTPUT kaffeslut,INPUT-OUTPUT lunchstarten,
               INPUT-OUTPUT lunchslutet,INPUT-OUTPUT nytid,INPUT-OUTPUT sekunder). 
               CREATE ftemp.
               ASSIGN
               ftemp.DAG = TIDREGITAB.DAG
               ftemp.DATUM = TIDREGITAB.DATUM
               ftemp.OSTART = regstart
               ftemp.OSLUT = regslut
               ftemp.FSTART = TIDREGITAB.START
               ftemp.FSLUT = TIDREGITAB.SLUT
               fdatum = TIDREGITAB.DATUM.
            END.
            ELSE DO:
               FIND FIRST ftemp WHERE FTEMP.DATUM = TIDREGITAB.DATUM NO-ERROR.  
               ASSIGN
               ftemp.FSLUT = TIDREGITAB.SLUT.
            END.
         END.
      END.
   
      GET NEXT tidq NO-LOCK.
   END.
        
   IF CMB_TMANAD = "hela året" THEN DO:
      OPEN QUERY tidfq FOR EACH TIDFEL WHERE 
      TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDFEL.DATUM) = arnr USE-INDEX PKOD NO-LOCK.
   END.
   ELSE DO: 
      OPEN QUERY tidfq FOR EACH TIDFEL WHERE 
      TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDFEL.DATUM) = arnr AND MONTH(TIDFEL.DATUM) = manadnr USE-INDEX PKOD NO-LOCK.
   END.
   GET FIRST tidfq NO-LOCK. 
   IF AVAILABLE TIDFEL THEN tidtabrec = RECID(TIDFEL). 
   ELSE godktid = TRUE.
   DO WHILE AVAILABLE(TIDFEL):         
      IF TIDFEL.DEBET = FALSE THEN debkred = -1.
      ELSE debkred = 1.
      CREATE tidsedel.
      ASSIGN
      tidsedel.AONR = TIDFEL.AONR 
      tidsedel.BERANTAL = TIDFEL.BERANTAL * debkred
      tidsedel.BEREDSKAP = TIDFEL.BEREDSKAP 
      tidsedel.DAG = TIDFEL.DAG 
      tidsedel.DATUM = TIDFEL.DATUM 
      tidsedel.DELNR = TIDFEL.DELNR 
      tidsedel.ENFLERDAGS = TIDFEL.ENFLERDAGS 
      tidsedel.GODKAND = TIDFEL.GODKAND
      tidsedel.VECKOKORD = TIDFEL.VECKOKORD 
      tidsedel.LONAUTO = TIDFEL.LONAUTO 
      tidsedel.LONTILLAGG = TIDFEL.LONTILLAGG 
      tidsedel.LONTILLANTAL = TIDFEL.LONTILLANTAL * debkred
      tidsedel.OVERTIDUTTAG = TIDFEL.OVERTIDUTTAG 
      tidsedel.OANT1 = TIDFEL.OANT1 * debkred
      tidsedel.OANT2 = TIDFEL.OANT2 * debkred
      tidsedel.OANT3 = TIDFEL.OANT3 * debkred
      tidsedel.OKOD1 = TIDFEL.OKOD1 
      tidsedel.OKOD2 = TIDFEL.OKOD2 
      tidsedel.OKOD3 = TIDFEL.OKOD3          
      tidsedel.OVERAUTO = TIDFEL.OVERAUTO 
      tidsedel.RECTIDVIS = TIDFEL.RECTIDVIS 
      tidsedel.RESMAL = TIDFEL.RESMAL 
      tidsedel.SLUT = TIDFEL.SLUT 
      tidsedel.START = TIDFEL.START 
      tidsedel.TOTALT = TIDFEL.TOTALT  * debkred
      tidsedel.TRAKTKOD = TIDFEL.TRAKTKOD 
      tidsedel.TRAKTANTAL = TIDFEL.TRAKTANTAL * debkred      
      tidsedel.VECKONUMMER = TIDFEL.VECKONUMMER
      tidsedel.UTRYCKNING = TIDFEL.UTRYCKNING
      tidsedel.PRISTYP = TIDFEL.PRISTYP
      tidsedel.BILFORARE = TIDFEL.BILFORARE.                   
      IF RECID(TIDFEL) = tidtabrec THEN tidtabrec = RECID(tidsedel). 
      IF regvnr NE TIDFEL.VECKONUMMER THEN DO:
         regvnr = TIDFEL.VECKONUMMER.
         FIND FIRST veckotemp WHERE veckotemp.VECKONUMMER = TIDFEL.VECKONUMMER
         USE-INDEX VECKO EXCLUSIVE-LOCK NO-ERROR. 
         IF NOT AVAILABLE veckotemp  THEN CREATE veckotemp.
         ASSIGN veckotemp.VECKONUMMER = regvnr.
      END.
               
      GET NEXT tidfq NO-LOCK.
   END.
END PROCEDURE.

PROCEDURE skapaut_UI :
   REPEAT:
      FIND FIRST tidtemp WHERE tidtemp.ORT = "" USE-INDEX AONR NO-ERROR.
      IF NOT AVAILABLE tidtemp THEN LEAVE.
      ASSIGN   
      tidao = tidtemp.AONR
      tiddelnr = tidtemp.DELNR.      
      IF tidtemp.AONR = "" THEN DO:
         ASSIGN tidtemp.ORT = "_". 
         NEXT.
      END.   
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = tidtemp.AONR AND 
      AONRTAB.DELNR = tidtemp.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF NOT AVAILABLE AONRTAB THEN DO:
         FOR EACH tidtemp WHERE tidtemp.AONR = tidao AND tidtemp.DELNR = tiddelnr:
            ASSIGN tidtemp.ORT = CAPS(Guru.Konstanter:gaok) + " FINNS EJ". 
         END. 
         FOR EACH overtemp WHERE overtemp.AONR = tidao AND overtemp.DELNR = tiddelnr:
            ASSIGN overtemp.ORT = CAPS(Guru.Konstanter:gaok) + " FINNS EJ". 
         END.
      END.    
      ELSE DO: 
         FOR EACH tidtemp WHERE tidtemp.AONR = tidao AND tidtemp.DELNR = tiddelnr:
            IF AONRTAB.ORT = "" THEN ASSIGN tidtemp.ORT = "?". 
            ELSE ASSIGN tidtemp.ORT = AONRTAB.ORT. 
         END.  
         FOR EACH overtemp WHERE overtemp.AONR = tidao AND overtemp.DELNR = tiddelnr:
            IF AONRTAB.ORT = "" THEN ASSIGN overtemp.ORT = "?". 
            ELSE ASSIGN overtemp.ORT = AONRTAB.ORT. 
         END.
      END.   
   END.          
   REPEAT:
      FIND FIRST overtemp WHERE overtemp.ORT = "" USE-INDEX AONR NO-ERROR.
      IF NOT AVAILABLE overtemp THEN LEAVE.
      ASSIGN   
      tidao = overtemp.AONR
      tiddelnr = overtemp.DELNR.      
      IF overtemp.AONR = "" THEN DO:
         ASSIGN overtemp.ORT = "_". 
         NEXT.
      END.   
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = overtemp.AONR AND 
      AONRTAB.DELNR = overtemp.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF NOT AVAILABLE AONRTAB THEN DO:
         FOR EACH overtemp WHERE overtemp.AONR = tidao AND overtemp.DELNR = tiddelnr:
            ASSIGN overtemp.ORT = CAPS(Guru.Konstanter:gaok) + " FINNS EJ". 
         END.
      END.    
      ELSE DO:          
         FOR EACH overtemp WHERE overtemp.AONR = tidao AND overtemp.DELNR = tiddelnr:
            IF AONRTAB.ORT = "" THEN ASSIGN overtemp.ORT = "?". 
            ELSE ASSIGN overtemp.ORT = AONRTAB.ORT. 
         END.
      END.   
   END.                                     
   REPEAT:
      FIND FIRST overtemp WHERE overtemp.ENKEL = "" AND overtemp.OVERTIDTILL NE "" 
      USE-INDEX OVER NO-ERROR.
      IF NOT AVAILABLE overtemp THEN LEAVE.  
      tidove = overtemp.OVERTIDTILL.           
      FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = overtemp.OVERTIDTILL AND
      OVERKOD.KOD = varansf 
      USE-INDEX OVER NO-LOCK NO-ERROR.
      IF NOT AVAILABLE OVERKOD THEN DO:
         FOR EACH overtemp WHERE overtemp.OVERTIDTILL = tidove:
            ASSIGN 
            overtemp.LONKODTEXT = ""             
            overtemp.ENKEL = "ENKE"
            overtemp.MULTIP = 1. 
         END.
      END.    
      ELSE DO: 
         FOR EACH overtemp WHERE overtemp.OVERTIDTILL = tidove AND overtemp.LONKODTEXT = "":
            ASSIGN 
            overtemp.OVERTIDTILL = OVERKOD.VILART
            overtemp.LONKODTEXT = OVERKOD.LONKODTEXT
            overtemp.ENHET = OVERKOD.ENHET
            overtemp.ENKEL = OVERKOD.ENKEL.            
            IF Guru.Konstanter:globforetag = "gkal" THEN DO:
               overtemp.MULTIP = OVERKOD.MULTIP. 
            END.
            ELSE DO:            
               overtemp.MULTIP = OVERKOD.ERSATTNING.
            END.
         END.
      END.   
   END.   
   ASSIGN        
   arrhjsum = 0
   overenk = 0
   overkval = 0.            
   FOR EACH overtemp BREAK BY overtemp.ENKEL:      
      ACCUMULATE overtemp.OVERANTAL (TOTAL BY overtemp.ENKEL).
      IF LAST-OF(overtemp.ENKEL) THEN DO:         
         IF overtemp.ENKEL = "ENKE" THEN DO:           
            ASSIGN
            overenk = (ACCUM TOTAL overtemp.OVERANTAL) - arrhjsum
            arrhjsum = (ACCUM TOTAL overtemp.OVERANTAL).
         END.           
         ELSE DO:                                    
            ASSIGN
            overkval = (ACCUM TOTAL overtemp.OVERANTAL) - arrhjsum
            arrhjsum = (ACCUM TOTAL overtemp.OVERANTAL).
         END.                                                                                 
      END.                                            
   END.                                                  
   FOR EACH overtemp:                                             
      IF overtemp.OVERTIDUTTAG = "K" THEN DO:                          
         overtemp.KOMPANTAL = overtemp.OVERANTAL + (overtemp.OVERANTAL * overtemp.MULTIP).
      END.                
      ELSE DO:
        overtemp.KOMPANTAL = 0.   /* ????????????? EJ KOMP PÅ ÖVERTID LENA*/
      END.           
      IF overtemp.ENKEL = "ENKE" THEN DO:      
         overtemp.ENKELANTAL = overtemp.ENKELANTAL + overtemp.OVERANTAL .             
      END.           
      ELSE DO: 
         overtemp.KVALANTAL = overtemp.KVALANTAL + overtemp.OVERANTAL.   
      END.                                    
   END.                
   REPEAT:
      FIND FIRST traktemp WHERE traktemp.LONKODTEXT = "" USE-INDEX TRAAV NO-ERROR.
      IF NOT AVAILABLE traktemp THEN LEAVE.  
      tidove = traktemp.TRAKTKOD.           
      FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = traktemp.TRAKTKOD AND
      TRAKTATAB.TRAAVTAL = vartraktav
      USE-INDEX TRAAV NO-LOCK NO-ERROR.
      IF NOT AVAILABLE TRAKTATAB THEN DO:
         FOR EACH traktemp WHERE traktemp.TRAKTKOD = tidove:
            ASSIGN 
            traktemp.LONKODTEXT = "_".            
         END.
      END.    
      ELSE DO: 
         FOR EACH traktemp WHERE traktemp.TRAKTKOD = tidove AND
         traktemp.LONKODTEXT = "":
            ASSIGN 
            traktemp.TRAKTKOD = TRAKTATAB.VILART
            traktemp.LONKODTEXT = TRAKTATAB.FORKL.             
         END.
      END.   
   END.         
   REPEAT:
      FIND FIRST bertemp WHERE bertemp.LONKODTEXT = "" USE-INDEX BERE NO-ERROR.
      IF NOT AVAILABLE bertemp THEN LEAVE.  
      tidove = bertemp.BEREDSKAP.           
      FIND FIRST BERKOD WHERE BERKOD.BEREDSKAP = bertemp.BEREDSKAP AND
      BERKOD.BEREDSKAPSAVTAL = varberav 
      USE-INDEX BERE NO-LOCK NO-ERROR.
      IF NOT AVAILABLE BERKOD THEN DO:
         FOR EACH bertemp WHERE bertemp.BEREDSKAP = tidove:
            ASSIGN 
            bertemp.LONKODTEXT = "_".            
         END.
      END.    
      ELSE DO: 
         FOR EACH bertemp WHERE bertemp.BEREDSKAP = tidove AND bertemp.LONKODTEXT = "":
            ASSIGN 
            bertemp.BEREDSKAP = BERKOD.VILART
            bertemp.LONKODTEXT = BERKOD.LONKODTEXT
            bertemp.ENHET = BERKOD.ENHET. 
         END.
      END.   
   END.         
   REPEAT:
      FIND FIRST lontemp WHERE lontemp.LONKODTEXT = "" USE-INDEX LON NO-ERROR.
      IF NOT AVAILABLE lontemp THEN LEAVE.  
      tidove = lontemp.LONTILLAGG.           
      FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = lontemp.LONTILLAGG AND
      LONTILL.KOD = varansf 
      USE-INDEX LON NO-LOCK NO-ERROR.
      IF NOT AVAILABLE LONTILL THEN DO:
         FOR EACH lontemp WHERE lontemp.LONTILLAGG = tidove AND lontemp.LONKODTEXT = "":
            ASSIGN 
            lontemp.LONKODTEXT = "_".            
         END.
      END.    
      ELSE DO: 
         FOR EACH lontemp WHERE lontemp.LONTILLAGG = tidove:
            ASSIGN 
            lontemp.LONTILLAGG = LONTILL.VILART
            lontemp.LONKODTEXT = LONTILL.LONKODTEXT
            lontemp.ENHET = LONTILL.ENHET. 
         END.
      END.   
   END. 
   kompsum = 0.        
   FOR EACH overtemp:      
      FIND FIRST tidtemp WHERE tidtemp.AONR = overtemp.AONR AND 
      tidtemp.DELNR = overtemp.DELNR AND tidtemp.PRISTYP NE "RESTID..." NO-LOCK NO-ERROR.
      IF NOT AVAILABLE tidtemp THEN CREATE tidtemp.
      ASSIGN
      tidtemp.AONR = overtemp.AONR  
      tidtemp.DELNR = overtemp.DELNR 
      tidtemp.ORT = overtemp.ORT
      tidtemp.ENKELANTAL = tidtemp.ENKELANTAL + overtemp.ENKELANTAL 
      tidtemp.KVALANTAL = tidtemp.KVALANTAL + overtemp.KVALANTAL 
      tidtemp.KOMPANTAL = tidtemp.KOMPANTAL + overtemp.KOMPANTAL.
      kompsum = kompsum + overtemp.KOMPANTAL.      
   END.       
   
   atltot = 0.
   IF Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:
      FOR EACH lontemp WHERE lontemp.LONTILLAGG = "ATL" :
         atltot = atltot + lontemp.LONTILLANTAL.
      END.      
      IF atltot > 0 THEN DO:
         FIND FIRST tidtemp WHERE tidtemp.AONR = "160" AND 
         tidtemp.DELNR = 0 NO-LOCK NO-ERROR.
         IF NOT AVAILABLE tidtemp THEN CREATE tidtemp.
         ASSIGN
         tidtemp.AONR = "160"
         tidtemp.DELNR = 0
         tidtemp.PRISTYP = "FRÅNVARO."
         tidtemp.ORT = "Arbetstidsförkortning"
         tidtemp.TOTALT = tidtemp.TOTALT + atltot.         
      END.
   END.   
   FOR EACH tidtemp USE-INDEX AONR: 
      IF tidtemp.TOTALT = 0 AND tidtemp.ENKELANTAL = 0 AND tidtemp.KVALANTAL = 0 AND 
      tidtemp.KOMPANTAL = 0 THEN NEXT.               
      CREATE tidut. 
      ASSIGN
      SUBSTRING(tidut.UT,1) = tidtemp.AONR
      SUBSTRING(tidut.UT,8) = STRING(tidtemp.DELNR,Guru.Konstanter:varforetypchar[1]).     
      SUBSTRING(tidut.UT,12) = SUBSTRING(tidtemp.ORT,1,20).
      IF tidtemp.PRISTYP = "FRÅNVARO." THEN DO:            
         IF Guru.Konstanter:globforetag = "NORD" OR Guru.Konstanter:globforetag = 'ESMA' OR Guru.Konstanter:globforetag = 'ESAN' THEN DO:
            IF tidtemp.AONR = "910911" OR tidtemp.AONR = "11" THEN DO:    
               ASSIGN                                             
               sekunder = tidtemp.TOTALT.
               RUN SEKTIM.P.       
               SUBSTRING(tidut.UT,72) = STRING(nytid * -1,"->>9.99").
               kompsum = kompsum + (sekunder * -1).
            END.
         END.          
         ELSE IF  Guru.Konstanter:globforetag = "GKAL"   THEN DO:
            IF tidtemp.AONR = "171" THEN DO:             
               ASSIGN          
               sekunder = tidtemp.TOTALT.
               RUN SEKTIM.P.       
               SUBSTRING(tidut.UT,72) = STRING(nytid * -1,"->>9.99").
               kompsum = kompsum + (sekunder * -1).
            END.
         END. 
         ELSE IF Guru.Konstanter:globforetag = "LULE" OR  Guru.Konstanter:globforetag = "sund" OR Guru.Konstanter:globforetag = "SNAT"  OR Guru.Konstanter:globforetag = "MISV" THEN DO:
            IF tidtemp.AONR = "170" THEN DO:             
               ASSIGN          
               sekunder = tidtemp.TOTALT.
               RUN SEKTIM.P.       
               SUBSTRING(tidut.UT,72) = STRING(nytid * -1,"->>9.99").
               kompsum = kompsum + (sekunder * -1).
            END.
         END. 
         ASSIGN          
         sekunder = tidtemp.TOTALT.
         RUN SEKTIM.P.
         SUBSTRING(tidut.UT,80) = STRING(nytid,">>>>9.99").
      END.
      ELSE IF tidtemp.PRISTYP = "RESTID..." THEN  DO:
          ASSIGN          
          sekunder = tidtemp.TOTALT.
          RUN SEKTIM.P.
          SUBSTRING(tidut.UT,65) = STRING(nytid,">>9.99").
      END.
      ELSE DO:  
         IF tidtemp.TOTALT > 0 THEN DO:
            ASSIGN          
            sekunder = tidtemp.TOTALT.
            RUN SEKTIM.P.
            SUBSTRING(tidut.UT,33) = STRING(nytid,">>>9.99").
         END.
         IF (tidtemp.TOTALT + tidtemp.ENKELANTAL + tidtemp.KVALANTAL) > 0 THEN DO: 
            ASSIGN          
            sekunder = tidtemp.TOTALT + tidtemp.ENKELANTAL + tidtemp.KVALANTA.
            RUN SEKTIM.P.      
            SUBSTRING(tidut.UT,57) = STRING(nytid,">>>9.99").
         END. 
      END.
      IF tidtemp.ENKELANTAL > 0 THEN DO:
         ASSIGN          
         sekunder = tidtemp.ENKELANTAL.
         RUN SEKTIM.P.
         SUBSTRING(tidut.UT,41) = STRING(nytid,">>>9.99"). 
      END.
      IF tidtemp.KVALANTAL > 0 THEN DO:
         ASSIGN          
         sekunder = tidtemp.KVALANTAL.
         RUN SEKTIM.P.
         SUBSTRING(tidut.UT,49) = STRING(nytid, ">>>9.99").
      END.
      IF tidtemp.KOMPANTAL > 0 THEN DO:
         ASSIGN          
         sekunder = tidtemp.KOMPANTAL.
         RUN SEKTIM.P.                          
         SUBSTRING(tidut.UT,72) = STRING(nytid,"->>9.99").
      END.
   END.         
   CREATE tidut. 
   ASSIGN 
   tidut.UT = str.
   CREATE tidut.  
   CREATE tidut.                 
   ASSIGN 
   SUBSTRING(tidut.UT,12) = "SUMMA".
   IF arrtidsum > 0 THEN DO:  
      sekunder = arrtidsum.
      RUN SEKTIM.P.      
      SUBSTRING(tidut.UT,33) = STRING(nytid,">>>9.99").
   END.
   IF overenk > 0 THEN  DO:
      sekunder = overenk.
      RUN SEKTIM.P.
      SUBSTRING(tidut.UT,41) = STRING(nytid,">>>9.99").
   END.
   IF overkval > 0 THEN DO:
      sekunder = overkval.
      RUN SEKTIM.P.
      SUBSTRING(tidut.UT,49) = STRING(nytid,">>>9.99").
   END.
   IF arrtidsum + overenk + overkval > 0 THEN do:
      sekunder = arrtidsum + overenk + overkval.
      RUN SEKTIM.P.
      SUBSTRING(tidut.UT,57) = STRING(nytid,">>>9.99").
   END.
   IF restidsum > 0 THEN DO:
      sekunder = restidsum.
      RUN SEKTIM.P.   
      SUBSTRING(tidut.UT,65) = STRING(nytid,">>9.99").
   END.
   IF kompsum NE 0 THEN  DO: 
      IF kompsum > 0 THEN DO:
         ASSIGN          
         sekunder = kompsum.
         RUN SEKTIM.P.
         SUBSTRING(tidut.UT,72) = STRING(nytid,"->>9.99"). 
      END.
      ELSE DO:
         ASSIGN          
         sekunder = kompsum * -1.
         RUN SEKTIM.P.
         SUBSTRING(tidut.UT,72) = STRING(nytid * -1,"->>9.99").
      END.
   END.   
   IF frantidsum > 0 THEN DO:   
      sekunder = frantidsum.
       RUN SEKTIM.P.
      SUBSTRING(tidut.UT,80) = STRING(nytid,">>>>9.99").
   END.
   CREATE tidut.
   ASSIGN 
   tidut.UT = str.
   
   IF CMB_TMANAD = "hela året" THEN DO:
      FIND FIRST overhela  NO-LOCK NO-ERROR.
      IF AVAILABLE overhela THEN DO:
         IF overhela.KOMPTOT = 0 AND overhela.KOMPUTTOT = 0 THEN.
         ELSE DO:
            CREATE tidut.
            CREATE tidut.
            CREATE tidut.
            ASSIGN 
            SUBSTRING(tidut.UT,4) = "Intjänad komp och uttagen komp innevarande år".  
            CREATE tidut.
            ASSIGN 
            SUBSTRING(tidut.UT,4) = "==============================================================".
            
            CREATE tidut.                                                      
            ASSIGN
            SUBSTRING(tidut.UT,4) = "Hela året verklig övertid  - verklig övertid, avrundad till jämna halvtimmar, som den anställde valt att ta ut i pengar. ".
            CREATE tidut.                                                      
            ASSIGN
            SUBSTRING(tidut.UT,4) = "Hela året verklig komp     - verklig övertid, avrundad till jämna halvtimmar, som den anställde valt att ta ut i kompledighet.".
            CREATE tidut.
            CREATE tidut.                                                              
            ASSIGN
            SUBSTRING(tidut.UT,4) = "Intjänad komp - övertid som den anställde valt kompledighet för, multiplicerat med 1,5 för enkel, 2 för kvalificerad kompledighet".
            CREATE tidut.                        
            ASSIGN
            SUBSTRING(tidut.UT,4) = "Uttagen komp  - tid som den anställde valt att ta ut kompensationsledighet. ".
            CREATE tidut.
            CREATE tidut.                       
            ASSIGN
            SUBSTRING(tidut.UT,2) = "Hela"
            SUBSTRING(tidut.UT,9) = "Hela".
            CREATE tidut.                       
            ASSIGN
            SUBSTRING(tidut.UT,2) = "året"
            SUBSTRING(tidut.UT,9) = "året"
            SUBSTRING(tidut.UT,16) = "Komp"
            SUBSTRING(tidut.UT,23) = "Komp"
            SUBSTRING(tidut.UT,30) = "Komp"
            SUBSTRING(tidut.UT,37) = "Komp"
            SUBSTRING(tidut.UT,44) = "Komp"
            SUBSTRING(tidut.UT,51) = "Komp"
            SUBSTRING(tidut.UT,58) = "Komp"
            SUBSTRING(tidut.UT,65) = "Komp"
            SUBSTRING(tidut.UT,72) = "Komp"
            SUBSTRING(tidut.UT,79) = "Komp"
            SUBSTRING(tidut.UT,86) = "Komp"
            SUBSTRING(tidut.UT,93) = "Komp"
            SUBSTRING(tidut.UT,100) = "Komp".
            
            CREATE tidut.                                   
            ASSIGN
            SUBSTRING(tidut.UT,2) = "verklig"
            SUBSTRING(tidut.UT,9) = "verklig"      
            SUBSTRING(tidut.UT,100) = "Hela".
            CREATE tidut.                        
            ASSIGN                            
            SUBSTRING(tidut.UT,2) = "Ötid"
            SUBSTRING(tidut.UT,9) = "Komp"            
            SUBSTRING(tidut.UT,16) = "Jan"
            SUBSTRING(tidut.UT,23) = "Feb"
            SUBSTRING(tidut.UT,30) = "Mars"
            SUBSTRING(tidut.UT,37) = "April"
            SUBSTRING(tidut.UT,44) = "Maj"
            SUBSTRING(tidut.UT,51) = "Juni"
            SUBSTRING(tidut.UT,58) = "Juli"
            SUBSTRING(tidut.UT,65) = "Aug"
            SUBSTRING(tidut.UT,72) = "Sept"
            SUBSTRING(tidut.UT,79) = "Okt"
            SUBSTRING(tidut.UT,86) = "Nov"
            SUBSTRING(tidut.UT,93) = "Dec"
            SUBSTRING(tidut.UT,100) = "Året" .            
            ASSIGN   str=                                                                              
      "======.======.======.======.======.======.======.======.======.======.======.======.======.======.=======.============".
            CREATE tidut.  
            ASSIGN tidut.UT = str.            
            FOR EACH overhela  :            
               CREATE tidut.                              
               IF overhela.VERKOV GE 100 THEN SUBSTRING(tidut.UT,2) = STRING(klock60(overhela.VERKOV),">>9.9").
               ELSE SUBSTRING(tidut.UT,2) = STRING(klock60(overhela.VERKOV),">9.99").
               IF overhela.VERKKO GE 100 THEN SUBSTRING(tidut.UT,9) = STRING(klock60(overhela.VERKKO),">>9.9").
               ELSE SUBSTRING(tidut.UT,9) = STRING(klock60(overhela.VERKKO),">9.99").
               ASSIGN                
               SUBSTRING(tidut.UT,16) = STRING(klock60(overhela.KOMP1),">9.99").
               SUBSTRING(tidut.UT,23) = STRING(klock60(overhela.KOMP2),">9.99").
               SUBSTRING(tidut.UT,30) = STRING(klock60(overhela.KOMP3),">9.99").
               SUBSTRING(tidut.UT,37) = STRING(klock60(overhela.KOMP4),">9.99").
               SUBSTRING(tidut.UT,44) = STRING(klock60(overhela.KOMP5),">9.99").
               SUBSTRING(tidut.UT,51) = STRING(klock60(overhela.KOMP6),">9.99").
               SUBSTRING(tidut.UT,58) = STRING(klock60(overhela.KOMP7),">9.99").
               SUBSTRING(tidut.UT,65) = STRING(klock60(overhela.KOMP8),">9.99").
               SUBSTRING(tidut.UT,72) = STRING(klock60(overhela.KOMP9),">9.99").
               SUBSTRING(tidut.UT,79) = STRING(klock60(overhela.KOMP10),">9.99").
               SUBSTRING(tidut.UT,86) = STRING(klock60(overhela.KOMP11),">9.99").
               SUBSTRING(tidut.UT,93) = STRING(klock60(overhela.KOMP12),">9.99").
               SUBSTRING(tidut.UT,100) = STRING(klock60(overhela.KOMPTOT),">>9.99").
               SUBSTRING(tidut.UT,107) = "Intjänad komp".               
               CREATE tidut.               
               ASSIGN                
               SUBSTRING(tidut.UT,15) = STRING((klock60(overhela.KOMPUT1) * -1),"->9.99").
               SUBSTRING(tidut.UT,22) = STRING((klock60(overhela.KOMPUT2) * -1),"->9.99").
               SUBSTRING(tidut.UT,29) = STRING((klock60(overhela.KOMPUT3) * -1),"->9.99").
               SUBSTRING(tidut.UT,36) = STRING((klock60(overhela.KOMPUT4) * -1),"->9.99").
               SUBSTRING(tidut.UT,43) = STRING((klock60(overhela.KOMPUT5) * -1),"->9.99").
               SUBSTRING(tidut.UT,50) = STRING((klock60(overhela.KOMPUT6) * -1),"->9.99").
               SUBSTRING(tidut.UT,57) = STRING((klock60(overhela.KOMPUT7) * -1),"->9.99").
               SUBSTRING(tidut.UT,64) = STRING((klock60(overhela.KOMPUT8) * -1),"->9.99").
               SUBSTRING(tidut.UT,71) = STRING((klock60(overhela.KOMPUT9) * -1),"->9.99").
               SUBSTRING(tidut.UT,78) = STRING((klock60(overhela.KOMPUT10) * -1),"->9.99").
               SUBSTRING(tidut.UT,85) = STRING((klock60(overhela.KOMPUT11) * -1),"->9.99").
               SUBSTRING(tidut.UT,92) = STRING((klock60(overhela.KOMPUT12) * -1),"->9.99").
               SUBSTRING(tidut.UT,99) = STRING((klock60(overhela.KOMPUTTOT) * -1),"->>9.99").
               SUBSTRING(tidut.UT,107) = "Uttagen komp".                               
            END.   
            CREATE tidut.
            ASSIGN       
            tidut.UT = str.      
            CREATE tidut.
         END.
      END.      
   END.       
   /*nytt*/
   IF ftro = TRUE THEN DO:
      ordarbman = 0.
      /*ordinarie tid mellan första och sista tidregistreringen*/      
      /*ändrat 20141124 om de bara inte har registrerat startdagar i månaden kommer inte ord tid med*/
      assign            
      visstdat = mbdatum
      regdatum = mbdatum.
      FIND FIRST GODKOLL WHERE GODKOLL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND GODKOLL.DATAR = YEAR (mavdatum)
      AND GODKOLL.DATMAN = MONTH(mavdatum) AND GODKOLL.KLAR = TRUE NO-LOCK NO-ERROR.
      IF AVAILABLE GODKOLL  THEN DO:
         vissldat = mavdatum.
      END.
      ELSE DO:                     
         IF MONTH(TODAY) = MONTH(mavdatum) THEN DO:
            FIND LAST tidsedel WHERE NO-LOCK NO-ERROR.
            vissldat =  tidsedel.datum.
         END.
         ELSE vissldat = mavdatum.
      END.                   
      REPEAT:     
         IF regdatum > vissldat THEN LEAVE.             
         RUN REGVEC.P.
         RUN SLUTARB.P.
         ordarbman = ordarbman + klock100(regtotalt).                          
         regdatum = regdatum + 1.
      END.                
   END.      
   /*flexsumma*/
   IF CMB_TMANAD = "hela året" THEN musz = musz.
   ELSE DO:   
      RUN kollflex_UI.
   END.
   IF ejover = TRUE  THEN DO:   
      IF ftro = TRUE THEN DO:
         CREATE tidut.
          CREATE tidut.
         SUBSTRING(tidut.UT,1) = "Förtroendetid " + STRING(CMB_TMANAD).         
         CREATE tidut.
         ASSIGN 
         SUBSTRING(tidut.UT,1) = "=======================".
         CREATE tidut.
         ASSIGN 
         SUBSTRING(tidut.UT,1) = "Ordinarie"
         SUBSTRING(tidut.UT,11) = "Registrerad"
         SUBSTRING(tidut.UT,23) = "Plus"
         SUBSTRING(tidut.UT,33) = "Varav".
         CREATE tidut.
         ASSIGN         
         SUBSTRING(tidut.UT,1) = "arbetstid"
         SUBSTRING(tidut.UT,11) = "tid"
         SUBSTRING(tidut.UT,23) = "tid"
         SUBSTRING(tidut.UT,33) = "Frånvaro"
         SUBSTRING(tidut.UT,44) = "Övertid".         
         CREATE tidut.
         ASSIGN 
         SUBSTRING(tidut.UT,1) = "=========.===========.=========.=========.=========.".
         CREATE tidut.
         ASSIGN
         SUBSTRING(tidut.UT,1) = STRING(klock60(ordarbman),">>99.99")
         SUBSTRING(tidut.UT,11) = STRING(klock60(rtidman),">>99.99")
         SUBSTRING(tidut.UT,21) = STRING(klock60((rtidman - ordarbman)),"->>99.99")
         SUBSTRING(tidut.UT,31) = STRING(klock60(ftidman),">>99.99")
         SUBSTRING(tidut.UT,41) = STRING(klock60(otidman),">>99.99").
         CREATE tidut.
      END.
      ELSE DO:   
         sekunder = eover.
         RUN FSEKTIM.P.             
         CREATE tidut.
         SUBSTRING(tidut.UT,12) = "Ej tolkad övertid".         
         SUBSTRING(tidut.UT,33) = STRING(fnytid,"->>9.99").
         CREATE tidut.
      END.   
   END.
   CREATE tidut.    
   CREATE tidut. 
   ASSIGN  
   SUBSTRING(tidut.UT,12) = "SUMMERING AV TILLÄGG". 
   FOR EACH lontemp BY lontemp.LONTILLAGG:      
      IF lontemp.ENHET NE "TI" THEN NEXT.
      sekunder = lontemp.LONTILLANTAL.
      RUN SEKTIM.P.
      ASSIGN lontemp.LONTILLANTAL = nytid.             
   END. 
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL = 0 THEN DO:
         FOR EACH bertemp:                       
            sekunder = bertemp.BERANTAL.
            RUN SEKTIM.P.
            bertemp.BERANTAL = nytid.         
         END.               
      END.
   END.
   FOR EACH tidsedel WHERE tidsedel.PRISTYP = "RESTID...":
      IF tidsedel.OANT1 > 0  THEN DO:      
          CREATE resovertemp.         
          nytid = tidsedel.OANT1.
          RUN TIMSEK.P.      
          ASSIGN 
          resovertemp.AONR = tidsedel.AONR
          resovertemp.DELNR = tidsedel.DELNR            
          resovertemp.OVERANTAL = sekunder 
          resovertemp.OVERTIDTILL = tidsedel.OKOD1.         
       END.
       IF tidsedel.OANT2 > 0  THEN DO:      
          CREATE resovertemp.         
          nytid = tidsedel.OANT2.
          RUN TIMSEK.P.      
          ASSIGN 
          resovertemp.AONR = tidsedel.AONR
          resovertemp.DELNR = tidsedel.DELNR            
          resovertemp.OVERANTAL = sekunder 
          resovertemp.OVERTIDTILL = tidsedel.OKOD2.         
       END.
       IF tidsedel.OANT3 > 0  THEN DO:      
          CREATE resovertemp.         
          nytid = tidsedel.OANT3.
          RUN TIMSEK.P.      
          ASSIGN 
          resovertemp.AONR = tidsedel.AONR
          resovertemp.DELNR = tidsedel.DELNR            
          resovertemp.OVERANTAL = sekunder 
          resovertemp.OVERTIDTILL = tidsedel.OKOD3.         
       END.             
    END.    
   CREATE tidut.  
   CREATE tidut. 
   ASSIGN 
   SUBSTRING(tidut.UT,12) = "TILLÄGG"
   SUBSTRING(tidut.UT,38) = "LÖNEART"
   SUBSTRING(tidut.UT,46) = "ENHET" 
   SUBSTRING(tidut.UT,52) = "ANTAL".
   IF Guru.Konstanter:globforetag = "GKAL" THEN DO:
      ASSIGN
      SUBSTRING(tidut.UT,63) = "AONR" 
      SUBSTRING(tidut.UT,70) = CAPS(Guru.Konstanter:gdelnrk) .
   END.   
   CREATE tidut. 
   IF  Guru.Konstanter:globforetag = "GKAL" THEN DO:
      ASSIGN 
      SUBSTRING(tidut.UT,12) =                         
      "=========================.=======.=====.==========.======.===".   
   END.
   ELSE DO:
      ASSIGN 
      SUBSTRING(tidut.UT,12) =                         
      "=========================.=======.=====.==========.".   
   END.   
   FOR EACH bertemp:
      IF bertemp.ENHET = "" THEN bertemp.ENHET = "ST".
      CREATE tidut. 
      ASSIGN  
      SUBSTRING(tidut.UT,12,25)= SUBSTRING(bertemp.LONKODTEXT,1,25)
      SUBSTRING(tidut.UT,38) = bertemp.BEREDSKAP
      SUBSTRING(tidut.UT,46) = bertemp.ENHET          
      SUBSTRING(tidut.UT,52) = STRING(bertemp.BERANTAL,"->>>>>9.99").  
      
   END.
   FOR EACH traktemp:
      IF traktemp.ENHET = "" THEN traktemp.ENHET = "ST".
      CREATE tidut. 
      ASSIGN  
      SUBSTRING(tidut.UT,12,25)= SUBSTRING(traktemp.LONKODTEXT,1,25)
      SUBSTRING(tidut.UT,38) = traktemp.TRAKTKOD
      SUBSTRING(tidut.UT,46) = traktemp.ENHET          
      SUBSTRING(tidut.UT,52) = STRING(traktemp.TRAKTANTAL,"->>>>>9.99").  
      
   END.   
    
   
   FOR EACH overtemp BREAK BY overtemp.OVERTIDTILL:     
      ACCUMULATE overtemp.OVERANTAL (TOTAL BY overtemp.OVERTIDTILL).
      IF LAST-OF(overtemp.OVERTIDTILL) THEN DO:
         sekunder = (ACCUM TOTAL BY overtemp.OVERTIDTILL overtemp.OVERANTAL).            
         RUN SEKTIM.P.
         IF overtemp.ENHET = "" THEN overtemp.ENHET = "ST".
         CREATE tidut. 
         ASSIGN  
         SUBSTRING(tidut.UT,12,25)= SUBSTRING(overtemp.LONKODTEXT,1,25)
         SUBSTRING(tidut.UT,38) = overtemp.OVERTIDTILL
         SUBSTRING(tidut.UT,46) = overtemp.ENHET          
         SUBSTRING(tidut.UT,52) = STRING(nytid,"->>>>>9.99").   
      END.
   END.       
   
   FOR EACH resovertemp BREAK BY resovertemp.OVERTIDTILL:          
      ACCUMULATE resovertemp.OVERANTAL (TOTAL BY resovertemp.OVERTIDTILL).
      IF LAST-OF(resovertemp.OVERTIDTILL) THEN DO:            
         CREATE tidut.
         SUBSTRING(tidut.UT,12,25)= "RESTID".
         IF resovertemp.ENHET = "" THEN resovertemp.ENHET = "ST".
         sekunder = (ACCUM TOTAL BY resovertemp.OVERTIDTILL resovertemp.OVERANTAL).            
         RUN SEKTIM.P.
         FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = resovertemp.OVERTIDTILL AND
         OVERKOD.KOD = varansf  USE-INDEX OVER NO-LOCK NO-ERROR.
         IF AVAILABLE OVERKOD THEN DO:            
            ASSIGN  
            SUBSTRING(tidut.UT,12,25)= SUBSTRING(OVERKOD.LONKODTEXT,1,18) + " RESTID"
            SUBSTRING(tidut.UT,46) = OVERKOD.ENHET.
         END.
         ELSE SUBSTRING(tidut.UT,46) = resovertemp.ENHET.
         ASSIGN
         SUBSTRING(tidut.UT,38) = resovertemp.OVERTIDTILL                      
         SUBSTRING(tidut.UT,52) = STRING(nytid,"->>>>>9.99").               
      END.
   END.   

   FOR EACH lontemp:
      IF lontemp.ENHET = "" THEN lontemp.ENHET = "ST".
      CREATE tidut. 
      ASSIGN  
      SUBSTRING(tidut.UT,12,25)= SUBSTRING(lontemp.LONKODTEXT,1,25)
      SUBSTRING(tidut.UT,38) = lontemp.LONTILLAGG
      SUBSTRING(tidut.UT,46) = lontemp.ENHET          
      SUBSTRING(tidut.UT,52) = STRING(lontemp.LONTILLANTAL,"->>>>>9.99").  
        
   END.       
   IF godktid = FALSE THEN DO:  
      CREATE tidut. 
      CREATE tidut. 
      CREATE tidut. 
      ASSIGN 
      SUBSTRING(tidut.UT,2) = "RIKTIGHET INTYGAS  :____________________________________________".
      CREATE tidut. 
      CREATE tidut. 
      SUBSTRING(tidut.UT,2) = "TIDSEDELN GODKÄNNES:____________________________________________".  
   END.
         
   IF UTRYCKNING.PARA8 = TRUE THEN DO:    
      CREATE tidut.
      ASSIGN SUBSTRING(tidut.UT,12) = "LUFTTID"
      SUBSTRING(tidut.UT,46) = "TI"
      SUBSTRING(tidut.UT,57) = STRING(luft1,"99.99").     
   END.
      
END PROCEDURE.

PROCEDURE timmar_UI :
   FOR EACH tidsedel USE-INDEX PSTART:
      IF tidsedel.START = tidsedel.SLUT THEN NEXT.
      nytid = tidsedel.TOTALT.
      RUN TIMSEK.P.
      ASSIGN tidsedel.TOTALT = sekunder.                                                                                   
   END.                                           
   FOR EACH tidsedel:                 
      IF tidsedel.PRISTYP = "FRÅNVARO." THEN NEXT.
      IF tidsedel.PRISTYP = "RESTID..." THEN NEXT.
      IF tidsedel.AONR = "" THEN tidsedel.TOTALT = 0. 
      IF tidsedel.START = tidsedel.SLUT THEN tidsedel.TOTALT = 0.         
      IF tidsedel.OANT1 > 0 THEN DO:
         ASSIGN
         tidsedel.TOTALT1 = tidsedel.TOTALT
         tidsedel.TOTALT = 0.
      END.   
      IF tidsedel.OANT2 > 0 AND tidsedel.TOTALT > 0 THEN DO:
         ASSIGN
         tidsedel.TOTALT1 = tidsedel.TOTALT
         tidsedel.TOTALT = 0.
      END.   
      IF tidsedel.OANT3 > 0 AND tidsedel.TOTALT > 0 THEN DO:
         ASSIGN
         tidsedel.TOTALT1 = tidsedel.TOTALT
         tidsedel.TOTALT = 0.        
      END.   
   END.     
   arrhjsum = 0.
   FOR EACH tidsedel BREAK BY tidsedel.AONR BY tidsedel.DELNR BY tidsedel.PRISTYP: 
      ACCUMULATE tidsedel.TOTALT (TOTAL BY tidsedel.AONR BY tidsedel.DELNR 
      BY tidsedel.PRISTYP).                   
      IF LAST-OF(tidsedel.PRISTYP) THEN DO TRANSACTION:
         IF tidsedel.AONR = "" THEN tidsedel.TOTALT = 0. 
         ELSE DO:                  
            CREATE tidtemp.
            ASSIGN 
            tidtemp.AONR = tidsedel.AONR
            tidtemp.DELNR = tidsedel.DELNR
            tidtemp.PRISTYP = tidsedel.PRISTYP
            tidtemp.TOTALT = (ACCUM TOTAL tidsedel.TOTALT ) - arrhjsum.           
         END.
         arrhjsum = ACCUM TOTAL tidsedel.TOTALT.
      END.    
   END.
   arrtidsum = 0.                     
   FOR EACH tidtemp USE-INDEX AONR:    
      IF tidtemp.PRISTYP = "RESTID..." THEN NEXT. 
      IF tidtemp.PRISTYP = "FRÅNVARO." THEN NEXT.      
      ACCUMULATE tidtemp.TOTALT (TOTAL).
      arrtidsum = (ACCUM TOTAL tidtemp.TOTALT).               
   END.         
   restidsum = 0.
   FOR EACH tidtemp WHERE tidtemp.PRISTYP = "RESTID..." USE-INDEX AONR:                      
      ACCUMULATE tidtemp.TOTALT (TOTAL).
      restidsum = (ACCUM TOTAL tidtemp.TOTALT).                
   END.          
   frantidsum = 0.
   FOR EACH tidtemp WHERE tidtemp.PRISTYP = "FRÅNVARO." USE-INDEX AONR:                  
      ACCUMULATE tidtemp.TOTALT (TOTAL).
      frantidsum = (ACCUM TOTAL tidtemp.TOTALT).                
   END.    
                                                                   
END PROCEDURE.

PROCEDURE tolk_UI :
   RUN skaptidsed_UI. 
   RUN overtill_UI.    /*övertid*/
   RUN huvud_UI.
   RUN timmar_UI.  
   IF AVAILABLE BEREDSKAPTAB  THEN RUN beredskap_UI.  /*beredskap*/
   RUN lontill_UI.    /*lönetill*/
   /*RUN overtill_UI.    /*övertid*/*/
   RUN trakt_UI.     /*traktamenten*/
   RUN skapaut_UI.                     
END PROCEDURE.

PROCEDURE trakt_UI :
   
   FOR EACH tidsedel BREAK BY tidsedel.TRAKTKOD:      
      ACCUMULATE tidsedel.TRAKTANTAL (TOTAL BY tidsedel.TRAKTKOD).
      IF LAST-OF(tidsedel.TRAKTKOD) THEN DO:
         CREATE traktemp.
         ASSIGN          
         traktemp.TRAKTANTAL = (ACCUM TOTAL BY tidsedel.TRAKTKOD tidsedel.TRAKTANTAL)         
         traktemp.TRAKTKOD = tidsedel.TRAKTKOD.  
      END.
   END.        
   
   FOR EACH traktemp WHERE traktemp.TRAKTKOD = "":
      DELETE traktemp.
   END.            
END PROCEDURE.

PROCEDURE kollflex_UI:
   IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                     
      ASSIGN
      fltid = 0
      kolldatum = ?
      lufl = 0.
      GET FIRST tidq NO-LOCK.
      DO WHILE AVAILABLE (TIDREGITAB):               
         IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.                           
         ELSE DO:                  
            IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                                                                     
               IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                  FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                  IF AVAILABLE ftemp THEN DO:
                     IF ftemp.FSTART > ftemp.OSTART  AND ftemp.OSTART NE ftemp.OSLUT THEN DO:
                        nytid = ftemp.FSTART.
                        RUN TIMSEK.P.
                        seku = sekunder.
                        nytid = ftemp.OSTART.
                        RUN TIMSEK.P.
                        sekunder = sekunder - seku.
                        RUN FSEKTIM.P.                               
                        fltid = fltid + sekunder.                     
                     END.
                  END.
               END.
            END.
            IF TIDREGITAB.AONR = "155" THEN DO:                          
               regdatum = TIDREGITAB.DATUM.
               regvnr = TIDREGITAB.VECKONUMMER.
               pkod = TIDREGITAB.PERSONALKOD.
               RUN SLUTARBW.P 
               (INPUT-OUTPUT pkod,INPUT-OUTPUT regstart,INPUT-OUTPUT regslut, 
               INPUT-OUTPUT regvnr,INPUT-OUTPUT regdagnamn,INPUT-OUTPUT regdatum, 
               INPUT-OUTPUT regtotalt,INPUT-OUTPUT frustarten,INPUT-OUTPUT fruslutet, 
               INPUT-OUTPUT kaffestart,INPUT-OUTPUT kaffeslut,INPUT-OUTPUT lunchstarten,
               INPUT-OUTPUT lunchslutet,INPUT-OUTPUT nytid,INPUT-OUTPUT sekunder).                             
               IF TIDREGITAB.START GE regslut THEN musz = musz.
               ELSE DO:                                                
                  nytid = TIDREGITAB.TOTALT.
                  RUN TIMSEK.P.
                  fltid = fltid - sekunder.                  
               END.   
            END. 
            ELSE IF TIDREGITAB.OVERTIDUTTAG = "F" AND TIDREGITAB.LONTILLAGG = ""
            THEN DO:
               regdatum = TIDREGITAB.DATUM.
               regvnr = TIDREGITAB.VECKONUMMER.
               pkod = TIDREGITAB.PERSONALKOD.
               RUN SLUTARBW.P 
               (INPUT-OUTPUT pkod,INPUT-OUTPUT regstart,INPUT-OUTPUT regslut, 
               INPUT-OUTPUT regvnr,INPUT-OUTPUT regdagnamn,INPUT-OUTPUT regdatum, 
               INPUT-OUTPUT regtotalt,INPUT-OUTPUT frustarten,INPUT-OUTPUT fruslutet, 
               INPUT-OUTPUT kaffestart,INPUT-OUTPUT kaffeslut,INPUT-OUTPUT lunchstarten,
               INPUT-OUTPUT lunchslutet,INPUT-OUTPUT nytid,INPUT-OUTPUT sekunder). 
               FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = TIDREGITAB.DATUM AND 
               OVERAVTAB.KOD = varansf USE-INDEX ODATUM  NO-LOCK NO-ERROR.                  
               IF WEEKDAY(TIDREGITAB.DATUM) = 1 OR WEEKDAY(TIDREGITAB.DATUM) = 7
               THEN DO:                           
                  nytid = TIDREGITAB.TOTALT.
                  RUN TIMSEK.P.
                  fltid = fltid + sekunder.                   
               END.      
               ELSE IF AVAILABLE OVERAVTAB AND ( OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7) THEN DO:                           
                  nytid = TIDREGITAB.TOTALT.
                  RUN TIMSEK.P.
                  fltid = fltid + sekunder.                     
               END.     
               ELSE DO: 
                  IF TIDREGITAB.START < regstart THEN DO:                                                                  
                     IF TIDREGITAB.SLUT > regstart THEN DO:                                 
                        nytid = TIDREGITAB.START.
                        RUN TIMSEK.P.
                        seku = sekunder.
                        nytid = regstart.
                        RUN TIMSEK.P.
                        sekunder = sekunder - seku.
                        RUN SEKTIM.P.                                 
                        plflex = nytid.
                     END.
                     ELSE plflex = TIDREGITAB.TOTALT.                                                            
                     nytid = plflex.
                     RUN TIMSEK.P.
                     fltid = fltid + sekunder.
                  END.
                  IF TIDREGITAB.SLUT > regslut THEN DO:                              
                     IF TIDREGITAB.START < regslut THEN DO:                               
                        nytid = TIDREGITAB.SLUT.
                        RUN TIMSEK.P.
                        seku = sekunder.
                        nytid = regslut.
                        RUN TIMSEK.P.
                        sekunder = seku - sekunder.
                        RUN SEKTIM.P.                               
                        plflex = nytid.
                     END.
                     ELSE plflex = TIDREGITAB.TOTALT.                              
                     flextot = plflex.                                                                                
                     nytid = flextot.
                     RUN TIMSEK.P.
                     fltid = fltid + sekunder.               
                  END.
               END.
            END.                                    
            IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                           
               musz = FALSE.                        
               IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                   ASSIGN
                   lufl = 0
                   musz = TRUE.
               END.
               ELSE IF kolldatum = TIDREGITAB.DATUM AND lufl = 0 THEN musz = TRUE.                        
               IF musz = TRUE THEN DO:
                  musz = FALSE.
                  ASSIGN
                  regdatum = TIDREGITAB.DATUM
                  regvnr = TIDREGITAB.VECKONUMMER
                  pkod = TIDREGITAB.PERSONALKOD.
                  RUN SLFLARBW.P 
                  (INPUT-OUTPUT pkod,INPUT-OUTPUT regstart,INPUT-OUTPUT regslut, 
                  INPUT-OUTPUT regvnr,INPUT-OUTPUT regdagnamn,INPUT-OUTPUT regdatum, 
                  INPUT-OUTPUT regtotalt,INPUT-OUTPUT frustarten,INPUT-OUTPUT fruslutet, 
                  INPUT-OUTPUT kaffestart,INPUT-OUTPUT kaffeslut,INPUT-OUTPUT lunchstarten,
                  INPUT-OUTPUT lunchslutet,INPUT-OUTPUT nytid,INPUT-OUTPUT sekunder).

                  IF TIDREGITAB.START < regslut AND TIDREGITAB.SLUT > regstart THEN DO:                           
                      nytid = lunchslutet.
                      RUN TIMSEK.P.
                      seku = sekunder.
                      nytid = lunchstarten.
                      RUN TIMSEK.P.                                                     
                      lunorm = (seku - sekunder) / 60.
                      IF TIDREGITAB.LAGANTAL > 0 AND TIDREGITAB.LAGANTAL < lunorm THEN DO:                              
                         sekunder = (lunorm - TIDREGITAB.LAGANTAL) * 60.
                         RUN SEKTIM.P.                                                                                           
                         fltid = fltid + sekunder.
                         lufl = 1.                         
                      END.
                      IF TIDREGITAB.LAGANTAL > lunorm THEN DO:                              
                         sekunder = (TIDREGITAB.LAGANTAL - lunorm ) * 60.
                         RUN SEKTIM.P.                                                                                      
                         fltid = fltid - sekunder.
                         lufl = 1.                         
                      END.                                           
                  END.
               END.
               IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                                                                     
                  IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                     FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                     IF AVAILABLE ftemp THEN DO:                                 
                        IF ftemp.FSLUT < ftemp.OSLUT THEN DO:
                           nytid = ftemp.FSLUT.
                           RUN TIMSEK.P.
                           seku = sekunder.
                           nytid = ftemp.OSLUT.
                           RUN TIMSEK.P.
                           sekunder = seku - sekunder.
                           RUN FSEKTIM.P.                                    
                           fltid = fltid + sekunder.
                        END.
                     END.
                  END.
               END.
               kolldatum = TIDREGITAB.DATUM.
            END.                
         END.
         GET NEXT tidq.
      END.        
      IF AVAILABLE FLEXAVT AND FLEXAVT.FLEXTID = TRUE THEN DO:      
         sekunder = fltid.
         RUN FSEKTIM.P.             
         CREATE tidut.
         SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,63).
         CREATE tidut.
         SUBSTRING(tidut.UT,12) = "Månadens flexsaldo".         
         SUBSTRING(tidut.UT,33) = STRING(fnytid,"->>9.99").
         CREATE tidut.  
      END.
   END.
END PROCEDURE.


