DEFINE VARIABLE totpris LIKE MTRL.NPRIS NO-UNDO.
DEFINE VARIABLE varpaslag AS DECIMAL FORMAT "->9.99" NO-UNDO.
{TEMPUT.I}
    
DEFINE TEMP-TABLE temp_mtrl2 
   FIELD UTTAG LIKE BERBEST.UTTAG 
   FIELD SVINN LIKE BERBEST.SVINN 
   FIELD REST LIKE BERBEST.REST 
   FIELD REKNR LIKE BERBEST.REKNR 
   FIELD Pris LIKE BERBEST.Pris 
   FIELD OFFERT LIKE BERBEST.OFFERT 
   FIELD LEVKOD LIKE BERBEST.LEVKOD 
   FIELD LEVDATUM LIKE BERBEST.LEVDATUM 
   FIELD Enr LIKE BERBEST.Enr 
   FIELD Enhet LIKE BERBEST.Enhet 
   FIELD Depnr LIKE BERBEST.Depnr 
   FIELD DELNR LIKE BERBEST.DELNR 
   FIELD Bestnr LIKE BERBEST.Bestnr 
   FIELD BESTID LIKE BERBEST.BESTID 
   FIELD Bestdatum LIKE BERBEST.Bestdatum 
   FIELD BESTALLARE LIKE BERBEST.BESTALLARE 
   FIELD BENAMNING LIKE BERBEST.BENAMNING 
   FIELD AONR LIKE BERBEST.AONR 
   FIELD Antal LIKE BERBEST.Antal.  

DEFINE INPUT PARAMETER vald_depa AS INTEGER.
DEFINE INPUT PARAMETER enrvar AS CHARACTER.
DEFINE INPUT PARAMETER avdatum AS DATE.
DEFINE INPUT PARAMETER bdatum AS DATE.
DEFINE INPUT-OUTPUT PARAMETER TABLE FOR temp_ut.
   
IF enrvar = "" THEN DO:
   OPEN QUERY utq FOR EACH BESTDEP WHERE BESTDEP.DEPNR = vald_depa AND
   (BESTDEP.LEVDATUM >= avdatum AND BESTDEP.LEVDATUM <= bdatum) AND BESTDEP.BERED = FALSE AND
    BESTDEP.LEVNAMN = "" NO-LOCK.
   GET FIRST utq NO-LOCK.
   DO WHILE AVAILABLE(BESTDEP):      
      CREATE temp_ut.      
      ASSIGN
      temp_ut.ENR = BESTDEP.ENR
      temp_ut.BENAMNING = BESTDEP.BENAMNING
      temp_ut.ENHET = BESTDEP.ENHET
      temp_ut.PRIS = BESTDEP.PRIS
      temp_ut.ANTAL = BESTDEP.ANTAL
      temp_ut.LEVDATUM = BESTDEP.LEVDATUM
      temp_ut.AOBENAMNING = "I"
      temp_ut.AONR = STRING(BESTDEP.BESTNR).
      GET NEXT utq NO-LOCK.
   END.
   CLOSE QUERY utq.
END.
ELSE DO:
   OPEN QUERY utq FOR EACH BESTDEP WHERE BESTDEP.DEPNR = vald_depa AND
   (BESTDEP.LEVDATUM >= avdatum AND BESTDEP.LEVDATUM <= bdatum) AND 
   BESTDEP.ENR = enrvar AND BESTDEP.BERED = FALSE AND BESTDEP.LEVNAMN = "" NO-LOCK.
   GET FIRST utq NO-LOCK.
   DO WHILE AVAILABLE(BESTDEP):      
      CREATE temp_ut.      
      ASSIGN
      temp_ut.ENR = BESTDEP.ENR
      temp_ut.BENAMNING = BESTDEP.BENAMNING
      temp_ut.ENHET = BESTDEP.ENHET
      temp_ut.PRIS = BESTDEP.PRIS
      temp_ut.ANTAL = BESTDEP.ANTAL
      temp_ut.LEVDATUM = BESTDEP.LEVDATUM
      temp_ut.AOBENAMNING = "I"
      temp_ut.AONR = STRING(BESTDEP.BESTNR).
      GET NEXT utq NO-LOCK.
   END.
   CLOSE QUERY utq.
END.   
