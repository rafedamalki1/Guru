/*BERFANMAPP.P*/


{KONSTRMTRL.I}
{ANMARKTEMP.I}
{LEVTEMP.I}
DEFINE VARIABLE musz AS LOGICAL NO-UNDO.
{LEVTEMPORDNINGFUNC.I}

PROCEDURE btnspar_UI :
   DEFINE INPUT PARAMETER TABLE FOR fastanmtemp.
   DEFINE OUTPUT PARAMETER for_rowid AS ROWID NO-UNDO.
   FIND FIRST fastanmtemp NO-LOCK NO-ERROR.
   IF AVAILABLE fastanmtemp THEN DO TRANSACTION:     
      FIND FIRST FASTANM WHERE ROWID(FASTANM) = fastanmtemp.FASTANVROW EXCLUSIVE-LOCK NO-ERROR.     
      IF NOT AVAILABLE FASTANM THEN DO:
         CREATE FASTANM.
      END.
      BUFFER-COPY fastanmtemp TO FASTANM.
   END.
   for_rowid = ROWID(FASTANM).
   RELEASE FASTANM NO-ERROR.

END PROCEDURE.


PROCEDURE ladda_UI :
   DEFINE OUTPUT PARAMETER TABLE FOR fastanmtemp.
   DEFINE OUTPUT PARAMETER TABLE FOR konstgrptemp.
   DEFINE OUTPUT PARAMETER TABLE FOR levtemp.
   EMPTY TEMP-TABLE fastanmtemp NO-ERROR. 
   EMPTY TEMP-TABLE konstgrptemp NO-ERROR. 
   EMPTY TEMP-TABLE levtemp NO-ERROR. 
   musz = FALSE. 
   FOR EACH KONSTGRUPP USE-INDEX ORD NO-LOCK:
      IF musz = FALSE THEN DO:
         FIND FIRST KONSTRUKTION WHERE KONSTRUKTION.KONSKOD = KONSTGRUPP.KONSKOD NO-LOCK NO-ERROR.
         IF AVAILABLE KONSTRUKTION THEN DO:
            CREATE konstgrptemp.
            BUFFER-COPY KONSTGRUPP TO konstgrptemp.        
            musz = TRUE.   
         END.     
      END.
      ELSE DO:
         FIND FIRST KONSTRUKTION WHERE KONSTRUKTION.KONSKOD = KONSTGRUPP.KONSKOD 
         NO-LOCK NO-ERROR.
         IF AVAILABLE KONSTRUKTION THEN DO:
            CREATE konstgrptemp.
            BUFFER-COPY KONSTGRUPP TO konstgrptemp.  
         END.
      END. 
   END. 
   FOR EACH LEVERANTOR WHERE LEVERANTOR.LEVKOD NE "0" AND LEVERANTOR.LEVKOD NE "99" AND LEVERANTOR.BORTTAG = FALSE USE-INDEX LEV NO-LOCK.
      CREATE levtemp.
      BUFFER-COPY LEVERANTOR TO levtemp.
      {LEVTEMPORDNING.I}   
   END.  
   FOR EACH FASTANM WHERE FASTANM.PROGRAM = "BERE" USE-INDEX OMRADE NO-LOCK:
      CREATE fastanmtemp.
      BUFFER-COPY FASTANM TO fastanmtemp.
      fastanmtemp.FASTANVROW = ROWID(FASTANM).               
   END. 
   FOR EACH FASTANM WHERE FASTANM.PROGRAM BEGINS "EGENK" USE-INDEX OMRADE NO-LOCK:
      CREATE fastanmtemp.
      BUFFER-COPY FASTANM TO fastanmtemp.
      IF SUBSTRING(FASTANM.PROGRAM,6,1) NE "" THEN  fastanmtemp.ORDNING = INTEGER(TRIM(SUBSTRING(FASTANM.PROGRAM,6))). 
      fastanmtemp.FASTANVROW = ROWID(FASTANM).               
   END. 
   FOR EACH FASTANM WHERE FASTANM.PROGRAM = "INKOP" USE-INDEX OMRADE EXCLUSIVE-LOCK:
      IF FASTANM.OMRADE = "" THEN FASTANM.OMRADE = "1".                    
   END.  
   FOR EACH FASTANM WHERE FASTANM.PROGRAM = "INKOP" USE-INDEX OMRADE NO-LOCK:
      CREATE fastanmtemp.
      BUFFER-COPY FASTANM TO fastanmtemp.
      fastanmtemp.FASTANVROW = ROWID(FASTANM).               
   END.  
   
END PROCEDURE.

PROCEDURE bortanm_UI :
   DEFINE INPUT PARAMETER for_rowid AS ROWID NO-UNDO.
   DO TRANSACTION:
      FIND FASTANM WHERE ROWID(FASTANM) = for_rowid EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE FASTANM THEN DO:
         DELETE FASTANM. 
      END.
   END.
   RETURN.
END PROCEDURE.

