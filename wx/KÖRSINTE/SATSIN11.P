/*SATSIN11.p*/      

DEFINE TEMP-TABLE tidin2
   FIELD E1                 AS CHARACTER FORMAT "X(1)" 
   FIELD SATSNR             AS CHARACTER FORMAT "X(11)" 
   FIELD E2                 AS CHARACTER FORMAT "X(1)"
   FIELD ENR                AS CHARACTER FORMAT "X(11)" 
   FIELD BENAMNING          AS CHARACTER FORMAT "X(40)" 
   FIELD ANTAL              AS INTEGER FORMAT ">>"   
   INDEX SATS IS PRIMARY SATSNR.

   
DEFINE INPUT PARAMETER TABLE FOR tidin2.   
DEFINE INPUT PARAMETER leverant AS CHARACTER NO-UNDO.   

FOR EACH tidin2 NO-LOCK:                                   
   DO TRANSACTION:                        
      FIND FIRST SATS WHERE SATS.KOD = SUBSTRING(tidin2.SATSNR,1,11) AND 
      SATS.SATS = TRUE NO-LOCK NO-ERROR.
      IF NOT AVAILABLE SATS THEN DO:
         FIND FIRST MTRL WHERE MTRL.ENR = SUBSTRING(tidin2.SATSNR,1,11) AND
         MTRL.LEVKOD = leverant AND MTRL.KALKNR = 0 USE-INDEX LEV NO-LOCK NO-ERROR.            
         CREATE SATS.
         ASSIGN      
         SATS.KOD = SUBSTRING(tidin2.SATSNR,1,11)
         SATS.LEVKOD = leverant         
         SATS.ENR = SUBSTRING(tidin2.SATSNR,1,11)
         SATS.SATS = TRUE.
         IF AVAILABLE MTRL THEN ASSIGN
         SATS.BENAMNING = MTRL.BENAMNING 
         SATS.ENHET = MTRL.ENHET 
         SATS.PRIS = MTRL.NPRIS.
         ELSE SATS.BENAMNING = "Benämning saknas".
         FIND FIRST MTRL WHERE MTRL.ENR = SUBSTRING(tidin2.ENR,1,11) AND
         MTRL.LEVKOD = leverant AND MTRL.KALKNR = 0 USE-INDEX LEV NO-LOCK NO-ERROR.
         CREATE SATS.
         ASSIGN      
         SATS.KOD = SUBSTRING(tidin2.SATSNR,1,11)
         SATS.LEVKOD = leverant         
         SATS.ENR2 = SUBSTRING(tidin2.ENR,1,11)
         SATS.BENAMNING2 = SUBSTRING(tidin2.BENAMNING,1,40)
         SATS.SATS = FALSE
         SATS.ANTAL = tidin2.ANTAL. 
         IF AVAILABLE MTRL THEN ASSIGN
         SATS.BENAMNING2 = MTRL.BENAMNING 
         SATS.ENHET2 = MTRL.ENHET 
         SATS.PRIS2 = MTRL.NPRIS.           
      END.
      ELSE DO:
         FIND FIRST MTRL WHERE MTRL.ENR = SUBSTRING(tidin2.ENR,1,11) AND
         MTRL.LEVKOD = leverant AND MTRL.KALKNR = 0 USE-INDEX LEV NO-LOCK NO-ERROR.
         CREATE SATS.
         ASSIGN      
         SATS.KOD = SUBSTRING(tidin2.SATSNR,1,11)
         SATS.LEVKOD = leverant         
         SATS.ENR2 = SUBSTRING(tidin2.ENR,1,11)
         SATS.BENAMNING2 = SUBSTRING(tidin2.BENAMNING,1,40)
         SATS.SATS = FALSE
         SATS.ANTAL = tidin2.ANTAL. 
         IF AVAILABLE MTRL THEN ASSIGN
         SATS.BENAMNING2 = MTRL.BENAMNING 
         SATS.ENHET2 = MTRL.ENHET 
         SATS.PRIS2 = MTRL.NPRIS.            
      END.
   END.            
END.   
                
