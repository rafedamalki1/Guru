/*Läsa in kostnads kaltalog*/

DEFINE NEW SHARED VARIABLE filnamn AS CHARACTER NO-UNDO.
DEFINE NEW SHARED VARIABLE skrivut AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.         
DEFINE VARIABLE words AS CHARACTER FORMAT "X(132)" NO-UNDO.
DEFINE TEMP-TABLE tidin
   FIELD TIN AS CHARACTER FORMAT "X(132)".  

DEFINE NEW SHARED TEMP-TABLE temp_kund 
   FIELD ARBKOD LIKE P1.ARBKOD
   FIELD LOPNR LIKE LOP1.LOPNR
   FIELD BENAMNING LIKE LOP1.BENAMNING
   FIELD ENHET LIKE LOP1.ENHET
   FIELD F1 LIKE LOP1.F1
   FIELD F2 LIKE LOP1.F2
   FIELD F3 LIKE LOP1.F3
   FIELD MATERIEL LIKE LOP1.MATERIEL
   FIELD OVRIGT LIKE LOP1.OVRIGT
   FIELD EA LIKE LOP1.EA
   FIELD ARBETE LIKE LOP1.ARBETE
   FIELD MASKINKOST LIKE LOP1.MASKINKOST
   FIELD TOTALT LIKE LOP1.MASKINKOST.
   
DEFINE BUFFER pbuff FOR P3.   
   
DOS SILENT quoter F:\ELPNJ\KALK\109e > F:\ELPNJ\KALK\109e.Q.      
   
INPUT FROM F:\ELPNJ\KALK\109e.Q NO-ECHO.
/*CONVERT TARGET "iso8859-1" SOURCE "iso8859-1".*/
/*iso8859-1 swedish-7-bit ibm850"*/
REPEAT:
   SET words VIEW-AS EDITOR INNER-CHARS 50 INNER-LINES 3 WITH FRAME DDD WIDTH 80.   
   CREATE TIDIN.   
   ASSIGN TIDIN.TIN = words.   
END.
INPUT CLOSE.

FOR EACH TIDIN:
   CREATE temp_kund.
   ASSIGN  
   temp_kund.ARBKOD = SUBSTRING(TIDIN.TIN,2,3)
   temp_kund.LOPNR = INTEGER(SUBSTRING(TIDIN.TIN,6,2))
   temp_kund.BENAMNING = SUBSTRING(TIDIN.TIN,9,21)   
   temp_kund.ENHET = SUBSTRING(TIDIN.TIN,44,3)      
   temp_kund.F1 = DECIMAL(SUBSTRING(TIDIN.TIN,69,7))
   temp_kund.F2 = DECIMAL(SUBSTRING(TIDIN.TIN,48,6))
   temp_kund.F3 = DECIMAL(SUBSTRING(TIDIN.TIN,55,6))
/*   temp_kund.MATERIEL = INTEGER(SUBSTRING(TIDIN.TIN,69,6))
 *    temp_kund.OVRIGT = INTEGER(SUBSTRING(TIDIN.TIN,82,5))*/.     
END.   

FOR EACH temp_kund:    
   ASSIGN
   temp_kund.ARBETE = (temp_kund.F1 * 415) + (temp_kund.F2 * 415)
   temp_kund.EA = temp_kund.F2 + ((temp_kund.F3 * 410) / 245.7)
   temp_kund.MASKINKOST = temp_kund.F3 * 410
   temp_kund.TOTALT = temp_kund.ARBETE + temp_kund.MASKINKOST + temp_kund.MATERIEL + temp_kund.OVRIGT.    
END.   

FOR EACH temp_kund:   
   FIND FIRST P3 WHERE P3.ARBKOD = temp_kund.ARBKOD 
   AND P3.KATAR = 2000 USE-INDEX AR 
   NO-LOCK NO-ERROR.
   IF NOT AVAILABLE P3 THEN DO:
      FIND FIRST pbuff WHERE pbuff.ARBKOD = temp_kund.ARBKOD 
      AND pbuff.KATAR = 1999 USE-INDEX AR 
      NO-LOCK NO-ERROR.
      IF AVAILABLE pbuff THEN DO:
         CREATE P3.
         ASSIGN
         P3.ARBKOD = temp_kund.ARBKOD
         P3.BENAMNING = pbuff.BENAMNING
         P3.KATAR = 2000.
      END.
      ELSE DO:
         CREATE P3.
         ASSIGN
         P3.ARBKOD = temp_kund.ARBKOD
         P3.BENAMNING = "NY"
         P3.KATAR = 2000.
      END.   
   END.
   CREATE LOP3.
   ASSIGN
   LOP3.ARBKOD = temp_kund.ARBKOD
   LOP3.LOPNR = temp_kund.LOPNR
   LOP3.BENAMNING = temp_kund.BENAMNING   
   LOP3.ENHET = temp_kund.ENHET      
   LOP3.F1 = temp_kund.F1
   LOP3.F2 = temp_kund.F2
   LOP3.F3 = temp_kund.F3
   LOP3.EA = temp_kund.EA
   LOP3.ARBETE = temp_kund.ARBETE
   LOP3.MASKINKOST = temp_kund.MASKINKOST   
   LOP3.MATERIEL = temp_kund.MATERIEL
   LOP3.OVRIGT = temp_kund.OVRIGT
   LOP3.KATAR = 2000. 
END.  
