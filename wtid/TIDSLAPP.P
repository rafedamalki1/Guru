/*TIDSLAPP.P*/
{TIDUTTTNEW.I} 
DEFINE INPUT PARAMETER pkod AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER borjdat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER avdat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER rdat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER stdat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER sldat AS DATE NO-UNDO.
DEFINE INPUT PARAMETER RAD_TIDSVAL AS INTEGER NO-UNDO.
DEFINE INPUT PARAMETER korda AS INTEGER NO-UNDO.
DEFINE OUTPUT PARAMETER knappvar AS LOGICAL NO-UNDO.
DEFINE OUTPUT PARAMETER TABLE FOR tidut.
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{GLOBVAR2DEL1.I}
{REGVAR.I}
FIND FIRST FORETAG NO-LOCK NO-ERROR.
Guru.Konstanter:globforetag = FORETAG.FORETAG.
RUN STYRFORE.P (INPUT Guru.Konstanter:globforetag).
DEFINE NEW SHARED VARIABLE fnytid AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE VARIABLE ingsal AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE VARIABLE energiavt AS LOGICAL NO-UNDO.
DEFINE VARIABLE beren AS CHARACTER FORMAT "X(5)" NO-UNDO. 
DEFINE VARIABLE startdatum AS DATE NO-UNDO.
DEFINE VARIABLE slutdatum AS DATE NO-UNDO. 
DEFINE VARIABLE berraknare AS INTEGER NO-UNDO.
DEFINE VARIABLE bermax AS INTEGER NO-UNDO.  
DEFINE VARIABLE bersummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE arrhjsum LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrhjesum LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrbsumkod LIKE TIDREGITAB.BEREDSKAP EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbsum LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO. 
DEFINE VARIABLE arrbesum LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbdag LIKE TIDREGITAB.DAG EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbdatum LIKE TIDREGITAB.DATUM EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbkod LIKE TIDREGITAB.BEREDSKAP EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbantal LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrbeantal LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO.    
DEFINE VARIABLE arrlenh LIKE LONTILL.ENHET EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrlkod LIKE TIDREGITAB.LONTILLAGG EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrlantal LIKE TIDREGITAB.LONTILLANTAL EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrlsum LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO.  
DEFINE VARIABLE arrlesum LIKE TIDREGITAB.BERANTAL EXTENT 70 NO-UNDO. 
DEFINE VARIABLE arrlsumkod LIKE TIDREGITAB.LONTILLAGG EXTENT 70 NO-UNDO. 
DEFINE VARIABLE adrsum LIKE LONTILL.ERSATTNING NO-UNDO.  
DEFINE VARIABLE arrtidsum LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE VARIABLE arrfrsum LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE VARIABLE arrressum LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE VARIABLE arrtsumkod LIKE TIDREGITAB.TRAKTKOD EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrtsum LIKE TIDREGITAB.TRAKTANTAL EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrtesum LIKE TIDREGITAB.TRAKTANTAL EXTENT 70 NO-UNDO. 
DEFINE VARIABLE arrosumkod LIKE TIDREGITAB.OKOD1 EXTENT 70 NO-UNDO.
DEFINE VARIABLE arrosum LIKE TIDREGITAB.OANT1 EXTENT 70 NO-UNDO.      
DEFINE VARIABLE lonraknare AS INTEGER NO-UNDO.    
DEFINE VARIABLE lonsummax AS INTEGER NO-UNDO.   
DEFINE VARIABLE trasummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE traraknare AS INTEGER NO-UNDO.   
DEFINE VARIABLE ovesummax AS INTEGER NO-UNDO. 
DEFINE VARIABLE overaknare AS INTEGER NO-UNDO. 
DEFINE VARIABLE lagbas AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE lers AS DECIMAL FORMAT "->>>>9.99" NO-UNDO.
DEFINE VARIABLE trec AS RECID NO-UNDO.
DEFINE VARIABLE koll5 AS INTEGER NO-UNDO.
DEFINE VARIABLE otim5 AS DECIMAL FORMAT "99.99" NO-UNDO. 
DEFINE VARIABLE otim6 AS DECIMAL FORMAT "99.99" NO-UNDO. 
DEFINE VARIABLE otim AS INTEGER FORMAT "-9999999" NO-UNDO.  
DEFINE VARIABLE otim1 AS INTEGER FORMAT "-9999999" NO-UNDO.               
DEFINE VARIABLE otim3 AS INTEGER FORMAT "-9999999" NO-UNDO. 
DEFINE VARIABLE otim4 AS INTEGER FORMAT "-9999999" NO-UNDO. 
DEFINE VARIABLE godkandvar LIKE TIDREGITAB.GODKAND NO-UNDO.
DEFINE VARIABLE tidove LIKE OVERKOD.OVERTIDTILL NO-UNDO.
DEFINE VARIABLE varansf LIKE ANSTFORMTAB.KOD NO-UNDO. 
DEFINE VARIABLE varberav LIKE BERKOD.BEREDSKAPSAVTAL NO-UNDO.
DEFINE VARIABLE vartraktav LIKE TRAKTATAB.TRAAVTAL NO-UNDO.
DEFINE VARIABLE overant AS INTEGER FORMAT "-9999999" NO-UNDO. 
DEFINE VARIABLE otid LIKE TIDREGITAB.OVERTIDUTTAG NO-UNDO.  
DEFINE VARIABLE otim2 AS INTEGER FORMAT "-9999999" NO-UNDO. 
DEFINE VARIABLE hjdat AS DATE NO-UNDO.
DEFINE VARIABLE luft1 AS INTEGER FORMAT "-999999" NO-UNDO.      
DEFINE VARIABLE luft2 AS DECIMAL FORMAT "-99.99" NO-UNDO.  
DEFINE VARIABLE sekunder1 AS INTEGER FORMAT "-9999999" NO-UNDO.   
DEFINE VARIABLE sekunder2 AS INTEGER FORMAT "-9999999" NO-UNDO.  
DEFINE VARIABLE sekunder3 AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE seku AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE str AS CHARACTER FORMAT "X(140)" NO-UNDO.
DEFINE VARIABLE str2 AS CHARACTER FORMAT "X(140)" NO-UNDO.
DEFINE VARIABLE tidao LIKE AONRTAB.AONR NO-UNDO.
DEFINE VARIABLE tiddelnr LIKE AONRTAB.DELNR NO-UNDO. 
DEFINE VARIABLE fltid AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE VARIABLE flextot LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE VARIABLE overnatt AS INTEGER NO-UNDO.
DEFINE VARIABLE fdatum AS DATE NO-UNDO.
DEFINE VARIABLE sign AS LOGICAL NO-UNDO.
DEFINE VARIABLE jamdag AS CHARACTER NO-UNDO.
DEFINE VARIABLE plflex AS DECIMAL FORMAT "-99.99" NO-UNDO.
DEFINE VARIABLE kolldatum AS DATE NO-UNDO.
DEFINE VARIABLE lunorm AS INTEGER NO-UNDO.
DEFINE VARIABLE lufl AS INTEGER NO-UNDO.
DEFINE VARIABLE blrak AS INTEGER NO-UNDO.
DEFINE VARIABLE hkoll1 AS INTEGER NO-UNDO.
DEFINE VARIABLE hkoll2 AS INTEGER NO-UNDO.
DEFINE VARIABLE lontotkr AS DECIMAL NO-UNDO.
DEFINE VARIABLE tratotkr AS DECIMAL NO-UNDO.
DEFINE VARIABLE formtotkr AS DECIMAL NO-UNDO.
DEFINE VARIABLE biltotkr AS DECIMAL NO-UNDO.
DEFINE VARIABLE hjmat AS CHARACTER NO-UNDO.
DEFINE BUFFER tidbuff FOR TIDREGITAB.
DEFINE VARIABLE totarbkort AS DECIMAL NO-UNDO.
DEFINE VARIABLE arregvnr AS INTEGER NO-UNDO.
DEFINE VARIABLE rtidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE ftidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE ordarbman AS DECIMAL NO-UNDO.
DEFINE VARIABLE otidman AS DECIMAL NO-UNDO.
DEFINE VARIABLE visstdat AS DATE NO-UNDO.
DEFINE VARIABLE vissldat AS DATE NO-UNDO.
DEFINE VARIABLE gplaktbuffh AS HANDLE NO-UNDO.
DEFINE VARIABLE gplhuvudbuffh AS HANDLE NO-UNDO.
DEFINE VARIABLE gplaktbuffextrh AS HANDLE NO-UNDO.
DEFINE VARIABLE kvaratk AS DECIMAL NO-UNDO.
DEFINE VARIABLE foremaxarbkort AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompvman  AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompvmandat AS DATE NO-UNDO.
DEFINE VARIABLE acckompsenast AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompsenasttot AS DECIMAL NO-UNDO.
DEFINE VARIABLE acckompsenastdat AS DATE NO-UNDO.
DEFINE VARIABLE komplog AS LOGICAL NO-UNDO.
DEFINE VARIABLE kompapph AS HANDLE NO-UNDO.
DEFINE VARIABLE tsem AS INTEGER NO-UNDO.
DEFINE VARIABLE sdag AS DATE NO-UNDO.        
DEFINE VARIABLE ovinvar AS DECIMAL NO-UNDO.       
DEFINE VARIABLE nodvar AS DECIMAL NO-UNDO.
DEFINE VARIABLE berkomp AS DECIMAL NO-UNDO.


DEFINE VARIABLE qString       AS CHARACTER  NO-UNDO.
CREATE WIDGET-POOL "DynTableRLAP" NO-ERROR.

DEFINE QUERY tidq FOR TIDREGITAB.
FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.

END FUNCTION.
FUNCTION klock60 RETURNS DECIMAL
  ( INPUT ber100 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  TRUNCATE(ber100,0) + ((ber100 - TRUNCATE(ber100,0)) * 60 / 100 ).

END FUNCTION.

FIND FIRST FORETAG NO-LOCK NO-ERROR.
ASSIGN
bdatum = borjdat
avdatum = avdat
regdatum = rdat
startdatum = stdat
slutdatum = sldat
Guru.Konstanter:globforetag  = FORETAG.FORETAG.
   
DEFINE NEW SHARED TEMP-TABLE vtid    
   FIELD EFTERNAMN LIKE PERSONALTAB.EFTERNAMN 
   FIELD FORNAMN LIKE PERSONALTAB.FORNAMN 
   FIELD PERSONALKOD LIKE PERSONALTAB.PERSONALKOD 
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER 
   FIELD AR AS INTEGER
   FIELD MANNR AS INTEGER
   FIELD MANAD AS CHARACTER FORMAT "X(9)"   
   INDEX PERSONALKOD IS PRIMARY PERSONALKOD VECKONUMMER ASCENDING
   INDEX PMANAD PERSONALKOD AR MANNR.    
DEFINE TEMP-TABLE tidsedel         
   FIELD ENHET LIKE LONTILL.ENHET 
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD ORT LIKE AONRTAB.ORT   
   FIELD BERANTAL LIKE TIDREGITAB.BERANTAL 
   FIELD BEREDSKAP LIKE TIDREGITAB.BEREDSKAP 
   FIELD DAG LIKE TIDREGITAB.DAG 
   FIELD DATUM LIKE TIDREGITAB.DATUM 
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD ENFLERDAGS LIKE TIDREGITAB.ENFLERDAGS 
   FIELD GODKAND LIKE TIDREGITAB.GODKAND
   FIELD VECKOKORD LIKE TIDREGITAB.VECKOKORD   
   FIELD LAGBAS LIKE TIDREGITAB.LAGBAS 
   FIELD LONAUTO LIKE TIDREGITAB.LONAUTO 
   FIELD LONTILLAGG LIKE TIDREGITAB.LONTILLAGG 
   FIELD LONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL   
   FIELD OVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD OANT1 LIKE TIDREGITAB.OANT1 
   FIELD OANT2 LIKE TIDREGITAB.OANT2 
   FIELD OANT3 LIKE TIDREGITAB.OANT3 
   FIELD OKOD1 LIKE TIDREGITAB.OKOD1 
   FIELD OKOD2 LIKE TIDREGITAB.OKOD2 
   FIELD OKOD3 LIKE TIDREGITAB.OKOD3    
   FIELD OVERAUTO LIKE TIDREGITAB.OVERAUTO 
   FIELD RECTIDVIS LIKE TIDREGITAB.RECTIDVIS 
   FIELD RESMAL LIKE TIDREGITAB.RESMAL 
   FIELD SLUT LIKE TIDREGITAB.SLUT 
   FIELD START LIKE TIDREGITAB.START 
   FIELD TOTALT LIKE TIDREGITAB.TOTALT
   FIELD TRAKTKOD LIKE TIDREGITAB.TRAKTKOD 
   FIELD TRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL 
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER  
   FIELD ENKEL LIKE OVERKOD.ENKEL    
   FIELD UTRYCKNING LIKE TIDREGITAB.UTRYCKNING 
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD TERSATTNING LIKE TRAKTATAB.ERSATTNING  
   FIELD LERSATTNING LIKE LONTILL.ERSATTNING 
   FIELD BERSATTNING LIKE BERKOD.ERSATTNING 
   FIELD BILFORARE LIKE TIDREGITAB.BILFORARE 
   FIELD AVDRAG LIKE LONTILL.ERSATTNING 
   FIELD ENY AS LOGICAL INITIAL FALSE  
   FIELD RES AS LOGICAL INITIAL FALSE  
   FIELD NODF LIKE TIDREGITAB.NODF
   FIELD TIDLOG LIKE TIDREGITAB.TIDLOG
   INDEX PSTART IS PRIMARY  DATUM START SLUT ASCENDING
   INDEX PTIDS DATUM ASCENDING TIDLOG DESCENDING START ASCENDING SLUT ASCENDING LONTILLAGG ASCENDING 
   INDEX PVNR VECKONUMMER ASCENDING.
DEFINE TEMP-TABLE resmaltidsedel         
   FIELD ENHET LIKE LONTILL.ENHET 
   FIELD AONR LIKE TIDREGITAB.AONR              
   FIELD ORT LIKE AONRTAB.ORT   
   FIELD BERANTAL LIKE TIDREGITAB.BERANTAL 
   FIELD BEREDSKAP LIKE TIDREGITAB.BEREDSKAP 
   FIELD DAG LIKE TIDREGITAB.DAG 
   FIELD DATUM LIKE TIDREGITAB.DATUM 
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD ENFLERDAGS LIKE TIDREGITAB.ENFLERDAGS 
   FIELD GODKAND LIKE TIDREGITAB.GODKAND   
   FIELD LAGBAS LIKE TIDREGITAB.LAGBAS 
   FIELD LONAUTO LIKE TIDREGITAB.LONAUTO 
   FIELD LONTILLAGG LIKE TIDREGITAB.LONTILLAGG 
   FIELD LONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL   
   FIELD OVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD OANT1 LIKE TIDREGITAB.OANT1 
   FIELD OANT2 LIKE TIDREGITAB.OANT2 
   FIELD OANT3 LIKE TIDREGITAB.OANT3 
   FIELD OKOD1 LIKE TIDREGITAB.OKOD1 
   FIELD OKOD2 LIKE TIDREGITAB.OKOD2 
   FIELD OKOD3 LIKE TIDREGITAB.OKOD3    
   FIELD OVERAUTO LIKE TIDREGITAB.OVERAUTO 
   FIELD RECTIDVIS LIKE TIDREGITAB.RECTIDVIS 
   FIELD RESMAL LIKE TIDREGITAB.RESMAL 
   FIELD SLUT LIKE TIDREGITAB.SLUT 
   FIELD START LIKE TIDREGITAB.START 
   FIELD TOTALT LIKE TIDREGITAB.TOTALT
   FIELD TRAKTKOD LIKE TIDREGITAB.TRAKTKOD 
   FIELD TRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL 
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER  
   FIELD ENKEL LIKE OVERKOD.ENKEL    
   FIELD UTRYCKNING LIKE TIDREGITAB.UTRYCKNING 
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD TERSATTNING LIKE TRAKTATAB.ERSATTNING  
   FIELD LERSATTNING LIKE LONTILL.ERSATTNING 
   FIELD BERSATTNING LIKE BERKOD.ERSATTNING 
   FIELD BILFORARE LIKE TIDREGITAB.BILFORARE 
   FIELD AVDRAG LIKE LONTILL.ERSATTNING 
   FIELD ENY AS LOGICAL INITIAL FALSE  
   FIELD RES AS LOGICAL INITIAL FALSE  
   FIELD NODF LIKE TIDREGITAB.NODF
   FIELD TIDLOG LIKE TIDREGITAB.TIDLOG
   INDEX PSTART IS PRIMARY  DATUM START SLUT ASCENDING
   INDEX PTIDS DATUM ASCENDING TIDLOG DESCENDING START ASCENDING SLUT ASCENDING LONTILLAGG ASCENDING 
   INDEX PVNR VECKONUMMER ASCENDING.
DEFINE BUFFER sedelbuff FOR tidsedel. 
DEFINE BUFFER tidsbuff FOR tidsedel.    
DEFINE BUFFER resmaltidbuff FOR resmaltidsedel.
DEFINE TEMP-TABLE overtidhj 
   FIELD OVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL   
   FIELD OVERANTAL LIKE TIDREGITAB.OVERANTAL.      
      
DEFINE TEMP-TABLE invartemp   
   FIELD GA LIKE ANVANDARE.ANVANDARE
   FIELD GM AS LOGICAL 
   FIELD SK AS LOGICAL 
   FIELD TI AS RECID 
   FIELD PER AS RECID 
   FIELD PER2 AS RECID 
   FIELD MU AS LOGICAL    
   FIELD REGST LIKE TIDREGITAB.START 
   FIELD REGSU LIKE TIDREGITAB.SLUT 
   FIELD RV AS INTEGER FORMAT "999" 
   FIELD RDAG AS CHARACTER FORMAT "X(3)"         
   FIELD RD AS DATE 
   FIELD RM AS INTEGER FORMAT "99" 
   FIELD RMN AS CHARACTER  
   FIELD REGA AS INTEGER FORMAT "99" 
   FIELD RT LIKE TIDREGITAB.TOTALT       
   FIELD BD AS DATE 
   FIELD AD AS DATE 
   FIELD NY AS DECIMAL 
   FIELD SEK AS INTEGER FORMAT "-9999999" 
   FIELD RSEK AS INTEGER 
   FIELD REGS AS INTEGER 
   FIELD GL LIKE FORETAG.FORETAG.   
DEFINE TEMP-TABLE ftemp   
   FIELD DATUM AS DATE
   FIELD DAG AS CHARACTER
   FIELD OSTART AS DECIMAL 
   FIELD OSLUT AS DECIMAL
   FIELD FSTART AS DECIMAL 
   FIELD FSLUT AS DECIMAL 
   FIELD MKFLEX AS INTEGER
   FIELD MKTFLEX AS DECIMAL
   FIELD TFLEX AS INTEGER
   FIELD TOTFLEX AS DECIMAL
   FIELD LFLEX AS DECIMAL
   FIELD MFLEX AS DECIMAL
   FIELD KFLEX AS DECIMAL.
                           
DEFINE NEW SHARED TEMP-TABLE tidut2
   FIELD UT AS CHARACTER FORMAT "X(132)".  
DEFINE TEMP-TABLE tidut3
   FIELD UT AS CHARACTER FORMAT "X(132)".  
DEFINE TEMP-TABLE klartextut
   FIELD UT AS CHARACTER FORMAT "X(132)".
   DEFINE TEMP-TABLE overtidhj2
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD OVERANTAL AS DECIMAL
   FIELD OVERTIDTILL AS CHARACTER
   FIELD MANAD AS INTEGER
   FIELD MULTIP AS DECIMAL
   FIELD ANTMULT AS DECIMAL
   FIELD KOMPUTTAG AS DECIMAL    
   FIELD NAMN AS CHARACTER FORMAT "X(30)"
   FIELD OMRADE AS CHARACTER
   FIELD GEOMRADE AS CHARACTER
   FIELD OVERTIDUTTAG AS CHARACTER
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL
   FIELD VECKOKORD AS CHARACTER 
   INDEX PKOD PERSONALKOD DATUM.

DEFINE TEMP-TABLE oversum
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD NAMN AS CHARACTER FORMAT "X(30)"
   FIELD MANAD AS INTEGER
   FIELD OVERANTAL AS DECIMAL
   FIELD ANTMULT AS DECIMAL   
   FIELD KOMPUTTAG AS DECIMAL       
   FIELD OMRADE AS CHARACTER
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL.
DEFINE TEMP-TABLE overksum LIKE  oversum.   
DEFINE TEMP-TABLE overhela   
   FIELD KOMP1 AS DECIMAL
   FIELD KOMP2 AS DECIMAL
   FIELD KOMP3 AS DECIMAL
   FIELD KOMP4 AS DECIMAL
   FIELD KOMP5 AS DECIMAL
   FIELD KOMP6 AS DECIMAL
   FIELD KOMP7 AS DECIMAL
   FIELD KOMP8 AS DECIMAL
   FIELD KOMP9 AS DECIMAL
   FIELD KOMP10 AS DECIMAL
   FIELD KOMP11 AS DECIMAL
   FIELD KOMP12 AS DECIMAL
   FIELD KOMPTOT AS DECIMAL   
   FIELD KOMPUT1 AS DECIMAL
   FIELD KOMPUT2 AS DECIMAL
   FIELD KOMPUT3 AS DECIMAL
   FIELD KOMPUT4 AS DECIMAL
   FIELD KOMPUT5 AS DECIMAL
   FIELD KOMPUT6 AS DECIMAL
   FIELD KOMPUT7 AS DECIMAL
   FIELD KOMPUT8 AS DECIMAL
   FIELD KOMPUT9 AS DECIMAL
   FIELD KOMPUT10 AS DECIMAL
   FIELD KOMPUT11 AS DECIMAL
   FIELD KOMPUT12 AS DECIMAL
   FIELD KOMPUTTOT AS DECIMAL     
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD    
   FIELD NAMN AS CHARACTER FORMAT "X(30)"
   FIELD OMRADE AS CHARACTER
   FIELD GEOMRADE AS CHARACTER
   FIELD VERKOV AS DECIMAL
   FIELD VERKKO AS DECIMAL.
         
     
DEFINE BUFFER tidutr FOR tidut.
DEFINE VARIABLE ftro AS LOGICAL NO-UNDO.
DEFINE VARIABLE tillit AS LOGICAL NO-UNDO.
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.
{EXTRADATA.I}
RUN EXTRADATAHMT.P PERSISTENT SET edataapph.   
    
RUN noll_UI.         
RUN avtal_UI.  
RUN tolk_UI.   
FIND FIRST tidut WHERE SUBSTRING(tidut.ut,4,6) = "MÅNAD:" NO-LOCK NO-ERROR. 
CREATE tidut3.
ASSIGN tidut3.UT = "".
REPEAT:
   FIND NEXT tidut NO-ERROR.
   IF NOT AVAILABLE tidut THEN LEAVE.
   IF SUBSTRING(tidut.UT,1,6) = "Totalt"  THEN LEAVE.
   
   IF SUBSTRING(tidut.UT,1,8) = "Intjänad"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,1,7) = "Verklig"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,1,7) = "Uttagen"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,1,11) = "Flexrapport"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,1,13) = "Månadens flex"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,2,18) = "RIKTIGHET INTYGAS:"  THEN LEAVE.
   IF SUBSTRING(tidut.UT,2,7) = "Faktisk"  THEN LEAVE.
   ASSIGN
   tidut3.UT = ""
   tidut3.UT = tidut.UT
   tidut.UT = "".
   IF tidut3.UT BEGINS "========================================" THEN DO:
      ASSIGN
      SUBSTRING(tidut.UT,1,120) = SUBSTRING(tidut3.UT,1,120).
      NEXT.
   END.
   IF tidut3.UT BEGINS "----------------------------------------" THEN DO: 
      ASSIGN
      SUBSTRING(tidut.UT,1,120) = SUBSTRING(tidut3.UT,1,120).
      NEXT.
   END.       
   
   ASSIGN
   SUBSTRING(tidut.UT,1,31) = SUBSTRING(tidut3.UT,1,31)
   /*SUND DELNR*/
   SUBSTRING(tidut.UT,32,4) = SUBSTRING(tidut3.UT,33,4)      
   SUBSTRING(tidut.UT,36,25) = SUBSTRING(tidut3.UT,37,25)      
   /*SUBSTRING(tidut.UT,62,17) = SUBSTRING(tidut3.UT,64,17)*/          
   SUBSTRING(tidut.UT,61,18) = SUBSTRING(tidut3.UT,63,18)          
   SUBSTRING(tidut.UT,80,5) = SUBSTRING(tidut3.UT,81,5)   
   SUBSTRING(tidut.UT,86,5) = SUBSTRING(tidut3.UT,86,5)   
   SUBSTRING(tidut.UT,91,4) = SUBSTRING(tidut3.UT,91,4)      
   SUBSTRING(tidut.UT,96,2) = SUBSTRING(tidut3.UT,97,2)      
   SUBSTRING(tidut.UT,99,5) = SUBSTRING(tidut3.UT,102,5)
   SUBSTRING(tidut.UT,105,4) = SUBSTRING(tidut3.UT,115,4)
   SUBSTRING(tidut.UT,110,12) = SUBSTRING(tidut3.UT,120,12).                         
END.          
FIND FIRST tidut WHERE SUBSTRING(tidut.ut,68,4) = "KVAL" NO-LOCK NO-ERROR. 
IF AVAILABLE tidut THEN DO: 
    ASSIGN 
    SUBSTRING(tidut.UT,74,13) = "Lönetillägg  "
    SUBSTRING(tidut.UT,91,13) = "Traktamente  "
    SUBSTRING(tidut.UT,105,11) = "Beredskap  ".
 END.  

/* **********************  Internal Procedures  *********************** */


{GDPRLOGGCLIENT.I}
DELETE WIDGET-POOL "DynTableST" NO-ERROR.
PROCEDURE avtal_UI :
   FIND PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod 
   NO-LOCK NO-ERROR.
   persrec = RECID(PERSONALTAB).
   FIND FIRST OMRADETAB WHERE OMRADETAB.OMRADE= PERSONALTAB.OMRADE
   USE-INDEX OMR NO-LOCK NO-ERROR.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
   USE-INDEX ANSTF NO-LOCK NO-ERROR.
   ASSIGN 
   varansf = ANSTFORMTAB.KOD
   varberav = PERSONALTAB.BEREDSKAPSAVTAL 
   vartraktav = PERSONALTAB.TRAAVTAL.
   FIND FIRST UTRYCKNING WHERE UTRYCKNING.KOD = ANSTFORMTAB.KOD USE-INDEX UT
   NO-LOCK NO-ERROR. 
   FIND FIRST BEREDSKAPTAB WHERE BEREDSKAPTAB.BEREDSKAPSAVTAL = 
   PERSONALTAB.BEREDSKAPSAVTAL USE-INDEX BERED NO-LOCK NO-ERROR.
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL > 0 THEN beren = "Antal".
      ELSE beren = "ti mi".          
   END.
   ELSE beren = "ti mi".          
   str="====================================================================================================================================".                
   
   regdatum = bdatum.
   RUN REGVEC.P.
   arregvnr = INTEGER(SUBSTRING(STRING(YEAR(regdatum),"9999"),1,3) + STRING(regvnr,"999")).
   FIND FIRST VECKOARBAV WHERE VECKOARBAV.PERSONALKOD = PERSONALTAB.PERSONALKOD AND VECKOARBAV.VECKONUMMER = arregvnr
   NO-LOCK NO-ERROR.
   IF AVAILABLE VECKOARBAV THEN DO:
      FIND FIRST VECKOARBETID WHERE VECKOARBETID.VECKOSCHEMA = VECKOARBAV.VECKOSCHEMA USE-INDEX VECKOSCHEMA NO-LOCK NO-ERROR.  
   END.  
   ELSE DO:
      FIND FIRST VECKOARBETID WHERE VECKOARBETID.VECKOSCHEMA = PERSONALTAB.VECKOSCHEMA USE-INDEX VECKOSCHEMA NO-LOCK NO-ERROR.
   END. 

      
   FIND FIRST ARBETSTIDTAB WHERE ARBETSTIDTAB.ARBTIDKOD = VECKOARBETID.ARBTIDMAN
   USE-INDEX ARBTIDKOD NO-LOCK NO-ERROR.
   ASSIGN
   regstart = ARBETSTIDTAB.START
   regslut = ARBETSTIDTAB.SLUT.
END PROCEDURE.

PROCEDURE avvecka_UI :
   IF MONTH(bdatum) = 12 THEN avdatum = DATE(12,31,YEAR(bdatum)). 
   ELSE avdatum = DATE(MONTH(bdatum) + 1,01,YEAR(bdatum)) - 1.         
END PROCEDURE.


PROCEDURE beredskap_UI :
   FOR EACH tidsedel BY tidsedel.BEREDSKAP:
      IF tidsedel.BEREDSKAP = "" THEN NEXT.
      FIND FIRST BERKOD WHERE BERKOD.BEREDSKAP = tidsedel.BEREDSKAP AND
      BERKOD.BEREDSKAPSAVTAL = varberav  USE-INDEX BERE NO-LOCK NO-ERROR.      
      IF NOT AVAILABLE BERKOD THEN DO:
         /*Om personen bytt avtal ska det inte spåra ur*/
         FIND FIRST BERKOD WHERE BERKOD.BEREDSKAP = tidsedel.BEREDSKAP USE-INDEX BERE NO-LOCK NO-ERROR.      
      END.
      ASSIGN tidsedel.BEREDSKAP = BERKOD.VILART.      
      IF BERKOD.ENHET = "ST" THEN ASSIGN tidsedel.BERSATTNING = BERKOD.ERSATTNING * tidsedel.BERANTAL.      
   END.        
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL = 0 THEN DO:
         FOR EACH tidsedel BY tidsedel.BEREDSKAP:
            IF tidsedel.BERANTAL = 0 THEN NEXT.
            nytid = tidsedel.BERANTAL.
            RUN TIMSEK.P.
            ASSIGN tidsedel.BERANTAL = sekunder.                
         END.      
      END.     
   END.
   FOR EACH tidsedel BREAK BY tidsedel.BEREDSKAP:            
      ACCUMULATE tidsedel.BERANTAL (TOTAL BY tidsedel.BEREDSKAP). 
      ACCUMULATE tidsedel.BERSATTNING (TOTAL BY tidsedel.BEREDSKAP).
      IF LAST-OF(tidsedel.BEREDSKAP) THEN DO:         
         ASSIGN 
         berraknare = berraknare + 1         
         arrbsum[berraknare] = (ACCUM TOTAL BY tidsedel.BEREDSKAP tidsedel.BERANTAL)   
         arrbesum[berraknare] = (ACCUM TOTAL BY tidsedel.BEREDSKAP tidsedel.BERSATTNING)         
         arrbsumkod[berraknare] = tidsedel.BEREDSKAP.            
      END.
   END.   
   bersummax = berraknare. 
   IF bersummax = 0 THEN RETURN.
   berraknare = 0.        
   FOR EACH tidsedel BREAK BY tidsedel.DATUM BY tidsedel.BEREDSKAP:
      /*IF tidsedel.BERANTAL = 0 THEN NEXT.     */
      ACCUMULATE tidsedel.BERANTAL (TOTAL BY tidsedel.BEREDSKAP). 
      ACCUMULATE tidsedel.BERSATTNING (TOTAL BY tidsedel.BEREDSKAP).
      IF LAST-OF(tidsedel.BEREDSKAP) THEN DO:     
         ASSIGN
         berraknare = berraknare + 1
         arrbdag[berraknare] = tidsedel.DAG
         arrbdatum[berraknare] = tidsedel.DATUM
         arrbkod[berraknare] = tidsedel.BEREDSKAP
         arrbantal[berraknare] = (ACCUM TOTAL BY tidsedel.BEREDSKAP tidsedel.BERANTAL)   
         arrbeantal[berraknare] = (ACCUM TOTAL BY tidsedel.BEREDSKAP tidsedel.BERSATTNING).         
      END.
   END.        
   bermax = berraknare.                  
   FOR EACH tidsedel BY tidsedel.BEREDSKAP:
      IF tidsedel.BERANTAL = 0 THEN NEXT. 
      ASSIGN tidsedel.BERANTAL = 0 
      tidsedel.BEREDSKAP = "".      
   END.           
   berraknare = 0.  
   IF AVAILABLE BEREDSKAPTAB THEN DO:
      IF BEREDSKAPTAB.BERANTAL = 0 THEN DO:
         REPEAT:
            berraknare = berraknare + 1.     
            IF berraknare > bermax THEN LEAVE.     
            sekunder = arrbantal[berraknare].
            RUN SEKTIM.P.
            arrbantal[berraknare] = nytid.         
         END.
         berraknare = 0.  
         REPEAT:
            berraknare = berraknare + 1.     
            IF berraknare > bersummax THEN LEAVE.     
            sekunder = arrbsum[berraknare].
            RUN SEKTIM.P.
            arrbsum[berraknare] = nytid.         
         END.                 
      END.    
   END.
   berraknare = 1.  
   FIND FIRST tidsedel WHERE tidsedel.DATUM = arrbdatum[berraknare] 
   USE-INDEX PSTART NO-ERROR.
   IF NOT AVAILABLE tidsedel THEN DO:
      CREATE tidsedel.
   END.
   ASSIGN                                 
   tidsedel.DAG = arrbdag[berraknare]
   tidsedel.DATUM = arrbdatum[berraknare]
   tidsedel.BEREDSKAP = arrbkod[berraknare]
   tidsedel.BERANTAL = arrbantal[berraknare]
   tidsedel.BERSATTNING = arrbeantal[berraknare].      
   REPEAT TRANSACTION:
      berraknare = berraknare + 1. 
      IF berraknare > bermax THEN LEAVE.
      FIND NEXT tidsedel WHERE tidsedel.DATUM = arrbdatum[berraknare] 
      USE-INDEX PSTART NO-ERROR.
      IF NOT AVAILABLE tidsedel THEN DO:
         CREATE tidsedel.
      END.      
      ASSIGN                                 
      tidsedel.DAG = arrbdag[berraknare]
      tidsedel.DATUM = arrbdatum[berraknare]
      tidsedel.BEREDSKAP = arrbkod[berraknare]
      tidsedel.BERANTAL = arrbantal[berraknare]
      tidsedel.BERSATTNING = arrbeantal[berraknare].                  
   END.                                
END PROCEDURE.

PROCEDURE huvud_UI :
   CREATE tidut. 
   ASSIGN
   SUBSTRING(tidut.UT,4) = "Tidfördelning för tjänsteställe:"
   SUBSTRING(tidut.UT,40) = OMRADETAB.NAMN     
   SUBSTRING(tidut.UT,70) = STRING(TODAY)
   SUBSTRING(tidut.UT,80) = STRING(TIME,"HH:MM:SS").
   CREATE tidut.  
   ASSIGN
   SUBSTRING(tidut.UT,4) = "Namn:"
   SUBSTRING(tidut.UT,10) = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN.
   IF Guru.Konstanter:globforetag = "GKAL" THEN musz = musz.
   ELSE SUBSTRING(tidut.UT,70) = STRING(PERSONALTAB.PERSONNUMMER,"999999-9999").
   ASSIGN
   SUBSTRING(tidut.UT,82) = "Sign:"
   SUBSTRING(tidut.UT,88) = PERSONALTAB.PERSONALKOD.
   Guru.GlobalaVariabler:GDPRvem = Guru.GlobalaVariabler:GDPRvem + "," + PERSONALTAB.PERSONALKOD.
           
   DO:
      CREATE tidut.
      ASSIGN SUBSTRING(tidut.UT,4) ="".
      IF korda = 1 THEN ASSIGN SUBSTRING(tidut.UT,4) = "GODKÄNDA TIDSEDLAR:".
      ELSE IF korda = 2 THEN ASSIGN SUBSTRING(tidut.UT,4) = "GODKÄNDA TIDSEDLAR EJ VECKOKÖRDA:".
      ELSE IF korda = 3 THEN ASSIGN SUBSTRING(tidut.UT,4) = "TIDSEDLAR FÄRDIGA FÖR GODKÄNNANDE:".
      IF RAD_TIDSVAL = 3 THEN DO:
         ASSIGN SUBSTRING(tidut.UT,4) = "TIDSEDLAR EJ GODKÄNDA:".
         knappvar = FALSE.         
      END.
      ELSE DO:
         FIND FIRST GODKOLL WHERE 
         GODKOLL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND               
         GODKOLL.DATAR = YEAR(bdatum) AND GODKOLL.DATMAN = MONTH(bdatum) 
         USE-INDEX PKODAR NO-LOCK NO-ERROR.
         IF AVAILABLE GODKOLL THEN DO:
            DEBUGGER:SET-BREAK().
            /*forfärdig*/            
            DO:                                           
               FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
               YEAR(TIDREGITAB.DATUM) = YEAR(GODKOLL.DATUM) AND MONTH(TIDREGITAB.DATUM) = MONTH(GODKOLL.DATUM)
               AND TIDREGITAB.DATUM LE GODKOLL.DATUM NO-LOCK NO-ERROR.                
               IF AVAILABLE TIDREGITAB THEN DO:
                  IF korda = 1 OR korda = 2 OR korda = 3 THEN musz = musz.
                  ELSE IF TIDREGITAB.GODKAND = "F" THEN DO:                      
                     FIND LAST tidbuff WHERE tidbuff.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
                     YEAR(tidbuff.DATUM) = YEAR(GODKOLL.DATUM) AND MONTH(tidbuff.DATUM) = MONTH(GODKOLL.DATUM)
                     AND tidbuff.DATUM LE GODKOLL.DATUM AND tidbuff.GODKAND BEGINS "G" NO-LOCK NO-ERROR.                
                     IF AVAILABLE tidbuff THEN DO:
                        ASSIGN SUBSTRING(tidut.UT,10) = "GODKÄND TILL OCH MED " + STRING(tidbuff.DATUM).
                        ASSIGN SUBSTRING(tidut.UT,40) = "FÄRDIG FÖR GODKÄNNANDE TILL OCH MED " + STRING(GODKOLL.DATUM).                                                
                     END.
                     ELSE ASSIGN SUBSTRING(tidut.UT,40) = "FÄRDIG FÖR GODKÄNNANDE TILL OCH MED " + STRING(GODKOLL.DATUM).                     
                  END.                  
                  ELSE IF TIDREGITAB.GODKAND BEGINS "G" THEN DO: 
                     ASSIGN SUBSTRING(tidut.UT,10,30) = "                              "
                     SUBSTRING(tidut.UT,40) = "GODKÄND TILL OCH MED " + STRING(GODKOLL.DATUM).                    
                  END.                  
                  IF GODKOLL.KLAR = TRUE THEN DO:
                     FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
                     YEAR(TIDREGITAB.DATUM) = YEAR(GODKOLL.DATUM) AND MONTH(TIDREGITAB.DATUM) = MONTH(GODKOLL.DATUM)
                     AND TIDREGITAB.GODKAND = "F" NO-LOCK NO-ERROR.                
                     IF AVAILABLE TIDREGITAB THEN knappvar = FALSE.                                       
                     ELSE knappvar = TRUE.
                  END.   
                  ELSE knappvar = FALSE.                                       
               END.   
               ELSE DO:                                    
                  ASSIGN
                  SUBSTRING(tidut.UT,40) = "GODKÄND TILL OCH MED " + STRING(GODKOLL.DATUM).            
                  IF GODKOLL.KLAR = TRUE THEN DO:
                     FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
                     YEAR(TIDREGITAB.DATUM) = YEAR(GODKOLL.DATUM) AND MONTH(TIDREGITAB.DATUM) = MONTH(GODKOLL.DATUM)
                     AND TIDREGITAB.GODKAND = "F" NO-LOCK NO-ERROR.                
                     IF AVAILABLE TIDREGITAB THEN knappvar = FALSE.                                       
                     ELSE knappvar = TRUE.
                  END.   
                  ELSE knappvar = FALSE.                                         
               END.                     
            END.         
         END.
         ELSE knappvar = FALSE.         
      END.                  
   END.  
   CREATE tidut.      
   regmnr = MONTH(bdatum).
   RUN MANNAMN.P.
   ASSIGN
   SUBSTRING(tidut.UT,4) = "Månad:" 
   SUBSTRING(tidut.UT,12) = regmannamn
   SUBSTRING(tidut.UT,23) = "År:" 
   SUBSTRING(tidut.UT,27) = STRING(YEAR(bdatum)).     
   CREATE tidut.                                                  
   ASSIGN
   SUBSTRING(tidut.UT,8) = "Start"
   SUBSTRING(tidut.UT,14) = "Slut"     
   SUBSTRING(tidut.UT,20) = "Tid i"
   SUBSTRING(tidut.UT,64) = "Enkel"
   SUBSTRING(tidut.UT,70) = "Kval"
   SUBSTRING(tidut.UT,76) =  "Lönetillägg"
   SUBSTRING(tidut.UT,91) = "Traktamente"     
   SUBSTRING(tidut.UT,115) = "Beredskap".
   
   CREATE tidut.                         
   ASSIGN
   SUBSTRING(tidut.UT,1) = "Dag"
   SUBSTRING(tidut.UT,5) = "Da"     
   SUBSTRING(tidut.UT,8) = "ti mi"
   SUBSTRING(tidut.UT,14) = "ti mi"
   SUBSTRING(tidut.UT,20) = "ti mi"
   SUBSTRING(tidut.UT,26) = CAPS(Guru.Konstanter:gaok)
   SUBSTRING(tidut.UT,37) = "Ort"     
   SUBSTRING(tidut.UT,58) = "Kod"
   SUBSTRING(tidut.UT,64) = "ti mi"
   SUBSTRING(tidut.UT,70) = "ti mi"
   SUBSTRING(tidut.UT,76) = "Kod"
   SUBSTRING(tidut.UT,81) = "Antal"  
   SUBSTRING(tidut.UT,87) = "Kr"
   SUBSTRING(tidut.UT,91) = "Kod"
   SUBSTRING(tidut.UT,97) = "St"  
   SUBSTRING(tidut.UT,103) = "Kr"
   SUBSTRING(tidut.UT,115) = "Kod"
   SUBSTRING(tidut.UT,121) = beren  
   SUBSTRING(tidut.UT,127) = "Kr".    
   CREATE tidut.                  
   ASSIGN
   SUBSTRING(tidut.UT,1) = str.   
END PROCEDURE.

PROCEDURE lontill_UI :
      /* LÖNETILLAGG*/
   ASSIGN 
   lonraknare = 0.
   IF (Guru.Konstanter:globforetag = "GRAN"  OR Guru.Konstanter:globforetag = "ELPA") THEN DO:      
      regdatum = startdatum.
      REPEAT:
         IF regdatum > slutdatum THEN LEAVE.
         FOR EACH tidsedel WHERE tidsedel.LAGBAS = TRUE AND tidsedel.DATUM = regdatum:
            IF tidsedel.LONTILLAGG = "" THEN NEXT.
            FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = tidsedel.LONTILLAGG AND
            LONTILL.KOD = varansf
            USE-INDEX LONTIL NO-LOCK NO-ERROR.      
            IF NOT AVAILABLE LONTILL THEN DO:
               /*Om personen bytt avtal skall det inte spåra ur*/
               FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = tidsedel.LONTILLAGG                
               USE-INDEX LONTIL NO-LOCK NO-ERROR.      
            END.
            IF AVAILABLE LONTILL AND LONTILL.ENHET = "TI" THEN DO:
               nytid = tidsedel.LONTILLANTAL.
               RUN TIMSEK.P.
               ASSIGN tidsedel.LONTILLANTAL = 0
               lagbas = lagbas + sekunder
               tidsedel.ENHET = LONTILL.ENHET.    
            end.                              
            trec = RECID(tidsedel).
         END.                                   
         IF lagbas > 0 THEN DO:    
            FIND tidsedel WHERE RECID(tidsedel) = trec NO-ERROR. 
            sekunder = lagbas.
            RUN SEKTIM.P.
            ASSIGN  
            tidsedel.LONTILLAGG = LONTILL.LONTILLAGG
            tidsedel.LONTILLANTAL = nytid
            lagbas = 0.
         END. 
         regdatum = regdatum + 1.
      END.   
   END.   
   FOR EACH tidsedel BY tidsedel.LONTILLAGG:
      IF tidsedel.LONTILLAGG = "" THEN NEXT.
      FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = tidsedel.LONTILLAGG AND
      LONTILL.KOD = varansf
      USE-INDEX LONTIL NO-LOCK NO-ERROR.
      IF NOT AVAILABLE LONTILL THEN DO:
         /*Om personen bytt avtal ska inte programmet spåra ut*/
         FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = tidsedel.LONTILLAGG       
         USE-INDEX LONTIL NO-LOCK NO-ERROR.
      END.
      lers = LONTILL.ERSATTNING.             
      ASSIGN tidsedel.ENHET = LONTILL.ENHET.
      IF AVAILABLE LONTILL AND LONTIL.ENHET = "TI" THEN DO:
         nytid = tidsedel.LONTILLANTAL.
         RUN TIMSEK.P.
         ASSIGN tidsedel.LONTILLANTAL = sekunder. 
      end.
      ELSE DO: 
         FIND FIRST MALTAB WHERE MALTAB.AVDRAGSKOD = tidsedel.LONTILLAGG
         USE-INDEX MALTAB NO-LOCK NO-ERROR.
         IF AVAILABLE MALTAB THEN DO:                           
            lers = LONTILL.ERSATTNING * (-1).               
         END.                           
      END.      
      IF Guru.Konstanter:globforetag = "LULE" THEN DO: 
         IF tidsedel.LONTILLAGG = "930" OR tidsedel.LONTILLAGG = "931" THEN lers = LONTILL.ERSATTNING * (-1).                        
      END.                
      ASSIGN tidsedel.LONTILLAGG = LONTILL.VILART.   
      IF LONTILL.ERSATTNING  > 0 THEN ASSIGN tidsedel.LERSATTNING =  lers * tidsedel.LONTILLANTAL.      
   END.                                              
   FOR EACH tidsedel BREAK BY tidsedel.LONTILLAGG:     
      IF tidsedel.LONTILLANTAL = 0 THEN NEXT. 
      ACCUMULATE tidsedel.LONTILLANTAL (TOTAL BY tidsedel.LONTILLAGG).  
      ACCUMULATE tidsedel.LERSATTNING (TOTAL BY tidsedel.LONTILLAGG). 
      IF LAST-OF(tidsedel.LONTILLAGG) THEN DO:
         lonraknare = lonraknare + 1.              
         ASSIGN
         arrlsum[lonraknare] = (ACCUM TOTAL BY tidsedel.LONTILLAGG tidsedel.LONTILLANTAL)         
         arrlesum[lonraknare] = (ACCUM TOTAL BY tidsedel.LONTILLAGG tidsedel.LERSATTNING)  
         arrlsumkod[lonraknare] = tidsedel.LONTILLAGG  
         arrlenh[lonraknare] = tidsedel.ENHET.                   
      END.
   END.             
   lonsummax = lonraknare.    
   IF lonsummax = 0 THEN RETURN.
   lonraknare = 0.  
   FOR EACH tidsedel BY tidsedel.LONTILLAGG:
      IF tidsedel.LONTILLANTAL = 0 THEN NEXT.
      IF tidsedel.ENHET NE "TI" THEN NEXT.
      sekunder = tidsedel.LONTILLANTAL.
      RUN SEKTIM.P.
      ASSIGN tidsedel.LONTILLANTAL = nytid
      tidsedel.LERSATTNING =  tidsedel.LERSATTNING / 3600.             
   END.                                 
   REPEAT:
      lonraknare = lonraknare + 1.     
      IF lonraknare > lonsummax THEN LEAVE.     
      IF arrlenh[lonraknare] NE "TI" THEN NEXT.  
      sekunder = arrlsum[lonraknare].
      RUN SEKTIM.P.
      arrlsum[lonraknare] = nytid. 
      arrlesum[lonraknare] = arrlesum[lonraknare] / 3600.                          
   END.                        
END PROCEDURE.

PROCEDURE noll_UI :
   /* NOLLSTÄLLNING*/ 
   EMPTY TEMP-TABLE tidut NO-ERROR. 
   EMPTY TEMP-TABLE tidsedel NO-ERROR. 
   EMPTY TEMP-TABLE overtidhj NO-ERROR.    
   ASSIGN      
   berraknare = 0
   bermax = 0  
   bersummax = 0 
   lonraknare = 0    
   lonsummax = 0   
   trasummax = 0 
   traraknare = 0   
   ovesummax = 0 
   overaknare = 0 
   sekunder1 = 0   
   sekunder2 = 0  
   sekunder3 = 0    
   arrhjsum = 0  
   arrhjesum = 0  
   arrbsumkod = ""
   arrbsum = 0
   arrbdag = "" 
   arrbdatum = ?
   arrbkod = ""
   arrbantal = 0    
   arrlenh = "" 
   arrlkod = ""
   arrlantal = 0
   arrlsum = 0   
   arrlesum = 0  
   arrlsumkod = ""
   arrtidsum = 0
   arrfrsum = 0
   arrressum = 0  
   arrtsumkod = ""
   arrtsum = 0    
   arrosumkod = ""
   arrosum = 0                                                  
   luft1 = 0.    
   luft2 = 0.         
END PROCEDURE.



&ANALYZE-SUSPEND _UIB-CODE-BLOCK _PROCEDURE overtill_UI WINDOW-2 
PROCEDURE overtill_UI :
/* -----------------------------------------------------------
  Purpose:     
  Parameters:  <none>
  Notes:       
-------------------------------------------------------------*/
      /* ÖVERTID*/     
   FOR EACH tidsedel WHERE tidsedel.ENY = FALSE AND tidsedel.OKOD1 NE "" BY tidsedel.OKOD1:
      ASSIGN 
      tidsedel.OVERTIDTILL = tidsedel.OKOD1
      tidsedel.OVERANTAL = tidsedel.OANT1
      tidsedel.ENY = TRUE.  
      IF tidsedel.OKOD2 = "" THEN NEXT.      
      CREATE sedelbuff.
      ASSIGN    
      sedelbuff.DAG = tidsedel.DAG 
      sedelbuff.START = tidsedel.START
      sedelbuff.SLUT = tidsedel.START
      sedelbuff.DATUM = tidsedel.DATUM
      sedelbuff.AONR = tidsedel.AONR
      sedelbuff.DELNR = tidsedel.DELNR
      sedelbuff.ORT = tidsedel.ORT
      sedelbuff.OVERTIDTILL = tidsedel.OKOD2
      sedelbuff.OVERANTAL = tidsedel.OANT2
      sedelbuff.UTRYCKNING = tidsedel.UTRYCKNING
      sedelbuff.ENY = TRUE
      sedelbuff.NODF = tidsedel.NODF.      
      IF tidsedel.OKOD3 = "" THEN NEXT.      
      CREATE sedelbuff.
      ASSIGN    
      sedelbuff.DAG = tidsedel.DAG
      sedelbuff.START = tidsedel.START
      sedelbuff.SLUT = tidsedel.START
      sedelbuff.DATUM = tidsedel.DATUM
      sedelbuff.AONR = tidsedel.AONR
      sedelbuff.DELNR = tidsedel.DELNR
      sedelbuff.ORT = tidsedel.ORT
      sedelbuff.OVERTIDTILL = tidsedel.OKOD3
      sedelbuff.OVERANTAL = tidsedel.OANT3        
      sedelbuff.UTRYCKNING = tidsedel.UTRYCKNING
      sedelbuff.ENY = TRUE
      sedelbuff.NODF = tidsedel.NODF.      
   END.                             
   REPEAT:
      FIND FIRST tidsedel WHERE tidsedel.ENKEL = "" AND tidsedel.OVERTIDTILL NE "" USE-INDEX PSTART NO-ERROR.
      IF NOT AVAILABLE tidsedel THEN LEAVE.  
      ASSIGN tidove = tidsedel.OVERTIDTILL.
      FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = tidsedel.OVERTIDTILL AND
      OVERKOD.KOD = varansf 
      USE-INDEX OVER NO-LOCK NO-ERROR.
      IF NOT AVAILABLE OVERKOD THEN DO:
         FOR EACH tidsedel WHERE tidsedel.OVERTIDTILL = tidove:
            ASSIGN tidsedel.ENKEL = "ENKE". 
         END.
      END.    
      ELSE DO:       
         FOR EACH tidsedel WHERE tidsedel.OVERTIDTILL = tidove AND tidsedel.ENKEL = "":
            ASSIGN tidsedel.ENKEL = OVERKOD.ENKEL
            tidsedel.OVERTIDTILL = OVERKOD.VILART.
         END.
      END.   
   END.      
   ASSIGN     
   luft1 = 0    
   luft2 = 0   
   overaknare = 0  
   arrhjsum = 0.  
   energiavt = FALSE.      
   IF (Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV") THEN ASSIGN energiavt = TRUE.
   IF Guru.Konstanter:globforetag = "LULE" THEN ASSIGN energiavt = TRUE.
   FOR EACH tidsedel:
      ASSIGN 
      sekunder = 0
      sekunder1 = 0
      sekunder2 = 0
      sekunder3 = 0.                        
      IF tidsedel.OVERANTAL > 0  THEN DO:      
         CREATE overtidhj.
         nytid = tidsedel.OVERANTAL.
         RUN TIMSEK.P.
         sekunder1 = sekunder. 
         ASSIGN 
         overtidhj.OVERANTAL = sekunder 
         overtidhj.OVERTIDTILL = tidsedel.OVERTIDTILL.                        
      END. 
      IF AVAILABLE UTRYCKNING THEN DO:
         IF UTRYCKNING.PARA8 = TRUE AND tidsedel.NODF = TRUE AND 
         tidsedel.OVERAUTO = TRUE THEN DO:         
            IF tidsedel.OVERANTAL = 0 THEN nytid = nytid.
            ELSE DO:
               nytid = tidsedel.TOTALT.
               RUN TIMSEK.P.
               luft1 = luft1 + sekunder1.
            END.
         END.
         ELSE IF UTRYCKNING.PARA8 = TRUE AND tidsedel.UTRYCKNING = TRUE AND 
         tidsedel.OVERAUTO = TRUE THEN DO:         
            IF tidsedel.OVERANTAL = 0 AND tidsedel.START = 0 AND 
            tidsedel.SLUT > 0 THEN DO:
               FIND FIRST tidsbuff WHERE tidsbuff.DATUM = tidsedel.DATUM - 1 AND 
               tidsbuff.AONR = tidsedel.AONR AND tidsbuff.DELNR = tidsedel.DELNR AND 
               tidsbuff.START NE tidsbuff.SLUT AND tidsbuff.SLUT = 24 NO-ERROR.
               IF AVAILABLE tidsbuff THEN DO:
                  nytid = tidsedel.TOTALT.
                  RUN TIMSEK.P.
                  luft1 = luft1  - sekunder.
               END.
            END.
            ELSE IF tidsedel.OVERANTAL = 0 THEN nytid = nytid.
            ELSE DO:
               nytid = tidsedel.TOTALT.
               RUN TIMSEK.P.
               luft1 = luft1 + sekunder1 - sekunder.
            END.
         END. 
         ELSE IF UTRYCKNING.PARA8 = TRUE AND energiavt = TRUE AND 
         tidsedel.OVERAUTO = TRUE THEN DO:         
            IF tidsedel.OVERANTAL = 0 THEN nytid = nytid.
            ELSE DO:
               nytid = tidsedel.TOTALT.
               RUN TIMSEK.P.            
               luft1 = luft1 + sekunder1 - sekunder.
            END.
         END.
      END.        
   END.   
   FOR EACH overtidhj BREAK BY overtidhj.OVERTIDTILL:
      IF overtidhj.OVERANTAL = 0 THEN NEXT. 
      ACCUMULATE overtidhj.OVERANTAL (TOTAL BY overtidhj.OVERTIDTILL).
      IF LAST-OF(overtidhj.OVERTIDTILL) THEN DO:
         ASSIGN 
         overaknare = overaknare + 1
         arrosum[overaknare] = (ACCUM TOTAL BY overtidhj.OVERTIDTILL overtidhj.OVERANTAL)
         arrosumkod[overaknare] = overtidhj.OVERTIDTILL.                     
      END.
   END.  
   ASSIGN    
   ovesummax = overaknare      
   overaknare = 0. 
   IF ovesummax = 0 THEN RETURN.
   REPEAT:
      overaknare = overaknare + 1.     
      IF overaknare > ovesummax THEN LEAVE.     
      sekunder = arrosum[overaknare].
      RUN SEKTIM.P.
      arrosum[overaknare] = nytid.                          
   END.                              
   sekunder = luft1.
   RUN SEKTIM.P.
   luft2 = nytid.                                        
END PROCEDURE.


PROCEDURE skaptidsed_UI :
   /*FLYTTA FRÅN TIDREGITAB TILL TIDSEDEL*/
   IF RAD_TIDSVAL = 2 AND korda = 2  OR korda = 3 THEN DO:
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE 
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.VECKOKORD = "" AND YEAR(TIDREGITAB.DATUM) = YEAR(bdatum) AND 
      MONTH(TIDREGITAB.DATUM) = MONTH(bdatum) USE-INDEX PVKORD NO-LOCK.
   END.  
   ELSE DO:
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE 
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDREGITAB.DATUM) = YEAR(bdatum) AND 
      MONTH(TIDREGITAB.DATUM) = MONTH(bdatum) 
      USE-INDEX PSTART NO-LOCK.
   END.
   GET FIRST tidq NO-LOCK.
   DO WHILE AVAILABLE(TIDREGITAB):   
      IF TIDREGITAB.DATUM > slutdatum THEN musz = TRUE.
      IF TIDREGITAB.DATUM > avdatum THEN musz = TRUE. 
      ELSE IF TIDREGITAB.DATUM < bdatum THEN musz = TRUE. 
      ELSE DO:
         IF RAD_TIDSVAL = 1 THEN musz = FALSE.      
         IF RAD_TIDSVAL = 2 AND (korda = 2 OR korda = 1) THEN DO:                    
            IF TIDREGITAB.GODKAND = "" THEN musz = TRUE.            
            IF TIDREGITAB.GODKAND = "F" THEN musz = TRUE.
         END.
         IF RAD_TIDSVAL = 2 AND korda = 3 THEN DO:                    
            IF TIDREGITAB.GODKAND = "" THEN musz = TRUE.            
            IF TIDREGITAB.GODKAND BEGINS "G" THEN musz = TRUE.
         END.
         IF RAD_TIDSVAL = 3 THEN IF TIDREGITAB.GODKAND NE "" THEN musz = TRUE.                     
      END.   
      IF musz = TRUE THEN musz = FALSE.           
      ELSE DO:                  
         CREATE tidsedel.
         ASSIGN
         tidsedel.AONR = TIDREGITAB.AONR 
         tidsedel.BERANTAL = TIDREGITAB.BERANTAL 
         tidsedel.BEREDSKAP = TIDREGITAB.BEREDSKAP 
         tidsedel.DAG = TIDREGITAB.DAG 
         tidsedel.DATUM = TIDREGITAB.DATUM 
         tidsedel.DELNR = TIDREGITAB.DELNR 
         tidsedel.ENFLERDAGS = TIDREGITAB.ENFLERDAGS 
         tidsedel.GODKAND = TIDREGITAB.GODKAND
         tidsedel.VECKOKORD = TIDREGITAB.VECKOKORD 
         tidsedel.LAGBAS = TIDREGITAB.LAGBAS
         tidsedel.LONAUTO = TIDREGITAB.LONAUTO 
         tidsedel.LONTILLAGG = TIDREGITAB.LONTILLAGG 
         tidsedel.LONTILLANTAL = TIDREGITAB.LONTILLANTAL 
         tidsedel.OANT1 = TIDREGITAB.OANT1 
         tidsedel.OANT2 = TIDREGITAB.OANT2 
         tidsedel.OANT3 = TIDREGITAB.OANT3 
         tidsedel.OKOD1 = TIDREGITAB.OKOD1 
         tidsedel.OKOD2 = TIDREGITAB.OKOD2 
         tidsedel.OKOD3 = TIDREGITAB.OKOD3          
         tidsedel.OVERAUTO = TIDREGITAB.OVERAUTO 
         tidsedel.RECTIDVIS = TIDREGITAB.RECTIDVIS 
         tidsedel.RESMAL = TIDREGITAB.RESMAL 
         tidsedel.SLUT = TIDREGITAB.SLUT 
         tidsedel.START = TIDREGITAB.START 
         tidsedel.TOTALT = TIDREGITAB.TOTALT
         tidsedel.TRAKTKOD = TIDREGITAB.TRAKTKOD 
         tidsedel.TRAKTANTAL = TIDREGITAB.TRAKTANTAL      
         tidsedel.VECKONUMMER = TIDREGITAB.VECKONUMMER
         tidsedel.UTRYCKNING = TIDREGITAB.UTRYCKNING
         tidsedel.PRISTYP = TIDREGITAB.PRISTYP
         tidsedel.BILFORARE = TIDREGITAB.BILFORARE
         tidsedel.NODF = TIDREGITAB.NODF
         tidsedel.TIDLOG = TIDREGITAB.TIDLOG.               
      END.
      GET NEXT tidq NO-LOCK.
   END.
   FOR EACH tidsedel WHERE tidsedel.RESMAL NE "":
      CREATE resmaltidsedel. 
      BUFFER-COPY tidsedel TO resmaltidsedel.
   END.
   FOR EACH tidsedel WHERE tidsedel.LONTILLAGG NE "" AND 
   tidsedel.START = tidsedel.SLUT USE-INDEX PTIDS:
      FIND FIRST tidsbuff WHERE tidsbuff.DATUM = tidsedel.DATUM AND 
      tidsbuff.AONR = tidsedel.AONR AND tidsbuff.DELNR = tidsedel.DELNR AND 
      tidsbuff.START NE tidsbuff.SLUT AND tidsbuff.LONTILLAGG = "" NO-ERROR.
      IF AVAILABLE tidsbuff THEN DO:
         ASSIGN  
         tidsbuff.LONTILLAGG = tidsedel.LONTILLAGG
         tidsbuff.LONTILLANTAL = tidsedel.LONTILLANTAL.
         IF tidsedel.RESMAL NE "" AND tidsbuff.RESMAL = "" THEN ASSIGN tidsbuff.RESMAL = tidsedel.RESMAL.
         IF tidsedel.ENFLERDAGS NE "" THEN ASSIGN tidsbuff.ENFLERDAGS = tidsedel.ENFLERDAGS.          
         DELETE tidsedel.
      END.
   END.            
END PROCEDURE.

PROCEDURE skapaut_UI :   
     /*UT BILDEN*/   
str="------------------------------------------------------------------------------------------------------------------------------------".        
   REPEAT:
      FIND FIRST tidsedel WHERE tidsedel.ORT = "" USE-INDEX PSTART NO-ERROR.
      IF NOT AVAILABLE tidsedel THEN LEAVE.
      ASSIGN   
      tidao = tidsedel.AONR
      tiddelnr = tidsedel.DELNR.      
      IF tidsedel.AONR = "" THEN DO:
         ASSIGN tidsedel.ORT = "_". 
         NEXT.
      END.   
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = tidsedel.AONR AND 
      AONRTAB.DELNR = tidsedel.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF NOT AVAILABLE AONRTAB THEN DO:
         FOR EACH tidsedel WHERE tidsedel.AONR = tidao AND tidsedel.DELNR = tiddelnr:
            ASSIGN tidsedel.ORT = CAPS(Guru.Konstanter:gaok) + " FINNS EJ". 
         END. 
      END.    
      ELSE DO: 
         FOR EACH tidsedel WHERE tidsedel.AONR = tidao AND tidsedel.DELNR = tiddelnr:
            IF AONRTAB.ORT = "" THEN ASSIGN tidsedel.ORT = "?". 
            ELSE ASSIGN tidsedel.ORT = AONRTAB.ORT. 
         END.
      END.   
   END.                                      
   FOR EACH tidsedel WHERE tidsedel.ENY = FALSE AND tidsedel.OKOD1 NE "" BY tidsedel.OKOD1:
      ASSIGN 
      tidsedel.OVERTIDTILL = tidsedel.OKOD1
      tidsedel.OVERANTAL = tidsedel.OANT1
      tidsedel.ENY = TRUE.  
      IF tidsedel.OKOD2 = "" THEN NEXT.      
      CREATE sedelbuff.
      ASSIGN    
      sedelbuff.DAG = tidsedel.DAG 
      sedelbuff.START = tidsedel.START
      sedelbuff.SLUT = tidsedel.START
      sedelbuff.DATUM = tidsedel.DATUM
      sedelbuff.AONR = tidsedel.AONR
      sedelbuff.DELNR = tidsedel.DELNR
      sedelbuff.ORT = tidsedel.ORT
      sedelbuff.OVERTIDTILL = tidsedel.OKOD2
      sedelbuff.OVERANTAL = tidsedel.OANT2      
      sedelbuff.UTRYCKNING = tidsedel.UTRYCKNING
      sedelbuff.ENY = TRUE
      sedelbuff.NODF = tidsedel.NODF.      
      IF tidsedel.OKOD3 = "" THEN NEXT.      
      CREATE sedelbuff.
      ASSIGN    
      sedelbuff.DAG = tidsedel.DAG
      sedelbuff.DATUM = tidsedel.DATUM
      sedelbuff.AONR = tidsedel.AONR
      sedelbuff.DELNR = tidsedel.DELNR
      sedelbuff.ORT = tidsedel.ORT
      sedelbuff.OVERTIDTILL = tidsedel.OKOD3
      sedelbuff.OVERANTAL = tidsedel.OANT3
      sedelbuff.UTRYCKNING = tidsedel.UTRYCKNING
      sedelbuff.ENY = TRUE
      sedelbuff.NODF = tidsedel.NODF.      
   END.                             
   REPEAT:
      FIND FIRST tidsedel WHERE tidsedel.ENKEL = "" AND tidsedel.OVERTIDTILL NE "" USE-INDEX PSTART NO-ERROR.
      IF NOT AVAILABLE tidsedel THEN LEAVE.  
      tidove = tidsedel.OVERTIDTILL.      
      FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = tidsedel.OVERTIDTILL AND
      OVERKOD.KOD = varansf 
      USE-INDEX OVER NO-LOCK NO-ERROR.
      IF NOT AVAILABLE OVERKOD THEN DO:
         FOR EACH tidsedel WHERE tidsedel.OVERTIDTILL = tidove:
            ASSIGN tidsedel.ENKEL = "ENKE". 
         END.
      END.    
      ELSE DO: 
         FOR EACH tidsedel WHERE tidsedel.OVERTIDTILL = tidove:
            ASSIGN tidsedel.ENKEL = OVERKOD.ENKEL. 
         END.
      END.   
   END. 
   ASSIGN
   jamdag = ""
   berraknare = 0.  
   FOR EACH tidsedel USE-INDEX PSTART:
      IF tidsedel.TOTALT = 0 AND tidsedel.TRAKTANTAL = 0 AND 
      tidsedel.OVERANTAL = 0 AND tidsedel.LONTILLANTAL = 0 AND tidsedel.BERANTAL = 0 
      THEN NEXT.
      berraknare = berraknare + 1.
      IF Guru.Konstanter:globforetag = "CELPA" THEN DO:
         IF berraknare > 3 THEN DO:
            berraknare = 1.
            CREATE tidut. 
            ASSIGN tidut.UT = str.
         END.
      END.         
      ELSE DO:
         /*alltid streckrad mellan dagar om ej begärt annat*/          
         IF jamdag NE "" AND tidsedel.DAG NE jamdag THEN DO:          
            CREATE tidut. 
            ASSIGN tidut.UT = str.                   
         END.                   
         jamdag = tidsedel.DAG.
      END.          
      CREATE tidut. 
      ASSIGN
      SUBSTRING(tidut.UT,1) = tidsedel.DAG 
      SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(tidsedel.DATUM,"999999"),5,2).     
      IF tidsedel.START NE tidsedel.SLUT THEN DO:
         ASSIGN
         SUBSTRING(tidut.UT,8) = STRING(tidsedel.START,"99.99")
         SUBSTRING(tidut.UT,14) = STRING(tidsedel.SLUT,"99.99")
         SUBSTRING(tidut.UT,20) = STRING(tidsedel.TOTALT,"99.99").   
      END. 
      IF tidsedel.PRISTYP = "VÄNTETID." THEN ASSIGN SUBSTRING(tidut.UT,25) = "V".
      IF tidsedel.AONR NE "" THEN DO:
         ASSIGN   
         SUBSTRING(tidut.UT,26) = tidsedel.AONR
         SUBSTRING(tidut.UT,33) = STRING(tidsedel.DELNR,Guru.Konstanter:varforetypchar[1]). 
      END.
      ASSIGN SUBSTRING(tidut.UT,37) = SUBSTRING(tidsedel.ORT,1,20).               
      IF tidsedel.OVERANTAL > 0 THEN DO:
         ASSIGN SUBSTRING(tidut.UT,58) = tidsedel.OVERTIDTILL.     
         IF tidsedel.ENKEL = "ENKE" THEN ASSIGN SUBSTRING(tidut.UT,64) = STRING(tidsedel.OVERANTAL,"99.99").         
         ELSE ASSIGN SUBSTRING(tidut.UT,70) = STRING(tidsedel.OVERANTAL,"99.99").         
      END.                   
      IF tidsedel.LONTILLANTAL > 0 THEN DO:               
         IF tidsedel.ENHET = "KR" THEN DO:
            ASSIGN SUBSTRING(tidut.UT,76) =  tidsedel.LONTILLAGG.
            IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" THEN DO:                            
               IF tidsedel.LONTILLAGG = "8379" OR tidsedel.LONTILLAGG = "8388"                
               OR tidsedel.LONTILLAGG = "844" OR tidsedel.LONTILLAGG = "950" THEN ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL * (-1),"->>>>").               
               ELSE ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL,">>>>>").               
            END.
            ELSE IF Guru.Konstanter:globforetag = "LULE" THEN DO:             
               IF tidsedel.LONTILLAGG = "844" THEN ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL * (-1),"->>>>").               
               ELSE ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL,">>>>>").               
            END.
            ELSE IF Guru.Konstanter:globforetag = "GKAL" THEN DO:             
               IF tidsedel.LONTILLAGG = "MUTL" THEN ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL * (-1),"->>>>").               
               ELSE ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL,">>>>>").               
            END.
            ELSE ASSIGN SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LONTILLANTAL,">>>>>").               
         END.   
         ELSE IF tidsedel.LERSATTNING < 0 THEN DO:            
            ASSIGN SUBSTRING(tidut.UT,76) =  tidsedel.LONTILLAGG
            SUBSTRING(tidut.UT,81) =  STRING(tidsedel.LONTILLANTAL,"99.99")
            SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LERSATTNING,"->>>").
         END.             
         ELSE IF tidsedel.LONTILLANTAL < 100 THEN DO:
            ASSIGN SUBSTRING(tidut.UT,76) =  tidsedel.LONTILLAGG
            SUBSTRING(tidut.UT,81) =  STRING(tidsedel.LONTILLANTAL,"99.99")
            SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LERSATTNING,">>>>>").
         END.
         ELSE DO: 
            ASSIGN SUBSTRING(tidut.UT,76) =  tidsedel.LONTILLAGG
            SUBSTRING(tidut.UT,81) =  STRING(tidsedel.LONTILLANTAL)
            SUBSTRING(tidut.UT,86) =  STRING(tidsedel.LERSATTNING,">>>>>").
         END.                
      END.  
      IF tidsedel.TRAKTANTAL > 0 THEN DO:   
         ASSIGN SUBSTRING(tidut.UT,91) = tidsedel.TRAKTKOD
         SUBSTRING(tidut.UT,97) = STRING(tidsedel.TRAKTANTAL,">9").        
      END.     
      IF tidsedel.TERSATTNING > 0 THEN ASSIGN SUBSTRING(tidut.UT,103) = STRING(tidsedel.TERSATTNING,">99").              
      IF tidsedel.BERANTAL > 0 THEN DO:
         ASSIGN 
         SUBSTRING(tidut.UT,115) = tidsedel.BEREDSKAP
         SUBSTRING(tidut.UT,121) = STRING(tidsedel.BERANTAL,"99.99")
         SUBSTRING(tidut.UT,127) = STRING(tidsedel.BERSATTNING,">>>>").
         IF tidsedel.BERSATTNING > 0 THEN SUBSTRING(tidut.UT,121,6) = "     ".
      END.       
   END.                 
   ASSIGN berraknare = 0
   lontotkr = 0
   formtotkr = 0
   biltotkr = 0
   tratotkr = 0.
   str="====================================================================================================================================".
   CREATE tidut. 
   ASSIGN tidut.UT = str.
   
   REPEAT:
      CREATE tidut.   
      berraknare = berraknare + 1.  
      IF berraknare = 1 THEN DO:         
         IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "gkal" THEN ASSIGN SUBSTRING(tidut.UT,1) = "Arbetad tid:".
         ELSE ASSIGN SUBSTRING(tidut.UT,1) = "Reg. tid:".
         ASSIGN SUBSTRING(tidut.UT,20) = STRING(arrtidsum,">99.99").
      END.                   
      IF berraknare > ovesummax AND berraknare > bersummax AND 
      berraknare > trasummax AND 
      berraknare > lonsummax THEN LEAVE.  
      IF berraknare <= ovesummax THEN DO:
         ASSIGN SUBSTRING(tidut.UT,58,4) = arrosumkod[berraknare]                 
         SUBSTRING(tidut.UT,63) = STRING(arrosum[berraknare],">99.99").   
      END.       
      IF berraknare <= lonsummax THEN DO:         
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" THEN DO:         
            IF arrlsumkod[berraknare] = "8379" OR arrlsumkod[berraknare] = "8388"             
            OR arrlsumkod[berraknare] = "844" OR arrlsumkod[berraknare] = "950" THEN DO:                                               
               arrlsum[berraknare] = arrlsum[berraknare] * (-1).  
            END.
          END.
          IF Guru.Konstanter:globforetag = "LULE" THEN DO:         
            IF arrlsumkod[berraknare] = "844"  THEN DO:                                               
               arrlsum[berraknare] = arrlsum[berraknare] * (-1).  
            END.
          END.      
          IF Guru.Konstanter:globforetag = "GKAL" THEN DO:         
            IF arrlsumkod[berraknare] = "MUTL"  THEN DO:                                               
               arrlsum[berraknare] = arrlsum[berraknare] * (-1).  
            END.
          END.      
         IF arrlsum[berraknare] < 100 THEN DO:
            IF arrlsum[berraknare] = 0 THEN DO:
               ASSIGN SUBSTRING(tidut.UT,76,4) = ""
               SUBSTRING(tidut.UT,81) = "".
            END.                  
            ELSE IF arrlenh[berraknare] = "KR" THEN DO:              
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare].               
               SUBSTRING(tidut.UT,86) = STRING(arrlsum[berraknare],"->>>>").                 
            END.   
            ELSE IF arrlesum[berraknare] < 0 THEN DO:
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
               SUBSTRING(tidut.UT,80) = STRING(arrlsum[berraknare],">99.99")
               SUBSTRING(tidut.UT,86) = STRING(arrlesum[berraknare],"->>>>").   
            END.
            ELSE DO:              
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
               SUBSTRING(tidut.UT,81) = STRING(arrlsum[berraknare],"99.99")
               SUBSTRING(tidut.UT,86) = STRING(arrlesum[berraknare],">>>>>").   
            END.
         END.   
         ELSE IF arrlsum[berraknare] < 1000 THEN DO:
            IF arrlesum[berraknare] < 0 THEN DO:            
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
               SUBSTRING(tidut.UT,81) = STRING(arrlsum[berraknare])
               SUBSTRING(tidut.UT,86) = STRING(arrlesum[berraknare],"->>>>").  
            END.                             
            ELSE IF arrlenh[berraknare] = "KR" THEN DO:
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
               SUBSTRING(tidut.UT,86) = STRING(arrlsum[berraknare],"->>>>").  
            END. 
            ELSE DO:              
               ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
               SUBSTRING(tidut.UT,81) = STRING(arrlsum[berraknare],">99.9")
               SUBSTRING(tidut.UT,86) = STRING(arrlesum[berraknare],">>>>>").  
            END.
         END.
         ELSE IF arrlenh[berraknare] = "KR" THEN DO:
            ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
            SUBSTRING(tidut.UT,86) = STRING(arrlsum[berraknare],"->>>>").  
         END. 
         ELSE DO:           
            ASSIGN SUBSTRING(tidut.UT,76) = arrlsumkod[berraknare]                 
            SUBSTRING(tidut.UT,81) = STRING(arrlsum[berraknare],">>>99")
            SUBSTRING(tidut.UT,86) = STRING(arrlesum[berraknare],">>>>>").  
         END.
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:
            FIND FIRST LONTILL  WHERE LONTILL.LONTILLAGG = arrlsumkod[berraknare] NO-LOCK NO-ERROR.
            IF AVAILABLE LONTILL AND SUBSTRING(LONTILL.TYPKOD,1,3) = "BIL" THEN biltotkr = biltotkr + arrlesum[berraknare].            
            ELSE IF arrlsumkod[berraknare] = "7211" OR arrlsumkod[berraknare] = "7212" 
            OR arrlsumkod[berraknare] = "880" OR arrlsumkod[berraknare] = "881" THEN formtotkr = formtotkr + arrlesum[berraknare].            
            ELSE DO:
               IF arrlenh[berraknare] = "KR" THEN lontotkr = lontotkr + arrlsum[berraknare].               
               ELSE lontotkr = lontotkr + arrlesum[berraknare].               
            END.         
         END.
         ELSE IF Guru.Konstanter:globforetag = "LULE"  THEN DO:
            IF arrlsumkod[berraknare] = "881" THEN formtotkr = formtotkr + arrlesum[berraknare].            
            ELSE DO:
               IF arrlenh[berraknare] = "KR" THEN lontotkr = lontotkr + arrlsum[berraknare].               
               ELSE lontotkr = lontotkr + arrlesum[berraknare].               
            END.         
         END.
         ELSE lontotkr = lontotkr + arrlesum[berraknare].

      END.   
      IF berraknare <= trasummax   THEN DO:
         /*om lönetilläggsantal går ihop med traktamentskod - skapa ny tidut 2005-09-27 /Lena */
         IF SUBSTRING(tidut.UT,90,1) NE "" THEN CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,91) = arrtsumkod[berraknare].                          
         IF arrtsum[berraknare] = 0 THEN DO: 
            ASSIGN
            SUBSTRING(tidut.UT,91,4) = ""
            SUBSTRING(tidut.UT,97) = "".
         END.                
         ELSE DO:                                 
            ASSIGN
            SUBSTRING(tidut.UT,96) = STRING(arrtsum[berraknare],">>9")
            SUBSTRING(tidut.UT,103) = STRING(arrtesum[berraknare],">>>>").
         END.         
         tratotkr = tratotkr + arrtesum[berraknare].
      END.           
      IF berraknare <= bersummax   THEN DO:
         ASSIGN SUBSTRING(tidut.UT,115) = arrbsumkod[berraknare].                         
         IF arrbsum[berraknare] = 0 THEN DO:
            ASSIGN                     
            SUBSTRING(tidut.UT,115,4) = "" 
            SUBSTRING(tidut.UT,121) = "".  
         END.
         ELSE DO:
            ASSIGN
            SUBSTRING(tidut.UT,120) = STRING(arrbsum[berraknare],">99.99")
            SUBSTRING(tidut.UT,127) = STRING(arrbesum[berraknare],">>>>").         
            IF arrbesum[berraknare] > 0 THEN SUBSTRING(tidut.UT,120,6) = "     ".
         END.   
      END.                
   END.
   IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:
      IF lontotkr NE 0 OR tratotkr NE 0 THEN DO:
         CREATE tidut.         
         ASSIGN SUBSTRING(tidut.UT,76) = "Summa  kr:".         
         ASSIGN SUBSTRING(tidut.UT,86) = STRING(lontotkr + tratotkr,"->>>>").   
      END. 
      IF formtotkr NE 0 THEN DO:
         CREATE tidut.         
         ASSIGN SUBSTRING(tidut.UT,76) = "Förmån kr:".               
         ASSIGN SUBSTRING(tidut.UT,86) = STRING(formtotkr,"->>>>").   
      END. 
      IF biltotkr NE 0 THEN DO:
         CREATE tidut.         
         ASSIGN SUBSTRING(tidut.UT,76) = "Bil    kr:".               
         ASSIGN SUBSTRING(tidut.UT,86) = STRING(biltotkr,">>>>>").   
      END. 
   END. 
   IF arrfrsum > 0 THEN DO:
      CREATE tidut.           
      IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "gkal" THEN ASSIGN SUBSTRING(tidut.UT,1) = "Reg. frånvaro:". 
      ELSE ASSIGN SUBSTRING(tidut.UT,1) = "Varav frånvaro:".
      ASSIGN SUBSTRING(tidut.UT,20) = STRING(arrfrsum,">99.99").
   END.
   IF arrressum > 0 THEN DO:   
      CREATE tidut.           
      IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "gkal" THEN ASSIGN SUBSTRING(tidut.UT,1) = "Reg. restid:".
      ELSE ASSIGN SUBSTRING(tidut.UT,1) = "Varav restid:".
      ASSIGN SUBSTRING(tidut.UT,20) = STRING(arrressum,">99.99").
   END.   
   IF ordarbman > 0 THEN DO:
      CREATE tidut.
      ASSIGN SUBSTRING(tidut.UT,1) = "Ord. arbetstid:".
      ASSIGN SUBSTRING(tidut.UT,20) = STRING(klock60(ordarbman),">99.99").
      
     
      SUBSTRING(tidut.UT,33) = STRING(visstdat,"9999/99/99").
      SUBSTRING(tidut.UT,44) = "-".
      SUBSTRING(tidut.UT,46) = STRING(vissldat,"9999/99/99").
   END.
      
   IF AVAILABLE UTRYCKNING THEN DO:   
      IF UTRYCKNING.PARA8 = TRUE THEN DO:    
         CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,58) = "LUFT"
         SUBSTRING(tidut.UT,63) = STRING(luft2,">99.99").     
      END.
      ELSE DO:
         CREATE tidut.
      END.
   END.    
   IF Guru.Konstanter:globforetag = "ELPA" OR  Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" THEN DO:
      EMPTY TEMP-TABLE overtidhj2 NO-ERROR.
      EMPTY TEMP-TABLE oversum NO-ERROR.
      EMPTY TEMP-TABLE overhela NO-ERROR.       
      RUN kompinut_UI.
   END.   
   DEBUGGER:SET-BREAK().
   IF Guru.Konstanter:globforetag = "SNAT" THEN DO:
      RUN FINNSTABELL.P (INPUT "KOMPSALDO", OUTPUT komplog).
      IF komplog = TRUE THEN DO:   
         IF NOT VALID-HANDLE(kompapph) THEN RUN KOMPSMANTAB.P PERSISTENT SET kompapph.
         IF VALID-HANDLE(kompapph) THEN DO:
            DEBUGGER:SET-BREAK().
            RUN viskompsal IN kompapph (INPUT PERSONALTAB.PERSONALKOD, INPUT avdatum, OUTPUT acckompvman, OUTPUT acckompvmandat, OUTPUT acckompsenast,  OUTPUT acckompsenastdat).
            FIND FIRST overksum WHERE NO-LOCK NO-ERROR.
            IF AVAILABLE overksum THEN DO:                              
              acckompsenasttot  = klock60( acckompsenast + overksum.ANTMULT - overksum.KOMPUTTAG ).              
            END.   
            ELSE acckompsenasttot  = klock60( acckompsenast).            
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "Totalt kompsaldo:"
            SUBSTRING(tidut.UT,21) = STRING(acckompsenasttot,"->>9.99")                                                            
            SUBSTRING(tidut.UT,35) = "Inarbetad el uttagen komp sedan månadskörning:".
            IF AVAILABLE overksum THEN SUBSTRING(tidut.UT,92) = STRING(klock60(overksum.ANTMULT - overksum.KOMPUTTAG),"->>9.99").
            ELSE SUBSTRING(tidut.UT,92) = STRING(0,"->>9.99").
            IF berkomp > 0 THEN DO:
               CREATE tidut.
               ASSIGN
               SUBSTRING(tidut.UT,1) = "Varav kompsaldo pga lart 260- Fyllnadslön mot ledighet vid beredskap:".
               SUBSTRING(tidut.UT,92) = STRING(klock60(berkomp),"->>9.99").
            END.               
            CREATE tidut.
         END.
      END.
   END.        
   IF Guru.Konstanter:globforetag = "ELPA" OR  Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" THEN DO:
      /*SUMMERA ARBETSTIDSFÖRKORTNING I ÅR PÅ TIDSEDELN*/
      totarbkort = 0.
      FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.AONR = "160" AND TIDREGITAB.DELNR = 0
      AND YEAR(TIDREGITAB.DATUM) = YEAR(bdatum) AND TIDREGITAB.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(TIDREGITAB.TOTALT).
      END.
      
      FOR EACH TIDFEL WHERE TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDFEL.AONR = "160" AND TIDFEL.DELNR = 0
      AND YEAR(TIDFEL.DATUM) = YEAR(bdatum) AND TIDFEL.DEBET = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(TIDFEL.TOTALT).
      END.
      FOR EACH TIDFEL WHERE TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDFEL.AONR = "160" AND TIDFEL.DELNR = 0
      AND YEAR(TIDFEL.DATUM) = YEAR(bdatum) AND TIDFEL.DEBET = FALSE NO-LOCK:
         totarbkort = totarbkort - klock100(TIDFEL.TOTALT).
      END.
      
                     
      FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.AONR = "161"
      AND YEAR(TIDREGITAB.DATUM) = YEAR(bdatum) AND TIDREGITAB.TIDLOG = TRUE NO-LOCK:
         totarbkort = totarbkort + klock100(TIDREGITAB.TOTALT).
      END.          
           
      totarbkort = klock60(totarbkort).
      /*om det är många poster och det blir avrundning kan slutsumman bli 26.60 det vill säga 27 tim*/
      IF STRING( totarbkort - truncate(totarbkort,0),">99.99")  = STRING(0.60,">99.99") THEN totarbkort = truncate(totarbkort,0) + 1.           
      FIND FIRST overhela WHERE NO-LOCK NO-ERROR.
      IF AVAILABLE overhela THEN DO:
         CREATE tidut.                                                      
         ASSIGN
         SUBSTRING(tidut.UT,1) = "Intjänad komp    - övertid som den anställde valt kompledighet för, multiplicerat med 1,5 för enkel, 2 för kvalificerad kompledighet".
         CREATE tidut.                        
         ASSIGN
         SUBSTRING(tidut.UT,1) = "Uttagen komp     - tid som den anställde valt att ta ut kompensationsledighet. ".         
         CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,1) = "Intjänad komp i  år:"
         SUBSTRING(tidut.UT,25) = STRING(klock60(overhela.KOMPTOT),">99.99").                  
         ASSIGN SUBSTRING(tidut.UT,37) = "Uttagen komp i  år:"
         SUBSTRING(tidut.UT,56) = STRING(klock60(overhela.KOMPUTTOT),">99.99").
         CREATE tidut.
      END.
      ovinvar = 0.
      nodvar = 0.
      FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
      AND TIDREGITAB.DATUM GE DATE(01,01,YEAR(bdatum)) AND TIDREGITAB.DATUM LE DATE(12,31,YEAR(bdatum)) AND TIDREGITAB.OKOD1 NE ""  NO-LOCK:
         /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena */
         ovinvar = ovinvar + klock100(TIDREGITAB.TOTALT).
         IF TIDREGITAB.NODF = TRUE THEN DO:
            nodvar = nodvar + klock100(TIDREGITAB.TOTALT).
         END.   
      END.      
      IF ovinvar > 0 THEN DO:      
         CREATE tidut.                        
         ASSIGN
         SUBSTRING(tidut.UT,1) = "Verklig övertid, ej avrundad,  både övertid som är vald att ta ut i pengar och komptid.".
         CREATE tidut.                        
         ASSIGN
         SUBSTRING(tidut.UT,1) = "Verklig övertid i år:".
         SUBSTRING(tidut.UT,25) = STRING(klock60(ovinvar),">99.99").
         IF nodvar > 0 THEN DO:
            ASSIGN
            SUBSTRING(tidut.UT,40) = "Varav nödfallsövertid:".
            SUBSTRING(tidut.UT,65) = STRING(klock60(nodvar),">99.99").
         END.            
         CREATE tidut.
      END.                                      
      RUN atkgrans_UI (OUTPUT foremaxarbkort ).
            
      
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "AVAFOR"                   
      inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.
      
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
      IF AVAILABLE extradatatemp THEN DO:      
               
         IF  extradatatemp.SOKINT[1] > 0 THEN kvaratk = klock60(extradatatemp.SOKINT[1] - klock100(ROUND(totarbkort,2))).
         ELSE kvaratk = klock60(foremaxarbkort - klock100(ROUND(totarbkort,2))).
      END.   
      ELSE kvaratk = klock60(foremaxarbkort - klock100(ROUND(totarbkort,2))).   
      IF PERSONALTAB.OMREGTID = 0 THEN DO:
         CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,1) = "Uttagen ATK i  år:"
         SUBSTRING(tidut.UT,25) = STRING(totarbkort,">99.99").                  
         ASSIGN SUBSTRING(tidut.UT,37) = "Kvar ATK i  år:"
         SUBSTRING(tidut.UT,56) = STRING(kvaratk,">99.99").
      END.              
      FIND PERSONALTAB WHERE RECID(PERSONALTAB) = persrec NO-LOCK NO-ERROR.
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE extradatatemp NO-ERROR. 

      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "ATKFRISK"                   
      inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.   
      inextradatatemp.HUVUDINT = YEAR(bdatum).         
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
      IF AVAILABLE extradatatemp THEN DO:
         CREATE tidut.
         IF extradatatemp.SOKLOG[1] = FALSE AND extradatatemp.SOKLOG[5] = TRUE THEN DO:
            ASSIGN SUBSTRING(tidut.UT,1) = "ATK i tid för " + STRING(extradatatemp.HUVUDINT) + " : " + STRING(extradatatemp.SOKLOG[1],"Ja/Nej") + "    Löneväxla ATK: "  + STRING(extradatatemp.SOKLOG[5],"Ja/Nej") + "    Uppdaterad: " + STRING(extradatatemp.SOKDAT[1]).
         END.   
         ELSE DO:
            ASSIGN SUBSTRING(tidut.UT,1) = "ATK i tid för " + STRING(extradatatemp.HUVUDINT) + " : " + STRING(extradatatemp.SOKLOG[1],"Ja/Nej") + "         Uppdaterad: " + STRING(extradatatemp.SOKDAT[1]).   
         END.   
         IF extradatatemp.SOKDAT[2] NE ? THEN DO:
            ASSIGN tidut.UT = tidut.UT + " Godkänd: " + STRING(extradatatemp.SOKDAT[2]).
        END.                        
      END.
      EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
      EMPTY TEMP-TABLE extradatatemp NO-ERROR. 

      CREATE inextradatatemp.          
      ASSIGN
      inextradatatemp.PROGRAM = "ATKFRISK"                   
      inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.   
      inextradatatemp.HUVUDINT = YEAR(bdatum) + 1.         
      RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
      FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
      IF AVAILABLE extradatatemp THEN DO:
               
         CREATE tidut.
         IF extradatatemp.SOKLOG[1] = FALSE AND extradatatemp.SOKLOG[5] = TRUE THEN DO:
            ASSIGN SUBSTRING(tidut.UT,1) = "ATK i tid för " + STRING(extradatatemp.HUVUDINT) + " : " + STRING(extradatatemp.SOKLOG[1],"Ja/Nej") + "    Löneväxla ATK: "  + STRING(extradatatemp.SOKLOG[5],"Ja/Nej") + "    Uppdaterad: " + STRING(extradatatemp.SOKDAT[1]).
         END.
         ELSE DO:
            ASSIGN SUBSTRING(tidut.UT,1) = "ATK i tid för " + STRING(extradatatemp.HUVUDINT) + " : " + STRING(extradatatemp.SOKLOG[1],"Ja/Nej") + "         Uppdaterad: " + STRING(extradatatemp.SOKDAT[1]).   
         END.   
         IF extradatatemp.SOKDAT[2] NE ? THEN DO:
            ASSIGN tidut.UT = tidut.UT + " Godkänd: " + STRING(extradatatemp.SOKDAT[2]).
        END.                  
      END.         
      CREATE tidut.    
   END.   
    DEFINE VARIABLE semdagar AS DECIMAL NO-UNDO.            
   IF Guru.Konstanter:globforetag = "SNAT"  THEN DO:               
      RUN SEMTILLW.P (INPUT PERSONALTAB.PERSONALKOD , INPUT bdatum ,OUTPUT semdagar).                  
      IF  MONTH(bdatum) < 5 THEN DO:    
         CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,1) = "Hela dagar ledighet juni-augusti förra året:"
         SUBSTRING(tidut.UT,45) = STRING(semdagar,">99.99").
         CREATE tidut.             
         SUBSTRING(tidut.UT,1) = "Underlag för fastställande av   extra semestertillägg.". 
         CREATE tidut.
       END.
       ELSE DO:
          CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,1) = "Hela dagar ledighet juni-augusti i år:"
         SUBSTRING(tidut.UT,45) = STRING(semdagar,">99.99").
         CREATE tidut.     
         SUBSTRING(tidut.UT,1) = "Underlag för fastställande av   extra semestertillägg.".         
         CREATE tidut.
       END.

       tsem = 0.        
       sdag = ?.    
       FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
       AND TIDREGITAB.AONR = "150" AND TIDREGITAB.TIDLOG = TRUE AND YEAR(TIDREGITAB.DATUM) = YEAR(bdatum)  NO-LOCK:
          IF sdag NE TIDREGITAB.DATUM THEN DO:
             tsem = tsem + 1.
          END.  
          sdag = TIDREGITAB.DATUM.          
       END.
       IF tsem > 0 THEN DO:
          CREATE tidut.
          ASSIGN SUBSTRING(tidut.UT,1) = "Uttagna semesterdagar i år:"
          SUBSTRING(tidut.UT,45) = STRING(tsem,">99.99").
       END.                    
   END.            
   overnatt = 1.
   hjdat = 01/01/92.
   FOR EACH tidsedel WHERE tidsedel.ENFLERDAGS BEGINS "Flerdag" NO-LOCK:
      IF tidsedel.DATUM > hjdat + 1 THEN DO:
         overnatt = overnatt.
         hjdat = tidsedel.DATUM.
      END.
      ELSE DO:
         IF tidsedel.DATUM NE hjdat THEN DO:
            overnatt = overnatt + 1.
            hjdat = tidsedel.DATUM.
         END.
      END.
   END.
   overnatt = overnatt - 1.
   IF overnatt > 0 THEN DO:
      CREATE tidut.   
      ASSIGN tidut.UT = "".
      CREATE tidut.                           
      ASSIGN 
      SUBSTRING(tidut.UT,2) = "Faktisk övernattning på avstånd större än 50 km:"
      SUBSTRING(tidut.UT,51) = STRING(overnatt)
      SUBSTRING(tidut.UT,54) = "nätter".      
   END.  
   CREATE tidut.   
   ASSIGN tidut.UT = "".
   CREATE tidut.                           
   ASSIGN 
   SUBSTRING(tidut.UT,2) = "Riktighet intygas:____________________________________________"
   SUBSTRING(tidut.UT,72) = "Tidsedeln godkännes:_______________________________________".    
   /*alla har klartexter*/                         
   IF ovesummax = 0 AND lonsummax = 0 AND trasummax = 0 AND bersummax = 0 THEN musz = musz.
   ELSE DO:      
      CREATE tidut.   
      CREATE tidut.   
      ASSIGN
      SUBSTRING(tidut.UT,1) =  "Lart"
      SUBSTRING(tidut.UT,7) = "Klartext" 
      SUBSTRING(tidut.UT,40) =  "Lart"
      SUBSTRING(tidut.UT,46) = "Klartext"
      SUBSTRING(tidut.UT,79) =  "Lart"
      SUBSTRING(tidut.UT,85) = "Klartext"
      str2="=====.================================.=====.================================.=====.==================================================".
      CREATE tidut. 
      ASSIGN tidut.UT = str2.      
      berraknare = 0.
      REPEAT:         
         berraknare = berraknare + 1.      
         IF berraknare > ovesummax THEN LEAVE.  
         IF berraknare <= ovesummax THEN DO:
            IF arrosum[berraknare] > 0 THEN DO:
               CREATE klartextut.   
               ASSIGN SUBSTRING(klartextut.UT,1,4) = arrosumkod[berraknare].               
               FIND FIRST OVERKOD WHERE OVERKOD.VILART = arrosumkod[berraknare] AND
               OVERKOD.KOD = varansf NO-LOCK NO-ERROR.
               IF AVAILABLE OVERKOD THEN DO:                  
                  SUBSTRING(klartextut.UT,7,30) =  SUBSTRING(OVERKOD.LONKODTEXT,1,30).
               END.
            END.            
         END.       
      END.
      berraknare = 0.
      REPEAT:         
         berraknare = berraknare + 1.      
         IF berraknare > lonsummax THEN LEAVE.  
         IF berraknare <= lonsummax THEN DO:                                                                   
            IF arrlsum[berraknare] NE 0 THEN DO:
               CREATE klartextut.   
               ASSIGN SUBSTRING(klartextut.UT,1) = arrlsumkod[berraknare].
               FIND FIRST LONTILL WHERE LONTILL.VILART = arrlsumkod[berraknare] AND
               LONTILL.KOD = varansf
               USE-INDEX LONTIL NO-LOCK NO-ERROR.
               IF NOT AVAILABLE LONTILL THEN DO:
                  /*Om personen bytt avtal ska inte programmet spåra ut*/
                  FIND FIRST LONTILL WHERE LONTILL.VILART = arrlsumkod[berraknare] USE-INDEX LONTIL NO-LOCK NO-ERROR.
               END.
               IF AVAILABLE LONTILL THEN SUBSTRING(klartextut.UT,7,30) =  SUBSTRING(LONTILL.LONKODTEXT,1,30).                  
            END.                                             
         END.
      END.
      berraknare = 0.
      REPEAT:         
         berraknare = berraknare + 1.      
         IF berraknare > trasummax THEN LEAVE.  
         IF berraknare <= trasummax   THEN DO:           
            IF arrtsum[berraknare] > 0 THEN DO: 
               CREATE klartextut.   
               ASSIGN SUBSTRING(klartextut.UT,1) = arrtsumkod[berraknare].                          
               FIND FIRST TRAKTATAB WHERE TRAKTATAB.VILART = arrtsumkod[berraknare] AND
               TRAKTATAB.TRAAVTAL = vartraktav  USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
               IF NOT AVAILABLE TRAKTATAB THEN DO:
                  /*Om personen bytt avtal ska det inte spåra ur*/
                  FIND FIRST TRAKTATAB WHERE TRAKTATAB.VILART = arrtsumkod[berraknare]  USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
               END.
               IF AVAILABLE TRAKTATAB THEN SUBSTRING(klartextut.UT,7,30) =  SUBSTRING(TRAKTATAB.FORKL,1,30).                  
            END.            
         END.           
      END.
      berraknare = 0.      
      REPEAT:         
         berraknare = berraknare + 1.      
         IF berraknare > bersummax THEN LEAVE.  
         IF berraknare <= bersummax   THEN DO:            
            IF arrbsum[berraknare] > 0 THEN DO:
               CREATE klartextut.   
               ASSIGN SUBSTRING(klartextut.UT,1) = arrbsumkod[berraknare].                         
               FIND FIRST BERKOD WHERE BERKOD.VILART = arrbsumkod[berraknare] AND
               BERKOD.BEREDSKAPSAVTAL = varberav NO-LOCK NO-ERROR.
               IF NOT AVAILABLE BERKOD THEN DO:
                  /*Om personen bytt avtal ska det inte spåra ur*/
                  FIND FIRST BERKOD WHERE BERKOD.VILART = arrbsumkod[berraknare] NO-LOCK NO-ERROR.
               END.
               IF AVAILABLE BERKOD THEN SUBSTRING(klartextut.UT,7,30) =  SUBSTRING(BERKOD.LONKODTEXT,1,30).                  
            END.
         END.          
      END.
      hkoll1 = 1.
      hkoll2 = 7.
      FOR EACH klartextut NO-LOCK:
         IF hkoll1 = 1 THEN CREATE tidut.
         ASSIGN SUBSTRING(tidut.UT,hkoll1) = SUBSTRING(klartextut.UT,1)
         SUBSTRING(tidut.UT,hkoll2,30) = SUBSTRING(klartextut.UT,7,30).
         ASSIGN
         hkoll1 = hkoll1 + 39
         hkoll2 = hkoll2 + 39.
         IF hkoll1 > 80 THEN DO:
            ASSIGN
            hkoll1 = 1
            hkoll2 = 7.
         END.
      END.
      CREATE tidut. 
      ASSIGN tidut.UT = str2.    
   END.   
   IF Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" THEN DO:
      FIND FIRST FLEXAVT WHERE FLEXAVT.PERSONALKOD = PERSONALTAB.PERSONALKOD 
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
      IF AVAILABLE FLEXAVT THEN DO:
         IF FLEXAVT.FLEXTID = TRUE AND bdatum GE 01/01/99 THEN DO:
            CREATE tidut.            
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "Månadens flex".
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "=============".
       
            IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR  Guru.Konstanter:globforetag = "ELPA" THEN DO:
               EMPTY TEMP-TABLE ftemp NO-ERROR. 
               fltid = 0.
               fdatum = ?.
               GET FIRST tidq NO-LOCK.
               DO WHILE AVAILABLE (TIDREGITAB):               
                  IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.
                  ELSE IF TIDREGITAB.OVERTIDUTTAG NE "F" THEN musz = musz.
                  ELSE IF TIDREGITAB.PRISTYP = "RESTID..." THEN musz = musz.
                  ELSE IF TIDREGITAB.DATUM NE fdatum THEN DO:                  
                     regdatum = TIDREGITAB.DATUM.
                     regvnr = TIDREGITAB.VECKONUMMER.
                     RUN SLUTARB.P.            
                     CREATE ftemp.
                     ASSIGN
                     ftemp.DAG = TIDREGITAB.DAG
                     ftemp.DATUM = TIDREGITAB.DATUM
                     ftemp.OSTART = regstart
                     ftemp.OSLUT = regslut
                     ftemp.FSTART = TIDREGITAB.START
                     ftemp.FSLUT = TIDREGITAB.SLUT
                     fdatum = TIDREGITAB.DATUM.
                  END.
                  ELSE DO:
                     FIND FIRST ftemp WHERE FTEMP.DATUM = TIDREGITAB.DATUM NO-ERROR.                  
                     ASSIGN
                     ftemp.FSLUT = TIDREGITAB.SLUT.
                  END.
                  GET NEXT tidq NO-LOCK.
               END.
            END.
            IF Guru.Konstanter:globforetag = "XGKAL" THEN DO:
               fltid = 0.
               fdatum = ?.
               GET FIRST tidq NO-LOCK.
               DO WHILE AVAILABLE (TIDREGITAB):               
                  IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.
                  IF TIDREGITAB.OVERTIDUTTAG NE "F" THEN musz = musz.
                  ELSE IF TIDREGITAB.DATUM NE fdatum THEN DO:                  
                     regdatum = TIDREGITAB.DATUM.
                     regvnr = TIDREGITAB.VECKONUMMER.
                     RUN SLUTARB.P.            
                     CREATE ftemp.
                     ASSIGN
                     ftemp.DATUM = TIDREGITAB.DATUM
                     ftemp.OSTART = regstart
                     ftemp.OSLUT = regslut
                     ftemp.FSTART = TIDREGITAB.START
                     ftemp.FSLUT = TIDREGITAB.SLUT
                     fdatum = TIDREGITAB.DATUM.
                  END.
                  ELSE DO:
                     ASSIGN
                     ftemp.FSLUT = TIDREGITAB.SLUT.
                  END.
                  GET NEXT tidq NO-LOCK.
               END.
               FOR EACH ftemp:
                  IF ftemp.FSTART NE ftemp.OSTART THEN DO:  
                     nytid = ftemp.FSTART.
                     RUN TIMSEK.P.
                     seku = sekunder.
                     nytid = ftemp.OSTART.
                     RUN TIMSEK.P.
                     sekunder = sekunder - seku.
                     RUN FSEKTIM.P.
                     ASSIGN ftemp.MFLEX = fnytid.
                  END.
                  IF ftemp.FSLUT NE ftemp.OSLUT THEN DO:  
                     nytid = ftemp.FSLUT.
                     RUN TIMSEK.P.
                     seku = sekunder.
                     nytid = ftemp.OSLUT.
                     RUN TIMSEK.P.
                     sekunder = seku - sekunder.
                     RUN FSEKTIM.P.
                     ASSIGN ftemp.KFLEX = fnytid.
                  END.
               END.
               FOR EACH ftemp:
                  IF ftemp.MFLEX NE 0 THEN DO:                               
                     CREATE tidut.
                     ASSIGN
                     SUBSTRING(tidut.UT,1) = ftemp.DAG 
                     SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(ftemp.DATUM,"999999"),5,2).
                     IF ftemp.MFLEX > 0 THEN DO:
                        ASSIGN
                        SUBSTRING(tidut.UT,9) = STRING(ftemp.FSTART,"99.99")
                        SUBSTRING(tidut.UT,17) = STRING(ftemp.OSTART,"99.99").                 
                     END.
                     IF ftemp.MFLEX < 0 THEN DO:
                        ASSIGN
                        SUBSTRING(tidut.UT,9) = STRING(ftemp.OSTART,"99.99")                 
                        SUBSTRING(tidut.UT,17) = STRING(ftemp.FSTART,"99.99").
                        
                     END.
                     ASSIGN
                     SUBSTRING(tidut.UT,24) = STRING(ftemp.MFLEX,"-99.99").                                                                                          
                     nytid = ftemp.MFLEX.
                     RUN TIMSEK.P.
                     fltid = fltid + sekunder.
                  END.
                  IF ftemp.KFLEX NE 0 THEN DO:                               
                     CREATE tidut.
                     ASSIGN
                     SUBSTRING(tidut.UT,1) = ftemp.DAG 
                     SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(ftemp.DATUM,"999999"),5,2).
                     IF ftemp.KFLEX > 0 THEN DO:
                        ASSIGN
                        SUBSTRING(tidut.UT,9) = STRING(ftemp.OSLUT,"99.99")
                        SUBSTRING(tidut.UT,17) = STRING(ftemp.FSLUT,"99.99").                 
                     END.
                     IF ftemp.KFLEX < 0 THEN DO:
                        ASSIGN
                        SUBSTRING(tidut.UT,9) = STRING(ftemp.FSLUT,"99.99")                 
                        SUBSTRING(tidut.UT,17) = STRING(ftemp.OSLUT,"99.99").                        
                     END.
                     ASSIGN
                     SUBSTRING(tidut.UT,24) = STRING(ftemp.KFLEX,"-99.99").                                                                                          
                     nytid = ftemp.KFLEX.
                     RUN TIMSEK.P.
                     fltid = fltid + sekunder.
                  END.                                      
               END.
            END.
            /*  NY FLEXRAPPORT FÖR LULE*/            
            ELSE IF Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "CLULE"  OR Guru.Konstanter:globforetag = "celpa" THEN DO:               
               CREATE tidut.                    
               ASSIGN
               SUBSTRING(tidut.UT,1) = "DAG"
               SUBSTRING(tidut.UT,5) = "DAT"     
               SUBSTRING(tidut.UT,9) = "TI MI"
               SUBSTRING(tidut.UT,17) = "TI MI"
               SUBSTRING(tidut.UT,47) = "TI MI".            
               CREATE tidut.
               SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).
               ASSIGN
               fltid = 0
               kolldatum = ?
               lufl = 0.
               GET FIRST tidq NO-LOCK.
               DO WHILE AVAILABLE (TIDREGITAB):               
                  IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.                  
                  ELSE DO:                  
                     IF TIDREGITAB.AONR = "155" THEN DO:                          
                        regdatum = TIDREGITAB.DATUM.
                        regvnr = TIDREGITAB.VECKONUMMER.
                        RUN SLUTARB.P.                                          
                        IF TIDREGITAB.START GE regslut THEN musz = musz.
                        ELSE DO:                     
                           CREATE tidut.
                           ASSIGN
                           SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                           SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                           SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")             
                           SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")                 
                           SUBSTRING(tidut.UT,46) = STRING(0 - TIDREGITAB.TOTALT,"->9.99").                                                                      
                           IF TIDREGITAB.AONR NE "" THEN DO:
                              ASSIGN   
                              SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                              SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                           END.                    
                           FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                           tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR. 
                           IF AVAILABLE tidsedel THEN                
                           ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid - sekunder.
                        END.   
                     END. 
                     ELSE IF TIDREGITAB.OVERTIDUTTAG = "F" AND TIDREGITAB.LONTILLAGG = ""
                     THEN DO:
                        regdatum = TIDREGITAB.DATUM.
                        regvnr = TIDREGITAB.VECKONUMMER.
                        RUN SLUTARB.P.                                       
                        FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = TIDREGITAB.DATUM AND 
                        OVERAVTAB.KOD = varansf USE-INDEX ODATUM  NO-LOCK NO-ERROR.                  
                        IF WEEKDAY(TIDREGITAB.DATUM) = 1 OR WEEKDAY(TIDREGITAB.DATUM) = 7
                        THEN DO:
                           CREATE tidut.
                           ASSIGN
                           SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                           SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)              
                           SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")  
                           SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")
                           SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,">9.99").                                                                                                                      
                           IF TIDREGITAB.AONR NE "" THEN DO:
                              ASSIGN   
                              SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                              SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                           END.   
                           FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                           tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                           IF AVAILABLE tidsedel THEN
                           ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid + sekunder.                            
                        END.      
                        ELSE IF AVAILABLE OVERAVTAB AND ( OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7) THEN DO:
                           CREATE tidut.
                           ASSIGN
                           SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                           SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                           SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")  
                           SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")
                           SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,">9.99").                                                                      
                           IF TIDREGITAB.AONR NE "" THEN DO:
                              ASSIGN   
                              SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                              SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                           END.   
                           FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                           tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                           IF AVAILABLE tidsedel THEN
                           ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid + sekunder.                     
                           
                        END.     
                        ELSE DO: 
                           IF TIDREGITAB.START < regstart THEN DO:                                    
                              CREATE tidut.
                              ASSIGN
                              SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                              SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                              SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99").                             
                              IF TIDREGITAB.SLUT > regstart THEN DO:
                                 ASSIGN SUBSTRING(tidut.UT,17) = STRING(regstart,"99.99").
                                 nytid = TIDREGITAB.START.
                                 RUN TIMSEK.P.
                                 seku = sekunder.
                                 nytid = regstart.
                                 RUN TIMSEK.P.
                                 sekunder = sekunder - seku.
                                 RUN SEKTIM.P.
                                 SUBSTRING(tidut.UT,25) = STRING(nytid,">9.99").
                                 plflex = nytid.
                              END.
                              ELSE DO:
                                  ASSIGN SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99").
                                  SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,">9.99").
                                  plflex = TIDREGITAB.TOTALT.
                              END.
                              IF TIDREGITAB.AONR NE "" THEN DO:
                                 ASSIGN   
                                 SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                                 SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                              END.   
                              FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                              tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                              IF AVAILABLE tidsedel THEN
                              ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                              nytid = plflex.
                              RUN TIMSEK.P.
                              fltid = fltid + sekunder.                              
                           END.
                           IF TIDREGITAB.SLUT > regslut THEN DO:
                              CREATE tidut.
                              ASSIGN
                              SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                              SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2).                        
                              ASSIGN
                              SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99").
                              IF TIDREGITAB.START < regslut THEN DO:
                                 ASSIGN SUBSTRING(tidut.UT,9) = STRING(regslut,">9.99").
                                 nytid = TIDREGITAB.SLUT.
                                 RUN TIMSEK.P.
                                 seku = sekunder.
                                 nytid = regslut.
                                 RUN TIMSEK.P.
                                 sekunder = seku - sekunder.
                                 RUN SEKTIM.P.
                                 SUBSTRING(tidut.UT,47) = STRING(nytid,">9.99").
                                 plflex = nytid.
                              END.
                              ELSE DO:
                                  ASSIGN SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99").
                                  SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,">9.99").
                                  plflex = TIDREGITAB.TOTALT.
                              END.                        
                              flextot = plflex.                                                  
                              IF TIDREGITAB.AONR NE "" THEN DO:
                                 ASSIGN   
                                 SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                                 SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                              END.   
                              FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                              tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                              IF AVAILABLE tidsedel THEN 
                              ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).
                              nytid = flextot.
                              RUN TIMSEK.P.
                              fltid = fltid + sekunder.                              
                           END.
                        END.
                     END.                                    
                     IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "celpa" THEN DO:                           
                        musz = FALSE.                        
                        IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                            ASSIGN
                            lufl = 0
                            musz = TRUE.
                        END.
                        ELSE IF kolldatum = TIDREGITAB.DATUM AND lufl = 0 THEN musz = TRUE.                        
                        IF musz = TRUE THEN DO:
                           musz = FALSE.
                           regdatum = TIDREGITAB.DATUM.
                           regvnr = TIDREGITAB.VECKONUMMER.
                           RUN SLFLARB.P.
                           IF TIDREGITAB.START < regslut AND TIDREGITAB.SLUT > regstart THEN DO:                           
                               nytid = lunchslutet.
                               RUN TIMSEK.P.
                               seku = sekunder.
                               nytid = lunchstarten.
                               RUN TIMSEK.P.                                                     
                               lunorm = (seku - sekunder) / 60.
                               IF TIDREGITAB.LAGANTAL > 0 AND TIDREGITAB.LAGANTAL < lunorm THEN DO:                              
                                  sekunder = (lunorm - TIDREGITAB.LAGANTAL) * 60.
                                  RUN SEKTIM.P.
                                  CREATE tidut.
                                  ASSIGN
                                  SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                                  SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)                              
                                  SUBSTRING(tidut.UT,47) = STRING(nytid,"->9.99")
                                  SUBSTRING(tidut.UT,66) = "Lunch".                                                                      
                                  fltid = fltid + sekunder.
                                  lufl = 1.                                  
                               END.
                               IF TIDREGITAB.LAGANTAL > lunorm THEN DO:                              
                                  sekunder = (TIDREGITAB.LAGANTAL - lunorm ) * 60.
                                  RUN SEKTIM.P.
                                  CREATE tidut.
                                  ASSIGN
                                  SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                                  SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)                              
                                  SUBSTRING(tidut.UT,47) = STRING(0 - nytid,"->9.99")
                                  SUBSTRING(tidut.UT,66) = "Lunch".                                                                      
                                  fltid = fltid - sekunder.
                                  lufl = 1.                                  
                               END.                                           
                           END.
                        END.                        
                        kolldatum = TIDREGITAB.DATUM.
                     END.                
                  END.
                  GET NEXT tidq.
               END.                 
            END.
            ELSE IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "elpa" THEN DO:               
               CREATE tidut.                    
               ASSIGN
               SUBSTRING(tidut.UT,1) = "Dag"
               SUBSTRING(tidut.UT,5) = "Dat"     
               SUBSTRING(tidut.UT,9) = "Lunch"
               SUBSTRING(tidut.UT,17) = "Morgon-kväll"
               SUBSTRING(tidut.UT,47) = "Totalt".            
               CREATE tidut.               
               SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).
               ASSIGN
               fltid = 0
               kolldatum = ?
               lufl = 0.
               GET FIRST tidq NO-LOCK.
               DO WHILE AVAILABLE (TIDREGITAB):                  
                  IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.                  
                  ELSE DO:                  
                     IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                                                                                             
                        IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                           FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                           IF AVAILABLE ftemp THEN DO:                              
                              IF ftemp.FSTART > ftemp.OSTART AND ftemp.OSTART NE ftemp.OSLUT THEN DO:
                                 nytid = ftemp.FSTART.
                                 RUN TIMSEK.P.
                                 seku = sekunder.
                                 nytid = ftemp.OSTART.
                                 RUN TIMSEK.P.
                                 sekunder = sekunder - seku.
                                 RUN FSEKTIM.P.                               
                                 fltid = fltid + sekunder.
                                 ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                                 ftemp.TFLEX = ftemp.TFLEX + sekunder.                                 
                              END.
                           END.
                        END.
                     END.
                     IF TIDREGITAB.AONR = "155" THEN DO:                          
                        regdatum = TIDREGITAB.DATUM.
                        regvnr = TIDREGITAB.VECKONUMMER.
                        RUN SLUTARB.P.                                          
                        IF TIDREGITAB.START GE regslut THEN musz = musz.
                        ELSE DO:                                                
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid - sekunder.
                           FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                           IF AVAILABLE ftemp THEN DO:
                              ftemp.MKFLEX = ftemp.MKFLEX - sekunder.
                              ftemp.TFLEX = ftemp.TFLEX - sekunder.                              
                           END.
                        END.   
                     END.                   
                     ELSE IF TIDREGITAB.OVERTIDUTTAG = "F" AND TIDREGITAB.LONTILLAGG = "" THEN DO:
                        regdatum = TIDREGITAB.DATUM.
                        regvnr = TIDREGITAB.VECKONUMMER.
                        RUN SLUTARB.P.                                       
                        FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = TIDREGITAB.DATUM AND 
                        OVERAVTAB.KOD = varansf USE-INDEX ODATUM  NO-LOCK NO-ERROR.                  
                        IF WEEKDAY(TIDREGITAB.DATUM) = 1 OR WEEKDAY(TIDREGITAB.DATUM) = 7
                        THEN DO:                           
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid + sekunder. 
                           FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                           IF AVAILABLE ftemp THEN DO:
                              ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                              ftemp.TFLEX = ftemp.TFLEX + sekunder.                              
                           END.
                        END.      
                        ELSE IF AVAILABLE OVERAVTAB AND ( OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7) THEN DO:                           
                           nytid = TIDREGITAB.TOTALT.
                           RUN TIMSEK.P.
                           fltid = fltid + sekunder.                     
                           FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                           IF AVAILABLE ftemp THEN DO:
                              ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                              ftemp.TFLEX = ftemp.TFLEX + sekunder.                              
                           END.
                        END.     
                        ELSE DO: 
                           IF regstart = regslut THEN DO:
                              nytid = TIDREGITAB.TOTALT.
                              RUN TIMSEK.P.
                              fltid = fltid + sekunder.                     
                              FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                              IF AVAILABLE ftemp THEN DO:
                                 ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                                 ftemp.TFLEX = ftemp.TFLEX + sekunder.                              
                              END.
                           END.
                           ELSE DO:                           
                              IF TIDREGITAB.START < regstart THEN DO:                                                                  
                                 IF TIDREGITAB.SLUT > regstart THEN DO:                                 
                                    nytid = TIDREGITAB.START.
                                    RUN TIMSEK.P.
                                    seku = sekunder.
                                    nytid = regstart.
                                    RUN TIMSEK.P.
                                    sekunder = sekunder - seku.
                                    RUN SEKTIM.P.                                 
                                    plflex = nytid.
                                 END.
                                 ELSE plflex = TIDREGITAB.TOTALT.                                                            
                                 nytid = plflex.
                                 RUN TIMSEK.P.
                                 fltid = fltid + sekunder.
                                 FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                                 IF AVAILABLE ftemp THEN DO:
                                    ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                                    ftemp.TFLEX = ftemp.TFLEX + sekunder.                                 
                                 END.
                              END.
                              IF TIDREGITAB.SLUT > regslut THEN DO:                              
                                 IF TIDREGITAB.START < regslut THEN DO:                               
                                    nytid = TIDREGITAB.SLUT.
                                    RUN TIMSEK.P.
                                    seku = sekunder.
                                    nytid = regslut.
                                    RUN TIMSEK.P.
                                    sekunder = seku - sekunder.
                                    RUN SEKTIM.P.                               
                                    plflex = nytid.
                                 END.
                                 ELSE plflex = TIDREGITAB.TOTALT.                              
                                 flextot = plflex.                                                                                
                                 nytid = flextot.
                                 RUN TIMSEK.P.
                                 fltid = fltid + sekunder.
                                 FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                                 IF AVAILABLE ftemp THEN DO:
                                    ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                                    ftemp.TFLEX = ftemp.TFLEX + sekunder.                                 
                                 END.
                              END.
                           END.
                        END.
                     END.                                    
                     IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                           
                        musz = FALSE.                        
                        IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                            ASSIGN
                            lufl = 0
                            musz = TRUE.
                        END.
                        ELSE IF kolldatum = TIDREGITAB.DATUM AND lufl = 0 THEN musz = TRUE.                        
                        IF musz = TRUE THEN DO:
                           musz = FALSE.
                           regdatum = TIDREGITAB.DATUM.
                           regvnr = TIDREGITAB.VECKONUMMER.
                           RUN SLFLARB.P.
                           IF TIDREGITAB.START < regslut AND TIDREGITAB.SLUT > regstart THEN DO:                           
                               nytid = lunchslutet.
                               RUN TIMSEK.P.
                               seku = sekunder.
                               nytid = lunchstarten.
                               RUN TIMSEK.P.                                                     
                               lunorm = (seku - sekunder) / 60.
                               IF TIDREGITAB.LAGANTAL > 0 AND TIDREGITAB.LAGANTAL < lunorm THEN DO:                              
                                  sekunder = (lunorm - TIDREGITAB.LAGANTAL) * 60.
                                  RUN SEKTIM.P.                                                                                           
                                  fltid = fltid + sekunder.
                                  lufl = 1.
                                  FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                                  IF AVAILABLE ftemp THEN DO:
                                     ftemp.LFLEX = nytid.
                                     ftemp.TFLEX = ftemp.TFLEX + sekunder.                                     
                                  END.
                               END.
                               IF TIDREGITAB.LAGANTAL > lunorm THEN DO:                              
                                  sekunder = (TIDREGITAB.LAGANTAL - lunorm ) * 60.
                                  RUN SEKTIM.P.                                                                                      
                                  fltid = fltid - sekunder.
                                  lufl = 1.
                                  FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                                  IF AVAILABLE ftemp THEN DO:
                                     ftemp.LFLEX = 0 - nytid.
                                     ftemp.TFLEX = ftemp.TFLEX - sekunder.                                     
                                  END.
                               END.                                           
                           END.
                        END.
                        IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "elpa" THEN DO:                                                                     
                           IF kolldatum NE TIDREGITAB.DATUM THEN DO:
                              FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                              IF AVAILABLE ftemp THEN DO:                                 
                                 IF ftemp.FSLUT < ftemp.OSLUT THEN DO:
                                    nytid = ftemp.FSLUT.
                                    RUN TIMSEK.P.
                                    seku = sekunder.
                                    nytid = ftemp.OSLUT.
                                    RUN TIMSEK.P.
                                    sekunder = seku - sekunder.
                                    RUN FSEKTIM.P.                                    
                                    fltid = fltid + sekunder.
                                    FIND FIRST ftemp WHERE ftemp.DATUM = TIDREGITAB.DATUM NO-LOCK NO-ERROR.
                                    IF AVAILABLE ftemp THEN DO:
                                       ftemp.MKFLEX = ftemp.MKFLEX + sekunder.
                                       ftemp.TFLEX = ftemp.TFLEX + sekunder.                                       
                                    END.
                                 END.
                              END.
                           END.
                        END.
                        kolldatum = TIDREGITAB.DATUM.                        
                     END.                
                  END.
                  GET NEXT tidq.
               END.  
               FOR EACH ftemp: 
                  sekunder = ftemp.MKFLEX.
                  RUN FSEKTIM.P.
                  ASSIGN ftemp.MKTFLEX = fnytid.                  
                  sekunder = ftemp.TFLEX.
                  RUN FSEKTIM.P.
                  ASSIGN ftemp.TOTFLEX = fnytid.
               END.            
               FOR EACH ftemp: 
                  IF ftemp.TOTFLEX = 0 THEN nytid = nytid.
                  ELSE DO:                  
                     CREATE tidut.
                     ASSIGN
                     SUBSTRING(tidut.UT,1) = ftemp.DAG
                     SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(ftemp.DATUM,"999999"),5,2).
                     IF ftemp.LFLEX NE 0 THEN DO:                                                
                        SUBSTRING(tidut.UT,9) = STRING(ftemp.LFLEX,"-99.99").                        
                     END.
                     IF ftemp.MKTFLEX NE 0 THEN DO:                                             
                        SUBSTRING(tidut.UT,20) = STRING(ftemp.MKTFLEX,"-99.99").                                                                 
                     END.
                     IF ftemp.TOTFLEX NE 0 THEN DO:                                             
                        SUBSTRING(tidut.UT,47) = STRING(ftemp.TOTFLEX,"-99.99").                                                                 
                     END.
                  END.
               END.
            END.
            ELSE DO:
               fltid = 0.
               GET FIRST tidq NO-LOCK.
               DO WHILE AVAILABLE (TIDREGITAB):               
                  IF TIDREGITAB.TIDLOG = FALSE THEN musz = musz.
                  ELSE IF TIDREGITAB.AONR = "910927" OR TIDREGITAB.AONR = "27" OR 
                  TIDREGITAB.AONR BEGINS "1097" THEN DO:                          
                     regdatum = TIDREGITAB.DATUM.
                     regvnr = TIDREGITAB.VECKONUMMER.
                     RUN SLUTARB.P.                     
                     IF TIDREGITAB.START GE regslut THEN musz = musz.
                     ELSE DO:                     
                        CREATE tidut.
                        ASSIGN
                        SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                        SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                        SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")             
                        SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")                 
                        SUBSTRING(tidut.UT,46) = STRING(0 - TIDREGITAB.TOTALT,"-99.99").                                                                      
                        IF TIDREGITAB.AONR NE "" THEN DO:
                           ASSIGN   
                           SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                           SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                        END.                    
                        FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                        tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR. 
                        IF AVAILABLE tidsedel THEN                
                        ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).
                        nytid = TIDREGITAB.TOTALT.
                        RUN TIMSEK.P.
                        fltid = fltid - sekunder.
                     END.   
                  END.                   
                  ELSE IF TIDREGITAB.OVERTIDUTTAG = "F" AND TIDREGITAB.LONTILLAGG = ""
                  THEN DO:
                     regdatum = TIDREGITAB.DATUM.
                     regvnr = TIDREGITAB.VECKONUMMER.
                     RUN SLUTARB.P.                                       
                     FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = TIDREGITAB.DATUM AND 
                     OVERAVTAB.KOD = varansf USE-INDEX ODATUM  NO-LOCK NO-ERROR.                  
                     IF WEEKDAY(TIDREGITAB.DATUM) = 1 OR WEEKDAY(TIDREGITAB.DATUM) = 7
                     THEN DO:
                        CREATE tidut.
                        ASSIGN
                        SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                        SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                        SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")  
                        SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")
                        SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,"99.99").                                                                      
                        IF TIDREGITAB.AONR NE "" THEN DO:
                           ASSIGN   
                           SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                           SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                        END.   
                        FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                        tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                        IF AVAILABLE tidsedel THEN
                        ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                        nytid = TIDREGITAB.TOTALT.
                        RUN TIMSEK.P.
                        fltid = fltid + sekunder.                     
                     END.      
                     ELSE IF AVAILABLE OVERAVTAB AND ( OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7) THEN DO:
                        CREATE tidut.
                        ASSIGN
                        SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                        SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                        SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")  
                        SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")
                        SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,"99.99").                                                                      
                        IF TIDREGITAB.AONR NE "" THEN DO:
                           ASSIGN   
                           SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                           SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                        END.   
                        FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                        tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                        IF AVAILABLE tidsedel THEN
                        ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                        nytid = TIDREGITAB.TOTALT.
                        RUN TIMSEK.P.
                        fltid = fltid + sekunder.                     
                     END.     
                     ELSE IF TIDREGITAB.START < regstart THEN DO:                 
                        CREATE tidut.
                        ASSIGN
                        SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                        SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                        SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99")  
                        SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99")
                        SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,"99.99").                                                                      
                        IF TIDREGITAB.AONR NE "" THEN DO:
                           ASSIGN   
                           SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                           SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                        END.   
                        FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                        tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                        IF AVAILABLE tidsedel THEN
                        ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).                                     
                        nytid = TIDREGITAB.TOTALT.
                        RUN TIMSEK.P.
                        fltid = fltid + sekunder.
                     END.
                     ELSE IF TIDREGITAB.START GE regslut THEN DO:
                        CREATE tidut.
                        ASSIGN
                        SUBSTRING(tidut.UT,1) = TIDREGITAB.DAG 
                        SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDREGITAB.DATUM,"999999"),5,2)
                        SUBSTRING(tidut.UT,9) = STRING(TIDREGITAB.START,"99.99").                 
                        ASSIGN
                        SUBSTRING(tidut.UT,17) = STRING(TIDREGITAB.SLUT,"99.99").
                        flextot = TIDREGITAB.TOTALT.                       
                        ASSIGN
                        SUBSTRING(tidut.UT,47) = STRING(TIDREGITAB.TOTALT,"99.99").                                                                      
                        IF TIDREGITAB.AONR NE "" THEN DO:
                           ASSIGN   
                           SUBSTRING(tidut.UT,55) = TIDREGITAB.AONR
                           SUBSTRING(tidut.UT,62) = STRING(TIDREGITAB.DELNR,Guru.Konstanter:varforetypchar[1]). 
                        END.   
                        FIND FIRST tidsedel WHERE tidsedel.AONR = TIDREGITAB.AONR AND 
                        tidsedel.DELNR = TIDREGITAB.DELNR NO-LOCK NO-ERROR.                 
                        IF AVAILABLE tidsedel THEN 
                        ASSIGN SUBSTRING(tidut.UT,66) = SUBSTRING(tidsedel.ORT,1,20).
                        nytid = flextot.
                        RUN TIMSEK.P.
                        fltid = fltid + sekunder.
                     END.
                  END.
                  GET NEXT tidq.
               END.  
            END.
            sekunder = fltid.
            RUN FSEKTIM.P.             
            
            IF Guru.Konstanter:globforetag = "lule" OR Guru.Konstanter:globforetag = "SKOK" OR Guru.Konstanter:globforetag = "elpa"  THEN DO:
               CREATE tidut.
               SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).
               CREATE tidut.
               SUBSTRING(tidut.UT,1) = "Månadens saldo:".
               FIND FIRST FSALDMAN WHERE FSALDMAN.PERSONALKOD = PERSONALTAB.PERSONALKOD AND FSALDMAN.DATUM = avdatum NO-LOCK NO-ERROR.
               IF AVAILABLE FSALDMAN  THEN DO:
                  SUBSTRING(tidut.UT,46) = STRING(FSALDMAN.PERIODFLEX,"->>9.99").
               END.
               ELSE SUBSTRING(tidut.UT,46) = STRING(fnytid,"->>9.99").
            END.    
            ELSE DO:
               CREATE tidut.
               SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).
               CREATE tidut.
               SUBSTRING(tidut.UT,1) = "Månadens saldo:".
                SUBSTRING(tidut.UT,46) = STRING(fnytid,"->>9.99").
             END.   
            ingsal = 0.            
            FIND FIRST FLEXSALDO WHERE FLEXSALDO.PERSONALKOD = PERSONALTAB.PERSONALKOD
            NO-LOCK NO-ERROR.
            IF NOT AVAILABLE FLEXSALDO THEN DO TRANSACTION:
               CREATE FLEXSALDO.
               ASSIGN FLEXSALDO.PERSONALKOD = PERSONALTAB.PERSONALKOD.
            END.   
            ELSE DO:
               nytid = FLEXSALDO.ACCFLEX.
               RUN TIMSEK.P.
               seku = sekunder.
               nytid = FLEXSALDO.PERIODFLEX.
               RUN TIMSEK.P.
               sekunder = sekunder + seku.
               RUN FSEKTIM.P.
               ingsal = fnytid.               
            END.   
            CREATE tidut.
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "Totalt flexsaldo körd tid:"
            SUBSTRING(tidut.UT,47) = STRING(ingsal,"-99.99").
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "Flexsaldo EJ körd tid: (uppdaterad igår kväll)"
            SUBSTRING(tidut.UT,47) = STRING(FLEXSALDO.EJKORDFLEX,"-99.99").                  

            nytid = ingsal.
            RUN TIMSEK.P.
            seku = sekunder.
            nytid = FLEXSALDO.EJKORDFLEX.
            RUN TIMSEK.P.
            sekunder = seku + sekunder.
            RUN FSEKTIM.P.
            CREATE tidut.
            ASSIGN            
            SUBSTRING(tidut.UT,47) = "------".         
            CREATE tidut.
            ASSIGN
            SUBSTRING(tidut.UT,1) = "Totalt flexsaldo:"
            SUBSTRING(tidut.UT,47) = STRING(fnytid,"-99.99").         

            CREATE tidut.
            SUBSTRING(tidut.UT,1) = SUBSTRING(str,1,86).         
         END.
      END.
   END.   
   
   /*Förtroendetid*/
   FIND PERSONALTAB WHERE RECID(PERSONALTAB) = persrec NO-LOCK NO-ERROR.
   /*förtroendetid   kalmar skriver fritt tid*/      
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
   ftro = FALSE.
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "FORTRO"                   
   inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.            
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
   IF AVAILABLE extradatatemp THEN DO:      
     ftro = extradatatemp.SOKLOG[1].         
   END.   
   ELSE ftro = FALSE.
   
   /*Tillit*/
   FIND PERSONALTAB WHERE RECID(PERSONALTAB) = persrec NO-LOCK NO-ERROR.
   /*tillit   kalmar skriver fritt tid kan även registrera övertid*/      
   EMPTY TEMP-TABLE inextradatatemp NO-ERROR. 
   EMPTY TEMP-TABLE extradatatemp NO-ERROR. 
   ftro = FALSE.
   CREATE inextradatatemp.          
   ASSIGN
   inextradatatemp.PROGRAM = "TILLIT"                   
   inextradatatemp.HUVUDCH = PERSONALTAB.PERSONALKOD.            
   RUN etabhamt_UI IN edataapph (INPUT TABLE inextradatatemp, OUTPUT TABLE extradatatemp). 
   FIND FIRST extradatatemp NO-LOCK NO-ERROR.     
   IF AVAILABLE extradatatemp THEN DO:      
     tillit = extradatatemp.SOKLOG[1].         
   END.   
   ELSE tillit = FALSE.                        
   
   IF ftro = TRUE OR tillit = TRUE THEN DO:
      CREATE tidut.
      CREATE tidut.  
      CREATE tidut.
      IF ftro = TRUE THEN ASSIGN SUBSTRING(tidut.UT,1) = "Förtroendetid tom".
      IF tillit = TRUE THEN ASSIGN SUBSTRING(tidut.UT,1) = "Tillitstid tom".
      IF MONTH(slutdatum) > MONTH(TODAY) THEN DO:
          SUBSTRING(tidut.UT,22) = STRING(slutdatum,"9999/99/99").
      END.    
      ELSE IF slutdatum > TODAY AND MONTH(slutdatum) = MONTH(TODAY) THEN SUBSTRING(tidut.UT,22) = STRING(TODAY,"9999/99/99").
      ELSE SUBSTRING(tidut.UT,22) = STRING(slutdatum,"9999/99/99").
      CREATE tidut.
      ASSIGN 
      SUBSTRING(tidut.UT,1) = "=================================".
      CREATE tidut.
      CREATE tidut.
      ASSIGN      
      SUBSTRING(tidut.UT,1) = "Ordinarie"
      SUBSTRING(tidut.UT,11) = "Registrerad"
      SUBSTRING(tidut.UT,23) = "Plus"
      SUBSTRING(tidut.UT,33) = "Varav".
      CREATE tidut.
      ASSIGN
      
      SUBSTRING(tidut.UT,1) = "arbetstid"
      SUBSTRING(tidut.UT,11) = "tid"
      SUBSTRING(tidut.UT,23) = "tid"
      SUBSTRING(tidut.UT,33) = "Frånvaro"
      SUBSTRING(tidut.UT,44) = "Övertid".
      
      CREATE tidut.
      ASSIGN 
      SUBSTRING(tidut.UT,1) = "=========.===========.=========.=========.=========.".
      assign
      rtidman = 0
      ftidman = 0      
      otidman = 0.
      regdatum = startdatum.
     
      REPEAT:     
         IF regdatum > slutdatum THEN LEAVE.         
         /*ändrat till vissldat om de har skrivit tid i förväg  Lena 20190130*/
         IF MONTH(regdatum) =  MONTH(TODAY) AND  regdatum > vissldat THEN LEAVE.
                                        
         OPEN QUERY toq FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
         AND TIDREGITAB.DATUM = regdatum  AND TIDREGITAB.START NE TIDREGITAB.SLUT  NO-LOCK.          
         GET FIRST toq NO-LOCK.
         DO WHILE AVAILABLE (TIDREGITAB):
            IF TIDREGITAB.PRISTYP = "RESTID..." THEN.
            ELSE DO:                            
               IF TIDREGITAB.OANT1 = 0 AND TIDREGITAB.OANT2 = 0 AND TIDREGITAB.OANT3 = 0  THEN DO:
                  rtidman =  rtidman +  klock100(TIDREGITAB.TOTALT).                  
                  IF  TIDREGITAB.PRISTYP = "FRÅNVARO." THEN ftidman  =  ftidman + klock100(TIDREGITAB.TOTALT).                                     
               END.
               ELSE  DO:
                  /*övertid*/
                  otidman = otidman + klock100(TIDREGITAB.OANT1) + + klock100(TIDREGITAB.OANT2) + + klock100(TIDREGITAB.OANT3).                                                                                                                                       
               END.      
            END.
            GET NEXT toq NO-LOCK.
         END.
         regdatum = regdatum + 1.
      END.
      
      CREATE tidut.
      ASSIGN
      /* rtidman registrerad tid förutom övertid*/      
      SUBSTRING(tidut.UT,1) = STRING(klock60(ordarbman),">99.99")
      SUBSTRING(tidut.UT,11) = STRING(klock60(rtidman),">>99.99")
      SUBSTRING(tidut.UT,21) = STRING(klock60((rtidman - ordarbman)),"->>99.99")
      SUBSTRING(tidut.UT,31) = STRING(klock60(ftidman),">>99.99")
      SUBSTRING(tidut.UT,41) = STRING(klock60(otidman),">>99.99").      
      CREATE tidut.
   END.         
   DO:
      /*Alla vill ha kommentarsbilaga*/
      FIND FIRST resmaltidsedel WHERE resmaltidsedel.RESMAL NE "" NO-ERROR.
      IF AVAILABLE resmaltidsedel THEN DO:       
         
         CREATE tidut.   
         ASSIGN tidut.UT = "".
         CREATE tidut.   
         SUBSTRING(tidut.UT,1) = "Bilaga med kommentarer / resmål".
         CREATE tidut.   
         SUBSTRING(tidut.UT,1) = "================================".
         CREATE tidut.   
         ASSIGN 
         SUBSTRING(tidut.UT,1) = "Dag" 
         SUBSTRING(tidut.UT,5) = "Dat"
         SUBSTRING(tidut.UT,9) = "Start"  
         SUBSTRING(tidut.UT,14) = "Slut"
         SUBSTRING(tidut.UT,20) = "Tid"                                                                                 
         SUBSTRING(tidut.UT,26) = CAPS(Guru.Konstanter:gaok)
         SUBSTRING(tidut.UT,33) = "Dnr"
         SUBSTRING(tidut.UT,37) = "Kommentar"         
         SUBSTRING(tidut.UT,117) =  "Lönetillägg".         
         berraknare = 0.
         CREATE tidut. 
         ASSIGN tidut.UT = str.
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "ELPA"  THEN DO:
            FOR EACH resmaltidsedel WHERE SUBSTRING(resmaltidsedel.RESMAL,159,6) NE "" :
               FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = SUBSTRING(resmaltidsedel.RESMAL,159,6) NO-LOCK NO-ERROR.
               IF AVAILABLE PERSONALTAB THEN
               resmaltidsedel.RESMAL = "Beordrat av: " + CAPS(SUBSTRING(PERSONALTAB.FORNAMN,1,1)) + " " + CAPS(PERSONALTAB.EFTERNAMN) + "  " + SUBSTRING(resmaltidsedel.RESMAL,1,158).
               ELSE ASSIGN resmaltidsedel.RESMAL = "Beordrat av: " + SUBSTRING(resmaltidsedel.RESMAL,159,6) + "  " + SUBSTRING(resmaltidsedel.RESMAL,1,158).
               ASSIGN SUBSTRING(resmaltidsedel.RESMAL,159,6) = "".               
            END.
            FIND PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod NO-LOCK NO-ERROR.
         END.
         FOR EACH resmaltidsedel WHERE resmaltidsedel.RESMAL NE "" BY resmaltidsedel.LONTILLAGG:
            IF resmaltidsedel.LONTILLAGG NE "" THEN DO:            
               FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = resmaltidsedel.LONTILLAGG AND
               LONTILL.KOD = varansf
               USE-INDEX LONTIL NO-LOCK NO-ERROR.
               IF NOT AVAILABLE LONTILL THEN DO:
                  /*Om personen bytt avtal ska inte programmet spåra ur*/
                  FIND FIRST LONTILL WHERE LONTILL.LONTILLAGG = resmaltidsedel.LONTILLAGG USE-INDEX LONTIL NO-LOCK NO-ERROR.
               END.
               IF AVAILABLE LONTILL THEN DO:
                  ASSIGN resmaltidsedel.LONTILLAGG = LONTILL.VILART.   
                  IF resmaltidsedel.ENFLERDAGS NE "" THEN DO:                                                                         
                     SUBSTRING(resmaltidsedel.RESMAL,49,30) =  SUBSTRING(LONTILL.LONKODTEXT,1,30).
                  END.
               END.
            END.
            IF resmaltidsedel.TRAKTKOD NE "" THEN DO:                           
               FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = resmaltidsedel.TRAKTKOD AND
               TRAKTATAB.TRAAVTAL = vartraktav  USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
               IF NOT AVAILABLE TRAKTATAB THEN DO:
                  /*Om personen bytt avtal ska det inte spåra ur*/
                  FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = resmaltidsedel.TRAKTKOD USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
               END.
               IF AVAILABLE TRAKTATAB THEN DO:                  
                  ASSIGN resmaltidsedel.TRAKTKOD = TRAKTATAB.VILART.  
                  IF resmaltidsedel.ENFLERDAGS NE "" THEN                   
                  SUBSTRING(resmaltidsedel.RESMAL,49,30) =  SUBSTRING(TRAKTATAB.FORKL,1,30).
               END.
            END.            
         END.        
         jamdag = "".
         FOR EACH resmaltidsedel WHERE resmaltidsedel.RESMAL NE "" USE-INDEX PSTART:
            IF resmaltidsedel.RESMAL BEGINS "Resans s" THEN musz = musz.
            ELSE IF resmaltidsedel.TOTALT = 0 AND resmaltidsedel.TRAKTANTAL = 0 AND 
            resmaltidsedel.OVERANTAL = 0 AND resmaltidsedel.LONTILLANTAL = 0 AND resmaltidsedel.BERANTAL = 0 
            THEN NEXT.
            berraknare = berraknare + 1.
            IF Guru.Konstanter:globforetag = "celpa" THEN DO:
               IF berraknare > 3 THEN DO:
                  berraknare = 1.
                  CREATE tidut. 
                  ASSIGN tidut.UT = str.
               END.
            END.           
            ELSE DO:
               /*alltid streckrad mellan dagar om ej begärt annat*/        
               IF jamdag NE "" AND resmaltidsedel.DAG NE jamdag THEN DO:          
                  CREATE tidut. 
                  ASSIGN tidut.UT = str.                   
               END.                   
               jamdag = resmaltidsedel.DAG.
            END.            
            CREATE tidut. 
            ASSIGN
            SUBSTRING(tidut.UT,1) = resmaltidsedel.DAG 
            SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(resmaltidsedel.DATUM,"999999"),5,2).     
            IF resmaltidsedel.START NE resmaltidsedel.SLUT THEN DO:
               ASSIGN
               SUBSTRING(tidut.UT,8) = STRING(resmaltidsedel.START,"99.99")
               SUBSTRING(tidut.UT,14) = STRING(resmaltidsedel.SLUT,"99.99")
               SUBSTRING(tidut.UT,20) = STRING(resmaltidsedel.TOTALT,"99.99").   
            END. 
            IF resmaltidsedel.PRISTYP = "VÄNTETID." THEN ASSIGN SUBSTRING(tidut.UT,25) = "V".
            IF resmaltidsedel.AONR NE "" THEN DO:
               ASSIGN   
               SUBSTRING(tidut.UT,26) = resmaltidsedel.AONR
               SUBSTRING(tidut.UT,33) = STRING(resmaltidsedel.DELNR,Guru.Konstanter:varforetypchar[1]). 
            END.               
            IF resmaltidsedel.RESMAL NE " " THEN DO:               
               resmaltidsedel.RESMAL = RIGHT-TRIM(resmaltidsedel.RESMAL).               
               IF LENGTH(resmaltidsedel.RESMAL)< 80 THEN DO:                                 
                  ASSIGN SUBSTRING(tidut.UT,37) = SUBSTRING(resmaltidsedel.RESMAL,1,79).
               END.
               ELSE DO:                                 
                  CREATE tidutr.
                  BUFFER-COPY tidut TO tidutr.
                  ASSIGN 
                  SUBSTRING(tidutr.UT,8,17) = "                 "
                  SUBSTRING(tidutr.UT,37,79) = " ".                  
                  IF SUBSTRING(resmaltidsedel.RESMAL,79,1) = " "  THEN  blrak = 79.                
                  ELSE IF SUBSTRING(resmaltidsedel.RESMAL,80,1) = " "  THEN blrak = 79.                   
                  ELSE DO:
                     blrak = 78.
                     REPEAT:
                        IF SUBSTRING(resmaltidsedel.RESMAL,blrak,1) = " " THEN LEAVE.
                        ELSE blrak = blrak - 1 .
                        IF blrak = 0 THEN DO:
                           blrak = 79.                
                           LEAVE.
                        END.
                     END.
                  END.
                  ASSIGN SUBSTRING(tidut.UT,37) = SUBSTRING(resmaltidsedel.RESMAL,1,blrak).                 
                  SUBSTRING(tidutr.UT,37) = SUBSTRING(resmaltidsedel.RESMAL,(blrak + 1),158).
               END.
            END.
            IF resmaltidsedel.LONTILLANTAL > 0 THEN DO:               
               IF resmaltidsedel.ENHET = "KR" THEN DO:
                  ASSIGN SUBSTRING(tidut.UT,117) =  resmaltidsedel.LONTILLAGG
                  SUBSTRING(tidut.UT,127) =  STRING(resmaltidsedel.LONTILLANTAL,">>>>").         
               END.   
               ELSE IF resmaltidsedel.LERSATTNING < 0 THEN DO:
                  ASSIGN SUBSTRING(tidut.UT,117) =  resmaltidsedel.LONTILLAGG
                  SUBSTRING(tidut.UT,122) =  STRING(resmaltidsedel.LONTILLANTAL,"99.99")
                  SUBSTRING(tidut.UT,127) =  STRING(resmaltidsedel.LERSATTNING,"->>>").
               END.             
               ELSE IF resmaltidsedel.LONTILLANTAL < 100 THEN DO:
                  ASSIGN SUBSTRING(tidut.UT,117) =  resmaltidsedel.LONTILLAGG
                  SUBSTRING(tidut.UT,122) =  STRING(resmaltidsedel.LONTILLANTAL,"99.99")
                  SUBSTRING(tidut.UT,127) =  STRING(resmaltidsedel.LERSATTNING,">>>>>").
               END.
               ELSE DO: 
                  ASSIGN SUBSTRING(tidut.UT,117) =  resmaltidsedel.LONTILLAGG
                  SUBSTRING(tidut.UT,122) =  STRING(resmaltidsedel.LONTILLANTAL)
                  SUBSTRING(tidut.UT,127) =  STRING(resmaltidsedel.LERSATTNING,">>>>>").
               END.                
            END.             
            IF resmaltidsedel.TRAKTANTAL > 0 THEN DO:                                            
               ASSIGN SUBSTRING(tidut.UT,117) =  resmaltidsedel.TRAKTKOD
               SUBSTRING(tidut.UT,122) =  STRING(resmaltidsedel.TRAKTANTAL,"99.99")
               SUBSTRING(tidut.UT,127) =  STRING(resmaltidsedel.TERSATTNING,">>>>>").              
            END.            
         END.                                 
         CREATE tidut. 
         ASSIGN tidut.UT = str.
      END.
   END.
   DO:
      FIND FIRST TIDFEL WHERE TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      YEAR(TIDFEL.DATUM) = YEAR(bdatum) AND MONTH(TIDFEL.DATUM) = MONTH(bdatum) USE-INDEX PKOD NO-LOCK NO-ERROR.
      IF AVAILABLE TIDFEL THEN DO:       
          CREATE tidut.   
          ASSIGN tidut.UT = "".
          CREATE tidut.   
          SUBSTRING(tidut.UT,1) = "Gjorda rättningar".
          CREATE tidut.   
          SUBSTRING(tidut.UT,1) = "=================".
          CREATE tidut.   
          ASSIGN 
          SUBSTRING(tidut.UT,1) = "Dag" 
          SUBSTRING(tidut.UT,5) = "Dat"
          SUBSTRING(tidut.UT,9) = "Start"  
          SUBSTRING(tidut.UT,17) = "Slut"
          SUBSTRING(tidut.UT,25) = "Tid"                                                                                 
          SUBSTRING(tidut.UT,32) = CAPS(Guru.Konstanter:gaok)
          SUBSTRING(tidut.UT,39) = "Dnr"
          SUBSTRING(tidut.UT,43) = "Deb"
          SUBSTRING(tidut.UT,47) = "Ändrat"
          SUBSTRING(tidut.UT,54) = "Av användare".
          CREATE tidut.
          ASSIGN 
          SUBSTRING(tidut.UT,1) = "===.==.======.=======.=======.=======.===.===.======.=========================.".
          OPEN QUERY tfq FOR EACH TIDFEL WHERE TIDFEL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
          YEAR(TIDFEL.DATUM) = YEAR(bdatum) AND 
          MONTH(TIDFEL.DATUM) = MONTH(bdatum) USE-INDEX PKOD NO-LOCK.
          GET FIRST tfq NO-LOCK.
          DO WHILE AVAILABLE (TIDFEL):
             CREATE tidut.                           
             ASSIGN 
             SUBSTRING(tidut.UT,1) = TIDFEL.DAG 
             SUBSTRING(tidut.UT,5) = SUBSTRING(STRING(TIDFEL.DATUM,"999999"),5,2)
             SUBSTRING(tidut.UT,9) = STRING(TIDFEL.START,"99.99")  
             SUBSTRING(tidut.UT,17) = STRING(TIDFEL.SLUT,"99.99")
             SUBSTRING(tidut.UT,25) = STRING(TIDFEL.TOTALT,"99.99")                                                                                
             SUBSTRING(tidut.UT,32) = TIDFEL.AONR
             SUBSTRING(tidut.UT,39) = STRING(TIDFEL.DELNR,Guru.Konstanter:varforetypchar[1])
             SUBSTRING(tidut.UT,43) = STRING(TIDFEL.DEBET,"Ja/Nej")
             SUBSTRING(tidut.UT,47) = STRING(TIDFEL.FELDATUM,"999999")
             SUBSTRING(tidut.UT,54) = STRING(TIDFEL.FELANVAND,"X(25)").
   
             GET NEXT tfq NO-LOCK.
          END.
          CREATE tidut.
          ASSIGN 
          SUBSTRING(tidut.UT,1) = "===.==.======.=======.=======.=======.===.===.======.=========================.".
      END.
   END.
   IF Guru.Konstanter:globforetag = "CELPA" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV"  THEN DO:   
      sign = FALSE.
      FIND FIRST FLEXAVT WHERE FLEXAVT.PERSONALKOD = PERSONALTAB.PERSONALKOD 
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
      IF AVAILABLE FLEXAVT THEN DO:
         IF FLEXAVT.FLEXTID = TRUE THEN DO:   
            CREATE tidut.
            RUN SKAPFL.P 
            (INPUT PERSONALTAB.PERSONALKOD, INPUT Guru.Konstanter:globforetag, INPUT 1, INPUT sign, OUTPUT TABLE tidut APPEND) .            
         END.
      END.
   END.
   
   IF Guru.Konstanter:varforetypchar[9] = "1" THEN RUN persliggrapp_UI.
   CREATE tidut.
   CREATE tidut.
   ASSIGN 
   SUBSTRING(tidut.UT,2) = PERSONALTAB.PERSONALKOD
   SUBSTRING(tidut.UT,9) = regmannamn.   
   berraknare = 0. 
        
   
END PROCEDURE.
PROCEDURE CreateCustomQuery:
   DEFINE INPUT PARAMETER tth  AS HANDLE NO-UNDO.
   DEFINE INPUT PARAMETER q AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER CustomQueryh AS HANDLE NO-UNDO.
   CREATE QUERY CustomQueryh IN WIDGET-POOL "DynTableRLAP".
   CustomQueryh:SET-BUFFERS(tth).
   CustomQueryh:QUERY-PREPARE(q).
   CustomQueryh:QUERY-OPEN().
END PROCEDURE.
PROCEDURE persliggrapp_UI :   
   DEFINE VARIABLE hQuery AS HANDLE NO-UNDO.
   DEFINE VARIABLE datvar1 AS DATE NO-UNDO.
   DEFINE VARIABLE tidvar1 AS INTEGER NO-UNDO.
   DEFINE VARIABLE tidvar2 AS INTEGER NO-UNDO.    
   CREATE BUFFER gplhuvudbuffh FOR TABLE "GPLHUVUD" IN WIDGET-POOL "DynTableRLAP".
   CREATE BUFFER gplaktbuffh FOR TABLE "GPLAKTIVITET" IN WIDGET-POOL "DynTableRLAP".
   CREATE BUFFER gplaktbuffextrh FOR TABLE "GPLAKTIVITET" IN WIDGET-POOL "DynTableRLAP".

   qString = "FOR EACH " + gplaktbuffh:TABLE + " WHERE GPLAKTIVITET.PERSONALKOD = '" + PERSONALTAB.PERSONALKOD  + "' AND YEAR(DATE(GPLAKTIVITET.LOGGTID)) = " 
   + STRING(YEAR(bdatum)) + "  AND  MONTH(DATE(GPLAKTIVITET.LOGGTID)) = " + STRING(MONTH(bdatum))  + " BY LOGGTID ".
   
   RUN CreateCustomQuery(INPUT gplaktbuffh,INPUT qString,OUTPUT hQuery).

   hQuery:GET-FIRST(NO-LOCK).
   IF gplaktbuffh:AVAILABLE THEN DO:
      CREATE tidut.
      CREATE tidut.
      SUBSTRING(tidut.UT,1) = "Personalliggare innevarande månad".
      CREATE tidut.
      SUBSTRING(tidut.UT,1) = "==================================".
      CREATE tidut.
      CREATE tidut. 
      ASSIGN 
      SUBSTRING(tidut.UT,1) = "Loggtid"
      SUBSTRING(tidut.UT,25) = Guru.Konstanter:gaok       
      SUBSTRING(tidut.UT,35) = "Benämning"
      SUBSTRING(tidut.UT,65) = "Typ"
      SUBSTRING(tidut.UT,69) = "Starttid"
      SUBSTRING(tidut.UT,89) = "Sluttid"
      SUBSTRING(tidut.UT,109) = "Tid".
      CREATE tidut.
      SUBSTRING(tidut.UT,1) = "=======================.=========.=============================.===.===================.===================.=====.".      
   END.   
   DO WHILE hQuery:QUERY-OFF-END = FALSE:
      gplhuvudbuffh:FIND-FIRST("WHERE PLID = " + gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE  , NO-LOCK) NO-ERROR.
      IF gplhuvudbuffh:AVAILABLE THEN DO:
         FIND FIRST AONRTAB WHERE AONRTAB.AONR = gplhuvudbuffh:BUFFER-FIELD("AONRAONR"):BUFFER-VALUE AND AONRTAB.DELNR = gplhuvudbuffh:BUFFER-FIELD("AONRDELNR"):BUFFER-VALUE NO-LOCK NO-ERROR.
         IF AVAILABLE AONRTAB THEN DO:                            
             CREATE tidut.                           
             ASSIGN 
             SUBSTRING(tidut.UT,1) = STRING(gplaktbuffh:BUFFER-FIELD("LOGGTID"):BUFFER-VALUE , "9999/99/99 hh:mm:ss")
             SUBSTRING(tidut.UT,25) = AONRTAB.AONR
             SUBSTRING(tidut.UT,31) = STRING(AONRTAB.DELNR,Guru.Konstanter:varforetypchar[1])  
             SUBSTRING(tidut.UT,35) = SUBSTRING(AONRTAB.ORT, 1,29).
             IF gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE NE "" THEN SUBSTRING(tidut.UT,65) = gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE .
             IF gplaktbuffh:BUFFER-FIELD("STARTTID"):BUFFER-VALUE NE ? THEN SUBSTRING(tidut.UT,69) = STRING(gplaktbuffh:BUFFER-FIELD("STARTTID"):BUFFER-VALUE , "9999/99/99 hh:mm:ss") .
             IF gplaktbuffh:BUFFER-FIELD("SLUTTID"):BUFFER-VALUE NE ? THEN SUBSTRING(tidut.UT,89) = STRING(gplaktbuffh:BUFFER-FIELD("SLUTTID"):BUFFER-VALUE  , "9999/99/99 hh:mm:ss") .
             IF gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE = "In" THEN DO:                
                gplaktbuffextrh:FIND-FIRST("WHERE PLAID = " + gplaktbuffh:BUFFER-FIELD("PLAID"):BUFFER-VALUE + " AND PLID = " + gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE  , NO-LOCK) NO-ERROR.                               
             END.
             IF gplaktbuffh:BUFFER-FIELD("TYP"):BUFFER-VALUE = "Ut" THEN DO:                
                IF gplaktbuffextrh:AVAILABLE THEN DO:
                   IF DATE(gplaktbuffextrh:BUFFER-FIELD("LOGGTID"):BUFFER-VALUE) = DATE(gplaktbuffh:BUFFER-FIELD("LOGGTID"):BUFFER-VALUE) AND
                   gplaktbuffextrh:BUFFER-FIELD("PLID"):BUFFER-VALUE =  gplaktbuffh:BUFFER-FIELD("PLID"):BUFFER-VALUE THEN DO:                      
                      tidvar1 = INTEGER( truncate( MTIME( gplaktbuffh:BUFFER-FIELD("SLUTTID"):BUFFER-VALUE ) / 1000, 0 ) ).
                      tidvar2 = INTEGER( truncate( MTIME( gplaktbuffextrh:BUFFER-FIELD("STARTTID"):BUFFER-VALUE ) / 1000, 0 ) ).
                      sekunder = tidvar1 - tidvar2.
                      RUN SEKTIM.P.                      
                      SUBSTRING(tidut.UT,109) = STRING(nytid,">9.99").                      
                   END.
                END.                      
             END.                                                                                                                                         
          END.   
          
       END.      
            
      hQuery:GET-NEXT(NO-LOCK).
   END.
   DELETE OBJECT gplaktbuffh.   
END PROCEDURE.
PROCEDURE timmar_UI :
    /*TIMMAR*/    
   FOR EACH tidsedel USE-INDEX PSTART:
      IF tidsedel.START = tidsedel.SLUT THEN NEXT.
      nytid = tidsedel.TOTALT.
      RUN TIMSEK.P.
      ASSIGN tidsedel.TOTALT = sekunder.                            
   END.     
   FOR EACH tidsedel USE-INDEX PSTART:
      IF ( Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:
         IF tidsedel.PRISTYP = "FRÅNVARO." THEN NEXT.
         IF tidsedel.PRISTYP = "RESTID..." AND tidsedel.BILFORARE = FALSE THEN NEXT.
      END.               
      ACCUMULATE tidsedel.TOTALT (TOTAL).
      arrtidsum = (ACCUM TOTAL tidsedel.TOTALT).               
   END.
   FOR EACH tidsedel USE-INDEX PSTART:      
      IF tidsedel.PRISTYP NE "FRÅNVARO." THEN NEXT.                  
      ACCUMULATE tidsedel.TOTALT (TOTAL).
      arrfrsum = (ACCUM TOTAL tidsedel.TOTALT).               
   END.
   FOR EACH tidsedel USE-INDEX PSTART:         
      IF tidsedel.PRISTYP NE  "RESTID..." THEN NEXT.             
      ACCUMULATE tidsedel.TOTALT (TOTAL).
      arrressum = (ACCUM TOTAL tidsedel.TOTALT).               
   END.          
   FOR EACH tidsedel USE-INDEX PSTART:
      IF tidsedel.START = tidsedel.SLUT THEN NEXT.
      sekunder = tidsedel.TOTALT.
      RUN SEKTIM.P.
      ASSIGN tidsedel.TOTALT = nytid.               
   END.                                 
   sekunder = arrtidsum.
   RUN SEKTIM.P.
   arrtidsum = nytid.
   sekunder = arrfrsum.
   RUN SEKTIM.P.
   arrfrsum = nytid.
   sekunder = arrressum.
   RUN SEKTIM.P.
   arrressum = nytid.      
   ordarbman = 0.
   /*ordinarie tid mellan första och sista tidregistreringen*/
   FIND FIRST tidsedel WHERE NO-LOCK NO-ERROR.
   IF AVAILABLE tidsedel THEN DO:
      /*ändrat 20141124 om de bara inte har registrerat startdagar i månaden kommer inte ord tid med*/
      visstdat = bdatum.
      regdatum = bdatum.          
      FIND FIRST GODKOLL WHERE GODKOLL.PERSONALKOD = PERSONALTAB.PERSONALKOD AND GODKOLL.DATAR = YEAR (avdatum)
      AND GODKOLL.DATMAN = MONTH(avdatum) AND GODKOLL.KLAR = TRUE NO-LOCK NO-ERROR.
      IF AVAILABLE GODKOLL  THEN DO:
         vissldat = avdatum.
      END.
      ELSE DO:         
         IF MONTH(TODAY) = MONTH(avdatum) THEN DO:
            FIND LAST tidsedel WHERE NO-LOCK NO-ERROR.
            vissldat =  tidsedel.datum.
         END.
         ELSE vissldat = avdatum.
      END.              
      REPEAT:     
         IF regdatum > vissldat THEN LEAVE.             
         RUN REGVEC.P.
         RUN SLUTARB.P.
         ordarbman = ordarbman + klock100(regtotalt).                          
         regdatum = regdatum + 1.
      END.          
   END.             
          
END PROCEDURE.

PROCEDURE tolk_UI :   
   RUN skaptidsed_UI.  
   RUN huvud_UI.
   RUN timmar_UI.
   RUN beredskap_UI.  /*beredskap*/
   RUN lontill_UI.    /*lönetill*/
   RUN overtill_UI.    /*övertid*/
   RUN trakt_UI.     /*traktamenten*/
   RUN skapaut_UI.                     
END PROCEDURE.

PROCEDURE trakt_UI :
      /* TRAKTAMENTEN*/                               
   FOR EACH tidsedel BY tidsedel.TRAKTKOD:
      IF tidsedel.TRAKTKOD = "" THEN NEXT.
      FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = tidsedel.TRAKTKOD AND
      TRAKTATAB.TRAAVTAL = vartraktav  USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
      FIND FIRST TRAKTREGLER WHERE TRAKTREGLER.TRAKTKOD = tidsedel.TRAKTKOD AND
      TRAKTREGLER.TRAAVTAL = vartraktav  USE-INDEX AVTAL NO-LOCK NO-ERROR.
      IF NOT AVAILABLE TRAKTATAB THEN DO:
         /*Om personen bytt avtal ska det inte spåra ur*/
         FIND FIRST TRAKTATAB WHERE TRAKTATAB.TRAKTKOD = tidsedel.TRAKTKOD USE-INDEX TRAKTKOD NO-LOCK NO-ERROR.  
         FIND FIRST TRAKTREGLER WHERE TRAKTREGLER.TRAKTKOD = tidsedel.TRAKTKOD USE-INDEX AVTAL NO-LOCK NO-ERROR.
      END.
      IF AVAILABLE TRAKTREGLER THEN DO:
          IF TRAKTREGLER.TRAKTANTAL = 0 THEN DO:
              nytid = tidsedel.TRAKTANTAL.
              RUN TIMSEK.P.             
              ASSIGN tidsedel.TERSATTNING = TRAKTATAB.ERSATTNING * sekunder / 3600.
          END.
          ELSE ASSIGN tidsedel.TERSATTNING = TRAKTATAB.ERSATTNING * tidsedel.TRAKTANTAL.          
      END.
      ELSE ASSIGN tidsedel.TERSATTNING = TRAKTATAB.ERSATTNING * tidsedel.TRAKTANTAL.      
      ASSIGN tidsedel.TRAKTKOD = TRAKTATAB.VILART.
   END.   
   ASSIGN   
   traraknare = 0.   
   FOR EACH tidsedel BREAK BY tidsedel.TRAKTKOD:
      IF tidsedel.TRAKTANTAL = 0 THEN NEXT. 
      ACCUMULATE tidsedel.TRAKTANTAL (TOTAL BY tidsedel.TRAKTKOD). 
      ACCUMULATE tidsedel.TERSATTNING (TOTAL BY tidsedel.TRAKTKOD).
      IF LAST-OF(tidsedel.TRAKTKOD) THEN DO:
         ASSIGN 
         traraknare = traraknare + 1
         arrtsum[traraknare] = (ACCUM TOTAL BY tidsedel.TRAKTKOD tidsedel.TRAKTANTAL)
         arrtesum[traraknare] = (ACCUM TOTAL BY tidsedel.TRAKTKOD tidsedel.TERSATTNING) 
         arrtsumkod[traraknare] = tidsedel.TRAKTKOD.           
      END.
   END.     
   trasummax = traraknare.              
END PROCEDURE.
PROCEDURE atkgrans_UI :     
   DEFINE OUTPUT PARAMETER foremaxarbkort  AS INTEGER NO-UNDO.
   /*finns även i phmtapp.P*/
   FIND FIRST FORETAG  NO-LOCK NO-ERROR.
   IF FORETAG.FORETAG = "gkal" THEN foremaxarbkort = 63.
   ELSE IF FORETAG.FORETAG = "sund" THEN foremaxarbkort = 54.
   ELSE IF FORETAG.FORETAG = "misv" THEN foremaxarbkort = 27.
   ELSE IF FORETAG.FORETAG = "snat" THEN foremaxarbkort = 63.
   ELSE IF FORETAG.FORETAG = "LULE" THEN foremaxarbkort = 63.
   ELSE foremaxarbkort = 63.
      
END PROCEDURE.

PROCEDURE kompinut_UI :
/*   CCC*/
   DEFINE VARIABLE kompaonr AS CHARACTER NO-UNDO.
   DEFINE VARIABLE hjregar AS INTEGER NO-UNDO.
   hjregar = YEAR(bdatum).
   FIND PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod  NO-LOCK NO-ERROR. 
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
   USE-INDEX ANSTF NO-LOCK NO-ERROR.                            
   OPEN QUERY toq FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
   AND TIDREGITAB.DATUM GE DATE(01,01,hjregar) AND TIDREGITAB.DATUM LE DATE(12,31,hjregar) AND TIDREGITAB.OKOD1 NE "" AND TIDREGITAB.OVERTIDUTTAG = "K"  NO-LOCK.
   GET FIRST toq NO-LOCK.
   DO WHILE AVAILABLE (TIDREGITAB):
      IF TIDREGITAB.OVERTIDUTTAG = "K"  THEN DO:                 
         IF TIDREGITAB.OANT1 > 0  THEN DO:      
            CREATE overtidhj2.                          
            ASSIGN
            overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                                               
            overtidhj2.DATUM =  TIDREGITAB.DATUM
            overtidhj2.OVERANTAL = klock100(TIDREGITAB.OANT1) 
            overtidhj2.OVERTIDTILL = TIDREGITAB.OKOD1
            overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM)
            overtidhj2.MULTIP = 1
            overtidhj2.OVERTIDUTTAG = TIDREGITAB.OVERTIDUTTAG
            overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
            FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = TIDREGITAB.OKOD1 AND OVERKOD.KOD = ANSTFORMTAB.KOD USE-INDEX OVER NO-LOCK NO-ERROR.
            IF AVAILABLE  OVERKOD THEN DO:                                               
               IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj2.MULTIP = OVERKOD.MULTIP.
               ELSE overtidhj2.MULTIP =  OVERKOD.ERSATTNING.
            END.
            IF TIDREGITAB.OVERTIDUTTAG = "K" THEN DO: 
               overtidhj2.ANTMULT = (1 + overtidhj2.MULTIP) * overtidhj2.OVERANTAL.
               /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena */               
               overtidhj2.VERKKO = klock100(TIDREGITAB.TOTALT).
            END.              
         END.      
         IF TIDREGITAB.OANT2 > 0  THEN DO:      
            CREATE overtidhj2.                          
            ASSIGN
            overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                                          
            overtidhj2.DATUM =  TIDREGITAB.DATUM            
            overtidhj2.OVERANTAL = klock100(TIDREGITAB.OANT2) 
            overtidhj2.OVERTIDTILL = TIDREGITAB.OKOD2
            overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM)
            overtidhj2.MULTIP = 1
            overtidhj2.OVERTIDUTTAG = TIDREGITAB.OVERTIDUTTAG
            overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
            FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = TIDREGITAB.OKOD2 AND OVERKOD.KOD = ANSTFORMTAB.KOD USE-INDEX OVER NO-LOCK NO-ERROR.
            IF AVAILABLE  OVERKOD THEN DO:                                               
               IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj2.MULTIP = OVERKOD.MULTIP.
               ELSE overtidhj2.MULTIP =  OVERKOD.ERSATTNING.
            END.               
            IF TIDREGITAB.OVERTIDUTTAG = "K" THEN DO: 
               overtidhj2.ANTMULT = (1 + overtidhj2.MULTIP) * overtidhj2.OVERANTAL.
               /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena 
               oant2 skall bara räknas om oant1 = 0*/
               IF TIDREGITAB.OANT1 = 0  THEN   overtidhj2.VERKKO = klock100(TIDREGITAB.TOTALT).                
            END.               
         END.      
         IF TIDREGITAB.OANT3 > 0  THEN DO:      
            CREATE overtidhj2.                          
            ASSIGN
            overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                                          
            overtidhj2.DATUM =  TIDREGITAB.DATUM            
            overtidhj2.OVERANTAL = klock100(TIDREGITAB.OANT3) 
            overtidhj2.OVERTIDTILL = TIDREGITAB.OKOD3
            overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM)
            overtidhj2.MULTIP = 1
            overtidhj2.OVERTIDUTTAG = TIDREGITAB.OVERTIDUTTAG
            overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
            FIND FIRST OVERKOD WHERE OVERKOD.OVERTIDTILL = TIDREGITAB.OKOD3 AND OVERKOD.KOD = ANSTFORMTAB.KOD USE-INDEX OVER NO-LOCK NO-ERROR.
            IF AVAILABLE  OVERKOD THEN DO:                                               
               IF Guru.Konstanter:globforetag = "gkal" THEN overtidhj2.MULTIP = OVERKOD.MULTIP.
               ELSE overtidhj2.MULTIP =  OVERKOD.ERSATTNING.
            END.
            IF TIDREGITAB.OVERTIDUTTAG = "K" THEN DO:                   
               overtidhj2.ANTMULT = (1 + overtidhj2.MULTIP) * overtidhj2.OVERANTAL.
               /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena 
               oant3 skall bara räknas om oant1 = 0 och oant2= 0*/
               IF TIDREGITAB.OANT1 = 0 AND  TIDREGITAB.OANT2 = 0  THEN   overtidhj2.VERKKO = klock100(TIDREGITAB.TOTALT).               
            END.                             
         END.
      END.                       
      GET NEXT toq NO-LOCK.           
   END.      
   IF Guru.Konstanter:globforetag = "GKAL" THEN kompaonr = "171".
   ELSE kompaonr = "170".
   OPEN QUERY toUq FOR EACH TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
   AND TIDREGITAB.DATUM GE DATE(01,01,hjregar) AND TIDREGITAB.DATUM LE DATE(12,31,hjregar) AND TIDREGITAB.AONR = kompaonr  NO-LOCK.
   GET FIRST touq NO-LOCK.
   DO WHILE AVAILABLE (TIDREGITAB):
      CREATE overtidhj2.                          
      ASSIGN
      overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                    
      overtidhj2.DATUM =  TIDREGITAB.DATUM.                     
      overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM).
      overtidhj2.KOMPUTTAG = klock100(TIDREGITAB.TOTALT).         
      overtidhj2.MULTIP = 1.
      overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
      GET NEXT touq NO-LOCK.           
   END.                  
   IF Guru.Konstanter:globforetag = "snat" THEN DO:      
      /*berdskapstolkning när veckvila inträffar under klämdag genererar lart 260 = Fyllnadslön mot ledighet vid beredskap Lena 20190611*/         
      OPEN QUERY tblq FOR EACH TIDREGITAB WHERE
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM GE DATE(01,01,hjregar) AND TIDREGITAB.DATUM LE DATE(12,31,hjregar) AND
      TIDREGITAB.LONTILLAGG = "260"  USE-INDEX PSTART NO-LOCK.   
      GET FIRST tblq NO-LOCK.
      DO WHILE AVAILABLE(TIDREGITAB):
         CREATE overtidhj2.                          
         ASSIGN
         overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                                               
         overtidhj2.DATUM =  TIDREGITAB.DATUM
         overtidhj2.OVERANTAL = klock100(TIDREGITAB.LONTILLANTAL) 
         overtidhj2.OVERTIDTILL = TIDREGITAB.LONTILLAGG
         overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM)
         overtidhj2.MULTIP = 0         
         overtidhj2.OVERTIDUTTAG = "K"          
         overtidhj2.ANTMULT =  overtidhj2.OVERANTAL
         /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena */               
         overtidhj2.VERKKO = 0
         overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
         GET NEXT tblq NO-LOCK.      
      END.
      /*berdskapstolkning klämdagar halvdagar genererar lart 260 = Fyllnadslön mot ledighet vid beredksp Lena 20190611*/      
      OPEN QUERY tbq FOR EACH TIDREGITAB WHERE
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM GE DATE(01,01,hjregar) AND TIDREGITAB.DATUM LE DATE(12,31,hjregar) AND
      TIDREGITAB.BEREDSKAP = "260"  USE-INDEX PSTART NO-LOCK.   
      GET FIRST tbq NO-LOCK.
      DO WHILE AVAILABLE(TIDREGITAB):
         CREATE overtidhj2.                          
         ASSIGN
         overtidhj2.PERSONALKOD = TIDREGITAB.PERSONALKOD                                               
         overtidhj2.DATUM =  TIDREGITAB.DATUM
         overtidhj2.OVERANTAL = klock100(TIDREGITAB.BERANTAL) 
         overtidhj2.OVERTIDTILL = TIDREGITAB.BEREDSKAP
         overtidhj2.MANAD = MONTH(TIDREGITAB.DATUM)
         overtidhj2.MULTIP = 0         
         overtidhj2.OVERTIDUTTAG = "K"          
         overtidhj2.ANTMULT =  overtidhj2.OVERANTAL
         /*ändrad till verklig tid inte inte avrundad tid 20171122 Lena */               
         overtidhj2.VERKKO = 0
         overtidhj2.VECKOKORD = TIDREGITAB.VECKOKORD.
         GET NEXT tbq NO-LOCK.      
      END.
   END.  
   /*TA BARA MED EJ KÖRDA LART 260  resten går in i KOMPSALDO vid körning
   fel- man vill veta alla timmar 260 oavset kört eller inte 20190618*/
   berkomp = 0.   
   FOR EACH overtidhj2 WHERE /*overtidhj2.VECKOKORD = "" AND */overtidhj2.DATUM LE avdatum AND overtidhj2.OVERTIDTILL = "260":
      berkomp = berkomp + overtidhj2.OVERANTAL.   
   END. 
   FOR EACH overtidhj2 BREAK BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD:    
      ACCUMULATE overtidhj2.OVERANTAL (TOTAL  BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD ).        
      ACCUMULATE overtidhj2.ANTMULT (TOTAL  BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD).
      ACCUMULATE overtidhj2.KOMPUTTAG (TOTAL  BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD).
      ACCUMULATE overtidhj2.VERKKO (TOTAL  BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD).
      ACCUMULATE overtidhj2.VERKOV (TOTAL  BY overtidhj2.PERSONALKOD BY overtidhj2.MANAD).              
      IF LAST-OF(overtidhj2.MANAD) THEN DO:      
         CREATE oversum.
         ASSIGN         
         oversum.PERSONALKOD = overtidhj2.PERSONALKOD                  
         oversum.NAMN = overtidhj2.NAMN        
         oversum.MANAD =   overtidhj2.MANAD.        
         oversum.OVERANTAL = (ACCUM TOTAL BY overtidhj2.MANAD overtidhj2.OVERANTAL).                  
         oversum.ANTMULT = (ACCUM TOTAL BY overtidhj2.MANAD overtidhj2.ANTMULT).
         oversum.KOMPUTTAG = (ACCUM TOTAL BY overtidhj2.MANAD overtidhj2.KOMPUTTAG).
         oversum.VERKKO = (ACCUM TOTAL BY overtidhj2.MANAD overtidhj2.VERKKO).
         oversum.VERKOV = (ACCUM TOTAL BY overtidhj2.MANAD overtidhj2.VERKOV).                                             
      END.
   END.   
   FOR EACH oversum WHERE  BY oversum.PERSONALKOD : 
      FIND FIRST overhela WHERE overhela.PERSONALKOD = oversum.PERSONALKOD NO-ERROR.
      IF NOT AVAILABLE overhela  THEN DO:
         CREATE overhela.
         ASSIGN overhela.PERSONALKOD  =  oversum.PERSONALKOD
         overhela.NAMN = oversum.NAMN.         
      END.
      overhela.VERKKO = overhela.VERKKO + oversum.VERKKO.
      overhela.VERKOV = overhela.VERKOV + oversum.VERKOV.
      overhela.KOMPTOT = overhela.KOMPTOT + oversum.ANTMULT.
      overhela.KOMPUTTOT = overhela.KOMPUTTOT + oversum.KOMPUTTAG.       
   END.
 
   /*ej körd kompsaldo*/
   EMPTY TEMP-TABLE overksum NO-ERROR. 
   FOR EACH overtidhj2 WHERE overtidhj2.VECKOKORD = "" AND overtidhj2.DATUM LE avdatum BREAK BY overtidhj2.PERSONALKOD:    
      ACCUMULATE overtidhj2.OVERANTAL (TOTAL  BY overtidhj2.PERSONALKOD).        
      ACCUMULATE overtidhj2.ANTMULT (TOTAL  BY overtidhj2.PERSONALKOD).
      ACCUMULATE overtidhj2.KOMPUTTAG (TOTAL  BY overtidhj2.PERSONALKOD).
      ACCUMULATE overtidhj2.VERKKO (TOTAL  BY overtidhj2.PERSONALKOD).
      ACCUMULATE overtidhj2.VERKOV (TOTAL  BY overtidhj2.PERSONALKOD).              
      IF LAST-OF(overtidhj2.PERSONALKOD) THEN DO:      
         CREATE overksum.
         ASSIGN         
         overksum.PERSONALKOD = overtidhj2.PERSONALKOD                  
         overksum.NAMN = overtidhj2.NAMN                         
         overksum.OVERANTAL = (ACCUM TOTAL BY overtidhj2.PERSONALKOD overtidhj2.OVERANTAL).                  
         overksum.ANTMULT = (ACCUM TOTAL BY overtidhj2.PERSONALKOD overtidhj2.ANTMULT).
         overksum.KOMPUTTAG = (ACCUM TOTAL BY overtidhj2.PERSONALKOD overtidhj2.KOMPUTTAG).
         overksum.VERKKO = (ACCUM TOTAL BY overtidhj2.PERSONALKOD overtidhj2.VERKKO).
         overksum.VERKOV = (ACCUM TOTAL BY overtidhj2.PERSONALKOD overtidhj2.VERKOV).                                             
      END.
   END.         
END PROCEDURE.
