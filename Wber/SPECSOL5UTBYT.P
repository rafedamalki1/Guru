/*SPECSOL5UTBYT.P*/
DEFINE TEMP-TABLE mattemp 
   FIELD NUM AS INTEGER
   FIELD ENR AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD ENHET AS CHARACTER
   FIELD ANTAL AS INTEGER
   FIELD PRIS AS DECIMAL  
   FIELD TOTPRIS AS DECIMAL
   FIELD LEVKOD AS CHARACTER
   FIELD LNAMN AS CHARACTER
   FIELD UPPLAG AS INTEGER      
   FIELD GRUPP AS INTEGER 
   FIELD XKORD AS INTEGER 
   FIELD FORNR AS CHARACTER
   FIELD LINNR AS CHARACTER
   FIELD NATNR AS CHARACTER
   FIELD FRI1 AS INTEGER 
   FIELD FRI2 AS INTEGER 
   FIELD LEVKOD2 AS CHARACTER
   FIELD LNAMN2 AS CHARACTER
   FIELD ENR2 AS CHARACTER
   FIELD PRIS2 AS DECIMAL  
   FIELD BENAMNING2 AS CHARACTER
   FIELD ENHET2 AS CHARACTER
   INDEX ENR IS PRIMARY ENR ASCENDING
   INDEX NUM NUM ASCENDING.        

DEFINE INPUT PARAMETER levvar AS LOGICAL NO-UNDO.
DEFINE INPUT PARAMETER lkod AS CHARACTER NO-UNDO.
DEFINE INPUT PARAMETER ltill AS CHARACTER NO-UNDO.
DEFINE OUTPUT PARAMETER TABLE FOR mattemp.

   
   EMPTY TEMP-TABLE mattemp  NO-ERROR. 
   
   IF lkod = ? THEN DO:   
      OPEN QUERY mq FOR EACH MTRLBER NO-LOCK.
   END.
   ELSE DO:
      OPEN QUERY mq FOR EACH MTRLBER WHERE MTRLBER.LEVKOD = lkod NO-LOCK.
   END.
   GET FIRST mq NO-LOCK.
   DO WHILE AVAILABLE(MTRLBER):
      IF levvar = FALSE THEN
      FIND FIRST mattemp WHERE mattemp.ENR = MTRLBER.ENR USE-INDEX ENR NO-LOCK NO-ERROR.
      ELSE
      FIND FIRST mattemp WHERE mattemp.ENR = MTRLBER.ENR AND mattemp.LEVKOD = MTRLBER.LEVKOD 
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE mattemp THEN DO:
         CREATE mattemp.
         ASSIGN
         mattemp.ENR = MTRLBER.ENR
         mattemp.BENAMNING = MTRLBER.BENAMNING
         mattemp.ENHET = MTRLBER.ENHET
         mattemp.PRIS = MTRLBER.PRIS
         mattemp.LEVKOD = MTRLBER.LEVKOD.         
         IF levvar = TRUE THEN DO:
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = mattemp.LEVKOD NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN mattemp.FORNR = LEVERANTOR.LEVNAMN.
         END.         
         FIND FIRST UTBYTESLISTA WHERE UTBYTESLISTA.UID = 0 AND UTBYTESLISTA.ORGLEVKOD = mattemp.LEVKOD AND UTBYTESLISTA.ORGENR = mattemp.ENR
         AND UTBYTESLISTA.BYTTILLLEVKOD = ltill NO-LOCK NO-ERROR.
         IF AVAILABLE UTBYTESLISTA  THEN DO:
            ASSIGN
            mattemp.ENR2 = UTBYTESLISTA.BYTTILLENR
            mattemp.LEVKOD2 = UTBYTESLISTA.BYTTILLLEVKOD.
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = ltill NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN + " E".
            FIND FIRST MTRL WHERE MTRL.LEVKOD = mattemp.LEVKOD2 AND MTRL.ENR = mattemp.ENR2 AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO: 
               ASSIGN
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.
            END.
         END.
         ELSE DO:
            FIND FIRST MTRL WHERE MTRL.LEVKOD = ltill AND MTRL.ENR = mattemp.ENR AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO: 
               FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = ltill NO-LOCK NO-ERROR.
               IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN .
               ASSIGN
               mattemp.ENR2 = mattemp.ENR
               mattemp.LEVKOD2 = ltill
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.

            END.
         END.
      END.   
      GET NEXT mq NO-LOCK.
   END.
   IF lkod = ? THEN DO:   
      OPEN QUERY kq FOR EACH BERSKAP WHERE BERSKAP.ENR NE "" NO-LOCK.
   END.
   ELSE DO:
      OPEN QUERY kq FOR EACH BERSKAP WHERE BERSKAP.LEVKOD = lkod AND BERSKAP.ENR NE "" NO-LOCK.
   END.
   GET FIRST kq NO-LOCK.
   DO WHILE AVAILABLE(BERSKAP):
      IF levvar = FALSE THEN
      FIND FIRST mattemp WHERE mattemp.ENR = BERSKAP.ENR USE-INDEX ENR NO-LOCK NO-ERROR.
      ELSE
      FIND FIRST mattemp WHERE mattemp.ENR = BERSKAP.ENR AND mattemp.LEVKOD = BERSKAP.LEVKOD 
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE mattemp THEN DO:
         CREATE mattemp.
         ASSIGN
         mattemp.ENR = BERSKAP.ENR
         mattemp.BENAMNING = BERSKAP.BENAMNING
         mattemp.ENHET = BERSKAP.ENHET
         mattemp.PRIS = BERSKAP.PRIS
         mattemp.LEVKOD = BERSKAP.LEVKOD.
         IF levvar = TRUE THEN DO:
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = mattemp.LEVKOD NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN DO: 
               ASSIGN
               mattemp.FORNR = LEVERANTOR.LEVNAMN.             
            END.
         END.
         FIND FIRST UTBYTESLISTA WHERE UTBYTESLISTA.UID = 0 AND UTBYTESLISTA.ORGLEVKOD = mattemp.LEVKOD AND UTBYTESLISTA.ORGENR = mattemp.ENR
         AND UTBYTESLISTA.BYTTILLLEVKOD = ltill NO-LOCK NO-ERROR.
         IF AVAILABLE UTBYTESLISTA  THEN DO:
            ASSIGN
            mattemp.ENR2 = UTBYTESLISTA.BYTTILLENR
            mattemp.LEVKOD2 = UTBYTESLISTA.BYTTILLLEVKOD.
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = mattemp.LEVKOD2 NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN.
            FIND FIRST MTRL WHERE MTRL.LEVKOD = mattemp.LEVKOD2 AND MTRL.ENR = mattemp.ENR2 AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO:                
               ASSIGN
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.
            END.
         END.
         ELSE DO:
            FIND FIRST MTRL WHERE MTRL.LEVKOD = ltill AND MTRL.ENR = mattemp.ENR AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO: 
               FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = ltill NO-LOCK NO-ERROR.
               IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN .
               ASSIGN
               mattemp.ENR2 = mattemp.ENR
               mattemp.LEVKOD2 = ltill
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.

            END.
         END.
      END.
      GET NEXT kq NO-LOCK.
   END.
   IF lkod = ? THEN DO:   
      OPEN QUERY kq2 FOR EACH BERSTOLP NO-LOCK.
   END.
   ELSE DO:
      OPEN QUERY kq2 FOR EACH BERSTOLP WHERE BERSTOLP.LEVKOD = lkod NO-LOCK.
   END.
   GET FIRST kq2 NO-LOCK.
   DO WHILE AVAILABLE(BERSTOLP):
      IF levvar = FALSE THEN
      FIND FIRST mattemp WHERE mattemp.ENR = BERSTOLP.ENR USE-INDEX ENR NO-LOCK NO-ERROR.
      ELSE
      FIND FIRST mattemp WHERE mattemp.ENR = BERSTOLP.ENR AND mattemp.LEVKOD = BERSTOLP.LEVKOD 
      NO-LOCK NO-ERROR.
      IF NOT AVAILABLE mattemp THEN DO:
         CREATE mattemp.
         ASSIGN
         mattemp.ENR = BERSTOLP.ENR
         mattemp.BENAMNING = BERSTOLP.BENAMNING
         mattemp.ENHET = BERSTOLP.ENHET
         mattemp.PRIS = BERSTOLP.PRIS
         mattemp.LEVKOD = BERSTOLP.LEVKOD.
         IF levvar = TRUE THEN DO:
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = mattemp.LEVKOD NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN mattemp.FORNR = LEVERANTOR.LEVNAMN.
         END.
         FIND FIRST UTBYTESLISTA WHERE UTBYTESLISTA.UID = 0 AND UTBYTESLISTA.ORGLEVKOD = mattemp.LEVKOD AND UTBYTESLISTA.ORGENR = mattemp.ENR
         AND UTBYTESLISTA.BYTTILLLEVKOD = ltill NO-LOCK NO-ERROR.
         IF AVAILABLE UTBYTESLISTA  THEN DO:
            ASSIGN
            mattemp.ENR2 = UTBYTESLISTA.BYTTILLENR
            mattemp.LEVKOD2 = UTBYTESLISTA.BYTTILLLEVKOD.
            FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = mattemp.LEVKOD2 NO-LOCK NO-ERROR.
            IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN.
            FIND FIRST MTRL WHERE MTRL.LEVKOD = mattemp.LEVKOD2 AND MTRL.ENR = mattemp.ENR2 AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO:                
               ASSIGN
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.
            END.
         END.
         ELSE DO:
            FIND FIRST MTRL WHERE MTRL.LEVKOD = ltill AND MTRL.ENR = mattemp.ENR AND MTRL.KALKNR = 0 NO-LOCK NO-ERROR.
            IF AVAILABLE MTRL THEN DO: 
               FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD = ltill NO-LOCK NO-ERROR.
               IF AVAILABLE LEVERANTOR THEN mattemp.LNAMN2 = LEVERANTOR.LEVNAMN .
               ASSIGN
               mattemp.ENR2 = mattemp.ENR
               mattemp.LEVKOD2 = ltill
               mattemp.PRIS2 = MTRL.NPRIS
               mattemp.BENAMNING2 = MTRL.BENAMNING
               mattemp.ENHET2 = MTRL.ENHET.

            END.
         END.
      END.
      GET NEXT kq2 NO-LOCK.
   END.
