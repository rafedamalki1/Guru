/*VALGRUPPAPP.P - anropas av valgruppu.w och valgruppu3.w*/

{KONSTRMTRL.I}
{BERTRAFFTEMP.I}
  
     
   DEFINE TEMP-TABLE ekon_temp
   FIELD KONSKOD AS INTEGER
   FIELD KTYPKOD AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD ORDNING AS INTEGER
   INDEX ORD ORDNING ASCENDING.
DEFINE NEW SHARED TEMP-TABLE egrupp_temp
   FIELD KONSKOD AS INTEGER
   FIELD BENAMNING AS CHARACTER
   FIELD ORDNING AS INTEGER
   INDEX ORD ORDNING ASCENDING.


PROCEDURE mtrlberhmt_UI :
   DEFINE INPUT PARAMETER konval AS INTEGER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR mtrlbertemp.
   EMPTY TEMP-TABLE mtrlbertemp NO-ERROR. 
   OPEN QUERY konq FOR EACH KONSTRUKTION WHERE KONSTRUKTION.KONSKOD = konval NO-LOCK.
   GET FIRST konq NO-LOCK.
   DO WHILE AVAILABLE(KONSTRUKTION):
      OPEN QUERY mq FOR EACH MTRLBER WHERE MTRLBER.KTYPKOD = KONSTRUKTION.KTYPKOD NO-LOCK.
      GET FIRST mq NO-LOCK.
      DO WHILE AVAILABLE(MTRLBER):
         CREATE mtrlbertemp.
         BUFFER-COPY MTRLBER TO mtrlbertemp.
         ASSIGN mtrlbertemp.MTRLROW = ROWID(MTRLBER).
         GET NEXT mq NO-LOCK.
      END.
      CLOSE QUERY mq.
      GET NEXT konq NO-LOCK.
   END.
   CLOSE QUERY konq.
   RETURN.
END PROCEDURE.

PROCEDURE mtrlberhmt3_UI :
   DEFINE INPUT PARAMETER typkod AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR mtrlbertemp.
   EMPTY TEMP-TABLE mtrlbertemp NO-ERROR. 
   OPEN QUERY mq FOR EACH MTRLBER WHERE MTRLBER.KTYPKOD = typkod NO-LOCK.
   GET FIRST mq NO-LOCK.
   DO WHILE AVAILABLE(MTRLBER):
      CREATE mtrlbertemp.
      BUFFER-COPY MTRLBER TO mtrlbertemp.
      ASSIGN mtrlbertemp.MTRLROW = ROWID(MTRLBER).
      GET NEXT mq NO-LOCK.
   END.
   CLOSE QUERY mq.
   RETURN.
END PROCEDURE.

PROCEDURE hamtaAOkon_UI:
   DEFINE INPUT PARAMETER TABLE FOR ekon_temp.
   DEFINE INPUT PARAMETER startdat AS DATE NO-UNDO.
   DEFINE INPUT PARAMETER slutdat AS DATE NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR bertrafftemp.   
   EMPTY TEMP-TABLE aobertemp NO-ERROR.
   EMPTY TEMP-TABLE bertrafftemp NO-ERROR.
   FOR EACH AONRTIDLAGE WHERE AONRTIDLAGE.IDTIDLAG = "AOUPPLAGT" AND AONRTIDLAGE.DATUM1 >= startdat AND  AONRTIDLAGE.DATUM1 <= slutdat  NO-LOCK, 
   EACH AONRTAB WHERE   
   AONRTAB.AONR = AONRTIDLAGE.AONR AND
   AONRTAB.DELNR = AONRTIDLAGE.DELNR      NO-LOCK.
     FIND FIRST BEREDNING  WHERE BEREDNING.AONR = AONRTAB.AONR AND BEREDNING.DELNR = AONRTAB.DELNR   NO-LOCK NO-ERROR.  
      IF AVAILABLE BEREDNING  THEN DO:
         CREATE  aobertemp.
         ASSIGN
         aobertemp.AONR  = AONRTAB.AONR
         aobertemp.DELNR = AONRTAB.DELNR  
         aobertemp.ORT = AONRTAB.ORT            
         aobertemp.DATUM = AONRTIDLAGE.DATUM1
         aobertemp.BEREDARE = AONRTAB.BEREDARE
         aobertemp.OMRADE = BEREDNING.OMRADE
         aobertemp.BERNR = BEREDNING.BERNR.
      END.   
   END.  
   FOR EACH ekon_temp  NO-LOCK,
   EACH aobertemp  NO-LOCK,            
   EACH BERVAL WHERE BERVAL.AONR =  string(aobertemp.BERNR)  AND BERVAL.OMRADE = aobertemp.OMRADE
   AND BERVAL.KONSKOD = ekon_temp.KONSKOD AND BERVAL.KTYPKOD  = ekon_temp.KTYPKOD AND BERVAL.KSKAP = FALSE   NO-LOCK:
      FIND FIRST KONSTGRUPP  WHERE KONSTGRUPP.KONSKOD = BERVAL.KONSKOD   NO-LOCK NO-ERROR.
      CREATE bertrafftemp.
      ASSIGN
      bertrafftemp.AONR = aobertemp.aonr
      bertrafftemp.DELNR  = aobertemp.DELNR
      bertrafftemp.ORT  = aobertemp.ORT
      bertrafftemp.BEREDARE = aobertemp.BEREDARE
      bertrafftemp.OMRADE = aobertemp.OMRADE
      bertrafftemp.BERNR = aobertemp.BERNR
      bertrafftemp.DATUM  = aobertemp.DATUM
      bertrafftemp.KONSKOD  = BERVAL.KONSKOD
      bertrafftemp.BENAMNING  =  KONSTGRUPP.BENAMNING
      bertrafftemp.KTYPKOD  = BERVAL.KTYPKOD
      bertrafftemp.NUM  = BERVAL.NUM.
      FIND FIRST BERID WHERE BERID.OMRADE = BERVAL.OMRADE AND 
      BERID.AONR = BERVAL.AONR AND BERID.NUM = BERVAL.NUM NO-LOCK NO-ERROR.
      IF AVAILABLE BERID THEN DO:
          bertrafftemp.ID2  = BERID.FRI2.
      END.         
      FIND FIRST BERID WHERE NO-LOCK NO-ERROR.
      bertrafftemp.NUM  = BERVAL.NUM . 
   END. 
            
END PROCEDURE.

PROCEDURE hamtaAOgrupp_UI:
   DEFINE INPUT PARAMETER TABLE FOR egrupp_temp.
   DEFINE INPUT PARAMETER startdat AS DATE NO-UNDO.
   DEFINE INPUT PARAMETER slutdat AS DATE NO-UNDO.   
   DEFINE OUTPUT PARAMETER TABLE FOR bertrafftemp.
   EMPTY TEMP-TABLE aobertemp NO-ERROR.
   EMPTY TEMP-TABLE bertrafftemp NO-ERROR.  
   FOR EACH AONRTIDLAGE WHERE AONRTIDLAGE.IDTIDLAG = "AOUPPLAGT" AND AONRTIDLAGE.DATUM1 >= startdat AND  AONRTIDLAGE.DATUM1 <= slutdat  NO-LOCK, 
   EACH AONRTAB WHERE   
   AONRTAB.AONR = AONRTIDLAGE.AONR AND
   AONRTAB.DELNR = AONRTIDLAGE.DELNR      NO-LOCK.
      FIND FIRST BEREDNING  WHERE BEREDNING.AONR = AONRTAB.AONR AND BEREDNING.DELNR = AONRTAB.DELNR   NO-LOCK NO-ERROR.  
      IF AVAILABLE BEREDNING  THEN DO:
         CREATE  aobertemp.
         ASSIGN
         aobertemp.AONR  = AONRTAB.AONR
         aobertemp.DELNR = AONRTAB.DELNR
         aobertemp.ORT = AONRTAB.ORT              
         aobertemp.DATUM = AONRTIDLAGE.DATUM1
         aobertemp.BEREDARE = AONRTAB.BEREDARE
         aobertemp.OMRADE = BEREDNING.OMRADE
         aobertemp.BERNR = BEREDNING.BERNR.
      END.   
   END.  
   FOR EACH BEREDNING WHERE BEREDNING.AONR = ? NO-LOCK:
      FIND FIRST BERMTRL WHERE BERMTRL.AONR = BEREDNING.BERAONR AND BERMTRL.OMRADE = BEREDNING.OMRADE AND BERMTRL.DATUM >= startdat AND BERMTRL.DATUM <= slutdat   NO-LOCK NO-ERROR.
      IF AVAILABLE BERMTRL THEN DO:
         CREATE  aobertemp.
         ASSIGN
         aobertemp.AONR  = ?
         aobertemp.DELNR = ?
         aobertemp.ORT = BEREDNING.BENAMNING              
         aobertemp.DATUM = BERMTRL.DATUM
         aobertemp.BEREDARE = BEREDNING.ANVANDARE
         aobertemp.OMRADE = BEREDNING.OMRADE
         aobertemp.BERNR = BEREDNING.BERNR.
      END.   
   END.
   FIND FIRST egrupp_temp NO-LOCK NO-ERROR.   
   FOR EACH aobertemp  NO-LOCK,            
   EACH BERVAL WHERE BERVAL.AONR =  STRING(aobertemp.BERNR)  AND BERVAL.OMRADE = aobertemp.OMRADE
   AND BERVAL.KONSKOD = egrupp_temp.KONSKOD AND BERVAL.KSKAP = FALSE   NO-LOCK:
      FIND FIRST KONSTGRUPP  WHERE KONSTGRUPP.KONSKOD = BERVAL.KONSKOD   NO-LOCK NO-ERROR.
      CREATE bertrafftemp.
      ASSIGN
      bertrafftemp.AONR = aobertemp.aonr
      bertrafftemp.DELNR  = aobertemp.DELNR
      bertrafftemp.ORT  = aobertemp.ORT
      bertrafftemp.OMRADE = aobertemp.OMRADE
      bertrafftemp.BERNR = aobertemp.BERNR
      bertrafftemp.BEREDARE = aobertemp.BEREDARE
      bertrafftemp.DATUM  = aobertemp.DATUM
      bertrafftemp.KONSKOD  = BERVAL.KONSKOD
      bertrafftemp.BENAMNING  =  KONSTGRUPP.BENAMNING
      bertrafftemp.KTYPKOD  = BERVAL.KTYPKOD. 
      FIND FIRST BERID WHERE BERID.OMRADE = BERVAL.OMRADE AND 
      BERID.AONR = BERVAL.AONR AND BERID.NUM = BERVAL.NUM NO-LOCK NO-ERROR.
      IF AVAILABLE BERID THEN DO:
          bertrafftemp.ID2  = BERID.FRI2.
      END.       
   END. 
            
END PROCEDURE.


