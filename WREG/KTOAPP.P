/*
     Filename: KTOAPP.P
      Created: 03.08.0018 14:28ELPAO     
     Modified: 
*/

/************************************* VARIABLE **************************************/
DEFINE INPUT PARAMETER anvglob AS CHARACTER NO-UNDO.

DEFINE TEMP-TABLE ktotemp
   FIELD KONTO AS CHARACTER
   FIELD KONTONR AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD JUDID AS CHARACTER
   FIELD VIJUDID AS CHARACTER
   FIELD OMRADE AS CHARACTER
   FIELD AVDELNINGNR AS INTEGER
   FIELD AKTIV AS LOGICAL
   FIELD RECTIDVIS AS RECID
   INDEX KONTO KONTO KONTONR.


DEFINE TEMP-TABLE kbtemp
   FIELD K1 AS CHARACTER
   FIELD K2 AS CHARACTER
   FIELD K3 AS CHARACTER
   FIELD K4 AS CHARACTER
   FIELD K5 AS CHARACTER.
DEFINE TEMP-TABLE jurtemp
   FIELD JUDID AS CHARACTER
   FIELD NAMN AS CHARACTER
   FIELD VIJUDID AS CHARACTER.
&Scoped-define NEW NEW
{GLOBVAR2DEL1.I}
DEFINE VARIABLE globanv AS CHARACTER NO-UNDO.
FIND FIRST FORETAG NO-LOCK NO-ERROR.
Guru.Konstanter:globforetag = FORETAG.FORETAG.
RUN STYRFORE.P (INPUT Guru.Konstanter:globforetag).
globanv = anvglob.

/************************************* KTOREG.W **************************************/

PROCEDURE nykonto_UI: /*ny*/
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.

   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr NO-ERROR.
   DO TRANSACTION:
      CREATE KONTO.
      ASSIGN
      KONTO.KONTO = ktotemp.KONTO
      KONTO.KONTONR = ktotemp.KONTONR
      KONTO.BENAMNING = ktotemp.BENAMNING
      KONTO.JUDID = ktotemp.JUDID
      KONTO.AKTIV = ktotemp.AKTIV
      ktotemp.RECTIDVIS = RECID(KONTO).
   END.
   IF AVAILABLE KONTO THEN RELEASE KONTO.
END PROCEDURE.

PROCEDURE nykontou_UI: /*ny*/
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempjur AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.

   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr AND ktotemp.VIJUDID = tempjur NO-ERROR.
   DO TRANSACTION:
      CREATE KONTO.
      ASSIGN
      KONTO.KONTO = ktotemp.KONTO
      KONTO.KONTONR = ktotemp.KONTONR
      KONTO.BENAMNING = ktotemp.BENAMNING
      KONTO.JUDID = ktotemp.JUDID
      KONTO.AKTIV = ktotemp.AKTIV
      ktotemp.RECTIDVIS = RECID(KONTO).
   END.
   IF AVAILABLE KONTO THEN RELEASE KONTO.
END PROCEDURE.

PROCEDURE andrakonto_UI: /*Ändra*/
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.
   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr NO-ERROR.
   DO TRANSACTION:
      FIND FIRST KONTO WHERE KONTO.KONTO = tempkonto AND
      KONTO.KONTONR = tempkontonr EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KONTO THEN DO:
         ASSIGN
         KONTO.KONTO = ktotemp.KONTO.
         KONTO.KONTONR = ktotemp.KONTONR .
         KONTO.BENAMNING = ktotemp.BENAMNING.
         KONTO.JUDID = ktotemp.JUDID.
         KONTO.AKTIV = ktotemp.AKTIV.
      END.      
   END.
   IF AVAILABLE KONTO THEN RELEASE KONTO.
END.

PROCEDURE andrakontou_UI: /*Ändra*/
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempjur AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.
   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr AND ktotemp.VIJUDID = tempjur NO-ERROR.
   DO TRANSACTION:
      FIND FIRST KONTO WHERE KONTO.KONTO = tempkonto AND
      KONTO.KONTONR = tempkontonr AND KONTO.JUDID = tempjur  EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KONTO THEN DO:
         ASSIGN
         KONTO.KONTO = ktotemp.KONTO.
         KONTO.KONTONR = ktotemp.KONTONR .
         KONTO.BENAMNING = ktotemp.BENAMNING.
         KONTO.JUDID = ktotemp.JUDID.
         KONTO.AKTIV = ktotemp.AKTIV.
      END.      
   END.
   IF AVAILABLE KONTO THEN RELEASE KONTO.
END.


PROCEDURE tabortkonto_UI: /*Ta bort*/
   DEFINE INPUT PARAMETER globforetagvar AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.
   DEFINE OUTPUT PARAMETER felmedd AS CHARACTER NO-UNDO.

   DEFINE VARIABLE aokaonr AS CHARACTER NO-UNDO.
   DEFINE VARIABLE aokdelnr AS INTEGER NO-UNDO.
   DEFINE VARIABLE ksbenamn AS CHARACTER NO-UNDO.

   ASSIGN
   felmedd = ""
   aokaonr = ""
   aokdelnr = 0
   ksbenamn = "".   
   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr NO-ERROR.
   IF NOT AVAILABLE ktotemp THEN DO:
      felmedd = "Hittade ingen ktotemp för konto " + tempkonto +
         " med kod " + tempkontonr + "!".
      RETURN.
   END.
   /*konto jurp*/
   IF Guru.Konstanter:varforetypval[18] = 1 THEN DO:   
      IF ktotemp.KONTO = "K1" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K1 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K2" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K2 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K3" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K3 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K4" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K4 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K5" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K5 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.      
      GET FIRST aq NO-LOCK.
      IF AVAILABLE AONRKONTKOD THEN DO:            
         ASSIGN
         aokaonr = AONRKONTKOD.AONR
         aokdelnr = AONRKONTKOD.DELNR. 
      END.              
      ELSE DO:      
         IF ktotemp.KONTO = "K1" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K1 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K2" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K2 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K3" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K3 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K4" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K4 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K5" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K5 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         GET FIRST ksq NO-LOCK.
         IF AVAILABLE KONTOSTRANG THEN DO:            
            ksbenamn = KONTOSTRANG.BENAMNING.      
         END.     
      END.
      CLOSE QUERY aq.
      CLOSE QUERY ksq.
   END.
   ELSE DO:
      IF ktotemp.KONTO = "K1" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K1 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K2" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K2 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K3" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K3 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K4" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K4 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K5" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K5 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      IF AVAILABLE AONRKONTKOD THEN DO:
         ASSIGN
         aokaonr = AONRKONTKOD.AONR
         aokdelnr = AONRKONTKOD.DELNR.         
      END.
      ELSE DO:
         IF ktotemp.KONTO = "K1" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K1 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K2" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K2 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K3" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K3 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K4" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K4 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K5" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K5 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         IF AVAILABLE KONTOSTRANG THEN DO:
            ksbenamn = KONTOSTRANG.BENAMNING.            
         END.
      END.    
   END.         
   IF aokaonr NE "" THEN DO:
      felmedd = "KONTO " + ktotemp.KONTO + " finns upplagd på aonr " + 
         aokaonr + STRING(aokdelnr,Guru.Konstanter:varforetypchar[1]) + " och kan ej tas bort.".       
   END.
   ELSE IF ksbenamn NE "" THEN DO:
      felmedd = "KONTO " + ktotemp.KONTO + " finns upplagd på kontosträng " +
         ksbenamn + " och kan ej tas bort.".      
   END.
   ELSE DO TRANSACTION:
      FIND FIRST KONTO WHERE KONTO.KONTO = tempkonto AND
         KONTO.KONTONR = tempkontonr EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KONTO THEN DO:
         DELETE KONTO.                  
      END.
   END.
END.

PROCEDURE tabortkontou_UI: /*Ta bort - sök även på judid*/
   DEFINE INPUT PARAMETER globforetagvar AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkonto AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempkontonr AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER tempjurp AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR ktotemp.
   DEFINE OUTPUT PARAMETER felmedd AS CHARACTER NO-UNDO.

   DEFINE VARIABLE aokaonr AS CHARACTER NO-UNDO.
   DEFINE VARIABLE aokdelnr AS INTEGER NO-UNDO.
   DEFINE VARIABLE ksbenamn AS CHARACTER NO-UNDO.

   ASSIGN
   felmedd = ""
   aokaonr = ""
   aokdelnr = 0
   ksbenamn = "".   
   FIND FIRST ktotemp WHERE ktotemp.KONTO = tempkonto AND
       ktotemp.KONTONR = tempkontonr AND ktotemp.VIJUDID = tempjurp NO-ERROR.
   IF NOT AVAILABLE ktotemp THEN DO:
      felmedd = "Hittade ingen ktotemp för konto " + tempkonto +
         " med kod " + tempkontonr + "!".
      RETURN.
   END.
   /*konto jurp*/
   IF Guru.Konstanter:varforetypval[18] = 1 THEN DO:   
      IF ktotemp.KONTO = "K1" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K1 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K2" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K2 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K3" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K3 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K4" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K4 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.
      ELSE IF ktotemp.KONTO = "K5" THEN DO:
         OPEN QUERY aq FOR EACH AONRKONTKOD WHERE AONRKONTKOD.K5 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK,
         EACH AONRTAB WHERE AONRTAB.AONR = AONRKONTKOD.AONR AND
         AONRTAB.DELNR = AONRKONTKOD.DELNR NO-LOCK,
         EACH OMRADETAB WHERE OMRADETAB.OMRADE = AONRTAB.OMRADE NO-LOCK,
         EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
         EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
         AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
      END.      
      GET FIRST aq NO-LOCK.
      IF AVAILABLE AONRKONTKOD THEN DO:            
         ASSIGN
         aokaonr = AONRKONTKOD.AONR
         aokdelnr = AONRKONTKOD.DELNR. 
      END.              
      ELSE DO:      
         IF ktotemp.KONTO = "K1" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K1 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K2" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K2 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K3" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K3 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K4" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K4 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         ELSE IF ktotemp.KONTO = "K5" THEN DO:         
            OPEN QUERY ksq FOR EACH KONTOSTRANG WHERE KONTOSTRANG.K5 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK,           
            EACH OMRADETAB WHERE OMRADETAB.OMRADE = KONTOSTRANG.OMRADE NO-LOCK,
            EACH AVDELNING WHERE AVDELNING.AVDELNINGNR = OMRADETAB.AVDELNINGNR NO-LOCK,
            EACH JURPERS WHERE JURPERS.JUDID = ktotemp.JUDID
            AND JURPERS.JUDID = AVDELNING.POSTANST NO-LOCK.
         END.
         GET FIRST ksq NO-LOCK.
         IF AVAILABLE KONTOSTRANG THEN DO:            
            ksbenamn = KONTOSTRANG.BENAMNING.      
         END.     
      END.
      CLOSE QUERY aq.
      CLOSE QUERY ksq.
   END.
   ELSE DO:
      IF ktotemp.KONTO = "K1" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K1 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K2" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K2 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K3" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K3 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K4" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K4 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      ELSE IF ktotemp.KONTO = "K5" THEN DO:         
         FIND FIRST AONRKONTKOD WHERE AONRKONTKOD.K5 = ktotemp.KONTONR  
         USE-INDEX K1K2K3K4K5 NO-LOCK NO-ERROR.
      END.
      IF AVAILABLE AONRKONTKOD THEN DO:
         ASSIGN
         aokaonr = AONRKONTKOD.AONR
         aokdelnr = AONRKONTKOD.DELNR.         
      END.
      ELSE DO:
         IF ktotemp.KONTO = "K1" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K1 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K2" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K2 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K3" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K3 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K4" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K4 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         ELSE IF ktotemp.KONTO = "K5" THEN DO:         
            FIND FIRST KONTOSTRANG WHERE KONTOSTRANG.K5 = ktotemp.KONTONR  
            USE-INDEX KONTO NO-LOCK NO-ERROR.  
         END.
         IF AVAILABLE KONTOSTRANG THEN DO:
            ksbenamn = KONTOSTRANG.BENAMNING.            
         END.
      END.    
   END.         
   IF aokaonr NE "" THEN DO:
      felmedd = "KONTO " + ktotemp.KONTO + " finns upplagd på aonr " + 
         aokaonr + STRING(aokdelnr,Guru.Konstanter:varforetypchar[1]) + " och kan ej tas bort.".       
   END.
   ELSE IF ksbenamn NE "" THEN DO:
      felmedd = "KONTO " + ktotemp.KONTO + " finns upplagd på kontosträng " +
         ksbenamn + " och kan ej tas bort.".      
   END.
   ELSE DO TRANSACTION:
      FIND FIRST KONTO WHERE KONTO.KONTO = tempkonto AND
         KONTO.KONTONR = tempkontonr EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE KONTO THEN DO:
         DELETE KONTO.                  
      END.
   END.
END.


PROCEDURE kbjurhamt_UI:
   DEFINE INPUT PARAMETER globforetagvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR kbtemp.
   DEFINE OUTPUT PARAMETER TABLE FOR jurtemp.
   EMPTY TEMP-TABLE jurtemp NO-ERROR. 
   EMPTY TEMP-TABLE kbtemp NO-ERROR. 
   FIND FIRST KBENAMNING USE-INDEX KBEN NO-LOCK NO-ERROR.
   CREATE kbtemp.
   ASSIGN
   kbtemp.K1 = KBENAMNING.K1
   kbtemp.K2 = KBENAMNING.K2
   kbtemp.K3 = KBENAMNING.K3
   kbtemp.K4 = KBENAMNING.K4
   kbtemp.K5 = KBENAMNING.K5.
    /*konto jurp*/
   IF Guru.Konstanter:varforetypval[18] = 1 THEN DO:   
      FOR EACH JURPERS NO-LOCK:
        CREATE jurtemp.
        ASSIGN
        jurtemp.NAMN = JURPERS.NAMN
        jurtemp.JUDID = JURPERS.JUDID
        jurtemp.VIJUDID = JURPERS.VIJUDID.
      END.
   END.
   ELSE DO:
      CREATE jurtemp.
      ASSIGN
      jurtemp.JUDID = ""
      jurtemp.VIJUDID = "".
   END.
END PROCEDURE.

PROCEDURE kbhmt_UI:
   DEFINE INPUT PARAMETER globforetagvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR kbtemp.
   EMPTY TEMP-TABLE kbtemp NO-ERROR. 
   FIND FIRST KBENAMNING USE-INDEX KBEN NO-LOCK NO-ERROR.
   CREATE kbtemp.
   ASSIGN
   kbtemp.K1 = KBENAMNING.K1
   kbtemp.K2 = KBENAMNING.K2
   kbtemp.K3 = KBENAMNING.K3
   kbtemp.K4 = KBENAMNING.K4
   kbtemp.K5 = KBENAMNING.K5.
  
END PROCEDURE.


PROCEDURE jurhmt_UI:
   DEFINE INPUT  PARAMETER vem AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER globforetagVAR AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR jurtemp.
   EMPTY TEMP-TABLE jurtemp NO-ERROR. 
   /*konto jurp*/
   
   IF Guru.Konstanter:varforetypval[18] = 1 THEN DO:
      IF globanv = CHR(69) + CHR(76) + CHR(80) + CHR(65) + CHR(79) THEN DO:
         FOR EACH JURPERS  NO-LOCK:
            CREATE jurtemp.
            ASSIGN
            jurtemp.NAMN = JURPERS.NAMN
            jurtemp.JUDID = JURPERS.JUDID
            jurtemp.VIJUDID = JURPERS.VIJUDID.
         END.
      END.
      ELSE DO:           
         FOR EACH BOLAGSEK WHERE BOLAGSEK.ANVANDARE = vem NO-LOCK:
            FOR EACH JURPERS WHERE JURPERS.JUDID = BOLAGSEK.OMRADE NO-LOCK:
               CREATE jurtemp.
               ASSIGN
               jurtemp.NAMN = JURPERS.NAMN
               jurtemp.JUDID = JURPERS.JUDID
               jurtemp.VIJUDID = JURPERS.VIJUDID.
            END.  
         END.
      END.   
   END.
   ELSE DO:
      CREATE jurtemp.
      ASSIGN
      jurtemp.JUDID = ""
      jurtemp.VIJUDID = "".
   END.
END PROCEDURE.



PROCEDURE ktohamt_UI:
   DEFINE INPUT PARAMETER globforetagVAR AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR ktotemp.
   EMPTY TEMP-TABLE ktotemp NO-ERROR. 
   OPEN QUERY till FOR EACH KONTO /*WHERE KONTO.AKTIV = TRUE*/ NO-LOCK.
   GET FIRST till NO-LOCK.
   DO WHILE AVAILABLE(KONTO):
      CREATE ktotemp.
      ASSIGN
      ktotemp.KONTO = KONTO.KONTO
      ktotemp.KONTONR = KONTO.KONTONR
      ktotemp.BENAMNING = KONTO.BENAMNING
      ktotemp.JUDID = KONTO.JUDID
      ktotemp.OMRADE = KONTO.OMRADE
      ktotemp.AVDELNINGNR = KONTO.AVDELNINGNR
      ktotemp.AKTIV = KONTO.AKTIV
      ktotemp.RECTIDVIS = RECID(KONTO).
      /*konto jurp*/
      IF Guru.Konstanter:varforetypval[18] = 1 THEN DO:   
         FIND FIRST JURPERS WHERE JURPERS.JUDID = KONTO.JUDID NO-LOCK NO-ERROR.
         IF AVAILABLE JURPERS THEN DO:
            ASSIGN ktotemp.VIJUDID = JURPERS.VIJUDID.
         END.
      END.
      GET NEXT till NO-LOCK.
   END.
   CLOSE QUERY till.
END.

