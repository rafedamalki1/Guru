DEFINE TEMP-TABLE sats_mtrl
   FIELD KOD AS CHARACTER
   FIELD ENR AS CHARACTER 
   FIELD BENAMNING AS CHARACTER LABEL "Benämning"
   FIELD ENHET AS CHARACTER LABEL "Enhet" 
   FIELD ANTAL AS INTEGER LABEL "Antal"
   FIELD PRIS AS DECIMAL LABEL "Pris"
   FIELD LEVKOD AS CHARACTER.
DEFINE BUFFER mbbuff FOR MTRLBER.
FOR EACH MTRLBER WHERE MTRLBER.ENR = "993014015"   EXCLUSIVE-LOCK:
   
   RUN ersats_UI (INPUT MTRLBER.ENR,INPUT mtrlber.levkod).   
   DELETE MTRLBER.   
END.
PROCEDURE ersats_UI:
   DEFINE INPUT PARAMETER sparkod AS CHARACTER NO-UNDO.
   DEFINE INPUT PARAMETER vald_lev AS CHARACTER NO-UNDO.
   OPEN QUERY skapq FOR EACH SATS WHERE SATS.KOD = sparkod AND
   SATS.LEVKOD = vald_lev AND SATS.SATS = FALSE USE-INDEX KOD NO-LOCK.
   GET FIRST skapq NO-LOCK.
   DO WHILE AVAILABLE(SATS):
      FIND FIRST MTRL WHERE MTRL.levkod = sats.levkod AND MTRL.enr = sats.enr2 NO-LOCK NO-ERROR.
      IF AVAILABLE MTRL THEN DO:

         CREATE mbbuff.      
         BUFFER-COPY mtrlber TO mbbuff.
         ASSIGN               
         mbbuff.ENR = SATS.ENR2 
         mbbuff.BENAMNING = MTRL.BENAMNING 
         mbbuff.ENHET = MTRL.ENHET 
         mbbuff.ANTAL = SATS.ANTAL 
         mbbuff.PRIS = MTRL.NPRIS 
         mbbuff.LEVKOD = SATS.LEVKOD
         mbbuff.SATS = FALSE.
      END.
      GET NEXT skapq NO-LOCK.
   END.
   CLOSE QUERY skapq.
END.
   /*OPEN QUERY skapq FOR EACH SATS WHERE SATS.KOD = sparkod AND
   SATS.LEVKOD = vald_lev AND SATS.SATS = FALSE USE-INDEX KOD NO-LOCK.
   GET FIRST skapq NO-LOCK.
   DO WHILE AVAILABLE(SATS):
      CREATE sats_mtrl.
      ASSIGN         
      sats_mtrl.KOD = SATS.KOD
      sats_mtrl.ENR = SATS.ENR2 
      sats_mtrl.BENAMNING = SATS.BENAMNING2 
      sats_mtrl.ENHET = SATS.ENHET2 
      sats_mtrl.ANTAL = SATS.ANTAL 
      sats_mtrl.PRIS = SATS.PRIS2 
      sats_mtrl.LEVKOD = SATS.LEVKOD.
      GET NEXT skapq NO-LOCK.
   END.
   CLOSE QUERY skapq.*/
