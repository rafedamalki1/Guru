/*OTOLKPR.P   */ 
&Scoped-define NEW 
{TIDALLT.I}
/*DEFINE SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.*/

DEFINE SHARED VARIABLE persrec AS RECID  NO-UNDO.
DEFINE SHARED VARIABLE tidtabrec AS RECID NO-UNDO.
DEFINE SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE SHARED VARIABLE sekunder AS INTEGER NO-UNDO.
DEFINE SHARED VARIABLE bustart3 LIKE TIDREGITAB.START NO-UNDO.
DEFINE SHARED VARIABLE regstartsek AS INTEGER NO-UNDO.
DEFINE SHARED VARIABLE regslutsek AS INTEGER NO-UNDO.
DEFINE SHARED VARIABLE regstart LIKE TIDREGITAB.START NO-UNDO.  
DEFINE SHARED VARIABLE regslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE SHARED VARIABLE lunchstarten AS DECIMAL NO-UNDO.
DEFINE SHARED VARIABLE lunchslutet AS DECIMAL NO-UNDO.
DEFINE SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE SHARED VARIABLE avdatum AS DATE NO-UNDO.
DEFINE SHARED VARIABLE bdatum AS DATE NO-UNDO.
DEFINE SHARED VARIABLE bilforare AS LOGICAL FORMAT "JA/NEJ" NO-UNDO.
DEFINE NEW SHARED VARIABLE reco AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE reco2 AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE sto1 LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE sto2 LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE sto4 LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE sta1 LIKE TIDREGITAB.START NO-UNDO.
DEFINE NEW SHARED VARIABLE sta2 LIKE TIDREGITAB.START NO-UNDO.
DEFINE NEW SHARED VARIABLE sta3 LIKE TIDREGITAB.START NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi1 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi2 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi3 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi4 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi5 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddi6 LIKE TIDREGITAB.OANT1 NO-UNDO. 
DEFINE NEW SHARED VARIABLE slut2 LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE slut4 AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE start4 AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE start5 AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE slut5 AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE bstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE NEW SHARED VARIABLE bslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE avstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE NEW SHARED VARIABLE avslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE midnatt LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE stop1 LIKE OVERTIDTAB.STOPP1 NO-UNDO.
DEFINE NEW SHARED VARIABLE stop2 LIKE OVERTIDTAB.STOPP1 NO-UNDO.
DEFINE NEW SHARED VARIABLE stop3 LIKE OVERTIDTAB.STOPP1 NO-UNDO.
DEFINE NEW SHARED VARIABLE stop4 LIKE OVERTIDTAB.STOPP1 NO-UNDO.
DEFINE NEW SHARED VARIABLE starta1 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE starta2 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE starta3 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE kod1 LIKE OVERTIDTAB.OVERTIDTILL NO-UNDO.
DEFINE NEW SHARED VARIABLE kod2 LIKE OVERTIDTAB.OVERTIDTILL NO-UNDO.
DEFINE NEW SHARED VARIABLE kod3 LIKE OVERTIDTAB.OVERTIDTILL NO-UNDO.
DEFINE NEW SHARED VARIABLE kod4 LIKE OVERTIDTAB.OVERTIDTILL NO-UNDO.
DEFINE NEW SHARED VARIABLE kod5 LIKE OVERTIDTAB.OVERTIDTILL NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff1 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff2 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff3 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff4 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff5 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE tiddiff6 LIKE OVERTIDTAB.START1 NO-UNDO.
DEFINE NEW SHARED VARIABLE komp LIKE OVERTIDTAB.OVERTIDUTTAG NO-UNDO.  
DEFINE NEW SHARED VARIABLE komp1 LIKE OVERTIDTAB.OVERTIDUTTAG NO-UNDO.
DEFINE NEW SHARED VARIABLE verklig LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE verklig1 LIKE TIDREGITAB.OANT1 NO-UNDO.
DEFINE NEW SHARED VARIABLE onr LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE NEW SHARED VARIABLE sta AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE slu AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE avsta AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE avslu AS INTEGER NO-UNDO.
DEFINE VARIABLE lunchstarten2 AS INTEGER NO-UNDO.
DEFINE VARIABLE lunchslutet2 AS INTEGER NO-UNDO.
DEFINE VARIABLE helg AS LOGICAL NO-UNDO.
DEFINE VARIABLE utbch AS LOGICAL NO-UNDO.
DEFINE VARIABLE berfinns AS LOGICAL NO-UNDO.
DEFINE NEW SHARED TEMP-TABLE ovavtab
   FIELD KOD LIKE OVERAVTAB.KOD 
   FIELD OVERTIDTILL LIKE OVERAVTAB.OVERTIDTILL
   FIELD START1 LIKE OVERAVTAB.START1
   FIELD STOPP1 LIKE OVERAVTAB.STOPP1
   FIELD START2 LIKE OVERAVTAB.START2
   FIELD STOPP2 LIKE OVERAVTAB.STOPP2
   FIELD DATUM LIKE OVERAVTAB.DATUM
   FIELD OVERTIDUTTAG LIKE OVERAVTAB.OVERTIDUTTAG
   FIELD DAGEQ LIKE OVERAVTAB.DAGEQ
   FIELD EQDAG LIKE OVERAVTAB.EQDAG 
   INDEX ODATUM IS PRIMARY DATUM ASCENDING 
   INDEX OSTART1 KOD DATUM START1 STOPP1 ASCENDING
   INDEX OSTART2 KOD DATUM START2 STOPP2 ASCENDING.
DEFINE NEW SHARED TEMP-TABLE otidtab
   FIELD KOD LIKE OVERTIDTAB.KOD 
   FIELD OVERTIDTILL LIKE OVERTIDTAB.OVERTIDTILL
   FIELD START1 LIKE OVERTIDTAB.START1
   FIELD STOPP1 LIKE OVERTIDTAB.STOPP1
   FIELD START2 LIKE OVERTIDTAB.START2
   FIELD STOPP2 LIKE OVERTIDTAB.STOPP2
   FIELD DAGNR LIKE OVERTIDTAB.DAGNR
   FIELD OVERTIDUTTAG LIKE OVERTIDTAB.OVERTIDUTTAG
   FIELD FORKL LIKE OVERTIDTAB.FORKL
   FIELD ARBSLUT LIKE OVERTIDTAB.ARBSLUT
   FIELD ARBSTART LIKE OVERTIDTAB.ARBSTART
   INDEX OVERTILL IS PRIMARY DAGNR OVERTIDTILL ASCENDING    
   INDEX OVERT KOD DAGNR ARBSLUT ASCENDING   
   INDEX OVERSTART KOD DAGNR START1 STOPP1 ASCENDING 
   INDEX OVERKOD OVERTIDTILL ASCENDING
   INDEX OVER KOD DAGNR OVERTIDTILL OVERTIDUTTAG ASCENDING
   INDEX OSTART2 KOD DAGNR START2 STOPP2 ASCENDING.      
DEFINE QUERY ovavq FOR OVERAVTAB. 
DEFINE QUERY otidq FOR OVERTIDTAB.
DEFINE BUFFER otab FOR otidtab.
DEFINE BUFFER otab2 FOR otidtab.
DEFINE BUFFER otab3 FOR otidtab.
DEFINE BUFFER oavtab FOR ovavtab.
DEFINE BUFFER tidbuff FOR TIDREGITAB.
DEFINE VARIABLE htim AS INTEGER NO-UNDO.
DEFINE VARIABLE start8 AS INTEGER NO-UNDO.
DEFINE VARIABLE slut8 AS INTEGER NO-UNDO.
DEFINE VARIABLE startar AS INTEGER NO-UNDO.
DEFINE VARIABLE seku AS INTEGER NO-UNDO.
DEFINE VARIABLE slut3 AS INTEGER NO-UNDO.
DEFINE VARIABLE hjdygn AS INTEGER NO-UNDO.
DEFINE VARIABLE hjstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE halvupp AS LOGICAL NO-UNDO.
DEFINE VARIABLE energiavt AS LOGICAL NO-UNDO.
DEFINE VARIABLE anstkod LIKE ANSTFORMTAB.KOD NO-UNDO.
DEFINE VARIABLE res LIKE AUTOMREG.PRISTYP NO-UNDO.
DEFINE VARIABLE hjdat AS DATE NO-UNDO.
DEFINE VARIABLE st4 AS INTEGER NO-UNDO.
DEFINE VARIABLE sl4 AS INTEGER NO-UNDO.
DEFINE VARIABLE spstart4 AS INTEGER NO-UNDO.
DEFINE VARIABLE spslut4 AS INTEGER NO-UNDO.
DEFINE VARIABLE kvkod AS CHARACTER NO-UNDO.
FUNCTION klock100 RETURNS DECIMAL
   ( INPUT ber60 AS DECIMAL ):
   RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.
END FUNCTION.

FUNCTION klock60 RETURNS DECIMAL
   ( INPUT ber100 AS DECIMAL ) :
   RETURN TRUNCATE(ber100,0) + ((ber100 - TRUNCATE(ber100,0)) * 60 / 100 ).   /* Function return value. */
END FUNCTION.

FIND PERSONALTAB WHERE RECID(PERSONALTAB) = persrec NO-LOCK NO-ERROR.
FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
USE-INDEX ANSTF NO-LOCK NO-ERROR.
anstkod = ANSTFORMTAB.KOD.
FIND FIRST ORDARB WHERE ORDARB.ANSTALLNING = ANSTFORMTAB.ANSTALLNING NO-LOCK NO-ERROR.
FIND FIRST UTRYCKNING WHERE UTRYCKNING.KOD = anstkod
USE-INDEX UT NO-LOCK NO-ERROR.     
IF PERSONALTAB.ANSTALLNING = "ENTREPRENÖR" THEN DO:
   RETURN.
END.
FIND FIRST AUTOMREG WHERE AUTOMREG.RESTIDREG = TRUE
USE-INDEX PRISTYPER NO-LOCK NO-ERROR.
energiavt = FALSE.

IF Guru.Konstanter:globforetag = "GKAL" THEN ASSIGN energiavt = TRUE.
IF (Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT"  OR Guru.Konstanter:globforetag = "MISV") THEN ASSIGN energiavt = TRUE.
IF Guru.Konstanter:globforetag = "LULE" THEN ASSIGN energiavt = TRUE.

halvupp = FALSE.



IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT"  OR Guru.Konstanter:globforetag = "MISV" THEN DO:
   /* aNSTÄLLNINGSFORM TO upplagd enbart för sommarövertid KFS avtal*/   
   IF ORDARB.OBKOD NE "" THEN DO:

      FIND FIRST FLEXREG NO-LOCK NO-ERROR.         
      IF AVAILABLE FLEXREG THEN DO:
         IF MONTH(regdatum) > MONTH(FLEXREG.SOMMARST) AND MONTH(regdatum) < MONTH(FLEXREG.SOMMARSL) THEN DO:
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TS" THEN anstkod = "TO".
            IF anstkod = "T1" THEN anstkod = "TT".   /*7-16 -7-15.30 korrigeras me .EXTID till 7.30-16 för tjänstemän?? Lena*/
            /*IF anstkod = "T1" THEN anstkod = "TO". /*alla t1 har 7.3-16 på sommaren /lena 2006-08-14*/*/
            IF anstkod = "K" THEN anstkod = "KO".
            IF anstkod = "T4" THEN anstkod = "T5".
            IF anstkod = "TU" THEN anstkod = "TV".            
            IF anstkod = "TX" THEN anstkod = "TY".            
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARSL) AND DAY(regdatum) <= DAY(FLEXREG.SOMMARSL) THEN DO:               
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TS" THEN anstkod = "TO".
            IF anstkod = "T1" THEN anstkod = "TT". /*7-16 -7-15.30 korrigeras me .EXTID till 7.30-16 för tjänstemän?? Lena*/
            /*IF anstkod = "T1" THEN anstkod = "TO".                                                        */
            IF anstkod = "K" THEN anstkod = "KO".
            IF anstkod = "T4" THEN anstkod = "T5".
            IF anstkod = "TU" THEN anstkod = "TV".
            IF anstkod = "TX" THEN anstkod = "TY".            
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARST) AND DAY(regdatum) >= DAY(FLEXREG.SOMMARST) THEN DO: 
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TS" THEN anstkod = "TO".
            IF anstkod = "T1" THEN anstkod = "TT".  /*7-16 -7-15.30 korrigeras me .EXTID till 7.30-16 för tjänstemän?? Lena*/
            /*IF anstkod = "T1" THEN anstkod = "TO". */
            IF anstkod = "K" THEN anstkod = "KO".
            IF anstkod = "T4" THEN anstkod = "T5".
            IF anstkod = "TU" THEN anstkod = "TV".
            IF anstkod = "TX" THEN anstkod = "TY".            
         END.
      END.
   END.
END.
IF Guru.Konstanter:globforetag = "LULE" THEN DO:
   /* aNSTÄLLNINGSFORM TO upplagd enbart för sommarövertid KFS avtal*/   
   IF ORDARB.OBKOD NE "" THEN DO:
      FIND FIRST FLEXREG NO-LOCK NO-ERROR.         
      IF AVAILABLE FLEXREG THEN DO:
         IF MONTH(regdatum) > MONTH(FLEXREG.SOMMARST) AND MONTH(regdatum) < MONTH(FLEXREG.SOMMARSL) THEN DO:
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TL" THEN anstkod = "TO".            
            IF anstkod = "TM" THEN anstkod = "TP".            
            IF anstkod = "KL" THEN anstkod = "KO".            
            IF anstkod = "KP" THEN anstkod = "KQ".            
            IF anstkod = "TR" THEN anstkod = "TS".            
            IF anstkod = "TT" THEN anstkod = "TU".            
            IF anstkod = "TV" THEN anstkod = "TX".            
            IF anstkod = "T1" THEN anstkod = "T2".            
            IF anstkod = "T6" THEN anstkod = "T7".
            IF anstkod = "E" THEN anstkod = "ES".            
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARSL) AND DAY(regdatum) <= DAY(FLEXREG.SOMMARSL) THEN DO:               
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TL" THEN anstkod = "TO".            
            IF anstkod = "TM" THEN anstkod = "TP".            
            IF anstkod = "KL" THEN anstkod = "KO".            
            IF anstkod = "KP" THEN anstkod = "KQ".            
            IF anstkod = "TR" THEN anstkod = "TS".            
            IF anstkod = "TT" THEN anstkod = "TU".            
            IF anstkod = "TV" THEN anstkod = "TX".            
            IF anstkod = "T1" THEN anstkod = "T2".   
            IF anstkod = "T6" THEN anstkod = "T7".
            IF anstkod = "E" THEN anstkod = "ES". 
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARST) AND DAY(regdatum) >= DAY(FLEXREG.SOMMARST) THEN DO: 
            /*obs om nytt schema läggs till här lägg också till i avtapp.p*/
            IF anstkod = "TL" THEN anstkod = "TO".            
            IF anstkod = "TM" THEN anstkod = "TP".            
            IF anstkod = "KL" THEN anstkod = "KO".            
            IF anstkod = "KP" THEN anstkod = "KQ".            
            IF anstkod = "TR" THEN anstkod = "TS".            
            IF anstkod = "TT" THEN anstkod = "TU".            
            IF anstkod = "TV" THEN anstkod = "TX".            
            IF anstkod = "T1" THEN anstkod = "T2".            
            IF anstkod = "T6" THEN anstkod = "T7".
            IF anstkod = "E" THEN anstkod = "ES". 
         END.
      END.
   END.
END.
OPEN QUERY ovavq FOR EACH OVERAVTAB WHERE OVERAVTAB.DATUM >= (regdatum - 3) AND
OVERAVTAB.DATUM <= (regdatum + 3)
AND OVERAVTAB.KOD = anstkod USE-INDEX ODATUM NO-LOCK.
GET FIRST ovavq NO-LOCK.
DO WHILE AVAILABLE(OVERAVTAB):
   DO TRANSACTION:
      CREATE ovavtab. 
      ASSIGN
      ovavtab.KOD = OVERAVTAB.KOD 
      ovavtab.OVERTIDTILL = OVERAVTAB.OVERTIDTILL
      ovavtab.START1 = OVERAVTAB.START1
      ovavtab.STOPP1 = OVERAVTAB.STOPP1
      ovavtab.START2 = OVERAVTAB.START2
      ovavtab.STOPP2 = OVERAVTAB.STOPP2
      ovavtab.DATUM = OVERAVTAB.DATUM
      ovavtab.OVERTIDUTTAG = OVERAVTAB.OVERTIDUTTAG
      ovavtab.DAGEQ = OVERAVTAB.DAGEQ
      ovavtab.EQDAG = OVERAVTAB.EQDAG. 
   END.
   GET NEXT ovavq NO-LOCK.
END.                      
CLOSE QUERY ovavq.
IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT"  OR Guru.Konstanter:globforetag = "MISV" THEN DO:
   FOR EACH ovavtab WHERE ovavtab.OVERTIDTILL = "4506":
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONAL = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.DATUM = regdatum AND TIDREGITAB.BEREDSKAP NE "" 
      AND (ovavtab.START1 / 3600)  GE TIDREGITAB.BEREDSKAPSTART   
      AND (ovavtab.START1 / 3600) <  TIDREGITAB.BEREDSKAPSLUT USE-INDEX PSTART NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO: 
         IF ovavtab.start1 = 43200 OR ovavtab.start1 = 45000 OR ovavtab.start1 = 46800 THEN ASSIGN ovavtab.OVERTIDTILL = "4371" .         
         ELSE ASSIGN ovavtab.OVERTIDTILL = "4372".
      END.
   END.
   FOR EACH ovavtab WHERE ovavtab.OVERTIDTILL = "4574":
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONAL = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.DATUM = regdatum AND TIDREGITAB.BEREDSKAP NE "" 
      AND (ovavtab.START1 / 3600)  GE TIDREGITAB.BEREDSKAPSTART
      AND (ovavtab.START1 / 3600) <  TIDREGITAB.BEREDSKAPSLUT USE-INDEX PSTART NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO: 
         IF ovavtab.start1 = 43200 OR ovavtab.start1 = 45000 OR ovavtab.start1 = 46800 THEN ASSIGN ovavtab.OVERTIDTILL = "4503" .         
         ELSE ASSIGN ovavtab.OVERTIDTILL = "4504".
         IF ovavtab.OVERTIDUTTAG = "Ö" THEN DO:
            /*SPECIAL FÖR KLÄMDAG SOM ENBART SKAL VARA I TID*/
            IF ovavtab.start1 = 43200 OR ovavtab.start1 = 45000 OR ovavtab.start1 = 46800 THEN ASSIGN ovavtab.OVERTIDTILL = "4371" .         
            ELSE ASSIGN ovavtab.OVERTIDTILL = "4372".
         END.
      END.
   END.
END.
OPEN QUERY otidq FOR EACH OVERTIDTAB WHERE OVERTIDTAB.DAGNR >= 1 AND
OVERTIDTAB.DAGNR <= 7 AND OVERTIDTAB.KOD = anstkod USE-INDEX OVERTILL NO-LOCK.
GET FIRST otidq NO-LOCK.
DO WHILE AVAILABLE(OVERTIDTAB):
   DO TRANSACTION:
      CREATE otidtab. 
      ASSIGN
      otidtab.KOD = OVERTIDTAB.KOD 
      otidtab.OVERTIDTILL = OVERTIDTAB.OVERTIDTILL
      otidtab.START1 = OVERTIDTAB.START1
      otidtab.STOPP1 = OVERTIDTAB.STOPP1
      otidtab.START2 = OVERTIDTAB.START2
      otidtab.STOPP2 = OVERTIDTAB.STOPP2
      otidtab.DAGNR = OVERTIDTAB.DAGNR
      otidtab.OVERTIDUTTAG = OVERTIDTAB.OVERTIDUTTAG
      otidtab.FORKL = OVERTIDTAB.FORKL
      otidtab.ARBSLUT = OVERTIDTAB.ARBSLUT
      otidtab.ARBSTART = OVERTIDTAB.ARBSTART.
   END.
   GET NEXT otidq NO-LOCK.
END.              
CLOSE QUERY otidq.
RUN REGVEC.P.
RUN SLUTARB.P.
res = AUTOMREG.PRISTYP.
IF bilforare = TRUE THEN  res = ' '.
slut2 = klock60(klock100(regslut) + (UTRYCKNING.EXTRAARBPASS / 3600)).
nytid = regslut.
RUN TIMSEK.P.
ASSIGN
slut5 = sekunder.
nytid = regstart.
RUN TIMSEK.P.
ASSIGN
start5 = sekunder
start8 = 25200
slut8 = 57600.
IF Guru.Konstanter:globforetag = "GKAL" THEN DO:
   IF regstart = regslut THEN DO:
      IF WEEKDAY(regdatum) = 1 OR WEEKDAY(regdatum) = 7 THEN.      
      ELSE DO:
         FOR EACH otidtab WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.OVERTIDTILL = "213"   EXCLUSIVE-LOCK:
           ASSIGN otidtab.OVERTIDTILL = "214".
         END.
         FOR EACH otidtab WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.OVERTIDTILL = "231"   EXCLUSIVE-LOCK:
           ASSIGN otidtab.OVERTIDTILL = "233".
         END.         
      END.
   END.
END.
FIND FIRST ORDARB WHERE ORDARB.ANSTALLNING = ANSTFORMTAB.ANSTALLNING NO-LOCK NO-ERROR.
IF AVAILABLE  ORDARB THEN DO:
   IF ORDARB.OBKOD NE "" THEN DO:
      IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT"   OR Guru.Konstanter:globforetag = "MISV" THEN DO: 
         FIND FIRST FLEXAVT WHERE FLEXAVT.PERSONALKOD = PERSONALTAB.PERSONALKOD NO-LOCK NO-ERROR.
         FIND FIRST FLEXREG WHERE FLEXREG.KOD = FLEXAVT.FLEXKOD USE-INDEX FLEX NO-LOCK NO-ERROR.           
         IF NOT AVAILABLE FLEXREG THEN DO:
            FIND FIRST FLEXREG WHERE FLEXREG.KOD = "" NO-LOCK NO-ERROR.
            /*tillägg för dem som inte har flextid men sommartid*/
         END.      
      END.
      ELSE DO:      
         FIND FIRST FLEXREG WHERE FLEXREG.KOD = anstkod NO-LOCK NO-ERROR.
         IF NOT AVAILABLE FLEXREG THEN DO:
            FIND FIRST FLEXREG WHERE FLEXREG.KOD = "" NO-LOCK NO-ERROR.
         END.      
      END.
      IF AVAILABLE FLEXREG THEN DO:
         IF MONTH(regdatum) > MONTH(FLEXREG.SOMMARST) AND MONTH(regdatum) < MONTH(FLEXREG.SOMMARSL) THEN DO:
            ASSIGN nytid = DECIMAL(ORDARB.OBKOD).   
            RUN TIMSEK.P.
            slut8 = sekunder.            
            IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TT" THEN start8 = ORDARB.START1.            
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TV" THEN start8 = ORDARB.START1.                        
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.                                    
            ELSE IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.                        
            ELSE IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.                        
            ELSE start8 = ORDARB.START1.
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARSL) AND DAY(regdatum) <= DAY(FLEXREG.SOMMARSL) THEN DO:
            ASSIGN nytid = DECIMAL(ORDARB.OBKOD).
            RUN TIMSEK.P.
            slut8 = sekunder.
            IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TT" THEN start8 = ORDARB.START1.            
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TV" THEN start8 = ORDARB.START1.            
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.                       
            ELSE IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.            
            ELSE IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.            
            ELSE start8 = ORDARB.START1.
         END.
         ELSE IF MONTH(regdatum) = MONTH(FLEXREG.SOMMARST) AND DAY(regdatum) >= DAY(FLEXREG.SOMMARST) THEN DO: 
            ASSIGN nytid = DECIMAL(ORDARB.OBKOD).
            RUN TIMSEK.P.
            slut8 = sekunder.
            IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TT" THEN start8 = ORDARB.START1.            
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND anstkod = "TV" THEN start8 = ORDARB.START1.            
            ELSE IF Guru.Konstanter:globforetag = "SUND" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.                        
            ELSE IF Guru.Konstanter:globforetag = "SNAT" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.            
            ELSE IF Guru.Konstanter:globforetag = "MISV" AND FLEXREG.KOD BEGINS "T" THEN start8 = 27000.            
            ELSE start8 = ORDARB.START1.
         END.
         ELSE DO:
            ASSIGN  
            start8 = ORDARB.START1
            slut8 = ORDARB.STOPP1.            
         END.
      END. 
      ELSE DO:
         ASSIGN  
         start8 = ORDARB.START1
         slut8 = ORDARB.STOPP1.         
      END.  
   END.
   ELSE DO:
      ASSIGN  
      start8 = ORDARB.START1
      slut8 = ORDARB.STOPP1.      
   END.   
END.  
IF start8 = 0 AND slut8 = 0 THEN DO:   /*FJÄRRVÄRME SOLLEFTEÅ*/
   ASSIGN
   start8 = 25200
   slut8 = 57600.
END.
IF Guru.Konstanter:globforetag = "GKAL" AND ANSTFORMTAB.KOD = "TJ" THEN DO:
   ASSIGN   
   start8 = ORDARB.START1
   slut8 = ORDARB.STOPP1.              
END.

ASSIGN slut4 = 0 start4 = 0.
IF UTRYCKNING.EXTID = TRUE THEN DO:
   /*sundsvall t1-tt 7-16 7-15.3 blir även 7.30-16 via korrigering*/
   IF regstart = regslut THEN  slut4 = 0.
   ELSE slut4 = slut5 - slut8.           
   IF PERSONALTAB.DELTID = TRUE THEN DO:
      /* förskjut inte enkel arbetstid för deltidare */
      IF start5 = 25200 AND slut5 = 55800 THEN.
      ELSE IF start5 = 27000 AND slut5 = 57600 THEN.
      ELSE slut4= 0.
   END.   
END.
IF UTRYCKNING.EXAKTM = TRUE THEN DO:
   /*sundsvall t1-tt 7-16 7-15.3 blir även 7.30-16 via korrigering*/
   IF regstart = regslut THEN  start4 = 0.
   ELSE start4 = start5 - start8.     /*25200*/
END.
FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum NO-LOCK NO-ERROR.
IF AVAILABLE ovavtab AND ovavtab.DAGEQ = "HAL"  THEN slut4 = 0.
IF AVAILABLE ovavtab AND ovavtab.DAGEQ = "VAL"  THEN slut4 = 0.
IF energiavt = TRUE THEN.
ELSE DO:
   IF regstart = 14 AND regslut = 22 THEN start4 = 0.      
END.
IF WEEKDAY(regdatum) = 1 OR WEEKDAY(regdatum) = 7 THEN DO:
   ASSIGN start4 = 0 slut4 = 0.
END.
hjdat = regdatum.
RUN skift_UI.
IF energiavt = TRUE THEN ASSIGN halvupp = TRUE.

ASSIGN tiddiff1 = 0 tiddiff2 = 0 tiddiff3 = 0 tiddiff4 = 0 tiddiff5 = 0 
tiddiff6 = 0
starta1 = 0 starta2 = 0 starta3 = 0 stop1 = 0 stop2 = 0 stop4 = 0 komp1 = "".
FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
TIDREGITAB.DATUM = regdatum AND TIDREGITAB.OVERAUTO = FALSE AND
TIDREGITAB.OKOD1 NE "" USE-INDEX PSTART NO-LOCK NO-ERROR.
IF NOT AVAILABLE TIDREGITAB THEN DO:
   /*INGA MANUELLA*/
   DO TRANSACTION:
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
      TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START = bustart3 AND
      TIDREGITAB.TIDLOG = TRUE  
      USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE TIDREGITAB THEN RETURN.
      IF TIDREGITAB.PRISTYP = res THEN DO:
         FIND NEXT TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
         TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START = bustart3 AND
         TIDREGITAB.TIDLOG = TRUE  
         USE-INDEX PSTART EXCLUSIVE-LOCK NO-ERROR.
         IF NOT AVAILABLE TIDREGITAB THEN RETURN.
         IF TIDREGITAB.PRISTYP = res THEN RETURN.
      END.         
                
      /*NYTT AVTAL 20220101  MITTSVERIGE*/          
      IF Guru.Konstanter:globforetag = "MISV" THEN DO:
         halvupp = FALSE.
         berfinns = FALSE.         
         FIND FIRST tidbuff WHERE tidbuff.PERSONAL = TIDREGITAB.PERSONALKOD AND
         tidbuff.DATUM = TIDREGITAB.DATUM  AND tidbuff.BEREDSKAP NE "" 
         AND tidbuff.BEREDSKAPSTART LE TIDREGITAB.START 
         AND tidbuff.BEREDSKAPSLUT GE TIDREGITAB.START USE-INDEX PSTART NO-LOCK NO-ERROR.         
         IF AVAILABLE tidbuff THEN berfinns = TRUE.
         ELSE DO:
            FIND FIRST tidbuff WHERE tidbuff.PERSONAL = TIDREGITAB.PERSONALKOD AND
            tidbuff.DATUM = TIDREGITAB.DATUM  AND tidbuff.BEREDSKAP NE "" 
            AND tidbuff.BEREDSKAPSTART LE TIDREGITAB.SLUT 
            AND tidbuff.BEREDSKAPSLUT GE TIDREGITAB.SLUT USE-INDEX PSTART NO-LOCK NO-ERROR.         
            IF AVAILABLE tidbuff THEN berfinns = TRUE.
         END.            
         IF berfinns = TRUE THEN DO:               
            IF TIDREGITAB.START GE 22 OR TIDREGITAB.START < 6 THEN halvupp = TRUE.
            IF TIDREGITAB.SLUT > 22 OR TIDREGITAB.SLUT LE 6 THEN halvupp = TRUE.            
         END.   
      END.    
      
      
      IF bustart3 GE regstart AND TIDREGITAB.SLUT LE regslut THEN DO: 
         IF regstart = 0 AND regslut = 24 THEN DO:
            IF bustart3 GE lunchstarten  AND TIDREGITAB.SLUT LE lunchslutet THEN bustart3 = bustart3.
            ELSE RETURN.
         END.
         ELSE RETURN.
      END.
      IF TIDREGITAB.OVERTIDUTTAG = 'I' THEN  DO:
         ASSIGN TIDREGITAB.OANT1 = 0 
         TIDREGITAB.OANT2 = 0
         TIDREGITAB.OANT3 = 0
         TIDREGITAB.OST1 = 0 TIDREGITAB.OSL1 = 0  
         TIDREGITAB.OST2 = 0 TIDREGITAB.OSL2 = 0
         TIDREGITAB.OST3 = 0 TIDREGITAB.OSL3 = 0        
         TIDREGITAB.OKOD1 = "" TIDREGITAB.OKOD2= "" TIDREGITAB.OKOD3 = ' '
         bdatum = TIDREGITAB.DATUM.
         RETURN.
      END.   
      IF TIDREGITAB.ENFLERDAGS = "Endag" AND bilforare = FALSE THEN RETURN. 
      IF TIDREGITAB.ENFLERDAGS = "Flerdag" AND bilforare = FALSE THEN RETURN.
      IF TIDREGITAB.OVERTIDUTTAG = 'F' THEN DO:
         ASSIGN TIDREGITAB.OANT1 = 0 
         TIDREGITAB.OANT2 = 0
         TIDREGITAB.OANT3 = 0
         TIDREGITAB.OST1 = 0 TIDREGITAB.OSL1 = 0  
         TIDREGITAB.OST2 = 0 TIDREGITAB.OSL2 = 0
         TIDREGITAB.OST3 = 0 TIDREGITAB.OSL3 = 0
         TIDREGITAB.OKOD1 = "" TIDREGITAB.OKOD2= "" TIDREGITAB.OKOD3 = ' '
         bdatum = TIDREGITAB.DATUM.   
         RETURN.
      END.       
      IF TIDREGITAB.START = 00.00 THEN DO:
         /* OM SISTA REG R 00.00 */
         ASSIGN 
         reco = RECID(TIDREGITAB) 
         bstart = TIDREGITAB.START 
         bslut = TIDREGITAB.SLUT 
         bdatum = TIDREGITAB.DATUM 
         komp = TIDREGITAB.OVERTIDUTTAG.
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT"  THEN DO:            
            RUN utb_UI.    
         END.
         IF Guru.Konstanter:globforetag = "MISV" THEN DO:
             IF  TIDREGITAB.AONR = "181016" OR TIDREGITAB.AONR = "181017" OR TIDREGITAB.AONR = "181018" OR TIDREGITAB.AONR = "181019" OR TIDREGITAB.AONR = "181020"   THEN DO:             
                IF komp = "Ö" THEN ASSIGN komp = "M".
                IF komp = "K"  THEN ASSIGN komp = "N".                
             END.
         END.
         IF Guru.Konstanter:globforetag = "GRAN" THEN DO:
             IF  TIDREGITAB.AONR = "141651" THEN DO:             
                 IF komp = "K" OR komp = "Ö" THEN ASSIGN komp = "M".
             END.
         END.
         IF Guru.Konstanter:globforetag = "GKAL" THEN DO:
             IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "251" THEN DO:                
                IF komp = "Ö" THEN ASSIGN komp = "M".
                IF komp = "K"  THEN ASSIGN komp = "N".
             END.
         END.
         IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:            
             IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "251" OR TIDREGITAB.AONR = "281" THEN DO:                 
                /* övertid ledig dag , mertid utanför ordinarie arbetstid de dagar man jobbar*/
                if regstart = regslut  THEN.                
                ELSE DO:                  
                   IF komp = "Ö" THEN ASSIGN komp = "M".
                   IF komp = "K"  THEN ASSIGN komp = "N".
                END.
             END.
             IF  TIDREGITAB.AONR = "875" AND TIDREGITAB.DELNR = 1 THEN DO:                 
                /* FRISKVÅRD SKIFTPERSONAL*/
                if regstart = regslut  THEN.                
                ELSE DO:                  
                   IF komp = "Ö" THEN ASSIGN komp = "M".
                   IF komp = "K"  THEN ASSIGN komp = "N".
                END.
             END.

         END.
         IF komp = "O" THEN ASSIGN komp = "Ö".
         FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD =
         PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM = (regdatum - 1) AND
         TIDREGITAB.TIDLOG = TRUE AND 
         TIDREGITAB.OVERAUTO = TRUE USE-INDEX PSTART NO-LOCK NO-ERROR.
         IF NOT AVAILABLE TIDREGITAB THEN regdatum = regdatum.
         ELSE IF TIDREGITAB.PRISTYP = res THEN regdatum = regdatum.
         ELSE IF TIDREGITAB.SLUT = 24.00 THEN DO:
            ASSIGN  regdatum = TIDREGITAB.DATUM.
            ASSIGN regvnr = TIDREGITAB.VECKONUMMER.
            RUN SLUTARB.P.                                  
            IF regslut = 24 THEN DO:
               /*arbetstid till 24 dagen innan- ejövertid*/
               regdatum = regdatum - 1.
               RUN REGVEC.P.

            END.
            ELSE DO:          
               ASSIGN
               midnatt = 24.00
               reco = RECID(TIDREGITAB)
                bstart = TIDREGITAB.START bslut = TIDREGITAB.SLUT
                komp1 = komp komp = TIDREGITAB.OVERTIDUTTAG
                bdatum = TIDREGITAB.DATUM.
                IF komp = "O" THEN ASSIGN komp = "Ö".
                IF komp1 = "O" THEN ASSIGN komp1 = "Ö".
                IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" THEN DO:
                   RUN utb_UI.                   
                END.    
                IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
                   IF  TIDREGITAB.AONR = "181016" OR TIDREGITAB.AONR = "181017" OR TIDREGITAB.AONR = "181018" OR TIDREGITAB.AONR = "181019" OR TIDREGITAB.AONR = "181020"   THEN DO:             
                      IF komp = "Ö" THEN ASSIGN komp = "M".
                      IF komp = "K"  THEN ASSIGN komp = "N".
                   END.
                END.    
                IF Guru.Konstanter:globforetag = "GRAN" THEN DO:
                   IF  TIDREGITAB.AONR = "141651" THEN DO:
                      IF komp = "K" OR komp = "Ö" THEN ASSIGN komp = "M".
                    END.
                END.
                IF Guru.Konstanter:globforetag = "GKAL" THEN DO:
                   IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "251" THEN DO:                   
                      IF komp = "Ö" THEN ASSIGN komp = "M".
                      IF komp = "K"  THEN ASSIGN komp = "N".
                   END.
                END.
                IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
                   IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "251" OR TIDREGITAB.AONR = "281" THEN DO:                   
                      /* övertid ledig dag , mertid utanför ordinarie arbetstid de dagar man jobbar*/
                      if regstart = regslut  THEN.                
                      ELSE DO:                  
                         IF komp = "Ö" THEN ASSIGN komp = "M".
                         IF komp = "K"  THEN ASSIGN komp = "N".
                      END.
                   END.
                   IF  TIDREGITAB.AONR = "875" AND TIDREGITAB.DELNR = 1 THEN DO:                 
                      /* FRISKVÅRD SKIFTPERSONAL*/
                      if regstart = regslut  THEN.                
                      ELSE DO:                  
                         IF komp = "Ö" THEN ASSIGN komp = "M".
                         IF komp = "K"  THEN ASSIGN komp = "N".
                      END.
                   END.
                END.
                REPEAT:
                   FIND PREV TIDREGITAB WHERE TIDREGITAB.PERSONALKOD =
                   PERSONALTAB.PERSONALKOD USE-INDEX PSTART NO-LOCK NO-ERROR.
                   IF NOT AVAILABLE TIDREGITAB THEN LEAVE.               
                   IF TIDREGITAB.DATUM NE (regdatum - 1) THEN LEAVE. 
                   IF TIDREGITAB.PRISTYP = res THEN LEAVE.  
                   /*IF TIDREGITAB.TRAKTAMENTE = 0 THEN LEAVE.*/
                   IF TIDREGITAB.SLUT NE midnatt THEN LEAVE.
                   ASSIGN reco = RECID(TIDREGITAB) bstart = TIDREGITAB.START
                   bdatum = TIDREGITAB.DATUM midnatt = TIDREGITAB.SLUT.
                END.
                ASSIGN regvnr = TIDREGITAB.VECKONUMMER.
                RUN SLUTARB.P.                      
            END.
         END.
      END.
      ELSE DO:
         ASSIGN reco = RECID(TIDREGITAB) bstart = TIDREGITAB.START
         bslut = TIDREGITAB.SLUT komp = TIDREGITAB.OVERTIDUTTAG bdatum = TIDREGITAB.DATUM.
         IF komp = "O" THEN ASSIGN komp = "Ö".
         IF Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" THEN DO:
            RUN utb_UI.            
         END.
         IF  Guru.Konstanter:globforetag = "MISV" THEN DO:
            IF  TIDREGITAB.AONR = "181016" OR TIDREGITAB.AONR = "181017" OR TIDREGITAB.AONR = "181018" OR TIDREGITAB.AONR = "181019" OR TIDREGITAB.AONR = "181020"   THEN DO:             
               IF komp = "Ö" THEN ASSIGN komp = "M".
               IF komp = "K"  THEN ASSIGN komp = "N".
            END.
         END.    
         IF Guru.Konstanter:globforetag = "GRAN" THEN DO:
             IF  TIDREGITAB.AONR = "141651" THEN DO:
                 IF komp = "K" OR komp = "Ö" THEN ASSIGN komp = "M".
             END.
         END.
         IF Guru.Konstanter:globforetag = "GKAL" THEN DO:
             IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "251" THEN DO:
                 IF komp = "Ö" THEN ASSIGN komp = "M".
                 IF komp = "K"  THEN ASSIGN komp = "N".
             END.
         END.     
         IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "elpa" THEN DO:
            IF  TIDREGITAB.AONR = "250" OR TIDREGITAB.AONR = "281" THEN DO:
               /* övertid ledig dag , mertid utanför ordinarie arbetstid de dagar man jobbar*/
               IF regstart = regslut  THEN.                
               ELSE DO:                  
                  IF komp = "Ö" THEN ASSIGN komp = "M".
                  IF komp = "K"  THEN ASSIGN komp = "N".
               END.
            END.
            IF  TIDREGITAB.AONR = "875" AND TIDREGITAB.DELNR = 1 THEN DO:                 
                /* FRISKVÅRD SKIFTPERSONAL*/
                if regstart = regslut  THEN.                
                ELSE DO:                  
                   IF komp = "Ö" THEN ASSIGN komp = "M".
                   IF komp = "K"  THEN ASSIGN komp = "N".
                END.
             END.
         END.    
         IF TIDREGITAB.START GE regslut AND TIDREGITAB.START LE slut2 AND 
         regstart NE regslut AND UTRYCKNING.EXTRAARBPASS > 0 THEN DO:
             ASSIGN TIDREGITAB.UTRYCKNING = FALSE.                                     
         END.                              
      END. 
   END.   
   ASSIGN avstart = bstart avslut = bslut avdatum = bdatum.      
   IF bslut LE regstart AND regstart ne regslut THEN DO:      
      FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
      TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START NE regstart AND
      TIDREGITAB.SLUT LE regstart AND TIDREGITAB.TIDLOG = TRUE
      USE-INDEX PSTART NO-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:
         IF TIDREGITAB.PRISTYP = res THEN DO:
            regdatum = regdatum.        /*????*/   
            REPEAT:
               FIND PREV TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
               TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START NE regstart AND
               TIDREGITAB.SLUT LE regstart 
               USE-INDEX PSTART NO-LOCK NO-ERROR.
               IF NOT AVAILABLE TIDREGITAB THEN LEAVE.
               ELSE IF TIDREGITAB.PRISTYP = res THEN NEXT.      
               ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
               avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
            END.
         END.
         ELSE DO:
             ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
             avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
         END.
      END.
   END.
   ELSE DO:      
      IF regstart = regslut THEN DO:
         FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
         AND TIDREGITAB.DATUM = regdatum AND TIDREGITAB.TIDLOG = TRUE USE-INDEX PSTART NO-LOCK NO-ERROR.         
      END.
      ELSE DO:      
         FIND LAST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
         AND TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START NE regstart AND TIDREGITAB.TIDLOG = TRUE
         USE-INDEX PSTART NO-LOCK NO-ERROR.
      END.   
      IF NOT AVAILABLE TIDREGITAB THEN regdatum = regdatum.
      ELSE IF TIDREGITAB.PRISTYP = res THEN DO:           
         REPEAT:
            FIND PREV TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
            TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START NE regstart AND
            TIDREGITAB.SLUT LE regstart 
            USE-INDEX PSTART NO-LOCK NO-ERROR.
            IF NOT AVAILABLE TIDREGITAB THEN LEAVE.
            ELSE IF TIDREGITAB.PRISTYP = res THEN NEXT.      
            ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
            avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
         END.
      END.
      ELSE IF TIDREGITAB.SLUT = 24.00 THEN DO:          
          /*OM SISTA REG SLUTAR 24.00 */
          ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
          avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
          FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD =
          PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM = (regdatum + 1) 
           USE-INDEX PSTART NO-LOCK NO-ERROR.
          IF AVAILABLE TIDREGITAB THEN DO:                                           
             IF TIDREGITAB.PRISTYP = res THEN regdatum = regdatum.
             ELSE DO:
                ASSIGN regvnr = TIDREGITAB.VECKONUMMER regdatum = regdatum + 1.
                RUN SLUTARB.P.                
                regdatum = regdatum - 1.
             END.
             IF TIDREGITAB.START = 00.00 THEN DO:                
                ASSIGN midnatt = 00.00 reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
                   avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
             END. 
             IF TIDREGITAB.SLUT = 24.00 THEN DO:
                /*OM SISTA REG SLUTAR 24.00 */                
                ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
                avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
                FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD =
                PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM = (regdatum + 2) 
                USE-INDEX PSTART NO-LOCK NO-ERROR.
                IF AVAILABLE TIDREGITAB THEN DO:                              
                   IF TIDREGITAB.PRISTYP = res THEN regdatum = regdatum.
                   ELSE DO:
                      ASSIGN regvnr = TIDREGITAB.VECKONUMMER regdatum = regdatum + 2.
                      RUN SLUTARB.P.
                      regdatum = regdatum - 2.                      
                   END.                   
                   IF TIDREGITAB.START = 00.00 THEN DO:                      
                      ASSIGN midnatt = 00.00 reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
                      avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
                   END. 
                END.
             END.
          END.  
      END.
      ELSE DO:          
          ASSIGN reco2 = RECID(TIDREGITAB) avstart = TIDREGITAB.START
          avslut = TIDREGITAB.SLUT avdatum = TIDREGITAB.DATUM.
      END.
   END.         
   /* jamfor med overtidstabell  */   
   nytid = bstart.
   RUN TIMSEK.P.
   ASSIGN sta = sekunder nytid = bslut.
   RUN TIMSEK.P.
   ASSIGN slu = sekunder seku = slu - sta sekunder = seku.      
   RUN SEKTIM.P.
   verklig = nytid.   
   IF energiavt = TRUE THEN DO:  /*Om bara uppdelad tid ej jämna halvtimmar per reg*/      
      FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco NO-LOCK NO-ERROR.      
      IF TIDREGITAB.START > regslut OR TIDREGITAB.START < regstart THEN DO:   
         hjstart = 0.
         FIND tidbuff WHERE RECID(tidbuff) = reco NO-LOCK NO-ERROR.
         uppde:
         REPEAT:
            FIND PREV tidbuff WHERE tidbuff.PERSONALKOD = TIDREGITAB.PERSONALKOD AND
            tidbuff.DATUM = TIDREGITAB.DATUM AND tidbuff.OVERTIDUTTAG NE "F" NO-LOCK NO-ERROR.
            IF NOT AVAILABLE tidbuff THEN LEAVE uppde.                        
            IF tidbuff.START GE regslut OR tidbuff.START < regstart THEN DO:
               IF tidbuff.SLUT = TIDREGITAB.START THEN DO:
                  ASSIGN hjstart = tidbuff.START.     /*tolka uppdelade registreringar ihop till halvtimmar*/                                                        
               END.
               ELSE IF hjstart > 0  AND tidbuff.SLUT = hjstart THEN ASSIGN hjstart = tidbuff.START.                                                                
               ELSE LEAVE uppde.
            END.
         END.  
         IF hjstart > 0 THEN DO:          
            nytid = hjstart.
            RUN TIMSEK.P.
            ASSIGN seku = sekunder nytid = bslut.
            RUN TIMSEK.P.
            ASSIGN  sekunder = sekunder - seku.           
         END.   
         FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco NO-LOCK NO-ERROR.
         FIND FIRST tidbuff WHERE tidbuff.PERSONALKOD = TIDREGITAB.PERSONALKOD AND
         tidbuff.DATUM = TIDREGITAB.DATUM AND tidbuff.START = TIDREGITAB.SLUT AND 
         tidbuff.START NE regstart AND tidbuff.OVERTIDUTTAG NE "F" NO-LOCK NO-ERROR.
         IF AVAILABLE tidbuff THEN ASSIGN halvupp = FALSE.   
         FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco NO-LOCK NO-ERROR. 
      END.
   END.            
   DO TRANSACTION:   
      FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco EXCLUSIVE-LOCK NO-ERROR.                            
   END.    
   
   IF ( Guru.Konstanter:globforetag = "GKAL"  OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:    
      IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE
      AND bdatum = avdatum THEN DO:            
         htim = TRUNCATE( sekunder / 1800 ,0).
         sekunder = 1800 - sekunder + ( htim * 1800 ).
         IF sekunder = 1800 THEN sekunder = 0.      
         slu = slu + sekunder.         
         hjdygn = 0.
         IF energiavt = TRUE AND TIDREGITAB.SLUT < 86400 AND slu > 86400 THEN DO:
            hjdygn = slu - 86400.
         END.   
         IF slu > 86400 THEN ASSIGN slu = 86400. /* obs ändrat 990112 jämna halvtimmar över 24*/         
      END.
   END.      
   IF bdatum NE avdatum THEN DO:      
      verklig1 = klock60(klock100(verklig) + klock100(avslut) - klock100(avstart)).      
      IF ( Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:
         IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE THEN DO:
            nytid = avslut.
            RUN TIMSEK.P.
            ASSIGN
            avslu = sekunder
            nytid = verklig1.
            RUN TIMSEK.P.
            htim = TRUNCATE( sekunder / 1800 ,0).            
            sekunder = 1800 - sekunder + ( htim * 1800 ).
            IF sekunder = 1800 THEN sekunder = 0.
            avslu = avslu + sekunder.
            sekunder = avslu.    /*obs ändrat 990112 lena jämna halvtimmar över 24*/
            RUN SEKTIM.P.
            avslut = nytid.         
         END.   
      END.
   END.
   ELSE  verklig1 = verklig.
   IF UTRYCKNING.EXTID = TRUE THEN DO:
      IF WEEKDAY(regdatum) = 2 OR WEEKDAY(regdatum) = 3
      OR WEEKDAY(regdatum) = 4 OR WEEKDAY(regdatum) = 5 
      OR WEEKDAY(regdatum) = 6 THEN DO:
           FIND FIRST otidtab WHERE otidtab.ARBSLUT = TRUE AND
          otidtab.DAGNR = WEEKDAY(regdatum) AND
          otidtab.KOD = anstkod USE-INDEX OVERT NO-LOCK NO-ERROR.
          IF NOT AVAILABLE otidtab THEN DO TRANSACTION:
             CREATE FELTEXT.
             ASSIGN 
             FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
             FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 24.'
             FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.  
             RETURN.
          END.         
          startar = bustart3 * 3600.
          IF startar < ( otidtab.STOPP1 + slut4 ) AND
          startar > start5 THEN  slut4 = slut4.
          ELSE slut4 = 0.
      END.
      ELSE slut4 = 0.
   END.
   ELSE slut4 = 0.   
   IF Guru.Konstanter:globforetag = "MSK " AND anstkod = "K" THEN slut4 = 0.
   IF UTRYCKNING.EXAKTM = TRUE THEN DO:
      IF WEEKDAY(regdatum) = 2 OR WEEKDAY(regdatum) = 3
      OR WEEKDAY(regdatum) = 4 OR WEEKDAY(regdatum) = 5 
      OR WEEKDAY(regdatum) = 6 THEN DO:
          FIND FIRST otidtab WHERE otidtab.ARBSTART = TRUE AND
          otidtab.DAGNR = WEEKDAY(regdatum) AND
          otidtab.KOD = anstkod USE-INDEX OVERT NO-LOCK NO-ERROR.          
         IF NOT AVAILABLE otidtab THEN DO TRANSACTION:
            CREATE FELTEXT.
            ASSIGN 
            FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
            FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 25.'
            FELTEXT.PROGRAM = "OTOLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.
            RETURN.
         END.
         startar = bslut * 3600.
         IF startar > ( otidtab.START1 - start4 ) AND startar < slut5 THEN  start4 = start4.
         ELSE start4 = 0.
      END.
      ELSE  start4 = 0.
   END.
   ELSE start4 = 0.   
   FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
   AND ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG NE "M" AND ovavtab.OVERTIDUTTAG NE "N" USE-INDEX ODATUM NO-LOCK NO-ERROR.
  
   IF NOT AVAILABLE ovavtab THEN DO:               
      FIND FIRST otidtab WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND
      otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp AND
      sta GE otidtab.START1 AND sta < otidtab.STOPP1 + slut4 + start4 AND
      sta NE otidtab.STOPP1 + slut4 + start4 AND
      otidtab.START1 NE otidtab.STOPP1 USE-INDEX OVERSTART NO-LOCK NO-ERROR.
      IF NOT AVAILABLE otidtab THEN DO:         
         FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum) AND
         otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp AND
         sta GE  otidtab.START2  AND
         sta < otidtab.STOPP2 + slut4 + start4 AND
         sta NE otidtab.STOPP2 + slut4 + start4 AND
         otidtab.START2 NE otidtab.STOPP2 USE-INDEX OSTART2 NO-LOCK NO-ERROR.
         IF NOT AVAILABLE otidtab THEN DO TRANSACTION:                         
            CREATE FELTEXT.
            ASSIGN 
            FELTEXT.ANVANDARE = Guru.Konstanter:globanv.         
            FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 26.' + string(regdatum) + anstkod + komp + STRING(STA) + STRING(SLU) 
            + string(slut4) + string(start4)  .
            FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.     
            RETURN.
         END.      
         ASSIGN stop1 = otidtab.STOPP2 + slut4 + start4
         kod1 = otidtab.OVERTIDTILL.         
      END.
      ELSE DO:         
         ASSIGN stop1 = otidtab.STOPP1 + slut4 + start4
         kod1 = otidtab.OVERTIDTILL.
      END.                        
   END. 
   ELSE DO:      
      FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
      ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp AND
      sta GE  ovavtab.START1 AND sta < ovavtab.STOPP1 + slut4 + start4 AND
      sta NE ovavtab.STOPP1 + slut4 + start4 AND
      ovavtab.START1 NE ovavtab.STOPP1 USE-INDEX OSTART1 NO-LOCK NO-ERROR.
      IF NOT AVAILABLE ovavtab THEN DO:
         FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
         ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp AND
         sta GE  ovavtab.START2 AND sta < ovavtab.STOPP2 + slut4 + start4 AND
         sta NE ovavtab.STOPP2 + slut4 + start4 AND
         ovavtab.START2 NE ovavtab.STOPP2 USE-INDEX OSTART2 NO-LOCK NO-ERROR.
         IF NOT AVAILABLE ovavtab THEN DO TRANSACTION:
            CREATE FELTEXT.
             ASSIGN 
             FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
             FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 27' + ANSTKOD + KOMP + STRING(sta) + STRING(start4) + STRING(slut4).
             FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.
             RETURN.
         END.
         ASSIGN stop1 = ovavtab.STOPP2 + slut4 + start4
         kod1 = ovavtab.OVERTIDTILL.
      END.
      ELSE ASSIGN stop1 = ovavtab.STOPP1 + slut4 + start4  kod1 = ovavtab.OVERTIDTILL.             
   END.      
   IF slu LE stop1 THEN DO:             
      IF energiavt = TRUE THEN ASSIGN tiddiff1 = slu + hjdygn - sta sekunder = tiddiff1.      
      ELSE ASSIGN tiddiff1 = slu - sta sekunder = tiddiff1.      
      RUN SEKTIM.P.
      tiddi1 = nytid.       
      DO TRANSACTION:
         FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco EXCLUSIVE-LOCK NO-ERROR.
         IF ( Guru.Konstanter:globforetag = "GKAL"  OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:
            IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE
            AND bdatum = avdatum THEN DO:
               sekunder = slu.
               RUN SEKTIM.P. 
               ASSIGN TIDREGITAB.OSL1 = nytid.               
            END.  
            ELSE ASSIGN TIDREGITAB.OSL1 = TIDREGITAB.SLUT.
         END.
         ELSE ASSIGN TIDREGITAB.OSL1 = TIDREGITAB.SLUT.
         ASSIGN 
         TIDREGITAB.OKOD1 = kod1
         TIDREGITAB.OANT1 = tiddi1
         TIDREGITAB.OST1 = TIDREGITAB.START   
         TIDREGITAB.OKOD2 = " "
         TIDREGITAB.OANT2 = 0
         TIDREGITAB.OST2 = 0
         TIDREGITAB.OSL2 = 0   
         TIDREGITAB.OKOD3 = " "
         TIDREGITAB.OANT3 = 0
         TIDREGITAB.OST3 = 0
         TIDREGITAB.OSL3 = 0.                                                   
      END.      
   END.   
   ELSE DO:      
      IF slu > stop1 THEN DO:         
         FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
         AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
         IF NOT AVAILABLE ovavtab THEN DO:
            FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum) AND
            otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp AND
            otidtab.START1 = stop1 - slut4 - start4 AND
            otidtab.START1 NE otidtab.STOPP1
            USE-INDEX OVERSTART NO-LOCK NO-ERROR.
            IF NOT AVAILABLE otidtab THEN DO:
               FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp
               AND otidtab.START2 = stop1 - slut4 - start4 AND
               otidtab.START2 NE otidtab.STOPP2
               USE-INDEX OSTART2 NO-LOCK NO-ERROR.
               IF NOT AVAILABLE otidtab THEN DO TRANSACTION:                   
                  CREATE FELTEXT.
                  ASSIGN 
                  FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
                  FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 28.' + ANSTKOD + KOMP + STRING(sta) + STRING(start4) + STRING(slut4) + " " + STRING(STOP1).
                  FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.                  
                  RETURN.
               END.
               ASSIGN starta1 = otidtab.START2 + slut4 + start4
               stop2 = otidtab.STOPP2  
               kod2 = otidtab.OVERTIDTILL.
               IF stop2 = 86400  THEN stop2 = stop2.
               ELSE IF energiavt = TRUE THEN stop2 = otidtab.STOPP2 + slut4 + start4.              
            END.
            ELSE DO:
               ASSIGN starta1 = otidtab.START1 + slut4 + start4
               stop2 = otidtab.STOPP1
               kod2 = otidtab.OVERTIDTILL.
               IF stop2 = 86400  THEN stop2 = stop2.
               ELSE IF energiavt = TRUE THEN stop2 = otidtab.STOPP1 + slut4 + start4.               
            END.            
         END.        
         ELSE DO:            
            FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
            ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp AND
            ovavtab.START1 = stop1 - slut4 - start4 AND
            ovavtab.START1 NE ovavtab.STOPP1 USE-INDEX OSTART1
            NO-LOCK NO-ERROR.
            IF NOT AVAILABLE ovavtab THEN DO:
               FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
               ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp
               AND ovavtab.START2 = stop1 - slut4 - start4 AND
               ovavtab.START2 NE ovavtab.STOPP2 USE-INDEX OSTART2
               NO-LOCK NO-ERROR.
               ASSIGN starta1 = ovavtab.START2 + slut4 + start4
               stop2 = ovavtab.STOPP2
               kod2 = ovavtab.OVERTIDTILL.
               IF energiavt = TRUE THEN stop2 = ovavtab.STOPP2 + slut4 + start4.
            END.
            ELSE DO:
               ASSIGN starta1 = ovavtab.START1 + slut4 + start4
               stop2 = ovavtab.STOPP1
               kod2 = ovavtab.OVERTIDTILL.
               IF energiavt = TRUE THEN stop2 = ovavtab.STOPP1 + slut4 + start4.
            END.            
         END.         
      END.
   END.   
   IF slu LE stop1 THEN regdatum = regdatum.
   ELSE DO:          
      IF slu > stop1 AND slu le stop2 THEN DO TRANSACTION:                  
         ASSIGN tiddiff1 = stop1 - sta.
         IF energiavt = TRUE AND stop2 = 86400 AND slu = 86400 AND hjdygn > 0 THEN DO:            
            ASSIGN tiddiff2 = slu + hjdygn - starta1.
         END.
         ELSE DO:  
            ASSIGN  tiddiff2 = slu - starta1.  
         END.            
         sekunder = tiddiff1.
         RUN SEKTIM.P.
         ASSIGN tiddi1 = nytid
         sekunder = tiddiff2.
         RUN SEKTIM.P.
         ASSIGN tiddi2 = nytid
         sekunder = starta1.
         RUN SEKTIM.P.
         ASSIGN sta1 = nytid
         sekunder = stop1.
         RUN SEKTIM.P.
         sto1 = nytid.
         FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco EXCLUSIVE-LOCK NO-ERROR.
         IF (Guru.Konstanter:globforetag = "GKAL"   OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV"  OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:
            IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE
            AND bdatum = avdatum THEN DO:
               sekunder = slu.
               RUN SEKTIM.P. 
               ASSIGN TIDREGITAB.OSL2 = nytid.
            END.  
            ELSE ASSIGN TIDREGITAB.OSL2 = TIDREGITAB.SLUT.  
         END.
         ELSE ASSIGN TIDREGITAB.OSL2 = TIDREGITAB.SLUT.  
         ASSIGN 
         TIDREGITAB.OKOD1 = kod1
         TIDREGITAB.OANT1 = tiddi1
         TIDREGITAB.OST1 = TIDREGITAB.START
         TIDREGITAB.OSL1 = sto1
         TIDREGITAB.OKOD2 = kod2
         TIDREGITAB.OST2 = sta1     
         TIDREGITAB.OANT2 = tiddi2 
         TIDREGITAB.OKOD3 = " "  
         TIDREGITAB.OST3 = 0
         TIDREGITAB.OSL3 = 0
         TIDREGITAB.OANT3 = 0.                                                                       
      END.
      
      ELSE DO TRANSACTION:         
         IF slu > stop2 THEN DO:                        
            FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
            AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
            IF NOT AVAILABLE ovavtab THEN DO:
               FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp
               AND otidtab.START1 = stop2 AND
               otidtab.START1 NE otidtab.STOPP1
               USE-INDEX OVERSTART NO-LOCK NO-ERROR.
               IF NOT AVAILABLE otidtab THEN DO:
                  FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum) AND
                  otidtab.KOD = anstkod AND
                  otidtab.OVERTIDUTTAG = komp AND otidtab.START2 = stop2 AND
                  otidtab.START2 NE otidtab.STOPP2
                  USE-INDEX OSTART2 NO-LOCK NO-ERROR.
                  IF NOT AVAILABLE otidtab THEN DO:
                     CREATE FELTEXT.
                     ASSIGN 
                     FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
                     FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 29. '  + string(regdatum) + anstkod + komp + STRING(STA) + STRING(SLU) + STRING(STOP2)
                     FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.
                     RETURN.
                  END.
                  ASSIGN starta2 = otidtab.START2
                  stop3 = otidtab.STOPP2
                  kod3 = otidtab.OVERTIDTILL.
               END.
               ELSE DO:
                  ASSIGN starta2 = otidtab.START1
                  stop3 = otidtab.STOPP1
                  kod3 = otidtab.OVERTIDTILL.
               END.
            END.            
            ELSE DO:
               FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
               ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp
               AND ovavtab.START1 = stop2 AND
               ovavtab.START1 NE ovavtab.STOPP1
               USE-INDEX OSTART1 NO-LOCK NO-ERROR.
               IF NOT AVAILABLE ovavtab THEN DO:
                  FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum AND
                  ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp
                  AND ovavtab.START2 = stop2 AND
                  ovavtab.START2 NE ovavtab.STOPP2
                  USE-INDEX OSTART2 NO-LOCK NO-ERROR.
                  ASSIGN starta2 = ovavtab.START2
                  stop3 = ovavtab.STOPP2
                  kod3 = ovavtab.OVERTIDTILL.
               END.
               ELSE DO:
                  ASSIGN starta2 = ovavtab.START1
                  stop3 = ovavtab.STOPP1
                  kod3 = ovavtab.OVERTIDTILL.
               END.
            END.
            IF slu > stop2 AND slu le stop3 THEN DO:
               ASSIGN tiddiff1 = stop1 - sta
               tiddiff2 = stop2 - stop1
               tiddiff3 = slu - starta2
               sekunder = tiddiff1.
               RUN SEKTIM.P.
               ASSIGN tiddi1 = nytid
               sekunder = tiddiff2.
               RUN SEKTIM.P.
               ASSIGN tiddi2 = nytid
               sekunder = tiddiff3.
               RUN SEKTIM.P.
               ASSIGN tiddi3 = nytid
               sekunder = starta1.
               RUN SEKTIM.P.
               ASSIGN sta1 = nytid
               sekunder = starta2.
               RUN SEKTIM.P.
               ASSIGN sta2 = nytid
               sekunder = stop1.
               RUN SEKTIM.P.
               ASSIGN sto1 = nytid
               sekunder = stop2.
               RUN SEKTIM.P.
               sto2 = nytid.
               FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco 
               EXCLUSIVE-LOCK NO-ERROR. 
               IF (Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE" ) THEN DO:
                  IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE
                  AND bdatum = avdatum THEN DO:
                     sekunder = slu.
                     RUN SEKTIM.P. 
                     ASSIGN TIDREGITAB.OSL3 = nytid.
                  END.  
                  ELSE ASSIGN TIDREGITAB.OSL3 = TIDREGITAB.SLUT.
               END.
               ELSE ASSIGN TIDREGITAB.OSL3 = TIDREGITAB.SLUT.  
               ASSIGN TIDREGITAB.OST1 = TIDREGITAB.START
               TIDREGITAB.OSL1 = sto1
               TIDREGITAB.OKOD1 = kod1
               TIDREGITAB.OANT1 = tiddi1
               TIDREGITAB.OKOD2 = kod2
               TIDREGITAB.OST2 = sto1
               TIDREGITAB.OSL2 = sto2 
               TIDREGITAB.OANT2 = tiddi2
               TIDREGITAB.OKOD3 = kod3
               TIDREGITAB.OST3 = sta2  
               TIDREGITAB.OANT3 = tiddi3.                                          
            END.
         END.
      END.
   END. 
   IF bslut = 24.00 AND avstart = 00.00 THEN DO:
      DEBUGGER:SET-BREAK().      
   /* OVER DYGNET */  
      nytid = avstart.
      RUN TIMSEK.P.
      ASSIGN avsta = sekunder
      nytid = avslut.
      RUN TIMSEK.P.
      avslu = sekunder.
      IF komp1 =  " " THEN  komp1 = komp.
      FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum
      AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
      IF NOT AVAILABLE ovavtab THEN DO:         
          FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum + 1) AND
          otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp1 AND
          avsta GE  otidtab.START1 AND avsta < otidtab.STOPP1 AND
          otidtab.START1 NE otidtab.STOPP1
          USE-INDEX OVERSTART NO-LOCK NO-ERROR.
          IF NOT AVAILABLE otidtab THEN DO:
             FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum + 1) AND
             otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp1
             AND TIDREGITAB.START GE  otidtab.START2 AND
             avsta < otidtab.STOPP2 AND otidtab.START2 NE otidtab.STOPP2
             USE-INDEX OSTART2 NO-LOCK NO-ERROR.
             IF NOT AVAILABLE otidtab THEN DO TRANSACTION:
                CREATE FELTEXT.
                ASSIGN 
                FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
                FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 30.'
                FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.
                RETURN.
             END.
             ASSIGN stop4 = otidtab.STOPP2
             kod4 = otidtab.OVERTIDTILL.
          END.
          ELSE ASSIGN stop4 = otidtab.STOPP1 kod4 = otidtab.OVERTIDTILL.         
      END.
      ELSE DO:
          FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum AND
          ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp1 AND
          avsta GE ovavtab.START1 AND avsta < ovavtab.STOPP1 AND
          ovavtab.START1 NE ovavtab.STOPP1
          USE-INDEX OSTART1 NO-LOCK NO-ERROR.
          IF NOT AVAILABLE ovavtab THEN DO:
             FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum AND
             ovavtab.KOD = anstkod AND ovavtab.OVERTIDUTTAG = komp1 AND
             TIDREGITAB.START GE  ovavtab.START2 AND
             avsta < ovavtab.STOPP2 AND ovavtab.START2 NE ovavtab.STOPP2
             USE-INDEX OSTART2 NO-LOCK NO-ERROR.
             ASSIGN stop4 = ovavtab.STOPP2
             kod4 = ovavtab.OVERTIDTILL.
          END.
          ELSE ASSIGN stop4 = ovavtab.STOPP1 kod4 = ovavtab.OVERTIDTILL.          
      END.      
      IF avslu LE stop4 THEN DO TRANSACTION:
          ASSIGN tiddiff4= avslu - avsta
          sekunder = tiddiff1
         sekunder = tiddiff4.
         RUN SEKTIM.P.
         tiddi4 = nytid.
          FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco2 EXCLUSIVE-LOCK NO-ERROR.
          IF ( Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE") THEN DO:
            IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE THEN DO:
               sekunder = avslu.
               RUN SEKTIM.P. 
               ASSIGN TIDREGITAB.OSL1 = nytid.               
            END.
            ELSE TIDREGITAB.OSL1 = TIDREGITAB.SLUT. 
         END.
         ELSE TIDREGITAB.OSL1 = TIDREGITAB.SLUT.  
          ASSIGN 
         TIDREGITAB.OKOD1 = kod4
         TIDREGITAB.OANT1 = tiddi4
         TIDREGITAB.OST1 = TIDREGITAB.START  
         TIDREGITAB.OKOD2 = " "
         TIDREGITAB.OANT2 = 0
         TIDREGITAB.OST2 = 0
         TIDREGITAB.OSL2 = 0 
         TIDREGITAB.OKOD3 = " "
         TIDREGITAB.OANT3 = 0
         TIDREGITAB.OST3 = 0
         TIDREGITAB.OSL3 = 0.   
         /*dygnsbryt om ändrat från Ö till K på 21-24 - ändra äver 0-2 till K Lena 20190528*/
         TIDREGITAB.OVERTIDUTTAG = komp1.                
      END.
      ELSE DO TRANSACTION:
           IF avslu > stop4 THEN DO:
             FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum
             AND ovavtab.KOD = anstkod
             USE-INDEX ODATUM NO-LOCK NO-ERROR.
             IF NOT AVAILABLE ovavtab THEN DO:
                FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum + 1) AND
                otidtab.KOD = anstkod AND
                otidtab.OVERTIDUTTAG = komp1 AND otidtab.START1 = stop4 AND
                otidtab.START1 NE otidtab.STOPP1
                USE-INDEX OVERSTART NO-LOCK NO-ERROR.
                IF NOT AVAILABLE otidtab THEN DO:
                    FIND FIRST otidtab WHERE otidtab.DAG = WEEKDAY(regdatum + 1) AND
                    otidtab.KOD = anstkod AND
                    otidtab.OVERTIDUTTAG = komp1 AND
                    otidtab.START2 = stop4 AND
                    otidtab.START2 NE otidtab.STOPP2
                    USE-INDEX OSTART2 NO-LOCK NO-ERROR.
                    IF NOT AVAILABLE otidtab THEN DO:
                       CREATE FELTEXT.
                       ASSIGN 
                       FELTEXT.ANVANDARE = Guru.Konstanter:globanv         
                       FELTEXT.FELTEXT = 'Kontakta Elpool! För nu är det något fel! Ange läge 31.'
                       FELTEXT.PROGRAM = "OTLKPR" + STRING(TODAY) + STRING(TIME,"HH:MM") + Guru.Konstanter:globanv.
                       RETURN.
                    END.
                    ASSIGN starta3 = otidtab.START2
                    kod5 = otidtab.OVERTIDTILL.
                END.
                ELSE ASSIGN starta3 = otidtab.START1 kod5 = otidtab.OVERTIDTILL.                
             END.
             ELSE DO:
                FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum AND
                ovavtab.KOD = anstkod  AND ovavtab.OVERTIDUTTAG = komp1
                AND ovavtab.START1 = stop4 AND
                ovavtab.START1 NE ovavtab.STOPP1
                USE-INDEX OSTART1 NO-LOCK NO-ERROR.
                IF NOT AVAILABLE ovavtab THEN DO:
                    FIND FIRST ovavtab WHERE ovavtab.DATUM = avdatum AND
                    ovavtab.KOD = anstkod AND
                    ovavtab.OVERTIDUTTAG = komp1 AND ovavtab.START2 = stop4 AND
                    ovavtab.START2 NE ovavtab.STOPP2
                    USE-INDEX OSTART2 NO-LOCK NO-ERROR.
                    ASSIGN starta3 = ovavtab.START2
                    kod5 = ovavtab.OVERTIDTILL.
                END.
                ELSE ASSIGN starta3 = ovavtab.START1 kod5 = ovavtab.OVERTIDTILL.                
             END.
             ASSIGN tiddiff5 = stop4 - avsta
             tiddiff6 = avslu - starta3
             sekunder = tiddiff5.
            RUN SEKTIM.P.
            ASSIGN tiddi5 = nytid
            sekunder = tiddiff6.
            RUN SEKTIM.P.
            ASSIGN tiddi6 = nytid
            sekunder = starta3.
            RUN SEKTIM.P.
            ASSIGN sta3 = nytid
            sekunder = stop4.
            RUN SEKTIM.P.
            sto4 = nytid.
             FIND TIDREGITAB WHERE RECID(TIDREGITAB) = reco2 EXCLUSIVE-LOCK NO-ERROR.
             IF ( Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "LULE") THEN DO:
               IF halvupp = TRUE  AND TIDREGITAB.UTRYCKNING = FALSE THEN DO:
                  sekunder = avslu.
                  RUN SEKTIM.P. 
                  ASSIGN TIDREGITAB.OSL2 = nytid.
               END.  
               ELSE TIDREGITAB.OSL2 = avslut. 
            END.
            ELSE TIDREGITAB.OSL2 = avslut.  
             ASSIGN 
             TIDREGITAB.OST1 = TIDREGITAB.START
            TIDREGITAB.OSL1 = sto4
            TIDREGITAB.OKOD1 = kod4
            TIDREGITAB.OANT1 = tiddi5
            TIDREGITAB.OKOD2 = kod5
            TIDREGITAB.OST2 = sta3
            TIDREGITAB.OANT2 = tiddi6
            TIDREGITAB.OKOD3 = " "
            TIDREGITAB.OANT3 = 0
            TIDREGITAB.OST3 = 0
            TIDREGITAB.OSL3 = 0.         
            /*dygnsbryt om ändrat från Ö till K på 21-24 - ändra äver 0-2 till K Lena 20190528*/
            TIDREGITAB.OVERTIDUTTAG = komp1.                                        
         END.
      END.
   END.   
   RUN OTO2PR.P.
END.
PROCEDURE skift_UI :
   IF Guru.Konstanter:globforetag = "LULE" OR Guru.Konstanter:globforetag = "GKAL" OR Guru.Konstanter:globforetag = "SUND" OR Guru.Konstanter:globforetag = "SNAT" OR Guru.Konstanter:globforetag = "MISV" OR Guru.Konstanter:globforetag = "ELPA" THEN DO:
      /*Förflyttning av övertiden för skiftpersonal*/   
      IF energiavt = TRUE THEN DO:        
         IF PERSONALTAB.DELTID = TRUE THEN.
         ELSE DO:               
            FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND 
            TIDREGITAB.DATUM = regdatum AND TIDREGITAB.START = bustart3 AND
            TIDREGITAB.TIDLOG = TRUE  USE-INDEX PSTART NO-LOCK NO-ERROR.
            IF NOT AVAILABLE TIDREGITAB THEN RETURN.         
            komp = TIDREGITAB.OVERTIDUTTAG. 
            IF start4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSTART = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.STOPP1 = otidtab.START1 USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + start4
                     otidtab.STOPP1 = otidtab.STOPP1 + start4          
                     otab.STOPP1 = otab.STOPP1 + start4.            
                  END.
               END.
            END.
            IF slut4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSLUT = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.START2 = otidtab.STOPP1 USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + start4.  /*obs måste vara start4 */
                     otidtab.STOPP1 = otidtab.STOPP1 + slut4.
                     IF otidtab.STOPP1 > 86400 THEN DO:               
                        FIND FIRST otab2 WHERE otab2.DAGNR = WEEKDAY(regdatum + 1) AND
                        otab2.KOD = anstkod AND otab2.OVERTIDUTTAG = komp AND otab2.START1 = 0 USE-INDEX OVERT NO-ERROR.
                        IF AVAILABLE otab2 THEN DO:                  
                           CREATE otab3.                                
                           ASSIGN
                           otab3.KOD = otab2.KOD 
                           otab3.OVERTIDTILL = otidtab.OVERTIDTILL
                           otab3.START1 = 0
                           otab3.STOPP1 = otidtab.STOPP1 - 86400
                           otab3.START2 = 0
                           otab3.STOPP2 = 0
                           otab3.DAGNR = otab2.DAGNR
                           otab3.OVERTIDUTTAG = otab2.OVERTIDUTTAG
                           otab3.FORKL = otab2.FORKL
                           otab3.ARBSLUT = FALSE
                           otab3.ARBSTART = FALSE
                           otidtab.STOPP1 = 86400
                           otab.START2 = 0
                           otab.STOPP2 = 0
                           otab2.START1 = otab3.STOPP1.
                        END.
                     END.
                     ELSE otab.START2 = otab.START2 + slut4.
         
                  END.
               END.
            END.
            IF regstart = regslut THEN DO:
               /*dagar utan arbetstid mitt i veckan är kval hela dagen om inte avvikelsekalendern säger annars*/               
               FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
               AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
               IF NOT AVAILABLE ovavtab THEN DO:                       
                  FIND FIRST otidtab WHERE otidtab.ARBSLUT = FALSE AND otidtab.ARBSTART = FALSE AND
                  otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otidtab THEN DO:
                      kvkod = otidtab.OVERTIDTILL.
                      FOR EACH otidtab  WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp:
                         ASSIGN otidtab.OVERTIDTILL = kvkod.
                      END.
                  END.
               END.
            END.        
            nytid = lunchstarten.
            RUN TIMSEK.P.
            lunchstarten2 = sekunder.
            nytid = lunchslutet.
            RUN TIMSEK.P.
            lunchslutet2 = sekunder.
            IF regstart = 0 AND regslut = 24 THEN DO:
               FIND FIRST otab3 WHERE otab3.ARBSLUT = FALSE AND otab3.ARBSTART = FALSE AND
               otab3.DAGNR = WEEKDAY(regdatum) AND
               otab3.KOD = anstkod AND otab3.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otab3  THEN DO:       
                  ASSIGN
                  otab3.START1 = lunchstarten2 + 7200
                  otab3.STOPP1 = lunchslutet2 - 7200 
                  otab3.START2 = 0
                  otab3.STOPP2 = 0.
               END.       
               FIND FIRST otidtab WHERE otidtab.ARBSTART = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  ASSIGN
                  otidtab.START1 = lunchslutet2 - 7200
                  otidtab.STOPP1 = lunchslutet2.         
               END.
               ELSE DO:
                  /* helgen har inga arbstart arbslut -skapa dem*/
                  IF AVAILABLE otab3 THEN DO:            
                     CREATE otidtab. 
                     ASSIGN
                     otidtab.KOD = otab3.KOD 
                     otidtab.OVERTIDTILL = otab3.OVERTIDTILL
                     otidtab.START1 = lunchslutet2 - 7200
                     otidtab.STOPP1 = lunchslutet2
                     otidtab.START2 = 0
                     otidtab.STOPP2 = 0
                     otidtab.DAGNR = otab3.DAGNR
                     otidtab.OVERTIDUTTAG = otab3.OVERTIDUTTAG
                     otidtab.FORKL = otab3.FORKL
                     otidtab.ARBSLUT = FALSE
                     otidtab.ARBSTART = TRUE.
                  END.
               END.
               FIND FIRST otidtab WHERE otidtab.ARBSLUT = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  ASSIGN
                  otidtab.START1 = lunchstarten2
                  otidtab.STOPP1 = lunchstarten2  + 7200.         
               END.
               ELSE DO:
                  /* helgen har inga arbstart arbslut -skapa dem*/
                  IF AVAILABLE otab3 THEN DO:            
                     CREATE otidtab. 
                     ASSIGN
                     otidtab.KOD = otab3.KOD 
                     otidtab.OVERTIDTILL = otab3.OVERTIDTILL
                     otidtab.START1 = lunchstarten2
                     otidtab.STOPP1 = lunchstarten2  + 7200
                     otidtab.START2 = 0
                     otidtab.STOPP2 = 0
                     otidtab.DAGNR = otab3.DAGNR
                     otidtab.OVERTIDUTTAG = otab3.OVERTIDUTTAG
                     otidtab.FORKL = otab3.FORKL
                     otidtab.ARBSLUT = TRUE
                     otidtab.ARBSTART = FALSE.
                  END.
               END.         
            END.      
            regdatum = regdatum - 1.
            RUN REGVEC.P.
            RUN SLUTARB.P.
            nytid = regstart.
            RUN TIMSEK.P.
            st4 = sekunder - start8.
            nytid = regslut.
            RUN TIMSEK.P.
            sl4 = sekunder - slut8.
            IF st4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSTART = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.STOPP1 = otidtab.START1 USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + st4
                     otidtab.STOPP1 = otidtab.STOPP1 + st4          
                     otab.STOPP1 = otab.STOPP1 + st4.
                  END.
               END.
            END.
            IF sl4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSLUT = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT  NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.START2 = otidtab.STOPP1 USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + st4
                     otidtab.STOPP1 = otidtab.STOPP1 + sl4.
                     IF otidtab.STOPP1 > 86400 THEN DO:               
                        FIND FIRST otab2 WHERE otab2.DAGNR = WEEKDAY(regdatum + 1) AND
                        otab2.KOD = anstkod AND otab2.OVERTIDUTTAG = komp AND otab2.START1 = 0 USE-INDEX OVERT NO-ERROR.
                        IF AVAILABLE otab2 THEN DO:                  
                           CREATE otab3.                                
                           ASSIGN
                           otab3.KOD = otab2.KOD 
                           otab3.OVERTIDTILL = otidtab.OVERTIDTILL
                           otab3.START1 = 0
                           otab3.STOPP1 = otidtab.STOPP1 - 86400
                           otab3.START2 = 0
                           otab3.STOPP2 = 0
                           otab3.DAGNR = otab2.DAGNR
                           otab3.OVERTIDUTTAG = otab2.OVERTIDUTTAG
                           otab3.FORKL = otab2.FORKL
                           otab3.ARBSLUT = FALSE
                           otab3.ARBSTART = FALSE
                           otidtab.STOPP1 = 86400
                           otab.START2 = 0
                           otab.STOPP2 = 0
                           otab2.START1 = otab3.STOPP1.
                        END.
                     END.
                     ELSE otab.START2 = otab.START2 + sl4.
                  END.
               END.
            END.
            IF regstart = regslut THEN DO:
               /*dagar utan arbetstid mitt i veckan är kval hela dagen om inte avvikelsekalendern säger annars*/               
               FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
               AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
               IF NOT AVAILABLE ovavtab THEN DO:                       
                  FIND FIRST otidtab WHERE otidtab.ARBSLUT = FALSE AND otidtab.ARBSTART = FALSE AND
                  otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otidtab THEN DO:
                      kvkod = otidtab.OVERTIDTILL.
                      FOR EACH otidtab  WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp EXCLUSIVE-LOCK:
                         ASSIGN otidtab.OVERTIDTILL = kvkod.
                      END.
                  END.
               END.
            END.
            regdatum = hjdat.
            regdatum = regdatum + 1.
            RUN REGVEC.P.
            RUN SLUTARB.P.
            nytid = regstart.
            RUN TIMSEK.P.
            st4 = sekunder - start8.
            nytid = regslut.
            RUN TIMSEK.P.
            sl4 = sekunder - slut8.
            IF st4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSTART = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.STOPP1 = otidtab.START1 USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + st4
                     otidtab.STOPP1 = otidtab.STOPP1 + st4          
                     otab.STOPP1 = otab.STOPP1 + st4.
                  END.
               END.
            END.
            IF sl4 NE 0 THEN DO:   
               FIND FIRST otidtab WHERE otidtab.ARBSLUT = TRUE AND
               otidtab.DAGNR = WEEKDAY(regdatum) AND
               otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
               IF AVAILABLE otidtab  THEN DO:       
                  FIND FIRST otab WHERE otab.DAGNR = WEEKDAY(regdatum) AND
                  otab.KOD = anstkod AND otab.OVERTIDUTTAG = komp AND otab.START2 = otidtab.STOPP1 USE-INDEX OVERT  NO-ERROR.
                  IF AVAILABLE otab THEN DO:
                     ASSIGN
                     otidtab.START1 = otidtab.START1 + st4
                     otidtab.STOPP1 = otidtab.STOPP1 + sl4.
                     IF otidtab.STOPP1 > 86400 THEN DO:               
                        FIND FIRST otab2 WHERE otab2.DAGNR = WEEKDAY(regdatum + 1) AND
                        otab2.KOD = anstkod AND otab2.OVERTIDUTTAG = komp AND otab2.START1 = 0 USE-INDEX OVERT NO-ERROR.
                        IF AVAILABLE otab2 THEN DO:                  
                           CREATE otab3.                                
                           ASSIGN
                           otab3.KOD = otab2.KOD 
                           otab3.OVERTIDTILL = otidtab.OVERTIDTILL
                           otab3.START1 = 0
                           otab3.STOPP1 = otidtab.STOPP1 - 86400
                           otab3.START2 = 0
                           otab3.STOPP2 = 0
                           otab3.DAGNR = otab2.DAGNR
                           otab3.OVERTIDUTTAG = otab2.OVERTIDUTTAG
                           otab3.FORKL = otab2.FORKL
                           otab3.ARBSLUT = FALSE
                           otab3.ARBSTART = FALSE
                           otidtab.STOPP1 = 86400
                           otab.START2 = 0
                           otab.STOPP2 = 0
                           otab2.START1 = otab3.STOPP1.
                        END.
                     END.
                     ELSE otab.START2 = otab.START2 + sl4.
                  END.
               END.
            END.
            IF regstart = regslut THEN DO:
               /*dagar utan arbetstid mitt i veckan är kval hela dagen om inte avvikelsekalendern säger annars*/               
               FIND FIRST ovavtab WHERE ovavtab.DATUM = regdatum
               AND ovavtab.KOD = anstkod USE-INDEX ODATUM NO-LOCK NO-ERROR.
               IF NOT AVAILABLE ovavtab THEN DO:                       
                  FIND FIRST otidtab WHERE otidtab.ARBSLUT = FALSE AND otidtab.ARBSTART = FALSE AND
                  otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp USE-INDEX OVERT NO-ERROR.
                  IF AVAILABLE otidtab THEN DO:
                      kvkod = otidtab.OVERTIDTILL.
                      FOR EACH otidtab  WHERE otidtab.DAGNR = WEEKDAY(regdatum) AND otidtab.KOD = anstkod AND otidtab.OVERTIDUTTAG = komp:
                         ASSIGN otidtab.OVERTIDTILL = kvkod.
                      END.
                  END.
               END.
            END.
            regdatum = hjdat.
            RUN REGVEC.P.
            RUN SLUTARB.P.
            ASSIGN
            spstart4 = start4
            spslut4 = slut4
            slut4 = 0
            start4 = 0.
         END. 
      END.
   END.
END PROCEDURE.

PROCEDURE utb_UI :
   utbch = FALSE.   
   /*IF TIDREGITAB.AONR = "00003" THEN utbch = TRUE.
   IF TIDREGITAB.AONR = "21471" AND TIDREGITAB.DELNR = 1 THEN utbch = TRUE.
   IF TIDREGITAB.AONR = "80014" THEN utbch = TRUE.
   IF TIDREGITAB.AONR = "80015" THEN utbch = TRUE.*/
   /* Sundsvall Energi ska ej längre ha mertidstolkning för utbildning  Lena 20181121
   ej heller Sundsvall Elnät 20220517*/   
   IF utbch = TRUE THEN DO:   
       IF komp = "Ö" THEN ASSIGN komp = "M".
       IF komp = "K"  THEN ASSIGN komp = "N".                
    END.
END PROCEDURE.
