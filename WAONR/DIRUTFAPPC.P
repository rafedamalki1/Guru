
/*DIRUTFAPPC.P*/
{KALKYLUPP.I}
{STARTFORAPP.I}
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{DIRDEF.I}
{SUMTD.I}
{BYTAO.I}
{LISTDEF.I}
{KALKTEMP.I}
{EXTRADATA.I}
{VPERSONALTEMP.I}
DEFINE VARIABLE bsek AS LOGICAL NO-UNDO.
DEFINE VARIABLE tisek AS LOGICAL NO-UNDO.
DEFINE VARIABLE kollvecka LIKE VECKONATT.VECKOKORD NO-UNDO.
DEFINE VARIABLE vkdatum AS DATE NO-UNDO.        
DEFINE VARIABLE valdelnrlog AS LOGICAL NO-UNDO. 
DEFINE VARIABLE berindvar AS DECIMAL NO-UNDO.
DEFINE VARIABLE utomr2 AS CHARACTER NO-UNDO. 
DEFINE VARIABLE arrhjsum LIKE TIDREGITAB.BERANTAL NO-UNDO.    
DEFINE VARIABLE arrhjsumtid LIKE TIDREGITAB.BERANTAL NO-UNDO.  
DEFINE VARIABLE arrhjrestid LIKE TIDREGITAB.BERANTAL NO-UNDO.  
DEFINE VARIABLE arrhjsumotid LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrhjsumove LIKE TIDREGITAB.BERANTAL NO-UNDO.
DEFINE VARIABLE arrhjsumtra LIKE TIDREGITAB.BERANTAL NO-UNDO.   
DEFINE VARIABLE arrhjsumlon LIKE TIDREGITAB.BERANTAL NO-UNDO.  
DEFINE VARIABLE arrhjsumikost LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrhjsumind LIKE TIDREGITAB.BERANTAL NO-UNDO. 
DEFINE VARIABLE arrhjkmbelopp AS DECIMAL NO-UNDO.
DEFINE VARIABLE str AS CHARACTER FORMAT "X(92)" NO-UNDO.  
DEFINE VARIABLE str2 AS CHARACTER FORMAT "X(92)" NO-UNDO. 
DEFINE VARIABLE avnrdatum AS DATE NO-UNDO. 
DEFINE VARIABLE bvnrdatum AS DATE NO-UNDO. 
DEFINE VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE VARIABLE vardelnr AS INTEGER NO-UNDO.
DEFINE VARIABLE varaonr AS CHARACTER NO-UNDO.

DEFINE VARIABLE planvar AS CHARACTER NO-UNDO.
DEFINE VARIABLE offert AS LOGICAL NO-UNDO.
DEFINE VARIABLE xtypmtrl AS INTEGER NO-UNDO.
DEFINE VARIABLE monpris AS DECIMAL NO-UNDO.
DEFINE VARIABLE berpris AS DECIMAL NO-UNDO.
DEFINE VARIABLE region AS LOGICAL NO-UNDO.

DEFINE VARIABLE ktotea AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotber AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotarb AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotmask AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotmtrl AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotovr AS DECIMAL NO-UNDO.
DEFINE VARIABLE karbtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE kbertim AS DECIMAL NO-UNDO.
DEFINE VARIABLE kmsktim AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotutr AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotutrtim AS DECIMAL NO-UNDO.

DEFINE VARIABLE karbtim1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE karbtim2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE karbtim3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE karbtim4 AS DECIMAL NO-UNDO.
DEFINE VARIABLE karbtim5 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt4 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ktotalt5 AS DECIMAL NO-UNDO.

DEFINE VARIABLE ototea AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototber AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototarb AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototmask AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototmtrl AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototovr AS DECIMAL NO-UNDO.
DEFINE VARIABLE obertim AS DECIMAL NO-UNDO.
DEFINE VARIABLE oarbtim AS DECIMAL NO-UNDO.
DEFINE VARIABLE omsktim AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototutr AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototutrtim AS DECIMAL NO-UNDO.

DEFINE VARIABLE oarbtim1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE oarbtim2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE oarbtim3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE oarbtim4 AS DECIMAL NO-UNDO.
DEFINE VARIABLE oarbtim5 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt2 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt4 AS DECIMAL NO-UNDO.
DEFINE VARIABLE ototalt5 AS DECIMAL NO-UNDO.
DEFINE VARIABLE anddat AS INTEGER NO-UNDO.
DEFINE VARIABLE tidftot AS DECIMAL NO-UNDO.
DEFINE VARIABLE utkonto AS CHARACTER NO-UNDO.
DEFINE VARIABLE proc1 AS DECIMAL NO-UNDO.
DEFINE VARIABLE fkto AS INTEGER NO-UNDO.
DEFINE VARIABLE anr AS CHARACTER NO-UNDO.
DEFINE VARIABLE dnr AS INTEGER NO-UNDO.
DEFINE VARIABLE viseg AS LOGICAL NO-UNDO.
DEFINE VARIABLE emask3 AS DECIMAL NO-UNDO.
DEFINE VARIABLE edataapph AS HANDLE NO-UNDO.
DEFINE TEMP-TABLE visa 
   FIELD UT AS CHARACTER    
   FIELD TYP AS CHARACTER       
   FIELD ORDNING AS INTEGER
   FIELD UPPFOLJVAL AS INTEGER
   FIELD KUURVAL AS LOGICAL
   FIELD DELNRKOLL AS LOGICAL
   FIELD VISEX AS INTEGER
   FIELD VISAP AS INTEGER
   INDEX ORDNING IS PRIMARY ORDNING KUURVAL
   INDEX UT UT.    

DEFINE NEW SHARED TEMP-TABLE kkod
   FIELD KONTO AS CHARACTER
   FIELD K1 AS CHARACTER
   FIELD K2 AS CHARACTER
   FIELD K3 AS CHARACTER
   FIELD K4 AS CHARACTER
   FIELD K5 AS CHARACTER
   FIELD KONTONR AS CHARACTER
   FIELD BENAMNING AS CHARACTER
   FIELD SATS% AS INTEGER
   INDEX KNR IS PRIMARY KONTONR ASCENDING.

DEFINE NEW SHARED TEMP-TABLE mtrl_temp2   
   {MTRLTEMP2TT.I}


DEFINE TEMP-TABLE aoval NO-UNDO
FIELD AONR LIKE AONRTAB.AONR
FIELD DELNR LIKE AONRTAB.DELNR
FIELD AONRREC AS RECID
INDEX AONR IS PRIMARY AONR DELNR.
               
DEFINE TEMP-TABLE aokto
FIELD AONR LIKE AONRTAB.AONR
FIELD DELNR LIKE AONRTAB.DELNR
FIELD K1 AS CHARACTER
FIELD K2 AS CHARACTER
FIELD K3 AS CHARACTER
FIELD K4 AS CHARACTER
FIELD K5 AS CHARACTER
FIELD SATS% AS INTEGER
FIELD AONRREC AS RECID
INDEX AONR IS PRIMARY AONR DELNR.

DEFINE TEMP-TABLE kto2
FIELD K2 AS CHARACTER.


DEFINE NEW SHARED TEMP-TABLE eko
   FIELD EDEBKRED LIKE EKRAPPRESULT.EDEBKRED
   FIELD ENY LIKE EKRAPPRESULT.ENY       
   FIELD EVERDATUM LIKE EKRAPPRESULT.EVERDATUM  
   FIELD EPROJEKT LIKE EKRAPPRESULT.EPROJEKT 
   FIELD DELNR LIKE AONRTAB.DELNR
   FIELD EORG LIKE EKRAPPRESULT.EORG 
/*   FIELD EGEO LIKE EKRAPPRESULT.EGEO       */
   FIELD EKOSTNADSSLAG LIKE EKRAPPRESULT.EKOSTNADSSLAG    
   FIELD EBELOPP LIKE  EKRAPPRESULT.EBELOPP 
   FIELD EANTAL  LIKE EKRAPPRESULT.EANTAL              
   FIELD ELONTILLAGG LIKE EKRAPPRESULT.ELONTILLAGG 
   FIELD ELONTILLANTAL LIKE EKRAPPRESULT.ELONTILLANTAL    
   FIELD ELONBELOPP LIKE EKRAPPRESULT.ELONBELOPP         
   INDEX ORG IS PRIMARY EVERDATUM EORG EPROJEKT DELNR EKOSTNADSSLAG ASCENDING.   

DEFINE TEMP-TABLE eko23
   FIELD EDEBKRED LIKE EKRAPPRESULT.EDEBKRED
   FIELD ENY LIKE EKRAPPRESULT.ENY       
   FIELD EVERDATUM LIKE EKRAPPRESULT.EVERDATUM  
   FIELD EPROJEKT LIKE EKRAPPRESULT.EPROJEKT
   FIELD DELNR LIKE AONRTAB.DELNR    
   FIELD EORG LIKE EKRAPPRESULT.EORG 
   /*FIELD EGEO LIKE EKRAPPRESULT.EGEO */       
   FIELD EKOSTNADSSLAG LIKE EKRAPPRESULT.EKOSTNADSSLAG    
   FIELD EBELOPP LIKE  EKRAPPRESULT.EBELOPP 
   FIELD EANTAL  LIKE EKRAPPRESULT.EANTAL              
   FIELD ELONTILLAGG LIKE EKRAPPRESULT.ELONTILLAGG 
   FIELD ELONTILLANTAL LIKE EKRAPPRESULT.ELONTILLANTAL    
   FIELD ELONBELOPP LIKE EKRAPPRESULT.ELONBELOPP         
   INDEX PERSORG IS PRIMARY EVERDATUM EPROJEKT DELNR EORG EKOSTNADSSLAG ASCENDING.   

DEFINE NEW SHARED TEMP-TABLE sumtemp
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD AONR LIKE TIDREGITAB.AONR 
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD DATUM LIKE TIDREGITAB.DATUM     
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP
   FIELD BELOPP AS DECIMAL
   INDEX PERS IS PRIMARY PERSONALKOD DATUM AONR PRISTYP
   INDEX AONR AONR DATUM PERSONALKOD.

DEFINE NEW SHARED TEMP-TABLE ejlontemp     
   FIELD PERSONALKOD LIKE SUMEJLON.PERSONALKOD 
   FIELD AONR LIKE SUMEJLON.AONR 
   FIELD DELNR LIKE SUMEJLON.DELNR 
   FIELD TYPKOD LIKE SUMEJLON.TYPKOD
   FIELD DATUM LIKE SUMEJLON.DATUM 
   FIELD PRISTYP LIKE SUMEJLON.PRISTYP
   FIELD LONKOST LIKE SUMEJLON.LONKOST
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE
   FIELD PRIS LIKE SUMTID.PRIS
   FIELD PRISR LIKE SUMTID.PRIS
   FIELD PRISI LIKE SUMTID.PRIS
   FIELD AKOD LIKE ANSTFORMTAB.KOD
   INDEX AONR IS PRIMARY AONR DELNR DATUM PRISTYP
   INDEX ORG OMRADE
   INDEX TYPKOD TYPKOD.

DEFINE NEW SHARED TEMP-TABLE konttemp
   FIELD DOMRADE LIKE SUMTIDDAG.GEOMRADE
   FIELD KOMRADE LIKE SUMTIDDAG.OMRADE
   FIELD BELOPP LIKE SUMTIDDAG.BELOPP
   FIELD DKONT AS CHARACTER 
   FIELD KKONT AS CHARACTER       
   INDEX OMRADE IS PRIMARY DOMRADE KOMRADE
   INDEX DKONT DKONT.

DEFINE NEW SHARED TEMP-TABLE slutsum           
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE
   FIELD PRIS LIKE TIDREGITAB.PRIS     
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"             
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "Ö-KOSTNAD"  
   FIELD OANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "Ö-ANTAL"         
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD TANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "T-ANTAL" 
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"          
   FIELD IKOST LIKE SUMTID.IKOSTNAD 
   FIELD INDEREKT AS DECIMAL 
   FIELD INOMRADE AS CHARACTER
   FIELD MED AS LOGICAL 
   FIELD ORT AS CHARACTER
   INDEX AONR IS PRIMARY AONR DELNR ASCENDING
   INDEX MED MED
   INDEX OMR AONR DELNR GEOMRADE OMRADE PERSONALKOD ASCENDING. 

DEFINE BUFFER slutsumbuff FOR slutsum.
DEFINE BUFFER tidbuff FOR TIDREGITAB.


DEFINE NEW SHARED TEMP-TABLE slutsum1           
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE
   FIELD PRIS LIKE TIDREGITAB.PRIS     
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"         
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "Ö-KOSTNAD"  
   FIELD OANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "Ö-ANTAL"         
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD TANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "T-ANTAL"   
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD"        
   FIELD IKOST LIKE SUMTID.IKOSTNAD 
   FIELD INDEREKT AS DECIMAL  
   FIELD ORT AS CHARACTER 
   INDEX AONR IS PRIMARY AONR DELNR ASCENDING
   INDEX OMR AONR DELNR GEOMRADE OMRADE PERSONALKOD ASCENDING.

DEFINE NEW SHARED TEMP-TABLE slutsum2           
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD 
   FIELD NAMN AS CHARACTER FORMAT "X(5)"
   FIELD GEOMRADE LIKE SUMTID.GEOMRADE 
   FIELD OMRADE LIKE SUMTID.OMRADE
   FIELD PRIS LIKE TIDREGITAB.PRIS     
   FIELD PRISTYP LIKE TIDREGITAB.PRISTYP 
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD TIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "TIMMAR"  
   FIELD OTIMMAR LIKE EKRAPPRESULT.EANTAL LABEL "OTIMMAR"             
   FIELD BELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "ARBKOSTNAD"           
   FIELD OBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "Ö-KOSTNAD"  
   FIELD OANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "Ö-ANTAL"         
   FIELD TBELOPP LIKE EKRAPPRESULT.EBELOPP LABEL "T-KOSTNAD"
   FIELD TANTAL LIKE EKRAPPRESULT.EANTAL  LABEL "T-ANTAL" 
   FIELD LONKOST LIKE EKRAPPRESULT.EBELOPP LABEL "L-KOSTNAD" 
   FIELD IKOST LIKE SUMTID.IKOSTNAD      

   FIELD INDEREKT AS DECIMAL 
   FIELD ORT AS CHARACTER 

   INDEX AONR IS PRIMARY AONR DELNR ASCENDING
   INDEX OMR AONR DELNR GEOMRADE OMRADE PERSONALKOD ASCENDING.  
   

DEFINE NEW SHARED TEMP-TABLE restid2 
   FIELD AONR LIKE AONRTAB.AONR
   FIELD DELNR LIKE AONRTAB.DELNR   
   FIELD OMRADE LIKE SUMTID.OMRADE                                
   FIELD TIMMAR AS DECIMAL LABEL "RTIMMAR"  
   INDEX OMR IS PRIMARY OMRADE.    
DEFINE NEW SHARED TEMP-TABLE restid3                  
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR 
   FIELD OMRADE LIKE OMRADETAB.OMRADE
   FIELD TIMMAR AS DECIMAL LABEL "RTIMMAR"                
   INDEX AONR IS PRIMARY AONR DELNR
   INDEX OMR OMRADE.      
DEFINE TEMP-TABLE restid4  
   FIELD AONR AS CHARACTER
   FIELD DELNR AS INTEGER                     
   FIELD OMRADE AS CHARACTER
   FIELD TIMMAR AS DECIMAL LABEL "RTIMMAR"                
   INDEX OMR IS PRIMARY OMRADE.


DEFINE TEMP-TABLE tidvnrtemp                  
   FIELD PERSONALKOD LIKE TIDREGITAB.PERSONALKOD
   FIELD DATUM LIKE TIDREGITAB.DATUM
   FIELD VECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   FIELD NAMN AS CHARACTER
   FIELD MAN AS DECIMAL
   FIELD TIS AS DECIMAL
   FIELD ONS AS DECIMAL
   FIELD TOR AS DECIMAL
   FIELD FRE AS DECIMAL
   FIELD LOR AS DECIMAL
   FIELD SON AS DECIMAL 
   INDEX PERSONALKOD IS PRIMARY PERSONALKOD DATUM
   INDEX VNR VECKONUMMER
   INDEX DATUM DATUM.


{TIDDETTEMP.I}
DEFINE TEMP-TABLE etiddettemp LIKE tiddettemp. 
DEFINE BUFFER oradebuff FOR OMRADETAB.
DEFINE BUFFER avdbuff FOR AVDELNING.
DEFINE BUFFER jurbuff FOR JURPERS.
           
   
FUNCTION klock100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):
/*------------------------------------------------------------------------------
  Purpose:  
    Notes:  
------------------------------------------------------------------------------*/

  RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.

END FUNCTION.

{DIRAPP.I}

PROCEDURE akalklista_UI :
   DEFINE INPUT PARAMETER offert AS LOGICAL NO-UNDO.
   DEFINE OUTPUT PARAMETER musz AS LOGICAL NO-UNDO.
   DEFINE INPUT PARAMETER TABLE FOR aoval.
   DEFINE INPUT-OUTPUT PARAMETER TABLE FOR tidut.
   FIND LAST tidut NO-LOCK NO-ERROR. 
   FOR EACH aoval:
      &Scoped-define FORMATNAMN aoval.AONR
      {AOFORMAT2.I} 
      FIND FIRST AONRTAB WHERE AONRTAB.AONR = aoval.AONR AND 
      AONRTAB.DELNR = aoval.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      CREATE tidut.
      SUBSTRING(tidut.UT,1) = Guru.Konstanter:gaok + ":" + formataonr + " Delnr:" + STRING(aoval.DELNR).
      CREATE tidut.
      SUBSTRING(tidut.UT,1) = "Benämning:" + AONRTAB.ORT.
      FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
      KALKAONR.DELNR = AONRTAB.DELNR AND 
      KALKAONR.STATUSNIV = "UF" 
      NO-LOCK NO-ERROR.
      musz = FALSE.
      IF AVAILABLE KALKAONR THEN DO:
         RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).
      END.
      ELSE DO:
         musz = FALSE. 
         FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
         KALKAONR.DELNR = AONRTAB.DELNR AND 
         KALKAONR.STATUSNIV = "HUV" AND KALKAONR.TYP = 2
         NO-LOCK NO-ERROR.
         IF AVAILABLE KALKAONR THEN DO:
            RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).     
         END.
         ELSE DO:
            FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
            KALKAONR.DELNR = AONRTAB.DELNR AND 
            KALKAONR.STATUSNIV = "HUV" AND KALKAONR.TYP = 3
            NO-LOCK NO-ERROR.
            IF AVAILABLE KALKAONR THEN DO:
              RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).  
            END.
            ELSE DO:
               FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
               KALKAONR.DELNR = AONRTAB.DELNR AND 
               KALKAONR.STATUSNIV = "HUV" AND KALKAONR.TYP = 1
               NO-LOCK NO-ERROR.
               IF AVAILABLE KALKAONR THEN DO:
                  RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).   
               END.
               ELSE DO:
                  FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
                  KALKAONR.DELNR = AONRTAB.DELNR AND 
                  KALKAONR.STATUSNIV = "HUV" AND KALKAONR.TYP = 5
                  NO-LOCK NO-ERROR.
                  IF AVAILABLE KALKAONR THEN DO:
                     RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).   
                  END.
               END.
            END.
         END.
     END. 
     RUN kalksummering_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).      
     IF AVAILABLE kalkhuvtt THEN DO:
        
         CREATE tidut.
         SUBSTRING(tidut.UT,1) = "Kalkylnr:" + STRING(kalkhuvtt.KALKNR).
         CREATE tidut.
         SUBSTRING(tidut.UT,1) = "Benämning:" + kalkhuvtt.BENAMNING.
         CREATE tidut.
         SUBSTRING(tidut.UT,1) = "Kalkyltyp:" + STRING(kalkhuvtt.TYP).
         RUN omrade_UI.
     END.
     ELSE DO:
        CREATE tidut.
        SUBSTRING(tidut.UT,1) = "Det finns ingen kalkyl kopplad till " + Guru.Konstanter:gaok.
        CREATE tidut.
        CREATE tidut.
     END.
  END.   
END PROCEDURE.
{KALKYLUPPSUMMA.I}

PROCEDURE plannr_UI :
   IF kkod.SATS% < 100 THEN 
   SUBSTRING(tidut.UT,43) = STRING(kkod.SATS%).
   EMPTY TEMP-TABLE kalk_temp NO-ERROR. 
   FIND FIRST KALKAONR WHERE KALKAONR.AONR = AONRTAB.AONR AND
   KALKAONR.DELNR = AONRTAB.DELNR AND KALKAONR.STATUSNIV = "UF" 
   NO-LOCK NO-ERROR.   
   IF AVAILABLE KALKAONR THEN DO:
      /*KALKÅR*/
      RUN kalkupp_UI (INPUT KALKAONR.KALKNR,INPUT KALKAONR.OMRADE).
      RUN summeringkalk_UI. 
   END.  
   FOR EACH kalksumsum NO-LOCK:
      ASSIGN 
      bertim = bertim + kalksumsum.BTIMMAR  
      arbtim = arbtim  + kalksumsum.TIMMAR  
      msktim = msktim + kalksumsum.MASKTIMMAR
      totea = totea + kalksumsum.EAMANG
      totarb = totarb + kalksumsum.BELOPP  
      totmask = totmask + kalksumsum.MASKGBELOPP  
      totmtrl = totmtrl + kalksumsum.MTRL
      totovr = totovr + (kalksumsum.OVRKR - kalksumsum.UKOST)  
      totutr = totutr + kalksumsum.UKOST
      totutrtim = totutrtim + kalksumsum.UTIMMAR.       
   END. 
   RUN sidfot_UI.
END PROCEDURE.




