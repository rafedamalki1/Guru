DEF VAR MUSZ AS LOGICAL.
OPEN QUERY AQ FOR EACH AONRTAB WHERE AONRTAB.OMRADE BEGINS "4" no-lock.
get first aq NO-LOCK.
DO WHILE AVAILABLE(AONRTAB):
   MESSAGE AONRTAB.AONR AONRTAB.DELNR.
   FIND FIRST TIDREGITAB WHERE TIDREGITAB.AONR = AONRTAB.AONR AND 
   TIDREGITAB.DELNR = AONRTAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
   IF AVAILABLE TIDREGITAB THEN DO:
      DISPLAY AONRTAB.AONR AONRTAB.DELNR " har tidskrivning "  WITH FRAME CC DOWN.
      DOWN 1 WITH FRAME CC.
      musz = TRUE.
      
   END.
   IF musz = FALSE THEN DO:   
      IF AONRTAB.FAKTNR = 0 THEN musz = FALSE.
      ELSE musz = TRUE.
      FIND FIRST KALKSPEC WHERE KALKSPEC.AONR = AONRTAB.AONR AND
      KALKSPEC.DELNR = AONRTAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF AVAILABLE KALKSPEC THEN DO:
         musz = TRUE.
      END.    
      FIND FIRST FASTSPEC WHERE FASTSPEC.AONR = AONRTAB.AONR AND
      FASTSPEC.DELNR = AONRTAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF AVAILABLE FASTSPEC THEN DO: 
         musz = TRUE.
      END.    
      FIND FIRST BEREDNING WHERE BEREDNING.AONR = AONRTAB.AONR AND 
      BEREDNING.DELNR = AONRTAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF AVAILABLE BEREDNING THEN DO:
         musz = TRUE.
      END.            
      FIND FIRST VARDERING WHERE VARDERING.AONR = AONRTAB.AONR AND
      VARDERING.DELNR = AONRTAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
      IF AVAILABLE VARDERING THEN DO:
         musz = TRUE.
      END.           
      IF musz = TRUE THEN DO:
         DISPLAY AONRTAB.AONR AONRTAB.DELNR " har koppling(ar) " WITH FRAME CC DOWN.
         DOWN 1 WITH FRAME CC.
      END.
      ELSE DO:                                       
         DEFINE QUERY aonrkq FOR AONRKONT.
         OPEN QUERY aonrkq FOR EACH AONRKONT WHERE AONRKONT.AONR = AONRTAB.AONR AND
         AONRKONT.DELNR = AONRTAB.DELNR USE-INDEX AONRKONT NO-LOCK.
         DO TRANSACTION:       
            GET FIRST aonrkq EXCLUSIVE-LOCK.
            IF AVAILABLE AONRKONT THEN DELETE AONRKONT.    
         END.
         REPEAT:  
            DO TRANSACTION:
               GET NEXT aonrkq EXCLUSIVE-LOCK.
               IF AVAILABLE AONRKONT THEN DELETE AONRKONT.    
               ELSE LEAVE.      
            END.         
         END.   
         DEFINE QUERY kostq FOR KOSTREG.
         OPEN QUERY kostq FOR EACH KOSTREG WHERE KOSTREG.AONR = AONRTAB.AONR AND
         KOSTREG.DELNR = AONRTAB.DELNR USE-INDEX KOST NO-LOCK.
         DO TRANSACTION:       
            GET FIRST kostq EXCLUSIVE-LOCK.
            IF AVAILABLE KOSTREG THEN DELETE KOSTREG.    
         END.
         REPEAT:  
            DO TRANSACTION:
               GET NEXT kostq EXCLUSIVE-LOCK.
               IF AVAILABLE KOSTREG THEN DELETE KOSTREG.    
               ELSE LEAVE.      
            END.         
         END.
         DO TRANSACTION:
            GET CURRENT AQ EXCLUSIVE-LOCK.
            DELETE AONRTAB.  
         END.
      END.   
     
   END.
   musz = FALSE.
   GET NEXT AQ NO-LOCK.
END.
