  /*XGRANEKO.P*/
{LESAMMAN.I}  
DEFINE INPUT PARAMETER invkdatum AS DATE NO-UNDO.
DEFINE INPUT PARAMETER ingvisatidpermanad AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE gvisatidpermanad AS LOGICAL NO-UNDO.
RUN sammut_UI (INPUT 1).
ASSIGN
vkdatum     = invkdatum  
gvisatidpermanad   = ingvisatidpermanad. 
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO. 
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO. 
DEFINE VARIABLE ekrid AS RECID EXTENT 50 NO-UNDO.
DEFINE VARIABLE aoomrade LIKE AONRTAB.OMRADE NO-UNDO.          
DEFINE VARIABLE timtid AS DECIMAL FORMAT "99.99" NO-UNDO. 
DEFINE VARIABLE multi AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE berkostnad AS DECIMAL FORMAT "99.99" NO-UNDO.

DEFINE VARIABLE reskod LIKE TIDREGITAB.LONTILLAGG NO-UNDO. 
DEFINE VARIABLE resantal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.
DEFINE VARIABLE resbelopp LIKE EKRAPPRESULT.ELONBELOPP NO-UNDO. 
DEFINE VARIABLE ovkod LIKE TIDREGITAB.OVERTIDTILL NO-UNDO. 
DEFINE VARIABLE ovantal LIKE TIDREGITAB.OVERANTAL NO-UNDO.
DEFINE VARIABLE ovbelopp LIKE EKRAPPRESULT.EOVERBELOPP NO-UNDO. 
DEFINE VARIABLE trakod LIKE TIDREGITAB.TRAKTKOD NO-UNDO. 
DEFINE VARIABLE traantal LIKE TIDREGITAB.TRAKTANTAL NO-UNDO.
DEFINE VARIABLE trabelopp LIKE EKRAPPRESULT.ETRAKTBELOPP NO-UNDO. 
DEFINE VARIABLE lonkod LIKE TIDREGITAB.LONTILLAGG NO-UNDO. 
DEFINE VARIABLE lonantal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.
DEFINE VARIABLE lonbelopp LIKE EKRAPPRESULT.ELONBELOPP NO-UNDO. 
DEFINE VARIABLE berkodvar LIKE TIDREGITAB.BEREDSKAP NO-UNDO. 
DEFINE VARIABLE bbantal LIKE TIDREGITAB.BERANTAL NO-UNDO.
DEFINE VARIABLE berbelopp LIKE EKRAPPRESULT.EBERBELOPP NO-UNDO.
DEFINE VARIABLE pkod LIKE PERSONALTAB.PERSONALKOD NO-UNDO.
DEFINE VARIABLE typover LIKE EKRAPPRESULT.ERESULTENH NO-UNDO. 
DEFINE VARIABLE typdatum LIKE EKRAPPRESULT.ETRANSDATUM NO-UNDO. 
DEFINE VARIABLE kodanst LIKE ANSTFORMTAB.KOD NO-UNDO.
DEFINE NEW SHARED TEMP-TABLE ekoforst
   FIELD ENY LIKE EKRAPPRESULT.ENY 
   FIELD EPERSONALKOD LIKE EKRAPPRESULT.EPERSONALKOD 
   FIELD EPROJEKT LIKE EKRAPPRESULT.EPROJEKT 
   FIELD EORG LIKE EKRAPPRESULT.EORG  
   FIELD EGEO LIKE EKRAPPRESULT.EGEO      
   FIELD ETRANSDATUM LIKE EKRAPPRESULT.ETRANSDATUM
   FIELD EOVERJA LIKE EKRAPPRESULT.EOVERJA
   FIELD ERESULTENH LIKE EKRAPPRESULT.ERESULTENH 
   FIELD EBELOPP LIKE  EKRAPPRESULT.EBELOPP 
   FIELD EANTAL  LIKE EKRAPPRESULT.EANTAL 	       
   FIELD ELONTILLAGG LIKE EKRAPPRESULT.ELONTILLAGG 
   FIELD ELONTILLANTAL LIKE EKRAPPRESULT.ELONTILLANTAL    
   FIELD ELONBELOPP LIKE EKRAPPRESULT.ELONBELOPP         
   INDEX PERSORG IS PRIMARY EPERSONALKOD EORG EGEO EPROJEKT ASCENDING.

/* OM FRÅNVARO AONR ANVÄDS STYR PRISTYPEN*/
pkod = "".
OPEN QUERY persq FOR EACH PERSONALTAB WHERE PERSONALTAB.BRAVO = TRUE 
USE-INDEX PERSONALKOD NO-LOCK.
GET FIRST persq NO-LOCK.
DO WHILE AVAILABLE(PERSONALTAB):
   musz = FALSE.
   aoomrade = "".
   persrec = RECID(PERSONALTAB).   
   IF pkod NE PERSONALTAB.PERSONALKOD THEN DO:
      pkod = PERSONALTAB.PERSONALKOD.        
      persrec = RECID(PERSONALTAB).
      FIND FIRST ANSTFORMTAB WHERE
      ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
      USE-INDEX ANSTF NO-LOCK NO-ERROR.  
      /*OBS ! ÄNDRING TJÄNSTEMÄN SKA ÖVER OM DE SKRIVER PÅ "DEB.TJM."
      IF ANSTFORMTAB.KOD = 'T' OR  
         ANSTFORMTAB.KOD = 'T1' OR 
         ANSTFORMTAB.KOD = 'T2' OR 
         ANSTFORMTAB.KOD = 'T3' OR 
         ANSTFORMTAB.KOD = 'T4' OR 
         ANSTFORMTAB.KOD = 'T5' THEN DO:
         IF PERSONALTAB.BEFATTNING = "DRIFTTEKNIKER" OR 
            PERSONALTAB.BEFATTNING = "MÄTTEKNIKER" OR
            PERSONALTAB.BEFATTNING = "BEREDARE"  THEN musz = musz.
         ELSE musz = TRUE.
      END.*/
      
      kodanst = ANSTFORMTAB.KOD.
   END.
   IF musz = FALSE THEN DO: 
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.VECKOKORD = "w20030206" AND
      TIDREGITAB.DATUM <= vkdatum
      USE-INDEX PSTART NO-LOCK. 
      GET FIRST tidq NO-LOCK.
      DO WHILE AVAILABLE(TIDREGITAB):                            
         musz = FALSE.   
         IF TIDREGITAB.PRISTYP = 'FRÅNVARO.' THEN DO: 
 	         musz = TRUE.	        	      	       
	      END.
         ELSE IF TIDREGITAB.PRISTYP = 'RESTID...' THEN DO: 
 	         musz = TRUE.	        	      	       
	      END.
         /*"EJ DEBI.."*/
	      ELSE IF TIDREGITAB.PRISTYP = 'EJ DEBI..' THEN DO: 
            musz = TRUE.	        	      	       
            /*
            IF ANSTFORMTAB.KOD BEGINS 'T' THEN DO:
	        IF PERSONALTAB.BEFATTNING = "DRIFTTEKNIKER" OR 
            PERSONALTAB.BEFATTNING    = "MÄTTEKNIKER"   OR
            PERSONALTAB.BEFATTNING    = "BEREDARE" 
            THEN DO:
                /* Dessa personer ska bara över på tot.pris och beredare*/
               IF TIDREGITAB.PRISTYP = "TOT.PRIS." THEN musz = musz.
               ELSE IF TIDREGITAB.PRISTYP = "BEREDARE." THEN musz = musz.
               ELSE IF TIDREGITAB.PRISTYP = "DRIFTCENT" THEN musz = musz.
               ELSE IF TIDREGITAB.PRISTYP = "ARBETSLED" THEN musz = TRUE.
               ELSE IF TIDREGITAB.PRISTYP = "PROJEKTÖR" THEN musz = TRUE.
               ELSE IF TIDREGITAB.PRISTYP = "EJ DEBI.." THEN musz = TRUE.
               ELSE musz = TRUE.               
            END.
            ELSE DO:   
               /*övriga tjänstemän ska bara över på  "deb.tjm."*/
               IF TIDREGITAB.PRISTYP = "TOT.PRIS." THEN musz = TRUE.	 
               ELSE IF TIDREGITAB.PRISTYP = "DRIFTCENT" THEN musz = musz.
	            ELSE IF TIDREGITAB.PRISTYP = "DEB.TJM.." THEN musz = musz.
	            ELSE IF TIDREGITAB.PRISTYP = "EJ DEBI.." THEN musz = TRUE.  
	            ELSE musz = TRUE.     	      	       
	         END.   
            */
	      END.             
	      IF musz = FALSE THEN DO:
            FIND FIRST AONRTAB WHERE AONRTAB.AONR = TIDREGITAB.AONR AND
            AONRTAB.DELNR = TIDREGITAB.DELNR USE-INDEX AONR NO-LOCK NO-ERROR.
            IF NOT AVAILABLE AONRTAB THEN DO:
               aoomrade = PERSONALTAB.OMRADE. 
               IF TIDREGITAB.AONR = "" THEN aoomrade = PERSONALTAB.OMRADE. 
               ELSE DO:
                  MESSAGE CAPS(Guru.Konstanter:gaol) TIDREGITAB.AONR TIDREGITAB.DELNR "FINNS EJ! KONTAKTA ELPOOL"
                  VIEW-AS ALERT-BOX.
               END.
            END.    
            ELSE DO:
               aoomrade = AONRTAB.OMRADE.   
               IF AONRTAB.OMRADE = "" THEN aoomrade = PERSONALTAB.OMRADE.                  
            END.                      	 	 
            typdatum = DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).  
            FIND FIRST ekoforst WHERE ekoforst.ENY = FALSE AND
            ekoforst.EPERSONALKOD = TIDREGITAB.PERSONALKOD AND 
            ekoforst.EORG = PERSONALTAB.OMRADE AND 
            ekoforst.EGEO = aoomrade AND
            ekoforst.EPROJEKT = TIDREGITAB.AONR AND         
            ekoforst.ETRANSDATUM = typdatum      
            USE-INDEX PERSORG NO-LOCK NO-ERROR.
            IF NOT AVAILABLE ekoforst THEN DO TRANSACTION:
               CREATE ekoforst.
	            ASSIGN 
	            ekoforst.ENY = FALSE
	            ekoforst.EPERSONALKOD = TIDREGITAB.PERSONALKOD
	            ekoforst.EPROJEKT = TIDREGITAB.AONR 
	            ekoforst.EORG = PERSONALTAB.OMRADE  
   	         ekoforst.EGEO = aoomrade 	    	    
	            ekoforst.ETRANSDATUM = typdatum.
            END.                                             
            ekrid[1] = RECID(ekoforst).
	        /*TIDREGISTRERING*/	          	       
	        /*TIMMAR OCH PENNGAR*/  
	        DO TRANSACTION:
	           FIND ekoforst WHERE RECID(ekoforst) = ekrid[1]
	           EXCLUSIVE-LOCK NO-ERROR.                                    
	           ASSIGN ekoforst.EOVERJA = FALSE. 	       
	           IF ekoforst.EOVERJA = FALSE AND TIDREGITAB.TOTALT > 0 THEN DO:		  
  	 	           nytid = TIDREGITAB.TOTALT.
		           RUN TIMSEK.P.
		           timtid = (sekunder / 3600).
		           ASSIGN ekoforst.EBELOPP = ekoforst.EBELOPP +
  		           (TIDREGITAB.PRIS * timtid)
		           ekoforst.EANTAL = ekoforst.EANTAL + timtid.
	           END.
	        END.	    
	     END.
	     GET NEXT tidq NO-LOCK.
      END.
   END.  /*ELSE DO*/
   GET NEXT persq NO-LOCK.
END.   /*FOR EACH*/     

RUN xGRANEKO2.P.   
RUN sammut_UI (INPUT 2). 
