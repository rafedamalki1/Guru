/*STEG6.P EXTRA KÖRNING LULEÅ FÖR ATT ÅTERSTÄLLA PRISER SOM DE VAR INNAN UPPDATERINGEN 20061127*/
DEFINE VARIABLE prisvar AS DECIMAL NO-UNDO.

DEFINE TEMP-TABLE tidinah
   FIELD ENR                AS CHARACTER       
   FIELD BENAMNING          AS CHARACTER 
   FIELD ENHET              AS CHARACTER
   FIELD PRIS               AS DECIMAL        
   INDEX ENR IS PRIMARY ENR.

DEFINE TEMP-TABLE tidinai
   FIELD ENR                AS CHARACTER       
   FIELD BENAMNING          AS CHARACTER 
   FIELD ENHET              AS CHARACTER
   FIELD PRIS               AS DECIMAL        
   INDEX ENR IS PRIMARY ENR.

  

DEFINE TEMP-TABLE infil
   FIELD PROGNAMN AS CHARACTER FORMAT "X(78)" 
   INDEX PRO IS PRIMARY PROGNAMN.

DEFINE VARIABLE filnamn AS CHARACTER NO-UNDO.   
 
{muswait.i} 
OUTPUT TO D:\ELPOOL\DELAD\PRO9\koll.txt APPEND.
PUT "Start KÖRNING. " SKIP.
OUTPUT CLOSE.
ASSIGN
filnamn = "D:\ELPOOL\DELAD\PRO9\FÖRE.skv".

EMPTY TEMP-TABLE tidinah NO-ERROR.
{AMERICANEUROPEAN.I}
SESSION:NUMERIC-FORMAT = "EUROPEAN".
INPUT FROM VALUE(filnamn) NO-ECHO.
REPEAT:
   DO TRANSACTION: 
      CREATE tidinah.
      ASSIGN.
      IMPORT DELIMITER ";" tidinah   NO-ERROR.
   END.               
END.   
FOR EACH tidinah WHERE tidinah.ENR = "":
   DELETE tidinah.
END.            

ASSIGN
filnamn = "D:\ELPOOL\DELAD\PRO9\EFTER.skv".

EMPTY TEMP-TABLE tidinai NO-ERROR.

INPUT FROM VALUE(filnamn) NO-ECHO.
REPEAT:
   DO TRANSACTION: 
      CREATE tidinai.
      ASSIGN.
      IMPORT DELIMITER ";" tidinai   NO-ERROR.
   END.               
END.   
FOR EACH tidinai WHERE tidinai.ENR = "":
   DELETE tidinai.
END.            
      
OUTPUT TO D:\ELPOOL\DELAD\PRO9\koll.txt APPEND.
PUT "Inläsning filer klart. " SKIP.
OUTPUT CLOSE.

SESSION:NUMERIC-FORMAT = "AMERICAN".

OUTPUT TO d:\elpool\DELAD\PRO9\steg6.txt.
FOR EACH tidinah USE-INDEX ENR NO-LOCK:
   FIND FIRST tidinai WHERE tidinai.ENR = tidinah.ENR NO-LOCK.
   FIND FIRST MTRLDEP WHERE MTRLDEP.DEPNR = 1 AND MTRLDEP.ENR = tidinah.ENR AND MTRLDEP.IBDATUM = ?
   NO-LOCK NO-ERROR.
   IF AVAILABLE MTRLDEP THEN
   PUT tidinah.ENR ";" tidinah.BENAMNING FORMAT "X(40)" ";" tidinah.ENHET ";" tidinah.PRIS ";" tidinai.PRIS ";" MTRLDEP.NPRIS ";" SKIP.
   ELSE
   PUT tidinah.ENR ";" tidinah.BENAMNING FORMAT "X(40)" ";" tidinah.ENHET ";" tidinah.PRIS ";" tidinai.PRIS ";" ";" SKIP.
   OPEN QUERY qbest FOR EACH BESTDEP WHERE BESTDEP.DEPNR = 1 AND BESTDEP.ENR = tidinah.ENR AND
   BESTDEP.LEVDATUM > 11/27/06 AND BESTDEP.LEVDATUM NE ? AND BESTDEP.BERED = FALSE NO-LOCK BY BESTDEP.LEVDATUM.
   GET FIRST qbest NO-LOCK.
   DO WHILE AVAILABLE(BESTDEP):           
      PUT ";" BESTDEP.LEVDATUM ";" BESTDEP.ANTAL ";" ";" ";" ";" BESTDEP.PRIS SKIP.
      GET NEXT qbest NO-LOCK. 
   END.  
   CLOSE QUERY qbest.
END.
OUTPUT CLOSE.

{EUROPEANAMERICAN.I}