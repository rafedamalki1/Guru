/*XFLERDAGBEST.P*/
DEFINE BUFFER lbuff FOR LEVTRP.
FOR EACH BEREDNING NO-LOCK:
   FIND FIRST BERMTRL WHERE BERMTRL.OMRADE = BEREDNING.OMRADE AND BERMTRL.AONR = STRING(BEREDNING.BERNR) 
   AND BERMTRL.INKOP = TRUE AND BERMTRL.KLAR = FALSE NO-LOCK NO-ERROR.
   IF AVAILABLE BERMTRL THEN DO:
      FOR EACH BERUPP WHERE BERUPP.OMRADE = BEREDNING.OMRADE AND BERUPP.AONR = STRING(BEREDNING.BERNR) AND BERUPP.ANTALRADER = INTEGER(BERMTRL.DATUM): 
         BERUPP.DELNR = 1000.
      END.
      FOR EACH BERLINKAB WHERE BERLINKAB.OMRADE = BEREDNING.OMRADE AND BERLINKAB.AONR = STRING(BEREDNING.BERNR) AND BERLINKAB.DATUM = BERMTRL.DATUM: 
         BERLINKAB.DELNR = 1000.
      END.
      FOR EACH BERVAL WHERE BERVAL.OMRADE = BEREDNING.OMRADE AND BERVAL.AONR = STRING(BEREDNING.BERNR) AND BERVAL.ORT = STRING(BERMTRL.DATUM): 
         BERVAL.DELNR = 1000.
      END.
      FOR EACH LEVTRP2 WHERE LEVTRP2.OMRADE = BEREDNING.OMRADE AND LEVTRP2.BERNR = BEREDNING.BERNR AND LEVTRP2.DATUM = BERMTRL.DATUM NO-LOCK:
         FIND FIRST lbuff WHERE lbuff.OMRADE = LEVTRP2.OMRADE AND lbuff.BERNR = LEVTRP2.BERNR AND 
         lbuff.LEVKOD = LEVTRP2.LEVKOD 
         NO-LOCK NO-ERROR.
         CREATE LEVTRP.
         BUFFER-COPY lbuff TO LEVTRP.
         ASSIGN
         LEVTRP.BESTNR = LEVTRP2.BESTNR
         SUBSTRING(LEVTRP.LEVERANS,1,15) = STRING(INTEGER(BERMTRL.DATUM)) 
         SUBSTRING(LEVTRP.LEVERANS,20,15) = STRING(1000).          
      END.
      FOR EACH LEVTRP WHERE LEVTRP.OMRADE = BEREDNING.OMRADE AND LEVTRP.BERNR = BEREDNING.BERNR AND LEVTRP.LEVERANS = "":
         DELETE LEVTRP.
      END.
      FOR EACH LEVTRP2 WHERE LEVTRP2.OMRADE = BEREDNING.OMRADE AND LEVTRP2.BERNR = BEREDNING.BERNR AND LEVTRP2.DATUM = BERMTRL.DATUM NO-LOCK:
         FOR EACH BESTSTAT WHERE BESTSTAT.OMRADE = LEVTRP2.OMRADE AND BESTSTAT.BERNR = LEVTRP2.BERNR AND BESTSTAT.LEVKOD = LEVTRP2.LEVKOD:
            ASSIGN
            BESTSTAT.BESTNR = LEVTRP2.BESTNR.            
         END.
      END.
   END.
   FOR EACH BERMTRL WHERE BERMTRL.OMRADE = BEREDNING.OMRADE AND BERMTRL.AONR = STRING(BEREDNING.BERNR) 
      AND BERMTRL.INKOP = TRUE AND BERMTRL.KLAR = FALSE:
      BERMTRL.DELNR = 1000.
   END.
END.
