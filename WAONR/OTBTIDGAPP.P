/*OTBTIDGAPP.P*/
FUNCTION klockan100 RETURNS DECIMAL
  ( INPUT ber60 AS DECIMAL ):

  RETURN  (TRUNCATE(ber60,0) * 3600 + (ber60 - TRUNCATE(ber60,0)) * 100 * 60) / 3600.

END FUNCTION.




FUNCTION klockan60 RETURNS DECIMAL
  ( INPUT ber100 AS DECIMAL ):
  RETURN TRUNCATE(ber100,0) + ((ber100 - TRUNCATE(ber100,0)) / 100) * 60 . 

END FUNCTION.
{TIDUTTT.I}
DEFINE TEMP-TABLE vispers
   FIELD PERSONALKOD LIKE PERSONALTAB.PERSONALKOD
   FIELD FORNAMN LIKE PERSONALTAB.FORNAMN 
   FIELD EFTERNAMN LIKE PERSONALTAB.EFTERNAMN
   INDEX PKOD IS PRIMARY PERSONALKOD.
DEFINE TEMP-TABLE valtemp
   FIELD VALDLISTA AS CHARACTER
   FIELD BAVAL AS INTEGER
   FIELD ALLTID AS LOGICAL
   FIELD STARTDATUM AS DATE
   FIELD SLUTDATUM AS DATE.
   {PERSOTB.I}


DEFINE VARIABLE pkod AS CHARACTER NO-UNDO.
DEFINE VARIABLE utnr AS INTEGER EXTENT 50 NO-UNDO.
 


PROCEDURE persotbhmt_UI:
   DEFINE INPUT PARAMETER TABLE FOR valtemp.
   DEFINE INPUT PARAMETER TABLE FOR vispers.      
   DEFINE OUTPUT PARAMETER TABLE FOR persotb.
   
   FIND FIRST valtemp NO-ERROR.
   RUN open_UI.   
END PROCEDURE.

PROCEDURE sppersotb_UI:
   DEFINE INPUT-OUTPUT PARAMETER TABLE FOR epersotb.
   FIND FIRST epersotb NO-LOCK NO-ERROR.
   IF AVAILABLE epersotb THEN DO TRANSACTION:    
      FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = epersotb.PERSONALKOD AND TIDREGITAB.PERSONALKOD = epersotb.PERSONALKOD AND TIDREGITAB.DATUM = epersotb.DATUM AND
      TIDREGITAB.START = epersotb.START AND TIDREGITAB.SLUT = epersotb.SLUT AND TIDREGITAB.TIDLOG = TRUE EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE TIDREGITAB THEN DO:
         ASSIGN 
         TIDREGITAB.LAGBAS = epersotb.GKAND.          
         SUBSTRING(TIDREGITAB.PROGRAM,159,40) = epersotb.GKANDVEMNAR.         
      END.   
   END.
   RELEASE TIDREGITAB.             
END PROCEDURE.




PROCEDURE open_UI :
   OPEN QUERY vpq FOR EACH vispers NO-LOCK. 
   GET FIRST vpq NO-LOCK.
   DO WHILE AVAILABLE(vispers): 
      IF valtemp.BAVAL = 1 OR valtemp.BAVAL = 11 OR valtemp.BAVAL = 2 OR valtemp.BAVAL = 12 THEN  DO:
         IF valtemp.ALLTID = FALSE THEN DO:
            OPEN QUERY otbq FOR EACH TIDREGITAB WHERE TIDREGITAB.VECKOKORD = "" AND  TIDREGITAB.GODKAND  = "" AND  TIDREGITAB.TIDLOG = TRUE
            AND SUBSTRING(TIDREGITAB.RESMAL,159,6) = vispers.PERSONALKOD  NO-LOCK.       
          END.         
          ELSE DO:
             OPEN QUERY otbq FOR EACH TIDREGITAB WHERE TIDREGITAB.TIDLOG = TRUE
             AND SUBSTRING(TIDREGITAB.RESMAL,159,6) = vispers.PERSONALKOD AND
             TIDREGITAB.DATUM >= valtemp.STARTDATUM AND
             TIDREGITAB.DATUM <= valtemp.SLUTDATUM NO-LOCK.          
           END.
         END.      
         GET FIRST otbq NO-LOCK.
         DO WHILE AVAILABLE(TIDREGITAB):  
            CREATE persotb.
            ASSIGN
               persotb.PERSONALKOD = TIDREGITAB.PERSONALKOD
               persotb.DATUM       = TIDREGITAB.DATUM
               persotb.START       = TIDREGITAB.START
               persotb.SLUT        = TIDREGITAB.SLUT
               persotb.TOTALT      = TIDREGITAB.TOTALT
               persotb.AONR        = TIDREGITAB.AONR
               persotb.DELNR       = TIDREGITAB.DELNR
               persotb.GODKAND       = TIDREGITAB.GODKAND
               persotb.OTB         = SUBSTRING(TIDREGITAB.RESMAL,159,6)
               persotb.KOMMENTAR   = SUBSTRING(TIDREGITAB.RESMAL,1,158)
               persotb.GKAND =  TIDREGITAB.LAGBAS       
               persotb.GKANDVEMNAR = SUBSTRING(TIDREGITAB.PROGRAM,159).
            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = TIDREGITAB.PERSONALKOD  NO-LOCK NO-ERROR.
            IF AVAILABLE PERSONALTAB THEN DO:
               ASSIGN
               persotb.FORNAMN    = PERSONALTAB.FORNAMN
               persotb.EFTERNAMN  = PERSONALTAB.EFTERNAMN
               persotb.GODKANNARE = PERSONALTAB.TIDSGODK.               
            END.
            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = persotb.OTB  NO-LOCK NO-ERROR.
            IF AVAILABLE PERSONALTAB THEN DO:
               ASSIGN  persotb.OTBNAMN    = SUBSTRING(PERSONALTAB.FORNAMN,1,1) + "." + PERSONALTAB.EFTERNAMN.
            END.

            FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = persotb.GODKANNARE  NO-LOCK NO-ERROR.
            IF AVAILABLE PERSONALTAB  THEN DO:
               ASSIGN  persotb.GNAMN    = SUBSTRING(PERSONALTAB.FORNAMN,1,1) + "." + PERSONALTAB.EFTERNAMN.
            END.    
                      
            GET NEXT otbq NO-LOCK.
         END.
         
         GET NEXT vpq NO-LOCK.
      END.    
   
   END PROCEDURE.
