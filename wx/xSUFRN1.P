    /*XSUFRN1.P*/
{LESAMMAN.I}  
DEFINE INPUT PARAMETER kordatum AS DATE NO-UNDO.
DEFINE INPUT PARAMETER koranv LIKE ANVANDARE.ANVANDARE NO-UNDO.
DEFINE INPUT PARAMETER gkorvar AS CHARACTER NO-UNDO.
RUN sammut_UI (INPUT 1).
&Scoped-define NEW NEW
&Scoped-define SHARED SHARED
{LONEDEF.I}
DEFINE NEW SHARED VARIABLE globanv LIKE ANVANDARE.ANVANDARE NO-UNDO.
DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE vkdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE gvisatidpermanad AS LOGICAL NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE regstart LIKE TIDREGITAB.START NO-UNDO. 
DEFINE NEW SHARED VARIABLE regslut LIKE TIDREGITAB.SLUT NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.        
DEFINE NEW SHARED VARIABLE regtotalt LIKE TIDREGITAB.TOTALT NO-UNDO.
DEFINE NEW SHARED VARIABLE frustarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE fruslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffestart AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE kaffeslut AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchstarten AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE lunchslutet AS DECIMAL NO-UNDO.
DEFINE NEW SHARED VARIABLE korvar AS CHARACTER NO-UNDO.


DEFINE VARIABLE onr LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE onr2 LIKE TIDREGITAB.AONR NO-UNDO.
DEFINE VARIABLE dnr LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE dnr2 LIKE TIDREGITAB.DELNR NO-UNDO.
DEFINE VARIABLE starttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE sluttiden AS INTEGER NO-UNDO.
DEFINE VARIABLE antal LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE antal2 LIKE TIDREGITAB.LONTILLANTAL NO-UNDO.   /*LON*/
DEFINE VARIABLE antalet LIKE PHJALP.PPAR8 NO-UNDO.   /*LON*/
DEFINE VARIABLE personal LIKE PERSONALTAB.PERSONALKOD NO-UNDO.
DEFINE VARIABLE pnr LIKE PERSONALTAB.PERSONNUMMER NO-UNDO.      /*LON*/
DEFINE VARIABLE vecknr LIKE TIDREGITAB.VECKONUMMER NO-UNDO.      /*LON*/
DEFINE VARIABLE pc LIKE FVARO.PROC NO-UNDO.
DEFINE VARIABLE fkod LIKE FVARO.FRKOD NO-UNDO.
DEFINE VARIABLE del1 LIKE FVARO.DEL NO-UNDO.
DEFINE VARIABLE regdatum2 AS DATE NO-UNDO.  
DEFINE VARIABLE regdat3 AS DATE NO-UNDO.
DEFINE VARIABLE regdat4 AS DATE NO-UNDO. 
DEFINE VARIABLE regdat5 AS DATE NO-UNDO.
DEFINE VARIABLE rec AS RECID NO-UNDO.
DEFINE VARIABLE tott1 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE tott2 AS INTEGER NO-UNDO.
DEFINE VARIABLE tott3 AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE VARIABLE tott4 AS INTEGER NO-UNDO.
DEFINE VARIABLE proc1 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE proc2 AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE seku AS INTEGER NO-UNDO.
DEFINE VARIABLE anst LIKE ANSTFORM.KOD NO-UNDO.
DEFINE VARIABLE krav AS INTEGER FORMAT "9" NO-UNDO.
DEFINE VARIABLE frstart LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE frslut LIKE TIDREGITAB.START NO-UNDO.
DEFINE VARIABLE avdatum AS DATE NO-UNDO.
DEFINE VARIABLE komptid AS DECIMAL FORMAT "999.9" NO-UNDO.
DEFINE VARIABLE musz AS LOGICAL NO-UNDO.
DEFINE VARIABLE dagnr AS INTEGER NO-UNDO. 
DEFINE VARIABLE kommentar AS CHARACTER NO-UNDO.
DEFINE VARIABLE arbdg AS INTEGER NO-UNDO.
DEFINE VARIABLE dagtot AS DECIMAL NO-UNDO.

DEFINE BUFFER frbuff FOR TIDREGITAB.
DEFINE NEW SHARED TEMP-TABLE frvarotemp
   FIELD PERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD TIMMAR AS DECIMAL FORMAT "99999.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"
   FIELD STARTKL LIKE TIDREGITAB.START
   FIELD SLUTKL LIKE TIDREGITAB.SLUT
   FIELD NAMN AS CHARACTER
   FIELD TIMMAR2 LIKE TIDREGITAB.LONTILLANTAL
   FIELD PROCENT2 AS DECIMAL FORMAT "999.9"   
   FIELD KOMMENTAR AS CHARACTER
   FIELD ARBDAGAR AS INTEGER
   FIELD TOTTIMMAR AS DECIMAL
   INDEX FRANVARO IS PRIMARY  PERSONNUMMER FRAN LART ASCENDING.
DEFINE TEMP-TABLE frvarotempsj NO-UNDO LIKE frvarotemp.
DEFINE TEMP-TABLE frfel
   FIELD PERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD FRAN LIKE TIDREGITAB.DATUM
   FIELD TILL LIKE TIDREGITAB.DATUM
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD TIMMAR AS DECIMAL FORMAT "99.99"
   FIELD LART AS CHARACTER FORMAT "X(4)"
   INDEX FRANVARO IS PRIMARY  PERSONNUMMER FRAN LART ASCENDING. 

/*
DEFINE NEW SHARED TEMP-TABLE lonefil
   FIELD PPERSONNUMMER LIKE PERSONALTAB.PERSONNUMMER
   FIELD START LIKE TIDREGITAB.START
   FIELD SLUT LIKE TIDREGITAB.SLUT
   FIELD PLONTILLAGG LIKE TIDREGITAB.LONTILLAGG
   FIELD PLONTILLANTAL LIKE TIDREGITAB.LONTILLANTAL
   FIELD POVERTIDTILL LIKE TIDREGITAB.OVERTIDTILL
   FIELD POVERANTAL LIKE TIDREGITAB.OVERANTAL
   FIELD PTRAKTKOD LIKE TIDREGITAB.TRAKTKOD
   FIELD PTRAKTANTAL LIKE TIDREGITAB.TRAKTANTAL
   FIELD PBEREDSKAP LIKE TIDREGITAB.BEREDSKAP
   FIELD PBERANTAL LIKE TIDREGITAB.BERANTAL
   FIELD PDATUM LIKE TIDREGITAB.DATUM
   FIELD SLUTDATUM LIKE TIDREGITAB.DATUM INITIAL ?
   FIELD PVECKONUMMER LIKE TIDREGITAB.VECKONUMMER
   FIELD MANAD AS INTEGER
   FIELD PSORT AS CHARACTER FORMAT "XX"
   FIELD PPAR8 AS DECIMAL FORMAT "-99.99"
   FIELD AONR LIKE TIDREGITAB.AONR
   FIELD DELNR LIKE TIDREGITAB.DELNR
   FIELD PAVTAL AS CHARACTER
   FIELD TID AS LOGICAL
   FIELD BERKOLL AS LOGICAL INITIAL FALSE
   FIELD PROCENT AS DECIMAL FORMAT "999.9"
   FIELD NAMN AS CHARACTER
   FIELD RESMAL AS CHARACTER
   FIELD ERSATTNING AS DECIMAL 
   INDEX PPERSONNUMMER IS PRIMARY PPERSONNUMMER ASCENDING PLONTILLAGG POVERTIDTILL PTRAKTKOD PBEREDSKAP PDATUM.
   */
DEFINE BUFFER fbuff FOR  frvarotemp .
DEFINE INPUT PARAMETER TABLE FOR lonefil.
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
ASSIGN
globforetag = FORETAG.FORETAG
globanv = koranv
vkdatum = kordatum
gvisatidpermanad = TRUE
korvar = gkorvar.


OPEN QUERY persq FOR EACH PERSONALTAB WHERE PERSONALTAB.PERSMASK = TRUE 
AND PERSONALTAB.BRAVO = TRUE USE-INDEX PERSONALKOD NO-LOCK.
GET FIRST persq NO-LOCK.
DO WHILE AVAILABLE(PERSONALTAB):
   persrec = RECID(PERSONALTAB).
   personal = PERSONALTAB.PERSONALKOD.
   pnr = PERSONALTAB.PERSONNUMMER.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
   PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
   anst = ANSTFORMTAB.KOD.
   IF gvisatidpermanad = TRUE THEN DO:
      OPEN QUERY tidq FOR EACH TIDREGITAB WHERE
      TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND
      TIDREGITAB.GODKAND BEGINS "G" AND TIDREGITAB.VECKOKORD = korvar AND
      TIDREGITAB.DATUM <= vkdatum AND TIDREGITAB.TIDLOG = TRUE
      USE-INDEX PSTART NO-LOCK. 
   END.   
  
    
   GET FIRST tidq NO-LOCK.         
   DO WHILE AVAILABLE(TIDREGITAB):         
      krav = 0.             
      FIND FIRST FRDEL WHERE FRDEL.PERSONALKOD = personal AND
      FRDEL.AONR = TIDREGITAB.AONR USE-INDEX FRDEL NO-LOCK NO-ERROR.
      IF AVAILABLE FRDEL THEN DO:
         onr = FRDEL.AONR.
         dnr = FRDEL.DELNR.
         krav = 1.
      END.   
      FIND FIRST FVARO WHERE FVARO.AONR = TIDREGITAB.AONR
      AND FVARO.DELNR = TIDREGITAB.DELNR USE-INDEX FVARO NO-LOCK NO-ERROR.
      IF NOT AVAILABLE FVARO THEN krav = 1. 
      regdatum = TIDREGITAB.DATUM.
      regvnr = TIDREGITAB.VECKONUMMER.
      RUN SLUTARB.P.
      IF regstart = regslut THEN krav = 1.
      IF regstart NE regslut THEN DO:
         IF TIDREGITAB.START GE regslut AND TIDREGITAB.SLUT > regslut THEN krav = 1.
         IF TIDREGITAB.START < regstart AND TIDREGITAB.SLUT LE regstart THEN krav = 1.
      END.   
      IF krav = 0 THEN DO:  
         ASSIGN
         rec = RECID(TIDREGITAB)
         onr2 = TIDREGITAB.AONR
         dnr2 = TIDREGITAB.DELNR
         kommentar = TIDREGITAB.RESMAL.
         FIND FIRST FVARO WHERE FVARO.AONR = onr2
         AND FVARO.DELNR = dnr2 USE-INDEX FVARO NO-LOCK NO-ERROR.
         IF AVAILABLE FVARO THEN DO TRANSACTION:	
            ASSIGN
            fkod = FVARO.FRKOD
	         pc = FVARO.PROC
	         del1 = FVARO.DEL   /* ti-timmar pr-procent he-heldag */
            frstart = TIDREGITAB.START
            frslut = TIDREGITAB.SLUT. 
            FIND LAST frvarotemp WHERE frvarotemp.PERSONNUMMER = pnr AND
	         frvarotemp.AONR = onr2 AND frvarotemp.DELNR = dnr2
	         USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
            IF NOT AVAILABLE frvarotemp THEN DO:
	            regdatum = TIDREGITAB.DATUM.
	            regvnr = TIDREGITAB.VECKONUMMER.
	            RUN SLUTARB.P.
	            nytid = regstart.
	            RUN TIMSEK.P.              /* raknar ut totala tiden */
	            starttiden = sekunder.
	            nytid = regslut.
               RUN TIMSEK.P.
               sluttiden = sekunder.
               regdatum = TIDREGITAB.DATUM.
               regvnr = TIDREGITAB.VECKONUMMER.
     	         RUN NORDFTO.P.
     	         tott1 = nytid.
     	        RUN TIMSEK.P.
     	        tott2 = sekunder.
     	        IF regstart = regslut THEN DO:  /*FRÅNVAROREG  HELGDAG*/
     	          ASSIGN
     	          proc1 = 000
     	          antal = 0. 
     	        END.  
	           ELSE IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
	           THEN DO:
	              nytid = TIDREGITAB.TOTALT.
	              RUN TIMSEK.P.
	              IF tott2 LE 0 THEN proc1 = 0.
	              ELSE DO:
	                 proc1 = 100 * sekunder / tott2.
               
	              END.   	           
	              IF pc NE TRUE THEN DO:  /* PROCENT SKALL UT*/	           	              
                     antal = TIDREGITAB.TOTALT.
	              END.
	           END.	        
	           ELSE DO:
	              ASSIGN
	              proc1 = 100              
                 antal = TIDREGITAB.TOTALT.
	          END.
             /*Avrunda inte atk och komp */
              IF  TIDREGITAB.AONR = "170" THEN DO:
                  nytid = antal.
                  RUN TIMSEK.P.
                  antal2 = sekunder / 3600.
                  nytid = tott1.
                  RUN TIMSEK.P.
                  tott3 = sekunder / 3600.                 
              END.
              ELSE IF  TIDREGITAB.AONR = "160" THEN DO:                 
                  /* aldrig frånvaro mer än en hel dag*/
                 IF antal > tott1 THEN antal = tott1.
                 IF ( tott1 - TRUNCATE(tott1,0)) GE 0 AND ( tott1 - TRUNCATE(tott1,0)) < 0.08 THEN tott3 = TRUNCATE(tott1,0).
                 ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.08  AND ( tott1 - TRUNCATE(tott1,0)) < 0.23 THEN tott3 = TRUNCATE(tott1,0) + 0.25.
                 ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.23  AND ( tott1 - TRUNCATE(tott1,0)) < 0.38 THEN tott3 = TRUNCATE(tott1,0) + 0.50.
                 ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.38  AND ( tott1 - TRUNCATE(tott1,0)) < 0.53 THEN tott3 = TRUNCATE(tott1,0) + 0.75.
                 ELSE  IF ( tott1 - TRUNCATE(tott1,0)) GE 0.53  THEN tott3 = TRUNCATE(tott1,0) + 1.                            
                 IF ( antal - TRUNCATE(antal,0)) GE 0 AND ( antal - TRUNCATE(antal,0)) < 0.08 THEN antal2 = TRUNCATE(antal,0).
                 ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.08  AND ( antal - TRUNCATE(antal,0)) < 0.23 THEN antal2 = TRUNCATE(antal,0) + 0.25.
                 ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.23  AND ( antal - TRUNCATE(antal,0)) < 0.38 THEN antal2 = TRUNCATE(antal,0) + 0.50.
                 ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.38  AND ( antal - TRUNCATE(antal,0)) < 0.53 THEN antal2 = TRUNCATE(antal,0) + 0.75.
                 ELSE  IF ( antal - TRUNCATE(antal,0)) GE 0.53  THEN antal2 = TRUNCATE(antal,0) + 1.                                             
              END.
              ELSE DO:                 
                 /* aldrig frånvaro mer än en hel dag*/
                 IF antal > tott1 THEN antal = tott1.
                 IF ( tott1 - TRUNCATE(tott1,0)) GE 0 AND ( tott1 - TRUNCATE(tott1,0)) < 0.16 THEN tott3 = TRUNCATE(tott1,0).
                 ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.16  AND ( tott1 - TRUNCATE(tott1,0)) < 0.46 THEN tott3 = TRUNCATE(tott1,0) + 0.50.
                 ELSE  IF ( tott1 - TRUNCATE(tott1,0)) GE 0.46  THEN tott3 = TRUNCATE(tott1,0) + 1.                            
                 IF ( antal - TRUNCATE(antal,0)) GE 0 AND ( antal - TRUNCATE(antal,0)) < 0.16 THEN antal2 = TRUNCATE(antal,0).
                 ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.16  AND ( antal - TRUNCATE(antal,0)) < 0.46 THEN antal2 = TRUNCATE(antal,0) + 0.50.
                 ELSE  IF ( antal - TRUNCATE(antal,0)) GE 0.46  THEN antal2 = TRUNCATE(antal,0) + 1.                            
                 FIND FIRST FLEXREG  USE-INDEX FLEXREG NO-LOCK NO-ERROR.
                 IF AVAILABLE FLEXREG THEN DO:                    
                    IF MONTH(TIDREGITAB.DATUM) > MONTH(FLEXREG.SOMMARST) AND MONTH(TIDREGITAB.DATUM) < MONTH(FLEXREG.SOMMARSL) THEN DO:
                       IF antal = 7.45 THEN antal2 = 8.00.
                       IF tott1 = 7.45 THEN tott3 = 8.00.
                    END.
                    ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARSL) AND DAY(TIDREGITAB.DATUM) <= DAY(FLEXREG.SOMMARSL) THEN DO:
                       IF antal = 7.45 THEN antal2 = 8.00.
                       IF tott1 = 7.45 THEN tott3 = 8.00.
                    END.
                    ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARST) AND DAY(TIDREGITAB.DATUM) >= DAY(FLEXREG.SOMMARST) THEN DO: 
                       IF antal = 7.45 THEN antal2 = 8.00.
                       IF tott1 = 7.45 THEN tott3 = 8.00.
                    END.
                 END. 
              END.
              tott4 = tott3 * 3600.
              proc2 = 100 * antal2 * 3600 / tott4. 

              regdat3 = TIDREGITAB.DATUM.
              regdat4 = TIDREGITAB.DATUM.
	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3  AND
	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
	              ASSIGN
	              regdat3 = TIDREGITAB.DATUM - 1 
                 regdat5 = regdat3.
                 IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
                 ELSE DO:
                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                    IF AVAILABLE OVERAVTAB THEN DO:
                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
                    END.
                 END.                                  
                 dat:
                 REPEAT:
                    IF regdat5 = regdat3 THEN LEAVE dat.
                    IF regdat5 > regdat3 THEN DO:    
                       regdat5 = regdat3.
                       IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                       ELSE DO:
                          FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
                          OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                          IF AVAILABLE OVERAVTAB THEN DO:
                             IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
                          END.
                       END.
                    END.
                 END.   
                 IF DAY(regdat3) GE 26 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
                       regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
                    IF AVAILABLE frbuff THEN regdat3 = 
                    DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).
                    ELSE regdat3 = TIDREGITAB.DATUM.              
                 END.  	     
                 ELSE regdat3 = TIDREGITAB.DATUM. 
              END.              	         	        
              ELSE IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
              DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	           ASSIGN
   	           regdat4 = TIDREGITAB.DATUM + 1 
   	           regdat5 = regdat4.
     	           IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	              END.
   	           END. 
   	           IF regdat4 = regdat5 THEN DO:
   	              ASSIGN
   	              regdat4 = regdat4 - 1
   	              regdat5 = regdat4.
   	           END.     
   	           dat2:
   	           REPEAT:
   	              IF regdat4 = regdat5 THEN LEAVE dat2. 
    	              IF regdat4 > regdat5 THEN DO:
   	                 regdat5 = regdat4.
                           IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                           ELSE DO:
   	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                    END.
   	                 END.    
   	              END.
   	           END.   
   	           IF DAY(regdat4) LE 3 THEN DO:           
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                       AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
      	              FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                    END.
   	              IF AVAILABLE frbuff THEN DO: 
   	                 IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                    ASSIGN
   	                    regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                    regdat4 = regdat5 - 1.
   	                 END.
   	                 ELSE DO:
   	                    ASSIGN
   	                    regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))
   	                    regdat4 = regdat5 - 1.
   	                 END.   
   	              END.  
   	              ELSE regdat4 = TIDREGITAB.DATUM.              
   	           END.              
                 ELSE regdat4 = TIDREGITAB.DATUM.                    
                 IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	              ASSIGN
   	              regdat3 = TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3.
   	              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
   	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
                              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                              ELSE DO:
     	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   	       
                    IF onr2 = "118" THEN DO:
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1  AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                    END.
                    ELSE DO:                    
                       FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	              regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	              AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                    END.
   	              IF AVAILABLE frbuff THEN regdat3 = regdat3 + 1 .	              
                    ELSE regdat3 = TIDREGITAB.DATUM.              	         	     	      
   	           END.                                  
   	        END.    	    
   	        ELSE IF proc1 = 100  AND WEEKDAY(TIDREGITAB.DATUM) = 2 THEN DO: /*HELG BAKÅT*/
   	           ASSIGN
   	           regdat3 = TIDREGITAB.DATUM - 1 
   	           regdat5 = regdat3.
   	           IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	           ELSE DO:
   	              FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	              OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	              IF AVAILABLE OVERAVTAB THEN DO:
   	                 IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	              END.
   	           END.                                  
   	           dat:
   	           REPEAT:
   	              IF regdat5 = regdat3 THEN LEAVE dat.
   	              IF regdat5 > regdat3 THEN DO:    
   	                 regdat5 = regdat3.
                       IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                       ELSE DO:
     	                    FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                    OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                    IF AVAILABLE OVERAVTAB THEN DO:
   	                       IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                    END.
   	                 END.
   	              END.
   	           END.   	                   
                 IF onr2 = "118" THEN DO:
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 AND frbuff.RESMAL = kommentar NO-LOCK NO-ERROR.
                 END.
                 ELSE DO:                 
                    FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	           regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2
      	           AND frbuff.TOTALT = tott1 NO-LOCK NO-ERROR.
                 END.
   	           IF AVAILABLE frbuff THEN regdat3 = regdat3 + 1 .	              
                 ELSE regdat3 = TIDREGITAB.DATUM.              	         	     	      
   	        END.              	         	        	        
   	        CREATE frvarotemp.
   	        ASSIGN frvarotemp.PERSONNUMMER = pnr frvarotemp.AONR = onr2
   	        frvarotemp.DELNR = dnr2 frvarotemp.LART = fkod
   	        frvarotemp.FRAN = regdat3 frvarotemp.TILL = regdat4
   	        frvarotemp.PROCENT = proc1 frvarotemp.TIMMAR = antal
              frvarotemp.NAMN = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN
              frvarotemp.PROCENT2 = proc2 frvarotemp.TIMMAR2 = antal2 frvarotemp.KOMMENTAR  = kommentar.
              frvarotemp.TOTTIMMAR = frvarotemp.TIMMAR2.
            
   	        IF proc1 > 0 AND proc1 < 100 THEN DO:
    	           ASSIGN
    	           frvarotemp.STARTKL = frstart 
   	           frvarotemp.SLUTKL = frslut.
   	           /*IF frvarotemp.LART = "3301" THEN ASSIGN frvarotemp.LART = "3300".*/
   	        END.   
              ASSIGN
    	        frvarotemp.STARTKL = frstart 
   	        frvarotemp.SLUTKL = frslut.  
   	     END.           
           ELSE DO:
   	        regdatum = TIDREGITAB.DATUM - 1.
   	        RUN REGVEC.P.
   	        RUN SLUTARB.P.
   	        IF regstart = regslut THEN DO:
   	           REPEAT:
   	              IF regstart ne regslut THEN LEAVE.
   	              regdatum = regdatum - 1.
   	              RUN REGVEC.P.
   	              RUN SLUTARB.P.
   	           END.
   	        END.
   	        ASSIGN
   	        regdatum2 = regdatum
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN SLUTARB.P.	   
   	        nytid = regstart.
   	        RUN TIMSEK.P. 
   	        ASSIGN             /* raknar ut totala tiden */
   	        starttiden = sekunder
   	        nytid = regslut.
   	        RUN TIMSEK.P.
   	        ASSIGN
   	        sluttiden = sekunder
   	        regdatum = TIDREGITAB.DATUM
   	        regvnr = TIDREGITAB.VECKONUMMER.
   	        RUN NORDFTO.P.
   	        tott1 = nytid.
   	        RUN TIMSEK.P.
   	        tott2 = sekunder.	   
              /*IF tott2 > 28800 THEN tott2 = 28800.*/
   	        IF frvarotemp.TILL < regdatum2
   	        OR frvarotemp.PROCENT < 100
   	        OR TIDREGITAB.TOTALT < tott1 THEN DO:
   	           IF TIDREGITAB.START NE regstart OR TIDREGITAB.SLUT NE regslut
   	           THEN DO:                  
   	              nytid = TIDREGITAB.TOTALT.
   	              RUN TIMSEK.P.               
   	              IF tott2 LE 0 THEN proc1 = 0.
   	              ELSE proc1 = 100 * sekunder / tott2.	           
   	              IF pc NE TRUE THEN DO:  /*PROCENT*/	              
   		             antal = nytid.		          
   	              END.
   	           END.	    	           
   	           ELSE DO:
   	              ASSIGN
   	              proc1 = 100
                    antal = nytid.	              
   	           END.       
                 /*Avrunda inte atk och komp */
                 IF  frvarotemp.AONR = "170" THEN DO:
                     nytid = antal.
                     RUN TIMSEK.P.
                     antal2 = sekunder / 3600.
                     nytid = tott1.
                     RUN TIMSEK.P.
                     tott3 = sekunder / 3600.
                    
                 END.
                 ELSE IF  frvarotemp.AONR = "160" THEN DO:                 
                     /* aldrig frånvaro mer än en hel dag*/
                    IF antal > tott1 THEN antal = tott1.
                    IF ( tott1 - TRUNCATE(tott1,0)) GE 0 AND ( tott1 - TRUNCATE(tott1,0)) < 0.08 THEN tott3 = TRUNCATE(tott1,0).
                    ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.08  AND ( tott1 - TRUNCATE(tott1,0)) < 0.23 THEN tott3 = TRUNCATE(tott1,0) + 0.25.
                    ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.23  AND ( tott1 - TRUNCATE(tott1,0)) < 0.38 THEN tott3 = TRUNCATE(tott1,0) + 0.50.
                    ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.38  AND ( tott1 - TRUNCATE(tott1,0)) < 0.53 THEN tott3 = TRUNCATE(tott1,0) + 0.75.
                    ELSE  IF ( tott1 - TRUNCATE(tott1,0)) GE 0.53  THEN tott3 = TRUNCATE(tott1,0) + 1.                            
                    IF ( antal - TRUNCATE(antal,0)) GE 0 AND ( antal - TRUNCATE(antal,0)) < 0.08 THEN antal2 = TRUNCATE(antal,0).
                    ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.08  AND ( antal - TRUNCATE(antal,0)) < 0.23 THEN antal2 = TRUNCATE(antal,0) + 0.25.
                    ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.23  AND ( antal - TRUNCATE(antal,0)) < 0.38 THEN antal2 = TRUNCATE(antal,0) + 0.50.
                    ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.38  AND ( antal - TRUNCATE(antal,0)) < 0.53 THEN antal2 = TRUNCATE(antal,0) + 0.75.
                    ELSE  IF ( antal - TRUNCATE(antal,0)) GE 0.53  THEN antal2 = TRUNCATE(antal,0) + 1.                                             
                 END.
                 ELSE DO:                 
                     /* aldrig frånvaro mer än en hel dag*/
                     IF antal > tott1 THEN antal = tott1.
                     /*Avrunda all frånvaro till halvtimmar*/
                     IF ( tott1 - TRUNCATE(tott1,0)) GE 0 AND ( tott1 - TRUNCATE(tott1,0)) < 0.16 THEN tott3 = TRUNCATE(tott1,0).
                     ELSE IF ( tott1 - TRUNCATE(tott1,0)) GE 0.16  AND ( tott1 - TRUNCATE(tott1,0)) < 0.46 THEN tott3 = TRUNCATE(tott1,0) + 0.50.
                     ELSE  IF ( tott1 - TRUNCATE(tott1,0)) GE 0.46  THEN tott3 = TRUNCATE(tott1,0) + 1.                 
                     
                     IF ( antal - TRUNCATE(antal,0)) GE 0 AND ( antal - TRUNCATE(antal,0)) < 0.16 THEN antal2 = TRUNCATE(antal,0).
                     ELSE IF ( antal - TRUNCATE(antal,0)) GE 0.16  AND ( antal - TRUNCATE(antal,0)) < 0.46 THEN antal2 = TRUNCATE(antal,0) + 0.50.
                     ELSE  IF ( antal - TRUNCATE(antal,0)) GE 0.46  THEN antal2 = TRUNCATE(antal,0) + 1.
                     /* 8 timmar i lönesystemet året om trots sommartid*/
                     FIND FIRST FLEXREG  USE-INDEX FLEXREG NO-LOCK NO-ERROR.
                     IF AVAILABLE FLEXREG THEN DO:                    
                        IF MONTH(TIDREGITAB.DATUM) > MONTH(FLEXREG.SOMMARST) AND MONTH(TIDREGITAB.DATUM) < MONTH(FLEXREG.SOMMARSL) THEN DO:
                           IF antal = 7.45 THEN antal2 = 8.00.
                           IF tott1 = 7.45 THEN tott3 = 8.00.
                        END.
                        ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARSL) AND DAY(TIDREGITAB.DATUM) <= DAY(FLEXREG.SOMMARSL) THEN DO:
                           IF antal = 7.45 THEN antal2 = 8.00.
                           IF tott1 = 7.45 THEN tott3 = 8.00.
                        END.
                        ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARST) AND DAY(TIDREGITAB.DATUM) >= DAY(FLEXREG.SOMMARST) THEN DO: 
                           IF antal = 7.45 THEN antal2 = 8.00.
                           IF tott1 = 7.45 THEN tott3 = 8.00.
                        END.
                     END.
                 END.
                 tott4 = tott3 * 3600.
                 proc2 = 100 * antal2 * 3600 / tott4. 
                 regdat3 = TIDREGITAB.DATUM.
   	           IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) LE 3 AND
   	           DAY(TIDREGITAB.DATUM) > 1 THEN DO:
   	              ASSIGN
   	              regdat3 = TIDREGITAB.DATUM - 1 
   	              regdat5 = regdat3.
   	              IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.  
   	                 END.
   	              END.                                  
   	              dat:
     	              REPEAT:
   	                 IF regdat5 = regdat3 THEN LEAVE dat.
   	                 IF regdat5 > regdat3 THEN DO:    
   	                    regdat5 = regdat3.
                          IF WEEKDAY(regdat3) = 1 OR WEEKDAY(regdat3) = 7 THEN regdat3 = regdat3 - 1.  
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat3 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat3 = regdat3 - 1.
   	                       END.
   	                    END.
   	                 END.
   	              END.   
   	              IF DAY(regdat3) GE 26 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat3 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN regdat3 = 
   	                 DATE(MONTH(TIDREGITAB.DATUM),01,YEAR(TIDREGITAB.DATUM)).
         	           ELSE regdat3 = TIDREGITAB.DATUM.              
   	              END.  	   
   	              ELSE regdat3 = TIDREGITAB.DATUM.  
   	           END.              	         
   	           regdat4 = TIDREGITAB.DATUM.
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4.
   	              IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
                       IF AVAILABLE OVERAVTAB THEN DO:
    	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
      	           END.   
   	              IF regdat4 = regdat5 THEN DO:
   	                 ASSIGN
   	                 regdat4 = regdat4 - 1
   	                 regdat5 = regdat4.
   	              END.     
   	              dat2:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat2. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
                          IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                           IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
     	                    END.      
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar   NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO:
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                       ASSIGN
   	                       regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM))
     	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE regdat4 = TIDREGITAB.DATUM.              
   	              END.                              
   	              ELSE regdat4 = TIDREGITAB.DATUM.  
   	           END.  	    
   	           CREATE frvarotemp.
   	           ASSIGN frvarotemp.PERSONNUMMER = pnr frvarotemp.AONR = onr2
   	           frvarotemp.DELNR = dnr2 frvarotemp.LART = fkod
   	           frvarotemp.FRAN = regdat3 frvarotemp.TILL = regdat4
   	           frvarotemp.PROCENT = proc1 frvarotemp.TIMMAR = antal
                 frvarotemp.NAMN = PERSONALTAB.FORNAMN + " " + PERSONALTAB.EFTERNAMN
                 frvarotemp.PROCENT2 = proc2 frvarotemp.TIMMAR2 = antal2 frvarotemp.KOMMENTAR  = kommentar
                 frvarotemp.TOTTIMMAR = frvarotemp.TIMMAR2.
   	           IF proc1 > 0 AND proc1 < 100 THEN DO:
    	              ASSIGN
    	              frvarotemp.STARTKL = frstart 
   	              frvarotemp.SLUTKL = frslut.
   	              /*IF frvarotemp.LART = "3301" THEN ASSIGN frvarotemp.LART = "3300".*/
   	           END.
                 ASSIGN
    	           frvarotemp.STARTKL = frstart 
   	           frvarotemp.SLUTKL = frslut.
   	        END.
              ELSE DO:      
                 ASSIGN
   	           regdat4 = TIDREGITAB.DATUM
                 dagtot = 0.
                 /*Avrunda inte atk och komp */
                 IF  TIDREGITAB.AONR = "170" THEN DO:
                     nytid = TIDREGITAB.TOTALT.
                     RUN TIMSEK.P.
                     dagtot = sekunder / 3600.
                 END.
                 ELSE IF  TIDREGITAB.AONR = "160" THEN DO:
                    IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0 AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.08 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0).
                    ELSE IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.08  AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.23 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 0.25.
                    ELSE IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.23  AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.38 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 0.5.
                    ELSE IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.38  AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.53 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 0.75.
                    ELSE  IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.53  THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 1.                                                                   
                 END.
                 ELSE DO:                 
                    IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0 AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.16 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0).
                    ELSE IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.16  AND ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) < 0.46 THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 0.50.
                    ELSE  IF ( TIDREGITAB.TOTALT - TRUNCATE(TIDREGITAB.TOTALT,0)) GE 0.46  THEN dagtot = TRUNCATE(TIDREGITAB.TOTALT,0) + 1.                            
                    FIND FIRST FLEXREG  USE-INDEX FLEXREG NO-LOCK NO-ERROR.
                    IF AVAILABLE FLEXREG THEN DO:                    
                       IF MONTH(TIDREGITAB.DATUM) > MONTH(FLEXREG.SOMMARST) AND MONTH(TIDREGITAB.DATUM) < MONTH(FLEXREG.SOMMARSL) THEN DO:
                          IF TIDREGITAB.TOTALT = 7.45 THEN dagtot = 8.00.                    
                       END.
                       ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARSL) AND DAY(TIDREGITAB.DATUM) <= DAY(FLEXREG.SOMMARSL) THEN DO:
                          IF TIDREGITAB.TOTALT = 7.45 THEN dagtot = 8.00.                     
                       END.
                       ELSE IF MONTH(TIDREGITAB.DATUM) = MONTH(FLEXREG.SOMMARST) AND DAY(TIDREGITAB.DATUM) >= DAY(FLEXREG.SOMMARST) THEN DO: 
                          IF TIDREGITAB.TOTALT = 7.45 THEN dagtot = 8.00.                       
                       END.
                    END.
                 END.
                 IF proc1 = 100  AND DAY(TIDREGITAB.DATUM) GE 26 AND
   	           DAY(TIDREGITAB.DATUM + 1) > 1 THEN DO:
   	              ASSIGN
   	              regdat4 = TIDREGITAB.DATUM + 1 
   	              regdat5 = regdat4.
   	              IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1.
   	              ELSE DO:
   	                 FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                 OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                 IF AVAILABLE OVERAVTAB THEN DO:
   	                    IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.  
   	                 END.
   	              END.        
   	              IF regdat4 = regdat5 THEN DO:
   	                 ASSIGN
   	                 regdat4 = regdat4 - 1
   	                 regdat5 = regdat4.
   	              END.
   	              dat3:
   	              REPEAT:
   	                 IF regdat4 = regdat5 THEN LEAVE dat3. 
    	                 IF regdat4 > regdat5 THEN DO:
   	                    regdat5 = regdat4.
                          IF WEEKDAY(regdat4) = 1 OR WEEKDAY(regdat4) = 7 THEN regdat4 = regdat4 + 1. 
                          ELSE DO:
   	                       FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdat4 AND
   	                       OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
   	                       IF AVAILABLE OVERAVTAB THEN DO:
   	                          IF OVERAVTAB.EQDAG = 1 OR OVERAVTAB.EQDAG = 7 THEN regdat4 = regdat4 + 1.
   	                       END.
   	                    END.    
   	                 END.
   	              END.   
   	              IF DAY(regdat4) LE 3 THEN DO:           
                       IF onr2 = "118" THEN DO:
                          FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 
                          AND frbuff.RESMAL = kommentar  NO-LOCK NO-ERROR.
                       END.
                       ELSE DO:                       
      	                 FIND FIRST frbuff WHERE frbuff.PERSONALKOD =  personal AND frbuff.DATUM =
      	                 regdat4 AND frbuff.TIDLOG = TRUE AND frbuff.AONR = onr2 NO-LOCK NO-ERROR.
                       END.
   	                 IF AVAILABLE frbuff THEN DO: 
   	                    IF MONTH(TIDREGITAB.DATUM) = 12 THEN DO:  
   	                       ASSIGN
   	                       regdat5 = DATE(01,01,YEAR(TIDREGITAB.DATUM) + 1)
   	                       regdat4 = regdat5 - 1.
   	                    END.
   	                    ELSE DO:
   	                       ASSIGN
   	                       regdat5 = DATE(MONTH(TIDREGITAB.DATUM) + 1,01,YEAR(TIDREGITAB.DATUM)).
   	                       regdat4 = regdat5 - 1.
   	                    END.   
   	                 END.  
   	                 ELSE regdat4 = TIDREGITAB.DATUM.              
   	              END.
   	              ELSE regdat4 = TIDREGITAB.DATUM.   
   	           END.  	    
                 ASSIGN frvarotemp.TILL = regdat4
                 frvarotemp.SLUTKL = frslut
                 frvarotemp.TOTTIMMAR = frvarotemp.TOTTIMMAR + dagtot.                 
                                         
              END. 
            END.
            IF del1 = FALSE AND frvarotemp.PROCENT < 100 THEN DO:
               CREATE frfel.
               ASSIGN frfel.PERSONNUMMER = frvarotemp.PERSONNUMMER frfel.AONR = frvarotemp.AONR  
  	            frfel.DELNR = frvarotemp.DELNR frfel.LART = frvarotemp.LART
	            frfel.FRAN =   frvarotemp.FRAN frfel.TILL = frvarotemp.TILL 
	            frfel.PROCENT = frvarotemp.PROCENT frfel.TIMMAR = frvarotemp.TIMMAR.
	         END.      
         END.
      END.
      GET NEXT tidq NO-LOCK.
   END.
   GET NEXT persq NO-LOCK.
END.       
FOR EACH frvarotemp WHERE frvarotemp.LART = "860" AND  frvarotemp.FRAN NE frvarotemp.TILL:
   ASSIGN
   komptid = 0
   regdatum = frvarotemp.FRAN + 1
   avdatum = frvarotemp.TILL
   komptid =  frvarotemp.TIMMAR2.
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
   IF NOT AVAILABLE PERSONALTAB  THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
   END.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
   PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
   REPEAT:   
      musz = FALSE.
      FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND
      OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.   
      IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 1  THEN musz = TRUE.
      ELSE IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 7  THEN musz = TRUE.      
      ELSE IF WEEKDAY(regdatum) = 1 THEN musz = TRUE.
      ELSE IF WEEKDAY(regdatum) = 7 THEN musz = TRUE.
      IF musz = TRUE THEN DO:
          musz = FALSE.
          regdatum = regdatum + 1.
          IF regdatum > avdatum THEN LEAVE.
          NEXT.
      END.
      frvarotemp.TIMMAR2 = frvarotemp.TIMMAR2 + komptid.
      regdatum = regdatum + 1.
      IF regdatum > avdatum THEN LEAVE.
   END.   
END.
FOR EACH frvarotemp WHERE frvarotemp.LART = "406" AND  frvarotemp.FRAN NE frvarotemp.TILL:
   ASSIGN
   komptid = 0
   regdatum = frvarotemp.FRAN + 1
   avdatum = frvarotemp.TILL
   komptid =  frvarotemp.TIMMAR2.
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
   IF NOT AVAILABLE PERSONALTAB  THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
   END.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING =
   PERSONALTAB.ANSTALLNING USE-INDEX ANSTF NO-LOCK NO-ERROR.
   REPEAT:   
      musz = FALSE.
      FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND
      OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.   
      IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 1  THEN musz = TRUE.
      ELSE IF AVAILABLE OVERAVTAB AND OVERAVTAB.EQDAG = 7  THEN musz = TRUE.      
      ELSE IF WEEKDAY(regdatum) = 1 THEN musz = TRUE.
      ELSE IF WEEKDAY(regdatum) = 7 THEN musz = TRUE.
      IF musz = TRUE THEN DO:
          musz = FALSE.
          regdatum = regdatum + 1.
          IF regdatum > avdatum THEN LEAVE.
          NEXT.
      END.
      /*FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD AND TIDREGITAB.DATUM =  regdatum
      AND TIDREGITAB.AONR = "160" AND TIDREGITAB.TIDLOG = TRUE NO-LOCK NO-ERROR.
      CCC*/
      frvarotemp.TIMMAR2 = frvarotemp.TIMMAR2 + komptid.
      regdatum = regdatum + 1.
      IF regdatum > avdatum THEN LEAVE.
   END.   
END.
IF globforetag = "sund" THEN DO:
   OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\sjkoll.d NO-ECHO.
END.

FOR EACH frvarotemp WHERE frvarotemp.LART = "600" USE-INDEX franvaro  NO-LOCK:
  EXPORT frvarotemp.
END.
OUTPUT CLOSE.  

/*skilj ut karensdag*/
FOR EACH frvarotemp WHERE frvarotemp.LART = "600":
   IF frvarotemp.FRAN NE frvarotemp.TILL THEN DO:
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      IF NOT AVAILABLE PERSONALTAB  THEN DO:
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      END.
      IF AVAILABLE PERSONALTAB THEN DO:      
         FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
         USE-INDEX ANSTF NO-LOCK NO-ERROR.   
         FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = frvarotemp.FRAN AND 
         OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
         IF NOT AVAILABLE OVERAVTAB THEN dagnr = WEEKDAY(frvarotemp.FRAN).
         ELSE dagnr = OVERAVTAB.EQDAG.
         IF dagnr = 1 OR dagnr = 7 THEN dagnr = dagnr.
         ELSE DO:
            regdatum = frvarotemp.FRAN.
            REPEAT:            
               regdatum = regdatum - 1.
               FIND FIRST OVERAVTAB WHERE OVERAVTAB.DATUM = regdatum AND 
               OVERAVTAB.KOD = ANSTFORMTAB.KOD USE-INDEX ODATUM NO-LOCK NO-ERROR.
               IF NOT AVAILABLE OVERAVTAB THEN dagnr = WEEKDAY(regdatum).
               ELSE dagnr = OVERAVTAB.EQDAG.
               IF dagnr = 1 OR dagnr = 7 THEN NEXT.
               ELSE LEAVE.
            END.
            FIND FIRST FVARO WHERE FVARO.FRKOD = frvarotemp.LART NO-LOCK NO-ERROR.
            IF AVAILABLE FVARO THEN DO:            
               FIND FIRST TIDREGITAB WHERE TIDREGITAB.PERSONALKOD = PERSONALTAB.PERSONALKOD
               AND TIDREGITAB.DATUM = regdatum AND TIDREGITAB.AONR = FVARO.AONR
               AND TIDREGITAB.TOTALT > 1  NO-LOCK NO-ERROR.
               IF NOT AVAILABLE TIDREGITAB THEN DO:
                  CREATE fbuff.
                  BUFFER-COPY frvarotemp TO fbuff.
                  ASSIGN fbuff.FRAN = frvarotemp.FRAN
                  fbuff.TILL = frvarotemp.FRAN.
                  frvarotemp.FRAN = frvarotemp.FRAN + 1.
               END.
            END.
         END.
      END.
   END.
END.
IF globforetag = "sund" THEN DO:
   OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\sjkolle.d NO-ECHO.
END.

FOR EACH frvarotemp WHERE frvarotemp.LART = "600" USE-INDEX franvaro  NO-LOCK:
  EXPORT frvarotemp.
END.
OUTPUT CLOSE.  

FOR EACH frvarotemp WHERE frvarotemp.FRAN = frvarotemp.TILL:
   IF frvarotemp.PROCENT2 = 100 THEN frvarotemp.ARBDAGAR = 1.      
END.

FOR EACH frvarotemp WHERE frvarotemp.FRAN NE frvarotemp.TILL:
   arbdg = 0.
   regdatum = frvarotemp.FRAN.
   adag:
   REPEAT:
      IF regdatum > frvarotemp.TILL THEN LEAVE adag.
      FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER AND PERSONALTAB.AKTIV = TRUE USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      IF NOT AVAILABLE PERSONALTAB  THEN DO:
         FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONNUMMER = frvarotemp.PERSONNUMMER  USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.      
      END.
      persrec = RECID(PERSONALTAB).         
      RUN REGVEC.P.
      RUN SLUTARB.P.      
      IF regstart = regslut THEN regstart = regstart.
      ELSE  arbdg = arbdg + 1.       
      regdatum = regdatum + 1.    
   END.
   frvarotemp.ARBDAGAR = arbdg.     
END.


DO TRANSACTION:
   FIND FIRST frvarotemp WHERE frvarotemp.PERSONNUMMER = " " OR frvarotemp.PERSONNUMMER =
   "000000000000" USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
   IF AVAILABLE frvarotemp THEN DELETE frvarotemp.
END.
REPEAT TRANSACTION:
   FIND NEXT frvarotemp WHERE frvarotemp.PERSONNUMMER = " " OR frvarotemp.PERSONNUMMER =
    "000000000000"  USE-INDEX franvaro EXCLUSIVE-LOCK NO-ERROR.
   IF NOT AVAILABLE frvarotemp THEN LEAVE.
   ELSE DELETE frvarotemp.
END.
IF globforetag = "sund" THEN DO:
   OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\fransu.d NO-ECHO.
END.
ELSE DO:
   OUTPUT TO \\pc012\d\delad\pro8\GURU\apptemp\fransu.d NO-ECHO.
END.   
FOR EACH frvarotemp USE-INDEX franvaro  NO-LOCK:
  EXPORT frvarotemp.
END.
OUTPUT CLOSE.  
IF globforetag = "sund" THEN DO:
   OUTPUT TO D:\delad\server\pro9s\EXPORT\lon\frfelma.d NO-ECHO.
END. 
ELSE DO:
   OUTPUT TO \\pc012\d\delad\pro8\GURU\apptemp\frfelma.d NO-ECHO.
END.   
FOR EACH frfel USE-INDEX franvaro  NO-LOCK:
  EXPORT frfel.
END.
RUN xSULOFRN.P.
RUN sammut_UI (INPUT 2).
