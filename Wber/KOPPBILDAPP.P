/*KOPPBILDAPP.P*/

{BERBILD.I}
DEFINE VARIABLE felmedd AS CHARACTER NO-UNDO.
DEFINE VARIABLE ktext AS CHARACTER NO-UNDO.

PROCEDURE laddabild_UI :
   DEFINE INPUT PARAMETER konstvalvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR berbildtemp.
   EMPTY TEMP-TABLE berbildtemp NO-ERROR. 
   OPEN QUERY bq FOR EACH BERBILD WHERE BERBILD.KTYPKOD = konstvalvar NO-LOCK.
   GET FIRST bq NO-LOCK.
   DO WHILE AVAILABLE(BERBILD):
      CREATE berbildtemp.
      BUFFER-COPY BERBILD TO berbildtemp.
      ASSIGN berbildtemp.BBROW = ROWID(BERBILD).
      GET NEXT bq NO-LOCK.        
   END.
   CLOSE QUERY bq.
END PROCEDURE.

PROCEDURE laddabild2_UI :   
   DEFINE OUTPUT PARAMETER TABLE FOR berbildtemp.
   EMPTY TEMP-TABLE berbildtemp NO-ERROR. 
   OPEN QUERY bq FOR EACH BERBILD NO-LOCK.
   GET FIRST bq NO-LOCK.
   DO WHILE AVAILABLE(BERBILD):
      CREATE berbildtemp.
      BUFFER-COPY BERBILD TO berbildtemp.
      ASSIGN berbildtemp.BBROW = ROWID(BERBILD).
      FIND FIRST KONSTRUKTION WHERE KONSTRUKTION.KTYPKOD = BERBILD.KTYPKOD NO-LOCK NO-ERROR.
      IF NOT AVAILABLE KONSTRUKTION THEN DO:
         FIND FIRST KONSTVAL WHERE KONSTVAL.KVALKOD = BERBILD.KTYPKOD NO-LOCK NO-ERROR.
         IF AVAILABLE KONSTVAL  THEN DO:
            FIND FIRST KONSTGRUPP WHERE KONSTGRUPP.KONSKOD = KONSTVAL.KONSKOD NO-LOCK NO-ERROR.
            IF AVAILABLE KONSTGRUPP  THEN DO:
               /*ktext =  berbildtemp.KTYPKOD + " (" + KONSTGRUPP.BENAMNING + " " + KONSTVAL.BB + ")".               
               ASSIGN berbildtemp.KTYPKOD = ktext.*/
               ASSIGN
               berbildtemp.HJKONSTGRUPPB = KONSTGRUPP.BENAMNING
               berbildtemp.HJUNDERGRUPPB = KONSTVAL.BB.
            END.
         END.         
      END.
      ELSE DO:
         FIND FIRST KONSTGRUPP WHERE KONSTGRUPP.KONSKOD = KONSTRUKTION.KONSKOD NO-LOCK NO-ERROR.
         IF AVAILABLE KONSTGRUPP  THEN DO:
            /*ktext =  berbildtemp.KTYPKOD + " (" + KONSTGRUPP.BENAMNING  + ")".               
            ASSIGN berbildtemp.KTYPKOD = ktext.*/
            ASSIGN
            berbildtemp.HJKONSTGRUPPB = KONSTGRUPP.BENAMNING.
            
         END.
         
      END.   
      GET NEXT bq NO-LOCK.        
   END.
   CLOSE QUERY bq.
END PROCEDURE.

PROCEDURE bort_UI :
   DEFINE INPUT PARAMETER bortrow AS ROWID NO-UNDO.
   DEFINE OUTPUT PARAMETER felmedd AS CHARACTER NO-UNDO.
   felmedd = "".
   DO TRANSACTION:
      FIND FIRST BERBILD WHERE ROWID(BERBILD) = bortrow EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE BERBILD THEN DO:
         DELETE BERBILD.
      END.
      ELSE DO:
         felmedd = "De gick inte att ta bort bild! Något är fel, kontakta Elpool på tfn:090-184540.".
      END.
   END.
   RETURN.
END PROCEDURE.

PROCEDURE nykontr_UI :
   DEFINE INPUT PARAMETER konstvalvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER bildant AS INTEGER NO-UNDO.
   OPEN QUERY bildq FOR EACH BERBILD WHERE 
   BERBILD.KTYPKOD = konstvalvar USE-INDEX KOD NO-LOCK.
   GET FIRST bildq NO-LOCK.
   DO WHILE AVAILABLE(BERBILD):
      bildant = bildant + 1.
      GET NEXT bildq NO-LOCK.
   END.
   CLOSE QUERY bildq.
   RETURN.
END PROCEDURE.

PROCEDURE ner_UI :
   DEFINE INPUT PARAMETER frannr AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER tillnr AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER frow AS ROWID NO-UNDO.
   DEFINE INPUT PARAMETER trow AS ROWID NO-UNDO.
   DEFINE INPUT-OUTPUT PARAMETER TABLE FOR berbildtemp.
   DO TRANSACTION:
      FIND BERBILD WHERE ROWID(BERBILD) = trow EXCLUSIVE-LOCK.
      FIND FIRST berbildtemp WHERE berbildtemp.BBROW = trow NO-LOCK NO-ERROR.
      ASSIGN 
      BERBILD.ORDNING = frannr.  
      berbildtemp.ORDNING = frannr.
   END.
   DO TRANSACTION:
      FIND BERBILD WHERE ROWID(BERBILD) = frow EXCLUSIVE-LOCK.
      FIND FIRST berbildtemp WHERE berbildtemp.BBROW = frow NO-LOCK NO-ERROR.
      ASSIGN
      BERBILD.ORDNING = tillnr.  
      berbildtemp.ORDNING = tillnr.
   END.
   RELEASE BERBILD NO-ERROR.
   RETURN.
END PROCEDURE.

PROCEDURE upp_UI :
   DEFINE INPUT PARAMETER frannr AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER tillnr AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER frow AS ROWID NO-UNDO.
   DEFINE INPUT PARAMETER trow AS ROWID NO-UNDO.
   DEFINE INPUT-OUTPUT PARAMETER TABLE FOR berbildtemp.
   DO TRANSACTION:
      FIND BERBILD WHERE ROWID(BERBILD) = trow EXCLUSIVE-LOCK.
      FIND FIRST berbildtemp WHERE berbildtemp.BBROW = trow NO-LOCK NO-ERROR.
      ASSIGN
      BERBILD.ORDNING = frannr
      berbildtemp.ORDNING = frannr.
   END.
   DO TRANSACTION:
      FIND BERBILD WHERE ROWID(BERBILD) = frow EXCLUSIVE-LOCK.
      FIND FIRST berbildtemp WHERE berbildtemp.BBROW = frow NO-LOCK NO-ERROR.
      ASSIGN
      BERBILD.ORDNING = tillnr
      berbildtemp.ORDNING = tillnr.
   END.
   RELEASE BERBILD NO-ERROR.
   RETURN.
END PROCEDURE.
