DEFINE VARIABLE pkod LIKE PERSONALTAB.PERSONALKOD NO-UNDO. 
DEFINE VARIABLE kodanst LIKE ANSTFORMTAB.KOD NO-UNDO.
DEFINE VARIABLE traav LIKE PERSONALTAB.TRAAVTAL NO-UNDO. 
DEFINE QUERY tidq FOR TIDREGITAB.
OPEN QUERY tidq FOR EACH TIDREGITAB WHERE TIDREGITAB.DATUM >= 01/01/97 AND 
TIDREGITAB.VECKOKORD NE "" 
USE-INDEX PVKORD NO-LOCK.   
GET FIRST tidq NO-LOCK.
DO WHILE AVAILABLE(TIDREGITAB):
   IF TIDREGITAB.DATUM >= 01/01/97 THEN DO:
      IF pkod NE TIDREGITAB.PERSONALKOD THEN DO:
         pkod = TIDREGITAB.PERSONALKOD.
         RUN pers_UI.
      END.
      IF TIDREGITAB.TRAKTKOD NE "" THEN DO:
         RUN traksum_UI.
      END.                                     
      IF TIDREGITAB.LONTILLAGG NE "" THEN DO:
         RUN lonsum_UI.  
      END.
   END.
   GET NEXT tidq NO-LOCK.
END.      
PROCEDURE pers_UI:
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod 
   USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
   USE-INDEX ANSTF NO-LOCK NO-ERROR.                   
   ASSIGN
   kodanst = ANSTFORMTAB.KOD                                                         
   traav = PERSONALTAB.TRAAVTAL.
END PROCEDURE.
PROCEDURE traksum_UI.      
   FIND FIRST TRAKTFLER WHERE TRAKTFLER.TRAAVTAL = traav AND 
   TRAKTFLER.TRAKTKOD = TIDREGITAB.TRAKTKOD  
   USE-INDEX FLTRAKT NO-LOCK NO-ERROR.                      
   CREATE SUMTRAKT.
   ASSIGN
   SUMTRAKT.PERSONALKOD = TIDREGITAB.PERSONALKOD      
   SUMTRAKT.AONR = TIDREGITAB.AONR
   SUMTRAKT.DELNR = TIDREGITAB.DELNR
   SUMTRAKT.DATUM = TIDREGITAB.DATUM
   SUMTRAKT.VECKOKORD = TIDREGITAB.VECKOKORD
   SUMTRAKT.TRAKTKOD = TIDREGITAB.TRAKTKOD
   SUMTRAKT.TRAKTANTAL = TIDREGITAB.TRAKTANTAL.
   IF AVAILABLE TRAKTFLER THEN SUMTRAKT.ENDAGS = FALSE.
   ELSE SUMTRAKT.ENDAGS = TRUE.    
END PROCEDURE.     
PROCEDURE lonsum_UI.      
   FIND FIRST LONTILL WHERE LONTILL.KOD = kodanst AND
   LONTILL.LONTILLAGG = TIDREGITAB.LONTILLAGG
   USE-INDEX LON NO-LOCK NO-ERROR.
   IF NOT AVAILABLE LONTILL THEN RETURN.      
   IF SUBSTRING(LONTILL.TYPKOD,5,3) NE "FAK" THEN RETURN.                   
   CREATE SUMLON.
   ASSIGN
   SUMLON.PERSONALKOD = TIDREGITAB.PERSONALKOD      
   SUMLON.AONR = TIDREGITAB.AONR
   SUMLON.DELNR = TIDREGITAB.DELNR
   SUMLON.DATUM = TIDREGITAB.DATUM
   SUMLON.VECKOKORD = TIDREGITAB.VECKOKORD
   SUMLON.LONTILLAGG = TIDREGITAB.LONTILLAGG
   SUMLON.LONTILLANTAL = TIDREGITAB.LONTILLANTAL.   
END PROCEDURE.

