DEFINE VARIABLE pkod LIKE PERSONALTAB.PERSONALKOD NO-UNDO. 
DEFINE VARIABLE kodanst LIKE ANSTFORMTAB.KOD NO-UNDO.
DEFINE VARIABLE traav LIKE PERSONALTAB.TRAAVTAL NO-UNDO. 
DEFINE VARIABLE arrhjsum AS DECIMAL NO-UNDO.    
DEFINE VARIABLE arrhjsum2 AS DECIMAL NO-UNDO. 
DEFINE VARIABLE arrhjsum3 AS DECIMAL NO-UNDO.  

DEFINE QUERY tidq FOR SUMLON.     
DEFINE QUERY sumdq FOR SUMTIDDAG. 
DEFINE QUERY sumq FOR SUMTID.
DEFINE TEMP-TABLE sumil
   FIELD PERSONALKOD LIKE SUMLON.PERSONALKOD      
   FIELD AONR LIKE SUMLON.AONR
   FIELD DELNR LIKE SUMLON.DELNR
   FIELD DATUM LIKE SUMLON.DATUM
   FIELD VECKOKORD LIKE SUMLON.VECKOKORD
   FIELD LONTILLAGG LIKE SUMLON.LONTILLAGG
   FIELD LONTILLANTAL LIKE SUMLON.LONTILLANTAL
   FIELD IKOST LIKE SUMTIDDAG.IKOSTNAD        
   INDEX PP IS PRIMARY PERSONALKOD AONR DELNR DATUM.          
DEFINE TEMP-TABLE sumil2
   FIELD PERSONALKOD LIKE SUMLON.PERSONALKOD      
   FIELD AONR LIKE SUMLON.AONR
   FIELD DELNR LIKE SUMLON.DELNR
   FIELD DATUM LIKE SUMLON.DATUM
   FIELD VECKOKORD LIKE SUMLON.VECKOKORD
   FIELD LONTILLAGG LIKE SUMLON.LONTILLAGG
   FIELD LONTILLANTAL LIKE SUMLON.LONTILLANTAL
   FIELD IKOST LIKE SUMTIDDAG.IKOSTNAD        
   INDEX PP IS PRIMARY PERSONALKOD AONR DELNR DATUM.
DEFINE TEMP-TABLE sumil3
   FIELD PERSONALKOD LIKE SUMLON.PERSONALKOD      
   FIELD AONR LIKE SUMLON.AONR
   FIELD DELNR LIKE SUMLON.DELNR
   FIELD DATUM LIKE SUMLON.DATUM
   FIELD VECKOKORD LIKE SUMLON.VECKOKORD
   FIELD LONTILLAGG LIKE SUMLON.LONTILLAGG
   FIELD LONTILLANTAL LIKE SUMLON.LONTILLANTAL
   FIELD IKOST LIKE SUMTIDDAG.IKOSTNAD        
   INDEX PP IS PRIMARY PERSONALKOD AONR DELNR DATUM.      
OPEN QUERY sumdq FOR EACH SUMTIDDAG WHERE YEAR(SUMTIDDAG.DATUM) = 1997 NO-LOCK.
DO TRANSACTION:
   GET FIRST sumdq EXCLUSIVE-LOCK.
   IF AVAILABLE SUMTIDDAG THEN 
   ASSIGN SUMTIDDAG.IKOSTNAD = SUMTIDDAG.BELOPP + SUMTIDDAG.LONKOST.
END.
REPEAT:    
   DO TRANSACTION:
      GET NEXT sumdq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTIDDAG THEN 
      ASSIGN SUMTIDDAG.IKOSTNAD = SUMTIDDAG.BELOPP + SUMTIDDAG.LONKOST.   
      ELSE LEAVE.
   END.          
END. 
OPEN QUERY sumq FOR EACH SUMTID WHERE YEAR(SUMTID.DATUM) = 1997 NO-LOCK.
DO TRANSACTION:
   GET FIRST sumq EXCLUSIVE-LOCK.
   IF AVAILABLE SUMTID THEN 
   ASSIGN SUMTID.IKOSTNAD = SUMTID.BELOPP + SUMTID.LONKOST.
END.
REPEAT:    
   DO TRANSACTION:
      GET NEXT sumq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN 
      ASSIGN SUMTID.IKOSTNAD = SUMTID.BELOPP + SUMTID.LONKOST.   
      ELSE LEAVE.
   END.          
END.   
OPEN QUERY tidq FOR EACH SUMLON  
USE-INDEX SUMLON NO-LOCK.  
DO TRANSACTION: 
GET FIRST tidq NO-LOCK. 
   IF AVAILABLE SUMLON THEN DO: 
      IF pkod NE SUMLON.PERSONALKOD THEN DO:
         pkod = SUMLON.PERSONALKOD.
         RUN pers_UI.
      END.
      IF SUMLON.LONTILLAGG NE "" THEN DO:
         RUN lonsum_UI.
      END.
   END.  
END.
DO WHILE AVAILABLE(SUMLON):
    DO TRANSACTION:  
       GET NEXT tidq NO-LOCK.
       IF AVAILABLE  SUMLON THEN DO:
          IF pkod NE SUMLON.PERSONALKOD THEN DO:
             pkod = SUMLON.PERSONALKOD.
             RUN pers_UI.
           END.
           IF SUMLON.LONTILLAGG NE "" THEN DO:
              RUN lonsum_UI.
         END.                                     
      END.
   END.   
END.         
arrhjsum = 0.
FOR EACH sumil BREAK BY sumil.DATUM BY sumil.PERSONALKOD BY
   sumil.AONR BY sumil.DELNR:
   ACCUMULATE sumil.IKOST 
   (TOTAL BY sumil.DATUM BY sumil.PERSONALKOD BY sumil.AONR BY 
   sumil.DELNR).       
   IF LAST-OF(sumil.DELNR) THEN DO:
      CREATE sumil2.
      ASSIGN         
      sumil2.PERSONALKOD = sumil.PERSONALKOD          
      sumil2.DATUM = sumil.DATUM 
      sumil2.AONR = sumil.AONR
      sumil2.DELNR = sumil.DELNR 
      sumil2.IKOST = (ACCUM TOTAL sumil.IKOST) - arrhjsum. 
      arrhjsum = ACCUM TOTAL sumil.IKOST.                                                 
   END. 
END.  
arrhjsum = 0.
FOR EACH sumil2 BREAK BY sumil2.PERSONALKOD BY
   sumil2.AONR BY sumil2.DELNR:
   ACCUMULATE sumil2.IKOST 
   (TOTAL BY sumil2.PERSONALKOD BY sumil2.AONR BY 
   sumil2.DELNR).       
   IF LAST-OF(sumil2.DELNR) THEN DO:
      CREATE sumil3.
      ASSIGN         
      sumil3.PERSONALKOD = sumil2.PERSONALKOD          
      sumil3.DATUM = 01/01/97
      sumil3.AONR = sumil2.AONR
      sumil3.DELNR = sumil2.DELNR 
      sumil3.IKOST = (ACCUM TOTAL sumil2.IKOST) - arrhjsum. 
      arrhjsum = ACCUM TOTAL sumil2.IKOST.                                                 
   END. 
END.                   
FOR EACH sumil2:          
   DO TRANSACTION:
      FIND FIRST SUMTIDDAG WHERE SUMTIDDAG.DATUM = sumil2.DATUM AND 
      SUMTIDDAG.PERSONALKOD = sumil2.PERSONALKOD AND
      SUMTIDDAG.AONR = sumil2.AONR AND
      SUMTIDDAG.DELNR = sumil2.DELNR AND
      SUMTIDDAG.IKOSTNAD > 0 EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE SUMTIDDAG THEN DO:
         ASSIGN SUMTIDDAG.IKOSTNAD = SUMTIDDAG.IKOSTNAD - sumil2.IKOST.
      END.
   END.    
END.   
FOR EACH sumil3:          
   DO TRANSACTION:
      FIND FIRST SUMTID WHERE SUMTID.DATUM = sumil3.DATUM AND 
      SUMTID.PERSONALKOD = sumil3.PERSONALKOD AND
      SUMTID.AONR = sumil3.AONR AND
      SUMTID.DELNR = sumil3.DELNR AND 
      SUMTID.VECKOKORD NE "" AND
      SUMTID.IKOSTNAD > 0 EXCLUSIVE-LOCK NO-ERROR.     
      IF AVAILABLE SUMTID THEN DO:
         ASSIGN SUMTID.IKOSTNAD = SUMTID.IKOSTNAD - sumil3.IKOST.
      END.
   END.    
END.   
PROCEDURE pers_UI:
   FIND FIRST PERSONALTAB WHERE PERSONALTAB.PERSONALKOD = pkod 
   USE-INDEX PERSONALKOD NO-LOCK NO-ERROR.
   FIND FIRST ANSTFORMTAB WHERE ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
   USE-INDEX ANSTF NO-LOCK NO-ERROR.                   
   ASSIGN
   kodanst = ANSTFORMTAB.KOD.            
END PROCEDURE.
PROCEDURE lonsum_UI.      
   FIND FIRST LONTILL WHERE LONTILL.KOD = kodanst AND
   LONTILL.LONTILLAGG = TIDREGITAB.LONTILLAGG
   USE-INDEX LON NO-LOCK NO-ERROR.
   IF NOT AVAILABLE LONTILL THEN RETURN.      
   IF SUBSTRING(LONTILL.TYPKOD,9,5) NE "EJIND" THEN RETURN.                   
   CREATE sumil.              
   ASSIGN                      
   sumil.PERSONALKOD = SUMLON.PERSONALKOD      
   sumil.AONR = SUMLON.AONR
   sumil.DELNR = SUMLON.DELNR
   sumil.DATUM = SUMLON.DATUM
   sumil.VECKOKORD = SUMLON.VECKOKORD
   sumil.LONTILLAGG = SUMLON.LONTILLAGG
   sumil.LONTILLANTAL = SUMLON.LONTILLANTAL
   sumil.IKOST = SUMLON.LONTILLANTAL * LONTILL.ERSATTNING.        
END PROCEDURE.     