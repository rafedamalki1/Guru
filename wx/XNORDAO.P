/*XNORDAO.P*/
DEFINE STREAM eko.  
DEFINE STREAM ekospar.
DEFINE STREAM ekoaonr.   
DEFINE STREAM ekoaonrspar.  
DEFINE VARIABLE typdatum LIKE EKRAPPRESULT.EVERDATUM NO-UNDO. 
DEFINE VARIABLE ekrid AS RECID EXTENT 50 NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO. 
DEFINE VARIABLE avdatum AS DATE NO-UNDO.
DEFINE VARIABLE paav AS CHARACTER FORMAT "X(1)" NO-UNDO.
DEFINE VARIABLE bestnr LIKE AONRTAB.BESTID NO-UNDO.  
DEFINE VARIABLE fk1 LIKE AONRKONTKO.K1 NO-UNDO. 
DEFINE VARIABLE fk2 LIKE AONRKONTKO.K2 NO-UNDO.
DEFINE VARIABLE fk3 LIKE AONRKONTKO.K3 NO-UNDO.
DEFINE VARIABLE fk4 LIKE AONRKONTKO.K4 NO-UNDO. 
DEFINE VARIABLE fk4i AS INTEGER format "999" NO-UNDO.
DEFINE VARIABLE fk5 LIKE AONRKONTKO.K5 NO-UNDO.
DEFINE VARIABLE antalc AS CHARACTER FORMAT "X(2)" NO-UNDO.
DEFINE VARIABLE antali AS INTEGER NO-UNDO. 
DEFINE VARIABLE raknare1 AS INTEGER NO-UNDO. 
DEFINE VARIABLE raknare2 AS INTEGER NO-UNDO.
DEFINE VARIABLE str AS CHARACTER FORMAT "X(140)" NO-UNDO. 
DEFINE VARIABLE delnrc AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE VARIABLE anlnri AS INTEGER NO-UNDO.                
DEFINE VARIABLE prognamn AS CHARACTER FORMAT "X(20)" NO-UNDO.
prognamn = "/eko1/guru/wtid/GURUX" + STRING(TODAY,"999999"). 
str = "".                                                                   
FIND FIRST EKRAPPRESULT WHERE EKRAPPRESULT.ENY = TRUE USE-INDEX PERSORG NO-LOCK NO-ERROR.
IF NOT AVAILABLE EKRAPPRESULT THEN RETURN.

OUTPUT STREAM ekospar TO VALUE(prognamn).
FOR EACH EKRAPPRESULT WHERE EKRAPPRESULT.ENY = TRUE USE-INDEX EPERS NO-LOCK:
   str = "".                                                
   SUBSTRING(str,4,7) = "0000000".  
   SUBSTRING(str,11,2) = "00".                                   
   SUBSTRING(str,13,42) = "GURU".  
   SUBSTRING(str,47,3) = SUBSTRING(EKRAPPRESULT.EORG,1,3).  
   SUBSTRING(str,50,6) = SUBSTRING(EKRAPPRESULT.EPROJEKT,1,6).
   SUBSTRING(str,40,4) = SUBSTRING(EKRAPPRESULT.EKOSTNADSSLAG,1,4).
   SUBSTRING(str,100,6) = EKRAPPRESULT.EVERDATUM.      
   IF EKRAPPRESULT.EBELOPP >= 0 THEN DO:                         
      SUBSTRING(str,106,15) = STRING(EKRAPPRESULT.EBELOPP * 100,"999999999999999").  
      SUBSTRING(str,121,1) = "+".
   END.
   ELSE DO:                                                       
      SUBSTRING(str,106,15) = STRING(EKRAPPRESULT.EBELOPP * -100,"999999999999999"). 
      SUBSTRING(str,121,1) = "-".
   END.    
   IF EKRAPPRESULT.EDEBKRED = TRUE /*DEBET*/ THEN DO:   
      SUBSTRING(str,122,1) = "1".
   END.
   ELSE DO:
      SUBSTRING(str,122,1) = "2".
   END. 
   IF EKRAPPRESULT.EANTAL >= 0 THEN DO:                       
      SUBSTRING(str,123,15) = STRING(EKRAPPRESULT.EANTAL * 100,"999999999999999").  
      SUBSTRING(str,138,1) = "+".
   END.
   ELSE DO:
      SUBSTRING(str,123,15) = STRING(EKRAPPRESULT.EANTAL * -100,"999999999999999"). 
      SUBSTRING(str,138,1) = "-".
   END.    
   IF EKRAPPRESULT.EDEBKRED = TRUE /*DEBET*/ THEN DO:   
      SUBSTRING(str,139,1) = "1".
   END.
   ELSE DO:
      SUBSTRING(str,139,1) = "2".
   END.
   PUT STREAM ekospar UNFORMATTED str AT 1
   SKIP.
END.  
OUTPUT STREAM ekospar CLOSE.


