/*APAMEDDU.P MEDELANDE FRÅN ANDRA DATABASER ENDAST ELPAO*/
DEFINE TEMP-TABLE flermeddtemp
  FIELD EDATUM LIKE MEDDELANDE.EDATUM 
  FIELD EMOTAGET LIKE MEDDELANDE.EMOTAGET 
  FIELD MEDD LIKE MEDDELANDE.MEDD 
  FIELD MOTTAGARE LIKE MEDDELANDE.MOTTAGARE 
  FIELD SANDARE LIKE MEDDELANDE.SANDARE 
  FIELD SDATUM LIKE MEDDELANDE.SDATUM
  FIELD FORETAG LIKE FORETAG.FORETAG
  FIELD MEDREC AS RECID
  INDEX MEDD IS PRIMARY FORETAG SANDARE SDATUM MOTTAGARE EMOTAGET 
  INDEX MEDD2 FORETAG SANDARE MOTTAGARE  
  INDEX MOTTAGARE FORETAG MOTTAGARE EMOTAGET SANDARE. 
FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
DEFINE VARIABLE  globanv AS CHARACTER NO-UNDO.
PROCEDURE medh_UI :
     /*hämta alla som finns även från andra databaser*/
   DEFINE INPUT PARAMETER globanvf LIKE ANVANDARE.ANVANDARE NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR flermeddtemp.
   globanv = globanvf.
   EMPTY TEMP-TABLE flermeddtemp NO-ERROR. 
   OPEN QUERY meddq FOR EACH MEDDELANDE WHERE MEDDELANDE.MOTTAGARE = globanvf AND
   MEDDELANDE.EMOTAGET = FALSE NO-LOCK.   
   GET FIRST meddq NO-LOCK. 
   DO WHILE AVAILABLE(MEDDELANDE):
      CREATE flermeddtemp.
      ASSIGN 
      flermeddtemp.FORETAG = FORETAG.FORETAG
      flermeddtemp.MEDD = MEDDELANDE.MEDD
      flermeddtemp.SANDARE = MEDDELANDE.SANDARE 
      flermeddtemp.SDATUM = MEDDELANDE.SDATUM          
      flermeddtemp.MEDREC = RECID(MEDDELANDE).               
      GET NEXT meddq NO-LOCK. 
   END.   
END PROCEDURE.

PROCEDURE meddssparade_UI :
   DEFINE INPUT PARAMETER globanvf LIKE ANVANDARE.ANVANDARE NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR flermeddtemp.
   globanv = globanvf.
   EMPTY TEMP-TABLE flermeddtemp NO-ERROR. 
   OPEN QUERY meddq FOR EACH MEDDELANDE WHERE MEDDELANDE.MOTTAGARE = globanvf AND
   MEDDELANDE.EMOTAGET = TRUE NO-LOCK.
   GET FIRST meddq NO-LOCK.
   DO WHILE AVAILABLE(MEDDELANDE):
      CREATE flermeddtemp.
      ASSIGN 
      flermeddtemp.FORETAG = FORETAG.FORETAG
      flermeddtemp.MEDD = MEDDELANDE.MEDD
      flermeddtemp.SANDARE = MEDDELANDE.SANDARE 
      flermeddtemp.SDATUM = MEDDELANDE.SDATUM
      flermeddtemp.MOTTAGARE =MEDDELANDE.MOTTAGARE 
      flermeddtemp.EMOTAGET = MEDDELANDE.EMOTAGET
      flermeddtemp.MEDREC = RECID(MEDDELANDE).
      GET NEXT meddq NO-LOCK.
   END.
END PROCEDURE.
PROCEDURE meddstatus_UI :
   /*till meddstatus*/
   DEFINE INPUT PARAMETER globanvf LIKE ANVANDARE.ANVANDARE NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR flermeddtemp.
   
   EMPTY TEMP-TABLE flermeddtemp NO-ERROR. 
   OPEN QUERY meddq FOR EACH MEDDELANDE WHERE MEDDELANDE.SANDARE = globanvf AND
   MEDDELANDE.EMOTAGET = FALSE
   USE-INDEX MEDD NO-LOCK.
   GET FIRST meddq NO-LOCK.
   DO WHILE AVAILABLE(MEDDELANDE):
      CREATE flermeddtemp.
      ASSIGN 
      flermeddtemp.FORETAG = FORETAG.FORETAG
      flermeddtemp.MEDD = MEDDELANDE.MEDD
      flermeddtemp.SANDARE = MEDDELANDE.SANDARE 
      flermeddtemp.SDATUM = MEDDELANDE.SDATUM
      flermeddtemp.MOTTAGARE =MEDDELANDE.MOTTAGARE 
      flermeddtemp.EMOTAGET = MEDDELANDE.EMOTAGET
      flermeddtemp.MEDREC = RECID(MEDDELANDE).
      GET NEXT meddq NO-LOCK.
   END.
END PROCEDURE.

PROCEDURE vmedstatus_UI :
   /*från medelade status.*/
   DEFINE INPUT PARAMETER plusrec AS RECID NO-UNDO.   
   DEFINE OUTPUT PARAMETER TABLE FOR flermeddtemp.
   EMPTY TEMP-TABLE flermeddtemp NO-ERROR. 
   FIND FIRST MEDDELANDE WHERE RECID(MEDDELANDE) = plusrec NO-LOCK.
   IF AVAILABLE MEDDELANDE THEN DO:
      CREATE flermeddtemp.
      ASSIGN 
      flermeddtemp.FORETAG = FORETAG.FORETAG
      flermeddtemp.MEDD = MEDDELANDE.MEDD
      flermeddtemp.SANDARE = MEDDELANDE.SANDARE 
      flermeddtemp.SDATUM = MEDDELANDE.SDATUM
      flermeddtemp.MOTTAGARE = MEDDELANDE.MOTTAGARE 
      flermeddtemp.EMOTAGET = MEDDELANDE.EMOTAGET
      flermeddtemp.MEDREC = RECID(MEDDELANDE).
   END.
END PROCEDURE.

PROCEDURE medbort_UI :
   /*tar bort medd*/
   DEFINE INPUT PARAMETER TABLE FOR flermeddtemp.
   FOR EACH flermeddtemp WHERE flermeddtemp.FORETAG = "tabort":
      DO TRANSACTION:
         FIND MEDDELANDE WHERE RECID(MEDDELANDE) = flermeddtemp.MEDREC EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE MEDDELANDE THEN DELETE MEDDELANDE.
         DELETE flermeddtemp.         
      END.   
   END. 
   FOR EACH flermeddtemp WHERE flermeddtemp.FORETAG = "spara":
      DO TRANSACTION:
         FIND MEDDELANDE WHERE RECID(MEDDELANDE) = flermeddtemp.MEDREC EXCLUSIVE-LOCK NO-ERROR.
         IF AVAILABLE MEDDELANDE THEN MEDDELANDE.EMOTAGET = TRUE.
         ELSE DO:
            CREATE MEDDELANDE.
            BUFFER-COPY flermeddtemp TO MEDDELANDE.
            MEDDELANDE.EMOTAGET = TRUE.
            IF MEDDELANDE.MOTTAGARE = "" THEN  MEDDELANDE.MOTTAGARE = globanv. 
            IF  MEDDELANDE.SDATUM = ? THEN  MEDDELANDE.SDATUM = TODAY.
         END.
         DELETE flermeddtemp.         
      END.   
   END.  
   RELEASE MEDDELANDE NO-ERROR.
END PROCEDURE.
