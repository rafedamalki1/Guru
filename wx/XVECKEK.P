DEFINE NEW SHARED VARIABLE globforetag LIKE FORETAG.FORETAG NO-UNDO.
DEFINE NEW SHARED VARIABLE succelval LIKE PROGVAL.JANEJ NO-UNDO.
DEFINE NEW SHARED VARIABLE regvnr AS INTEGER FORMAT "999" NO-UNDO.
DEFINE NEW SHARED VARIABLE regdagnamn AS CHARACTER FORMAT "X(3)" NO-UNDO.        
DEFINE NEW SHARED VARIABLE regdatum AS DATE NO-UNDO.
DEFINE NEW SHARED VARIABLE regstartsek AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE regslutsek AS INTEGER NO-UNDO.
DEFINE NEW SHARED VARIABLE nytid AS DECIMAL FORMAT "99.99" NO-UNDO.
DEFINE NEW SHARED VARIABLE sekunder AS INTEGER FORMAT "-9999999" NO-UNDO.
DEFINE NEW SHARED VARIABLE tidtabrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE persrec2 AS RECID NO-UNDO.
DEFINE NEW SHARED VARIABLE vart AS CHARACTER FORMAT "X(3)" NO-UNDO.
DEFINE NEW SHARED VARIABLE musz AS LOGICAL NO-UNDO. 
DEFINE NEW SHARED VARIABLE plusdval LIKE PROGVAL.JANEJ NO-UNDO.
   
DEFINE VARIABLE vtidrec AS RECID.
DEFINE VARIABLE veckrec AS RECID.
DEFINE NEW SHARED VARIABLE korlage AS CHARACTER FORMAT "X(50)" NO-UNDO.
DEFINE QUERY vsatt FOR TIDREGITAB.
FIND FIRST PROGVAL WHERE PROGVAL.PROGRAM = "PLUSD" NO-LOCK NO-ERROR.
   plusdval = PROGVAL.JANEJ.
   FIND FIRST PROGVAL WHERE PROGVAL.PROGRAM = "SUCCEL" NO-LOCK NO-ERROR.
   IF AVAILABLE PROGVAL THEN succelval = PROGVAL.JANEJ.
   FIND FIRST FORETAG USE-INDEX FORETAG NO-LOCK NO-ERROR.
   globforetag = FORETAG.FORETAG.
   IF globforetag = 'GRAN' OR globforetag = 'GADM' OR globforetag = 'GSYD' OR globforetag = 'ROSL' OR globforetag = 'MALA' THEN DO:      
      korlage = "NU STARTAR KôRNING FôR EKONOMI " + STRING(TIME,"HH:MM:SS").
      DISPLAY  korlage VIEW-AS TEXT WITH FRAME CC NO-LABELS.
      PAUSE 0.
      RUN GRANEKO.P.                                            
      korlage = "NU STARTAR KôRNING FôR UTLéSNING EKONOMI " + STRING(TIME,"HH:MM:SS").
      DISPLAY  korlage VIEW-AS TEXT WITH FRAME CC NO-LABELS.
      PAUSE 0.
      RUN GRANAOEK.P.
   END.     
   IF succelval = TRUE THEN DO:
      IF globforetag = 'KOMU' THEN DO:
         RUN SUCCV4.P.   /*KôR ôVERTIDSKOSTNADEN TILL SUCCEL*/
      END.
   END.  
   DO TRANSACTION:
      regdatum = TODAY.
      RUN REGVEC.P.           
      FIND FIRST VECKONATT WHERE VECKONATT.DAG_AR = "DAG" 
      USE-INDEX NATT EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE VECKONATT THEN DO:
         CREATE VECKONATT.
      END.
      ASSIGN
      VECKONATT.NYKORD = TRUE
      VECKONATT.DAG_AR = "DAG"
      VECKONATT.VECKOKORD = "V" + STRING(regvnr, "999").    
      FIND FIRST VECKONATT WHERE VECKONATT.DAG_AR = "èR" 
      USE-INDEX NATT EXCLUSIVE-LOCK NO-ERROR.
      IF NOT AVAILABLE VECKONATT THEN DO:
         CREATE VECKONATT.
      END.
      ASSIGN
      VECKONATT.NYKORD = TRUE
      VECKONATT.DAG_AR = "èR"
      VECKONATT.VECKOKORD = "V" + STRING(regvnr, "999").   
   END.
   IF WEEKDAY(TODAY) = 1 THEN regdatum = TODAY - 7.
   IF WEEKDAY(TODAY) = 2 THEN regdatum = TODAY - 1.
   IF WEEKDAY(TODAY) = 3 THEN regdatum = TODAY - 2.
   IF WEEKDAY(TODAY) = 4 THEN regdatum = TODAY - 3.
   IF WEEKDAY(TODAY) = 5 THEN regdatum = TODAY - 4.
   IF WEEKDAY(TODAY) = 6 THEN regdatum = TODAY - 5.
   IF WEEKDAY(TODAY) = 7 THEN regdatum = TODAY - 6.            
   korlage = "NU STOPPAS ALL éNDRING AV TIDSEDLAR " + STRING(TIME,"HH:MM:SS").
   DISPLAY  korlage VIEW-AS TEXT WITH FRAME CC NO-LABELS.
   PAUSE 0.
   DO:
      OPEN QUERY vsatt FOR EACH TIDREGITAB WHERE TIDREGITAB.DATUM <= regdatum AND
      TIDREGITAB.VECKOKORD = " "  USE-INDEX KOLL NO-LOCK.
      DO TRANSACTION:
         GET FIRST vsatt EXCLUSIVE-LOCK.
         IF AVAILABLE TIDREGITAB THEN DO:
            IF TIDREGITAB.GODKAND = " " THEN regdatum = regdatum.
            ELSE ASSIGN TIDREGITAB.VECKOKORD = "V" + STRING(regvnr, "999").
         END.
      END.
      VKO:
      REPEAT TRANSACTION:
         GET NEXT vsatt EXCLUSIVE-LOCK.
         IF AVAILABLE TIDREGITAB THEN DO:
            IF TIDREGITAB.GODKAND = " " THEN NEXT VKO.
            ELSE ASSIGN TIDREGITAB.VECKOKORD = "V" + STRING(regvnr, "999").
         END. 
         ELSE LEAVE VKO. 
      END.             
   END.          
   CLOSE QUERY vsatt.   
   DO TRANSACTION:
      FIND FIRST VKORN USE-INDEX VKORN EXCLUSIVE-LOCK NO-ERROR.
      IF AVAILABLE VKORN THEN DO:
         ASSIGN VKORN.VECKOK = FALSE.
         VALIDATE VKORN.
      END.
   END.
