/*XBAFAKT.P* TAR BORT ANGIVEN LôPANDE FAKTURA OBS ENDST DEN SISTA FAKTURAN GèR ATT
TA BORT*/
 DEFINE VARIABLE DD LIKE FAKTPLAN.FAKTNR NO-UNDO.
DEFINE VARIABLE DD1  LIKE FAKTURERAD.FDELNR NO-UNDO. 
DEFINE VARIABLE DD2  LIKE FAKTKOLL.SENASTTID NO-UNDO. 
DEFINE QUERY faktaonrq FOR FAKTAONR. 
DEFINE QUERY faktidq FOR FAKTTID.  
DEFINE QUERY fakkostq FOR FAKTKOST.
DEFINE QUERY fakkollq FOR FAKTKOLL.
UPDATE DD DD1 .    
FIND FIRST FAKTPLAN WHERE FAKTPLAN.FAKTNR = DD NO-LOCK NO-ERROR.
OPEN QUERY fakkostq FOR EACH FAKTKOST WHERE FAKTKOST.FAKTNR = FAKTPLAN.FAKTNR AND 
FAKTKOST.FDELNR = DD1 
USE-INDEX FAKTKOST NO-LOCK.  
DO TRANSACTION:
   GET FIRST fakkostq EXCLUSIVE-LOCK.   
   DO WHILE AVAILABLE(FAKTKOST):  
      IF AVAILABLE FAKTKOST THEN DO:
         FIND KOSTREG WHERE KOSTREG.AONR = FAKTKOST.AONR AND  
         KOSTREG.DELNR = FAKTKOST.DELNR AND KOSTREG.RADNR = FAKTKOST.RADNR
         USE-INDEX KOST EXCLUSIVE-LOCK NO-ERROR.  
         IF AVAILABLE KOSTREG THEN ASSIGN KOSTREG.FAKTURERAD = FALSE.
      END.
      DELETE FAKTKOST.     
      GET NEXT fakkostq EXCLUSIVE-LOCK.
   END.   
END.   


OPEN QUERY faktidq FOR EACH FAKTTID WHERE FAKTTID.FAKTNR = FAKTPLAN.FAKTNR AND  
FAKTTID.FDELNR = DD1 AND FAKTTID.SENASTTID = FAKTPLAN.SENASTTID AND 
FAKTTID.SENASTFAK = FAKTPLAN.SENASTFAK
USE-INDEX FAKTTID NO-LOCK.
DO TRANSACTION:
   GET FIRST faktidq EXCLUSIVE-LOCK.   
   DO WHILE AVAILABLE(FAKTTID): 
      DELETE FAKTTID.     
      GET NEXT faktidq EXCLUSIVE-LOCK.
   END.   
END.                              

OPEN QUERY fakkollq FOR EACH FAKTKOLL WHERE FAKTKOLL.FAKTNR = FAKTPLAN.FAKTNR AND
FAKTKOLL.BESTID = FAKTPLAN.BESTID
USE-INDEX FAKTNR NO-LOCK.
DO TRANSACTION:
   GET FIRST fakkollq EXCLUSIVE-LOCK.   
   DO WHILE AVAILABLE(FAKTKOLL):         
      FIND LAST FAKTTID WHERE FAKTTID.FAKTNR = FAKTKOLL.FAKTNR AND           
      FAKTTID.AONR = FAKTKOLL.AONR  AND
      FAKTTID.DELNR = FAKTKOLL.DELNR  
      USE-INDEX FAKTTID EXCLUSIVE-LOCK NO-ERROR. 
      IF AVAILABLE FAKTTID THEN DO: 
         ASSIGN         
         FAKTKOLL.SENASTFAK = FAKTTID.SENASTFAK
         FAKTKOLL.SENASTTID = FAKTTID.SENASTTID
         FAKTKOLL.SLUTFAKT = FALSE
         FAKTKOLL.VECKOKORD = FAKTTID.VECKOKORD.         
      END.
      ELSE DO:
         ASSIGN         
         FAKTKOLL.SENASTFAK = ?
         FAKTKOLL.SENASTTID = ?
         FAKTKOLL.SLUTFAKT = FALSE
         FAKTKOLL.VECKOKORD = "".         
      END.
      GET NEXT fakkollq EXCLUSIVE-LOCK.
   END.
END.   
                                               
DO TRANSACTION:
   FIND FIRST FAKTURERAD WHERE FAKTURERAD.FAKTNR = FAKTPLAN.FAKTNR AND
   FAKTURERAD.FDELNR = DD1 USE-INDEX FAKTNR EXCLUSIVE-LOCK NO-ERROR. 
   IF AVAILABLE FAKTURERAD THEN DELETE FAKTURERAD.   
END.

FIND LAST FAKTTID WHERE FAKTTID.FAKTNR = FAKTPLAN.FAKTNR AND  
FAKTTID.FDELNR = DD1 USE-INDEX FAKTTID NO-LOCK NO-ERROR.                                     
IF AVAILABLE FAKTTID THEN DO TRANSACTION:
   FIND FIRST FAKTPLAN WHERE FAKTPLAN.FAKTNR = DD EXCLUSIVE-LOCK NO-ERROR.
   ASSIGN
   FAKTPLAN.SENASTFAK = FAKTTID.SENASTFAK  
   FAKTPLAN.SENASTTID = FAKTTID.SENASTTID 
   FAKTPLAN.TOTPRIS = FAKTTID.TOTPRIS.
END. 
ELSE DO TRANSACTION:        
   FIND FIRST FAKTPLAN WHERE FAKTPLAN.FAKTNR = DD EXCLUSIVE-LOCK NO-ERROR.
   ASSIGN
   FAKTPLAN.SENASTFAK = ?  
   FAKTPLAN.SENASTTID = ?
   FAKTPLAN.TOTPRIS = 0.
   FOR EACH FAKTURERAD WHERE FAKTURERAD.FAKTNR = FAKTPLAN.FAKTNR 
   USE-INDEX FAKTNR NO-LOCK:      
      ASSIGN
      FAKTPLAN.SENASTFAK = ?  
      FAKTPLAN.SENASTTID = ?      
      FAKTPLAN.TOTPRIS = FAKTPLAN.TOTPRIS + FAKTURERAD.TOTPRIS. 
   END.
END. 
     