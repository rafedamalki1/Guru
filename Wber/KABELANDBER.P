
/*------------------------------------------------------------------------
    File        : KABELANDBER.P
    Purpose     : 

    Syntax      :

    Description : 

    Author(s)   : 
    Created     : Mon Sep 28 15:41:05 CEST 2015
    Notes       :
  ----------------------------------------------------------------------*/
{BBENAMNTEMP.I}
{KONVALTEMP.I}
{KONSTRMTRL.I}
{BEREDTT.i}
DEFINE VARIABLE bloblog AS LOGICAL NO-UNDO.


DEFINE INPUT  PARAMETER globanv AS CHARACTER NO-UNDO.   
PROCEDURE uppmtrl_UI :
   DEFINE INPUT  PARAMETER bervar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER omrvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER numvar AS INTEGER NO-UNDO.
   DEFINE INPUT PARAMETER ktypkodvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER TABLE FOR upp_mtrlTT.
   DEFINE OUTPUT PARAMETER TABLE FOR ber_mtrltt.
   DEFINE VARIABLE beflev AS CHARACTER NO-UNDO.
   FOR EACH MTRLBER WHERE MTRLBER.KTYPKOD = ktypkodvar NO-LOCK:
      CREATE upp_mtrlTT.
      BUFFER-COPY MTRLBER TO upp_mtrlTT.
   END.
   
   FOR EACH BERMTRL WHERE BERMTRL.AONR = bervar AND BERMTRL.OMRADE = omrvar AND  BERMTRL.NUM  = numvar NO-LOCK:
      CREATE ber_mtrltt.
      BUFFER-COPY BERMTRL TO ber_mtrltt. 
   END.
   FOR EACH upp_mtrlTT WHERE NO-LOCK:
      FIND FIRST MTRL WHERE MTRL.Enr = upp_mtrlTT.ENR AND MTRL.LEVKOD = upp_mtrlTT.LEVKOD NO-LOCK NO-ERROR.
      IF AVAILABLE MTRL THEN upp_mtrlTT.KUND = MTRL.KUND.
   END.
   /*ÄR LEVERANTÖR BYTT*/
   FIND FIRST BETFRIA WHERE BETFRIA.BETNR =  INTEGER(bervar) AND BETFRIA.FAKTTEXT = omrvar NO-LOCK NO-ERROR.
   IF AVAILABLE BETFRIA THEN DO:
      /*HÄMTA HUVUDLEV*/
      FIND FIRST HUVUDLEV WHERE HUVUDLEV.DEP-NR = 999 NO-LOCK NO-ERROR.
      IF AVAILABLE HUVUDLEV THEN DO:
         beflev = HUVUDLEV.LEVKOD.
      END.
      ELSE DO:
         /* ÄR DEN BORTA ??*/
         FIND FIRST LEVERANTOR WHERE LEVERANTOR.LEVKOD NE "0"  AND LEVERANTOR.BORTTAG = FALSE NO-LOCK NO-ERROR.
         beflev = LEVERANTOR.LEVKOD.
      END.
      /*BERLEV ÄR INTE SAMMA SOM HUVUDLEV*/
      RUN UtbytStart_UI (INPUT "UPPERSATT",INPUT BETFRIA.TYP,INPUT INTEGER(bervar),INPUT omrvar).
   END.
END PROCEDURE.
PROCEDURE enrhmt_UI :
   DEFINE INPUT  PARAMETER levvar AS CHARACTER NO-UNDO.
   DEFINE INPUT  PARAMETER enrvar AS CHARACTER NO-UNDO.
   DEFINE OUTPUT PARAMETER kundvar AS LOGICAL NO-UNDO. 
   FIND FIRST MTRL WHERE MTRL.LEVKOD = levvar AND MTRL.ENR = enrvar AND MTRL.KALKNR = 0
   NO-LOCK NO-ERROR.
   IF AVAILABLE  MTRL THEN DO:                                           
      kundvar =  MTRL.KUND.
   END.
   ELSE kundvar = FALSE.   
END PROCEDURE.
{UTBYTSTARTUM.I}