DEFINE VARIABLE befvar LIKE  PERSONALTAB.BEFATTNING NO-UNDO.
DEFINE VARIABLE nattaonr LIKE AONRTAB.AONR NO-UNDO.  
DEFINE VARIABLE nattdelnr LIKE AONRTAB.DELNR NO-UNDO.  
DEFINE VARIABLE nattaoomr LIKE AONRTAB.OMRADE NO-UNDO. 
DEFINE VARIABLE pkod LIKE PERSONALTAB.PERSONALKOD NO-UNDO. 
DEF VAR artalsok AS DATE.
   DEF VAR kollvecka AS CHARACTER.
   kollvecka = "W20021004".
OPEN QUERY sumarq FOR EACH SUMTID WHERE SUMTID.datum = 01/01/2002 NO-LOCK.
DO TRANSACTION:
   GET FIRST sumarq EXCLUSIVE-LOCK.
   IF AVAILABLE SUMTID THEN DELETE SUMTID.      
END.                                             
REPEAT:
   DO TRANSACTION:
      GET NEXT sumarq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN DELETE SUMTID. 
      ELSE LEAVE.
   END.
END.       
CLOSE QUERY sumarq.  
RUN sumartid_UI.
RUN namnar_UI.
PROCEDURE sumartid_UI:
   
   FOR EACH SUMTIDDAG WHERE SUMTIDDAG.VECKOKORD NE "" AND YEAR(SUMTIDDAG.DATUM) = 2002 BREAK 
   BY SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY 
   SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY SUMTIDDAG.PRISTYP:       
      ACCUMULATE SUMTIDDAG.TIMMAR (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.BELOPP (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.OTIMMAR (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.OBELOPP (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.TBELOPP (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.LONKOST (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 
      ACCUMULATE SUMTIDDAG.IKOSTNAD (TOTAL  BY 
      SUMTIDDAG.PERSONALKOD BY SUMTIDDAG.BEFATTNING BY SUMTIDDAG.AONR BY SUMTIDDAG.DELNR BY 
      SUMTIDDAG.PRISTYP). 

      IF LAST-OF(SUMTIDDAG.PRISTYP) THEN DO:     
         DO TRANSACTION:
            artalsok = DATE(01,01,YEAR(SUMTIDDAG.DATUM)).
            FIND FIRST SUMTID WHERE           
            SUMTID.DATUM = artalsok AND 
            SUMTID.AONR = SUMTIDDAG.AONR AND 
            SUMTID.DELNR = SUMTIDDAG.DELNR AND
            SUMTID.PERSONALKOD = SUMTIDDAG.PERSONALKOD AND
            SUMTID.VECKOKORD =  kollvecka AND 
            SUBSTRING(SUMTID.BEFATTNING,1,20) = SUBSTRING(SUMTIDDAG.BEFATTNING,1,20) AND
            SUMTID.PRISTYP = SUMTIDDAG.PRISTYP                                             
            EXCLUSIVE-LOCK NO-ERROR.                   
            IF NOT AVAILABLE SUMTID THEN DO:
               CREATE SUMTID.                     
            END.                              
            ASSIGN
            SUMTID.BEFATTNING = SUMTIDDAG.BEFATTNING                                             
            SUMTID.VECKOKORD = kollvecka                             
            SUMTID.PERSONALKOD = SUMTIDDAG.PERSONALKOD 
            SUMTID.PRIS = SUMTIDDAG.PRIS     
            SUMTID.DATUM = artalsok 
            SUMTID.AUTODATUM = TODAY
            SUMTID.AONR = SUMTIDDAG.AONR   
            SUMTID.DELNR = SUMTIDDAG.DELNR
            SUMTID.PRISTYP = SUMTIDDAG.PRISTYP 
            SUMTID.LONKOST = SUMTID.LONKOST + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.LONKOST) 
            SUMTID.TIMMAR = SUMTID.TIMMAR + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.TIMMAR)
            SUMTID.BELOPP  = SUMTID.BELOPP + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.BELOPP) 
            SUMTID.OTIMMAR = SUMTID.OTIMMAR + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.OTIMMAR)
            SUMTID.OBELOPP = SUMTID.OBELOPP + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.OBELOPP)
            SUMTID.TBELOPP = SUMTID.TBELOPP + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.TBELOPP)              
            SUMTID.IKOSTNAD = SUMTID.IKOSTNAD + (ACCUM TOTAL BY SUMTIDDAG.PRISTYP SUMTIDDAG.BELOPP).      
         END.
      END.
   END.
END PROCEDURE.
PROCEDURE namnar_UI: 
   RELEASE AONRTAB NO-ERROR.                  
   ASSIGN
   nattaonr = ""
   nattdelnr = 0.
   OPEN QUERY sumarq FOR EACH SUMTID WHERE SUMTID.VECKOKORD = kollvecka NO-LOCK
   BY SUMTID.VECKOKORD BY SUMTID.AONR by SUMTID.DELNR.    
   DO TRANSACTION:   
      GET FIRST sumarq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN DO:         
         IF NOT AVAILABLE AONRTAB THEN DO:
            ASSIGN  
            nattaonr = SUMTID.AONR 
            nattdelnr = SUMTID.DELNR. 
            FIND FIRST AONRTAB WHERE AONRTAB.AONR = SUMTID.AONR AND 
            AONRTAB.DELNR = SUMTID.DELNR
            USE-INDEX AONR NO-LOCK NO-ERROR. 
         END.            
         ELSE DO:                                                          
            IF nattaonr = SUMTID.AONR AND nattdelnr = SUMTID.DELNR 
            THEN nattaonr = nattaonr.
            ELSE DO:
               ASSIGN  
               nattaonr = SUMTID.AONR 
               nattdelnr = SUMTID.DELNR. 
               FIND FIRST AONRTAB WHERE AONRTAB.AONR = SUMTID.AONR AND 
               AONRTAB.DELNR = SUMTID.DELNR
               USE-INDEX AONR NO-LOCK NO-ERROR. 
            END.
         END.    
         IF AVAILABLE AONRTAB THEN DO: 
            ASSIGN 
            SUMTID.FASTAAONR = AONRTAB.FASTAAONR          
            SUMTID.GEOMRADE = AONRTAB.OMRADE 
            SUMTID.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = "" THEN ASSIGN SUMTID.GEOMRADE = SUMTID.OMRADE.           
         END.
      END.                                              
   END.   
   AONAMN2:
   REPEAT TRANSACTION:                       
      GET NEXT sumarq EXCLUSIVE-LOCK.         
      IF NOT AVAILABLE SUMTID THEN LEAVE AONAMN2.
      ELSE DO:
         IF NOT AVAILABLE AONRTAB THEN DO:
            ASSIGN  
            nattaonr = SUMTID.AONR 
            nattdelnr = SUMTID.DELNR. 
            FIND FIRST AONRTAB WHERE AONRTAB.AONR = SUMTID.AONR AND 
            AONRTAB.DELNR = SUMTID.DELNR
            USE-INDEX AONR NO-LOCK NO-ERROR. 
         END.            
         ELSE DO:                                                          
            IF nattaonr = SUMTID.AONR AND nattdelnr = SUMTID.DELNR 
            THEN nattaonr = nattaonr.
            ELSE DO:
               ASSIGN  
               nattaonr = SUMTID.AONR 
               nattdelnr = SUMTID.DELNR. 
               FIND FIRST AONRTAB WHERE AONRTAB.AONR = SUMTID.AONR AND 
               AONRTAB.DELNR = SUMTID.DELNR
               USE-INDEX AONR NO-LOCK NO-ERROR. 
            END.
         END.    
         IF AVAILABLE AONRTAB THEN DO: 
            ASSIGN 
            SUMTID.FASTAAONR = AONRTAB.FASTAAONR          
            SUMTID.GEOMRADE = AONRTAB.OMRADE 
            SUMTID.ORT = AONRTAB.ORT.
            IF AONRTAB.OMRADE = "" THEN ASSIGN SUMTID.GEOMRADE = SUMTID.OMRADE.           
         END.
      END.     
   END.     
   CLOSE QUERY sumarq.                        
   pkod = " ".
   OPEN QUERY sumarq FOR EACH SUMTID WHERE SUMTID.VECKOKORD = kollvecka NO-LOCK 
   BY SUMTID.VECKOKORD BY SUMTID.PERSONALKOD.  
   DO TRANSACTION:   
      GET FIRST sumarq EXCLUSIVE-LOCK.
      IF AVAILABLE SUMTID THEN DO:
         RUN sattar_UI.          
      END. 
   END.          
   NAMN2:
   REPEAT TRANSACTION:                    
      GET NEXT sumarq EXCLUSIVE-LOCK.          
      IF NOT AVAILABLE SUMTID THEN LEAVE NAMN2.
      ELSE DO:
         RUN sattar_UI.                  
      END.                
   END.
END PROCEDURE.
PROCEDURE sattar_UI:
   IF pkod NE SUMTID.PERSONALKOD THEN DO:
      pkod = SUMTID.PERSONALKOD.
      FIND FIRST PERSONALTAB WHERE 
      PERSONALTAB.PERSONALKOD = SUMTID.PERSONALKOD
      USE-INDEX PERSONALKOD NO-LOCK NO-ERROR. 
      IF AVAILABLE PERSONALTAB THEN DO:
         FIND FIRST ANSTFORMTAB WHERE 
         ANSTFORMTAB.ANSTALLNING = PERSONALTAB.ANSTALLNING
         USE-INDEX ANSTF NO-LOCK NO-ERROR.                           
      END. 
   END.
   IF AVAILABLE PERSONALTAB THEN DO:                          
      IF SUMTID.GEOMRADE = "" THEN SUMTID.GEOMRADE = PERSONALTAB.OMRADE.
      ASSIGN 
      SUMTID.FORNAMN = PERSONALTAB.FORNAMN 
      SUMTID.EFTERNAMN = PERSONALTAB.EFTERNAMN
      SUMTID.OMRADE = PERSONALTAB.OMRADE.
      befvar = SUBSTRING(SUMTID.BEFATTNING,1,20).
      SUMTID.BEFATTNING = "".
      IF befvar = "" THEN SUBSTRING(SUMTID.BEFATTNING,1,20) = PERSONALTAB.BEFATTNING .
      ELSE SUBSTRING(SUMTID.BEFATTNING,1,20) = befvar.
      ASSIGN
      SUBSTRING(SUMTID.BEFATTNING,21) = ANSTFORMTAB.KOD         
      SUMTID.PERSMASK = PERSONALTAB.PERSMASK.  
      ASSIGN SUMTID.PRISI = SUMTID.PRIS.
      
   END.
END PROCEDURE.   

